<div id="Cancel_Card_Constraint">
<div class="head">
<h1>Theory Cancel_Card_Constraint</h1>
</div>
<pre class="source"><span class="comment1">(* Author: R. Thiemann *)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Elimination of CARD('n)›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the following theory we provide a method which modifies theorems
  of the form $P[CARD('n)]$ into $n != 0 \Longrightarrow P[n]$, so that they can more
  easily be applied.
  
  Known issues: there might be problems with nested meta-implications and meta-quantification.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Cancel_Card_Constraint
<span class="keyword2"><span class="keyword">imports</span></span> 
  <span class="quoted">"<a href="../../HOL/HOL-Types_To_Sets/Types_To_Sets.html">HOL-Types_To_Sets.Types_To_Sets</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Cardinality.html">HOL-Library.Cardinality</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> n_zero_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span> <span class="main">::</span> nat<span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> type_impl_card_n<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">Rep</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇒</span> nat<span class="main">)</span> <span class="bound">Abs</span><span class="main">.</span> type_definition <span class="bound">Rep</span> <span class="bound">Abs</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span> <span class="main">::</span> nat<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"class.finite <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rep</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">abs</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"type_definition <span class="skolem">rep</span> <span class="skolem">abs</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">=</span> card <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> type_definition.card<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> bn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">CARD</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">abs</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">abs</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">=</span> UNIV"</span></span> <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> type_definition.Abs_image<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"class.finite <span class="main">(</span><span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> class.finite_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> bn <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹cancel_card_constraint.ML›</span>


<span class="comment1">(* below you find an example what the attribute cancel_card_constraint can do and how
   it works internally *)</span>

<span class="comment1">(*
(* input: some type based lemma with CARD inside, like t0 *)
consts P :: "nat ⇒ nat ⇒ bool" 
axiomatization where t0: "P (CARD ('a :: finite)) (CARD('a) * m)"

(* t0 is converted into a property without the cardinality constraint via the new attribute *)
lemma t_1_to_6: "n ≠ 0 ⟹ P n (n * m)"
  by (rule t0[cancel_card_constraint])

(* The internal steps are as follows. *)

(* 1st step: pull out CARD and introduce new variable n *)
lemma t1: "CARD('a :: finite) = n ⟹ P n (n * m)" 
  using t0[where 'a = 'a] by blast

(* 2nd step: get rid of sorts *)
lemma t2: "class.finite TYPE('a) ⟹ CARD('a) = n ⟹ P n (n * m)"
  by (rule t1[internalize_sort "?'a::finite"])

(* 3rd step: restructure thm so that first two assumptions are merged into one *)
lemma t3: "class.finite TYPE('a) ∧ CARD('a) = n ⟹ P n (n * m)" 
  using t2 by blast

(* 4th step: choose an appropriate carrier set *)
lemma t4: "∃Rep Abs. type_definition Rep Abs {0..&lt;n} ⟹ P n (n * m)"
  by (rule t3[OF type_impl_card_n])

(* 5th step: cancel type definition *)
lemma t5: "{0..&lt;n} ≠ {} ⟹ P n (n * m)"
  by (rule t4[cancel_type_definition])

(* 6th step: simplify non-empty assumption to obtain final theorem *)
lemma t6: "n ≠ 0 ⟹ P n (n * m)" 
  by (rule t5[OF n_zero_nonempty])
*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/cancel_card_constraint.ML">
<div class="head">
<h1>File ‹cancel_card_constraint.ML›</h1>
</div>
<pre class="source"><span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">CARD_ELIMINATION</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> cancel_card_constraint<span class="main">:</span> thm <span class="main">-&gt;</span> thm
  <span class="keyword1"><span class="keyword">val</span></span> cancel_card_constraint_attr<span class="main">:</span> attribute
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Card_Elimination</span> <span class="main">:</span> <span class="entity">CARD_ELIMINATION</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

  <span class="comment1">(* turns A ==&gt; B[CARD('a)] ==&gt; C[CARD('a), CARD('b)] ==&gt; ... ==&gt; Z 
    into CARD('a) = n1 ==&gt; CARD('b) = n2 ==&gt; A ==&gt; B[n1] ==&gt; C[n1,n2] ==&gt; ... ==&gt; Z *)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">extract_card_type</span> <span class="entity">ctxt</span> <span class="entity">thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prop</span> <span class="main">=</span> Thm.prop_of <span class="entity">thm</span> 
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_match_terms</span> <span class="entity">f</span> <span class="entity">t</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">f</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">then</span></span> insert <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">else</span></span> I<span class="main">)</span> #&gt;
      <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>         
        <span class="entity">t1</span> $ <span class="entity">t2</span> <span class="main">=&gt;</span> <span class="entity">add_match_terms</span> <span class="entity">f</span> <span class="entity">t1</span> #&gt; <span class="entity">add_match_terms</span> <span class="entity">f</span> <span class="entity">t2</span>
      <span class="main">|</span> Abs <span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">,</span><span class="entity">t1</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">add_match_terms</span> <span class="entity">f</span> <span class="entity">t1</span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> I<span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">replace_terms</span> <span class="entity">xys</span> <span class="entity">t</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> AList.lookup <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="entity">xys</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span> SOME <span class="entity">y</span> <span class="main">=&gt;</span> <span class="entity">y</span>
      <span class="main">|</span> NONE <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="entity">t1</span> $ <span class="entity">t2</span> <span class="main">=&gt;</span> <span class="entity">replace_terms</span> <span class="entity">xys</span> <span class="entity">t1</span> $ <span class="entity">replace_terms</span> <span class="entity">xys</span> <span class="entity">t2</span>
      <span class="main">|</span> Abs <span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">t1</span><span class="main">)</span> <span class="main">=&gt;</span> Abs <span class="main">(</span><span class="entity">a</span><span class="main">,</span><span class="entity">b</span><span class="main">,</span><span class="entity">replace_terms</span> <span class="entity">xys</span> <span class="entity">t1</span><span class="main">)</span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">t</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">find_card</span> <span class="main">(</span>Const <span class="main">(</span><span class="entity">c</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> $ Const <span class="main">(</span><span class="entity">t</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="entity">c</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Finite_Set.card<span class="antiquote">}</span></span> 
          <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">t</span> <span class="main">=</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> Orderings.top_class.top<span class="antiquote">}</span></span><span class="main">)</span> 
      <span class="main">|</span> <span class="entity">find_card</span> <span class="main">_</span> <span class="main">=</span> false    
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">card_ts</span> <span class="main">=</span> <span class="entity">add_match_terms</span> <span class="entity">find_card</span> <span class="entity">prop</span> <span class="main">[</span><span class="main">]</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">vars</span> <span class="main">=</span> Term.add_vars <span class="entity">prop</span> <span class="main">[</span><span class="main">]</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">all_tvars</span> <span class="main">=</span> Term.add_tvars <span class="entity">prop</span> <span class="main">[</span><span class="main">]</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">all_tfrees</span> <span class="main">=</span> map TFree <span class="main">(</span>Variable.variant_frees <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">prop</span><span class="main">]</span> <span class="main">(</span>map <span class="main">(</span>apfst fst<span class="main">)</span> <span class="entity">all_tvars</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ns</span> <span class="main">=</span> map_index <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">i</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="inner_quoted">"n"</span> ^ string_of_int <span class="entity">i</span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">nat</span><span class="antiquote">}</span></span><span class="main">)</span><span class="main">)</span> <span class="entity">card_ts</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">substT_map</span> <span class="main">=</span> map fst <span class="entity">all_tvars</span> ~~ <span class="entity">all_tfrees</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">substT</span> <span class="main">=</span> I subst_TVars <span class="entity">substT_map</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">free_ns</span> <span class="main">=</span> Variable.variant_frees <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">prop</span><span class="main">]</span> <span class="main">(</span>map <span class="main">(</span>apfst fst<span class="main">)</span> <span class="entity">vars</span> @ <span class="entity">ns</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">all_frees</span> <span class="main">=</span> map <span class="main">(</span><span class="entity">substT</span> o Free<span class="main">)</span> <span class="entity">free_ns</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ns</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="entity">vars</span><span class="main">)</span> <span class="entity">all_frees</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">subst</span> <span class="main">=</span> subst_vars <span class="main">(</span><span class="entity">substT_map</span><span class="main">,</span> map fst <span class="entity">vars</span> ~~ <span class="main">(</span>take <span class="main">(</span>length <span class="entity">vars</span><span class="main">)</span> <span class="entity">all_frees</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prop'</span> <span class="main">=</span> <span class="entity">subst</span> <span class="entity">prop</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">match_card_ns</span> <span class="main">=</span> <span class="entity">add_match_terms</span> <span class="entity">find_card</span> <span class="entity">prop'</span> <span class="main">[</span><span class="main">]</span> ~~ rev <span class="entity">ns</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prop''</span> <span class="main">=</span> <span class="entity">replace_terms</span> <span class="entity">match_card_ns</span> <span class="entity">prop'</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">eqs</span> <span class="main">=</span> map <span class="main">(</span><span class="entity">HOLogic.mk_eq</span> #&gt; <span class="entity">HOLogic.mk_Trueprop</span><span class="main">)</span> <span class="entity">match_card_ns</span> |&gt; rev
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">new_thm</span> <span class="main">=</span> Goal.prove <span class="entity">ctxt</span> <span class="main">(</span>map fst <span class="entity">free_ns</span><span class="main">)</span> <span class="entity">eqs</span> <span class="entity">prop''</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>prems <span class="main">=</span> <span class="entity">prems</span><span class="main">,</span> context <span class="main">=</span> <span class="entity">ctxt</span><span class="main">}</span> <span class="main">=&gt;</span> 
      <span class="entity">unfold_tac</span> <span class="entity">ctxt</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> sym<span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">thm</span><span class="main">]</span><span class="main">)</span> <span class="entity">prems</span><span class="main">)</span>
      THEN resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">thm</span><span class="main">]</span> <span class="inner_numeral">1</span>
      THEN <span class="main">(</span>REPEAT <span class="main">(</span>assume_tac <span class="entity">ctxt</span> <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">in</span></span> 
    <span class="main">(</span>length <span class="entity">ns</span><span class="main">,</span> <span class="entity">new_thm</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="comment1">(* turns A ==&gt; B ==&gt; C into A /\ B ==&gt; C *)</span>
  <span class="comment1">(* does not properly work in case of nested meta-implications and meta-quantification *)</span>
  <span class="comment1">(* TODO: fix and simplify *)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">combine_first_prems</span> <span class="entity">ctxt</span> <span class="entity">thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prop</span> <span class="main">=</span> Thm.prop_of <span class="entity">thm</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">p1</span> :: <span class="entity">p2</span> :: <span class="entity">prems</span><span class="main">)</span> <span class="main">=</span> Thm.prems_of <span class="entity">thm</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">concl</span> <span class="main">=</span> Thm.concl_of <span class="entity">thm</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">all_tvars</span> <span class="main">=</span> Term.add_tvars <span class="entity">prop</span> <span class="main">[</span><span class="main">]</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">all_tfrees</span> <span class="main">=</span> map TFree <span class="main">(</span>Variable.variant_frees <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">prop</span><span class="main">]</span> <span class="main">(</span>map <span class="main">(</span>apfst fst<span class="main">)</span> <span class="entity">all_tvars</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">substT_map</span> <span class="main">=</span> map fst <span class="entity">all_tvars</span> ~~ <span class="entity">all_tfrees</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prop'</span> <span class="main">=</span> subst_TVars <span class="entity">substT_map</span> <span class="entity">prop</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">all_vars</span> <span class="main">=</span> Term.add_vars <span class="entity">prop'</span> <span class="main">[</span><span class="main">]</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">free_ns</span> <span class="main">=</span> Variable.variant_frees <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">prop'</span><span class="main">]</span> <span class="main">(</span>map <span class="main">(</span>apfst fst<span class="main">)</span> <span class="entity">all_vars</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">all_frees</span> <span class="main">=</span> map Free <span class="entity">free_ns</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">subst</span> <span class="main">=</span> subst_vars <span class="main">(</span><span class="entity">substT_map</span><span class="main">,</span> map fst <span class="entity">all_vars</span> ~~ <span class="entity">all_frees</span><span class="main">)</span>
    
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">p1</span> <span class="main">=</span> <span class="entity">subst</span> <span class="entity">p1</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">p2</span> <span class="main">=</span> <span class="entity">subst</span> <span class="entity">p2</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prems</span> <span class="main">=</span> map <span class="entity">subst</span> <span class="entity">prems</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">concl</span> <span class="main">=</span> <span class="entity">subst</span> <span class="entity">concl</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">p</span> <span class="main">=</span> <span class="entity">HOLogic.mk_conj</span> <span class="main">(</span><span class="entity">HOLogic.dest_Trueprop</span> <span class="entity">p1</span><span class="main">,</span> <span class="entity">HOLogic.dest_Trueprop</span> <span class="entity">p2</span><span class="main">)</span>
      |&gt; <span class="entity">HOLogic.mk_Trueprop</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    Goal.prove <span class="entity">ctxt</span> <span class="main">(</span>map fst <span class="entity">free_ns</span><span class="main">)</span> <span class="main">(</span><span class="entity">p</span> :: <span class="entity">prems</span><span class="main">)</span> <span class="entity">concl</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">{</span>prems <span class="main">=</span> <span class="entity">prems</span><span class="main">,</span> context <span class="main">=</span> <span class="entity">ctxt</span><span class="main">}</span> <span class="main">=&gt;</span>
      <span class="keyword2"><span class="keyword">let</span></span> 
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">p</span> <span class="main">=</span> hd <span class="entity">prems</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">p1</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> conjunct1<span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">p</span><span class="main">]</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">p2</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> conjunct2<span class="antiquote">}</span></span></span> OF <span class="main">[</span><span class="entity">p</span><span class="main">]</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">prems</span> <span class="main">=</span> tl <span class="entity">prems</span>
      <span class="keyword2"><span class="keyword">in</span></span>           
        resolve_tac <span class="entity">ctxt</span> <span class="main">[</span><span class="entity">thm</span> OF <span class="main">(</span><span class="entity">p1</span> :: <span class="entity">p2</span> :: <span class="entity">prems</span><span class="main">)</span><span class="main">]</span> <span class="inner_numeral">1</span>       
      <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="comment1">(* turns CARD('a) = n1 ==&gt; A ==&gt; B ==&gt; C into
        A ==&gt; B ==&gt; n1 != 0 ==&gt; C *)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">eliminate_card_constraint</span> <span class="entity">ctxt</span> <span class="entity">thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">v</span> <span class="main">=</span> Thm.ctyp_of <span class="entity">ctxt</span> <span class="main">(</span>Thm.prems_of <span class="entity">thm</span> |&gt; hd |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">t</span> <span class="main">=&gt;</span> Term.add_tvars <span class="entity">t</span> <span class="main">[</span><span class="main">]</span> |&gt; hd<span class="main">)</span> |&gt; TVar<span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> <span class="entity">Internalize_Sort.internalize_sort</span> <span class="entity">v</span> <span class="entity">thm</span> |&gt; snd
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> <span class="entity">combine_first_prems</span> <span class="entity">ctxt</span> <span class="entity">thm</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> <span class="main">(</span><span class="entity">thm</span> OF <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> type_impl_card_n<span class="antiquote">}</span></span></span><span class="main">)</span> |&gt; <span class="entity">Local_Typedef.cancel_type_definition</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> <span class="entity">thm</span> OF <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> n_zero_nonempty<span class="antiquote">}</span></span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> rotate_prems <span class="inner_numeral">1</span> <span class="entity">thm</span>
  <span class="keyword2"><span class="keyword">in</span></span> 
    <span class="entity">thm</span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="comment1">(* turns CARD('a) = n1 ==&gt; ... ==&gt; CARD('z) = n_z ==&gt; A ==&gt; B ==&gt; C into
        A ==&gt; B ==&gt; n1 != 0 ==&gt; ... ==&gt; n_z != 0 ==&gt; C *)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">eliminate_card_constraints</span> <span class="entity">ctxt</span> <span class="entity">thm</span> <span class="entity">n</span> <span class="main">=</span> 
    fold <span class="main">(</span>K <span class="main">(</span><span class="entity">eliminate_card_constraint</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>replicate <span class="entity">n</span> true<span class="main">)</span> <span class="entity">thm</span>
    
  <span class="comment1">(* turns A ==&gt; B[CARD('a)] ==&gt; C[CARD('a), CARD('b)] ==&gt; ... ==&gt; Z 
    into A ==&gt; B[n1] ==&gt; C[n1,n2] ==&gt; ... ==&gt; n1 != 0 ==&gt; n2 != 0 ==&gt; Z *)</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cancel_card_constraint</span> <span class="entity">thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ctxt</span> <span class="main">=</span> Proof_Context.init_global <span class="main">(</span>Thm.theory_of_thm <span class="entity">thm</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">n</span><span class="main">,</span><span class="entity">thm</span><span class="main">)</span> <span class="main">=</span> <span class="entity">extract_card_type</span> <span class="entity">ctxt</span> <span class="entity">thm</span>
  <span class="keyword2"><span class="keyword">in</span></span> 
    <span class="entity">eliminate_card_constraints</span> <span class="entity">ctxt</span> <span class="entity">thm</span> <span class="entity">n</span>
  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cancel_card_constraint_attr</span> <span class="main">=</span> Thm.rule_attribute <span class="main">[</span><span class="main">]</span> <span class="main">(</span>K <span class="entity">cancel_card_constraint</span><span class="main">)</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> Context.&gt;&gt; <span class="main">(</span>Context.map_theory <span class="main">(</span><span class="entity">Attrib.setup</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> cancel_card_constraint<span class="antiquote">}</span></span></span> 
    <span class="main">(</span>Scan.succeed <span class="entity">cancel_card_constraint_attr</span><span class="main">)</span> <span class="inner_quoted">"cancels carrier constraints"</span><span class="main">)</span><span class="main">)</span> 
<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Bij_Nat">
<div class="head">
<h1>Theory Bij_Nat</h1>
</div>
<pre class="source"><span class="comment1">(*
  Authors: J. Divasón, R. Thiemann, A. Yamada
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Connecting HMA-matrices with JNF-matrices›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following theories provide a connection between the type-based representation of vectors
  and matrices in HOL multivariate-analysis (HMA) with the set-based representation of vectors and matrices
  with integer indices in the Jordan-normal-form (JNF) development.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Bijections between index types of HMA and natural numbers›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹At the core of HMA-connect, there has to be a translation between indices
  of vectors and matrices, which are via index-types on the one hand, and natural
  numbers on the other hand.

  We some unspecified bijection in our application, and not the conversions
  to-nat and from-nat in theory 
  Rank-Nullity-Theorem/Mod-Type, since our definitions
  below do not enforce any further type constraints.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Bij_Nat
<span class="keyword2"><span class="keyword">imports</span></span> 
  <span class="quoted">"<a href="../../HOL/HOL-Library/Cardinality.html">HOL-Library.Cardinality</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Numeral_Type.html">HOL-Library.Numeral_Type</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_set_to_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">xs</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> finite list<span class="main">.</span> distinct <span class="bound">xs</span> <span class="main">∧</span> set <span class="bound">xs</span> <span class="main">=</span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">y</span> <span class="skolem">Y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">y</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">xs</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> xs insert<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">univ_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> finite list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">univ_list</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">xs</span><span class="main">.</span> distinct <span class="bound">xs</span> <span class="main">∧</span> set <span class="bound">xs</span> <span class="main">=</span> UNIV<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> univ_list<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>univ_list <span class="main">::</span> <span class="tfree">'a</span> list<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set univ_list <span class="main">=</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> finite set<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"univ_list <span class="main">::</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="var">?xs</span> <span class="main">∧</span> set <span class="var">?xs</span> <span class="main">=</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> univ_list_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI_ex<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> finite_set_to_list<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"distinct <span class="var">?xs</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?xs</span> <span class="main">=</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">to_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> finite <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">to_nat</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">i</span><span class="main">.</span> univ_list <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>univ_list <span class="main">::</span> <span class="tfree">'a</span> list<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">from_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> finite"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">from_nat</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> univ_list <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> length_univ_list_card<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>univ_list <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> finite list<span class="main">)</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> distinct_card<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"univ_list <span class="main">::</span> <span class="tfree">'a</span> list"</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> univ_list<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> to_nat_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span> <span class="bound">i</span><span class="main">.</span> univ_list <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> finite<span class="main">)</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>univ_list <span class="main">::</span> <span class="tfree">'a</span> list<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ul</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"univ_list <span class="main">::</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword1"><span class="command">have</span></span> a_in_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> set <span class="var">?ul</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> univ_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="main">[</span><span class="operator">unfolded</span> set_conv_nth<span class="main">]</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ul</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="var">?ul</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ex1I<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> i1<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ul</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> <span class="skolem">j</span> <span class="main">&lt;</span> length <span class="var">?ul</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="var">?ul</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> univ_list<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i1 nth_eq_iff_index_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> to_nat_less_card<span class="main">:</span> <span class="quoted"><span class="quoted">"to_nat <span class="main">(</span><span class="free">a</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> finite<span class="main">)</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ul</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"univ_list <span class="main">::</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword1"><span class="command">from</span></span> to_nat_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  i1<span class="main">:</span> <span class="quoted"><span class="quoted">"univ_list <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> <span class="skolem">i</span><span class="main">&lt;</span>length <span class="main">(</span>univ_list<span class="main">::</span><span class="tfree">'a</span> list<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> to_nat_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> someI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> i1<span class="main">)</span>
   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
   <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ul</span> <span class="main">!</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">&lt;</span> length <span class="var">?ul</span>"</span></span>
   <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> univ_list length_univ_list_card<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> to_nat_from_nat_id<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> finite<span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"to_nat <span class="main">(</span>from_nat <span class="free">i</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> to_nat_def from_nat_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> some_equality<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>univ_list<span class="main">::</span><span class="tfree">'a</span> list<span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>set <span class="main">(</span>univ_list<span class="main">::</span><span class="tfree">'a</span> list<span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> distinct_card<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> univ_list<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> i2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>univ_list<span class="main">::</span><span class="tfree">'a</span> list<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">unfolding</span></span> univ_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> 
   <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>univ_list<span class="main">::</span><span class="tfree">'a</span> list<span class="main">)</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span>univ_list<span class="main">::</span><span class="tfree">'a</span> list<span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∧</span> <span class="skolem">n</span> <span class="main">&lt;</span> length <span class="main">(</span>univ_list<span class="main">::</span><span class="tfree">'a</span> list<span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>univ_list<span class="main">::</span><span class="tfree">'a</span> list<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> univ_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>      
   <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nth_eq_iff_index_eq<span class="main">[</span><span class="operator">OF</span> d _ i2<span class="main">]</span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> from_nat_inj<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> finite<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> finite<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>from_nat <span class="free">i</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> from_nat <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> id<span class="main">,</span> <span class="operator">of</span> <span class="quoted">to_nat</span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> i j <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_nat_from_nat_id<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> from_nat_to_nat_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>from_nat <span class="main">(</span>to_nat <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">::</span> finite<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> a_in_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> set <span class="main">(</span>univ_list<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> univ_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="main">[</span><span class="operator">unfolded</span> set_conv_nth<span class="main">]</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i1<span class="main">:</span> <span class="quoted"><span class="quoted">"univ_list <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> <span class="skolem">i</span><span class="main">&lt;</span>length <span class="main">(</span>univ_list<span class="main">::</span><span class="tfree">'a</span> list<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> to_nat_def from_nat_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> i1<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> to_nat_inj<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"to_nat <span class="free">a</span> <span class="main">=</span> to_nat <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> to_nat_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> to_nat_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> to_nat_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms from_nat_to_nat_id<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> range_to_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>to_nat <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> finite <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="var">?l</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> to_nat_less_card<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span> <span class="main"><span class="main">=</span></span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="var">?r</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> to_nat_from_nat_id<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="var">?l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> range_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inj_to_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"inj to_nat"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bij_to_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw to_nat <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> finite set<span class="main">)</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> range_to_nat inj_to_nat<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> numeral_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>numeral <span class="free">m1</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">*</span> numeral <span class="free">n1</span> <span class="main">≡</span> numeral <span class="main">(</span><span class="free">m1</span> <span class="main">*</span> <span class="free">n1</span><span class="main">)</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>numeral <span class="free">m1</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">+</span> numeral <span class="free">n1</span> <span class="main">≡</span> numeral <span class="main">(</span><span class="free">m1</span> <span class="main">+</span> <span class="free">n1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemmas</span></span> card_num_simps <span class="main">=</span> 
  card_num1 card_bit0 card_bit1 
  mult_num_simps
  add_num_simps 
  eq_num_simps
  mult_Suc_right mult_0_right One_nat_def add.right_neutral 
  numeral_nat Suc_numeral 

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="HMA_Connect">
<div class="head">
<h1>Theory HMA_Connect</h1>
</div>
<pre class="source"><span class="comment1">(*
  Authors: J. Divasón, R. Thiemann, A. Yamada, O. Kunčar
*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transfer rules to convert theorems from JNF to HMA and vice-versa.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> HMA_Connect
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="../Jordan_Normal_Form/Spectral_Radius.html">Jordan_Normal_Form.Spectral_Radius</a> 
  <span class="quoted">"<a href="../../HOL/HOL-Analysis/Determinants.html">HOL-Analysis.Determinants</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Analysis/Cartesian_Euclidean_Space.html">HOL-Analysis.Cartesian_Euclidean_Space</a>"</span>
  <a href="Bij_Nat.html">Bij_Nat</a>
  <a href="Cancel_Card_Constraint.html">Cancel_Card_Constraint</a>
  <span class="quoted">"<a href="../../HOL/HOL-Eisbach/Eisbach.html">HOL-Eisbach.Eisbach</a>"</span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Prefer certain constants and lemmas without prefix.›</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Matrix.mat
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Matrix.row
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Determinant.det

<span class="keyword1"><span class="command">lemmas</span></span> mat_def <span class="main">=</span> Finite_Cartesian_Product.mat_def
<span class="keyword1"><span class="command">lemmas</span></span> det_def <span class="main">=</span> Determinants.det_def
<span class="keyword1"><span class="command">lemmas</span></span> row_def <span class="main">=</span> Finite_Cartesian_Product.row_def

<span class="keyword1"><span class="command">notation</span></span> vec_index <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">$v</span>"</span> 90<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> vec_nth <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">$h</span>"</span> 90<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Forget that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> mat"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> Matrix.vec"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> poly"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
  have been defined via lifting›</span></span>


<span class="comment1">(* TODO: add to end of matrix theory, stores lifting + transfer setup *)</span>
<span class="keyword1"><span class="command">lifting_forget</span></span> vec.lifting
<span class="keyword1"><span class="command">lifting_forget</span></span> mat.lifting

<span class="keyword1"><span class="command">lifting_forget</span></span> poly.lifting

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some notions which we did not find in the HMA-world.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eigen_vector</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>comm_ring_1 <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eigen_vector</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ev</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">*v</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ev</span></span></span> <span class="keyword1">*s</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eigen_value</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> comm_ring_1 <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eigen_value</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> eigen_vector <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">similar_matrix_wit</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> semiring_1 <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">similar_matrix_wit</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">**</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">=</span> mat <span class="main">1</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">**</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> mat <span class="main">1</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">**</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">**</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">similar_matrix</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> semiring_1 <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">similar_matrix</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> similar_matrix_wit <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="bound">P</span> <span class="bound">Q</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">spectral_radius</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">spectral_radius</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> Max <span class="main">{</span> norm <span class="bound">ev</span> <span class="main">|</span> <span class="bound">v</span> <span class="bound">ev</span><span class="main">.</span> eigen_vector <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">v</span> <span class="bound">ev</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Spectrum</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> field <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Spectrum</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> Collect <span class="main">(</span>eigen_value <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vec_elements_h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vec_elements_h</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> range <span class="main">(</span>vec_nth <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vec_elements_h_def'<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_elements_h <span class="free">v</span> <span class="main">=</span> <span class="main">{</span><span class="free">v</span> <span class="keyword1">$h</span> <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> True<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vec_elements_h_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">elements_mat_h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'nc</span> <span class="main">^</span> <span class="tfree">'nr</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">elements_mat_h</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> range <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">$h</span> <span class="bound">i</span> <span class="keyword1">$h</span> <span class="bound">j</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> elements_mat_h_def'<span class="main">:</span> <span class="quoted"><span class="quoted">"elements_mat_h <span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="free">A</span> <span class="keyword1">$h</span> <span class="bound">i</span> <span class="keyword1">$h</span> <span class="bound">j</span> <span class="main">|</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> True<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> elements_mat_h_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">map_vector</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">^</span><span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">^</span><span class="tfree">'n</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">map_vector</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">$h</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">map_matrix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'m</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'m</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">map_matrix</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> map_vector <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">$h</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">normbound</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> real_normed_field <span class="main">^</span> <span class="tfree">'nc</span> <span class="main">^</span> <span class="tfree">'nr</span> <span class="main">⇒</span> real <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">normbound</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> elements_mat_h <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> norm <span class="bound">x</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> spectral_radius_ev_def<span class="main">:</span> <span class="quoted"><span class="quoted">"spectral_radius <span class="free">A</span> <span class="main">=</span> Max <span class="main">(</span>norm <span class="main">`</span> <span class="main">(</span>Collect <span class="main">(</span>eigen_value <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spectral_radius_def eigen_value_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">Max</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> elements_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"elements_mat <span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">|</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> dim_col <span class="free">A</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> elements_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vec_elements</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Matrix.vec <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">vec_elements</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> set <span class="main">[</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">$</span> <span class="bound">i</span><span class="main">.</span> i <span class="main">&lt;-</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> dim_vec <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> vec_elements<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_elements <span class="free">v</span> <span class="main">=</span> <span class="main">{</span> <span class="free">v</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_vec <span class="free">v</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vec_elements_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="comment1">(* TODO: restore a bundle, for e.g., for matrix_impl *)</span>
<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> vec.lifting 
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">from_hma<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'n</span>  <span class="main">⇒</span> <span class="tfree">'a</span> Matrix.vec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">from_hma<span class="hidden">⇩</span><sub>v</sub></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> Matrix.vec <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">$h</span> from_nat <span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">from_hma<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'nc</span> <span class="main">^</span> <span class="tfree">'nr</span> <span class="main">⇒</span> <span class="tfree">'a</span> Matrix.mat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">from_hma<span class="hidden">⇩</span><sub>m</sub></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> Matrix.mat <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'nr</span><span class="main">)</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'nc</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">$h</span> from_nat <span class="bound">i</span> <span class="keyword1">$h</span> from_nat <span class="bound">j</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">to_hma<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Matrix.vec <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'n</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">to_hma<span class="hidden">⇩</span><sub>v</sub></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">$v</span> to_nat <span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">to_hma<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Matrix.mat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'nc</span>  <span class="main">^</span> <span class="tfree">'nr</span> "</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">to_hma<span class="hidden">⇩</span><sub>m</sub></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">$$</span> <span class="main">(</span>to_nat <span class="bound">i</span><span class="main">,</span> to_nat <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> vec_lambda_eta<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> to_hma_from_hma<span class="hidden">⇩</span><sub>v</sub><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"to_hma<span class="hidden">⇩</span><sub>v</sub> <span class="main">(</span>from_hma<span class="hidden">⇩</span><sub>v</sub> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_hma<span class="hidden">⇩</span><sub>v</sub>_def from_hma<span class="hidden">⇩</span><sub>v</sub>_def to_nat_less_card<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> to_hma_from_hma<span class="hidden">⇩</span><sub>m</sub><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"to_hma<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>from_hma<span class="hidden">⇩</span><sub>m</sub> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_hma<span class="hidden">⇩</span><sub>m</sub>_def from_hma<span class="hidden">⇩</span><sub>m</sub>_def to_nat_less_card<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> from_hma_to_hma<span class="hidden">⇩</span><sub>v</sub><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> carrier_vec <span class="main">(</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> from_hma<span class="hidden">⇩</span><sub>v</sub> <span class="main">(</span>to_hma<span class="hidden">⇩</span><sub>v</sub> <span class="free">v</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'n</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_hma<span class="hidden">⇩</span><sub>v</sub>_def from_hma<span class="hidden">⇩</span><sub>v</sub>_def to_nat_from_nat_id<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> from_hma_to_hma<span class="hidden">⇩</span><sub>m</sub><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="main">(</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'nr</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'nc</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> from_hma<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span>to_hma<span class="hidden">⇩</span><sub>m</sub> <span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'nc</span>  <span class="main">^</span> <span class="tfree">'nr</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_hma<span class="hidden">⇩</span><sub>m</sub>_def from_hma<span class="hidden">⇩</span><sub>m</sub>_def to_nat_from_nat_id<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> from_hma<span class="hidden">⇩</span><sub>v</sub>_inj<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"from_hma<span class="hidden">⇩</span><sub>v</sub> <span class="free">x</span> <span class="main">=</span> from_hma<span class="hidden">⇩</span><sub>v</sub> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> to_hma_from_hma<span class="hidden">⇩</span><sub>v</sub><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> from_hma<span class="hidden">⇩</span><sub>m</sub>_inj<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"from_hma<span class="hidden">⇩</span><sub>m</sub> <span class="free">x</span> <span class="main">=</span> from_hma<span class="hidden">⇩</span><sub>m</sub> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> to_hma_from_hma<span class="hidden">⇩</span><sub>m</sub><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HMA_V</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Matrix.vec <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'n</span>  <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">HMA_V</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">v</span> <span class="main">=</span> from_hma<span class="hidden">⇩</span><sub>v</sub> <span class="bound">w</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HMA_M</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Matrix.mat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'nc</span>  <span class="main">^</span> <span class="tfree">'nr</span>  <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">HMA_M</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">=</span> from_hma<span class="hidden">⇩</span><sub>m</sub> <span class="bound">b</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HMA_I</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'n</span> <span class="main">::</span> finite <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HMA_I</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">i</span> <span class="main">=</span> to_nat <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Domainp_HMA_V <span class="main">[</span><span class="operator">transfer_domain_rule</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Domainp <span class="main">(</span>HMA_V <span class="main">::</span> <span class="tfree">'a</span> Matrix.vec <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> carrier_vec <span class="main">(</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span> <span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> ext iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> from_hma_to_hma<span class="hidden">⇩</span><sub>v</sub><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> from_hma<span class="hidden">⇩</span><sub>v</sub>_def HMA_V_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Domainp_HMA_M <span class="main">[</span><span class="operator">transfer_domain_rule</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Domainp <span class="main">(</span>HMA_M <span class="main">::</span> <span class="tfree">'a</span> Matrix.mat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'nc</span>  <span class="main">^</span> <span class="tfree">'nr</span>  <span class="main">⇒</span> bool<span class="main">)</span> 
  <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> carrier_mat <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'nr</span><span class="main">)</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'nc</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ext iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> from_hma_to_hma<span class="hidden">⇩</span><sub>m</sub><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> from_hma<span class="hidden">⇩</span><sub>m</sub>_def HMA_M_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Domainp_HMA_I <span class="main">[</span><span class="operator">transfer_domain_rule</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Domainp <span class="main">(</span>HMA_I <span class="main">::</span> nat <span class="main">⇒</span> <span class="tfree">'n</span> <span class="main">::</span> finite <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?r</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> HMA_I_def Domainp_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"from_nat <span class="skolem">i</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_nat_from_nat_id to_nat_less_card<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bi_unique_HMA_V <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bi_unique HMA_V"</span></span> <span class="quoted"><span class="quoted">"left_unique HMA_V"</span></span> <span class="quoted"><span class="quoted">"right_unique HMA_V"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> HMA_V_def bi_unique_def left_unique_def right_unique_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> bi_unique_HMA_M <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bi_unique HMA_M"</span></span> <span class="quoted"><span class="quoted">"left_unique HMA_M"</span></span> <span class="quoted"><span class="quoted">"right_unique HMA_M"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> HMA_M_def bi_unique_def left_unique_def right_unique_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> bi_unique_HMA_I <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bi_unique HMA_I"</span></span> <span class="quoted"><span class="quoted">"left_unique HMA_I"</span></span> <span class="quoted"><span class="quoted">"right_unique HMA_I"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> HMA_I_def bi_unique_def left_unique_def right_unique_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> right_total_HMA_V <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"right_total HMA_V"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> HMA_V_def right_total_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> right_total_HMA_M <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"right_total HMA_M"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> HMA_M_def right_total_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> right_total_HMA_I <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"right_total HMA_I"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> HMA_I_def right_total_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_V_index <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>HMA_V <span class="main">===&gt;</span> HMA_I <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> <span class="keyword1">($v)</span> <span class="keyword1">($h)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_fun_def HMA_V_def HMA_I_def from_hma<span class="hidden">⇩</span><sub>v</sub>_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_nat_less_card<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We introduce the index function to have pointwise access to 
  HMA-matrices by a constant. Otherwise, the transfer rule 
  with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">A</span></span> <span class="bound"><span class="bound">i</span></span> <span class="bound"><span class="bound">j</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">A</span></span> <span class="keyword1"><span class="keyword1">$h</span></span> <span class="bound"><span class="bound">i</span></span> <span class="keyword1"><span class="keyword1">$h</span></span> <span class="bound"><span class="bound">j</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> instead of index is not applicable.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">index_hma</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">$h</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">$h</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_M_index <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>HMA_M <span class="main">===&gt;</span> HMA_I <span class="main">===&gt;</span> HMA_I <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">A</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">A</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> index_hma"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> rel_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_hma_def to_nat_less_card HMA_M_def HMA_I_def from_hma<span class="hidden">⇩</span><sub>m</sub>_def<span class="main">)</span>  

<span class="keyword1"><span class="command">lemma</span></span> HMA_V_0 <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"HMA_V <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> zero <span class="main">^</span> <span class="tfree">'n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> HMA_V_def from_hma<span class="hidden">⇩</span><sub>v</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_M_0 <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"HMA_M <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'nr</span><span class="main">)</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'nc</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> zero <span class="main">^</span> <span class="tfree">'nc</span>  <span class="main">^</span> <span class="tfree">'nr</span> <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> HMA_M_def from_hma<span class="hidden">⇩</span><sub>m</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_M_1<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"HMA_M <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mat <span class="main">1</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>zero<span class="main">,</span>one<span class="main">}</span><span class="main">^</span><span class="tfree">'n</span><span class="main">^</span><span class="tfree">'n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> HMA_M_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mat_def from_hma<span class="hidden">⇩</span><sub>m</sub>_def from_nat_inj<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> from_hma<span class="hidden">⇩</span><sub>v</sub>_add<span class="main">:</span> <span class="quoted"><span class="quoted">"from_hma<span class="hidden">⇩</span><sub>v</sub> <span class="free">v</span> <span class="main">+</span> from_hma<span class="hidden">⇩</span><sub>v</sub> <span class="free">w</span> <span class="main">=</span> from_hma<span class="hidden">⇩</span><sub>v</sub> <span class="main">(</span><span class="free">v</span> <span class="main">+</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> from_hma<span class="hidden">⇩</span><sub>v</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_V_add <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>HMA_V <span class="main">===&gt;</span> HMA_V <span class="main">===&gt;</span> HMA_V<span class="main">)</span> <span class="main">(+)</span> <span class="main">(+)</span> "</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_fun_def HMA_V_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> from_hma<span class="hidden">⇩</span><sub>v</sub>_add<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> from_hma<span class="hidden">⇩</span><sub>v</sub>_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"from_hma<span class="hidden">⇩</span><sub>v</sub> <span class="free">v</span> <span class="main">-</span> from_hma<span class="hidden">⇩</span><sub>v</sub> <span class="free">w</span> <span class="main">=</span> from_hma<span class="hidden">⇩</span><sub>v</sub> <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> from_hma<span class="hidden">⇩</span><sub>v</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_V_diff <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>HMA_V <span class="main">===&gt;</span> HMA_V <span class="main">===&gt;</span> HMA_V<span class="main">)</span> <span class="main">(-)</span> <span class="main">(-)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_fun_def HMA_V_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> from_hma<span class="hidden">⇩</span><sub>v</sub>_diff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> from_hma<span class="hidden">⇩</span><sub>m</sub>_add<span class="main">:</span> <span class="quoted"><span class="quoted">"from_hma<span class="hidden">⇩</span><sub>m</sub> <span class="free">a</span> <span class="main">+</span> from_hma<span class="hidden">⇩</span><sub>m</sub> <span class="free">b</span> <span class="main">=</span> from_hma<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> from_hma<span class="hidden">⇩</span><sub>m</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_M_add <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>HMA_M <span class="main">===&gt;</span> HMA_M <span class="main">===&gt;</span> HMA_M<span class="main">)</span> <span class="main">(+)</span> <span class="main">(+)</span> "</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_fun_def HMA_M_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> from_hma<span class="hidden">⇩</span><sub>m</sub>_add<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> from_hma<span class="hidden">⇩</span><sub>m</sub>_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"from_hma<span class="hidden">⇩</span><sub>m</sub> <span class="free">a</span> <span class="main">-</span> from_hma<span class="hidden">⇩</span><sub>m</sub> <span class="free">b</span> <span class="main">=</span> from_hma<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> from_hma<span class="hidden">⇩</span><sub>m</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_M_diff <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>HMA_M <span class="main">===&gt;</span> HMA_M <span class="main">===&gt;</span> HMA_M<span class="main">)</span> <span class="main">(-)</span> <span class="main">(-)</span> "</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_fun_def HMA_M_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> from_hma<span class="hidden">⇩</span><sub>m</sub>_diff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> scalar_product<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> semiring_1 <span class="main">^</span> <span class="tfree">'n</span> "</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"scalar_prod <span class="main">(</span>from_hma<span class="hidden">⇩</span><sub>v</sub> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>from_hma<span class="hidden">⇩</span><sub>v</sub> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> scalar_product <span class="free">v</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> scalar_product_def scalar_prod_def from_hma<span class="hidden">⇩</span><sub>v</sub>_def dim_vec
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.reindex<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj_to_nat<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> range_to_nat<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"from_hma<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span><span class="free">y</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'nc</span>  <span class="main">^</span> <span class="tfree">'nr</span><span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="main">(</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'nr</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'nc</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>from_hma<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span><span class="free">y</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'nc</span>  <span class="main">^</span> <span class="tfree">'nr</span> <span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'nr</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>from_hma<span class="hidden">⇩</span><sub>m</sub> <span class="main">(</span><span class="free">y</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'nc</span>  <span class="main">^</span> <span class="tfree">'nr</span> <span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'nc</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> from_hma<span class="hidden">⇩</span><sub>m</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"from_hma<span class="hidden">⇩</span><sub>v</sub> <span class="main">(</span><span class="free">y</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'n</span><span class="main">)</span> <span class="main">∈</span> carrier_vec <span class="main">(</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>from_hma<span class="hidden">⇩</span><sub>v</sub> <span class="main">(</span><span class="free">y</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> from_hma<span class="hidden">⇩</span><sub>v</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">declare</span></span> rel_funI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_scalar_prod <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>HMA_V <span class="main">===&gt;</span> HMA_V <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> scalar_prod scalar_product"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HMA_V_def scalar_product<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_row <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>HMA_I <span class="main">===&gt;</span> HMA_M <span class="main">===&gt;</span> HMA_V<span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span> <span class="bound">a</span><span class="main">.</span> Matrix.row <span class="bound">a</span> <span class="bound">i</span><span class="main">)</span> row"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> HMA_M_def HMA_I_def HMA_V_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> from_hma<span class="hidden">⇩</span><sub>m</sub>_def from_hma<span class="hidden">⇩</span><sub>v</sub>_def to_nat_less_card row_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_col <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>HMA_I <span class="main">===&gt;</span> HMA_M <span class="main">===&gt;</span> HMA_V<span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span> <span class="bound">a</span><span class="main">.</span> col <span class="bound">a</span> <span class="bound">i</span><span class="main">)</span> column"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> HMA_M_def HMA_I_def HMA_V_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> from_hma<span class="hidden">⇩</span><sub>m</sub>_def from_hma<span class="hidden">⇩</span><sub>v</sub>_def to_nat_less_card column_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mk_mat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'j</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">^</span><span class="tfree">'j</span><span class="main">^</span><span class="tfree">'i</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mk_mat</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mk_vec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">^</span><span class="tfree">'i</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mk_vec</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_M_mk_mat<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>HMA_I <span class="main">===&gt;</span> HMA_I <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">===&gt;</span> HMA_M<span class="main">)</span> 
  <span class="main">(</span><span class="main">λ</span> <span class="bound">f</span><span class="main">.</span> Matrix.mat <span class="main">(</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'nr</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'nc</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">(</span>mk_mat <span class="main">::</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'nr</span> <span class="main">⇒</span> <span class="tfree">'nc</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'nc</span><span class="main">^</span><span class="tfree">'nr</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">ya</span> <span class="main">::</span> <span class="tfree">'nr</span><span class="main">)</span> <span class="main">(</span><span class="bound">yb</span> <span class="main">::</span> <span class="tfree">'nc</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">(</span>to_nat <span class="bound">ya</span><span class="main">)</span> <span class="main">(</span>to_nat <span class="bound">yb</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">y</span> <span class="bound">ya</span> <span class="bound">yb</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'nr</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'nc</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> to_nat_from_nat_id<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> to_nat_from_nat_id<span class="main">[</span><span class="operator">OF</span> j<span class="main">]</span> id<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"from_nat <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"from_nat <span class="skolem">j</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">(</span>from_nat <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>from_nat <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_fun_def mk_mat_def HMA_M_def HMA_I_def from_hma<span class="hidden">⇩</span><sub>m</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_M_mk_vec<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>HMA_I <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">===&gt;</span> HMA_V<span class="main">)</span> 
  <span class="main">(</span><span class="main">λ</span> <span class="bound">f</span><span class="main">.</span> Matrix.vec <span class="main">(</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">(</span>mk_vec <span class="main">::</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">ya</span> <span class="main">::</span> <span class="tfree">'n</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">(</span>to_nat <span class="bound">ya</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">y</span> <span class="bound">ya</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> to_nat_from_nat_id<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> id<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"from_nat <span class="skolem">i</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">(</span>from_nat <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_fun_def mk_vec_def HMA_V_def HMA_I_def from_hma<span class="hidden">⇩</span><sub>v</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> mat_mult_scalar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">**</span> <span class="free">B</span> <span class="main">=</span> mk_mat <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> scalar_product <span class="main">(</span>row <span class="bound">i</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>column <span class="bound">j</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vec_eq_iff matrix_matrix_mult_def scalar_product_def mk_mat_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> row_def column_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_mat_vec_scalar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> <span class="free">v</span> <span class="main">=</span> mk_vec <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> scalar_product <span class="main">(</span>row <span class="bound">i</span> <span class="free">A</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vec_eq_iff matrix_vector_mult_def scalar_product_def mk_mat_def mk_vec_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> row_def column_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dim_row_transfer_rule<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"HMA_M <span class="free">A</span> <span class="main">(</span><span class="free">A'</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'nc</span> <span class="main">^</span> <span class="tfree">'nr</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(=)</span> <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'nr</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> HMA_M_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> dim_col_transfer_rule<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"HMA_M <span class="free">A</span> <span class="main">(</span><span class="free">A'</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'nc</span> <span class="main">^</span> <span class="tfree">'nr</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(=)</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'nc</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> HMA_M_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_M_mult <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>HMA_M <span class="main">===&gt;</span> HMA_M <span class="main">===&gt;</span> HMA_M<span class="main">)</span> <span class="main">(</span><span class="main">(*)</span><span class="main">)</span> <span class="main">(</span><span class="main">(**)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> semiring_1 mat"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">A'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'n</span>  <span class="main">^</span> <span class="tfree">'nr</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">B'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'nc</span> <span class="main">^</span> <span class="tfree">'n</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"HMA_M <span class="skolem">A</span> <span class="skolem">A'</span>"</span></span> <span class="quoted"><span class="quoted">"HMA_M <span class="skolem">B</span> <span class="skolem">B'</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> <span class="main">=</span> dim_row_transfer_rule<span class="main">[</span><span class="operator">OF</span> 1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> dim_col_transfer_rule<span class="main">[</span><span class="operator">OF</span> 1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"HMA_M <span class="main">(</span><span class="skolem">A</span> <span class="main">*</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">(</span><span class="skolem">A'</span> <span class="main">**</span> <span class="skolem">B'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> times_mat_def mat_mult_scalar
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer_prover_start</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer_step</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
      

<span class="keyword1"><span class="command">lemma</span></span> HMA_V_smult <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(=)</span> <span class="main">===&gt;</span> HMA_V <span class="main">===&gt;</span> HMA_V<span class="main">)</span> <span class="keyword1">(⋅<span class="hidden">⇩</span><sub>v</sub>)</span> <span class="main">(</span><span class="keyword1">(*s)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> smult_vec_def 
  <span class="keyword1"><span class="command">unfolding</span></span> rel_fun_def HMA_V_def from_hma<span class="hidden">⇩</span><sub>v</sub>_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_M_mult_vec <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>HMA_M <span class="main">===&gt;</span> HMA_V <span class="main">===&gt;</span> HMA_V<span class="main">)</span> <span class="main">(</span><span class="keyword1">(*<span class="hidden">⇩</span><sub>v</sub>)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">(*v)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> semiring_1 mat"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Matrix.vec"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">A'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'nc</span>  <span class="main">^</span> <span class="tfree">'nr</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">v'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'nc</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"HMA_M <span class="skolem">A</span> <span class="skolem">A'</span>"</span></span> <span class="quoted"><span class="quoted">"HMA_V <span class="skolem">v</span> <span class="skolem">v'</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> <span class="main">=</span> dim_row_transfer_rule
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"HMA_V <span class="main">(</span><span class="skolem">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span><span class="skolem">A'</span> <span class="keyword1">*v</span> <span class="skolem">v'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mult_mat_vec_def mult_mat_vec_scalar
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer_prover_start</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer_step</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_det <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>HMA_M <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> Determinant.det 
  <span class="main">(</span>det <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> comm_ring_1 <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tn</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"to_nat <span class="main">::</span> <span class="tfree">'n</span> <span class="main">::</span> finite <span class="main">⇒</span> nat"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fn</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"from_nat <span class="main">::</span> nat <span class="main">⇒</span> <span class="tfree">'n</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?zn</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"UNIV <span class="main">::</span> <span class="tfree">'n</span> set"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="keyword1">permutes</span> <span class="var">?zn</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="keyword1">permutes</span> <span class="var">?U</span><span class="main">}</span>"</span></span>  
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span><span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">p</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">∈</span> <span class="var">?U</span> <span class="keyword1">then</span> <span class="var">?fn</span> <span class="main">(</span><span class="bound">p</span> <span class="main">(</span><span class="var">?tn</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">p</span> <span class="bound">i</span><span class="main">.</span> <span class="var">?fn</span> <span class="main">(</span><span class="bound">p</span> <span class="main">(</span><span class="var">?tn</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> <span class="var">?U</span> <span class="keyword1">then</span> <span class="bound">b</span> <span class="keyword1">else</span> <span class="bound">c</span><span class="main">)</span> <span class="main">=</span> <span class="bound">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p2</span> <span class="main">=</span> <span class="var">?f</span> <span class="main">`</span> <span class="var">?p1</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> permutes_bij'<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_nat_less_card to_nat_from_nat_id<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?p2</span> <span class="main">=</span> <span class="var">?g</span> <span class="main">`</span> <span class="var">?p1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> inj_g<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="var">?g</span> <span class="var">?p1</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ballI impI ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">permutes</span> <span class="var">?zn</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">permutes</span> <span class="var">?zn</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="var">?fn</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">(</span><span class="var">?tn</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="var">?fn</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">(</span><span class="var">?tn</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
        <span class="keyword1"><span class="command">from</span></span> permutes_in_image<span class="main">[</span><span class="operator">OF</span> p<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> pi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">(</span><span class="var">?tn</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_nat_less_card<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> permutes_in_image<span class="main">[</span><span class="operator">OF</span> q<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> qi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">(</span><span class="var">?tn</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_nat_less_card<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> fun_cong<span class="main">[</span><span class="operator">OF</span> id<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fn</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">(</span><span class="var">?tn</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>  <span class="main">=</span> from_nat <span class="main">(</span><span class="skolem">q</span> <span class="main">(</span><span class="var">?tn</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?tn</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">(</span><span class="var">?tn</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">(</span><span class="var">?tn</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_nat_from_nat_id pi qi<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> id <span class="main">=</span> this             
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">q</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?tn</span> <span class="main">(</span><span class="var">?fn</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_nat_from_nat_id<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?fn</span> <span class="skolem">i</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> p q <span class="keyword1"><span class="command">unfolding</span></span> permutes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> mult_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span><span class="main">.</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="bound">c</span> <span class="main">=</span> <span class="bound">d</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">c</span> <span class="main">=</span> <span class="bound">b</span> <span class="main">*</span> <span class="bound">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> 
      signof <span class="bound">p</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span><span class="var">?zn</span><span class="main">.</span> <span class="skolem">a</span> <span class="keyword1">$h</span> <span class="var">?fn</span> <span class="bound">i</span> <span class="keyword1">$h</span> <span class="var">?fn</span> <span class="main">(</span><span class="bound">p</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?p1</span>
      <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span> <span class="bound">p</span><span class="main">.</span> of_int <span class="main">(</span>sign <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="skolem">a</span> <span class="keyword1">$h</span> <span class="bound">i</span> <span class="keyword1">$h</span> <span class="bound">p</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="var">?p2</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> id sum.reindex<span class="main">[</span><span class="operator">OF</span> inj_g<span class="main">]</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> mem_Collect_eq o_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> mult_cong<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">permutes</span> <span class="var">?zn</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="var">?fn</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">(</span><span class="var">?tn</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> id p <span class="keyword1"><span class="command">have</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?q</span> <span class="keyword1">permutes</span> <span class="var">?U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> pp<span class="main">:</span> <span class="quoted"><span class="quoted">"permutation <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> permutation_permutes <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ft</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">p</span> <span class="bound">i</span><span class="main">.</span> <span class="var">?fn</span> <span class="main">(</span><span class="bound">p</span> <span class="main">(</span><span class="var">?tn</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?zn</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sign <span class="skolem">p</span> <span class="main">=</span> sign <span class="var">?q</span> <span class="main">∧</span> <span class="skolem">p</span> <span class="keyword1">permutes</span> <span class="var">?zn</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> permutes_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin _ _ p<span class="main"><span class="main">]</span></span><span class="main">)</span>    
        <span class="keyword3"><span class="command">case</span></span> 1 
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sign_id<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> id_def<span class="main"><span class="main">]</span></span> permutes_id<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> id_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">p</span><span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sab</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun.swap <span class="skolem">a</span> <span class="skolem">b</span> id"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sfab</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Fun.swap <span class="main">(</span><span class="var">?fn</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span><span class="var">?fn</span> <span class="skolem">b</span><span class="main">)</span> id"</span></span>
        <span class="keyword1"><span class="command">have</span></span> p_sab<span class="main">:</span> <span class="quoted"><span class="quoted">"permutation <span class="var">?sab</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> permutation_swap_id<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> p_sfab<span class="main">:</span> <span class="quoted"><span class="quoted">"permutation <span class="var">?sfab</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> permutation_swap_id<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> IH1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">permutes</span> <span class="var">?zn</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> IH2<span class="main">:</span> <span class="quoted"><span class="quoted">"sign <span class="skolem">p</span> <span class="main">=</span> sign <span class="main">(</span><span class="var">?ft</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> sab_perm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?sab</span> <span class="keyword1">permutes</span> <span class="var">?zn</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1-2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> permutes_swap_id<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> permutes_compose<span class="main">[</span><span class="operator">OF</span> IH1 this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> perm1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?sab</span> <span class="keyword1">o</span> <span class="skolem">p</span> <span class="keyword1">permutes</span> <span class="var">?zn</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">from</span></span> IH1 <span class="keyword1"><span class="command">have</span></span> p_p1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="var">?p1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ft</span> <span class="skolem">p</span> <span class="main">∈</span> <span class="var">?ft</span> <span class="main">`</span> <span class="var">?p1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> imageI<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">folded</span> id<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ft</span> <span class="skolem">p</span> <span class="keyword1">permutes</span> <span class="var">?U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> p_ftp<span class="main">:</span> <span class="quoted"><span class="quoted">"permutation <span class="main">(</span><span class="var">?ft</span> <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> permutation_permutes <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
          <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="var">?zn</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="var">?zn</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?fn</span> <span class="skolem">a</span> <span class="main">=</span> <span class="var">?fn</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1-2<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> from_nat_inj<span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> inj <span class="main">=</span> this
        <span class="keyword1"><span class="command">from</span></span> inj<span class="main">[</span><span class="operator">OF</span> 2<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> id2<span class="main">:</span> <span class="quoted"><span class="quoted">"sign <span class="var">?sfab</span> <span class="main">=</span> sign <span class="var">?sab</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sign_swap_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ft</span> <span class="main">(</span>Fun.swap <span class="skolem">a</span> <span class="skolem">b</span> id <span class="main">∘</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Fun.swap <span class="main">(</span><span class="var">?fn</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span><span class="var">?fn</span> <span class="skolem">b</span><span class="main">)</span> id <span class="main">∘</span> <span class="var">?ft</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> 
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ft</span> <span class="main">(</span>Fun.swap <span class="skolem">a</span> <span class="skolem">b</span> id <span class="main">∘</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span>Fun.swap <span class="main">(</span><span class="var">?fn</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span><span class="var">?fn</span> <span class="skolem">b</span><span class="main">)</span> id <span class="main">∘</span> <span class="var">?ft</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">c</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">(</span><span class="var">?tn</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">∨</span> <span class="skolem">p</span> <span class="main">(</span><span class="var">?tn</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def swap_def<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">hence</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">(</span><span class="var">?tn</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">(</span><span class="var">?tn</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> pc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">(</span><span class="var">?tn</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?zn</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> permutes_in_image<span class="main">[</span><span class="operator">OF</span> IH1<span class="main">]</span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_nat_less_card<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> neq<span class="main">[</span><span class="operator">folded</span> inj<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">OF</span></span> pc 2<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> inj<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">OF</span></span> pc 2<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fn</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">(</span><span class="var">?tn</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="var">?fn</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fn</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">(</span><span class="var">?tn</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="var">?fn</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
            <span class="keyword1"><span class="command">with</span></span> neq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def swap_def<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> IH2 id sign_compose<span class="main">[</span><span class="operator">OF</span> p_sab 2<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> sign_compose<span class="main">[</span><span class="operator">OF</span> p_sfab p_ftp<span class="main">]</span> id2 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl perm1<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"signof <span class="skolem">p</span> <span class="main">=</span> of_int <span class="main">(</span>sign <span class="var">?q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> signof_def sign_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span><span class="main">.</span> <span class="skolem">a</span> <span class="keyword1">$h</span> <span class="var">?fn</span> <span class="bound">i</span> <span class="keyword1">$h</span> <span class="var">?fn</span> <span class="main">(</span><span class="skolem">p</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
           <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="skolem">a</span> <span class="keyword1">$h</span> <span class="bound">i</span> <span class="keyword1">$h</span> <span class="var">?q</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 
           range_to_nat<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> prod.reindex<span class="main">[</span><span class="operator">OF</span> inj_to_nat<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> o_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>   
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> HMA_M_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> from_hma<span class="hidden">⇩</span><sub>m</sub>_def Determinant.det_def det_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_mat<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(=)</span> <span class="main">===&gt;</span> HMA_M<span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span><span class="main">)</span> 
  <span class="main">(</span>Finite_Cartesian_Product.mat <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>semiring_1 <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">^</span><span class="tfree">'n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Finite_Cartesian_Product.mat_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> rel_fun_def HMA_M_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> from_hma<span class="hidden">⇩</span><sub>m</sub>_def from_nat_inj<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> HMA_mat_minus<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>HMA_M <span class="main">===&gt;</span> HMA_M <span class="main">===&gt;</span> HMA_M<span class="main">)</span> 
  <span class="main">(</span><span class="main">λ</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="bound">A</span> <span class="main">+</span> map_mat uminus <span class="bound">B</span><span class="main">)</span> <span class="main">(</span><span class="main">(-)</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> group_add <span class="main">^</span><span class="tfree">'nc</span><span class="main">^</span><span class="tfree">'nr</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'nc</span><span class="main">^</span><span class="tfree">'nr</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'nc</span><span class="main">^</span><span class="tfree">'nr</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_fun_def HMA_M_def from_hma<span class="hidden">⇩</span><sub>m</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mat2matofpoly</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mat2matofpoly</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">[:</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">:]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">charpoly</span> <span class="keyword2"><span class="keyword">where</span></span> charpoly_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">charpoly</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> det <span class="main">(</span>mat <span class="main">(</span>monom <span class="main">1</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> mat2matofpoly <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">erase_mat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> zero <span class="main">^</span> <span class="tfree">'nc</span> <span class="main">^</span> <span class="tfree">'nr</span> <span class="main">⇒</span> <span class="tfree">'nr</span> <span class="main">⇒</span> <span class="tfree">'nc</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'nc</span> <span class="main">^</span> <span class="tfree">'nr</span>"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">erase_mat</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i'</span><span class="main">.</span> <span class="keyword1">χ</span>  <span class="bound">j'</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∨</span> <span class="bound">j'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">$</span> <span class="bound">i'</span> <span class="main">$</span> <span class="bound">j'</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sum_UNIV_type</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'n</span> <span class="main">::</span> finite <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> comm_monoid_add<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'n</span> itself <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sum_UNIV_type</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> sum <span class="free"><span class="bound"><span class="entity">f</span></span></span> UNIV"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sum_UNIV_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> comm_monoid_add<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sum_UNIV_set</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> sum <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">{..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">HMA_T</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'n</span> <span class="main">::</span> finite itself <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">HMA_T</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> HMA_mat2matofpoly<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>HMA_M <span class="main">===&gt;</span> HMA_M<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> map_mat <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">[:</span><span class="bound">a</span><span class="main">:]</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> mat2matofpoly"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_fun_def HMA_M_def from_hma<span class="hidden">⇩</span><sub>m</sub>_def mat2matofpoly_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_char_poly <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>HMA_M <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span> comm_ring_1 mat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">^</span><span class="tfree">'n</span> <span class="main">⇒</span> bool<span class="main">)</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> char_poly charpoly"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">A'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">^</span><span class="tfree">'n</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"HMA_M <span class="skolem">A</span> <span class="skolem">A'</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">A</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HMA_M_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"monom <span class="main">1</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">[:</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">:]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monom_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_mat uminus <span class="main">(</span>map_mat <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">[:</span><span class="bound">a</span><span class="main">:]</span><span class="main">)</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> map_mat <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span><span class="bound">a</span><span class="main">:]</span><span class="main">)</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"char_poly <span class="skolem">A</span> <span class="main">=</span> charpoly <span class="skolem">A'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> char_poly_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> char_poly_matrix_def charpoly_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
 

<span class="keyword1"><span class="command">lemma</span></span> HMA_eigen_vector <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>HMA_M <span class="main">===&gt;</span> HMA_V <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> eigenvector eigen_vector"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Matrix.vec"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">A'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">v'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">k</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"HMA_M <span class="skolem">A</span> <span class="skolem">A'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"HMA_V <span class="skolem">v</span> <span class="skolem">v'</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">A</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="skolem">v</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HMA_V_def HMA_M_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> carrier_vec <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">unfolding</span></span> HMA_V_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eigenvector <span class="skolem">A</span> <span class="skolem">v</span> <span class="main">=</span> eigen_vector <span class="skolem">A'</span> <span class="skolem">v'</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> eigenvector_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> eigen_vector_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> HMA_eigen_value <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>HMA_M <span class="main">===&gt;</span> <span class="main">(=)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> eigenvalue eigen_value"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">A'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'n</span>  <span class="main">^</span> <span class="tfree">'n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"HMA_M <span class="skolem">A</span> <span class="skolem">A'</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">A</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> HMA_M_def<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> <span class="main">=</span> dim_row_transfer_rule<span class="main">[</span><span class="operator">OF</span> 1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>eigenvalue <span class="skolem">A</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>eigen_value <span class="skolem">A'</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> eigenvalue_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> eigen_value_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eigenvector_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> HMA_spectral_radius <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>HMA_M <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> Spectral_Radius.spectral_radius spectral_radius"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Spectral_Radius.spectral_radius_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> spectrum_def 
    spectral_radius_ev_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_elements_mat<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>HMA_M <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> mat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'nc</span> <span class="main">^</span> <span class="tfree">'nr</span> <span class="main">⇒</span> bool<span class="main">)</span><span class="main">)</span>  <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> 
  elements_mat elements_mat_h"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'nc</span> <span class="main">^</span> <span class="tfree">'nr</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'nr</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'nc</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"from_hma<span class="hidden">⇩</span><sub>m</sub> <span class="skolem">y</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">ya</span><span class="main">)</span><span class="main">.</span> <span class="skolem">y</span> <span class="keyword1">$h</span> <span class="bound">i</span> <span class="keyword1">$h</span> <span class="bound">ya</span><span class="main">)</span>"</span></span>      
      <span class="keyword1"><span class="command">using</span></span> to_nat_from_nat_id<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> to_nat_from_nat_id<span class="main">[</span><span class="operator">OF</span> j<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> from_hma<span class="hidden">⇩</span><sub>m</sub>_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'nc</span> <span class="main">^</span> <span class="tfree">'nr</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="skolem">y</span> <span class="keyword1">$h</span> <span class="skolem">a</span> <span class="keyword1">$h</span> <span class="skolem">b</span> <span class="main">=</span> from_hma<span class="hidden">⇩</span><sub>m</sub> <span class="skolem">y</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'nr</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'nc</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> from_hma<span class="hidden">⇩</span><sub>m</sub>_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Bij_Nat.to_nat <span class="skolem">a</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Bij_Nat.to_nat <span class="skolem">b</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span>
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_nat_less_card<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> elements_mat<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> elements_mat_h_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> HMA_M_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> HMA_vec_elements<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>HMA_V <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> Matrix.vec <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> bool<span class="main">)</span><span class="main">)</span>  <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> 
  vec_elements vec_elements_h"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">i</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"from_hma<span class="hidden">⇩</span><sub>v</sub> <span class="skolem">y</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">∈</span> range <span class="main">(</span>vec_nth <span class="skolem">y</span><span class="main">)</span>"</span></span>      
      <span class="keyword1"><span class="command">using</span></span> to_nat_from_nat_id<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> from_hma<span class="hidden">⇩</span><sub>v</sub>_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">y</span> <span class="keyword1">$h</span> <span class="skolem">a</span> <span class="main">=</span> from_hma<span class="hidden">⇩</span><sub>v</sub> <span class="skolem">y</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> from_hma<span class="hidden">⇩</span><sub>v</sub>_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Bij_Nat.to_nat <span class="skolem">a</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_nat_less_card<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vec_elements<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> vec_elements_h_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> rel_fun_def HMA_V_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>  
  
<span class="keyword1"><span class="command">lemma</span></span> norm_bound_elements_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"norm_bound <span class="free">A</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">∈</span> elements_mat <span class="free">A</span><span class="main">.</span> norm <span class="bound">x</span> <span class="main">≤</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> norm_bound_def elements_mat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_normbound <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>HMA_M <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> real_normed_field mat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'nc</span> <span class="main">^</span> <span class="tfree">'nr</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(=)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span>
  norm_bound normbound"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> normbound_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> norm_bound_elements_mat<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer_prover</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_map_matrix <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(=)</span> <span class="main">===&gt;</span> HMA_M <span class="main">===&gt;</span> HMA_M<span class="main">)</span> map_mat map_matrix"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_vector_def map_matrix_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> map_mat_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> HMA_M_def from_hma<span class="hidden">⇩</span><sub>m</sub>_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_transpose_matrix <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>HMA_M <span class="main">===&gt;</span> HMA_M<span class="main">)</span> transpose_mat transpose"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> transpose_mat_def transpose_def HMA_M_def from_hma<span class="hidden">⇩</span><sub>m</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_map_vector <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(=)</span> <span class="main">===&gt;</span> HMA_V <span class="main">===&gt;</span> HMA_V<span class="main">)</span> map_vec map_vector"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_vector_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> map_vec_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> HMA_V_def from_hma<span class="hidden">⇩</span><sub>v</sub>_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_similar_mat_wit <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>HMA_M <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> comm_ring_1 <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">===&gt;</span> HMA_M <span class="main">===&gt;</span> HMA_M <span class="main">===&gt;</span> HMA_M <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> 
  similar_mat_wit similar_matrix_wit"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> rel_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">a</span> <span class="skolem">A</span> <span class="skolem">b</span> <span class="skolem">B</span> <span class="skolem">c</span> <span class="skolem">C</span> <span class="skolem">d</span> <span class="skolem">D</span><span class="main">)</span>  
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> <span class="main">=</span> this
  <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">a</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HMA_M_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span> <span class="main">*</span> <span class="skolem">d</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="skolem">a</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">d</span> <span class="main">*</span> <span class="skolem">c</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="skolem">a</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="skolem">C</span> <span class="main">**</span> <span class="skolem">D</span> <span class="main">=</span> mat <span class="main">1</span> <span class="main">∧</span> <span class="skolem">D</span> <span class="main">**</span> <span class="skolem">C</span> <span class="main">=</span> mat <span class="main">1</span> <span class="main">∧</span> <span class="skolem">A</span> <span class="main">=</span> <span class="skolem">C</span> <span class="main">**</span> <span class="skolem">B</span> <span class="main">**</span> <span class="skolem">D</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> similar_mat_wit_def Let_def similar_matrix_wit_def *
    <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HMA_M_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_similar_mat <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>HMA_M <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> comm_ring_1 <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">===&gt;</span> HMA_M <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> 
  similar_mat similar_matrix"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> rel_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">a</span> <span class="skolem">A</span> <span class="skolem">b</span> <span class="skolem">B</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> <span class="main">=</span> this
  <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">a</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HMA_M_def<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="skolem">d</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"similar_mat_wit <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">d</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">d</span><span class="main">}</span> <span class="main">⊆</span> carrier_mat <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> similar_mat_wit_def id Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> similar_mat_def similar_matrix_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> *<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_spectrum<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>HMA_M <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> spectrum Spectrum"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> spectrum_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> Spectrum_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_M_erase_mat<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>HMA_M <span class="main">===&gt;</span> HMA_I <span class="main">===&gt;</span> HMA_I <span class="main">===&gt;</span> HMA_M<span class="main">)</span> mat_erase erase_mat"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> mat_erase_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> erase_mat_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HMA_M_def HMA_I_def from_hma<span class="hidden">⇩</span><sub>m</sub>_def to_nat_from_nat_id <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_matI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_M_sum_UNIV<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>HMA_I <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">===&gt;</span> HMA_T <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> sum_UNIV_set sum_UNIV_type"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_fun_def 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rename_tac</span> f fT n nT<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">fT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">n</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">nT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> itself"</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> HMA_I <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">fT</span> <span class="bound">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"HMA_T <span class="skolem">n</span> <span class="skolem">nT</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"from_nat <span class="main">::</span> nat <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"to_nat <span class="main">::</span> <span class="tfree">'b</span> <span class="main">⇒</span> nat"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> n<span class="main">[</span><span class="operator">unfolded</span> HMA_T_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> to_nat_from_nat_id<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span> <span class="main"><span class="main">=</span></span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span><span class="main">,</span> <span class="operator">folded</span> n<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> tf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="main">⟹</span> <span class="var">?t</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_UNIV_set <span class="skolem">f</span> <span class="skolem">n</span> <span class="main">=</span> sum <span class="skolem">f</span> <span class="main">(</span><span class="var">?t</span> <span class="main">`</span> <span class="var">?f</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> sum_UNIV_set_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"sum <span class="skolem">f</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> tf<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="main">(</span><span class="skolem">f</span> <span class="main">∘</span> <span class="var">?t</span><span class="main">)</span> <span class="main">(</span><span class="var">?f</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> tf n<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span> <span class="main">=</span> UNIV"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> range_to_nat<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span> <span class="main"><span class="main">=</span></span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span><span class="main">,</span> <span class="operator">folded</span> n<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="skolem">f</span> <span class="main">∘</span> <span class="var">?t</span><span class="main">)</span> UNIV <span class="main">=</span> sum <span class="skolem">fT</span> UNIV"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span> <span class="main">∘</span> <span class="var">?t</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">fT</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> o_def 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> f<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> HMA_I_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_UNIV_type <span class="skolem">fT</span> <span class="skolem">nT</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> sum_UNIV_type_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum_UNIV_set <span class="skolem">f</span> <span class="skolem">n</span> <span class="main">=</span> sum_UNIV_type <span class="skolem">fT</span> <span class="skolem">nT</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Setup a method to easily convert theorems from JNF into HMA.›</span></span>

<span class="keyword1"><span class="command">method</span></span> transfer_hma <span class="keyword2"><span class="keyword">uses</span></span> rule <span class="main">=</span> <span class="main">(</span>
  <span class="main">(</span><span class="operator">fold</span> index_hma_def<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="comment1">(* prepare matrix access for transfer *)</span>
  <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rule</span> <span class="dynamic"><span class="dynamic">rule</span></span><span class="main"><span class="keyword3">,</span></span> 
  <span class="main">(</span><span class="operator">unfold</span> carrier_vec_def carrier_mat_def<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> 
  <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now it becomes easy to transfer results which are not yet proven in HMA, such as:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> matrix_add_vect_distrib<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="free">v</span> <span class="main">=</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">v</span> <span class="main">+</span> <span class="free">B</span> <span class="keyword1">*v</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer_hma</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> add_mult_distrib_mat_vec<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> matrix_vector_right_distrib<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="keyword1">*v</span> <span class="main">(</span><span class="free">v</span> <span class="main">+</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">M</span> <span class="keyword1">*v</span> <span class="free">v</span> <span class="main">+</span> <span class="free">M</span> <span class="keyword1">*v</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer_hma</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mult_add_distrib_mat_vec<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> matrix_vector_right_distrib_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> ring_1 <span class="main">^</span> <span class="tfree">'nr</span> <span class="main">^</span> <span class="tfree">'nc</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="main">(</span><span class="free">v</span> <span class="main">-</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">M</span> <span class="keyword1">*v</span> <span class="free">v</span> <span class="main">-</span> <span class="free">M</span> <span class="keyword1">*v</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer_hma</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mult_minus_distrib_mat_vec<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eigen_value_root_charpoly<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"eigen_value <span class="free">A</span> <span class="free">k</span> <span class="main">⟷</span> poly <span class="main">(</span>charpoly <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> field <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span><span class="main">)</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer_hma</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eigenvalue_root_char_poly<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_spectrum<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> field <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Collect <span class="main">(</span>eigen_value <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer_hma</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> card_finite_spectrum<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> spectrum_def<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> non_empty_spectrum<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Collect <span class="main">(</span>eigen_value <span class="free">A</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer_hma</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> spectrum_non_empty<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> spectrum_def<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> charpoly_transpose<span class="main">:</span> <span class="quoted"><span class="quoted">"charpoly <span class="main">(</span>transpose <span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> field <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span><span class="main">)</span> <span class="main">=</span> charpoly <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer_hma</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> char_poly_transpose_mat<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eigen_value_transpose<span class="main">:</span> <span class="quoted"><span class="quoted">"eigen_value <span class="main">(</span>transpose <span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> field <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span><span class="main">)</span> <span class="free">v</span> <span class="main">=</span> eigen_value <span class="free">A</span> <span class="free">v</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> eigen_value_root_charpoly charpoly_transpose <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> matrix_diff_vect_distrib<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="free">v</span> <span class="main">=</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">v</span> <span class="main">-</span> <span class="free">B</span> <span class="keyword1">*v</span> <span class="main">(</span><span class="free">v</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> ring_1 <span class="main">^</span> <span class="tfree">'n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer_hma</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> minus_mult_distrib_mat_vec<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> similar_matrix_charpoly<span class="main">:</span> <span class="quoted"><span class="quoted">"similar_matrix <span class="free">A</span> <span class="free">B</span> <span class="main">⟹</span> charpoly <span class="free">A</span> <span class="main">=</span> charpoly <span class="free">B</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer_hma</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> char_poly_similar<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pderiv_char_poly_erase_mat<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> idom <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"monom <span class="main">1</span> <span class="main">1</span> <span class="main">*</span> pderiv <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> charpoly <span class="main">(</span>erase_mat <span class="free">A</span> <span class="bound">i</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> UNIV"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"from_hma<span class="hidden">⇩</span><sub>m</sub> <span class="free">A</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> tA<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"HMA_M <span class="var">?A</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> HMA_M_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> tN<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"HMA_T <span class="var">?n</span> <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> HMA_T_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">∈</span> carrier_mat <span class="var">?n</span> <span class="var">?n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> from_hma<span class="hidden">⇩</span><sub>m</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> charpoly <span class="main">(</span>erase_mat <span class="free">A</span> <span class="bound">i</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> UNIV <span class="main">=</span> 
    sum_UNIV_type <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> charpoly <span class="main">(</span>erase_mat <span class="free">A</span> <span class="bound">i</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sum_UNIV_type_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> pderiv_char_poly_mat_erase<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_UNIV_set_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> degree_monic_charpoly<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> comm_ring_1 <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">∧</span> monic <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">from</span></span> degree_monic_char_poly<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Perron_Frobenius_Aux">
<div class="head">
<h1>Theory Perron_Frobenius_Aux</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Thiemann *)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Perron-Frobenius Theorem›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary Notions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define notions like non-negative real-valued matrix, both
  in JNF and in HMA. These notions will be linked via HMA-connect.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Perron_Frobenius_Aux
<span class="keyword2"><span class="keyword">imports</span></span> <a href="HMA_Connect.html">HMA_Connect</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">real_nonneg_mat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex mat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">real_nonneg_mat</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> elements_mat <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="main">ℝ</span> <span class="main">∧</span> Re <span class="bound">a</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">real_nonneg_vec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex Matrix.vec <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">real_nonneg_vec</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> vec_elements <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="main">ℝ</span> <span class="main">∧</span> Re <span class="bound">a</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">real_non_neg_vec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">real_non_neg_vec</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> vec_elements_h <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="main">ℝ</span> <span class="main">∧</span> Re <span class="bound">a</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">real_non_neg_mat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex <span class="main">^</span> <span class="tfree">'nr</span> <span class="main">^</span> <span class="tfree">'nc</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">real_non_neg_mat</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> elements_mat_h <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="main">ℝ</span> <span class="main">∧</span> Re <span class="bound">a</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> real_non_neg_matD<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"real_non_neg_mat <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">$h</span> <span class="free">i</span> <span class="keyword1">$h</span> <span class="free">j</span> <span class="main">∈</span> <span class="main">ℝ</span>"</span></span> <span class="quoted"><span class="quoted">"Re <span class="main">(</span><span class="free">A</span> <span class="keyword1">$h</span> <span class="free">i</span> <span class="keyword1">$h</span> <span class="free">j</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> real_non_neg_mat_def elements_mat_h_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nonneg_mat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linordered_idom mat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nonneg_mat</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> elements_mat <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="bound">a</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">non_neg_mat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linordered_idom <span class="main">^</span> <span class="tfree">'nr</span> <span class="main">^</span> <span class="tfree">'nc</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">non_neg_mat</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">a</span> <span class="main">∈</span> elements_mat_h <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="bound">a</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span>"</span></span> 


<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_real_non_neg_mat <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>HMA_M <span class="main">::</span> complex mat <span class="main">⇒</span> complex <span class="main">^</span> <span class="tfree">'nc</span> <span class="main">^</span> <span class="tfree">'nr</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> 
  real_nonneg_mat real_non_neg_mat"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> real_nonneg_mat_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> real_non_neg_mat_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_real_non_neg_vec <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>HMA_V <span class="main">::</span> complex Matrix.vec <span class="main">⇒</span> complex <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> 
  real_nonneg_vec real_non_neg_vec"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> real_nonneg_vec_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> real_non_neg_vec_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_non_neg_mat <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>HMA_M <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> linordered_idom mat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'nc</span> <span class="main">^</span> <span class="tfree">'nr</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> 
  nonneg_mat non_neg_mat"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nonneg_mat_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> non_neg_mat_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">matpow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>semiring_1<span class="main">^</span><span class="tfree">'n</span><span class="main">^</span><span class="tfree">'n</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">^</span><span class="tfree">'n</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  matpow_0<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="free">matpow</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">0</span> <span class="main">=</span> mat <span class="main">1</span>"</span></span> <span class="main">|</span>
  matpow_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">matpow</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">matpow</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">**</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax
<span class="keyword2"><span class="keyword">begin</span></span>  
<span class="keyword1"><span class="command">lemma</span></span> HMA_pow_mat<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>HMA_M <span class="main">::</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>semiring_1<span class="main">}</span> mat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">^</span><span class="tfree">'n</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(=)</span> <span class="main">===&gt;</span> HMA_M<span class="main">)</span> pow_mat matpow"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">A'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">^</span><span class="tfree">'n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"HMA_M <span class="skolem">A</span> <span class="skolem">A'</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">A</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> HMA_M_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"HMA_M <span class="main">(</span>pow_mat <span class="skolem">A</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>matpow <span class="skolem">A'</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> <span class="main">=</span> this
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer_prover</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer_prover</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trancl_image<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="free">i</span><span class="main">,</span> <span class="free">f</span> <span class="free">j</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">f</span> <span class="main">`</span> <span class="free">R</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trancl_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">j</span> <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> step<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">j</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∈</span> map_prod <span class="free">f</span> <span class="free">f</span> <span class="main">`</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> step<span class="main">(</span>3<span class="main">)</span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> inj_trancl_image<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="free">i</span><span class="main">,</span> <span class="free">f</span> <span class="free">j</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">f</span> <span class="main">`</span> <span class="free">R</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="keyword1"><span class="command">from</span></span> trancl_image<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="keyword1"><span class="command">from</span></span> trancl_image<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"the_inv <span class="free">f</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> image_image prod.map_comp o_def the_inv_f_f<span class="main">[</span><span class="operator">OF</span> inj<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> matrix_add_rdistrib<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">B</span> <span class="main">+</span> <span class="free">C</span><span class="main">)</span> <span class="main">**</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span> <span class="main">**</span> <span class="free">A</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">C</span> <span class="main">**</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">vector</span> matrix_matrix_mult_def sum.distrib<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> norm_smult<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">::</span> real<span class="main">)</span> <span class="keyword1">*s</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> abs <span class="free">a</span> <span class="main">*</span> norm <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> norm_vec_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> norm_scaleR norm_vec_def scalar_mult_eq_scaleR<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nonneg_mat_mult<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"nonneg_mat <span class="free">A</span> <span class="main">⟹</span> nonneg_mat <span class="free">B</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">n</span>
  <span class="main">⟹</span> <span class="free">B</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">nc</span> <span class="main">⟹</span> nonneg_mat <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> nonneg_mat_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> elements_mat_def scalar_prod_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_nonneg<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nonneg_mat_power<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"nonneg_mat <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nonneg_mat <span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonneg_mat_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> nonneg_mat_mult<span class="main">[</span><span class="operator">OF</span> this assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> _ assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nonneg_matD<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nonneg_mat <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> dim_row <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> dim_col <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> nonneg_mat_def elements_mat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> comm_ring_hom<span class="main">)</span> similar_mat_wit_hom<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>
  <span class="quoted"><span class="quoted">"similar_mat_wit <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">D</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"similar_mat_wit <span class="main">(</span><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">C</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">D</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> dim_row <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> similar_mat_witD<span class="main">[</span><span class="operator">OF</span> n assms<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="free">C</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> C <span class="main">=</span> *<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> D <span class="main">=</span> *<span class="main">(</span>7<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> id <span class="main">=</span> mat_hom_mult<span class="main">[</span><span class="operator">OF</span> C D<span class="main">]</span> mat_hom_mult<span class="main">[</span><span class="operator">OF</span> D C<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> ** <span class="main">=</span> *<span class="main">(</span>1-3<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> arg_cong<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator"><span class="operator"><span class="operator">of</span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span></span></span>"</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main">,</span> <span class="operator">unfolded</span> id<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> mult <span class="main">=</span> mult_carrier_mat<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> hom_mult <span class="main">=</span> mat_hom_mult<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> similar_mat_wit_def Let_def <span class="keyword1"><span class="command">unfolding</span></span> **<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> **<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> hom_mult <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> *<span class="main"><span class="main">(</span></span>4-<span class="main"><span class="main">)</span></span> mult<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> comm_ring_hom<span class="main">)</span> similar_mat_hom<span class="main">:</span>
  <span class="quoted"><span class="quoted">"similar_mat <span class="free">A</span> <span class="free">B</span> <span class="main">⟹</span> similar_mat <span class="main">(</span><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> similar_mat_wit_hom<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="skolem">C</span></span> <span class="quoted"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">C</span> <span class="skolem">D</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> similar_mat_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> det_dim_1<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Determinant.det <span class="free">A</span> <span class="main">=</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> laplace_expansion_column<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> n<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A n<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cofactor_def mat_delete_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> det_dim_2<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Determinant.det <span class="free">A</span> <span class="main">=</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="main">*</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">0</span> <span class="main">+</span> <span class="skolem">f</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">f</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> laplace_expansion_column<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> n<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A n<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cofactor_def mat_delete_def set<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> det_dim_1<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> jordan_nf_root_char_poly<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>semiring_no_zero_divisors<span class="main">,</span> idom<span class="main">}</span> mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"jordan_nf <span class="free">A</span> <span class="free">n_as</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="free">lam</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">n_as</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="free">lam</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> m0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> jordan_nf_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> split_list<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> nas<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n_as</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="free">lam</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> m0
    <span class="keyword1"><span class="command">unfolding</span></span> jordan_nf_char_poly<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> nas poly_prod_list prod_list_zero_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inverse_power_tendsto_zero<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> inverse <span class="main">(</span><span class="main">(</span>of_nat <span class="bound">x</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> real_normed_div_algebra<span class="main">)</span> <span class="main">^</span> Suc <span class="free">d</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> filterlim_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tendsto_inverse_0<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> 
  <span class="operator">intro</span> filterlim_at_infinity<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span>ceiling <span class="skolem">r</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> eventually_sequentiallyI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> norm_power norm_of_nat<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> x1<span class="main">:</span> <span class="quoted"><span class="quoted">"real <span class="skolem">x</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≤</span> real <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> real <span class="skolem">x</span> <span class="main">^</span> Suc <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≤</span> real <span class="skolem">x</span> <span class="main">^</span> Suc <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> 
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> inverse_of_nat_tendsto_zero<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> inverse <span class="main">(</span>of_nat <span class="bound">x</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> real_normed_div_algebra<span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inverse_power_tendsto_zero<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> poly_times_exp_tendsto_zero<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">b</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> real_normed_field<span class="main">)</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> of_nat <span class="bound">x</span> <span class="main">^</span> <span class="free">k</span> <span class="main">*</span> <span class="free">b</span> <span class="main">^</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">nla</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nla</span> <span class="main">=</span> norm <span class="free">b</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> sqrt <span class="skolem">nla</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> b False <span class="keyword1"><span class="command">have</span></span> nla<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">nla</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nla</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> nla_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">^</span><span class="skolem">x</span> <span class="main">*</span> <span class="skolem">s</span><span class="main">^</span><span class="skolem">x</span> <span class="main">=</span> sqrt <span class="main">(</span><span class="skolem">nla</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> s_def power_add<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 
      <span class="keyword1"><span class="command">unfolding</span></span> real_sqrt_power<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> sqrt <span class="main">(</span><span class="skolem">nla</span> <span class="main">^</span> <span class="bound">x</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">nla</span><span class="main">^</span><span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> power_mult real_sqrt_power
      <span class="keyword1"><span class="command">using</span></span> nla <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nla</span><span class="main">^</span><span class="skolem">x</span> <span class="main">=</span> <span class="skolem">s</span><span class="main">^</span><span class="skolem">x</span> <span class="main">*</span> <span class="skolem">s</span><span class="main">^</span><span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> nla_s <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> of_nat <span class="bound">x</span> <span class="main">^</span> <span class="free">k</span> <span class="main">*</span> <span class="free">b</span> <span class="main">^</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>        
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> tendsto_norm_zero_cancel<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> norm_mult norm_power norm_of_nat nla_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> nla_s
       mult.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>  
    <span class="keyword1"><span class="command">from</span></span> poly_exp_constant_bound<span class="main">[</span><span class="operator">OF</span> s<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      p<span class="main">:</span> <span class="quoted"><span class="quoted">"real <span class="skolem">x</span> <span class="main">^</span> <span class="free">k</span> <span class="main">*</span> <span class="skolem">s</span><span class="main">^</span><span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>              
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>real <span class="skolem">x</span> <span class="main">^</span> <span class="free">k</span> <span class="main">*</span> <span class="skolem">s</span> <span class="main">^</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> real <span class="skolem">x</span> <span class="main">^</span> <span class="free">k</span> <span class="main">*</span> <span class="skolem">s</span><span class="main">^</span><span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> p <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>real <span class="skolem">x</span> <span class="main">^</span> <span class="free">k</span> <span class="main">*</span> <span class="skolem">s</span> <span class="main">^</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> s <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> real <span class="bound">x</span> <span class="main">^</span> <span class="free">k</span> <span class="main">*</span> <span class="skolem">s</span> <span class="main">^</span> <span class="bound">x</span> <span class="main">*</span> <span class="skolem">s</span> <span class="main">^</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lim_null_mult_left_bounded<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ LIMSEQ_power_zero<span class="main"><span class="main">[</span></span><span class="operator">OF</span> s<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> p<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> True
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> tendsto_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">0</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eventually_sequentiallyI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> linorder_topology<span class="main">)</span> tendsto_Min<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span> <span class="main">⤏</span> <span class="free">a</span> <span class="bound">i</span><span class="main">)</span> <span class="free">F</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Min <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> 
    <span class="main">(</span>Min <span class="main">(</span><span class="free">a</span> <span class="main">`</span> <span class="free">I</span><span class="main">)</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span><span class="main">)</span> <span class="free">F</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> fin I
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">i</span> <span class="skolem">I</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">i</span> <span class="main">⤏</span> <span class="free">a</span> <span class="skolem">i</span><span class="main">)</span> <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span><span class="free">a</span> <span class="main">`</span> insert <span class="skolem">i</span> <span class="skolem">I</span><span class="main">)</span> <span class="main">=</span> min <span class="main">(</span><span class="free">a</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>Min <span class="main">(</span><span class="free">a</span> <span class="main">`</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False insert<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Min <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> insert <span class="skolem">i</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> min <span class="main">(</span><span class="free">f</span> <span class="skolem">i</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>Min <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> False insert<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Min <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="main">⤏</span> Min <span class="main">(</span><span class="free">a</span> <span class="main">`</span> <span class="skolem">I</span><span class="main">)</span><span class="main">)</span> <span class="free">F</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> insert<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> False<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> * **
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> tendsto_min i IH<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> tendsto_mat_mult <span class="main">[</span><span class="operator">tendsto_intros</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⤏</span> <span class="free">a</span><span class="main">)</span> <span class="free">F</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">g</span> <span class="main">⤏</span> <span class="free">b</span><span class="main">)</span> <span class="free">F</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">**</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⤏</span> <span class="free">a</span> <span class="main">**</span> <span class="free">b</span><span class="main">)</span> <span class="free">F</span>"</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> <span class="main">{</span>semiring_1<span class="main">,</span> real_normed_algebra<span class="main">}</span> <span class="main">^</span> <span class="tfree">'n1</span> <span class="main">^</span> <span class="tfree">'n2</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_matrix_mult_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">tendsto_intros</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tendsto_matpower <span class="main">[</span><span class="operator">tendsto_intros</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⤏</span> <span class="free">a</span><span class="main">)</span> <span class="free">F</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> matpow <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span> <span class="main">⤏</span> matpow <span class="free">a</span> <span class="free">n</span><span class="main">)</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">::</span> <span class="main">{</span>semiring_1<span class="main">,</span> real_normed_algebra<span class="main">}</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tendsto_mat_mult<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> continuous_matpow<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">R</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">A</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>semiring_1<span class="main">,</span> real_normed_algebra_1<span class="main">}</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span><span class="main">.</span> matpow <span class="bound">A</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> continuous_on_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">tendsto_intros</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vector_smult_distrib<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> comm_ring_1<span class="main">)</span> <span class="keyword1">*s</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">*s</span> <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_vector_mult_def vector_scalar_mult_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> sum_distrib_left<span class="main">)</span>  

<span class="keyword1"><span class="command">instance</span></span> real <span class="main">::</span> <span class="quoted">ordered_semiring_strict</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_classes</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> poly_tendsto_pinfty<span class="main">:</span>  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lead_coeff <span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"poly <span class="free">p</span> <span class="main">⇢</span> <span class="main">∞</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> Lim_PInfty
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">N</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">N</span><span class="main">.</span> ereal <span class="skolem">b</span> <span class="main">≤</span> ereal <span class="main">(</span>poly <span class="free">p</span> <span class="main">(</span>real <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> ereal_less_eq <span class="keyword1"><span class="command">using</span></span> poly_pinfty_ge<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> of_nat_le_iff order_trans real_arch_simple<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> div_lt_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">j</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="main">*</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">j</span> <span class="keyword1">div</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_mult_imp_div_less mult.commute<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">diagvector</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> semiring_0<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">diagvector</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> diagvector_mult_vector<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"diagvector <span class="free">x</span> <span class="keyword1">*v</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">x</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">y</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> diagvector_def matrix_vector_mult_def vec_eq_iff vec_lambda_beta
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.remove<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diagvector_mult_left<span class="main">:</span> <span class="quoted"><span class="quoted">"diagvector <span class="free">x</span> <span class="main">**</span> <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free">x</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="var">?B</span>"</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">unfolding</span></span> vec_eq_iff
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="keyword1">$h</span> <span class="skolem">i</span> <span class="keyword1">$h</span> <span class="skolem">j</span> <span class="main">=</span> <span class="var">?B</span> <span class="keyword1">$h</span> <span class="skolem">i</span> <span class="keyword1">$h</span> <span class="skolem">j</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> map_vector_def diagvector_def matrix_matrix_mult_def vec_lambda_beta
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.remove<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diagvector_mult_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">**</span> diagvector <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">*</span> <span class="free">x</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="var">?B</span>"</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">unfolding</span></span> vec_eq_iff
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="keyword1">$h</span> <span class="skolem">i</span> <span class="keyword1">$h</span> <span class="skolem">j</span> <span class="main">=</span> <span class="var">?B</span> <span class="keyword1">$h</span> <span class="skolem">i</span> <span class="keyword1">$h</span> <span class="skolem">j</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> map_vector_def diagvector_def matrix_matrix_mult_def vec_lambda_beta
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.remove<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diagvector_mult<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"diagvector <span class="free">x</span> <span class="main">**</span> diagvector <span class="free">y</span> <span class="main">=</span> diagvector <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">x</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">y</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> diagvector_mult_left <span class="keyword1"><span class="command">unfolding</span></span> diagvector_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diagvector_const<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"diagvector <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> mat <span class="free">k</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> diagvector_def mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> diagvector_eq_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"diagvector <span class="free">x</span> <span class="main">=</span> mat <span class="free">a</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">a</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> diagvector_def mat_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cmod_eq_Re<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cmod <span class="free">x</span> <span class="main">=</span> Re <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"of_real <span class="main">(</span>Re <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Im <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>cmod <span class="free">x</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span> <span class="main">≠</span> <span class="main">(</span>Re <span class="free">x</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> norm_complex_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_complex_def complex_of_real_def<span class="main">)</span>

<span class="keyword1"><span class="command">hide_fact</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Matrix.vec_eq_iff

<span class="keyword1"><span class="command">no_notation</span></span>
  vec_index <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">$</span>"</span> 100<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> spectral_radius_ev<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">ev</span> <span class="bound">v</span><span class="main">.</span> eigen_vector <span class="free">A</span> <span class="bound">v</span> <span class="bound">ev</span> <span class="main">∧</span> norm <span class="bound">ev</span> <span class="main">=</span> spectral_radius <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> non_empty_spectrum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> finite_spectrum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"spectral_radius <span class="free">A</span> <span class="main">∈</span> norm <span class="main">`</span> <span class="main">(</span>Collect <span class="main">(</span>eigen_value <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> spectral_radius_ev_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> eigen_value_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> spectral_radius_max<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eigen_value <span class="free">A</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"norm <span class="free">v</span> <span class="main">≤</span> spectral_radius <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="free">v</span> <span class="main">∈</span> norm <span class="main">`</span> <span class="main">(</span>Collect <span class="main">(</span>eigen_value <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Max_ge<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">,</span> <span class="operator">folded</span> spectral_radius_ev_def<span class="main">]</span>
    finite_spectrum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For Perron-Frobenius it is useful to use the linear norm, and
  not the Euclidean norm.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">norm1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> real_normed_field <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">norm1</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> norm <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> norm1_ge_0<span class="main">:</span> <span class="quoted"><span class="quoted">"norm1 <span class="free">v</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> norm1_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_nonneg<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> norm1_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"norm1 <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> norm1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> norm1_nonzero<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"norm1 <span class="free">v</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">v</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> vi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> vec_eq_iff
    <span class="keyword1"><span class="command">using</span></span> Finite_Cartesian_Product.vec_eq_iff zero_index <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="skolem">i</span><span class="main">}</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_nonneg<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="free">v</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> vi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">+</span> sum <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> norm <span class="main">(</span><span class="free">v</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="skolem">i</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> norm1 <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> norm1_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.remove<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm1 <span class="free">v</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> norm1_0_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>norm1 <span class="free">v</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">v</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> norm1_0 norm1_nonzero <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> norm1_scaleR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"norm1 <span class="main">(</span><span class="free">r</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> abs <span class="free">r</span> <span class="main">*</span> norm1 <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> norm1_def sum_distrib_left
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> abs_norm1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span>norm1 <span class="free">v</span><span class="main">)</span> <span class="main">=</span> norm1 <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> norm1_ge_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>

<span class="keyword1"><span class="command">lemma</span></span> normalize_eigen_vector<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eigen_vector <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> real_normed_field <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span><span class="main">)</span> <span class="free">v</span> <span class="free">ev</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eigen_vector <span class="free">A</span> <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm1 <span class="free">v</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">v</span><span class="main">)</span> <span class="free">ev</span>"</span></span> <span class="quoted"><span class="quoted">"norm1 <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm1 <span class="free">v</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm1 <span class="free">v</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> eigen_vector_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> <span class="free">v</span> <span class="main">=</span> <span class="free">ev</span> <span class="keyword1">*s</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> nz <span class="keyword1"><span class="command">have</span></span> norm1<span class="main">:</span> <span class="quoted"><span class="quoted">"norm1 <span class="free">v</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"norm1 <span class="var">?v</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> norm1 nz <span class="keyword1"><span class="command">have</span></span> nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> <span class="var">?v</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm1 <span class="free">v</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_eq_iff matrix_vector_mult_def real_vector.scale_sum_right<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> <span class="free">v</span> <span class="main">=</span> <span class="free">ev</span> <span class="keyword1">*s</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm1 <span class="free">v</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">ev</span> <span class="keyword1">*s</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">ev</span> <span class="keyword1">*s</span> <span class="var">?v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eigen_vector <span class="free">A</span> <span class="var">?v</span> <span class="free">ev</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nz <span class="keyword1"><span class="command">unfolding</span></span> eigen_vector_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> norm1_cont<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"isCont norm1 <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> norm1_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> norm1_ge_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"norm1 <span class="free">v</span> <span class="main">≥</span> norm <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> norm1_def norm_vec_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> L2_set_le_sum<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following continuity lemmas have been proven with hints from Fabian Immler.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tendsto_matrix_vector_mult<span class="main">[</span><span class="operator">tendsto_intros</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">(*v)</span> <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> real_normed_algebra_1 <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'k</span><span class="main">)</span> <span class="main">⤏</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">v</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_vector_mult_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">tendsto_intros</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tendsto_matrix_matrix_mult<span class="main">[</span><span class="operator">tendsto_intros</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(**)</span> <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> real_normed_algebra_1 <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'k</span><span class="main">)</span> <span class="main">⤏</span> <span class="free">A</span> <span class="main">**</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">B</span> <span class="keyword1">within</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> matrix_matrix_mult_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">tendsto_intros</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> matrix_vect_scaleR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> real_normed_algebra_1 <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'k</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vec_eq_iff
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matrix_vector_mult_def scaleR_vec_def scaleR_sum_right
  <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> inj_semiring_hom<span class="main">)</span> map_vector_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map_vector <span class="free">hom</span> <span class="free">v</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">v</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vec_eq_iff map_vector_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> inj_semiring_hom<span class="main">)</span> map_vector_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map_vector <span class="free">hom</span> <span class="free">v</span> <span class="main">=</span> map_vector <span class="free">hom</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">v</span> <span class="main">=</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vec_eq_iff map_vector_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> semiring_hom<span class="main">)</span> matrix_vector_mult_hom<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>map_matrix <span class="free">hom</span> <span class="free">A</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="main">(</span>map_vector <span class="free">hom</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> map_vector <span class="free">hom</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">hom</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult_mat_vec_hom<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> semiring_hom<span class="main">)</span> vector_smult_hom<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">hom</span> <span class="free">x</span> <span class="keyword1">*s</span> <span class="main">(</span>map_vector <span class="free">hom</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> map_vector <span class="free">hom</span> <span class="main">(</span><span class="free">x</span> <span class="keyword1">*s</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">hom</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_hom_smult<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> inj_comm_ring_hom<span class="main">)</span> eigen_vector_hom<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"eigen_vector <span class="main">(</span>map_matrix <span class="free">hom</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>map_vector <span class="free">hom</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">hom</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> eigen_vector <span class="free">A</span> <span class="free">v</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> eigen_vector_def matrix_vector_mult_hom vector_smult_hom map_vector_0 map_vector_inj 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Perron_Frobenius">
<div class="head">
<h1>Theory Perron_Frobenius</h1>
</div>
<pre class="source"><span class="comment1">(* Author: R. Thiemann *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Perron-Frobenius theorem via Brouwer's fixpoint theorem.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Perron_Frobenius
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Analysis/Brouwer_Fixpoint.html">HOL-Analysis.Brouwer_Fixpoint</a>"</span>
  <a href="Perron_Frobenius_Aux.html">Perron_Frobenius_Aux</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We follow the textbook proof of Serre \cite[Theorem 5.2.1]{SerreMatrices}.›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">::</span> finite"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rnnA<span class="main">:</span> <span class="quoted"><span class="quoted">"real_non_neg_mat <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">abbreviation</span></span><span class="main">(</span>input<span class="main">)</span> <span class="entity">sr</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">sr</span> <span class="main">≡</span> spectral_radius <span class="free">A</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_v_ev</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>complex<span class="main">^</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">×</span> complex"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_v_ev</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">v_ev</span><span class="main">.</span> eigen_vector <span class="free">A</span> <span class="main">(</span>fst <span class="bound">v_ev</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">v_ev</span><span class="main">)</span>
  <span class="main">∧</span> norm <span class="main">(</span>snd <span class="bound">v_ev</span><span class="main">)</span> <span class="main">=</span> sr<span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">max_v</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm1 <span class="main">(</span>fst max_v_ev<span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> fst max_v_ev"</span></span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">max_ev</span> <span class="main">=</span> snd max_v_ev"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> max_v_ev<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eigen_vector <span class="free">A</span> max_v max_ev"</span></span>
  <span class="quoted"><span class="quoted">"norm max_ev <span class="main">=</span> sr"</span></span>
  <span class="quoted"><span class="quoted">"norm1 max_v <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">ev</span></span> <span class="keyword2"><span class="keyword">where</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"max_v_ev <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">ev</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> spectral_radius_ev<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> someI_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">v_ev</span><span class="main">.</span> eigen_vector <span class="free">A</span> <span class="main">(</span>fst <span class="bound">v_ev</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">v_ev</span><span class="main">)</span>
  <span class="main">∧</span> norm <span class="main">(</span>snd <span class="bound">v_ev</span><span class="main">)</span> <span class="main">=</span> sr"</span></span><span class="main">,</span> <span class="operator">folded</span> max_v_ev_def<span class="main">,</span> <span class="operator">unfolded</span> id<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"eigen_vector <span class="free">A</span> <span class="skolem">v</span> <span class="skolem">ev</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="skolem">ev</span> <span class="main">=</span> sr"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> normalize_eigen_vector<span class="main">[</span><span class="operator">OF</span> v<span class="main">]</span> ev
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eigen_vector <span class="free">A</span> max_v max_ev"</span></span> <span class="quoted"><span class="quoted">"norm max_ev <span class="main">=</span> sr"</span></span> <span class="quoted"><span class="quoted">"norm1 max_v <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> max_v_def max_ev_def id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the definition of S, we use the linear norm instead of the
  default euclidean norm which is defined via the type-class.
  The reason is that S is not convex if one uses the euclidean norm.›</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≡</span> <span class="keyword1">χ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> Re <span class="main">(</span><span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">S</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound">v</span> <span class="main">::</span> real <span class="main">^</span> <span class="tfree">'n</span> <span class="main">.</span> norm1 <span class="bound">v</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">v</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">≥</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span>B <span class="keyword1">*v</span> <span class="bound">v</span><span class="main">)</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">≥</span> sr <span class="main">*</span> <span class="main">(</span><span class="bound">v</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> real <span class="main">^</span> <span class="tfree">'n</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm1 <span class="main">(</span>B <span class="keyword1">*v</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span>B <span class="keyword1">*v</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> closedS<span class="main">:</span> <span class="quoted"><span class="quoted">"closed S"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> S_def matrix_vector_mult_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> closed_Collect_conj closed_Collect_all closed_Collect_le closed_Collect_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"continuous_on UNIV norm1"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> continuous_at_imp_continuous_on<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span> continuous_on_component<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> boundedS<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded S"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">^</span> <span class="tfree">'n</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> norm1_ge_norm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm1 <span class="skolem">v</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> norm <span class="skolem">v</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> S_def bounded_iff
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> compactS<span class="main">:</span> <span class="quoted"><span class="quoted">"compact S"</span></span>
  <span class="keyword1"><span class="command">using</span></span> boundedS closedS
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> compact_eq_bounded_closed<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemmas</span></span> rnn <span class="main">=</span> real_non_neg_matD<span class="main">[</span><span class="operator">OF</span> rnnA<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> B_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"B <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span> <span class="main">=</span> norm <span class="main">(</span><span class="free">A</span> <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rnn<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">j</span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> B_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_B_mono<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="free">v</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">≥</span> <span class="free">w</span> <span class="main">$</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>B <span class="keyword1">*v</span> <span class="free">v</span><span class="main">)</span> <span class="main">$</span> <span class="free">i</span> <span class="main">≥</span> <span class="main">(</span>B <span class="keyword1">*v</span> <span class="free">w</span><span class="main">)</span> <span class="main">$</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> matrix_vector_mult_def vec_lambda_beta
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> mult_left_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> B_norm<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> non_emptyS<span class="main">:</span> <span class="quoted"><span class="quoted">"S <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> norm <span class="main">(</span>max_v <span class="main">$</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">::</span> real <span class="main">^</span> <span class="tfree">'n</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm1 max_v <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> max_v_ev<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> nv<span class="main">:</span> <span class="quoted"><span class="quoted">"norm1 <span class="var">?v</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> norm1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sr <span class="main">*</span> <span class="main">(</span><span class="var">?v</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> sr <span class="main">*</span> norm <span class="main">(</span>max_v <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>norm max_ev<span class="main">)</span> <span class="main">*</span> norm <span class="main">(</span>max_v <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> max_v_ev <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> norm <span class="main">(</span><span class="main">(</span>max_ev <span class="keyword1">*s</span> max_v<span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_mult<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"max_ev <span class="keyword1">*s</span> max_v <span class="main">=</span> <span class="free">A</span> <span class="keyword1">*v</span> max_v"</span></span> <span class="keyword1"><span class="command">using</span></span> max_v_ev<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> eigen_vector_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> max_v<span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>B <span class="keyword1">*v</span> <span class="var">?v</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> matrix_vector_mult_def vec_lambda_beta
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_norm_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_mult B_norm<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sr <span class="main">*</span> <span class="main">(</span><span class="var">?v</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>B <span class="keyword1">*v</span> <span class="var">?v</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> le <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">∈</span> S"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">using</span></span> nv le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> convexS<span class="main">:</span> <span class="quoted"><span class="quoted">"convex S"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> convexI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">w</span> <span class="skolem">a</span> <span class="skolem">b</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> S"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> S"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> real<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lin</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">v</span> <span class="main">+</span> <span class="skolem">b</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">w</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"norm1 <span class="skolem">v</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"norm1 <span class="skolem">w</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm1 <span class="var">?lin</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> norm1 <span class="skolem">v</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> norm1 <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> norm1_def sum_distrib_left sum.distrib<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'n</span></span></span>
    <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="var">?lin</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> norm <span class="main">(</span><span class="skolem">v</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> norm <span class="main">(</span><span class="skolem">w</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>3-4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>5<span class="main">)</span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> norm1<span class="main">:</span> <span class="quoted"><span class="quoted">"norm1 <span class="var">?lin</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">v</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"sr <span class="main">*</span> <span class="skolem">v</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="main">(</span>B <span class="keyword1">*v</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span>sr <span class="main">*</span> <span class="skolem">v</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span>B <span class="keyword1">*v</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">w</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"sr <span class="main">*</span> <span class="skolem">w</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="main">(</span>B <span class="keyword1">*v</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">*</span> <span class="main">(</span>sr <span class="main">*</span> <span class="skolem">w</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">b</span> <span class="main">*</span> <span class="main">(</span>B <span class="keyword1">*v</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span>sr <span class="main">*</span> <span class="skolem">v</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="main">(</span>sr <span class="main">*</span> <span class="skolem">w</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span>B <span class="keyword1">*v</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="main">(</span>B <span class="keyword1">*v</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> le <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> switch<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> <span class="skolem">a</span> <span class="main">*</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">*</span> <span class="bound">y</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">*</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">*</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">w</span><span class="main">}</span> <span class="main">⟹</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">*</span> <span class="skolem">x</span> <span class="keyword1">$h</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="skolem">x</span> <span class="keyword1">$h</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">r</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">v</span> <span class="main">+</span> <span class="skolem">b</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">w</span> <span class="main">∈</span> S"</span></span> <span class="keyword1"><span class="command">using</span></span> * norm1 le <span class="keyword1"><span class="command">unfolding</span></span> S_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matrix_vect_scaleR matrix_vector_right_distrib ring_distribs<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">r</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> complex"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≡</span> of_real"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">^</span><span class="tfree">'n</span> <span class="main">⇒</span> complex <span class="main">^</span><span class="tfree">'n</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rv</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> r <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> rv_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rv <span class="free">v</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">v</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_real_hom.map_vector_0 map_vector_def vec_eq_iff<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> rv_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> rv <span class="free">v</span> <span class="main">=</span> rv <span class="main">(</span>B <span class="keyword1">*v</span> <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_matrix r B <span class="main">=</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rnnA <span class="keyword1"><span class="command">unfolding</span></span> map_matrix_def B_def real_non_neg_mat_def map_vector_def elements_mat_h_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">vector</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> of_real_hom.matrix_vector_mult_hom<span class="main">[</span><span class="operator">of</span> <span class="quoted">B</span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span> <span class="main"><span class="main">=</span></span> <span class="quoted">complex</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_vector_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> zero_no_ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> S <span class="main">⟹</span> <span class="free">A</span> <span class="keyword1">*v</span> rv <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> normB_S<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> S"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"norm1 <span class="main">(</span>B <span class="keyword1">*v</span> <span class="free">v</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> zero_no_ev<span class="main">[</span><span class="operator">OF</span> v<span class="main">,</span> <span class="operator">unfolded</span> rv_mult rv_0<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> image_f<span class="main">:</span> <span class="quoted"><span class="quoted">"f <span class="main">`</span> S <span class="main">⊆</span> S"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> S"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> norm<span class="main">:</span> <span class="quoted"><span class="quoted">"norm1 <span class="skolem">v</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> sr <span class="main">*</span> <span class="skolem">v</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">≤</span> <span class="main">(</span>B <span class="keyword1">*v</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">$</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> normB_S<span class="main">[</span><span class="operator">OF</span> v<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> normB<span class="main">:</span> <span class="quoted"><span class="quoted">"norm1 <span class="main">(</span>B <span class="keyword1">*v</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> norm1_nonzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> fv<span class="main">:</span> <span class="quoted"><span class="quoted">"f <span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm1 <span class="main">(</span>B <span class="keyword1">*v</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span>B <span class="keyword1">*v</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> normB <span class="keyword1"><span class="command">have</span></span> Bv0<span class="main">:</span> <span class="quoted"><span class="quoted">"B <span class="keyword1">*v</span> <span class="skolem">v</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> norm1_0_iff<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">have</span></span> norm<span class="main">:</span> <span class="quoted"><span class="quoted">"norm1 <span class="main">(</span>f <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fv <span class="keyword1"><span class="command">using</span></span> normB Bv0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> norm1 <span class="main">(</span>B <span class="keyword1">*v</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> c_def <span class="keyword1"><span class="command">using</span></span> normB <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"f <span class="skolem">v</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fv c_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> c ge
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matrix_vector_mult_def sum_distrib_left B_norm <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_nonneg<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> id1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span>B <span class="keyword1">*v</span> f <span class="skolem">v</span><span class="main">)</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>B <span class="keyword1">*v</span> <span class="main">(</span>B <span class="keyword1">*v</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> f_def c_def matrix_vect_scaleR <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> id3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> sr <span class="main">*</span> f <span class="skolem">v</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>B <span class="keyword1">*v</span> <span class="main">(</span>sr <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> f_def c_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> matrix_vect_scaleR <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"sr <span class="main">*</span> f <span class="skolem">v</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="main">(</span>B <span class="keyword1">*v</span> f <span class="skolem">v</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id1 id3
        <span class="keyword1"><span class="command">unfolding</span></span> mult_le_cancel_iff2<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_B_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ge<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> 1 2
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">with</span></span> norm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"f <span class="skolem">v</span> <span class="main">∈</span> S"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> cont_f<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on S f"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> f_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> continuous_on <span class="keyword1"><span class="command">using</span></span> normB_S
  <span class="keyword1"><span class="command">unfolding</span></span> norm1_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">tendsto_eq_intros</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">lemma</span></span> perron_frobenius_positive_ev<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> eigen_vector <span class="free">A</span> <span class="bound">v</span> <span class="main">(</span>r sr<span class="main">)</span> <span class="main">∧</span> real_non_neg_vec <span class="bound">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> brouwer<span class="main">[</span><span class="operator">OF</span> compactS convexS non_emptyS cont_f image_f<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> S"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fv<span class="main">:</span> <span class="quoted"><span class="quoted">"f <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ev</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ev</span> <span class="main">=</span> norm1 <span class="main">(</span>B <span class="keyword1">*v</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> normB_S<span class="main">[</span><span class="operator">OF</span> v<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ev</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ev_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> norm1_ge_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"B <span class="keyword1">*v</span> <span class="skolem">v</span>"</span></span><span class="main">,</span> <span class="operator">folded</span> ev_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> norm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ev</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> fv<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> f_def<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="bound">w</span> <span class="main">::</span> real <span class="main">^</span> <span class="tfree">'n</span><span class="main">)</span><span class="main">.</span> <span class="skolem">ev</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">w</span>"</span></span><span class="main">]</span> norm
  <span class="keyword1"><span class="command">have</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"B <span class="keyword1">*v</span> <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">ev</span> <span class="keyword1">*s</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ev_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> scalar_mult_eq_scaleR <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> v<span class="main">[</span><span class="operator">unfolded</span> S_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> sr <span class="main">*</span> <span class="skolem">v</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">≤</span> <span class="skolem">ev</span> <span class="main">*</span> <span class="skolem">v</span> <span class="main">$</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> rv <span class="skolem">v</span> <span class="main">=</span> rv <span class="main">(</span>B <span class="keyword1">*v</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rv_mult <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">ev</span> <span class="keyword1">*s</span> rv <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ev vec_eq_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scaleR_conv_of_real scaleR_vec_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> rv <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">ev</span> <span class="keyword1">*s</span> rv <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> v <span class="keyword1"><span class="command">have</span></span> v0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rv <span class="skolem">v</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rv_0 <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> ev <span class="keyword1"><span class="command">have</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"eigen_vector <span class="free">A</span> <span class="main">(</span>rv <span class="skolem">v</span><span class="main">)</span> <span class="skolem">ev</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eigen_vector_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eigen_value <span class="free">A</span> <span class="skolem">ev</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eigen_value_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> spectral_radius_max<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>r <span class="skolem">ev</span><span class="main">)</span> <span class="main">≤</span> sr"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> v0 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> vec_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> ge<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"sr <span class="main">≤</span> <span class="skolem">ev</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> le <span class="keyword1"><span class="command">have</span></span> sr<span class="main">:</span> <span class="quoted"><span class="quoted">"r sr <span class="main">=</span> <span class="skolem">ev</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> v <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"real_non_neg_vec <span class="main">(</span>rv <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def real_non_neg_vec_def vec_elements_h_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sr
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"rv <span class="skolem">v</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> * ev norm<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">lemma</span></span> perron_frobenius_both<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> eigen_vector <span class="free">A</span> <span class="bound">v</span> <span class="main">(</span>r sr<span class="main">)</span> <span class="main">∧</span> real_non_neg_vec <span class="bound">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="main">∈</span> S<span class="main">.</span> <span class="free">A</span> <span class="keyword1">*v</span> rv <span class="bound">v</span> <span class="main">≠</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Perron_Frobenius.perron_frobenius_positive_ev<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rnnA<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> True<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> S"</span></span> <span class="keyword2"><span class="keyword">and</span></span> A0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> rv <span class="skolem">v</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> rv <span class="skolem">v</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">*s</span> rv <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> v0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rv <span class="skolem">v</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rv_0 <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> id <span class="keyword1"><span class="command">have</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"eigen_vector <span class="free">A</span> <span class="main">(</span>rv <span class="skolem">v</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eigen_vector_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eigen_value <span class="free">A</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eigen_value_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">from</span></span> spectral_radius_max<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> sr"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> v<span class="main">[</span><span class="operator">unfolded</span> S_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> sr <span class="main">*</span> <span class="skolem">v</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">≤</span> <span class="main">(</span>B <span class="keyword1">*v</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">$</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> v<span class="main">[</span><span class="operator">unfolded</span> S_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> rnn<span class="main">:</span> <span class="quoted"><span class="quoted">"real_non_neg_vec <span class="main">(</span>rv <span class="skolem">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> real_non_neg_vec_def vec_elements_h_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> v0 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> vec_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> vi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> rv_mult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">,</span> <span class="operator">unfolded</span> A0<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rv <span class="main">(</span>B <span class="keyword1">*v</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"B <span class="keyword1">*v</span> <span class="skolem">v</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rv_0 <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> ge<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">,</span> <span class="operator">unfolded</span> this<span class="main">]</span> vi <span class="keyword1"><span class="command">have</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"sr <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_le_0_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≤</span> sr›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sr <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹sr <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> rnn ev <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Perron Frobenius: The largest complex eigenvalue of a real-valued non-negative matrix
  is a real one, and it has a real-valued non-negative eigenvector.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> perron_frobenius<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"real_non_neg_mat <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> eigen_vector <span class="free">A</span> <span class="bound">v</span> <span class="main">(</span>of_real <span class="main">(</span>spectral_radius <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> real_non_neg_vec <span class="bound">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Perron_Frobenius.perron_frobenius_both<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹And a version which ignores the eigenvector.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> perron_frobenius_eigen_value<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"real_non_neg_mat <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eigen_value <span class="free">A</span> <span class="main">(</span>of_real <span class="main">(</span>spectral_radius <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> perron_frobenius<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> eigen_value_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Roots_Unity">
<div class="head">
<h1>Theory Roots_Unity</h1>
</div>
<pre class="source"><span class="comment1">(* author: Thiemann *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Roots of Unity›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Roots_Unity
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Polynomial_Factorization/Order_Polynomial.html">Polynomial_Factorization.Order_Polynomial</a>
  <span class="quoted">"<a href="../../HOL/HOL-Computational_Algebra/Fundamental_Theorem_Algebra.html">HOL-Computational_Algebra.Fundamental_Theorem_Algebra</a>"</span>
  <a href="../Polynomial_Interpolation/Ring_Hom_Poly.html">Polynomial_Interpolation.Ring_Hom_Poly</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cis_mult_cmod_id<span class="main">:</span> <span class="quoted"><span class="quoted">"cis <span class="main">(</span>arg <span class="free">x</span><span class="main">)</span> <span class="main">*</span> of_real <span class="main">(</span>cmod <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rcis_cmod_arg<span class="main">[</span><span class="operator">unfolded</span> rcis_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rcis_mult_cis<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rcis <span class="free">n</span> <span class="free">a</span> <span class="main">*</span> cis <span class="free">b</span> <span class="main">=</span> rcis <span class="free">n</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cis_rcis_eq rcis_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lemma</span></span> rcis_div_cis<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rcis <span class="free">n</span> <span class="free">a</span> <span class="main">/</span> cis <span class="free">b</span> <span class="main">=</span> rcis <span class="free">n</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cis_rcis_eq rcis_divide <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> cis_plus_2pi<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cis <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> pi<span class="main">)</span> <span class="main">=</span> cis <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> complex_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> cis_plus_2pi_neq_1<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> pi"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cis <span class="free">x</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cos <span class="free">x</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> cos_2pi_minus cos_monotone_0_pi cos_zero<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> complex_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cis_times_2pi<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cis <span class="main">(</span>of_nat <span class="free">n</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> pi<span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_nat <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">=</span> of_nat <span class="skolem">n</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> pi"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_right<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cis <span class="main">…</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cis_plus_2pi Suc <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">declare</span></span> cis_pi<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> cis_pi_2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cis <span class="main">(</span>pi <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">𝗂</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> complex_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cis_add_pi<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cis <span class="main">(</span>pi <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> cis <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> complex_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cis_3_pi_2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cis <span class="main">(</span>pi <span class="main">*</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="keyword1">𝗂</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cis <span class="main">(</span>pi <span class="main">*</span> <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> cis <span class="main">(</span>pi <span class="main">+</span> pi <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">cis</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">-</span> <span class="keyword1">𝗂</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cis_add_pi <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rcis_plus_2pi<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rcis <span class="free">y</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> pi<span class="main">)</span> <span class="main">=</span> rcis <span class="free">y</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rcis_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lemma</span></span> rcis_times_2pi<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rcis <span class="free">r</span> <span class="main">(</span>of_nat <span class="free">n</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> pi<span class="main">)</span> <span class="main">=</span> of_real <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rcis_def cis_times_2pi <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> arg_rcis_cis<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"arg <span class="main">(</span>rcis <span class="free">n</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> arg <span class="main">(</span>cis <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> arg_bounded arg_unique cis_arg complex_mod_rcis n rcis_def sgn_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> arg_eqD<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"arg <span class="main">(</span>cis <span class="free">x</span><span class="main">)</span> <span class="main">=</span> arg <span class="main">(</span>cis <span class="free">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span>pi <span class="main">&lt;</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> pi"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span>pi <span class="main">&lt;</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> pi"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> arg_unique<span class="main">[</span><span class="operator">OF</span> sgn_cis assms<span class="main"><span class="main">(</span></span>2-3<span class="main"><span class="main">)</span></span><span class="main">]</span> arg_unique<span class="main">[</span><span class="operator">OF</span> sgn_cis assms<span class="main"><span class="main">(</span></span>4-5<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rcis_inj_on<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>rcis <span class="free">r</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="numeral">2</span> <span class="main">*</span> pi<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> 1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> <span class="free">r</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cis <span class="skolem">x</span> <span class="main">=</span> cis <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rcis_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> inverse <span class="bound">x</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cis <span class="main">(</span><span class="main">-</span><span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> cis <span class="main">(</span><span class="main">-</span><span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted">uminus</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"cis <span class="main">(</span><span class="main">-</span><span class="skolem">x</span> <span class="main">+</span> pi<span class="main">)</span> <span class="main">=</span> cis <span class="main">(</span><span class="main">-</span><span class="skolem">y</span> <span class="main">+</span> pi<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> complex_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="skolem">x</span> <span class="main">+</span> pi <span class="main">=</span> <span class="main">-</span> <span class="skolem">y</span> <span class="main">+</span> pi"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_eqD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> arg_cong<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> *<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">arg</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> 1<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cis_inj_on<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on cis <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="numeral">2</span> <span class="main">*</span> pi<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rcis_inj_on<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> rcis_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">root_unity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> comm_ring_1 poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">root_unity</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> monom <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> poly_root_unity<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>root_unity <span class="free">n</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">x</span><span class="main">^</span><span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> root_unity_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_monom<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> degree_root_unity<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>root_unity <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"degree <span class="var">?p</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">=</span> monom <span class="main">1</span> <span class="free">n</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> root_unity_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> p <span class="keyword1"><span class="command">unfolding</span></span> Suc
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> degree_add_eq_left<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degree_monom_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zero_root_unit<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"root_unity <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> root_unity_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> degree_root_unity<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> False
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="var">?p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prod_root_unity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> idom poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prod_root_unity</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">=</span> prod_list <span class="main">(</span>map root_unity <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> poly_prod_root_unity<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>prod_root_unity <span class="free">ns</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">∈</span>set <span class="free">ns</span><span class="main">.</span> <span class="free">x</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prod_root_unity_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_prod_list prod_list_zero_iff o_def image_def poly_root_unity<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> degree_prod_root_unity<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> set <span class="free">ns</span> <span class="main">⟹</span> degree <span class="main">(</span>prod_root_unity <span class="free">ns</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="free">ns</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prod_root_unity_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> degree_prod_list_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zero_prod_root_unit<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prod_root_unity <span class="free">ns</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="main">0</span> <span class="main">∈</span> set <span class="free">ns</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prod_root_unity_def prod_list_zero_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> roots_of_unity<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span>cis <span class="main">(</span>of_nat <span class="bound">i</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">::</span> complex<span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?prod</span> <span class="main">=</span> <span class="var">?Roots</span>"</span></span><span class="main">)</span>
     <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>root_unity <span class="free">n</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">::</span> complex<span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span>"</span></span>
     <span class="quoted"><span class="quoted">"card <span class="main">{</span> <span class="bound">x</span> <span class="main">::</span> complex<span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?one</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">::</span> complex"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"monom <span class="var">?one</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> degM<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>monom <span class="var">?one</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> degree_monom_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="var">?p</span> <span class="main">=</span> degree <span class="main">(</span>monom <span class="var">?one</span> <span class="free">n</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> degree <span class="main">(</span>monom <span class="var">?one</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> degree_add_eq_left<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> n<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> degM<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> degp<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="var">?p</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> degM <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> n <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> roots<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Roots</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="var">?p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> poly_diff poly_monom <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> poly_roots_finite<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?Roots</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?prod</span> <span class="main">⊆</span> <span class="var">?Roots</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?prod</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> cis <span class="main">(</span>real <span class="skolem">i</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">^</span> <span class="free">n</span> <span class="main">=</span> cis <span class="main">(</span>real <span class="skolem">i</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> pi<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> x DeMoivre <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?Roots</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> Rn<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?Roots</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> roots
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> poly_roots_degree<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?p</span></span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> degp<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> p<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> card <span class="var">?prod</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> card_image<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> inj_onI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"real <span class="skolem">m</span> <span class="main">&lt;</span> real <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> mult_strict_right_mono<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> real <span class="free">n</span>"</span></span><span class="main">]</span> n
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="skolem">m</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> real <span class="free">n</span> <span class="main">&lt;</span> real <span class="free">n</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> real <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"real <span class="skolem">m</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> real <span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> pi"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> this
    <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="skolem">x</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> real <span class="free">n</span> <span class="main">=</span> real <span class="skolem">y</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> real <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rcis_inj_on 1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> cis_rcis_eq<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> 1<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> n <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> cn<span class="main">:</span>  <span class="quoted"><span class="quoted">"card <span class="var">?prod</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">with</span></span> Rn <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?prod</span> <span class="main">≥</span> card <span class="var">?Roots</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> card_mono<span class="main">[</span><span class="operator">OF</span> fin sub<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> card<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?prod</span> <span class="main">=</span> card <span class="var">?Roots</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?prod</span> <span class="main">=</span> <span class="var">?Roots</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_subset_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin sub card<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this roots<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> cn<span class="main">[</span><span class="operator">unfolded</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> root_unity_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> poly_roots_dvd<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> field poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">≥</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> poly_roots_degree<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>2-3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="free">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1-2<span class="main">)</span> this assms<span class="main">(</span>4<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>0 <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> is_unit_iff_degree<span class="main">[</span><span class="operator">OF</span> 0<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> 0<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="skolem">p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="skolem">q</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>4-5<span class="main">)</span> card_gt_0_iff<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      x<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"poly <span class="skolem">q</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">[:</span><span class="main">-</span><span class="skolem">x</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> x<span class="main">[</span><span class="operator">unfolded</span> poly_eq_0_iff_dvd r_def<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">symmetric</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">*</span> <span class="skolem">p'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">*</span> <span class="skolem">q'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">p</span> <span class="main">=</span> degree <span class="skolem">r</span> <span class="main">+</span> degree <span class="skolem">p'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> degree_mult_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Suc<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">p'</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>2<span class="main">)</span> p <span class="keyword1"><span class="command">have</span></span> p'0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="skolem">p'</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="skolem">q'</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="var">?P'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p poly_mult <span class="keyword1"><span class="command">unfolding</span></span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="var">?Q'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> q poly_mult <span class="keyword1"><span class="command">unfolding</span></span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?P'</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">=</span> <span class="var">?P'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted">card</span><span class="main">,</span> <span class="operator">unfolded</span> Suc<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> deg <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> poly_roots_degree<span class="main">[</span><span class="operator">OF</span> p'0<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> xp' <span class="main">=</span> this
    <span class="keyword1"><span class="command">hence</span></span> xP'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?P'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?P</span> <span class="main">=</span> Suc <span class="main">(</span>card <span class="var">?P'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> P
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_insert_disjoint<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ xP'<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> fin<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> P<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Suc<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> card<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?P'</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> P Q<span class="main">]</span> xP' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P'</span> <span class="main">⊆</span> <span class="var">?Q'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> p'0 deg card this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="keyword1">dvd</span> <span class="skolem">q'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> p q <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> root_unity_decomp<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"root_unity <span class="free">n</span> <span class="main">=</span>
    prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span>cis <span class="main">(</span>of_nat <span class="bound">i</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> <span class="free">n</span><span class="main">)</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="main">=</span> <span class="var">?p</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="var">?u</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> roots_of_unity<span class="main">[</span><span class="operator">OF</span> n<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="keyword1">dvd</span> <span class="var">?p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> poly_roots_dvd<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ deg<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="var">?u</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> main <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="var">?u</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="var">?p</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> main<span class="main">(</span>2<span class="main">)</span> main<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> poly_prod_list prod_list_zero_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> deg'<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="var">?p</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> degree_prod_list_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def sum_list_triv<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> mon<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="var">?u</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> deg <span class="keyword1"><span class="command">unfolding</span></span> root_unity_def <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> mon'<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="var">?p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> monic_prod_list<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> dvd<span class="main">[</span><span class="operator">unfolded</span> dvd_def<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> puf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">=</span> <span class="var">?u</span> <span class="main">*</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="var">?p</span> <span class="main">=</span> degree <span class="var">?u</span> <span class="main">+</span> degree <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mon' n <span class="keyword1"><span class="command">unfolding</span></span> puf
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> degree_mult_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> deg deg' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="skolem">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> degree0_coeffs<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">[:</span><span class="skolem">a</span><span class="main">:]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> puf<span class="main">,</span> <span class="operator">of</span> <span class="quoted">lead_coeff</span><span class="main">]</span> mon mon'
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> puf f <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> f <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> puf <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> order_monic_linear<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="free">x</span> <span class="main">[:</span><span class="free">y</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">y</span> <span class="main">+</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">+</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">[:</span><span class="free">y</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> order_root<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="free">x</span> <span class="main">[:</span><span class="free">y</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> order_degree<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[:</span><span class="free">y</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span>"</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="free">x</span> <span class="main">[:</span><span class="free">y</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">[:</span><span class="free">y</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> order_0I<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> order_root_unity<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">complex</span> <span class="keyword2"><span class="keyword">assumes</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"order <span class="free">x</span> <span class="main">(</span>root_unity <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span><span class="main">^</span><span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"order <span class="main">_</span> <span class="var">?u</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">^</span><span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> roots_of_unity<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> n<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="var">?u</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> False order_0I<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?phi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span> <span class="main">::</span> nat<span class="main">.</span> <span class="bound">i</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> True roots_of_unity<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> n<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> cis <span class="main">(</span><span class="var">?phi</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> n_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">i</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">i</span> <span class="main">#</span> <span class="main">[</span>Suc <span class="skolem">i</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_Suc_ex less_imp_le_nat not_le_imp_less not_less0 upt_add_eq_append upt_conv_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∨</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"cis <span class="main">(</span><span class="var">?phi</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> cis <span class="main">(</span><span class="var">?phi</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> inj_onD<span class="main">[</span><span class="operator">OF</span> cis_inj_on eq<span class="main">]</span> i j n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> inj <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="free">x</span> <span class="var">?u</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> root_unity_decomp<span class="main">[</span><span class="operator">OF</span> n<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> x n_split <span class="keyword1"><span class="command">using</span></span> inj
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> order_prod_list<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> order_monic_linear<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> order_prod_root_unity<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> set <span class="free">ks</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"order <span class="main">(</span><span class="free">x</span> <span class="main">::</span> complex<span class="main">)</span> <span class="main">(</span>prod_root_unity <span class="free">ks</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> <span class="free">x</span><span class="main">^</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="free">ks</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="free">x</span> <span class="main">(</span>prod_root_unity <span class="free">ks</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">←</span><span class="free">ks</span><span class="main">.</span> order <span class="free">x</span> <span class="main">(</span>root_unity <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> prod_root_unity_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> order_prod_list<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> 0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">←</span><span class="free">ks</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span><span class="main">^</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> map_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> 0<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> order_root_unity<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> <span class="free">x</span><span class="main">^</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="free">ks</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_list_map_filter'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_list_triv<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> root_unity_witness<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span><span class="bound">x</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> monom <span class="main">1</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">^</span><span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_list_zero_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟷</span> poly <span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span><span class="bound">x</span><span class="main">,</span><span class="main">1</span><span class="main">:]</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> poly_prod_list prod_list_zero_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="free">x</span><span class="main">^</span><span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> roots_of_unity<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> n0<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> assms root_unity_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> root_unity_explicit<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">complex</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="main">1</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="numeral">3</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> Complex <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>sqrt <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">,</span> Complex <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span> sqrt <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="keyword1">𝗂</span><span class="main">,</span> <span class="main">-</span> <span class="keyword1">𝗂</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="main">1</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> root_unity_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[</span></span></span><span class="main"><span class="main"><span class="main">1</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">code_simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> root_unity_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[</span></span></span><span class="main"><span class="main"><span class="main">1</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span><span class="main"><span class="main"><span class="main">-</span></span></span><span class="main"><span class="main"><span class="main">1</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">code_simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="numeral">4</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="keyword1">𝗂</span><span class="main">,</span> <span class="main">-</span> <span class="keyword1">𝗂</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> root_unity_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[</span></span></span><span class="main"><span class="main"><span class="main">1</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span><span class="main"><span class="main"><span class="main">-</span></span></span><span class="main"><span class="main"><span class="main">1</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">𝗂</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">𝗂</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">code_simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> <span class="main">[:</span><span class="main">1</span><span class="main">:]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="numeral">3</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> Complex <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>sqrt <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">,</span> Complex <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span> sqrt <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> root_unity_witness<span class="main"><span class="main">[</span></span><span class="operator">of</span>
      <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[</span></span></span><span class="main"><span class="main"><span class="main">1</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> Complex <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">-</span></span></span><span class="main"><span class="main"><span class="main">1</span></span></span><span class="main"><span class="main"><span class="main">/</span></span></span><span class="numeral"><span class="numeral"><span class="numeral">2</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>sqrt <span class="numeral"><span class="numeral"><span class="numeral">3</span></span></span> <span class="main"><span class="main"><span class="main">/</span></span></span> <span class="numeral"><span class="numeral"><span class="numeral">2</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> Complex <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">-</span></span></span><span class="main"><span class="main"><span class="main">1</span></span></span><span class="main"><span class="main"><span class="main">/</span></span></span><span class="numeral"><span class="numeral"><span class="numeral">2</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">-</span></span></span> sqrt <span class="numeral"><span class="numeral"><span class="numeral">3</span></span></span> <span class="main"><span class="main"><span class="main">/</span></span></span> <span class="numeral"><span class="numeral"><span class="numeral">2</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 3 monom_altdef complex_mult complex_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">primitive_root_unity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> power <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">primitive_root_unity</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">^</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound"><span class="bound">k'</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">.</span> <span class="bound">k'</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">^</span><span class="bound">k'</span> <span class="main">≠</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> primitive_root_unityD<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"primitive_root_unity <span class="free">k</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">^</span><span class="free">k</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k'</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">^</span><span class="free">k'</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> assms<span class="main">[</span><span class="operator">unfolded</span> primitive_root_unity_def<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k'</span> <span class="main">&lt;</span> <span class="free">k</span> <span class="main">⟹</span> <span class="free">k'</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">^</span> <span class="free">k'</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">^</span><span class="free">k</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k'</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">^</span><span class="free">k'</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> primitive_root_unity_exists<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="free">k</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k'</span><span class="main">.</span> <span class="bound">k'</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">∧</span> primitive_root_unity <span class="bound">k'</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> <span class="free">x</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">k</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> Pk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> LeastI_ex<span class="main">[</span><span class="operator">OF</span> Pk<span class="main">,</span> <span class="operator">folded</span> k'_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="skolem">k'</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> not_less_Least<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">,</span> <span class="operator">folded</span> k'_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"primitive_root_unity <span class="skolem">k'</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> primitive_root_unity_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> primitive_root_unityD<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this assms<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> primitive_root_unity_dvd<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"primitive_root_unity <span class="free">k</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟷</span> <span class="free">k</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="free">k</span> <span class="main">*</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="free">k</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> n power_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> primitive_root_unityD<span class="main">[</span><span class="operator">OF</span> k<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> k <span class="main">=</span> primitive_root_unityD<span class="main">[</span><span class="operator">OF</span> k<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> n0<span class="main">:</span> False
    <span class="keyword1"><span class="command">from</span></span> k<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> n0<span class="main">]</span> n <span class="keyword1"><span class="command">have</span></span> nk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> roots_of_unity<span class="main">[</span><span class="operator">OF</span> k<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span> k<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> xk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> cis <span class="main">(</span><span class="skolem">i</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> <span class="free">k</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ik<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> roots_of_unity<span class="main">[</span><span class="operator">OF</span> n0<span class="main">]</span> n <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> xn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> cis <span class="main">(</span><span class="skolem">j</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> jn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> cop<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">i</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> gcd_eq_1_imp_coprime<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> k<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="skolem">i</span> <span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> gcd_coprime_exists<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">i'</span> <span class="main">*</span> <span class="skolem">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="skolem">k'</span> <span class="main">*</span> <span class="skolem">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> gcd <span class="skolem">i</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">)</span> k<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> cis <span class="main">(</span><span class="skolem">i</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> <span class="free">k</span> <span class="main">=</span> <span class="skolem">i'</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> <span class="skolem">k'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> * <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="skolem">k'</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DeMoivre k'<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> k<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> k'<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">≥</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> * k<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gcd <span class="skolem">i</span> <span class="free">k</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> inj_onD<span class="main">[</span><span class="operator">OF</span> cis_inj_on xk<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> xn<span class="main"><span class="main">]</span></span><span class="main">]</span> n0 k<span class="main">(</span>1<span class="main">)</span> ik jn
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">*</span> real <span class="free">k</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">*</span> real <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="skolem">j</span> <span class="main">*</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> real <span class="main">(</span><span class="skolem">i</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">*</span> <span class="free">k</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">*</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">with</span></span> cop <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">dvd</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> coprime_commute coprime_dvd_mult_right_iff dvd_triv_right<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> primitive_root_unity_simple_computation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"primitive_root_unity <span class="free">k</span> <span class="free">x</span>  <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> False <span class="keyword1">else</span>
     <span class="free">x</span> <span class="main">^</span> <span class="free">k</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span> <span class="main">..&lt;</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> <span class="free">x</span> <span class="main">^</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> primitive_root_unity_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> primitive_root_unity_explicit<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">complex</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"primitive_root_unity <span class="main">1</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="quoted"><span class="quoted">"primitive_root_unity <span class="numeral">2</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span>
    <span class="quoted"><span class="quoted">"primitive_root_unity <span class="numeral">3</span> <span class="free">x</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> <span class="main">{</span>Complex <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>sqrt <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">,</span> Complex <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span> sqrt <span class="numeral">3</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"primitive_root_unity <span class="numeral">4</span> <span class="free">x</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="keyword1">𝗂</span><span class="main">,</span> <span class="main">-</span> <span class="keyword1">𝗂</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bool"</span></span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span> <span class="main">..&lt;</span> <span class="numeral">2</span> <span class="main">::</span> nat<span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span> <span class="main">..&lt;</span> <span class="numeral">3</span> <span class="main">::</span> nat<span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span> <span class="main">..&lt;</span> <span class="numeral">4</span> <span class="main">::</span> nat<span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span> <span class="main">{</span><span class="main">1</span> <span class="main">..&lt;</span> <span class="numeral">2</span><span class="main">}</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">P</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span> <span class="main">{</span><span class="main">1</span> <span class="main">..&lt;</span> <span class="numeral">3</span><span class="main">}</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟷</span> <span class="skolem">P</span> <span class="main">1</span> <span class="main">∧</span> <span class="skolem">P</span> <span class="numeral">2</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span> <span class="main">{</span><span class="main">1</span> <span class="main">..&lt;</span> <span class="numeral">4</span><span class="main">}</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟷</span> <span class="skolem">P</span> <span class="main">1</span> <span class="main">∧</span> <span class="skolem">P</span> <span class="numeral">2</span> <span class="main">∧</span> <span class="skolem">P</span> <span class="numeral">3</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> primitive_root_unity_simple_computation root_unity_explicit *
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> complex_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">decompose_prod_root_unity_main</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> field poly <span class="main">⇒</span> nat <span class="main">⇒</span> nat list <span class="main">×</span> <span class="tfree">'a</span> poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">decompose_prod_root_unity_main</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="keyword1">else</span>
   <span class="keyword1">let</span> <span class="bound">q</span> <span class="main">=</span> root_unity <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">q</span> <span class="keyword1">dvd</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> <span class="keyword1">else</span>
     map_prod <span class="main">(</span>Cons <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> id <span class="main">(</span><span class="free">decompose_prod_root_unity_main</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">div</span> <span class="bound">q</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="keyword1">else</span>
     <span class="free">decompose_prod_root_unity_main</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">k</span><span class="main">)</span><span class="main">.</span> degree <span class="bound">p</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degree_div_less<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> decompose_prod_root_unity_main.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> decompose_prod_root_unity_main<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> prod_root_unity <span class="free">ks</span> <span class="main">*</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"decompose_prod_root_unity_main <span class="free">p</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="free">ks'</span><span class="main">,</span><span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> cmod <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> poly <span class="free">f</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k'</span><span class="main">.</span> <span class="bound">k'</span> <span class="main">&gt;</span> <span class="free">k</span> <span class="main">⟹</span> <span class="main">¬</span> root_unity <span class="bound">k'</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> prod_root_unity <span class="free">ks'</span> <span class="main">*</span> <span class="free">f</span> <span class="main">∧</span> <span class="free">f</span> <span class="main">=</span> <span class="free">g</span> <span class="main">∧</span> set <span class="free">ks</span> <span class="main">=</span> set <span class="free">ks'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> d p k
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ks</span></span> <span class="quoted"><span class="free">ks'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> decompose_prod_root_unity_main.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">p</span> <span class="skolem">k</span> <span class="skolem">ks</span> <span class="skolem">ks'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> p <span class="main">=</span> 1<span class="main">(</span>4<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> k <span class="main">=</span> 1<span class="main">(</span>5<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> k<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> p0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> 1<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> decompose_prod_root_unity_main.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main"><span class="main">]</span></span> this if_False Let_def<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> p0<span class="main">[</span><span class="operator">unfolded</span> p<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ks0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> set <span class="skolem">ks</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> f<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> f0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ refl _ p0<span class="main">]</span> 1<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ refl<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> p k<span class="main">[</span><span class="operator">unfolded</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">ks</span>"</span></span><span class="main">]</span> p0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ks</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ks</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_root_unity_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> d p True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_root_unity_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> k0<span class="main">:</span> False
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">[</span><span class="operator">OF</span> k0<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> k0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> d<span class="main">[</span><span class="operator">unfolded</span> this if_False<span class="main">]</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"root_unity <span class="skolem">k</span> <span class="main">::</span> complex poly"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="keyword1">dvd</span> <span class="skolem">p</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?call</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"decompose_prod_root_unity_main <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">div</span> <span class="var">?u</span><span class="main">)</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> True d <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ks</span></span> <span class="keyword2"><span class="keyword">where</span></span> rec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?call</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Ks</span><span class="main">,</span><span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ks'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ks'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">#</span> <span class="skolem">Ks</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?call</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?u</span> <span class="keyword1">dvd</span> <span class="skolem">p</span> <span class="main">⟷</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> d<span class="main">[</span><span class="operator">unfolded</span> this if_True rec<span class="main">]</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cis <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="var">?u</span> <span class="var">?x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> poly_root_unity <span class="keyword1"><span class="command">using</span></span> cis_times_2pi<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> DeMoivre<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="skolem">p</span> <span class="var">?x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dvd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> p<span class="main">]</span> f<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span><span class="main">]</span> rt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>prod_root_unity <span class="skolem">ks</span><span class="main">)</span> <span class="var">?x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> poly_root_unity <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> poly_prod_root_unity<span class="main">]</span> ks0 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">∈</span> set <span class="skolem">ks</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">^</span> <span class="skolem">k'</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> k'0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"root_unity <span class="skolem">k'</span> <span class="main">::</span> complex poly"</span></span>
      <span class="keyword1"><span class="command">from</span></span> k' rt k'0 <span class="keyword1"><span class="command">have</span></span> rtk'<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="var">?u'</span> <span class="var">?x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> poly_root_unity <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?phi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">" <span class="skolem">k'</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="var">?phi</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?phi</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> pi"</span></span> <span class="keyword1"><span class="command">using</span></span> k0 k'0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> cis_plus_2pi_neq_1<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> rtk'
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> poly_root_unity DeMoivre <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">hence</span></span> kk'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">k'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">&gt;</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> k<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">unfolded</span> p<span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?u'</span> <span class="keyword1">dvd</span> prod_root_unity <span class="skolem">ks</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dvd_mult2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> k' <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> prod_root_unity_def
          <span class="keyword1"><span class="command">using</span></span> prod_list_dvd<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?u'</span></span></span> <span class="quoted"><span class="quoted">"map root_unity <span class="skolem">ks</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">with</span></span> kk' <span class="keyword1"><span class="command">have</span></span> kk'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">with</span></span> k' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> set <span class="skolem">ks</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> split_list<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ks1</span></span> <span class="skolem"><span class="skolem">ks2</span></span> <span class="keyword2"><span class="keyword">where</span></span> ks<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ks</span> <span class="main">=</span> <span class="skolem">ks1</span> <span class="main">@</span> <span class="skolem">k</span> <span class="main">#</span> <span class="skolem">ks2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">div</span> <span class="var">?u</span> <span class="main">=</span> <span class="main">(</span><span class="var">?u</span> <span class="main">*</span> <span class="main">(</span>prod_root_unity <span class="main">(</span><span class="skolem">ks1</span> <span class="main">@</span> <span class="skolem">ks2</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="var">?u</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> p prod_root_unity_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> prod_root_unity <span class="main">(</span><span class="skolem">ks1</span> <span class="main">@</span> <span class="skolem">ks2</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nonzero_mult_div_cancel_left<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> k0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">div</span> <span class="var">?u</span> <span class="main">=</span> prod_root_unity <span class="main">(</span><span class="skolem">ks1</span> <span class="main">@</span> <span class="skolem">ks2</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">from</span></span> d <span class="keyword1"><span class="command">have</span></span> ks'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ks'</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">#</span> <span class="skolem">Ks</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">k'</span> <span class="main">⟹</span> <span class="main">¬</span> root_unity <span class="skolem">k'</span> <span class="keyword1">dvd</span> <span class="skolem">p</span> <span class="keyword1">div</span> <span class="var">?u</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k'</span>
        <span class="keyword1"><span class="command">using</span></span> k<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k'</span></span><span class="main">]</span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_div_mult_self dvd_mult2<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="operator">OF</span> rec id this<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">div</span> root_unity <span class="skolem">k</span> <span class="main">=</span> prod_root_unity <span class="skolem">Ks</span> <span class="main">*</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">g</span> <span class="main">∧</span> set <span class="main">(</span><span class="skolem">ks1</span> <span class="main">@</span> <span class="skolem">ks2</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">Ks</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> id<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> <span class="var">?u</span>"</span></span><span class="main">]</span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> prod_root_unity <span class="skolem">Ks</span> <span class="main">*</span> <span class="free">f</span> <span class="main">*</span> root_unity <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">unfolding</span></span> ks ks' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_root_unity_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> d False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"decompose_prod_root_unity_main <span class="skolem">p</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ks'</span><span class="main">,</span><span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> False this p<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">k'</span> <span class="main">⟹</span> <span class="main">¬</span> root_unity <span class="skolem">k'</span> <span class="keyword1">dvd</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k'</span> <span class="keyword1"><span class="command">using</span></span> False k<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k'</span></span><span class="main">]</span> k0
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> IH<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> False k<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">decompose_prod_root_unity</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> decompose_prod_root_unity_main <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>degree <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> decompose_prod_root_unity<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> prod_root_unity <span class="free">ks</span> <span class="main">*</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"decompose_prod_root_unity <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">ks'</span><span class="main">,</span><span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> cmod <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> poly <span class="free">f</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> p0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> prod_root_unity <span class="free">ks'</span> <span class="main">*</span> <span class="free">f</span> <span class="main">∧</span> <span class="free">f</span> <span class="main">=</span> <span class="free">g</span> <span class="main">∧</span> set <span class="free">ks</span> <span class="main">=</span> set <span class="free">ks'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> decompose_prod_root_unity_main<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p d<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> decompose_prod_root_unity_def<span class="main"><span class="main">]</span></span> f<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
  <span class="keyword3"><span class="command">assume</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">&lt;</span> degree <span class="main">(</span>root_unity <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> p0 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> root_unity <span class="skolem">k</span> <span class="keyword1">dvd</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_divides_conv0<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> comm_ring_hom<span class="main">)</span> hom_root_unity<span class="main">:</span> <span class="quoted"><span class="quoted">"map_poly <span class="free">hom</span> <span class="main">(</span>root_unity <span class="free">n</span><span class="main">)</span> <span class="main">=</span> root_unity <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> p<span class="main">:</span> map_poly_comm_ring_hom <span class="quoted"><span class="free">hom</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> root_unity_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">hom_distribs</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> idom_hom<span class="main">)</span> hom_prod_root_unity<span class="main">:</span> <span class="quoted"><span class="quoted">"map_poly <span class="free">hom</span> <span class="main">(</span>prod_root_unity <span class="free">n</span><span class="main">)</span> <span class="main">=</span> prod_root_unity <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> p<span class="main">:</span> map_poly_comm_ring_hom <span class="quoted"><span class="free">hom</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> prod_root_unity_def p.hom_prod_list map_map o_def hom_root_unity <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> field_hom<span class="main">)</span> hom_decompose_prod_root_unity_main<span class="main">:</span>
  <span class="quoted"><span class="quoted">"decompose_prod_root_unity_main <span class="main">(</span>map_poly <span class="free">hom</span> <span class="free">p</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> map_prod id <span class="main">(</span>map_poly <span class="free">hom</span><span class="main">)</span>
    <span class="main">(</span>decompose_prod_root_unity_main <span class="free">p</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> decompose_prod_root_unity_main.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">p</span> <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_poly <span class="free">hom</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"root_unity <span class="skolem">k</span> <span class="main">::</span> <span class="tfree">'a</span> poly"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"root_unity <span class="skolem">k</span> <span class="main">::</span> <span class="tfree">'b</span> poly"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> p<span class="main">:</span> map_poly_inj_idom_divide_hom <span class="quoted"><span class="free">hom</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> u'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?u'</span> <span class="main">=</span> <span class="var">?h</span> <span class="var">?u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> hom_root_unity <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">note</span></span> simp <span class="main">=</span> decompose_prod_root_unity_main.simps
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rec1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"decompose_prod_root_unity_main <span class="main">(</span><span class="skolem">p</span> <span class="keyword1">div</span> <span class="var">?u</span><span class="main">)</span> <span class="skolem">k</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> simp<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> simp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> if_distrib<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"map_prod id <span class="var">?h</span>"</span></span><span class="main">]</span> Let_def u'
    <span class="keyword1"><span class="command">unfolding</span></span> 0 p.hom_div<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> p.hom_dvd_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> if_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> if_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl if_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span>
     <span class="main">(</span><span class="operator">subst</span> 1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?rec1</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="main">(</span><span class="operator">subst</span> 1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> field_hom<span class="main">)</span> hom_decompose_prod_root_unity<span class="main">:</span>
  <span class="quoted"><span class="quoted">"decompose_prod_root_unity <span class="main">(</span>map_poly <span class="free">hom</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> map_prod id <span class="main">(</span>map_poly <span class="free">hom</span><span class="main">)</span>
    <span class="main">(</span>decompose_prod_root_unity <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> decompose_prod_root_unity_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> hom_decompose_prod_root_unity_main<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Perron_Frobenius_Irreducible">
<div class="head">
<h1>Theory Perron_Frobenius_Irreducible</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Thiemann *)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Perron Frobenius Theorem for Irreducible Matrices›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Perron_Frobenius_Irreducible
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Perron_Frobenius.html">Perron_Frobenius</a>
  <a href="Roots_Unity.html">Roots_Unity</a>
  <a href="../Rank_Nullity_Theorem/Miscellaneous.html">Rank_Nullity_Theorem.Miscellaneous</a> <span class="comment1">(* for scalar-matrix-multiplication, 
    this import is incompatible with field_simps, ac_simps *)</span>
<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1"><span class="command">lifting_forget</span></span> vec.lifting
<span class="keyword1"><span class="command">lifting_forget</span></span> mat.lifting
<span class="keyword1"><span class="command">lifting_forget</span></span> poly.lifting

<span class="keyword1"><span class="command">lemma</span></span> charpoly_of_real<span class="main">:</span> <span class="quoted"><span class="quoted">"charpoly <span class="main">(</span>map_matrix complex_of_real <span class="free">A</span><span class="main">)</span> <span class="main">=</span> map_poly of_real <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer_hma</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> of_real_hom.char_poly_hom<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemma</span></span> HMA_M_smult<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(=)</span> <span class="main">===&gt;</span> HMA_M <span class="main">===&gt;</span> HMA_M<span class="main">)</span> <span class="keyword1">(⋅<span class="hidden">⇩</span><sub>m</sub>)</span> <span class="main">(</span><span class="keyword1">(*k)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> smult_mat_def 
  <span class="keyword1"><span class="command">unfolding</span></span> rel_fun_def HMA_M_def from_hma<span class="hidden">⇩</span><sub>m</sub>_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matrix_scalar_mult_def<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> order_charpoly_smult<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"order <span class="free">x</span> <span class="main">(</span>charpoly <span class="main">(</span><span class="free">k</span> <span class="keyword1">*k</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> order <span class="main">(</span><span class="free">x</span> <span class="main">/</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> order_char_poly_smult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ k<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="comment1">(* use field, since the *k-lemmas have been stated for fields *)</span>
<span class="keyword1"><span class="command">lemma</span></span> smult_eigen_vector<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> field"</span></span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eigen_vector <span class="free">A</span> <span class="free">v</span> <span class="free">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eigen_vector <span class="main">(</span><span class="free">a</span> <span class="keyword1">*k</span> <span class="free">A</span><span class="main">)</span> <span class="free">v</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> eigen_vector_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> <span class="free">v</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">*s</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> id<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">(*s)</span> <span class="free">a</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="keyword1">*k</span> <span class="free">A</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">*s</span> <span class="free">v</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> scalar_matrix_vector_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"eigen_vector <span class="main">(</span><span class="free">a</span> <span class="keyword1">*k</span> <span class="free">A</span><span class="main">)</span> <span class="free">v</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> v <span class="keyword1"><span class="command">unfolding</span></span> eigen_vector_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> smult_eigen_value<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> field"</span></span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eigen_value <span class="free">A</span> <span class="free">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eigen_value <span class="main">(</span><span class="free">a</span> <span class="keyword1">*k</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms smult_eigen_vector<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="main">_</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> eigen_value_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">locale</span></span> fixed_mat <span class="main">=</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> zero <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'n</span> rel"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">=</span> <span class="main">{</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">irreducible</span> <span class="main">::</span> <span class="quoted">bool</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">irreducible</span> <span class="main">=</span> <span class="main">(</span>UNIV <span class="main">⊆</span> G<span class="main">^+</span><span class="main">)</span>"</span></span> 
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> G_transpose<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"fixed_mat.G <span class="main">(</span>transpose <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>fixed_mat.G <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">^-1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fixed_mat.G_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> transpose_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> G_transpose_trancl<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>fixed_mat.G <span class="main">(</span>transpose <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">^+</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>fixed_mat.G <span class="free">A</span><span class="main">)</span><span class="main">^+</span><span class="main">)</span><span class="main">^-1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> G_transpose trancl_converse <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1"><span class="command">locale</span></span> pf_nonneg_mat <span class="main">=</span> fixed_mat <span class="quoted"><span class="free">A</span></span> <span class="keyword2"><span class="keyword">for</span></span> 
  <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linordered_idom <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span>"</span></span> <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> non_neg_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"non_neg_mat <span class="free">A</span>"</span></span>  
<span class="keyword2"><span class="keyword">begin</span></span> 
<span class="keyword1"><span class="command">lemma</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> non_neg_mat <span class="keyword1"><span class="command">unfolding</span></span> non_neg_mat_def elements_mat_h_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nonneg_matpow<span class="main">:</span> <span class="quoted"><span class="quoted">"matpow <span class="free">A</span> <span class="free">n</span> <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> nonneg<span class="main"><span class="keyword3">,</span></span> 
    <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_nonneg <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matrix_matrix_mult_def mat_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> G_relpow_matpow_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">∈</span> G <span class="main">^^</span> <span class="free">n</span> <span class="main">⟹</span> matpow <span class="free">A</span> <span class="free">n</span> <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>0 <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mat_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> G <span class="main">^^</span> <span class="skolem">n</span> <span class="keyword1">O</span> G"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> relpow_commute<span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    ik<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">$</span> <span class="skolem">k</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> kj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∈</span> G <span class="main">^^</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ik nonneg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ik<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">$</span> <span class="skolem">k</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> kj<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"matpow <span class="free">A</span> <span class="skolem">n</span> <span class="keyword1">$h</span> <span class="skolem">i</span> <span class="keyword1">$h</span> <span class="skolem">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ik <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonneg_matpow nonneg matrix_matrix_mult_def 
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_pos2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main"><span class="main">]</span></span> mult_nonneg_nonneg<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> matpow_mono<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free">B</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">≥</span> <span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matpow <span class="free">B</span> <span class="free">n</span> <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span> <span class="main">≥</span> matpow <span class="free">A</span> <span class="free">n</span> <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> B nonneg_matpow<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> nonneg 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matrix_matrix_mult_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_mono mult_mono'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> matpow_sum_one_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"matpow <span class="main">(</span><span class="free">A</span> <span class="main">+</span> mat <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span> <span class="main">≥</span> matpow <span class="main">(</span><span class="free">A</span> <span class="main">+</span> mat <span class="main">1</span><span class="main">)</span> <span class="free">n</span> <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>matpow <span class="main">(</span><span class="free">A</span> <span class="main">+</span> mat <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">**</span> <span class="free">A</span><span class="main">)</span> <span class="keyword1">$h</span> <span class="free">i</span> <span class="keyword1">$h</span> <span class="free">j</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> matrix_matrix_mult_def
    <span class="keyword1"><span class="command">using</span></span> order.trans<span class="main">[</span><span class="operator">OF</span> nonneg_matpow matpow_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">+</span> mat <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">+</span> <span class="skolem">k</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_nonneg mult_nonneg_nonneg nonneg <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mat_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matrix_add_ldistrib matrix_mul_rid<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> G_relpow_matpow_pos_ge<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">∈</span> G <span class="main">^^</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matpow <span class="main">(</span><span class="free">A</span> <span class="main">+</span> mat <span class="main">1</span><span class="main">)</span> <span class="free">n</span> <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="free">m</span> <span class="main">+</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> le_Suc_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> matpow <span class="free">A</span> <span class="free">m</span> <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> G_relpow_matpow_pos<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> matpow <span class="main">(</span><span class="free">A</span> <span class="main">+</span> mat <span class="main">1</span><span class="main">)</span> <span class="free">m</span> <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> matpow_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> matpow <span class="main">(</span><span class="free">A</span> <span class="main">+</span> mat <span class="main">1</span><span class="main">)</span> <span class="free">n</span> <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> n <span class="keyword1"><span class="command">using</span></span> matpow_sum_one_mono <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> perron_frobenius <span class="main">=</span> pf_nonneg_mat <span class="quoted"><span class="free">A</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span>"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> irr<span class="main">:</span> <span class="quoted">irreducible</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">N</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">N</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">ij</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span> <span class="main">≤</span> <span class="bound">N</span><span class="main">.</span> <span class="bound">ij</span> <span class="main">∈</span> G <span class="main">^^</span> <span class="bound">n</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">n</span></span> <span class="main">≤</span> N<span class="main">.</span> <span class="free">ij</span> <span class="main">∈</span> G <span class="main">^^</span> <span class="bound">n</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ij</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ij</span> <span class="main">∈</span> G<span class="main">^+</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> irr<span class="main">[</span><span class="operator">unfolded</span> irreducible_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> trancl_power<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="skolem">ij</span> <span class="main">∈</span> G <span class="main">^^</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">ij</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">ij</span> <span class="main">∈</span> G <span class="main">^^</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> choice<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">ij</span><span class="main">.</span> <span class="bound">ij</span> <span class="main">∈</span> G <span class="main">^^</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">ij</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> Max <span class="main">(</span>range <span class="skolem">f</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ij</span>
    <span class="keyword1"><span class="command">from</span></span> f<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ij</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ij</span> <span class="main">∈</span> G <span class="main">^^</span> <span class="skolem">f</span> <span class="skolem">ij</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">ij</span> <span class="main">≤</span> <span class="skolem">N</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> N
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Max_ge<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">n</span></span> <span class="main">≤</span> <span class="skolem">N</span><span class="main">.</span> <span class="skolem">ij</span> <span class="main">∈</span> G <span class="main">^^</span> <span class="bound">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> this
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">N</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">ij</span><span class="main">.</span> <span class="main">∃</span> <span class="bound"><span class="bound">n</span></span> <span class="main">≤</span> <span class="bound">N</span><span class="main">.</span> <span class="bound">ij</span> <span class="main">∈</span> G <span class="main">^^</span> <span class="bound">n</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> main <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> someI<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">,</span> <span class="operator">folded</span> N_def<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> irreducible_matpow_pos<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted">irreducible</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matpow <span class="main">(</span><span class="free">A</span> <span class="main">+</span> mat <span class="main">1</span><span class="main">)</span> N <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> N <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> N"</span></span> <span class="keyword2"><span class="keyword">and</span></span> reach<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">∈</span> G <span class="main">^^</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> G_relpow_matpow_pos_ge<span class="main"><span class="main">[</span></span><span class="operator">OF</span> reach n<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pf_transpose<span class="main">:</span> <span class="quoted"><span class="quoted">"perron_frobenius <span class="main">(</span>transpose <span class="free">A</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fixed_mat.irreducible <span class="main">(</span>transpose <span class="free">A</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> fixed_mat.irreducible_def G_transpose_trancl <span class="keyword1"><span class="command">using</span></span> irr<span class="main">[</span><span class="operator">unfolded</span> irreducible_def<span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> nonneg<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> transpose_def non_neg_mat_def elements_mat_h_def<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">le_vec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> real <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">le_vec</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">$</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">lt_vec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> real <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lt_vec</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">$</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">A1n</span> <span class="main">=</span> matpow <span class="main">(</span><span class="free">A</span> <span class="main">+</span> mat <span class="main">1</span><span class="main">)</span> N"</span></span> 

<span class="keyword1"><span class="command">lemmas</span></span> A1n_pos <span class="main">=</span> irreducible_matpow_pos<span class="main">[</span><span class="operator">OF</span> irr<span class="main">,</span> <span class="operator">folded</span> A1n_def<span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">r</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Min <span class="main">{</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">/</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">$</span> <span class="bound">j</span> <span class="main">|</span> <span class="bound">j</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">$</span> <span class="bound">j</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">}</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>real <span class="main">^</span> <span class="tfree">'n</span> <span class="main">)</span>set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">.</span> le_vec <span class="main">0</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">}</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> nonneg_Ax<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> X <span class="main">⟹</span> le_vec <span class="main">0</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> X_def <span class="keyword1"><span class="command">using</span></span> nonneg
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matrix_vector_mult_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_nonneg<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> A_nonzero_fixed_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">j</span><span class="main">.</span> <span class="free">A</span> <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> irr<span class="main">[</span><span class="operator">unfolded</span> irreducible_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">i</span><span class="main">)</span> <span class="main">∈</span> G<span class="main">^+</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> G"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> converse_tranclE<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> Aij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> G_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> A_nonzero_fixed_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span><span class="main">.</span> <span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="free">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> irr<span class="main">[</span><span class="operator">unfolded</span> irreducible_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">j</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">∈</span> G<span class="main">^+</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">∈</span> G"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> Aij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="free">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> G_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Ax_pos<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"lt_vec <span class="main">0</span> <span class="free">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lt_vec <span class="main">0</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">from</span></span> A_nonzero_fixed_i<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> nonneg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> order.strict_iff_order<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> nonneg <span class="main">=</span> mult_nonneg_nonneg<span class="main">[</span><span class="operator">OF</span> nonneg<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="main">]</span></span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">A</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">*</span> <span class="free">x</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_vector_mult_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">A</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">*</span> <span class="free">x</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="skolem">j</span><span class="main">}</span><span class="main">.</span> <span class="free">A</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">*</span> <span class="free">x</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.remove<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">+</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> add_less_le_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A x<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span> nonneg<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_nonneg mult_pos_pos<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
  

<span class="keyword1"><span class="command">lemma</span></span> nonzero_Ax<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> X"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> x<span class="main">[</span><span class="operator">unfolded</span> X_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"le_vec <span class="main">0</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> x<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> xj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> vec_eq_iff zero_index<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> A_nonzero_fixed_j<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span>  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> Aij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> 0<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> matrix_vector_mult_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">k</span> <span class="main">∈</span> UNIV<span class="main">.</span> <span class="free">A</span> <span class="keyword1">$h</span> <span class="skolem">i</span> <span class="keyword1">$h</span> <span class="bound">k</span> <span class="main">*</span> <span class="free">x</span> <span class="keyword1">$h</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">A</span> <span class="keyword1">$h</span> <span class="skolem">i</span> <span class="keyword1">$h</span> <span class="skolem">j</span> <span class="main">*</span> <span class="free">x</span> <span class="keyword1">$h</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">k</span> <span class="main">∈</span> UNIV <span class="main">-</span> <span class="main">{</span><span class="skolem">j</span><span class="main">}</span><span class="main">.</span> <span class="free">A</span> <span class="keyword1">$h</span> <span class="skolem">i</span> <span class="keyword1">$h</span> <span class="bound">k</span> <span class="main">*</span> <span class="free">x</span> <span class="keyword1">$h</span> <span class="bound">k</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.remove<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">+</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> add_less_le_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> nonneg<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="main">]</span></span> Aij x<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> xj<span class="main"><span class="keyword3">,</span></span> 
    <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_nonneg mult_pos_pos <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dual_order.not_eq_order_implies_strict<span class="main">)</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_witness<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> X"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">j</span><span class="main">.</span> <span class="free">x</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> r <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">/</span> <span class="free">x</span> <span class="main">$</span> <span class="bound">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> x<span class="main">[</span><span class="operator">unfolded</span> X_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"le_vec <span class="main">0</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">/</span> <span class="free">x</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">|</span> <span class="bound">j</span><span class="main">.</span> <span class="free">x</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> x<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> vec_eq_iff zero_index<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Min_in<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">,</span> <span class="operator">folded</span> r_def<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rx<span class="main">:</span> <span class="quoted"><span class="quoted">"r <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">/</span> <span class="free">x</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dual_order.not_eq_order_implies_strict<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> rx <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rx_nonneg<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> X"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"r <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> x<span class="main">[</span><span class="operator">unfolded</span> X_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"le_vec <span class="main">0</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">/</span> <span class="free">x</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">|</span> <span class="bound">j</span><span class="main">.</span> <span class="free">x</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> r_witness<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> X›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> r_def X_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> Min_ge_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> empty <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> ballI<span class="main">)</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">/</span> <span class="free">x</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> nonneg_Ax<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> X›</span></span><span class="main">]</span> this x
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rx_pos<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"lt_vec <span class="main">0</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"r <span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> Ax_pos<span class="main">[</span><span class="operator">OF</span> x<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> lt<span class="main">:</span> <span class="quoted"><span class="quoted">"lt_vec <span class="main">0</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> X"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X_def order.strict_iff_order <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">/</span> <span class="free">x</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">|</span> <span class="bound">j</span><span class="main">.</span> <span class="free">x</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> r_witness<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> X›</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> r_def X_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> Min_gr_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">use</span> empty <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> ballI<span class="main">)</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">/</span> <span class="free">x</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> lt this x <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rx_le_Ax<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> X"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"le_vec <span class="main">(</span>r <span class="free">x</span> <span class="keyword1">*s</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>r <span class="free">x</span> <span class="keyword1">*s</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">$h</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">$h</span> <span class="skolem">i</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> nonneg_Ax<span class="main">[</span><span class="operator">OF</span> x<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> x<span class="main">[</span><span class="operator">unfolded</span> X_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dual_order.not_eq_order_implies_strict<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">$h</span> <span class="skolem">i</span> <span class="main">/</span> <span class="free">x</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">/</span> <span class="free">x</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">|</span> <span class="bound">j</span><span class="main">.</span> <span class="free">x</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">$h</span> <span class="skolem">i</span> <span class="main">/</span> <span class="free">x</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">≥</span> r <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">*</span> r <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">$h</span> <span class="skolem">i</span> <span class="main">/</span> <span class="free">x</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mult_le_cancel_left_pos<span class="main">[</span><span class="operator">OF</span> pos<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">$h</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rho_le_x_Ax_imp_rho_le_rx<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> X"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ρ<span class="main">:</span> <span class="quoted"><span class="quoted">"le_vec <span class="main">(</span><span class="free">ρ</span> <span class="keyword1">*s</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">≤</span> r <span class="free">x</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> r_witness<span class="main">[</span><span class="operator">OF</span> x<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    rx<span class="main">:</span> <span class="quoted"><span class="quoted">"r <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">/</span> <span class="free">x</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> divide_right_mono<span class="main">[</span><span class="operator">OF</span> ρ<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span> xj<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> rx <span class="keyword1"><span class="command">using</span></span> xj <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rx_Max<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> X"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"r <span class="free">x</span> <span class="main">=</span> Sup <span class="main">{</span> <span class="bound">ρ</span> <span class="main">.</span> le_vec <span class="main">(</span><span class="bound">ρ</span> <span class="keyword1">*s</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> Sup <span class="var">?S</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"r <span class="free">x</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rx_le_Ax<span class="main">[</span><span class="operator">OF</span> x<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"le_vec <span class="main">(</span><span class="skolem">y</span> <span class="keyword1">*s</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> rho_le_x_Ax_imp_rho_le_rx<span class="main">[</span><span class="operator">OF</span> x this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> r <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> 
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> cSup_eq_maximum<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_smult<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> X"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"r <span class="main">(</span><span class="free">a</span> <span class="keyword1">*s</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> r <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> r_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">Min</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> vector_smult_distrib<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> a<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">X1</span> <span class="main">=</span> <span class="main">(</span>X <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> norm <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> bounded_X1<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded X1"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> bounded_iff X1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> closed_X1<span class="main">:</span> <span class="quoted"><span class="quoted">"closed X1"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> X1<span class="main">:</span> <span class="quoted"><span class="quoted">"X1 <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> le_vec <span class="main">0</span> <span class="bound">x</span> <span class="main">∧</span> norm <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> X1_def X_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> X1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> closed_Collect_conj closed_Collect_all  closed_Collect_le closed_Collect_eq<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> compact_X1<span class="main">:</span> <span class="quoted"><span class="quoted">"compact X1"</span></span> <span class="keyword1"><span class="command">using</span></span> bounded_X1 closed_X1
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> compact_eq_bounded_closed<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pow_A_1</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> A1n <span class="keyword1">*v</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> 



<span class="keyword1"><span class="command">lemma</span></span> continuous_pow_A_1<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="free">R</span> pow_A_1"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pow_A_1_def continuous_on
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">tendsto_intros</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> pow_A_1 <span class="main">`</span> X1"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> compact_Y<span class="main">:</span> <span class="quoted"><span class="quoted">"compact Y"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> Y_def <span class="keyword1"><span class="command">using</span></span> compact_X1 continuous_pow_A_1<span class="main">[</span><span class="operator">of</span> <span class="quoted">X1</span><span class="main">]</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> compact_continuous_image<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Y_pos_main<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> pow_A_1 <span class="main">`</span> X"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">$</span> <span class="free">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> y <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> X"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> pow_A_1 <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Y_def X1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> r_witness<span class="main">[</span><span class="operator">OF</span> x<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> xj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> x<span class="main">[</span><span class="operator">unfolded</span> X_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> xi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> A1n <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="skolem">k</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">$</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="keyword1"><span class="command">using</span></span> A1n_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> xi<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span>UNIV<span class="main">.</span> A1n <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> y pow_A_1_def matrix_vector_mult_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> A1n <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="skolem">j</span><span class="main">}</span><span class="main">.</span> A1n <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.remove<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">+</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> add_less_le_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> xj A1n_pos nonneg<span class="main"><span class="keyword3">,</span></span> 
    <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_nonneg mult_pos_pos <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dual_order.not_eq_order_implies_strict<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Y_pos<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> Y"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">$</span> <span class="free">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> Y_pos_main<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> y <span class="keyword1"><span class="command">unfolding</span></span> Y_def X1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Y_nonzero<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> Y"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">$</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> Y_pos<span class="main">[</span><span class="operator">OF</span> y<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">r'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r'</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Min <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">/</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> r'_r<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Y"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"r' <span class="free">x</span> <span class="main">=</span> r <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> r'_def r_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">Min</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">/</span> <span class="free">x</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">/</span> <span class="free">x</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">|</span><span class="bound">j</span><span class="main">.</span> <span class="free">x</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊆</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">/</span> <span class="free">x</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Y_pos<span class="main">[</span><span class="operator">OF</span> x<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊇</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> continuous_Y_r<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on Y r"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> Y<span class="main">.</span> <span class="skolem">P</span> <span class="bound">y</span> <span class="main">(</span>r <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> Y<span class="main">.</span> <span class="skolem">P</span> <span class="bound">y</span> <span class="main">(</span>r' <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">P</span> <span class="keyword1"><span class="command">using</span></span> r'_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"continuous_on Y r <span class="main">=</span> continuous_on Y r'"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> continuous_on_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl r'_r<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="main">…</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> continuous_on r'_def <span class="keyword1"><span class="command">using</span></span> Y_nonzero
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> tendsto_Min <span class="dynamic"><span class="dynamic">tendsto_intros</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1"><span class="command">lemma</span></span> X1_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"X1 <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> undefined <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">::</span> real <span class="main">^</span> <span class="tfree">'n</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">$</span> undefined"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> x_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_vec <span class="main">0</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> x_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> norm_vec_def L2_set_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sum.remove<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted">undefined</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> x_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> X1_def X_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Y_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"Y <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> Y_def <span class="keyword1"><span class="command">using</span></span> X1_nonempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">z</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> Y <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> Y<span class="main">.</span> r <span class="bound">y</span> <span class="main">≤</span> r <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">sr</span> <span class="main">≡</span> r z"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"z <span class="main">∈</span> Y"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sr_max_Y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> Y <span class="main">⟹</span> r <span class="bound">y</span> <span class="main">≤</span> sr"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> Y <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">y</span> <span class="main">∈</span> Y<span class="main">.</span> r <span class="bound">y</span> <span class="main">≤</span> r <span class="bound">z</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> continuous_attains_sup<span class="main">[</span><span class="operator">OF</span> compact_Y Y_nonempty continuous_Y_r<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> someI<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">,</span> <span class="operator">folded</span> z_def<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"z <span class="main">∈</span> Y"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> Y <span class="main">⟹</span> r <span class="bound">y</span> <span class="main">≤</span> r z"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Y_subset_X<span class="main">:</span> <span class="quoted"><span class="quoted">"Y <span class="main">⊆</span> X"</span></span> 
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> Y"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> Y_pos<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> X"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> order.strict_iff_order<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zX<span class="main">:</span> <span class="quoted"><span class="quoted">"z <span class="main">∈</span> X"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> z<span class="main">(</span>1<span class="main">)</span> Y_subset_X <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> le_vec_mono_left<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free">B</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"le_vec <span class="free">x</span> <span class="free">y</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"le_vec <span class="main">(</span><span class="free">B</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="keyword1">*v</span> <span class="free">y</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="main">(</span><span class="free">B</span> <span class="keyword1">*v</span> <span class="free">y</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> matrix_vector_mult_def <span class="keyword1"><span class="command">using</span></span> B<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_mono mult_left_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>  


<span class="keyword1"><span class="command">lemma</span></span> matpow_1_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"matpow <span class="main">(</span><span class="free">A</span> <span class="main">+</span> mat <span class="main">1</span><span class="main">)</span> <span class="free">n</span> <span class="main">**</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span> <span class="main">**</span> matpow <span class="main">(</span><span class="free">A</span> <span class="main">+</span> mat <span class="main">1</span><span class="main">)</span> <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matrix_add_rdistrib matrix_add_ldistrib matrix_mul_rid matrix_mul_lid
  matrix_mul_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> A1n_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"A1n <span class="main">**</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span> <span class="main">**</span> A1n"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> A1n_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> matpow_1_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> le_vec_pow_A_1<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"le_vec <span class="main">(</span><span class="free">rho</span> <span class="keyword1">*s</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"le_vec <span class="main">(</span><span class="free">rho</span> <span class="keyword1">*s</span> pow_A_1 <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> pow_A_1 <span class="free">x</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"A1n <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="keyword1"><span class="command">using</span></span> A1n_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> le_vec_mono_left<span class="main">[</span><span class="operator">OF</span> this le<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_vec <span class="main">(</span>A1n <span class="keyword1">*v</span> <span class="main">(</span><span class="free">rho</span> <span class="keyword1">*s</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>A1n <span class="keyword1">*v</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"A1n <span class="keyword1">*v</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>A1n <span class="main">**</span> <span class="free">A</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matrix_vector_mul_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="main">(</span>A1n <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A1n_commute <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matrix_vector_mul_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="main">(</span>pow_A_1 <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pow_A_1_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"A1n <span class="keyword1">*v</span> <span class="main">(</span><span class="free">rho</span> <span class="keyword1">*s</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">rho</span> <span class="keyword1">*s</span> <span class="main">(</span>A1n <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> vector_smult_distrib <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">rho</span> <span class="keyword1">*s</span> pow_A_1 <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pow_A_1_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le_vec <span class="main">(</span><span class="free">rho</span> <span class="keyword1">*s</span> pow_A_1 <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> pow_A_1 <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_pow_A_1<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> X"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"r <span class="free">x</span> <span class="main">≤</span> r <span class="main">(</span>pow_A_1 <span class="free">x</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"pow_A_1 <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">∈</span> pow_A_1 <span class="main">`</span> X"</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Y_pos_main<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">∈</span> X"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> order.strict_iff_order<span class="main">)</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">ρ</span><span class="main">.</span> le_vec <span class="main">(</span><span class="bound">ρ</span> <span class="keyword1">*s</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">ρ</span><span class="main">.</span> le_vec <span class="main">(</span><span class="bound">ρ</span> <span class="keyword1">*s</span> pow_A_1 <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> pow_A_1 <span class="free">x</span><span class="main">)</span><span class="main">}</span>"</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> rx_Max<span class="main">[</span><span class="operator">OF</span> x<span class="main">]</span> rx_Max<span class="main">[</span><span class="operator">OF</span> y<span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> cSup_mono<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bdd_above <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rho_le_x_Ax_imp_rho_le_rx<span class="main">[</span><span class="operator">OF</span> y<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rx_le_Ax<span class="main">[</span><span class="operator">OF</span> x<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">rho</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rho</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"le_vec <span class="main">(</span><span class="skolem">rho</span> <span class="keyword1">*s</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> le_vec_pow_A_1<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rho</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">rho'</span> <span class="main">∈</span> <span class="var">?B</span><span class="main">.</span> <span class="skolem">rho</span> <span class="main">≤</span> <span class="bound">rho'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sr_max<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> X"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"r <span class="free">x</span> <span class="main">≤</span> sr"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"norm <span class="free">x</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> inverse <span class="var">?n</span> <span class="keyword1">*s</span> <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> x<span class="main">[</span><span class="operator">unfolded</span> X_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> x0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> X1"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> X"</span></span> <span class="keyword1"><span class="command">using</span></span> x n <span class="keyword1"><span class="command">unfolding</span></span> X1_def X_def x'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_smult<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"r <span class="free">x</span> <span class="main">=</span> r <span class="skolem">x'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> x'_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> r_smult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> x<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> n<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> pow_A_1 <span class="skolem">x'</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> x' <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> Y"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Y_def y_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> id
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"r <span class="skolem">x'</span> <span class="main">≤</span> r <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r_pow_A_1<span class="main">[</span><span class="operator">OF</span> x'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> y_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> r z"</span></span> <span class="keyword1"><span class="command">using</span></span> sr_max_Y<span class="main">[</span><span class="operator">OF</span> y<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"r <span class="free">x</span> <span class="main">≤</span> r z"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> z_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"z <span class="main">$</span> <span class="free">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> Y_pos<span class="main">[</span><span class="operator">OF</span> z<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sr_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"sr <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rx_pos<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> z_pos<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">u</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> X"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ru<span class="main">:</span> <span class="quoted"><span class="quoted">"r <span class="free">u</span> <span class="main">=</span> sr"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sr_imp_eigen_vector_main<span class="main">:</span> <span class="quoted"><span class="quoted">"sr <span class="keyword1">*s</span> <span class="free">u</span> <span class="main">=</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">u</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"sr <span class="keyword1">*s</span> <span class="free">u</span> <span class="main">≠</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">u</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> <span class="free">u</span> <span class="main">-</span> sr <span class="keyword1">*s</span> <span class="free">u</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"pow_A_1 <span class="free">u</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_vec <span class="main">(</span>sr <span class="keyword1">*s</span> <span class="free">u</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rx_le_Ax<span class="main">[</span><span class="operator">OF</span> u<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ru <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"le_vec <span class="main">0</span> <span class="var">?x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 0 le <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">∈</span> X"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> y_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"lt_vec <span class="main">0</span> <span class="var">?y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Y_pos_main<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span><span class="main">]</span> u <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">∈</span> X"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> order.strict_iff_order<span class="main">)</span>  
  <span class="keyword1"><span class="command">from</span></span> Y_pos_main<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"pow_A_1 <span class="var">?x</span>"</span></span><span class="main">]</span> x 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lt_vec <span class="main">0</span> <span class="main">(</span>pow_A_1 <span class="var">?x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> lt<span class="main">:</span> <span class="quoted"><span class="quoted">"lt_vec <span class="main">(</span>sr <span class="keyword1">*s</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="var">?y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pow_A_1_def matrix_vector_right_distrib_diff
    matrix_vector_mul_assoc A1n_commute vector_smult_distrib <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="var">?y</span> <span class="main">-</span> sr <span class="keyword1">*s</span> <span class="var">?y</span><span class="main">)</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">/</span> <span class="var">?y</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?U</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"UNIV <span class="main">::</span> <span class="tfree">'n</span> set"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">eps</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">eps</span> <span class="main">=</span> Min <span class="main">(</span><span class="var">?f</span> <span class="main">`</span> <span class="var">?U</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?f</span> <span class="main">`</span> <span class="var">?U</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">`</span> <span class="var">?U</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> eps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">eps</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eps_def Min_gr_iff<span class="main">[</span><span class="operator">OF</span> U<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> lt sr_pos y_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"le_vec <span class="main">(</span><span class="main">(</span>sr <span class="main">+</span> <span class="skolem">eps</span><span class="main">)</span> <span class="keyword1">*s</span> <span class="var">?y</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="var">?y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>sr <span class="main">+</span> <span class="skolem">eps</span><span class="main">)</span> <span class="keyword1">*s</span> <span class="var">?y</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">=</span> sr <span class="main">*</span> <span class="var">?y</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">+</span> <span class="skolem">eps</span> <span class="main">*</span> <span class="var">?y</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comm_semiring_class.distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> sr <span class="main">*</span> <span class="var">?y</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">+</span> <span class="var">?f</span> <span class="skolem">i</span> <span class="main">*</span> <span class="var">?y</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> add_left_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mult_right_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="var">?y</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> y_pos<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">eps</span> <span class="main">≤</span> <span class="var">?f</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eps_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Min_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="var">?y</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sr_pos y_pos<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span>  
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>sr <span class="main">+</span> <span class="skolem">eps</span><span class="main">)</span> <span class="keyword1">*s</span> <span class="var">?y</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="var">?y</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> rho_le_x_Ax_imp_rho_le_rx<span class="main">[</span><span class="operator">OF</span> y le<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"r <span class="var">?y</span> <span class="main">≥</span> sr <span class="main">+</span> <span class="skolem">eps</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> sr_max<span class="main">[</span><span class="operator">OF</span> y<span class="main">]</span> eps <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sr_imp_eigen_vector<span class="main">:</span> <span class="quoted"><span class="quoted">"eigen_vector <span class="free">A</span> <span class="free">u</span> sr"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> eigen_vector_def sr_imp_eigen_vector_main <span class="keyword1"><span class="command">using</span></span> u <span class="keyword1"><span class="command">unfolding</span></span> X_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sr_u_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"lt_vec <span class="main">0</span> <span class="free">u</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"pow_A_1 <span class="free">u</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> N"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span>sr <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">^</span>N"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sr_pos <span class="keyword1"><span class="command">unfolding</span></span> c_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lt_vec <span class="main">0</span> <span class="var">?y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Y_pos_main<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span><span class="main">]</span> u <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">=</span> A1n <span class="keyword1">*v</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pow_A_1_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">c</span> <span class="keyword1">*s</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> c_def A1n_def n_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matrix_vector_mul_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> vec.scale
          sr_imp_eigen_vector_main<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> lt<span class="main">:</span> <span class="quoted"><span class="quoted">"lt_vec <span class="main">0</span> <span class="main">(</span><span class="skolem">c</span> <span class="keyword1">*s</span> <span class="free">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">u</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">using</span></span> lt<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> c <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> zero_less_mult_pos<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"lt_vec <span class="main">0</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eigen_vector_z_sr<span class="main">:</span> <span class="quoted"><span class="quoted">"eigen_vector <span class="free">A</span> z sr"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> sr_imp_eigen_vector<span class="main">[</span><span class="operator">OF</span> zX refl<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eigen_value_sr<span class="main">:</span> <span class="quoted"><span class="quoted">"eigen_value <span class="free">A</span> sr"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> eigen_vector_z_sr <span class="keyword1"><span class="command">unfolding</span></span> eigen_value_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≡</span> complex_of_real"</span></span> 
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">cA</span> <span class="main">≡</span> map_matrix c <span class="free">A</span>"</span></span> 
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">norm_v</span> <span class="main">≡</span> map_vector <span class="main">(</span>norm <span class="main">::</span> complex <span class="main">⇒</span> real<span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> norm_v_ge_0<span class="main">:</span> <span class="quoted"><span class="quoted">"le_vec <span class="main">0</span> <span class="main">(</span>norm_v <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_vector_def<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> norm_v_eq_0<span class="main">:</span> <span class="quoted"><span class="quoted">"norm_v <span class="free">v</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">v</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_vector_def vec_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cA_index<span class="main">:</span> <span class="quoted"><span class="quoted">"cA <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span> <span class="main">=</span> c <span class="main">(</span><span class="free">A</span> <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> map_matrix_def map_vector_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> norm_cA<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>cA <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">$</span> <span class="free">i</span> <span class="main">$</span> <span class="free">j</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> nonneg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cA_index<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">α</span> <span class="free">v</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"eigen_vector cA <span class="free">v</span> <span class="free">α</span>"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> evD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="keyword1">*s</span> <span class="free">v</span> <span class="main">=</span> cA <span class="keyword1">*v</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> ev<span class="main">[</span><span class="operator">unfolded</span> eigen_vector_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ev_alpha_norm_v<span class="main">:</span> <span class="quoted"><span class="quoted">"norm_v <span class="main">(</span><span class="free">α</span> <span class="keyword1">*s</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>norm <span class="free">α</span> <span class="keyword1">*s</span> norm_v <span class="free">v</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_vector_def norm_mult vec_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ev_A_norm_v<span class="main">:</span> <span class="quoted"><span class="quoted">"norm_v <span class="main">(</span>cA <span class="keyword1">*v</span> <span class="free">v</span><span class="main">)</span> <span class="main">$</span> <span class="free">j</span> <span class="main">≤</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> norm_v <span class="free">v</span><span class="main">)</span> <span class="main">$</span> <span class="free">j</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm_v <span class="main">(</span>cA <span class="keyword1">*v</span> <span class="free">v</span><span class="main">)</span> <span class="main">$</span> <span class="free">j</span> <span class="main">=</span> norm <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> cA <span class="main">$</span> <span class="free">j</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">v</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> map_vector_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matrix_vector_mult_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> norm <span class="main">(</span>cA <span class="main">$</span> <span class="free">j</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">v</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> norm_sum<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">A</span> <span class="main">$</span> <span class="free">j</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">*</span> norm_v <span class="free">v</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_mult map_vector_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> norm_v <span class="free">v</span><span class="main">)</span> <span class="main">$</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matrix_vector_mult_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ev_le_vec<span class="main">:</span> <span class="quoted"><span class="quoted">"le_vec <span class="main">(</span>norm <span class="free">α</span> <span class="keyword1">*s</span> norm_v <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> norm_v <span class="free">v</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> evD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">norm_v</span><span class="main">,</span> <span class="operator">unfolded</span> ev_alpha_norm_v<span class="main">]</span> ev_A_norm_v <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> norm_v_X<span class="main">:</span> <span class="quoted"><span class="quoted">"norm_v <span class="free">v</span> <span class="main">∈</span> X"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> norm_v_ge_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span> evD<span class="main">(</span>2<span class="main">)</span> norm_v_eq_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> X_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ev_inequalities<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="free">α</span> <span class="main">≤</span> r <span class="main">(</span>norm_v <span class="free">v</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"r <span class="main">(</span>norm_v <span class="free">v</span><span class="main">)</span> <span class="main">≤</span> sr"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"norm_v <span class="free">v</span> <span class="main">∈</span> X"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> norm_v_X<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> rho_le_x_Ax_imp_rho_le_rx<span class="main">[</span><span class="operator">OF</span> v ev_le_vec<span class="main">]</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"norm <span class="free">α</span> <span class="main">≤</span> r <span class="main">(</span>norm_v <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> sr_max<span class="main">[</span><span class="operator">OF</span> v<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"r <span class="main">(</span>norm_v <span class="free">v</span><span class="main">)</span> <span class="main">≤</span> sr"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eigen_vector_norm_sr<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="free">α</span> <span class="main">≤</span> sr"</span></span> <span class="keyword1"><span class="command">using</span></span> ev_inequalities <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eigen_value_norm_sr<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eigen_value cA <span class="free">α</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"norm <span class="free">α</span> <span class="main">≤</span> sr"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> eigen_vector_norm_sr<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">α</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">unfolding</span></span> eigen_value_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> le_vec_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"le_vec <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> le_vec <span class="free">y</span> <span class="free">u</span> <span class="main">⟹</span> le_vec <span class="free">x</span> <span class="free">u</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> order.trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">i</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eigen_vector_z_sr_c<span class="main">:</span> <span class="quoted"><span class="quoted">"eigen_vector cA <span class="main">(</span>map_vector c z<span class="main">)</span> <span class="main">(</span>c sr<span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> of_real_hom.eigen_vector_hom <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eigen_vector_z_sr<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eigen_value_sr_c<span class="main">:</span> <span class="quoted"><span class="quoted">"eigen_value cA <span class="main">(</span>c sr<span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> eigen_vector_z_sr_c <span class="keyword1"><span class="command">unfolding</span></span> eigen_value_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> perron_frobenius.z <span class="main">(</span>transpose <span class="free">A</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"transpose <span class="free">A</span> <span class="keyword1">*v</span> w <span class="main">=</span> sr <span class="keyword1">*s</span> w"</span></span> <span class="quoted"><span class="quoted">"lt_vec <span class="main">0</span> w"</span></span> <span class="quoted"><span class="quoted">"perron_frobenius.sr <span class="main">(</span>transpose <span class="free">A</span><span class="main">)</span> <span class="main">=</span> sr"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> t<span class="main">:</span> perron_frobenius <span class="quoted"><span class="quoted">"transpose <span class="free">A</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pf_transpose<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> eigen_vector_z_sr_c t.eigen_vector_z_sr_c 
  <span class="keyword1"><span class="command">have</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"eigen_value cA <span class="main">(</span>c sr<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"eigen_value t.cA <span class="main">(</span>c t.sr<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> eigen_value_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eigen_value <span class="main">(</span>t.cA<span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> eigen_value <span class="main">(</span>transpose cA<span class="main">)</span> <span class="skolem">x</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> map_matrix_def map_vector_def transpose_def 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> eigen_value cA <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eigen_value_transpose<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eigen_value <span class="main">(</span>t.cA<span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> eigen_value cA <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> ev_id <span class="main">=</span> this
  <span class="keyword1"><span class="command">with</span></span> ev <span class="keyword1"><span class="command">have</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"eigen_value t.cA <span class="main">(</span>c sr<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"eigen_value cA <span class="main">(</span>c t.sr<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> eigen_value_norm_sr<span class="main">[</span><span class="operator">OF</span> ev<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> t.eigen_value_norm_sr<span class="main">[</span><span class="operator">OF</span> ev<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> 
  <span class="keyword3"><span class="command">show</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"t.sr <span class="main">=</span> sr"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> t.eigen_vector_z_sr<span class="main">[</span><span class="operator">unfolded</span> id<span class="main">,</span> <span class="operator">folded</span> w_def<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"transpose <span class="free">A</span> <span class="keyword1">*v</span> w <span class="main">=</span> sr <span class="keyword1">*s</span> w"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> eigen_vector_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> t.z_pos<span class="main">[</span><span class="operator">folded</span> w_def<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lt_vec <span class="main">0</span> w"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> c_cmod_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">ℝ</span> <span class="main">⟹</span> Re <span class="free">a</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> c <span class="main">(</span>cmod <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Reals_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pos_rowvector_mult_0<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> lt<span class="main">:</span> <span class="quoted"><span class="quoted">"lt_vec <span class="main">0</span> <span class="free">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rowvector <span class="free">x</span> <span class="main">::</span> real <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="keyword1">*v</span> <span class="main">_</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"le_vec <span class="main">0</span> <span class="free">y</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">with</span></span> le <span class="keyword1"><span class="command">have</span></span> yi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> order.strict_iff_order<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="var">?x</span> <span class="keyword1">*v</span> <span class="free">y</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">x</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">*</span> <span class="free">y</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> rowvector_def matrix_vector_mult_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> yi lt le<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult_nonneg_nonneg 
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> order.strict_iff_order<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pos_matrix_mult_0<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free">B</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> lt<span class="main">:</span> <span class="quoted"><span class="quoted">"lt_vec <span class="main">0</span> <span class="free">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="keyword1">*v</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">with</span></span> le <span class="keyword1"><span class="command">have</span></span> gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> order.strict_iff_order<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span> <span class="keyword1">*v</span> <span class="free">x</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">B</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">*</span> <span class="free">x</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> matrix_vector_mult_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> gt lt le<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult_nonneg_nonneg 
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> order.strict_iff_order<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> vec_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eigen_value_smaller_matrix<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">B</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">∧</span> <span class="free">B</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> AB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="free">B</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"eigen_value <span class="main">(</span>map_matrix c <span class="free">B</span><span class="main">)</span> <span class="free">sigma</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cmod <span class="free">sigma</span> <span class="main">&lt;</span> sr"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>  
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_matrix c <span class="free">B</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"spectral_radius <span class="var">?B</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">=</span> <span class="var">?sr</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real_non_neg_mat <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> real_non_neg_mat_def elements_mat_h_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_matrix_def map_vector_def B<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> perron_frobenius<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">folded</span> σ_def<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> ev_sr<span class="main">:</span> <span class="quoted"><span class="quoted">"eigen_vector <span class="var">?B</span> <span class="skolem">x</span> <span class="main">(</span>c <span class="skolem">σ</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> rnn<span class="main">:</span> <span class="quoted"><span class="quoted">"real_non_neg_vec <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> norm_v <span class="skolem">x</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> rnn <span class="keyword1"><span class="command">have</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> map_vector c <span class="skolem">y</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> real_non_neg_vec_def vec_elements_h_def y_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_vector_def vec_eq_iff c_cmod_id<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> spectral_radius_max<span class="main">[</span><span class="operator">OF</span> ev<span class="main">,</span> <span class="operator">folded</span> σ_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> sigma_sigma<span class="main">:</span> <span class="quoted"><span class="quoted">"cmod <span class="free">sigma</span> <span class="main">≤</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> ev_sr<span class="main">[</span><span class="operator">unfolded</span> xy of_real_hom.eigen_vector_hom<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> ev_B<span class="main">:</span> <span class="quoted"><span class="quoted">"eigen_vector <span class="free">B</span> <span class="skolem">y</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> ev_B<span class="main">[</span><span class="operator">unfolded</span> eigen_vector_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ev_B'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="keyword1">*v</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="keyword1">*s</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ypos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">unfolding</span></span> y_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_vector_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ev_B this <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> X"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eigen_vector_def X_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">have</span></span> BA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span> <span class="keyword1">*v</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_vector_mult_def vec_lambda_beta
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> mult_right_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> B ypos<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>  
  <span class="keyword1"><span class="command">hence</span></span> le_vec<span class="main">:</span> <span class="quoted"><span class="quoted">"le_vec <span class="main">(</span><span class="skolem">σ</span> <span class="keyword1">*s</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ev_B' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> rho_le_x_Ax_imp_rho_le_rx<span class="main">[</span><span class="operator">OF</span> y le_vec<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">≤</span> r <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> sr"</span></span> <span class="keyword1"><span class="command">using</span></span> y <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sr_max<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> sig_le_sr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">≤</span> sr"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">=</span> sr"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> r_sr<span class="main">:</span> <span class="quoted"><span class="quoted">"r <span class="skolem">y</span> <span class="main">=</span> sr"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sr_sig<span class="main">:</span> <span class="quoted"><span class="quoted">"sr <span class="main">=</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">σ</span> <span class="main">≤</span> r <span class="skolem">y</span>›</span></span> <span class="quoted"><span class="quoted">‹r <span class="skolem">y</span> <span class="main">≤</span> sr›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> sr_u_pos<span class="main">[</span><span class="operator">OF</span> y r_sr<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"lt_vec <span class="main">0</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> sr_imp_eigen_vector<span class="main">[</span><span class="operator">OF</span> y r_sr<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ev'<span class="main">:</span> <span class="quoted"><span class="quoted">"eigen_vector <span class="free">A</span> <span class="skolem">y</span> sr"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="skolem">y</span> <span class="main">=</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="skolem">y</span> <span class="main">-</span> <span class="free">B</span> <span class="keyword1">*v</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> matrix_vector_mult_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_eq_iff <span class="dynamic"><span class="dynamic">field_simps</span></span> sum_subtractf<span class="main">)</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> <span class="skolem">y</span> <span class="main">=</span> sr <span class="keyword1">*s</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ev'<span class="main">[</span><span class="operator">unfolded</span> eigen_vector_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="keyword1">*v</span> <span class="skolem">y</span> <span class="main">=</span> sr <span class="keyword1">*s</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ev_B' sr_sig <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> pos_matrix_mult_0<span class="main">[</span><span class="operator">OF</span> _ pos id<span class="main">]</span> assms<span class="main">(</span>1-2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> sig_le_sr sigma_sigma <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> charpoly_erase_mat_sr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> poly <span class="main">(</span>charpoly <span class="main">(</span>erase_mat <span class="free">A</span> <span class="free">i</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> sr"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"erase_mat <span class="free">A</span> <span class="free">i</span> <span class="free">i</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pos</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>charpoly <span class="var">?A</span><span class="main">)</span> sr"</span></span> 
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> A_nonzero_fixed_j<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">$</span> <span class="skolem">k</span> <span class="main">$</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="var">?A</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">$</span> <span class="skolem">k</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> <span class="var">?A</span> <span class="main">$</span> <span class="skolem">k</span> <span class="main">$</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">$</span> <span class="skolem">k</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> erase_mat_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">$</span> <span class="skolem">k</span> <span class="main">$</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> AA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="var">?A</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">∧</span> <span class="var">?A</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">≤</span> <span class="free">A</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> erase_mat_def nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ev_small <span class="main">=</span> eigen_value_smaller_matrix<span class="main">[</span><span class="operator">OF</span> le AA<span class="main">]</span>  
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">rho</span> <span class="main">::</span> <span class="quoted">real</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"eigen_value <span class="var">?A</span> <span class="skolem">rho</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"eigen_value <span class="main">(</span>map_matrix c <span class="var">?A</span><span class="main">)</span> <span class="main">(</span>c <span class="skolem">rho</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> eigen_value_def <span class="keyword1"><span class="command">using</span></span> of_real_hom.eigen_vector_hom<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">rho</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> ev_small<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs <span class="skolem">rho</span> <span class="main">&lt;</span> sr"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> ev_small_real <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> pos0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?pos</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> ev_small_real<span class="main">[</span><span class="operator">of</span> <span class="quoted">sr</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eigen_value_root_charpoly<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> charpoly <span class="var">?A</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?pos</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> neg<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">p</span> sr <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> degree_monic_charpoly<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> mon<span class="main">:</span> <span class="quoted"><span class="quoted">"monic <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="skolem">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"poly <span class="skolem">p</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> cont<span class="main">:</span> <span class="quoted"><span class="quoted">"continuous_on <span class="main">{</span><span class="skolem">a</span><span class="main">..</span><span class="skolem">b</span><span class="main">}</span> <span class="var">?f</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">continuous_intros</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> pos <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> sr <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> mon <span class="keyword1"><span class="command">have</span></span> lc<span class="main">:</span> <span class="quoted"><span class="quoted">"lead_coeff <span class="skolem">p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> poly_pinfty_ge<span class="main">[</span><span class="operator">OF</span> this deg<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> lez<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="skolem">z</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="var">?f</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> max <span class="skolem">z</span> sr"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> yr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≥</span> sr"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≥</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> y_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> lez<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> y0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">y</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> IVT'<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span><span class="main">,</span> <span class="operator">OF</span> le y0 yr cont<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> sr"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> p_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eigen_value <span class="var">?A</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eigen_value_root_charpoly<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> ev_small_real<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> ge <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> pos0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> multiplicity_sr_1<span class="main">:</span> <span class="quoted"><span class="quoted">"order sr <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>pderiv <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span><span class="main">)</span> sr <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> poly <span class="main">(</span>monom <span class="main">1</span> <span class="main">1</span> <span class="main">*</span> pderiv <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span><span class="main">)</span> sr"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> poly <span class="main">(</span>charpoly <span class="main">(</span>erase_mat <span class="free">A</span> <span class="bound">i</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> sr<span class="main">)</span> UNIV"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> pderiv_char_poly_erase_mat poly_sum <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> charpoly_erase_mat_sr<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span> 
  <span class="keyword1"><span class="command">hence</span></span> nZ<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>pderiv <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span><span class="main">)</span> sr <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nZ'<span class="main">:</span> <span class="quoted"><span class="quoted">"pderiv <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> eigen_vector_z_sr <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eigen_value <span class="free">A</span> sr"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eigen_value_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> eigen_value_root_charpoly<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span> sr <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"order sr <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> order_root <span class="keyword1"><span class="command">using</span></span> nZ' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> order_pderiv<span class="main">[</span><span class="operator">OF</span> nZ' this<span class="main">]</span> order_0I<span class="main">[</span><span class="operator">OF</span> nZ<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sr_spectral_radius<span class="main">:</span> <span class="quoted"><span class="quoted">"sr <span class="main">=</span> spectral_radius cA"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> eigen_vector_z_sr_c <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eigen_value cA <span class="main">(</span>c sr<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> eigen_value_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> spectral_radius_max<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> sr<span class="main">:</span> <span class="quoted"><span class="quoted">"sr <span class="main">≤</span> spectral_radius cA"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> spectral_radius_ev<span class="main">[</span><span class="operator">of</span> <span class="quoted">cA</span><span class="main">]</span> eigen_vector_norm_sr
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> le_vec_A_mu<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> X"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"le_vec <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="free">mu</span> <span class="keyword1">*s</span> <span class="free">y</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sr <span class="main">≤</span> <span class="free">mu</span>"</span></span> <span class="quoted"><span class="quoted">"lt_vec <span class="main">0</span> <span class="free">y</span>"</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">=</span> sr <span class="main">∨</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">y</span> <span class="main">=</span> <span class="free">mu</span> <span class="keyword1">*s</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">mu</span> <span class="main">=</span> sr <span class="main">∧</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">y</span> <span class="main">=</span> <span class="free">mu</span> <span class="keyword1">*s</span> <span class="free">y</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?w</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rowvector w"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?w'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"columnvector w"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?w</span> <span class="main">**</span> <span class="free">A</span> <span class="main">=</span> transpose <span class="main">(</span>transpose <span class="main">(</span><span class="var">?w</span> <span class="main">**</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> transpose_transpose <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"transpose <span class="main">(</span><span class="var">?w</span> <span class="main">**</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> transpose <span class="free">A</span> <span class="main">**</span> transpose <span class="var">?w</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> matrix_transpose_mul<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"transpose <span class="var">?w</span> <span class="main">=</span> columnvector w"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> transpose_rowvector<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"transpose <span class="free">A</span> <span class="main">**</span> <span class="main">…</span> <span class="main">=</span> columnvector <span class="main">(</span>transpose <span class="free">A</span> <span class="keyword1">*v</span> w<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> dot_rowvector_columnvector<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"transpose <span class="free">A</span> <span class="keyword1">*v</span> w <span class="main">=</span> sr <span class="keyword1">*s</span> w"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> w <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"transpose <span class="main">(</span>columnvector <span class="main">…</span><span class="main">)</span> <span class="main">=</span> rowvector <span class="main">(</span>sr <span class="keyword1">*s</span> w<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> transpose_def columnvector_def rowvector_def vector_scalar_mult_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?w</span> <span class="main">**</span> <span class="free">A</span> <span class="main">=</span> rowvector <span class="main">(</span>sr <span class="keyword1">*s</span> w<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sr <span class="keyword1">*s</span> <span class="main">(</span><span class="var">?w</span> <span class="keyword1">*v</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="var">?w</span> <span class="main">**</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rowvector_def vector_scalar_mult_def matrix_vector_mult_def vec_eq_iff
       sum_distrib_left mult.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?w</span> <span class="keyword1">*v</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matrix_vector_mul_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"sr <span class="keyword1">*s</span> <span class="main">(</span>rowvector w <span class="keyword1">*v</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> rowvector w <span class="keyword1">*v</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_vec <span class="main">(</span>rowvector w <span class="keyword1">*v</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?w</span> <span class="keyword1">*v</span> <span class="main">(</span><span class="free">mu</span> <span class="keyword1">*s</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> le_vec_mono_left<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ le<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> w<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rowvector_def order.strict_iff_order<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?w</span> <span class="keyword1">*v</span> <span class="main">(</span><span class="free">mu</span> <span class="keyword1">*s</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">mu</span> <span class="keyword1">*s</span> <span class="main">(</span><span class="var">?w</span> <span class="keyword1">*v</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> vec.scale<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> le1<span class="main">:</span> <span class="quoted"><span class="quoted">"le_vec <span class="main">(</span>rowvector w <span class="keyword1">*v</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">mu</span> <span class="keyword1">*s</span> <span class="main">(</span><span class="var">?w</span> <span class="keyword1">*v</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> le1<span class="main">[</span><span class="operator">unfolded</span> eq1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"le_vec <span class="main">(</span>sr <span class="keyword1">*s</span> <span class="main">(</span><span class="var">?w</span> <span class="keyword1">*v</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">mu</span> <span class="keyword1">*s</span> <span class="main">(</span><span class="var">?w</span> <span class="keyword1">*v</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> y <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> yi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> <span class="free">y</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> order.strict_iff_order vec_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> w<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> wi<span class="main">:</span> <span class="quoted"><span class="quoted">"w <span class="main">$</span> <span class="skolem">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">j</span><span class="main">.</span> w <span class="main">$</span> <span class="bound">j</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> order.strict_iff_order<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?w</span> <span class="keyword1">*v</span> <span class="free">y</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> yi y wi w
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matrix_vector_mult_def rowvector_def 
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_pos2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="main">]</span></span> mult_nonneg_nonneg<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 2<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sr <span class="main">*</span> <span class="main">(</span><span class="var">?w</span> <span class="keyword1">*v</span> <span class="free">y</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="free">mu</span> <span class="main">*</span> <span class="main">(</span><span class="var">?w</span> <span class="keyword1">*v</span> <span class="free">y</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sr <span class="main">≤</span> <span class="free">mu</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span> 
  <span class="keyword3"><span class="command">thus</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"sr <span class="main">≤</span> <span class="free">mu</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cc</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cc</span> <span class="main">=</span> <span class="main">(</span><span class="free">mu</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">^</span> N"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> N"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> * sr_pos <span class="keyword1"><span class="command">have</span></span> mu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> cc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cc</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
  <span class="keyword1"><span class="command">from</span></span> y <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pow_A_1 <span class="free">y</span> <span class="main">∈</span> pow_A_1 <span class="main">`</span> X"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Y_pos_main<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span>A1n <span class="keyword1">*v</span> <span class="free">y</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pow_A_1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"le_vec <span class="main">(</span>A1n <span class="keyword1">*v</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cc</span> <span class="keyword1">*s</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cc_def A1n_def n_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?An</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"matpow <span class="main">(</span><span class="free">A</span> <span class="main">+</span> mat <span class="main">1</span><span class="main">)</span> <span class="skolem">n</span>"</span></span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mu</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">mu</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> id'<span class="main">:</span> <span class="quoted"><span class="quoted">"matpow <span class="main">(</span><span class="free">A</span> <span class="main">+</span> mat <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="keyword1">*v</span> <span class="free">y</span> <span class="main">=</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="main">(</span><span class="var">?An</span> <span class="keyword1">*v</span> <span class="free">y</span><span class="main">)</span> <span class="main">+</span> <span class="var">?An</span> <span class="keyword1">*v</span> <span class="free">y</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">=</span> <span class="var">?b</span> <span class="main">+</span> <span class="var">?c</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matrix_add_ldistrib matrix_mul_rid matrix_add_vect_distrib matpow_1_commute
       matrix_vector_mul_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_vec <span class="var">?b</span> <span class="main">(</span><span class="var">?mu</span><span class="main">^</span><span class="skolem">n</span> <span class="keyword1">*s</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> le_vec_mono_left<span class="main">[</span><span class="operator">OF</span> nonneg Suc<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> vec.scale<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_vec <span class="main">(</span><span class="var">?mu</span><span class="main">^</span><span class="skolem">n</span> <span class="keyword1">*s</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?mu</span><span class="main">^</span><span class="skolem">n</span> <span class="keyword1">*s</span> <span class="main">(</span><span class="free">mu</span> <span class="keyword1">*s</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> le mu <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mu</span><span class="main">^</span><span class="skolem">n</span> <span class="keyword1">*s</span> <span class="main">(</span><span class="free">mu</span> <span class="keyword1">*s</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?mu</span><span class="main">^</span><span class="skolem">n</span> <span class="main">*</span> <span class="free">mu</span><span class="main">)</span> <span class="keyword1">*s</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> le_vec_trans<span class="main">[</span><span class="operator">OF</span> calculation<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> id<span class="main"><span class="main">]</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> le1<span class="main">:</span> <span class="quoted"><span class="quoted">"le_vec <span class="var">?b</span> <span class="main">(</span><span class="main">(</span><span class="var">?mu</span><span class="main">^</span><span class="skolem">n</span> <span class="main">*</span> <span class="free">mu</span><span class="main">)</span> <span class="keyword1">*s</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span> 
    <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword1"><span class="command">have</span></span> le2<span class="main">:</span> <span class="quoted"><span class="quoted">"le_vec <span class="var">?c</span> <span class="main">(</span><span class="main">(</span><span class="free">mu</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">n</span> <span class="keyword1">*s</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"le_vec <span class="var">?a</span> <span class="main">(</span><span class="main">(</span><span class="var">?mu</span><span class="main">^</span><span class="skolem">n</span> <span class="main">*</span> <span class="free">mu</span><span class="main">)</span> <span class="keyword1">*s</span> <span class="free">y</span> <span class="main">+</span> <span class="var">?mu</span><span class="main">^</span><span class="skolem">n</span> <span class="keyword1">*s</span> <span class="free">y</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> id' <span class="keyword1"><span class="command">using</span></span> add_mono<span class="main">[</span><span class="operator">OF</span> le1<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span> le2<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> id''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?mu</span><span class="main">^</span><span class="skolem">n</span> <span class="main">*</span> <span class="free">mu</span><span class="main">)</span> <span class="keyword1">*s</span> <span class="free">y</span> <span class="main">+</span> <span class="var">?mu</span><span class="main">^</span><span class="skolem">n</span> <span class="keyword1">*s</span> <span class="free">y</span> <span class="main">=</span> <span class="var">?mu</span><span class="main">^</span>Suc <span class="skolem">n</span> <span class="keyword1">*s</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> le <span class="keyword1"><span class="command">unfolding</span></span> id'' <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matrix_vector_mul_lid<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">cc</span> <span class="main">*</span> <span class="free">y</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">using</span></span> lt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> le<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">using</span></span> lt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> cc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> zero_less_mult_pos<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"lt_vec <span class="main">0</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">assume</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">=</span> sr <span class="main">∨</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">y</span> <span class="main">=</span> <span class="free">mu</span> <span class="keyword1">*s</span> <span class="free">y</span>"</span></span> 
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> <span class="free">y</span> <span class="main">=</span> <span class="free">mu</span> <span class="keyword1">*s</span> <span class="free">y</span>"</span></span> 
    <span class="keyword1"><span class="command">with</span></span> y <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eigen_vector <span class="free">A</span> <span class="free">y</span> <span class="free">mu</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X_def eigen_vector_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eigen_vector cA <span class="main">(</span>map_vector c <span class="free">y</span><span class="main">)</span> <span class="main">(</span>c <span class="free">mu</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> of_real_hom.eigen_vector_hom <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> eigen_vector_norm_sr<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">=</span> sr"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> ** <span class="keyword1"><span class="command">have</span></span> mu_sr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">=</span> sr"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> eq1<span class="main">[</span><span class="operator">folded</span> vector_smult_distrib<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?w</span> <span class="keyword1">*v</span> <span class="main">(</span>sr <span class="keyword1">*s</span> <span class="free">y</span> <span class="main">-</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_vector_right_distrib_diff <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> le0<span class="main">:</span> <span class="quoted"><span class="quoted">"le_vec <span class="main">0</span> <span class="main">(</span>sr <span class="keyword1">*s</span> <span class="free">y</span> <span class="main">-</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> mu_sr<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sr <span class="keyword1">*s</span> <span class="free">y</span> <span class="main">-</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pos_rowvector_mult_0<span class="main">[</span><span class="operator">OF</span> w<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 0 le0<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> ev_y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> <span class="free">y</span> <span class="main">=</span> sr <span class="keyword1">*s</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">=</span> sr <span class="main">∧</span> <span class="free">A</span> <span class="keyword1">*v</span> <span class="free">y</span> <span class="main">=</span> <span class="free">mu</span> <span class="keyword1">*s</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ev_y mu_sr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nonnegative_eigenvector_has_ev_sr<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eigen_vector <span class="free">A</span> <span class="free">v</span> <span class="free">mu</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"le_vec <span class="main">0</span> <span class="free">v</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">mu</span> <span class="main">=</span> sr"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> eigen_vector_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> <span class="free">v</span> <span class="main">=</span> <span class="free">mu</span> <span class="keyword1">*s</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> le v <span class="keyword1"><span class="command">have</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> X"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> X_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> ev <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_vec <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">mu</span> <span class="keyword1">*s</span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> le_vec_A_mu<span class="main">[</span><span class="operator">OF</span> v this<span class="main">]</span> ev <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> similar_matrix_rotation<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"eigen_value cA <span class="free">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> α<span class="main">:</span> <span class="quoted"><span class="quoted">"cmod <span class="free">α</span> <span class="main">=</span> sr"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"similar_matrix <span class="main">(</span>cis <span class="main">(</span>arg <span class="free">α</span><span class="main">)</span> <span class="keyword1">*k</span> cA<span class="main">)</span> cA"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> ev <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"eigen_vector cA <span class="skolem">y</span> <span class="free">α</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eigen_value_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"norm_v <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> maps <span class="main">=</span> map_vector_def map_matrix_def
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">yp</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yp</span> <span class="main">=</span> norm_v <span class="skolem">y</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?yp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_vector c <span class="skolem">yp</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> yp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">yp</span> <span class="main">∈</span> X"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> yp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> norm_v_X<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ev<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ev<span class="main">[</span><span class="operator">unfolded</span> eigen_vector_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ev_y<span class="main">:</span> <span class="quoted"><span class="quoted">"cA <span class="keyword1">*v</span> <span class="skolem">y</span> <span class="main">=</span> <span class="free">α</span> <span class="keyword1">*s</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> ev_le_vec<span class="main">[</span><span class="operator">OF</span> ev<span class="main">,</span> <span class="operator">unfolded</span> α<span class="main">,</span> <span class="operator">folded</span> yp_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"le_vec <span class="main">(</span>sr <span class="keyword1">*s</span> <span class="skolem">yp</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*v</span> <span class="skolem">yp</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> rho_le_x_Ax_imp_rho_le_rx<span class="main">[</span><span class="operator">OF</span> yp 1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sr <span class="main">≤</span> r <span class="skolem">yp</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> ev_inequalities<span class="main">[</span><span class="operator">OF</span> ev<span class="main">,</span> <span class="operator">folded</span> yp_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"r <span class="skolem">yp</span> <span class="main">=</span> sr"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ev_yp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">*v</span> <span class="skolem">yp</span> <span class="main">=</span> sr <span class="keyword1">*s</span> <span class="skolem">yp</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> pos_yp<span class="main">:</span> <span class="quoted"><span class="quoted">"lt_vec <span class="main">0</span> <span class="skolem">yp</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> sr_imp_eigen_vector_main<span class="main">[</span><span class="operator">OF</span> yp 2<span class="main">]</span> sr_u_pos<span class="main">[</span><span class="operator">OF</span> yp 2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> diagvector <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> cis <span class="main">(</span>arg <span class="main">(</span><span class="skolem">y</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">inv_D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">inv_D</span> <span class="main">=</span> diagvector <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> cis <span class="main">(</span><span class="main">-</span> arg <span class="main">(</span><span class="skolem">y</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> DD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">inv_D</span> <span class="main">**</span> <span class="skolem">D</span> <span class="main">=</span> mat <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">**</span> <span class="skolem">inv_D</span> <span class="main">=</span> mat <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> D_def inv_D_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diagvector_eq_mat cis_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">D</span> <span class="keyword1">*v</span> <span class="var">?yp</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">=</span> cis <span class="main">(</span>arg <span class="main">(</span><span class="skolem">y</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> c <span class="main">(</span>cmod <span class="main">(</span><span class="skolem">y</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> D_def yp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maps<span class="main">)</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cis_mult_cmod_id<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> calculation
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> y_D_yp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">D</span> <span class="keyword1">*v</span> <span class="var">?yp</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_eq_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">=</span> arg <span class="free">α</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?φ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cis <span class="main">(</span><span class="main">-</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cis <span class="main">(</span><span class="main">-</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">*</span> rcis sr <span class="skolem">φ</span> <span class="main">=</span> sr"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cis_rcis_eq rcis_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> α<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">=</span> rcis sr <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> φ_def α<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> rcis_cmod_arg <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> <span class="var">?φ</span> <span class="keyword1">*k</span> <span class="main">(</span><span class="skolem">inv_D</span> <span class="main">**</span> cA <span class="main">**</span> <span class="skolem">D</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cA <span class="keyword1">*v</span> <span class="main">(</span><span class="skolem">D</span> <span class="keyword1">*v</span> <span class="var">?yp</span><span class="main">)</span> <span class="main">=</span> <span class="free">α</span> <span class="keyword1">*s</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> y_D_yp<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> ev_y <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">inv_D</span> <span class="keyword1">*v</span> <span class="main">…</span> <span class="main">=</span> <span class="free">α</span> <span class="keyword1">*s</span> <span class="var">?yp</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> vector_smult_distrib y_D_yp matrix_vector_mul_assoc DD matrix_vector_mul_lid <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?φ</span> <span class="keyword1">*s</span> <span class="main">…</span> <span class="main">=</span> sr <span class="keyword1">*s</span> <span class="var">?yp</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> α <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map_vector c <span class="main">(</span>sr <span class="keyword1">*s</span> <span class="skolem">yp</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> vec_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> maps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> cA <span class="keyword1">*v</span> <span class="var">?yp</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ev_yp<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> maps matrix_vector_mult_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="keyword1">*v</span> <span class="var">?yp</span> <span class="main">=</span> cA <span class="keyword1">*v</span> <span class="var">?yp</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> F_def matrix_scalar_vector_ac<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> matrix_vector_mul_assoc<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> vector_smult_distrib <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> prod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">inv_D</span> <span class="main">**</span> cA <span class="main">**</span> <span class="skolem">D</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> cis <span class="main">(</span><span class="main">-</span> arg <span class="main">(</span><span class="skolem">y</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> cA <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">*</span> cis <span class="main">(</span>arg <span class="main">(</span><span class="skolem">y</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> inv_D_def D_def diagvector_mult_right diagvector_mult_left <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cmod <span class="main">(</span><span class="skolem">F</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> cmod <span class="main">(</span><span class="var">?φ</span> <span class="main">*</span> cA <span class="keyword1">$h</span> <span class="skolem">i</span> <span class="keyword1">$h</span> <span class="skolem">j</span> <span class="main">*</span> <span class="main">(</span>cis <span class="main">(</span><span class="main">-</span> arg <span class="main">(</span><span class="skolem">y</span> <span class="keyword1">$h</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> cis <span class="main">(</span>arg <span class="main">(</span><span class="skolem">y</span> <span class="keyword1">$h</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> F_def prod vec_lambda_beta matrix_scalar_mult_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">A</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cis_mult <span class="keyword1"><span class="command">unfolding</span></span> norm_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> calculation
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> FA<span class="main">:</span> <span class="quoted"><span class="quoted">"map_matrix norm <span class="skolem">F</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> maps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_matrix c <span class="main">(</span>map_matrix norm <span class="skolem">F</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="main">-</span> <span class="skolem">F</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Re</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_matrix Re"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> F<span class="main">[</span><span class="operator">folded</span> FA<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="keyword1">*v</span> <span class="var">?yp</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> matrix_diff_vect_distrib <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Re</span> <span class="var">?G</span> <span class="keyword1">*v</span> <span class="skolem">yp</span> <span class="main">=</span> map_vector Re <span class="main">(</span><span class="var">?G</span> <span class="keyword1">*v</span> <span class="var">?yp</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> maps matrix_vector_mult_def vec_lambda_beta Re_sum <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_eq_iff maps<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Re</span> <span class="var">?G</span> <span class="keyword1">*v</span> <span class="skolem">yp</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Re</span> <span class="var">?G</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pos_matrix_mult_0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ pos_yp 0<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> maps complex_Re_le_cmod<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="main">=</span> <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> maps vec_eq_iff cmod_eq_Re<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> FA <span class="keyword1"><span class="command">have</span></span> AF<span class="main">:</span> <span class="quoted"><span class="quoted">"cA <span class="main">=</span> <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">A</span><span class="main">.</span> cis <span class="skolem">φ</span> <span class="keyword1">*k</span> <span class="bound">A</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> sim<span class="main">:</span> <span class="quoted"><span class="quoted">"cis <span class="skolem">φ</span> <span class="keyword1">*k</span> cA <span class="main">=</span> <span class="skolem">inv_D</span> <span class="main">**</span> cA <span class="main">**</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> F_def matrix.scale_scale cis_mult
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"similar_matrix <span class="main">(</span>cis <span class="skolem">φ</span> <span class="keyword1">*k</span> cA<span class="main">)</span> cA"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> similar_matrix_def similar_matrix_wit_def
     sim
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">inv_D</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">D</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> DD<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> φ_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"eigen_value cA <span class="free">α</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> α<span class="main">:</span> <span class="quoted"><span class="quoted">"cmod <span class="free">α</span> <span class="main">=</span> sr"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> maximal_eigen_value_order_1<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="free">α</span> <span class="main">(</span>charpoly cA<span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> maximal_eigen_value_rotation<span class="main">:</span> <span class="quoted"><span class="quoted">"eigen_value cA <span class="main">(</span><span class="free">x</span> <span class="main">*</span> cis <span class="main">(</span>arg <span class="free">α</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> eigen_value cA <span class="free">x</span>"</span></span>
      <span class="quoted"><span class="quoted">"eigen_value cA <span class="main">(</span><span class="free">x</span> <span class="main">/</span> cis <span class="main">(</span>arg <span class="free">α</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> eigen_value cA <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cis <span class="main">(</span>arg <span class="free">α</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"charpoly cA"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> similar_matrix_rotation<span class="main">[</span><span class="operator">OF</span> ev α<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"similar_matrix <span class="main">(</span><span class="var">?a</span> <span class="keyword1">*k</span> cA<span class="main">)</span> cA"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> similar_matrix_charpoly<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"charpoly <span class="main">(</span><span class="var">?a</span> <span class="keyword1">*k</span> cA<span class="main">)</span> <span class="main">=</span> <span class="var">?p</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> order_charpoly_smult<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted">cA</span><span class="main">,</span> <span class="operator">unfolded</span> id<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> order_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="skolem">x</span> <span class="var">?p</span> <span class="main">=</span> order <span class="main">(</span><span class="skolem">x</span> <span class="main">/</span> <span class="var">?a</span><span class="main">)</span> <span class="var">?p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> order_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="skolem">x</span> <span class="var">?p</span> <span class="main">=</span> order <span class="main">(</span><span class="skolem">x</span> <span class="main">*</span> <span class="var">?a</span><span class="main">)</span> <span class="var">?p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> 
    <span class="keyword1"><span class="command">using</span></span> order_neg<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">*</span> <span class="var">?a</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">note</span></span> order_neg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">α</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">/</span> <span class="var">?a</span> <span class="main">=</span> sr"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> α<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> a cis_mult_cmod_id nonzero_mult_div_cancel_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> sr<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="main">…</span> <span class="var">?p</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> multiplicity_sr_1<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> charpoly_of_real
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> map_poly_inj_idom_divide_hom.order_hom<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="free">α</span> <span class="var">?p</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eigen_value cA <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="var">?a</span><span class="main">)</span> <span class="main">=</span> eigen_value cA <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> order_pos 
    <span class="keyword1"><span class="command">unfolding</span></span> eigen_value_root_charpoly order_root <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eigen_value cA <span class="main">(</span><span class="free">x</span> <span class="main">/</span> <span class="var">?a</span><span class="main">)</span> <span class="main">=</span> eigen_value cA <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> order_neg
    <span class="keyword1"><span class="command">unfolding</span></span> eigen_value_root_charpoly order_root <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> maximal_eigen_values_group<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="main">{</span><span class="bound">ev</span> <span class="main">::</span> complex<span class="main">.</span> eigen_value cA <span class="bound">ev</span> <span class="main">∧</span> cmod <span class="bound">ev</span> <span class="main">=</span> sr<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"rcis sr <span class="free">α</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"rcis sr <span class="free">β</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rcis sr <span class="main">(</span><span class="free">α</span> <span class="main">+</span> <span class="free">β</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"rcis sr <span class="main">(</span><span class="free">α</span> <span class="main">-</span> <span class="free">β</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"rcis sr <span class="main">0</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"rcis sr <span class="skolem">a</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"cis <span class="main">(</span>arg <span class="main">(</span>rcis sr <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> cis <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> * M mem_Collect_eq nonzero_mult_div_cancel_left of_real_eq_0_iff 
         rcis_cmod_arg rcis_def sr_pos<span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> *<span class="main">[</span><span class="operator">unfolded</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eigen_value cA <span class="main">(</span>rcis sr <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"cmod <span class="main">(</span>rcis sr <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> sr"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> maximal_eigen_value_rotation<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">unfolded</span> id<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eigen_value cA <span class="main">(</span><span class="skolem">x</span> <span class="main">*</span> cis <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> eigen_value cA <span class="skolem">x</span>"</span></span> 
      <span class="quoted"><span class="quoted">"eigen_value cA <span class="main">(</span><span class="skolem">x</span> <span class="main">/</span> cis <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> eigen_value cA <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> b<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"rcis sr <span class="free">α</span>"</span></span><span class="main">]</span> a <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rcis sr <span class="main">(</span><span class="free">α</span> <span class="main">+</span> <span class="free">β</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> M <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> a<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"rcis sr <span class="free">α</span>"</span></span><span class="main">]</span> a <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rcis sr <span class="main">0</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> M <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> *<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> b<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"rcis sr <span class="free">α</span>"</span></span><span class="main">]</span> a <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rcis sr <span class="main">(</span><span class="free">α</span> <span class="main">-</span> <span class="free">β</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> M <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> maximal_eigen_value_roots_of_unity_rotation<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="main">{</span><span class="bound">ev</span> <span class="main">::</span> complex<span class="main">.</span> eigen_value cA <span class="bound">ev</span> <span class="main">∧</span> cmod <span class="bound">ev</span> <span class="main">=</span> sr<span class="main">}</span>"</span></span> 
   <span class="keyword2"><span class="keyword">and</span></span> kM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> card <span class="free">M</span>"</span></span> 
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">f</span><span class="main">.</span> charpoly <span class="free">A</span> <span class="main">=</span> <span class="main">(</span>monom <span class="main">1</span> <span class="free">k</span> <span class="main">-</span> <span class="main">[:</span>sr<span class="main">^</span><span class="free">k</span><span class="main">:]</span><span class="main">)</span> <span class="main">*</span> <span class="bound">f</span> 
       <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>map_poly c <span class="bound">f</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> cmod <span class="bound">x</span> <span class="main">&lt;</span> sr<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="main">(*)</span> <span class="main">(</span>c sr<span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span>cis <span class="main">(</span>of_nat <span class="bound">i</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="main">(*)</span> <span class="main">(</span>c sr<span class="main">)</span> <span class="main">`</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">::</span> complex<span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> <span class="free">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(*)</span> <span class="main">(</span>cis <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> Spectrum cA <span class="main">=</span> Spectrum cA"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kM
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"card <span class="free">M</span>"</span></span> 
  <span class="keyword1"><span class="command">note</span></span> fin <span class="main">=</span> finite_spectrum<span class="main">[</span><span class="operator">of</span> <span class="quoted">cA</span><span class="main">]</span>  
  <span class="keyword1"><span class="command">note</span></span> char <span class="main">=</span> degree_monic_charpoly<span class="main">[</span><span class="operator">of</span> <span class="quoted">cA</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">≤</span> card <span class="main">(</span>Collect <span class="main">(</span>eigen_value cA<span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fin<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> M<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Collect <span class="main">(</span>eigen_value cA<span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>charpoly cA<span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> eigen_value_root_charpoly <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">≤</span> degree <span class="main">(</span>charpoly cA<span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> poly_roots_degree<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> char<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> char <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">≤</span> <span class="keyword1">CARD</span> <span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> finite_subset<span class="main">[</span><span class="operator">OF</span> _ fin<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> finM<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> M <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> finite_distinct_list<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> Mm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> set <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Mm dist <span class="keyword1"><span class="command">have</span></span> card<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">=</span> length <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distinct_card<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> sr<span class="main">:</span> <span class="quoted"><span class="quoted">"sr <span class="main">∈</span> set <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eigen_value_sr_c sr_pos <span class="keyword1"><span class="command">unfolding</span></span> Mm<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> M <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> sort_key arg <span class="skolem">m</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> map arg <span class="skolem">s</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">a</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> dist Mm card sr <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> set <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">s</span>"</span></span>  <span class="quoted"><span class="quoted">"sr <span class="main">∈</span> set <span class="skolem">s</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> card<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">=</span> <span class="var">?k</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sorted<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="skolem">a</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> s_def a_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> map_s<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">(*)</span> <span class="main">(</span>c sr<span class="main">)</span><span class="main">)</span> <span class="main">(</span>map cis <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> map_map o_def a_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> map_idI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">s</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">folded</span> s<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">unfolded</span> M<span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">x</span> <span class="main">=</span> sr"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sr <span class="main">*</span> cis <span class="main">(</span>arg <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> rcis_cmod_arg<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> id<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rcis_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> s<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">folded</span> map_s<span class="main">,</span> <span class="operator">unfolded</span> distinct_map<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"inj_on cis <span class="main">(</span>set <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> s<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">aa</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">aa</span> <span class="main">#</span> <span class="skolem">a'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> a_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> arg_bounded <span class="keyword1"><span class="command">have</span></span> bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">a</span> <span class="main">⟹</span> <span class="main">-</span> pi <span class="main">&lt;</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">≤</span> pi"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">unfolding</span></span> a_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> bounded<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">aa</span></span><span class="main">,</span> <span class="operator">unfolded</span> a_split<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> aa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> pi <span class="main">&lt;</span> <span class="skolem">aa</span> <span class="main">∧</span> <span class="skolem">aa</span> <span class="main">≤</span> pi"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?aa</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">aa</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> pi"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">args</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">args</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">@</span> <span class="main">[</span><span class="var">?aa</span><span class="main">]</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?diff</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">args</span> <span class="main">!</span> Suc <span class="bound">i</span> <span class="main">-</span> <span class="skolem">args</span> <span class="main">!</span> <span class="bound">i</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> bnd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">a</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="var">?aa</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> aa bounded<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> aa_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?aa</span> <span class="main">∉</span> set <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">have</span></span> sorted<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="skolem">args</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> args_def <span class="keyword1"><span class="command">using</span></span> sorted <span class="keyword1"><span class="command">unfolding</span></span> sorted_append
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> bnd<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> order.strict_iff_order<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">args</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a aa_a <span class="keyword1"><span class="command">unfolding</span></span> args_def distinct_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?k</span><span class="main">.</span> <span class="var">?diff</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> pi"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> sum_lessThan_telescope args_def a_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> a_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?diff</span> <span class="main">`</span> <span class="main">{..&lt;</span> <span class="var">?k</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Min</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Min</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Min</span> <span class="main">=</span> <span class="var">?Min</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Min</span> <span class="main">=</span> <span class="main">(</span><span class="var">?k</span> <span class="main">*</span> <span class="var">?Min</span><span class="main">)</span> <span class="main">/</span> <span class="var">?k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">*</span> <span class="var">?Min</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?k</span><span class="main">.</span> <span class="var">?Min</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">/</span> <span class="var">?k</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="var">?k</span><span class="main">.</span> <span class="var">?diff</span> <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> <span class="var">?k</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> divide_right_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sum_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Min_le<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> <span class="var">?k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> Min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Min</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> <span class="var">?k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Min_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="var">?k</span> <span class="main">⟹</span> <span class="skolem">args</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">args</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> 
    <span class="keyword1"><span class="command">using</span></span> sorted<span class="main">[</span><span class="operator">unfolded</span> sorted_iff_nth_mono<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span>
    dist<span class="main">[</span><span class="operator">unfolded</span> distinct_conv_nth<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> args_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> rcis sr <span class="main">(</span><span class="skolem">args</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> hda<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">aa</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> a_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
  <span class="keyword1"><span class="command">have</span></span> Min0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Min</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lt <span class="keyword1"><span class="command">unfolding</span></span> Min_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Min_gr_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> k<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Min_A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Min</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Min_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> k<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">args</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="skolem">i</span> <span class="main">=</span> rcis sr <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">@</span> <span class="main">[</span>hd <span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="var">?k</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> args_def nth_append rcis_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>rcis sr<span class="main">)</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">@</span> <span class="main">[</span>hd <span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i 
      <span class="keyword1"><span class="command">unfolding</span></span> args_def set_map <span class="keyword1"><span class="command">unfolding</span></span> set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> rcis sr <span class="main">`</span> set <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> a_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s<span class="main">(</span>1<span class="main">)</span> map_s<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> set_map image_image
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rcis_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> ciM <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="var">?k</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">args</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">args</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> args_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> maximal_eigen_values_group<span class="main">[</span><span class="operator">OF</span> M ciM<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator"><span class="operator"><span class="operator">OF</span></span></span> this<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span> ciM<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator"><span class="operator"><span class="operator">OF</span></span></span> this<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rcis sr <span class="main">(</span><span class="var">?diff</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> Min_M<span class="main">:</span> <span class="quoted"><span class="quoted">"rcis sr <span class="skolem">Min</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Min_A <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>  
  <span class="keyword1"><span class="command">have</span></span> rcisM<span class="main">:</span> <span class="quoted"><span class="quoted">"rcis sr <span class="main">(</span>of_nat <span class="skolem">n</span> <span class="main">*</span> <span class="skolem">Min</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> sr Mm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>    
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"rcis sr <span class="main">(</span>of_nat <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Min</span><span class="main">)</span> <span class="main">=</span> rcis sr <span class="main">(</span>of_nat <span class="skolem">n</span> <span class="main">*</span> <span class="skolem">Min</span><span class="main">)</span> <span class="main">*</span> cis <span class="skolem">Min</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rcis_mult ring_distribs add.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> maximal_eigen_values_group<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> M Suc Min_M<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?list</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>rcis sr<span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> of_nat <span class="bound">i</span> <span class="main">*</span> <span class="skolem">Min</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="var">?k</span><span class="main">]</span><span class="main">)</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">list</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">list</span> <span class="main">=</span> <span class="var">?list</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?list</span> <span class="main">=</span> <span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> card <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> sr_pos <span class="keyword1"><span class="command">have</span></span> sr0<span class="main">:</span> <span class="quoted"><span class="quoted">"sr <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="var">?k</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> real <span class="skolem">i</span> <span class="main">*</span> <span class="skolem">Min</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Min0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="skolem">i</span> <span class="main">&lt;</span> real <span class="var">?k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> mult_strict_right_mono<span class="main">[</span><span class="operator">OF</span> this Min0<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="skolem">i</span> <span class="main">*</span> <span class="skolem">Min</span> <span class="main">&lt;</span> real <span class="var">?k</span> <span class="main">*</span> <span class="skolem">Min</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> real <span class="var">?k</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> real <span class="var">?k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_left_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Min<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> pi"</span></span> <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="skolem">i</span> <span class="main">*</span> <span class="skolem">Min</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> pi"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">note</span></span> * this
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> prod_pi <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="var">?list</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> distinct_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rcis sr"</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ inj_on_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rcis_inj_on<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sr0<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> of_nat <span class="bound">i</span> <span class="main">*</span> <span class="skolem">Min</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="var">?k</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Min0
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distinct_map inj_on_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> real <span class="bound">i</span> <span class="main">*</span> <span class="skolem">Min</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="var">?k</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="numeral">2</span> <span class="main">*</span> pi<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prod_pi
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> len <span class="keyword1"><span class="command">have</span></span> card'<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set <span class="var">?list</span><span class="main">)</span> <span class="main">=</span> <span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> distinct_card <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> listM<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="var">?list</span> <span class="main">⊆</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rcisM <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> card_subset_eq<span class="main">[</span><span class="operator">OF</span> finM listM card'<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> M_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> set <span class="var">?list</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?piM</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> <span class="var">?M</span>"</span></span> 
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Min</span> <span class="main">≠</span> <span class="var">?piM</span>"</span></span> 
    <span class="keyword1"><span class="command">with</span></span> Min <span class="keyword1"><span class="command">have</span></span> lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Min</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> <span class="var">?k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> card <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> k <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> real <span class="var">?k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> mult_strict_left_mono<span class="main">[</span><span class="operator">OF</span> lt this<span class="main">]</span> k Min0
    <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="var">?k</span> <span class="main">*</span> <span class="skolem">Min</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">*</span> <span class="skolem">Min</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> pi"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> rcisM<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span><span class="main">,</span> <span class="operator">unfolded</span> M_list<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rcis sr <span class="main">(</span><span class="var">?k</span> <span class="main">*</span> <span class="skolem">Min</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?list</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="var">?k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"rcis sr <span class="main">(</span><span class="var">?k</span> <span class="main">*</span> <span class="skolem">Min</span><span class="main">)</span> <span class="main">=</span> rcis sr <span class="main">(</span><span class="skolem">i</span> <span class="main">*</span> <span class="skolem">Min</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> inj_onD<span class="main">[</span><span class="operator">OF</span> inj_on_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rcis_inj_on<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sr0<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?k</span> <span class="main">*</span> <span class="skolem">Min</span><span class="main">,</span> <span class="skolem">i</span> <span class="main">*</span> <span class="skolem">Min</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span> id<span class="main">]</span> 
      prod_pi<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> k
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">*</span> <span class="skolem">Min</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">*</span> <span class="skolem">Min</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Min0 i <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> Min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Min</span> <span class="main">=</span> <span class="var">?piM</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> cM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> card <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> cis <span class="main">(</span>of_nat <span class="bound">i</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">note</span></span> M_list
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?list</span> <span class="main">=</span> <span class="main">(*)</span> <span class="main">(</span>c sr<span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> cis <span class="main">(</span>of_nat <span class="bound">i</span> <span class="main">*</span> <span class="skolem">Min</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="var">?k</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> set_map image_image 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> sr_pos<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rcis_mult rcis_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> M_cis<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="main">(*)</span> <span class="main">(</span>c sr<span class="main">)</span> <span class="main">`</span> <span class="var">?f</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="var">?M</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> card Min <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.assoc<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> M_pow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="main">(*)</span> <span class="main">(</span>c sr<span class="main">)</span> <span class="main">`</span> <span class="main">{</span> <span class="bound">x</span> <span class="main">::</span> complex<span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> <span class="var">?M</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> roots_of_unity<span class="main">[</span><span class="operator">OF</span> cM<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rphi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"rcis sr <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> <span class="var">?M</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?phi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cis <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> <span class="var">?M</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> Min_M<span class="main">[</span><span class="operator">unfolded</span> Min<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"eigen_value cA <span class="var">?rphi</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> M <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> cm<span class="main">:</span> <span class="quoted"><span class="quoted">"cmod <span class="var">?rphi</span> <span class="main">=</span> sr"</span></span> <span class="keyword1"><span class="command">using</span></span> sr_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"cis <span class="main">(</span>arg <span class="var">?rphi</span><span class="main">)</span> <span class="main">=</span> cis <span class="main">(</span>arg <span class="var">?phi</span><span class="main">)</span> <span class="main">*</span> cmod <span class="var">?phi</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> arg_rcis_cis<span class="main">[</span><span class="operator">OF</span> sr_pos<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?phi</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cis_mult_cmod_id <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"cis <span class="main">(</span>arg <span class="var">?rphi</span><span class="main">)</span> <span class="main">=</span> <span class="var">?phi</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">phi</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">phi</span> <span class="main">=</span> <span class="var">?phi</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> phi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">phi</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> phi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> max <span class="main">=</span> maximal_eigen_value_rotation<span class="main">[</span><span class="operator">OF</span> ev cm<span class="main">,</span> <span class="operator">unfolded</span> id phi_def<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">symmetric</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(*)</span> <span class="skolem">phi</span><span class="main">)</span> <span class="main">`</span> Spectrum cA <span class="main">=</span> Spectrum cA"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> max<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> phi <span class="keyword1"><span class="command">unfolding</span></span> Spectrum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> 
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eigen_value cA <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Spectrum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">folded</span> max<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">/</span> <span class="skolem">phi</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Spectrum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>      
        <span class="keyword1"><span class="command">from</span></span> imageI<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(*)</span> <span class="skolem">phi</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> phi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">note</span></span> this *
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> phi_def<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(*)</span> <span class="main">(</span>cis <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> pi <span class="main">/</span> real <span class="main">(</span>card <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> Spectrum cA <span class="main">=</span> Spectrum cA"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"monom <span class="main">1</span> <span class="free">k</span> <span class="main">-</span> <span class="main">[:</span>sr<span class="main">^</span><span class="free">k</span><span class="main">:]</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"monom <span class="main">1</span> <span class="free">k</span> <span class="main">-</span> <span class="main">[:</span><span class="main">(</span>c sr<span class="main">)</span><span class="main">^</span><span class="free">k</span><span class="main">:]</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?one</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">::</span> complex"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?list</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>rcis sr<span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> of_nat <span class="bound">i</span> <span class="main">*</span> <span class="var">?piM</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> card <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">interpret</span></span> c<span class="main">:</span> field_hom <span class="quoted">c</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> p<span class="main">:</span> map_poly_inj_idom_divide_hom <span class="quoted">c</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> cp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?cp</span> <span class="main">=</span> map_poly c <span class="var">?p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">hom_distribs</span></span><span class="main">)</span>    
  <span class="keyword1"><span class="command">have</span></span> M_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> set <span class="var">?list</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> M_list<span class="main">[</span><span class="operator">unfolded</span> Min card<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> dist<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="var">?list</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dist<span class="main">[</span><span class="operator">unfolded</span> Min card<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> k0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k<span class="main">[</span><span class="operator">folded</span> card<span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?cp</span> <span class="main">=</span> <span class="main">(</span>monom <span class="main">1</span> <span class="free">k</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span> <span class="main">[:</span><span class="main">(</span>c sr<span class="main">)</span><span class="main">^</span><span class="free">k</span><span class="main">:]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">…</span> <span class="main">=</span> <span class="free">k</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> degree_add_eq_left<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> k0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degree_monom_eq<span class="main">)</span>  
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="var">?cp</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> deg k0 <span class="keyword1"><span class="command">have</span></span> cp0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?cp</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="var">?cp</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">^</span><span class="free">k</span> <span class="main">=</span> <span class="main">(</span>c sr<span class="main">)</span><span class="main">^</span><span class="free">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> poly_diff poly_monom 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="free">M</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">^</span><span class="free">k</span> <span class="main">=</span> <span class="main">(</span>c sr<span class="main">)</span><span class="main">^</span><span class="free">k</span>"</span></span> 
      <span class="keyword1"><span class="command">from</span></span> sr_pos k0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>c sr<span class="main">)</span><span class="main">^</span><span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> id<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">/</span> <span class="main">(</span>c sr<span class="main">)</span><span class="main">^</span><span class="free">k</span>"</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">/</span> c sr<span class="main">)</span><span class="main">^</span><span class="free">k</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> power_divide <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"c sr <span class="main">*</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">/</span> c sr<span class="main">)</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> M_pow<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> kM<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"c sr <span class="main">*</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">/</span> c sr<span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sr_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> cp_M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="var">?cp</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> card <span class="main">(</span>set <span class="var">?list</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> distinct_card<span class="main">[</span><span class="operator">OF</span> dist<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> kM<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="var">?cp</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> card_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> poly_roots_finite<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cp0<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="var">?list</span>"</span></span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> rcis sr <span class="main">(</span>real <span class="skolem">i</span> <span class="main">*</span> <span class="var">?piM</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">^</span><span class="free">k</span> <span class="main">=</span> <span class="main">(</span>c sr<span class="main">)</span><span class="main">^</span><span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> x DeMoivre2 kM
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> mult.assoc of_real_power rcis_times_2pi<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"poly <span class="var">?cp</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> poly_diff poly_monom <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?list</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="var">?cp</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> k_card<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="var">?cp</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> k_card cp_M finM <span class="keyword1"><span class="command">have</span></span> M_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="var">?cp</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> kM <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_seteq<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> dvdc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?cp</span> <span class="keyword1">dvd</span> charpoly cA"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> poly_roots_dvd<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cp0 deg k_card<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> cp_M
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="var">?cp</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>charpoly cA<span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> M eigen_value_root_charpoly <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> charpoly_of_real cp p.hom_dvd_iff<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> dvd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="keyword1">dvd</span> charpoly <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> dvd_def<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"charpoly <span class="free">A</span> <span class="main">=</span> <span class="var">?p</span> <span class="main">*</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_poly c <span class="skolem">f</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> decompc<span class="main">:</span> <span class="quoted"><span class="quoted">"charpoly cA <span class="main">=</span> <span class="var">?cp</span> <span class="main">*</span> <span class="var">?f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> charpoly_of_real decomp p.hom_mult cp <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">f</span><span class="main">.</span> charpoly <span class="free">A</span> <span class="main">=</span> <span class="main">(</span>monom <span class="main">1</span> <span class="var">?M</span> <span class="main">-</span> <span class="main">[:</span>sr<span class="main">^</span><span class="var">?M</span><span class="main">:]</span><span class="main">)</span> <span class="main">*</span> <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>map_poly c <span class="bound">f</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> cmod <span class="bound">x</span> <span class="main">&lt;</span> sr<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> kM<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> decomp<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="var">?f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"eigen_value cA <span class="skolem">x</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> decompc p.hom_mult eigen_value_root_charpoly <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
    <span class="keyword1"><span class="command">hence</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">x</span> <span class="main">≤</span> sr"</span></span> <span class="keyword1"><span class="command">using</span></span> eigen_value_norm_sr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> max<span class="main">:</span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">x</span> <span class="main">=</span> sr"</span></span> 
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> M <span class="keyword1"><span class="command">using</span></span> ev <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"poly <span class="var">?cp</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> M_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> dvd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[:</span> <span class="main">-</span><span class="skolem">x</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span> <span class="keyword1">dvd</span> <span class="var">?cp</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> poly_eq_0_iff_dvd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> f<span class="main">[</span><span class="operator">unfolded</span> poly_eq_0_iff_dvd<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> dvd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[:</span> <span class="main">-</span><span class="skolem">x</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span> <span class="keyword1">dvd</span> <span class="var">?f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> char <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"charpoly cA <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> mult_dvd_mono<span class="main">[</span><span class="operator">OF</span> dvd1 dvd2<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[:</span> <span class="main">-</span><span class="skolem">x</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span><span class="main">^</span><span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="main">(</span>charpoly cA<span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> decompc power2_eq_square <span class="keyword1"><span class="command">.</span></span>      
      <span class="keyword1"><span class="command">from</span></span> order_max<span class="main">[</span><span class="operator">OF</span> this 0<span class="main">]</span> maximal_eigen_value_order_1<span class="main">[</span><span class="operator">OF</span> ev max<span class="main">]</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">with</span></span> le <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">x</span> <span class="main">&lt;</span> sr"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemmas</span></span> pf_main <span class="main">=</span>
  eigen_value_sr eigen_vector_z_sr <span class="comment1">(* sr is eigenvalue *)</span>
  eigen_value_norm_sr  <span class="comment1">(* it is maximal among all complex eigenvalues *)</span>
  z_pos    <span class="comment1">(* it's eigenvector is positive *)</span>
  multiplicity_sr_1 <span class="comment1">(* the algebr. multiplicity is 1 *)</span>
  nonnegative_eigenvector_has_ev_sr <span class="comment1">(* every non-negative real eigenvector has sr as eigenvalue *)</span>
  maximal_eigen_value_order_1 <span class="comment1">(* all maximal eigenvalues have order 1 *)</span>
  maximal_eigen_value_roots_of_unity_rotation 
   <span class="comment1">(* the maximal eigenvalues are precisely the k-th roots of unity for some k ≤ dim A *)</span>

<span class="keyword1"><span class="command">lemmas</span></span> pf_main_connect <span class="main">=</span> pf_main<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>5<span class="main">,</span>7<span class="main">,</span>8-10<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> sr_spectral_radius<span class="main">]</span> 
  sr_pos<span class="main">[</span><span class="operator">unfolded</span> sr_spectral_radius<span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Perron_Frobenius_General">
<div class="head">
<h1>Theory Perron_Frobenius_General</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Thiemann *)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Handling Non-Irreducible Matrices as Well›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Perron_Frobenius_General
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Perron_Frobenius_Irreducible.html">Perron_Frobenius_Irreducible</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We will need to take sub-matrices and permutations of matrices where the former can best be done
  via JNF-matrices. So, we first need the Perron-Frobenius theorem in the JNF-world. 
  So, we first define irreducibility of a JNF-matrix.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">graph_of_mat</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">graph_of_mat</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> dim_row <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span> <span class="bound">U</span> <span class="main">=</span> <span class="main">{..&lt;</span><span class="bound">n</span><span class="main">}</span> <span class="keyword1">in</span>
     <span class="main">{</span> <span class="bound">ij</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">$$</span> <span class="bound">ij</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span> <span class="main">∩</span> <span class="bound">U</span> <span class="main">×</span> <span class="bound">U</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">irreducible_mat</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">irreducible_mat</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> dim_row <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">in</span> 
    <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">n</span> <span class="main">⟶</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="bound">n</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>graph_of_mat <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">^+</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">nonneg_irreducible_mat</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span>nonneg_mat <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧</span> irreducible_mat <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next, we have to install transfer rules›</span></span>

<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemma</span></span> HMA_irreducible<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>HMA_M <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> 
  irreducible_mat fixed_mat.irreducible"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> rel_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">a</span> <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> fixed_mat <span class="quoted"><span class="skolem">A</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Bij_Nat.to_nat <span class="main">::</span> <span class="tfree">'n</span> <span class="main">⇒</span> nat"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Bij_Nat.from_nat <span class="main">::</span> nat <span class="main">⇒</span> <span class="tfree">'n</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> 1<span class="main">[</span><span class="operator">unfolded</span> HMA_M_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> from_hma<span class="hidden">⇩</span><sub>m</sub> <span class="skolem">A</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?A</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> dim<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">a</span> <span class="main">=</span> <span class="var">?n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="var">?n</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="var">?n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> Aij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">=</span> <span class="var">?A</span> <span class="main">$$</span> <span class="main">(</span><span class="var">?t</span> <span class="skolem">i</span><span class="main">,</span> <span class="var">?t</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> to_hma<span class="hidden">⇩</span><sub>m</sub>_def to_hma_from_hma<span class="hidden">⇩</span><sub>m</sub> vec_lambda_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> graph<span class="main">:</span> <span class="quoted"><span class="quoted">"graph_of_mat <span class="skolem">a</span> <span class="main">=</span> 
    <span class="main">{</span><span class="main">(</span><span class="var">?t</span> <span class="bound">i</span><span class="main">,</span><span class="var">?t</span> <span class="bound">j</span><span class="main">)</span> <span class="main">|</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="skolem">A</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> graph_of_mat_def dim Let_def id range_to_nat<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> a Aij <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"irreducible_mat <span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> range <span class="var">?t</span> <span class="main">⟶</span> <span class="bound">j</span> <span class="main">∈</span> range <span class="var">?t</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?G</span><span class="main">^+</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> irreducible_mat_def dim Let_def range_to_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="var">?t</span> <span class="bound">i</span><span class="main">,</span> <span class="var">?t</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?G</span><span class="main">^+</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> part1 <span class="main">=</span> calculation
  <span class="keyword1"><span class="command">have</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="main">=</span> map_prod <span class="var">?t</span> <span class="var">?t</span> <span class="main">`</span> G"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> graph G_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> part2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?t</span> <span class="skolem">i</span><span class="main">,</span> <span class="var">?t</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?G</span><span class="main">^+</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> G<span class="main">^+</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inj_trancl_image<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> part1 part2 irreducible_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> HMA_nonneg_irreducible_mat<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>HMA_M <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> nonneg_irreducible_mat perron_frobenius"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> perron_frobenius_def pf_nonneg_mat_def perron_frobenius_axioms_def 
    nonneg_irreducible_mat_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The main statements of Perron-Frobenius can now be transferred to JNF-matrices›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> perron_frobenius_irreducible<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real Matrix.mat"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">cA</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex Matrix.mat"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_mat <span class="free">A</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> irr<span class="main">:</span> <span class="quoted"><span class="quoted">"irreducible_mat <span class="free">A</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> cA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cA</span> <span class="main">=</span> map_mat of_real <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sr</span> <span class="main">=</span> Spectral_Radius.spectral_radius <span class="free">cA</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> 
    <span class="quoted"><span class="quoted">"eigenvalue <span class="free">A</span> <span class="free">sr</span>"</span></span>
    <span class="quoted"><span class="quoted">"order <span class="free">sr</span> <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">sr</span>"</span></span>
    <span class="quoted"><span class="quoted">"eigenvalue <span class="free">cA</span> <span class="free">α</span> <span class="main">⟹</span> cmod <span class="free">α</span> <span class="main">≤</span> <span class="free">sr</span>"</span></span>
    <span class="quoted"><span class="quoted">"eigenvalue <span class="free">cA</span> <span class="free">α</span> <span class="main">⟹</span> cmod <span class="free">α</span> <span class="main">=</span> <span class="free">sr</span> <span class="main">⟹</span> order <span class="free">α</span> <span class="main">(</span>char_poly <span class="free">cA</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> char_poly <span class="free">A</span> <span class="main">=</span> <span class="main">(</span>monom <span class="main">1</span> <span class="bound">k</span> <span class="main">-</span> <span class="main">[:</span><span class="free">sr</span> <span class="main">^</span> <span class="bound">k</span><span class="main">:]</span><span class="main">)</span> <span class="main">*</span> <span class="bound">f</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>map_poly complex_of_real <span class="bound">f</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> cmod <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">sr</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">from</span></span> nonneg irr <span class="keyword1"><span class="command">have</span></span> irr<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_irreducible_mat <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> nonneg_irreducible_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> perron_frobenius.pf_main_connect<span class="main">[</span><span class="operator">untransferred</span><span class="main">,</span> <span class="operator">cancel_card_constraint</span><span class="main">,</span> <span class="operator">OF</span> A irr<span class="main">,</span> 
    <span class="operator">folded</span> sr cA<span class="main">]</span> 
  <span class="keyword1"><span class="command">from</span></span> main<span class="main">(</span>5<span class="main">,</span>6<span class="main">,</span>7<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> refl refl n<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> char_poly <span class="free">A</span> <span class="main">=</span> <span class="main">(</span>monom <span class="main">1</span> <span class="bound">k</span> <span class="main">-</span> <span class="main">[:</span><span class="free">sr</span> <span class="main">^</span> <span class="bound">k</span><span class="main">:]</span><span class="main">)</span> <span class="main">*</span> <span class="bound">f</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>map_poly complex_of_real <span class="bound">f</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> cmod <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">sr</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> main<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>8<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> n<span class="main">]</span> main<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ n<span class="main">]</span> main<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ _ n<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now need permutations on matrices to show that a matrix if a matrix is not irreducible,
  then it can be turned into a four-block-matrix by a permutation, where the lower left block is 0.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">permutation_mat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> semiring_1 mat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">permutation_mat</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> Matrix.mat <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">no_notation</span></span> m_inv <span class="main">(</span><span class="quoted">"<span class="keyword1">inv</span>ı _"</span> <span class="main">[</span>81<span class="main">]</span> 80<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> permutation_mat_dim<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"permutation_mat <span class="free">n</span> <span class="free">p</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> 
  <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>permutation_mat <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>permutation_mat <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> permutation_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> permutation_mat_row<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">permutes</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span>
  Matrix.row <span class="main">(</span>permutation_mat <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> unit_vec <span class="free">n</span> <span class="main">(</span>inv <span class="free">p</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> permutation_mat_def unit_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutes_inverses<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> permutation_mat_col<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">permutes</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span>
  Matrix.col <span class="main">(</span>permutation_mat <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> unit_vec <span class="free">n</span> <span class="main">(</span><span class="free">p</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> permutation_mat_def unit_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutes_inverses<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> permutation_mat_left<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">nc</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">permutes</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"permutation_mat <span class="free">n</span> <span class="free">p</span> <span class="main">*</span> <span class="free">A</span> <span class="main">=</span> Matrix.mat <span class="free">n</span> <span class="free">nc</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span>inv <span class="free">p</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">nc</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> p ij<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"inv <span class="free">p</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutes_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>permutation_mat <span class="free">n</span> <span class="free">p</span> <span class="main">*</span> <span class="free">A</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> scalar_prod <span class="main">(</span>unit_vec <span class="free">n</span> <span class="main">(</span>inv <span class="free">p</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>col <span class="free">A</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> index_mult_mat<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ij A p<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span>inv <span class="free">p</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> scalar_prod_left_unit<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A ij i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> calculation
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> permutation_mat_right<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">permutes</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">*</span> permutation_mat <span class="free">n</span> <span class="free">p</span> <span class="main">=</span> Matrix.mat <span class="free">nr</span> <span class="free">n</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="free">p</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">nr</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> p ij<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutes_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">*</span> permutation_mat <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> scalar_prod <span class="main">(</span>Matrix.row <span class="free">A</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>unit_vec <span class="free">n</span> <span class="main">(</span><span class="free">p</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> index_mult_mat<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ij A p<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="free">p</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> scalar_prod_right_unit<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A ij j<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> calculation
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> permutes_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">permutes</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">p</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> lessThan_iff permutes_in_image<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> permutes_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">permutes</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">p</span> <span class="free">i</span> <span class="main">=</span> <span class="free">p</span> <span class="free">j</span> <span class="main">⟷</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> permutes_inverses<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> permutation_mat_id_1<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">permutes</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"permutation_mat <span class="free">n</span> <span class="free">p</span> <span class="main">*</span> permutation_mat <span class="free">n</span> <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> permutation_mat_left<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ p<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> permutation_mat_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_matI<span class="main"><span class="keyword3">,</span></span> 
   <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutes_lt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> permutes_inv<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> p<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> permutes_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> permutes_inv<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> p<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> permutation_mat_id_2<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">permutes</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"permutation_mat <span class="free">n</span> <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">*</span> permutation_mat <span class="free">n</span> <span class="free">p</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> permutation_mat_right<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ p<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> permutation_mat_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_matI<span class="main"><span class="keyword3">,</span></span> 
   <span class="operator">insert</span> p<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutes_lt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p<span class="main"><span class="main">]</span></span> permutes_inverses<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> permutation_mat_both<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">permutes</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"permutation_mat <span class="free">n</span> <span class="free">p</span> <span class="main">*</span> Matrix.mat <span class="free">n</span> <span class="free">n</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">p</span> <span class="bound">i</span><span class="main">,</span> <span class="free">p</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> permutation_mat <span class="free">n</span> <span class="main">(</span>inv <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> permutation_mat_left<span class="main">[</span><span class="operator">OF</span> mat_carrier p<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> permutation_mat_right<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ permutes_inv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A p<span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_matI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutes_inverses permutes_lt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> permutes_inv<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> p<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> permutation_similar_mat<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">permutes</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"similar_mat <span class="free">A</span> <span class="main">(</span>Matrix.mat <span class="free">n</span> <span class="free">n</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">p</span> <span class="bound">i</span><span class="main">,</span> <span class="free">p</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> similar_matI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ permutation_mat_id_1<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> p<span class="main"><span class="main"><span class="main">]</span></span></span> permutation_mat_id_2<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> p<span class="main"><span class="main"><span class="main">]</span></span></span> 
  permutation_mat_both<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> A p<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> det_four_block_mat_lower_left_zero<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> idom mat"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A1</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A2</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> A30<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A3</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">m</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A4</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">m</span>"</span></span>  
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Determinant.det <span class="main">(</span>four_block_mat <span class="free">A1</span> <span class="free">A2</span> <span class="free">A3</span> <span class="free">A4</span><span class="main">)</span> <span class="main">=</span> Determinant.det <span class="free">A1</span> <span class="main">*</span> Determinant.det <span class="free">A4</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?det</span></span></span> <span class="main">=</span> <span class="quoted">Determinant.det</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"transpose_mat"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"four_block_mat <span class="free">A1</span> <span class="free">A2</span> <span class="free">A3</span> <span class="free">A4</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">+</span> <span class="free">m</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> A3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A3</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A30 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">∈</span> carrier_mat <span class="var">?k</span> <span class="var">?k</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> four_block_carrier_mat<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A1 A4<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?det</span> <span class="var">?A</span> <span class="main">=</span> <span class="var">?det</span> <span class="main">(</span><span class="var">?t</span> <span class="var">?A</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Determinant.det_transpose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="var">?A</span> <span class="main">=</span> four_block_mat <span class="main">(</span><span class="var">?t</span> <span class="free">A1</span><span class="main">)</span> <span class="main">(</span><span class="var">?t</span> <span class="free">A3</span><span class="main">)</span> <span class="main">(</span><span class="var">?t</span> <span class="free">A2</span><span class="main">)</span> <span class="main">(</span><span class="var">?t</span> <span class="free">A4</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> transpose_four_block_mat<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A1 A2 A3 A4<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?det</span> <span class="main">…</span> <span class="main">=</span> <span class="var">?det</span> <span class="main">(</span><span class="var">?t</span> <span class="free">A1</span><span class="main">)</span> <span class="main">*</span> <span class="var">?det</span> <span class="main">(</span><span class="var">?t</span> <span class="free">A4</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> det_four_block_mat_upper_right_zero<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A1 A2 A30 A4<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?det</span> <span class="main">(</span><span class="var">?t</span> <span class="free">A1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?det</span> <span class="free">A1</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Determinant.det_transpose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?det</span> <span class="main">(</span><span class="var">?t</span> <span class="free">A4</span><span class="main">)</span> <span class="main">=</span> <span class="var">?det</span> <span class="free">A4</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Determinant.det_transpose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A4<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> char_poly_matrix_four_block_mat<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> 
      A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A1</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A2</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">m</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> A3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A3</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A4</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"char_poly_matrix <span class="main">(</span>four_block_mat <span class="free">A1</span> <span class="free">A2</span> <span class="free">A3</span> <span class="free">A4</span><span class="main">)</span> <span class="main">=</span> 
  four_block_mat <span class="main">(</span>char_poly_matrix <span class="free">A1</span><span class="main">)</span> <span class="main">(</span>map_mat <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span><span class="bound">x</span><span class="main">:]</span><span class="main">)</span> <span class="free">A2</span><span class="main">)</span> 
    <span class="main">(</span>map_mat <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span><span class="bound">x</span><span class="main">:]</span><span class="main">)</span> <span class="free">A3</span><span class="main">)</span> <span class="main">(</span>char_poly_matrix <span class="free">A4</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A1 A4 
  <span class="keyword1"><span class="command">have</span></span> dim<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="free">A1</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="free">A1</span> <span class="main">=</span> <span class="free">n</span>"</span></span> 
      <span class="quoted"><span class="quoted">"dim_row <span class="free">A4</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="free">A4</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> char_poly_matrix_def four_block_mat_def Let_def dim
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A2 A3<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> char_poly_four_block_mat_lower_left_zero<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> idom mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> four_block_mat <span class="free">B</span> <span class="free">C</span> <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">m</span> <span class="free">n</span><span class="main">)</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"char_poly <span class="free">A</span> <span class="main">=</span> char_poly <span class="free">B</span> <span class="main">*</span> char_poly <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> A char_poly_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> char_poly_matrix_four_block_mat<span class="main"><span class="main">[</span></span><span class="operator">OF</span> B C _ D<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> 
     <span class="operator">rule</span> det_four_block_mat_lower_left_zero<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> B C D<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> elements_mat_permutes<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">permutes</span> <span class="main">{..&lt;</span> <span class="free">n</span><span class="main">}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> Matrix.mat <span class="free">n</span> <span class="free">n</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">p</span> <span class="bound">i</span><span class="main">,</span> <span class="free">p</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"elements_mat <span class="free">A</span> <span class="main">=</span> elements_mat <span class="free">B</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A B <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="free">A</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="free">A</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="free">B</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="free">B</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inv <span class="free">p</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> permutes_lt<span class="main">[</span><span class="operator">OF</span> p<span class="main">]</span> ij <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> permutes_lt<span class="main">[</span><span class="operator">OF</span> permutes_inv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p<span class="main"><span class="main">]</span></span><span class="main">]</span> ij <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i'</span> <span class="bound">j'</span><span class="main">.</span> <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i'</span><span class="main">,</span><span class="bound">j'</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">i'</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">j'</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> 
       <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i'</span> <span class="bound">j'</span><span class="main">.</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i'</span><span class="main">,</span><span class="bound">j'</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">i'</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">j'</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="skolem">i</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="skolem">j</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ij *<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> B<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="skolem">i</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="skolem">j</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ** p<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> B permutes_inverses<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> elements_mat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> elements_mat_four_block_mat_supseteq<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A1</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A2</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">m</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> A3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A3</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A4</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"elements_mat <span class="main">(</span>four_block_mat <span class="free">A1</span> <span class="free">A2</span> <span class="free">A3</span> <span class="free">A4</span><span class="main">)</span> <span class="main">⊇</span> 
  <span class="main">(</span>elements_mat <span class="free">A1</span> <span class="main">∪</span> elements_mat <span class="free">A2</span> <span class="main">∪</span> elements_mat <span class="free">A3</span> <span class="main">∪</span> elements_mat <span class="free">A4</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"four_block_mat <span class="free">A1</span> <span class="free">A2</span> <span class="free">A3</span> <span class="free">A4</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">∈</span> carrier_mat <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A1 A2 A3 A4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> A1 A4 
  <span class="keyword1"><span class="command">have</span></span> dim<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="free">A1</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="free">A1</span> <span class="main">=</span> <span class="free">n</span>"</span></span> 
      <span class="quoted"><span class="quoted">"dim_row <span class="free">A4</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="free">A4</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> elements_mat <span class="free">A1</span> <span class="main">∪</span> elements_mat <span class="free">A2</span> <span class="main">∪</span> elements_mat <span class="free">A3</span> <span class="main">∪</span> elements_mat <span class="free">A4</span>"</span></span> 
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> elements_mat <span class="free">A1</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> elements_mat<span class="main">]</span> A1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">A1</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
      ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="var">?A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ij <span class="keyword1"><span class="command">unfolding</span></span> x four_block_mat_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> elements_matI<span class="main">[</span><span class="operator">OF</span> A _ _ this<span class="main">]</span> ij <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> elements_mat <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> 
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> elements_mat <span class="free">A2</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> elements_mat<span class="main">]</span> A2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">A2</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
      ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="var">?A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ij <span class="keyword1"><span class="command">unfolding</span></span> x four_block_mat_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> elements_matI<span class="main">[</span><span class="operator">OF</span> A _ _ this<span class="main">]</span> ij <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> elements_mat <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> elements_mat <span class="free">A3</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> elements_mat<span class="main">]</span> A3 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">A3</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
      ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="var">?A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="free">n</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ij <span class="keyword1"><span class="command">unfolding</span></span> x four_block_mat_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> elements_matI<span class="main">[</span><span class="operator">OF</span> A _ _ this<span class="main">]</span> ij <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> elements_mat <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> elements_mat <span class="free">A4</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> elements_mat<span class="main">]</span> A4 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">A4</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
      ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="var">?A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="free">n</span><span class="main">,</span><span class="skolem">j</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ij <span class="keyword1"><span class="command">unfolding</span></span> x four_block_mat_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> elements_matI<span class="main">[</span><span class="operator">OF</span> A _ _ this<span class="main">]</span> ij <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> elements_mat <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> elements_mat <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
      

<span class="keyword1"><span class="command">lemma</span></span> non_irreducible_mat_split<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> idom mat"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> not<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> irreducible_mat <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n1</span> <span class="bound">n2</span> <span class="bound">B</span> <span class="bound">B1</span> <span class="bound">B2</span> <span class="bound">B4</span><span class="main">.</span> similar_mat <span class="free">A</span> <span class="bound">B</span> <span class="main">∧</span> elements_mat <span class="free">A</span> <span class="main">=</span> elements_mat <span class="bound">B</span> <span class="main">∧</span>
       <span class="bound">B</span> <span class="main">=</span> four_block_mat <span class="bound">B1</span> <span class="bound">B2</span> <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">n2</span> <span class="bound">n1</span><span class="main">)</span> <span class="bound">B4</span> <span class="main">∧</span>  
       <span class="bound">B1</span> <span class="main">∈</span> carrier_mat <span class="bound">n1</span> <span class="bound">n1</span> <span class="main">∧</span> <span class="bound">B2</span> <span class="main">∈</span> carrier_mat <span class="bound">n1</span> <span class="bound">n2</span> <span class="main">∧</span> <span class="bound">B4</span> <span class="main">∈</span> carrier_mat <span class="bound">n2</span> <span class="bound">n2</span> <span class="main">∧</span>
       <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">n1</span> <span class="main">∧</span> <span class="bound">n1</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">n2</span> <span class="main">∧</span> <span class="bound">n2</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">n1</span> <span class="main">+</span> <span class="bound">n2</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="free">A</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"graph_of_mat <span class="free">A</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?reachp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?G</span><span class="main">^+</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?reach</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?G</span><span class="main">^*</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">¬</span> <span class="var">?reach</span> <span class="bound">i</span> <span class="bound">j</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> reach<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="var">?reach</span> <span class="bound">i</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> not<span class="main">[</span><span class="operator">unfolded</span> irreducible_mat_def Let_def<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nreach<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?reachp</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> reach<span class="main">[</span><span class="operator">OF</span> i j<span class="main">]</span> nreach <span class="keyword1"><span class="command">have</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rtrancl_eq_or_trancl<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> n j <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> reach<span class="main">[</span><span class="operator">OF</span> j k<span class="main">]</span> diff reach<span class="main">[</span><span class="operator">OF</span> k j<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?reachp</span> <span class="skolem">j</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rtrancl_eq_or_trancl<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> nreach ij <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nreach<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?reach</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> <span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="var">?reach</span> <span class="skolem">i</span> <span class="bound">k</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> iI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">using</span></span> nreach i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> jI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∉</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">using</span></span> nreach j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">]</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> mset_eq_permutation<span class="main">[</span><span class="operator">OF</span> mset_sort<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">permutes</span> <span class="main">{..&lt;</span> <span class="free">n</span><span class="main">}</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> perm<span class="main">:</span> <span class="quoted"><span class="quoted">"permute_list <span class="skolem">p</span> <span class="var">?xs</span> <span class="main">=</span> sort_key <span class="skolem">f</span> <span class="var">?xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> lt<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="skolem">p</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> permutes_lt<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inv <span class="skolem">p</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> ip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="keyword1">permutes</span> <span class="main">{..&lt;</span> <span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> permutes_inv<span class="main">[</span><span class="operator">OF</span> p<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> ip <span class="keyword1"><span class="command">have</span></span> ilt<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="var">?p</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> permutes_lt<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Matrix.mat <span class="free">n</span> <span class="free">n</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">p</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">p</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="var">?B</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> permutation_similar_mat<span class="main">[</span><span class="operator">OF</span> A p<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> sim<span class="main">:</span> <span class="quoted"><span class="quoted">"similar_mat <span class="free">A</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ys</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"permute_list <span class="skolem">p</span> <span class="var">?xs</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="var">?ys</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> len_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ys</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ys_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="var">?k</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> kn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> k_def <span class="keyword1"><span class="command">using</span></span> len_ys 
    <span class="keyword1"><span class="command">using</span></span> length_filter_le<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ys_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="skolem">ys</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">p</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">unfolding</span></span> ys_def permute_list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> len_ys<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_nth<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map <span class="skolem">p</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> map_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ys_p<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">k</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> kn
    <span class="keyword1"><span class="command">using</span></span> le_Suc_ex upt_add_eq_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> map <span class="skolem">p</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">@</span> map <span class="skolem">p</span> <span class="main">[</span><span class="skolem">k</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>    
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"filter <span class="var">?g</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> pi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> length <span class="main">(</span><span class="var">?f</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>    
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="var">?f</span> <span class="main">(</span>map <span class="skolem">p</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">k</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="var">?f</span> <span class="main">(</span>map <span class="skolem">p</span> <span class="main">[</span><span class="skolem">k</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ys <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> k <span class="main">=</span> calculation
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">True</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> perm<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">folded</span> ys_def<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map <span class="skolem">f</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sorted_sort_key <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> ys map_append sorted_append set_map<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> sorted<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">p</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">p</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">k</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">p</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span><span class="skolem">p</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span><span class="skolem">p</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> sorted<span class="main">[</span><span class="operator">OF</span> i<span class="main">,</span> <span class="operator">unfolded</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">p</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">p</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> f_def 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">(</span>map <span class="skolem">p</span> <span class="main">[</span><span class="skolem">k</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> k<span class="main">[</span><span class="operator">unfolded</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="var">?f</span> <span class="main">(</span>map <span class="skolem">p</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
      <span class="keyword1"><span class="command">from</span></span> length_filter_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"map <span class="skolem">p</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="skolem">k</span><span class="main">]</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span><span class="main">,</span> <span class="operator">unfolded</span> this<span class="main">]</span> i zero
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">(</span>map <span class="skolem">p</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> map <span class="skolem">p</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> k<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> this<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">set</span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span> <span class="main">..&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">p</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">p</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">p</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> 0<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> main<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?p</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="skolem">i</span>"</span></span><span class="main">]</span> i p 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutes_inverses<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="main">⟷</span> <span class="skolem">f</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟷</span> <span class="var">?p</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> main <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="main">⟷</span> <span class="var">?p</span> <span class="skolem">i</span> <span class="main">≥</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> main<span class="main">[</span><span class="operator">OF</span> j<span class="main">]</span> jI
  <span class="keyword1"><span class="command">have</span></span> k0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> iI main<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="skolem">i</span> <span class="main">≥</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> ilt<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> kn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> 
    <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ik<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> jk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> kn <span class="keyword1"><span class="command">have</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> jI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">j</span> <span class="main">∉</span> <span class="skolem">I</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> main<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> jk j p<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutes_inverses<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> iI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> main<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i ik p<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutes_inverses<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> i j <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">p</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">p</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">p</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">p</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">p</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?G</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> graph_of_mat_def Let_def <span class="keyword1"><span class="command">using</span></span> i j p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> iI j <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> jI <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> zero <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> dimB<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">B</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="skolem">B</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> dim<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">B</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="skolem">B</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> kn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B1</span></span> <span class="skolem"><span class="skolem">B2</span></span> <span class="skolem"><span class="skolem">B3</span></span> <span class="skolem"><span class="skolem">B4</span></span> <span class="keyword2"><span class="keyword">where</span></span> spl<span class="main">:</span> <span class="quoted"><span class="quoted">"split_block <span class="skolem">B</span> <span class="skolem">k</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">B1</span><span class="main">,</span><span class="skolem">B2</span><span class="main">,</span><span class="skolem">B3</span><span class="main">,</span><span class="skolem">B4</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?tmp</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?tmp</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>  
  <span class="keyword1"><span class="command">from</span></span> split_block<span class="main">[</span><span class="operator">OF</span> this dim<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
    Bs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B1</span> <span class="main">∈</span> carrier_mat <span class="skolem">k</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B2</span> <span class="main">∈</span> carrier_mat <span class="skolem">k</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">B3</span> <span class="main">∈</span> carrier_mat <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B4</span> <span class="main">∈</span> carrier_mat <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> four_block_mat <span class="skolem">B1</span> <span class="skolem">B2</span> <span class="skolem">B3</span> <span class="skolem">B4</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> B3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B3</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> spl<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">B</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">B</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> split<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> split_block_def Let_def split
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> kn zero<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> elements_mat_permutes<span class="main">[</span><span class="operator">OF</span> p A B_def<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> elem<span class="main">:</span> <span class="quoted"><span class="quoted">"elements_mat <span class="free">A</span> <span class="main">=</span> elements_mat <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sim<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> elem<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> B<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> B3<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> Bs k0 kn<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> non_irreducible_nonneg_mat_split<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linordered_idom mat"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_mat <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> not<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> irreducible_mat <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">n1</span> <span class="bound">n2</span> <span class="bound">A1</span> <span class="bound">A2</span><span class="main">.</span> char_poly <span class="free">A</span> <span class="main">=</span> char_poly <span class="bound">A1</span> <span class="main">*</span> char_poly <span class="bound">A2</span> 
    <span class="main">∧</span> nonneg_mat <span class="bound">A1</span> <span class="main">∧</span> nonneg_mat <span class="bound">A2</span>
    <span class="main">∧</span> <span class="bound">A1</span> <span class="main">∈</span> carrier_mat <span class="bound">n1</span> <span class="bound">n1</span> <span class="main">∧</span> <span class="bound">A2</span> <span class="main">∈</span> carrier_mat <span class="bound">n2</span> <span class="bound">n2</span>
    <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">n1</span> <span class="main">∧</span> <span class="bound">n1</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">n2</span> <span class="main">∧</span> <span class="bound">n2</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">n1</span> <span class="main">+</span> <span class="bound">n2</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> non_irreducible_mat_split<span class="main">[</span><span class="operator">OF</span> A not n<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n1</span></span> <span class="skolem"><span class="skolem">n2</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">B1</span></span> <span class="skolem"><span class="skolem">B2</span></span> <span class="skolem"><span class="skolem">B4</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> sim<span class="main">:</span> <span class="quoted"><span class="quoted">"similar_mat <span class="free">A</span> <span class="skolem">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> elem<span class="main">:</span> <span class="quoted"><span class="quoted">"elements_mat <span class="free">A</span> <span class="main">=</span> elements_mat <span class="skolem">B</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> four_block_mat <span class="skolem">B1</span> <span class="skolem">B2</span> <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">n2</span> <span class="skolem">n1</span><span class="main">)</span> <span class="skolem">B4</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> Bs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B1</span> <span class="main">∈</span> carrier_mat <span class="skolem">n1</span> <span class="skolem">n1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B2</span> <span class="main">∈</span> carrier_mat <span class="skolem">n1</span> <span class="skolem">n2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B4</span> <span class="main">∈</span> carrier_mat <span class="skolem">n2</span> <span class="skolem">n2</span>"</span></span> 
     <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">n1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">n2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n2</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">+</span> <span class="skolem">n2</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> char_poly_similar<span class="main">[</span><span class="operator">OF</span> sim<span class="main">]</span> 
  <span class="keyword1"><span class="command">have</span></span> AB<span class="main">:</span> <span class="quoted"><span class="quoted">"char_poly <span class="free">A</span> <span class="main">=</span> char_poly <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> nonneg <span class="keyword1"><span class="command">have</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_mat <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> nonneg_mat_def elem <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> cB<span class="main">:</span> <span class="quoted"><span class="quoted">"char_poly <span class="skolem">B</span> <span class="main">=</span> char_poly <span class="skolem">B1</span> <span class="main">*</span> char_poly <span class="skolem">B4</span>"</span></span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> char_poly_four_block_mat_lower_left_zero<span class="main"><span class="main">[</span></span><span class="operator">OF</span> B Bs<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> nonneg <span class="keyword1"><span class="command">have</span></span> B1_B4<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_mat <span class="skolem">B1</span>"</span></span> <span class="quoted"><span class="quoted">"nonneg_mat <span class="skolem">B4</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> B nonneg_mat_def
    <span class="keyword1"><span class="command">using</span></span> elements_mat_four_block_mat_supseteq<span class="main">[</span><span class="operator">OF</span> Bs<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> _ Bs<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">n2</span> <span class="skolem">n1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> AB<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> cB<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> B1_B4<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> B1_B4<span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">rule</span> Bs<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Bs<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> n<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The main generalized theorem. The characteristic polynomial of a non-negative
  real matrix can be represented as a product of roots of unitys (scaled by the 
  the spectral radius sr) and a polynomial where all roots are smaller than the
  spectral radius.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> perron_frobenius_nonneg<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real Matrix.mat"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_mat <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">sr</span> <span class="bound">ks</span> <span class="bound">f</span><span class="main">.</span> 
    <span class="bound">sr</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∧</span> 
    <span class="main">0</span> <span class="main">∉</span> set <span class="bound">ks</span> <span class="main">∧</span> <span class="bound">ks</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
    char_poly <span class="free">A</span> <span class="main">=</span> prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> monom <span class="main">1</span> <span class="bound">k</span> <span class="main">-</span> <span class="main">[:</span><span class="bound">sr</span> <span class="main">^</span> <span class="bound">k</span><span class="main">:]</span><span class="main">)</span> <span class="bound">ks</span><span class="main">)</span> <span class="main">*</span> <span class="bound">f</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>map_poly complex_of_real <span class="bound">f</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> cmod <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">sr</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">sr</span> <span class="bound">k</span><span class="main">.</span> monom <span class="main">1</span> <span class="bound">k</span> <span class="main">-</span> <span class="main">[:</span> <span class="main">(</span><span class="bound">sr</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">^</span> <span class="bound">k</span><span class="main">:]</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?small</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">f</span> <span class="bound">sr</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>map_poly complex_of_real <span class="bound">f</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> cmod <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">sr</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?wit</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">A</span> <span class="bound">sr</span> <span class="bound">ks</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">sr</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">∉</span> set <span class="bound">ks</span> <span class="main">∧</span> <span class="bound">ks</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
    char_poly <span class="bound">A</span> <span class="main">=</span> prod_list <span class="main">(</span>map <span class="main">(</span><span class="skolem">p</span> <span class="bound">sr</span><span class="main">)</span> <span class="bound">ks</span><span class="main">)</span> <span class="main">*</span> <span class="bound">f</span> <span class="main">∧</span> <span class="var">?small</span> <span class="bound">f</span> <span class="bound">sr</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"complex_of_real"</span></span> 
  <span class="keyword1"><span class="command">interpret</span></span> c<span class="main">:</span> field_hom <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> p<span class="main">:</span> map_poly_inj_idom_divide_hom <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> map_p<span class="main">:</span> <span class="quoted"><span class="quoted">"map_poly <span class="var">?c</span> <span class="main">(</span><span class="skolem">p</span> <span class="skolem">sr</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>monom <span class="main">1</span> <span class="skolem">k</span> <span class="main">-</span> <span class="main">[:</span><span class="var">?c</span> <span class="skolem">sr</span><span class="main">^</span><span class="skolem">k</span><span class="main">:]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">sr</span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">unfolding</span></span> p_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  <span class="dynamic"><span class="dynamic">hom_distribs</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">x</span> <span class="skolem">sr</span>
    <span class="keyword3"><span class="command">assume</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>map_poly <span class="var">?c</span> <span class="main">(</span><span class="skolem">p</span> <span class="skolem">sr</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sr</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">note</span></span> 0 <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> map_p    
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">^</span><span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="var">?c</span> <span class="skolem">sr</span><span class="main">)</span><span class="main">^</span><span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_monom<span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">c</span><span class="main">.</span> root <span class="skolem">k</span> <span class="main">(</span>cmod <span class="bound">c</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> norm_power<span class="main">]</span> k
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">x</span> <span class="main">=</span> cmod <span class="main">(</span><span class="var">?c</span> <span class="skolem">sr</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> real_root_pos2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">sr</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">sr</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> p_conv <span class="main">=</span> this  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">sr</span> <span class="bound">ks</span> <span class="bound">f</span><span class="main">.</span> <span class="var">?wit</span> <span class="free">A</span> <span class="bound">sr</span> <span class="bound">ks</span> <span class="bound">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A pos n
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">n</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> pos <span class="main">=</span> less<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> A <span class="main">=</span> less<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> less<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> n <span class="main">=</span> less<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> n 
    <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="main">|</span> <span class="main">(</span>irr<span class="main">)</span> <span class="quoted"><span class="quoted">"irreducible_mat <span class="skolem">A</span>"</span></span> 
      <span class="main">|</span> <span class="main">(</span>red<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> irreducible_mat <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">sr</span> <span class="bound">ks</span> <span class="bound">f</span><span class="main">.</span> <span class="var">?wit</span> <span class="skolem">A</span> <span class="bound">sr</span> <span class="bound">ks</span> <span class="bound">f</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> irr
      <span class="keyword1"><span class="command">from</span></span> perron_frobenius_irreducible<span class="main">(</span>3<span class="main">,</span>6<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> A n pos irr refl refl<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sr</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sr</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"char_poly <span class="skolem">A</span> <span class="main">=</span> <span class="skolem">p</span> <span class="skolem">sr</span> <span class="skolem">k</span> <span class="main">*</span> <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?small</span> <span class="skolem">f</span> <span class="skolem">sr</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?wit</span> <span class="skolem">A</span> <span class="skolem">sr</span> <span class="main">[</span><span class="skolem">k</span><span class="main">]</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> red
      <span class="keyword1"><span class="command">from</span></span> non_irreducible_nonneg_mat_split<span class="main">[</span><span class="operator">OF</span> A pos red<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n1</span></span> <span class="skolem"><span class="skolem">n2</span></span> <span class="skolem"><span class="skolem">A1</span></span> <span class="skolem"><span class="skolem">A2</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> char<span class="main">:</span>  <span class="quoted"><span class="quoted">"char_poly <span class="skolem">A</span> <span class="main">=</span> char_poly <span class="skolem">A1</span> <span class="main">*</span> char_poly <span class="skolem">A2</span>"</span></span> 
          <span class="keyword2"><span class="keyword">and</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_mat <span class="skolem">A1</span>"</span></span> <span class="quoted"><span class="quoted">"nonneg_mat <span class="skolem">A2</span>"</span></span> 
          <span class="keyword2"><span class="keyword">and</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A1</span> <span class="main">∈</span> carrier_mat <span class="skolem">n1</span> <span class="skolem">n1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A2</span> <span class="main">∈</span> carrier_mat <span class="skolem">n2</span> <span class="skolem">n2</span>"</span></span> 
          <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n2</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> 
          <span class="keyword2"><span class="keyword">and</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n2</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="operator">OF</span> n<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> A<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pos<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> n0<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sr1</span></span> <span class="skolem"><span class="skolem">ks1</span></span> <span class="skolem"><span class="skolem">f1</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?wit</span> <span class="skolem">A1</span> <span class="skolem">sr1</span> <span class="skolem">ks1</span> <span class="skolem">f1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="operator">OF</span> n<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> A<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> pos<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> n0<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sr2</span></span> <span class="skolem"><span class="skolem">ks2</span></span> <span class="skolem"><span class="skolem">f2</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?wit</span> <span class="skolem">A2</span> <span class="skolem">sr2</span> <span class="skolem">ks2</span> <span class="skolem">f2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">A1</span> <span class="bound">A2</span> <span class="bound">sr1</span> <span class="bound">ks1</span> <span class="bound">f1</span> <span class="bound">sr2</span> <span class="bound">ks2</span> <span class="bound">f2</span><span class="main">.</span> <span class="var">?wit</span> <span class="bound">A1</span> <span class="bound">sr1</span> <span class="bound">ks1</span> <span class="bound">f1</span> <span class="main">∧</span> <span class="var">?wit</span> <span class="bound">A2</span> <span class="bound">sr2</span> <span class="bound">ks2</span> <span class="bound">f2</span> <span class="main">∧</span> 
         <span class="bound">sr1</span> <span class="main">≥</span> <span class="bound">sr2</span> <span class="main">∧</span> char_poly <span class="skolem">A</span> <span class="main">=</span> char_poly <span class="bound">A1</span> <span class="main">*</span> char_poly <span class="bound">A2</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">sr1</span> <span class="main">≥</span> <span class="skolem">sr2</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> char
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 1 conjI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 2<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> True<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> char
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 2 conjI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 1<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> False<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A1</span></span> <span class="skolem"><span class="skolem">A2</span></span> <span class="skolem"><span class="skolem">sr1</span></span> <span class="skolem"><span class="skolem">ks1</span></span> <span class="skolem"><span class="skolem">f1</span></span> <span class="skolem"><span class="skolem">sr2</span></span> <span class="skolem"><span class="skolem">ks2</span></span> <span class="skolem"><span class="skolem">f2</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?wit</span> <span class="skolem">A1</span> <span class="skolem">sr1</span> <span class="skolem">ks1</span> <span class="skolem">f1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?wit</span> <span class="skolem">A2</span> <span class="skolem">sr2</span> <span class="skolem">ks2</span> <span class="skolem">f2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
        sr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sr1</span> <span class="main">≥</span> <span class="skolem">sr2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> char<span class="main">:</span> <span class="quoted"><span class="quoted">"char_poly <span class="skolem">A</span> <span class="main">=</span> char_poly <span class="skolem">A1</span> <span class="main">*</span> char_poly <span class="skolem">A2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">sr1</span> <span class="main">=</span> <span class="skolem">sr2</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?wit</span> <span class="skolem">A</span> <span class="skolem">sr2</span> <span class="main">(</span><span class="skolem">ks1</span> <span class="main">@</span> <span class="skolem">ks2</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f1</span> <span class="main">*</span> <span class="skolem">f2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> char
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> 1 2 True<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> True p.hom_mult<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> sr <span class="keyword1"><span class="command">have</span></span> sr1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sr1</span> <span class="main">&gt;</span> <span class="skolem">sr2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>         
        <span class="keyword1"><span class="command">have</span></span> lt<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>map_poly <span class="var">?c</span> <span class="main">(</span><span class="skolem">p</span> <span class="skolem">sr2</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="skolem">k</span> <span class="main">∈</span> set <span class="skolem">ks2</span> <span class="main">⟹</span> cmod <span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">sr1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="skolem">x</span>
          <span class="keyword1"><span class="command">using</span></span> sr1 p_conv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">sr2</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?wit</span> <span class="skolem">A</span> <span class="skolem">sr1</span> <span class="skolem">ks1</span> <span class="main">(</span><span class="skolem">f1</span> <span class="main">*</span> <span class="skolem">f2</span> <span class="main">*</span> prod_list <span class="main">(</span>map <span class="main">(</span><span class="skolem">p</span> <span class="skolem">sr2</span><span class="main">)</span> <span class="skolem">ks2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> char
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> 1 2 sr1 lt<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p.hom_mult p.hom_prod_list 
          poly_prod_list prod_list_zero_iff<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">$$</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> Matrix.mat <span class="main">1</span> <span class="main">1</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> a_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A 1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> char<span class="main">:</span> <span class="quoted"><span class="quoted">"char_poly <span class="skolem">A</span> <span class="main">=</span> <span class="main">[:</span> <span class="main">-</span> <span class="skolem">a</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A  
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Determinant.det_def char_poly_def char_poly_matrix_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> pos A <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> nonneg_mat_def elements_mat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?wit</span> <span class="skolem">A</span> <span class="skolem">a</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> char <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p_def monom_Suc<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sr</span></span> <span class="skolem"><span class="skolem">ks</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> wit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?wit</span> <span class="free">A</span> <span class="skolem">sr</span> <span class="skolem">ks</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> wit <span class="keyword1"><span class="command">unfolding</span></span> p_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹And back to HMA world via transfer.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> perron_frobenius_non_neg<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"non_neg_mat <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">sr</span> <span class="bound">ks</span> <span class="bound">f</span><span class="main">.</span> 
    <span class="bound">sr</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∧</span> 
    <span class="main">0</span> <span class="main">∉</span> set <span class="bound">ks</span> <span class="main">∧</span> <span class="bound">ks</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
    charpoly <span class="free">A</span> <span class="main">=</span> prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> monom <span class="main">1</span> <span class="bound">k</span> <span class="main">-</span> <span class="main">[:</span><span class="bound">sr</span> <span class="main">^</span> <span class="bound">k</span><span class="main">:]</span><span class="main">)</span> <span class="bound">ks</span><span class="main">)</span> <span class="main">*</span> <span class="bound">f</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>map_poly complex_of_real <span class="bound">f</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> cmod <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">sr</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> pos
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> perron_frobenius_nonneg<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now specialize the theorem for complexity analysis where
  we are mainly interested in the case where the spectral radius is as most 1.
  Note that this can be checked by tested that there are no real roots of the
  characteristic polynomial which exceed 1.

  Moreover, here the existential quantifier over the factorization is replaced
  by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> decompose_prod_root_unity<span class="antiquote"><span class="antiquote">}</span></span></span></span>, an algorithm which computes this factorization 
  in an efficient way.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> perron_frobenius_for_complexity<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real poly"</span></span> 
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">cA</span> <span class="main">≡</span> map_matrix complex_of_real <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">cf</span> <span class="main">≡</span> map_poly complex_of_real <span class="free">f</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"non_neg_mat <span class="free">A</span>"</span></span> 
   <span class="keyword2"><span class="keyword">and</span></span> sr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"decompose_prod_root_unity <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ks</span><span class="main">,</span> <span class="free">f</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> set <span class="free">ks</span>"</span></span> 
   <span class="quoted"><span class="quoted">"charpoly <span class="free">A</span> <span class="main">=</span> prod_root_unity <span class="free">ks</span> <span class="main">*</span> <span class="free">f</span>"</span></span>
   <span class="quoted"><span class="quoted">"charpoly <span class="free">cA</span> <span class="main">=</span> prod_root_unity <span class="free">ks</span> <span class="main">*</span> <span class="free">cf</span>"</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>charpoly <span class="free">cA</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> cmod <span class="bound">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> 
   <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> poly <span class="free">cf</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> cmod <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> 
   <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> cmod <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> order <span class="bound">x</span> <span class="main">(</span>charpoly <span class="free">cA</span><span class="main">)</span> <span class="main">=</span> length <span class="main">[</span><span class="bound">k</span><span class="main">←</span><span class="free">ks</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span>"</span></span> 
   <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> cmod <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> poly <span class="main">(</span>charpoly <span class="free">cA</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">k</span> <span class="main">∈</span> set <span class="free">ks</span><span class="main">.</span> <span class="bound">x</span><span class="main">^</span><span class="bound">k</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> cf_def cA_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span><span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"complex_of_real"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_poly <span class="var">?c</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_matrix <span class="var">?c</span> <span class="free">A</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?wit</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">ks</span> <span class="bound">f</span><span class="main">.</span> <span class="main">0</span> <span class="main">∉</span> set <span class="bound">ks</span> <span class="main">∧</span> 
    charpoly <span class="free">A</span> <span class="main">=</span> prod_root_unity <span class="bound">ks</span> <span class="main">*</span> <span class="bound">f</span> <span class="main">∧</span>
    charpoly <span class="var">?A</span> <span class="main">=</span> prod_root_unity <span class="bound">ks</span> <span class="main">*</span> map_poly of_real <span class="bound">f</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>charpoly <span class="var">?A</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> cmod <span class="bound">x</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span><span class="var">?cp</span> <span class="bound">f</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> cmod <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">interpret</span></span> field_hom <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> p<span class="main">:</span> map_poly_inj_idom_divide_hom <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> perron_frobenius_non_neg<span class="main">[</span><span class="operator">OF</span> pos<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sr</span></span> <span class="skolem"><span class="skolem">ks</span></span> <span class="skolem"><span class="skolem">f</span></span> 
      <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sr</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> set <span class="skolem">ks</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ks</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> 
       <span class="keyword2"><span class="keyword">and</span></span> cp<span class="main">:</span> <span class="quoted"><span class="quoted">"charpoly <span class="free">A</span> <span class="main">=</span> prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> monom <span class="main">1</span> <span class="bound">k</span> <span class="main">-</span> <span class="main">[:</span><span class="skolem">sr</span> <span class="main">^</span> <span class="bound">k</span><span class="main">:]</span><span class="main">)</span> <span class="skolem">ks</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">f</span>"</span></span> 
       <span class="keyword2"><span class="keyword">and</span></span> small<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span><span class="var">?cp</span> <span class="skolem">f</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> cmod <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">sr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> cp<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"map_poly <span class="var">?c</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> cpc<span class="main">:</span> <span class="quoted"><span class="quoted">"charpoly <span class="var">?A</span> <span class="main">=</span> prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> monom <span class="main">1</span> <span class="bound">k</span> <span class="main">-</span> <span class="main">[:</span><span class="var">?c</span> <span class="skolem">sr</span> <span class="main">^</span> <span class="bound">k</span><span class="main">:]</span><span class="main">)</span> <span class="skolem">ks</span><span class="main">)</span> <span class="main">*</span> map_poly <span class="var">?c</span> <span class="skolem">f</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> charpoly_of_real <span class="dynamic"><span class="dynamic">hom_distribs</span></span> p.prod_list_map_hom<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> o_def<span class="main">)</span>  
    <span class="keyword1"><span class="command">have</span></span> sr_le_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sr</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sr<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> cp<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> *<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">ks</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> poly_monom<span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> prod_list_zero_iff o_def poly_monom
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>charpoly <span class="var">?A</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> cpc poly_mult poly_prod_list<span class="main">]</span> small<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>lt<span class="main">)</span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">sr</span>"</span></span> <span class="main">|</span> <span class="main">(</span>mem<span class="main">)</span> <span class="skolem">k</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> set <span class="skolem">ks</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="var">?c</span> <span class="skolem">sr</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">sr</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mem <span class="skolem">k</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">with</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> mem<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> root <span class="skolem">k</span> <span class="main">(</span>cmod <span class="bound">x</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> norm_power<span class="main">]</span> 
          real_root_pos2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> *<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">sr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> root <span class="main">=</span> this
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">ks</span> <span class="bound">f</span><span class="main">.</span> <span class="var">?wit</span> <span class="bound">ks</span> <span class="bound">f</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">sr</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False    
      <span class="keyword1"><span class="command">with</span></span> sr_le_1 <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">sr</span> <span class="main">⟹</span> cmod <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">sr</span> <span class="main">⟹</span> cmod <span class="skolem">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted">Nil</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"charpoly <span class="free">A</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> * root<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_root_unity_def charpoly_of_real<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> sr<span class="main">:</span> True
      <span class="keyword1"><span class="command">from</span></span> * cp cpc small root
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sr root_unity_def prod_root_unity_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pCons_one<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ks</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> wit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?wit</span> <span class="skolem">Ks</span> <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> cA0<span class="main">:</span> <span class="quoted"><span class="quoted">"charpoly <span class="var">?A</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> degree_monic_charpoly<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> wit <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"charpoly <span class="var">?A</span> <span class="main">=</span> prod_root_unity <span class="skolem">Ks</span> <span class="main">*</span> <span class="var">?cp</span> <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> of_real_hom.hom_decompose_prod_root_unity<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"charpoly <span class="free">A</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> decomp<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> decompc<span class="main">:</span> <span class="quoted"><span class="quoted">"decompose_prod_root_unity <span class="main">(</span>charpoly <span class="var">?A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ks</span><span class="main">,</span> <span class="var">?cp</span> <span class="free">f</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> charpoly_of_real<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> wit <span class="keyword1"><span class="command">have</span></span> small<span class="main">:</span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> poly <span class="main">(</span><span class="var">?cp</span> <span class="skolem">F</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> decompose_prod_root_unity<span class="main">[</span><span class="operator">OF</span> id decompc this cA0<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"charpoly <span class="var">?A</span> <span class="main">=</span> prod_root_unity <span class="free">ks</span> <span class="main">*</span> <span class="var">?cp</span> <span class="skolem">F</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">Ks</span> <span class="main">=</span> set <span class="free">ks</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?cp</span> <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="var">?cp</span> <span class="main">(</span>prod_root_unity <span class="free">ks</span> <span class="main">*</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id 
    <span class="keyword1"><span class="command">unfolding</span></span> charpoly_of_real<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> id p.hom_mult of_real_hom.hom_prod_root_unity <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> idr<span class="main">:</span> <span class="quoted"><span class="quoted">"charpoly <span class="free">A</span> <span class="main">=</span> prod_root_unity <span class="free">ks</span> <span class="main">*</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> wit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?wit</span> <span class="free">ks</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> idc<span class="main">:</span> <span class="quoted"><span class="quoted">"charpoly <span class="var">?A</span> <span class="main">=</span> prod_root_unity <span class="free">ks</span> <span class="main">*</span> <span class="var">?cp</span> <span class="free">f</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> wit <span class="keyword1"><span class="command">unfolding</span></span> id idr <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> small<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">unfolded</span> id<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span><span class="var">?cp</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> order_0I<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> this <span class="keyword1"><span class="command">have</span></span> ord<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="skolem">x</span> <span class="main">(</span><span class="var">?cp</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cf0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?cp</span> <span class="free">f</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">x</span> <span class="main">(</span>charpoly <span class="var">?A</span><span class="main">)</span> <span class="main">=</span> order <span class="skolem">x</span> <span class="main">(</span>prod_root_unity <span class="free">ks</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> idc
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> order_mult<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> cf0 wit ord<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> length <span class="main">[</span><span class="bound">k</span><span class="main">←</span><span class="free">ks</span> <span class="main">.</span> <span class="skolem">x</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> order_prod_root_unity<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> wit<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> ord<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="skolem">x</span> <span class="main">(</span>charpoly <span class="var">?A</span><span class="main">)</span> <span class="main">=</span> length <span class="main">[</span><span class="bound">k</span><span class="main">←</span><span class="free">ks</span> <span class="main">.</span> <span class="skolem">x</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>charpoly <span class="var">?A</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">with</span></span> cA0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">x</span> <span class="main">(</span>charpoly <span class="var">?A</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> order_root <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> ord<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k</span> <span class="main">∈</span> set <span class="free">ks</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">k</span><span class="main">←</span><span class="free">ks</span> <span class="main">.</span> <span class="skolem">x</span> <span class="main">^</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> 
    <span class="keyword1"><span class="command">note</span></span> this ord
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> wit <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹and convert to JNF-world›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> perron_frobenius_for_complexity_jnf <span class="main">=</span> 
  perron_frobenius_for_complexity<span class="main">[</span><span class="operator">unfolded</span> atomize_imp atomize_all<span class="main">,</span> 
    <span class="operator">untransferred</span><span class="main">,</span> <span class="operator">cancel_card_constraint</span><span class="main">,</span> <span class="operator">rule_format</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Spectral_Radius_Theory">
<div class="head">
<h1>Theory Spectral_Radius_Theory</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Combining Spectral Radius Theory with Perron Frobenius theorem›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Spectral_Radius_Theory
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="../Polynomial_Factorization/Square_Free_Factorization.html">Polynomial_Factorization.Square_Free_Factorization</a>
  <a href="../Jordan_Normal_Form/Spectral_Radius.html">Jordan_Normal_Form.Spectral_Radius</a>
  <a href="../Jordan_Normal_Form/Char_Poly.html">Jordan_Normal_Form.Char_Poly</a>
  <a href="Perron_Frobenius.html">Perron_Frobenius</a>
  <span class="quoted">"<a href="../../HOL/HOL-Computational_Algebra/Field_as_Ring.html">HOL-Computational_Algebra.Field_as_Ring</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">spectral_radius</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">spectral_radius</span> <span class="main">≡</span> Spectral_Radius.spectral_radius"</span></span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Module.smult

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Via JNFs it has been proven that the growth of $A^k$ is polynomially bounded,
  if all complex eigenvalues have a norm at most 1, i.e., the spectral radius must be
  at most 1. Moreover, the degree of the polynomial growth can be 
  bounded by the order of those roots which have norm 1, cf. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> spectral_radius_poly_bound<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Perron Frobenius theorem tells us that for a real valued non negative matrix,
  the largest eigenvalue is a real non-negative one. Hence, we only have to check, that all real 
  eigenvalues are at most one.›</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We combine both theorems in the following. To be more precise,
  the set-based complexity results from JNFs with the type-based
  Perron Frobenius theorem in HMA are connected to obtain 
  a set based complexity criterion for real-valued
  non-negative matrices, where one only investigated the real valued eigenvalues for
  checking the eigenvalue-at-most-1 condition.  
  Here, in the precondition of the roots of the polynomial, the type-system ensures
  that we only have to look at real-valued eigenvalues, and can ignore the 
  complex-valued ones.

  The linkage between set-and type-based is performed via HMA-connect.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> perron_frobenius_spectral_radius_complex<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> real_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"real_nonneg_mat <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ev_le_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>char_poly <span class="main">(</span>map_mat Re <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ev_order<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> norm <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> order <span class="bound">x</span> <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span> <span class="bound">c2</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> norm_bound <span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="bound">c1</span> <span class="main">+</span> <span class="bound">c2</span> <span class="main">*</span> real <span class="bound">k</span> <span class="main">^</span> <span class="main">(</span><span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sr</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sr</span> <span class="main">=</span> spectral_radius <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> sr <span class="main">=</span> spectral_radius_mem_max<span class="main">[</span><span class="operator">OF</span> A n<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">,</span> <span class="operator">folded</span> sr_def<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> spectral_radius_poly_bound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> sr_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"complex_of_real"</span></span>
    <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹here is the transition from type-based perron-frobenius to set-based›</span></span>
    <span class="keyword1"><span class="command">from</span></span> perron_frobenius<span class="main">[</span><span class="operator">untransferred</span><span class="main">,</span> <span class="operator">cancel_card_constraint</span><span class="main">,</span> <span class="operator">OF</span> A real_nonneg n<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"eigenvector <span class="free">A</span> <span class="skolem">v</span> <span class="main">(</span><span class="var">?cr</span> <span class="skolem">sr</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
      rnn<span class="main">:</span> <span class="quoted"><span class="quoted">"real_nonneg_vec <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> map_mat Re <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_mat <span class="var">?cr</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> AB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> real_nonneg<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> real_nonneg_mat_def elements_mat_def<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> map_vec Re <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_vec <span class="var">?cr</span> <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> vw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="var">?v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> w_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> rnn<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> real_nonneg_vec_def vec_elements_def<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> AB vw ev <span class="keyword1"><span class="command">have</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"eigenvector <span class="var">?A</span> <span class="var">?v</span> <span class="main">(</span><span class="var">?cr</span> <span class="skolem">sr</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eigenvector <span class="skolem">B</span> <span class="skolem">w</span> <span class="skolem">sr</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> of_real_hom.eigenvector_hom_rev<span class="main"><span class="main">[</span></span><span class="operator">OF</span> B ev<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eigenvalue <span class="skolem">B</span> <span class="skolem">sr</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eigenvalue_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> ev_le_1<span class="main">[</span><span class="operator">folded</span> B_def<span class="main">,</span> <span class="operator">OF</span> this<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> eigenvalue_root_char_poly<span class="main"><span class="main">[</span></span><span class="operator">OF</span> B<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sr</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ev</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">ev</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">ev</span> <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ev_order<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> norm_bound_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemma is the same as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> perron_frobenius_spectral_radius_complex<span class="antiquote"><span class="antiquote">}</span></span></span></span>, 
  except that now the type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">real</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is used instead of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">complex</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> perron_frobenius_spectral_radius<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_mat <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ev_le_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ev_order<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">::</span> complex<span class="main">.</span> norm <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> order <span class="bound">x</span> <span class="main">(</span>map_poly of_real <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span> <span class="bound">c2</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> elements_mat <span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">k</span><span class="main">)</span> <span class="main">⟶</span> abs <span class="bound">a</span> <span class="main">≤</span> <span class="main">(</span><span class="bound">c1</span> <span class="main">+</span> <span class="bound">c2</span> <span class="main">*</span> real <span class="bound">k</span> <span class="main">^</span> <span class="main">(</span><span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"complex_of_real"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_mat <span class="var">?cr</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> rnn<span class="main">:</span> <span class="quoted"><span class="quoted">"real_nonneg_mat <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nonneg <span class="keyword1"><span class="command">unfolding</span></span> real_nonneg_mat_def nonneg_mat_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> elements_mat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"map_mat Re <span class="var">?B</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span> <span class="bound">c2</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> norm_bound <span class="main">(</span><span class="var">?B</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="bound">c1</span> <span class="main">+</span> <span class="bound">c2</span> <span class="main">*</span> real <span class="bound">k</span> <span class="main">^</span> <span class="main">(</span><span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> perron_frobenius_spectral_radius_complex<span class="main"><span class="main">[</span></span><span class="operator">OF</span> B rnn<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> id<span class="main"><span class="keyword3">,</span></span> 
    <span class="operator">insert</span> ev_le_1 ev_order<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> of_real_hom.char_poly_hom<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="keyword2"><span class="keyword">where</span></span> nb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> norm_bound <span class="main">(</span><span class="var">?B</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">c1</span> <span class="main">+</span> <span class="skolem">c2</span> <span class="main">*</span> real <span class="bound">k</span> <span class="main">^</span> <span class="main">(</span><span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">c1</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">c2</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> elements_mat <span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> pow_carrier_mat<span class="main">[</span><span class="operator">OF</span> A<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> elements_mat <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> ij nb<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">(</span><span class="var">?B</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">c1</span> <span class="main">+</span> <span class="skolem">c2</span> <span class="main">*</span> real <span class="skolem">k</span> <span class="main">^</span> <span class="main">(</span><span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> norm_bound_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?B</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="var">?cr</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> of_real_hom.mat_hom_pow<span class="main">[</span><span class="operator">OF</span> A<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> a <span class="keyword1"><span class="command">using</span></span> ij A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="var">?cr</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> abs <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"abs <span class="skolem">a</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">c1</span> <span class="main">+</span> <span class="skolem">c2</span> <span class="main">*</span> real <span class="skolem">k</span> <span class="main">^</span> <span class="main">(</span><span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can also convert the set-based lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> perron_frobenius_spectral_radius<span class="antiquote"><span class="antiquote">}</span></span></span></span>
  to a type-based version.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> perron_frobenius_spectral_type_based<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"non_neg_mat <span class="main">(</span><span class="free">A</span> <span class="main">::</span> real <span class="main">^</span> <span class="tfree">'n</span> <span class="main">^</span> <span class="tfree">'n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">::</span> complex<span class="main">.</span> norm <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> order <span class="bound">x</span> <span class="main">(</span>map_poly of_real <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span> <span class="bound">c2</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> elements_mat_h <span class="main">(</span>matpow <span class="free">A</span> <span class="bound">k</span><span class="main">)</span> <span class="main">⟶</span> abs <span class="bound">a</span> <span class="main">≤</span> <span class="main">(</span><span class="bound">c1</span> <span class="main">+</span> <span class="bound">c2</span> <span class="main">*</span> real <span class="bound">k</span> <span class="main">^</span> <span class="main">(</span><span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms perron_frobenius_spectral_radius
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹And of course, we can also transfer the type-based lemma back to a set-based setting, 
  only that -- without further case-analysis -- 
  we get the additional assumption <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">n</span></span> <span class="main"><span class="main">::</span></span> nat<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">≠</span></span> <span class="main"><span class="main">0</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nonneg_mat <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">::</span> complex<span class="main">.</span> norm <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> order <span class="bound">x</span> <span class="main">(</span>map_poly of_real <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span> <span class="bound">c2</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> elements_mat <span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">k</span><span class="main">)</span> <span class="main">⟶</span> abs <span class="bound">a</span> <span class="main">≤</span> <span class="main">(</span><span class="bound">c1</span> <span class="main">+</span> <span class="bound">c2</span> <span class="main">*</span> real <span class="bound">k</span> <span class="main">^</span> <span class="main">(</span><span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> perron_frobenius_spectral_type_based<span class="main">[</span><span class="operator">untransferred</span><span class="main">,</span> <span class="operator">cancel_card_constraint</span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
   

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note that the precondition eigenvalue-at-most-1 can easily be formulated as a cardinality
  constraints which can be decided by Sturm's theorem. 
  And in order to obtain a bound on the order, one can 
  perform a square-free-factorization (via Yun's factorization algorithm) 
  of the characteristic polynomial into
  $f_1^1 \cdot \ldots f_d^d$ where each $f_i$ has precisely the roots of order $i$.›</span></span>

<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real mat"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">fis</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_mat <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> yun<span class="main">:</span> <span class="quoted"><span class="quoted">"yun_factorization gcd <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">fis</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ev_le_1<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> yun_factorization<span class="antiquote"><span class="antiquote">}</span></span></span></span> has an offset by 1, 
  so the pair <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">f<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">i</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> set <span class="free"><span class="free">fis</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> encodes <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">f<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main"><span class="main">^</span></span><span class="main"><span class="main">(</span></span>Suc <span class="free"><span class="free">i</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> perron_frobenius_spectral_radius_yun<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> bnd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">f<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">f<span class="hidden">⇩</span><sub>i</sub></span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">fis</span> 
    <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">x</span> <span class="main">::</span> complex<span class="main">.</span> poly <span class="main">(</span>map_poly of_real <span class="bound">f<span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> norm <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> 
    <span class="main">⟹</span> Suc <span class="bound">i</span> <span class="main">≤</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span> <span class="bound">c2</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> elements_mat <span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">k</span><span class="main">)</span> <span class="main">⟶</span> abs <span class="bound">a</span> <span class="main">≤</span> <span class="main">(</span><span class="bound">c1</span> <span class="main">+</span> <span class="bound">c2</span> <span class="main">*</span> real <span class="bound">k</span> <span class="main">^</span> <span class="main">(</span><span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> perron_frobenius_spectral_radius<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A nonneg<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cr</span></span></span> <span class="main">=</span> <span class="quoted">complex_of_real</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_poly <span class="var">?cr</span> <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">complex</span>
  <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> A0<span class="main">:</span> <span class="quoted"><span class="quoted">"char_poly <span class="free">A</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> degree_monic_char_poly<span class="main">[</span><span class="operator">OF</span> A<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">interpret</span></span> field_hom_0' <span class="var"><span class="quoted"><span class="var">?cr</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> A0 <span class="keyword1"><span class="command">have</span></span> cp0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?cp</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ox</span></span> <span class="keyword2"><span class="keyword">where</span></span> ox<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="skolem">x</span> <span class="var">?cp</span> <span class="main">=</span> <span class="skolem">ox</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> sff <span class="main">=</span> square_free_factorization_order_root<span class="main">[</span><span class="operator">OF</span> yun_factorization<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> 
    yun_factorization_hom<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"char_poly <span class="free">A</span>"</span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">unfolded</span> yun map_prod_def split<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> cp0<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">ox</span></span><span class="main">,</span> <span class="operator">unfolded</span> ox<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">x</span> <span class="var">?cp</span> <span class="main">≤</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ox
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ox</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">oo</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> sff <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">fi</span></span> <span class="keyword2"><span class="keyword">where</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">fi</span><span class="main">,</span><span class="skolem">oo</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">fis</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>map_poly <span class="var">?cr</span> <span class="skolem">fi</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> bnd<span class="main">[</span><span class="operator">OF</span> mem exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">OF</span> conjI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rt x<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ox</span> <span class="main">≤</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Suc <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword3"><span class="command">assume</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?L</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ poly_roots_finite<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"char_poly <span class="free">A</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">insert</span> degree_monic_char_poly<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ev_le_1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> rt <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note that the only remaining problem in applying 
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> perron_frobenius_spectral_radius_yun<span class="antiquote"><span class="antiquote">}</span></span></span></span> is to check the
  condition <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">∃</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">::</span></span> complex<span class="main"><span class="main">.</span></span> poly <span class="main"><span class="main">(</span></span>map_poly of_real <span class="free"><span class="free">f<span class="hidden">⇩</span><sub>i</sub></span></span><span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">0</span></span> <span class="main"><span class="main">∧</span></span> norm <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  Here, there are at least three possibilities.
  First, one can just ignore this precondition and weaken the statement.
  Second, one can apply Sturm's theorem to determine whether all roots are real.
  This can be done by comparing the number of distinct real roots with the degree of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f<span class="hidden">⇩</span><sub>i</sub></span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
    since <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f<span class="hidden">⇩</span><sub>i</sub></span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is square-free. If all roots are real, then one can decide the criterion
    by checking the only two possible real roots with norm equal to 1, namely 1 and -1.
    If on the other hand there are complex roots, then we loose precision at this point.
  Third, one uses a factorization algorithm (e.g., via complex algebraic numbers) to
  precisely determine the complex roots and decide the condition.

  The second approach is illustrated in the following theorem. Note that all preconditions --
  including the ones from the context --
  can easily be checked with the help of Sturm's method.
  This method is used as a fast approximative technique in CeTA \cite{CeTA}. Only if the desired degree
  cannot be ensured by this method, the more costly complex algebraic number based 
  factorization is applied.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> perron_frobenius_spectral_radius_yun_real_roots<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> bnd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">f<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">f<span class="hidden">⇩</span><sub>i</sub></span><span class="main">,</span><span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">fis</span> 
    <span class="main">⟹</span> card <span class="main">{</span> <span class="bound">x</span><span class="main">.</span> poly <span class="bound">f<span class="hidden">⇩</span><sub>i</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">≠</span> degree <span class="bound">f<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">∨</span> poly <span class="bound">f<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> poly <span class="bound">f<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> 
    <span class="main">⟹</span> Suc <span class="bound">i</span> <span class="main">≤</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span> <span class="bound">c2</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> elements_mat <span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">k</span><span class="main">)</span> <span class="main">⟶</span> abs <span class="bound">a</span> <span class="main">≤</span> <span class="main">(</span><span class="bound">c1</span> <span class="main">+</span> <span class="bound">c2</span> <span class="main">*</span> real <span class="bound">k</span> <span class="main">^</span> <span class="main">(</span><span class="free">d</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> perron_frobenius_spectral_radius_yun<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">fi</span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cr</span></span></span> <span class="main">=</span> <span class="quoted">complex_of_real</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_poly <span class="var">?cr</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> fi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">fi</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">fis</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>map_poly <span class="var">?cr</span> <span class="skolem">fi</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> norm <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span><span class="var">?cp</span> <span class="skolem">fi</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">≤</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> bnd<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fi<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>c<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="main">ℝ</span>"</span></span> <span class="main">|</span> <span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span> <span class="main">(</span>m1<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span> <span class="main">|</span> <span class="main">(</span>r<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">ℝ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">ℝ</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="skolem">fi</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">≠</span> degree <span class="skolem">fi</span> <span class="main">∨</span> poly <span class="skolem">fi</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> poly <span class="skolem">fi</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">from</span></span> rt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="skolem">fi</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> m1
      <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span> <span class="main">=</span> <span class="var">?cr</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> rt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"poly <span class="skolem">fi</span> <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> m1 id of_real_hom.hom_zero<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main">=</span></span><span class="quoted">complex</span><span class="main">,</span><span class="operator">symmetric</span><span class="main">]</span> of_real_hom.poly_map_poly <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> r
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> of_real <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Reals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> r<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> xy<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> x<span class="main">[</span><span class="operator">unfolded</span> xy<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs <span class="skolem">y</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> y <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> c
      <span class="keyword1"><span class="command">from</span></span> yun_factorization<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> yun<span class="main">]</span> fi <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"monic <span class="skolem">fi</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> fi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?cp</span> <span class="skolem">fi</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span><span class="var">?cp</span> <span class="skolem">fi</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> poly_roots_finite<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?cr</span> <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span><span class="var">?cp</span> <span class="skolem">fi</span><span class="main">)</span> <span class="main">(</span><span class="var">?cr</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">⊂</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span><span class="var">?cp</span> <span class="skolem">fi</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⊂</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="var">?l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">unfolding</span></span> Reals_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">≠</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> psubset_card_mono<span class="main">[</span><span class="operator">OF</span> fin this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?l</span> <span class="main">&lt;</span> card <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> degree <span class="main">(</span><span class="var">?cp</span> <span class="skolem">fi</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> poly_roots_degree<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fi<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> degree <span class="skolem">fi</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?cr</span> <span class="main">`</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="skolem">fi</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="skolem">fi</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_image<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="skolem">fi</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">≠</span> degree <span class="skolem">fi</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">thm</span></span> perron_frobenius_spectral_radius_yun_real_roots
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Spectral_Radius_Largest_Jordan_Block">
<div class="head">
<h1>Theory Spectral_Radius_Largest_Jordan_Block</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Thiemann *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Jordan Blocks of the Spectral Radius are Largest›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Consider a non-negative real matrix, and consider any Jordan-block
  of any eigenvalues whose norm is the spectral radius. We prove that there is
  a Jordan block of the spectral radius which has the same size or is larger.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Spectral_Radius_Largest_Jordan_Block
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="../Jordan_Normal_Form/Jordan_Normal_Form_Uniqueness.html">Jordan_Normal_Form.Jordan_Normal_Form_Uniqueness</a>
  <a href="Perron_Frobenius_General.html">Perron_Frobenius_General</a>
  <span class="quoted">"<a href="../../HOL/HOL-Real_Asymp/Real_Asymp.html">HOL-Real_Asymp.Real_Asymp</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_root_unity<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>comm_ring<span class="main">,</span>division_ring<span class="main">}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">^</span><span class="free">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">x</span><span class="main">^</span><span class="bound">i</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> of_nat <span class="free">n</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∨</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> x<span class="main">:</span> False
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> Suc <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span> <span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">m</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms x n <span class="keyword1"><span class="command">unfolding</span></span> id sum_gp <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> divide_inverse<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_root_unity_power_pos_implies_1<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> sumpos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> Re <span class="main">(</span>sum <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">b</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">x</span> <span class="bound">i</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> root_unity<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">x</span> <span class="bound">i</span> <span class="main">^</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">∈</span> <span class="free">x</span> <span class="main">`</span> <span class="free">I</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span> 
  <span class="keyword1"><span class="command">hence</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="free">x</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> sumpos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> sum.infinite <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">d</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟶</span> <span class="bound">d</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">x</span> <span class="bound">i</span> <span class="main">^</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> root_unity <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> choice<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="skolem">d</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">x</span> <span class="bound">i</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">d</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> prod <span class="skolem">d</span> <span class="free">I</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> D0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> D_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod_pos<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> d<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> sum <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> Re <span class="main">(</span>sum <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">b</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">x</span> <span class="bound">i</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="skolem">D</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_pos<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ sumpos<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> D0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Re <span class="main">(</span>sum <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> sum <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">b</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">x</span> <span class="bound">i</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="skolem">D</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> sum <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">b</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">x</span> <span class="bound">i</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="skolem">D</span><span class="main">}</span>
    <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> sum <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> <span class="free">b</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">x</span> <span class="bound">i</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="skolem">D</span><span class="main">}</span><span class="main">)</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.swap<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="free">b</span> <span class="bound">i</span> <span class="main">*</span> sum <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> <span class="free">x</span> <span class="bound">i</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="skolem">D</span><span class="main">}</span><span class="main">)</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum.neutral<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> ballI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> d<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> x<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rt_unity<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="skolem">i</span> <span class="main">^</span> <span class="skolem">d</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">C</span><span class="main">.</span> <span class="skolem">D</span> <span class="main">=</span> <span class="skolem">d</span> <span class="skolem">i</span> <span class="main">*</span> <span class="bound">C</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> D_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> prod.remove<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i I<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="skolem">d</span> <span class="skolem">i</span> <span class="main">*</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> image<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">{..&lt;</span> <span class="skolem">D</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">`</span> <span class="main">{..&lt;</span> <span class="skolem">D</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span> <span class="main">+</span> <span class="skolem">d</span> <span class="skolem">i</span> <span class="main">*</span> <span class="bound">c</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span> <span class="skolem">D</span><span class="main">}</span> <span class="main">=</span> <span class="var">?g</span> <span class="main">`</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">j</span> <span class="keyword1">mod</span> <span class="skolem">d</span> <span class="skolem">i</span><span class="main">,</span> <span class="bound">j</span> <span class="keyword1">div</span> <span class="skolem">d</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span> <span class="skolem">d</span> <span class="skolem">i</span> <span class="main">*</span> <span class="skolem">C</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> image_image split D<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> d mod_mult_div_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="bound">j</span> <span class="keyword1">mod</span> <span class="skolem">d</span> <span class="skolem">i</span><span class="main">,</span> <span class="bound">j</span> <span class="keyword1">div</span> <span class="skolem">d</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span> <span class="skolem">d</span> <span class="skolem">i</span> <span class="main">*</span> <span class="skolem">C</span><span class="main">}</span> <span class="main">=</span> <span class="main">{..&lt;</span> <span class="skolem">d</span> <span class="skolem">i</span><span class="main">}</span> <span class="main">×</span> <span class="main">{..&lt;</span> <span class="skolem">C</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">`</span> <span class="var">?A</span> <span class="main">=</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">d</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">&lt;</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">+</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">d</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">d</span> <span class="skolem">i</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">d</span> <span class="skolem">i</span> <span class="main">*</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_le_mono2<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> c<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">+</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">d</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">+</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">d</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?f</span> <span class="main">`</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">+</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">d</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> x <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?f</span> <span class="main">`</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> div_lt_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span> <span class="skolem">D</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span> <span class="main">+</span> <span class="skolem">d</span> <span class="skolem">i</span> <span class="main">*</span> <span class="bound">c</span><span class="main">)</span> <span class="main">`</span> <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="var">?g</span> <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a1</span> <span class="skolem">a2</span> <span class="skolem">c1</span> <span class="skolem">c2</span>
        <span class="keyword3"><span class="command">assume</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">(</span><span class="skolem">a1</span><span class="main">,</span><span class="skolem">c1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?g</span> <span class="main">(</span><span class="skolem">a2</span><span class="main">,</span><span class="skolem">c2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a1</span><span class="main">,</span><span class="skolem">c1</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a2</span><span class="main">,</span><span class="skolem">c2</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span> 
        <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> id<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">div</span> <span class="skolem">d</span> <span class="skolem">i</span>"</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">=</span> <span class="skolem">c2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> id<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">mod</span> <span class="skolem">d</span> <span class="skolem">i</span>"</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a1</span> <span class="main">=</span> <span class="skolem">a2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">note</span></span> a c
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> SigmaE inj_onI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> <span class="free">x</span> <span class="skolem">i</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="skolem">D</span><span class="main">}</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="free">x</span> <span class="skolem">i</span> <span class="main">^</span> <span class="main">(</span><span class="bound">a</span> <span class="main">+</span> <span class="skolem">d</span> <span class="skolem">i</span> <span class="main">*</span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span> <span class="var">?B</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.reindex<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> inj<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span> 
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="free">x</span> <span class="skolem">i</span> <span class="main">^</span> <span class="bound">a</span><span class="main">)</span> <span class="var">?B</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power_add power_mult rt_unity<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum.cartesian_product<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>  sum.swap<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="skolem">C</span><span class="main">}</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.neutral<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sum_root_unity<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rt_unity<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="skolem">i</span> <span class="main">*</span> sum <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> <span class="free">x</span> <span class="skolem">i</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span> <span class="main">{..&lt;</span> <span class="skolem">D</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">j_to_jb_index</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span>list <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">×</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">j_to_jb_index</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">n_as</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="keyword1">else</span> 
     <span class="keyword1">let</span> <span class="bound">rec</span> <span class="main">=</span> <span class="free">j_to_jb_index</span> <span class="free"><span class="bound"><span class="entity">n_as</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span>Suc <span class="main">(</span>fst <span class="bound">rec</span><span class="main">)</span><span class="main">,</span> snd <span class="bound">rec</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">jb_to_j_index</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span>list <span class="main">⇒</span> nat <span class="main">×</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">jb_to_j_index</span> <span class="free"><span class="bound"><span class="entity">n_as</span></span></span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">jb_to_j_index</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">n_as</span></span></span><span class="main">)</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free">jb_to_j_index</span> <span class="free"><span class="bound"><span class="entity">n_as</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> j_to_jb_index<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> sum_list <span class="main">(</span>map fst <span class="free">n_as</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> sum_list <span class="main">(</span>map fst <span class="free">n_as</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"j_to_jb_index <span class="free">n_as</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">bi</span><span class="main">,</span> <span class="free">li</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"j_to_jb_index <span class="free">n_as</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="free">bj</span><span class="main">,</span> <span class="free">lj</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n_as</span> <span class="main">!</span> <span class="free">bj</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>jordan_matrix <span class="free">n_as</span><span class="main">)</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">r</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">bi</span> <span class="main">=</span> <span class="free">bj</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">(</span>jordan_block <span class="free">n</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">r</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">li</span><span class="main">,</span> <span class="free">lj</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span><span class="free">bi</span> <span class="main">=</span> <span class="free">bj</span> <span class="main">⟶</span> <span class="free">li</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">lj</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">bj</span> <span class="main">&lt;</span> length <span class="free">n_as</span> <span class="main">∧</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">n_as</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> jordan_matrix_pow <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n_as</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">bi</span></span> <span class="quoted"><span class="free">bj</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">mb</span> <span class="skolem">n_as</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">bi</span> <span class="skolem">bj</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> mb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mb</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">m</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">note</span></span> Cons <span class="main">=</span> Cons<span class="main">[</span><span class="operator">unfolded</span> mb<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> fst <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> fst <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> jordan_block <span class="bound">n</span> <span class="bound">a</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> fst <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> jordan_block <span class="bound">n</span> <span class="bound">a</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> fst <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>UL<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">m</span>"</span></span> <span class="main">|</span> <span class="main">(</span>UR<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="skolem">m</span>"</span></span> <span class="main">|</span> <span class="main">(</span>LL<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">m</span>"</span></span> 
    <span class="main">|</span> <span class="main">(</span>LR<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> UL
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>2-<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> UR
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>2-<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def dim_diag_block_mat o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> LL
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>2-<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def dim_diag_block_mat o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> LR
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">-</span> <span class="skolem">m</span>"</span></span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="skolem">m</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> LR Cons<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> bi<span class="main">:</span> <span class="quoted"><span class="quoted">"j_to_jb_index <span class="skolem">n_as</span> <span class="var">?i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">bi</span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="free">li</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bi</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> LR Cons<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> bj<span class="main">:</span> <span class="quoted"><span class="quoted">"j_to_jb_index <span class="skolem">n_as</span> <span class="var">?j</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">bj</span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="free">lj</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bj</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> LR Cons<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">&lt;</span> sum_list <span class="main">(</span>map fst <span class="skolem">n_as</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> LR Cons<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?j</span> <span class="main">&lt;</span> sum_list <span class="main">(</span>map fst <span class="skolem">n_as</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> LR Cons<span class="main">(</span>2-<span class="main">)</span> bj<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> nas<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n_as</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">bj</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bj</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> bi<span class="main">(</span>2<span class="main">)</span> bj<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">bi</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">bj</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">bi</span> <span class="main">=</span> <span class="skolem">bj</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> i j bi<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bj<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nas<span class="main">,</span> <span class="operator">unfolded</span> id<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"diag_block_mat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> jordan_block <span class="bound">n</span> <span class="bound">a</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">mb</span> <span class="main">#</span> <span class="skolem">n_as</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>
      <span class="main">=</span> diag_block_mat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> jordan_block <span class="bound">n</span> <span class="bound">a</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">r</span><span class="main">)</span> <span class="skolem">n_as</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="var">?i</span><span class="main">,</span> <span class="var">?j</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> i j LR <span class="keyword1"><span class="command">unfolding</span></span> mb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def dim_diag_block_mat o_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>     
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> j_to_jb_index_rev<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"j_to_jb_index <span class="free">n_as</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">bi</span><span class="main">,</span> <span class="free">li</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> sum_list <span class="main">(</span>map fst <span class="free">n_as</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">li</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">li</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">∧</span> j_to_jb_index <span class="free">n_as</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">bi</span><span class="main">,</span> <span class="free">li</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
  j_to_jb_index <span class="free">n_as</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="free">bi</span><span class="main">,</span><span class="free">li</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">j</span> <span class="main">&lt;</span> sum_list <span class="main">(</span>map fst <span class="free">n_as</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> j i
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n_as</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">bi</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">mb</span> <span class="skolem">n_as</span> <span class="skolem">i</span> <span class="skolem">bi</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> mb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mb</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">m</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">note</span></span> Cons <span class="main">=</span> Cons<span class="main">[</span><span class="operator">unfolded</span> mb<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">m</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mb <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> i_large<span class="main">:</span> False
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">-</span> <span class="skolem">m</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">&lt;</span> sum_list <span class="main">(</span>map fst <span class="skolem">n_as</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2-<span class="main">)</span> i_large <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2-<span class="main">)</span> i_large <span class="keyword1"><span class="command">have</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"j_to_jb_index <span class="skolem">n_as</span> <span class="var">?i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">bi</span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="free">li</span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> bi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bi</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> j i<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> IH <span class="keyword1"><span class="command">have</span></span> IH1<span class="main">:</span> <span class="quoted"><span class="quoted">"j_to_jb_index <span class="skolem">n_as</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="skolem">m</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">bi</span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="free">li</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       li<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">li</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">-</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> li <span class="keyword1"><span class="command">have</span></span> aim1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">li</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> li k i_large <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">-</span> <span class="free">k</span> <span class="main">≥</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> aim2<span class="main">:</span> <span class="quoted"><span class="quoted">"j_to_jb_index <span class="main">(</span><span class="skolem">mb</span> <span class="main">#</span> <span class="skolem">n_as</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">bi</span><span class="main">,</span> <span class="free">li</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> IH1 bi <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mb Let_def add.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"j_to_jb_index <span class="main">(</span><span class="skolem">mb</span> <span class="main">#</span> <span class="skolem">n_as</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">bi</span><span class="main">,</span> <span class="free">li</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> sum_list <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">mb</span> <span class="main">#</span> <span class="skolem">n_as</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">from</span></span> * bi <span class="keyword1"><span class="command">have</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="skolem">m</span>"</span></span> 
      <span class="keyword1"><span class="command">from</span></span> j * <span class="keyword1"><span class="command">have</span></span> jj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?j</span> <span class="main">&lt;</span> sum_list <span class="main">(</span>map fst <span class="skolem">n_as</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> j * <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"j_to_jb_index <span class="skolem">n_as</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">bi</span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="free">li</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bi mb 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"j_to_jb_index <span class="skolem">n_as</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">m</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?j</span></span></span><span class="main">]</span> jj ** <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="skolem">m</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">-</span> <span class="skolem">m</span> <span class="main">-</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> j i_large k <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">-</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">-</span> <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> aim3 <span class="main">=</span> this
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> aim1 aim2 aim3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>  
  

<span class="keyword1"><span class="command">locale</span></span> spectral_radius_1_jnf_max <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real mat"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">lam</span> <span class="main">::</span> <span class="quoted">complex</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n_as</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_mat <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> jnf<span class="main">:</span> <span class="quoted"><span class="quoted">"jordan_nf <span class="main">(</span>map_mat complex_of_real <span class="free">A</span><span class="main">)</span> <span class="free">n_as</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="free">lam</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">n_as</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> lam1<span class="main">:</span> <span class="quoted"><span class="quoted">"cmod <span class="free">lam</span> <span class="main">=</span> <span class="main">1</span>"</span></span>  
  <span class="keyword2"><span class="keyword">and</span></span> sr1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> max_block<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span> <span class="bound">la</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span><span class="bound">la</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">n_as</span> <span class="main">⟹</span> cmod <span class="bound">la</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">(</span>cmod <span class="bound">la</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">m</span><span class="main">)</span>"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> n_as0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="free">n_as</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> jnf<span class="main">[</span><span class="operator">unfolded</span> jordan_nf_def<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mem n_as0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cA</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">cA</span> <span class="main">≡</span> map_mat complex_of_real <span class="free">A</span>"</span></span> 
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">J</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">J</span> <span class="main">≡</span> jordan_matrix <span class="free">n_as</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> sim_A_J<span class="main">:</span> <span class="quoted"><span class="quoted">"similar_mat cA J"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> jnf<span class="main">[</span><span class="operator">unfolded</span> jordan_nf_def<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="main">(</span>of_nat <span class="free">m</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> of_nat <span class="bound">ia</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">lemma</span></span> c_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"c <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> c_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod_pos<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> c0<span class="main">:</span> <span class="quoted"><span class="quoted">"c <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c_gt_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> c_int_def<span class="main">:</span> <span class="quoted"><span class="quoted">"c <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">-</span><span class="main">1</span><span class="main">.</span> <span class="main">(</span>of_nat <span class="free">m</span> <span class="main">::</span> int<span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> of_nat <span class="bound">ia</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> c_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> c_int<span class="main">:</span> <span class="quoted"><span class="quoted">"c <span class="main">∈</span> <span class="main">ℤ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c_int_def Ints_of_int <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">lemma</span></span> c_ge_1<span class="main">:</span> <span class="quoted"><span class="quoted">"c <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c_gt_0 <span class="keyword1"><span class="command">unfolding</span></span> c_int_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PP</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">PP</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">PP</span><span class="main">.</span> similar_mat_wit cA J <span class="main">(</span>fst <span class="bound">PP</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">PP</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">P</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> fst PP"</span></span> 
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">iP</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">iP</span> <span class="main">=</span> snd PP"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> JNF<span class="main">:</span> <span class="quoted"><span class="quoted">"P <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"iP <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"J <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"P <span class="main">*</span> iP <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"iP <span class="main">*</span> P <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"cA <span class="main">=</span> P <span class="main">*</span> J <span class="main">*</span> iP"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> dim_row cA"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> sim_A_J<span class="main">[</span><span class="operator">unfolded</span> similar_mat_def<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="skolem"><span class="skolem">iQ</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"similar_mat_wit cA J <span class="skolem">Q</span> <span class="skolem">iQ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"similar_mat_wit cA J <span class="main">(</span>fst <span class="main">(</span><span class="skolem">Q</span><span class="main">,</span><span class="skolem">iQ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span><span class="skolem">Q</span><span class="main">,</span><span class="skolem">iQ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"similar_mat_wit cA J P iP"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> PP_def iP_def P_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> similar_mat_witD<span class="main">[</span><span class="operator">OF</span> n this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">I</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span> <span class="bound">bi</span> <span class="bound">li</span> <span class="bound">nn</span> <span class="bound">la</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> j_to_jb_index <span class="free">n_as</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">(</span><span class="bound">bi</span><span class="main">,</span> <span class="bound">li</span><span class="main">)</span> 
    <span class="main">∧</span> <span class="free">n_as</span> <span class="main">!</span> <span class="bound">bi</span> <span class="main">=</span> <span class="main">(</span><span class="bound">nn</span><span class="main">,</span><span class="bound">la</span><span class="main">)</span> <span class="main">∧</span> cmod <span class="bound">la</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">nn</span> <span class="main">=</span> <span class="free">m</span> <span class="main">∧</span> <span class="bound">li</span> <span class="main">=</span> <span class="bound">nn</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sumlist_nf<span class="main">:</span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map fst <span class="free">n_as</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map fst <span class="free">n_as</span><span class="main">)</span> <span class="main">=</span> dim_row <span class="main">(</span>jordan_matrix <span class="free">n_as</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> dim_row cA"</span></span> <span class="keyword1"><span class="command">using</span></span> similar_matD<span class="main">[</span><span class="operator">OF</span> sim_A_J<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> I_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"I <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> split_list<span class="main">[</span><span class="operator">OF</span> mem<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> n_as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n_as</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="main">(</span><span class="free">m</span><span class="main">,</span><span class="free">lam</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map fst <span class="skolem">as</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"j_to_jb_index <span class="free">n_as</span> <span class="var">?i</span> <span class="main">=</span> <span class="main">(</span>length <span class="skolem">as</span><span class="main">,</span> <span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> n_as <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">as</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> m0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> lam1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">∈</span> I"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">unfolding</span></span> sumlist_nf<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> n_as <span class="keyword1"><span class="command">using</span></span> m0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> I_n<span class="main">:</span> <span class="quoted"><span class="quoted">"I <span class="main">⊆</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> root_unity_cmod_1<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> la<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">la</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">n_as</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"cmod <span class="free">la</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">la</span> <span class="main">^</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> la <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> kla<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span><span class="main">,</span><span class="free">la</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">n_as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> n_as0 kla <span class="keyword1"><span class="command">have</span></span> k0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> split_list<span class="main">[</span><span class="operator">OF</span> kla<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> nas<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n_as</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span><span class="free">la</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>char_poly cA<span class="main">)</span> <span class="free">la</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k0
    <span class="keyword1"><span class="command">unfolding</span></span> jordan_nf_char_poly<span class="main">[</span><span class="operator">OF</span> jnf<span class="main">]</span> nas poly_prod_list prod_list_zero_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ks</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"decompose_prod_root_unity <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ks</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> sumlist_nf<span class="main">[</span><span class="operator">unfolded</span> nas<span class="main">]</span> k0 <span class="keyword1"><span class="command">have</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> pf <span class="main">=</span> perron_frobenius_for_complexity_jnf<span class="main">(</span>1<span class="main">,</span>7<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> A n0 nonneg sr1 decomp<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> pf<span class="main">(</span>1<span class="main">)</span> pf<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 1 rt<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">la</span> <span class="main">^</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">d</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">d</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">la</span><span class="main">.</span> <span class="bound">la</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">n_as</span> <span class="main">⟶</span> cmod <span class="bound">la</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> 
  <span class="bound">d</span> <span class="bound">la</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">la</span> <span class="main">^</span> <span class="main">(</span><span class="bound">d</span> <span class="bound">la</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> d<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">la</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">n_as</span>"</span></span> <span class="quoted"><span class="quoted">"cmod <span class="free">la</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">la</span> <span class="main">^</span> <span class="main">(</span>d <span class="free">la</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> d <span class="free">la</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">d</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">la</span><span class="main">.</span> <span class="bound">la</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">n_as</span> <span class="main">⟶</span> cmod <span class="bound">la</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> 
    <span class="bound">d</span> <span class="bound">la</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">la</span> <span class="main">^</span> <span class="main">(</span><span class="bound">d</span> <span class="bound">la</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
  <span class="keyword1"><span class="command">from</span></span> root_unity_cmod_1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">la</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">d</span><span class="main">.</span> <span class="bound">la</span> <span class="main">∈</span> snd <span class="main">`</span> set <span class="free">n_as</span> <span class="main">⟶</span> cmod <span class="bound">la</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> 
    <span class="bound">d</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">la</span> <span class="main">^</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> choice<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">d</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">d</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> someI_ex<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> d"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">la</span></span><span class="main">,</span> <span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">D</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">na</span><span class="main">.</span> <span class="keyword1">if</span> cmod <span class="main">(</span>snd <span class="bound">na</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> d <span class="main">(</span>snd <span class="bound">na</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span> <span class="free">n_as</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> D0<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> D_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> prod_list_zero_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> d<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">K</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="free"><span class="bound"><span class="entity">off</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> D <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">+</span> <span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">off</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mono_K<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_mono <span class="main">(</span>K <span class="free">off</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> strict_mono_def K_def
  <span class="keyword1"><span class="command">using</span></span> D0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">C</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="free"><span class="bound"><span class="entity">off</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span>c <span class="main">/</span> real <span class="main">(</span>K <span class="free"><span class="bound"><span class="entity">off</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> limit_jordan_block<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> kla<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">la</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">n_as</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">N</span><span class="main">.</span> <span class="main">(</span>jordan_block <span class="free">k</span> <span class="free">la</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>K <span class="free">off</span> <span class="bound">N</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">*</span> C <span class="free">off</span> <span class="bound">N</span><span class="main">)</span>
  <span class="main">⇢</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">=</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> cmod <span class="free">la</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">=</span> <span class="free">m</span> <span class="keyword1">then</span> <span class="free">la</span><span class="main">^</span><span class="free">off</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"of_nat <span class="main">::</span> nat <span class="main">⇒</span> complex"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"of_nat <span class="main">::</span> nat <span class="main">⇒</span> real"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cr</span></span></span> <span class="main">=</span> <span class="quoted">complex_of_real</span> 
  <span class="keyword1"><span class="command">from</span></span> ij <span class="keyword1"><span class="command">have</span></span> k0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> jordan_nf_char_poly<span class="main">[</span><span class="operator">OF</span> jnf<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> cA<span class="main">:</span> <span class="quoted"><span class="quoted">"char_poly cA <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">←</span><span class="free">n_as</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">a</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> degree_monic_char_poly<span class="main">[</span><span class="operator">OF</span> A<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> deg<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>char_poly cA<span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> degree_monic_char_poly<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> cA<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> degree <span class="main">(</span><span class="main">∏</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">←</span><span class="free">n_as</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">a</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  sum_list <span class="main">(</span>map degree <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">a</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span> <span class="free">n_as</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> degree_prod_list_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_list <span class="main">(</span>map fst <span class="free">n_as</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">sum_list</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degree_linear_power<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> sum<span class="main">:</span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map fst <span class="free">n_as</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> split_list<span class="main">[</span><span class="operator">OF</span> kla<span class="main">]</span> k0 <span class="keyword1"><span class="command">have</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ks</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"decompose_prod_root_unity <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ks</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">note</span></span> pf <span class="main">=</span> perron_frobenius_for_complexity_jnf<span class="main">[</span><span class="operator">OF</span> A n0 nonneg sr1 decomp<span class="main">]</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ji</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ji</span> <span class="main">=</span> <span class="free">j</span> <span class="main">-</span> <span class="free">i</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">N</span><span class="main">.</span> <span class="main">(</span>c <span class="main">/</span> <span class="main">(</span><span class="var">?r</span> <span class="bound">N</span><span class="main">)</span><span class="main">^</span><span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?jb</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">N</span><span class="main">.</span> <span class="main">(</span>jordan_block <span class="free">k</span> <span class="free">la</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">N</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?jbc</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">N</span><span class="main">.</span> <span class="main">(</span>jordan_block <span class="free">k</span> <span class="free">la</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">N</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">*</span> <span class="var">?f</span> <span class="bound">N</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">=</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> cmod <span class="free">la</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">=</span> <span class="free">m</span> <span class="keyword1">then</span> <span class="free">la</span><span class="main">^</span><span class="free">off</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">N</span> <span class="main">::</span> nat<span class="main">.</span> <span class="main">(</span><span class="main">∏</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">ji</span><span class="main">.</span> <span class="main">(</span><span class="var">?c</span> <span class="bound">N</span> <span class="main">-</span> <span class="var">?c</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">/</span> <span class="var">?c</span> <span class="main">(</span><span class="skolem">ji</span> <span class="main">-</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">la</span> <span class="main">^</span> <span class="main">(</span><span class="bound">N</span> <span class="main">-</span> <span class="skolem">ji</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">N</span><span class="main">.</span> <span class="main">(</span><span class="main">∏</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">ji</span><span class="main">.</span> <span class="main">(</span><span class="var">?c</span> <span class="bound">N</span> <span class="main">-</span> <span class="var">?c</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">/</span> <span class="var">?c</span> <span class="main">(</span><span class="skolem">ji</span> <span class="main">-</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">la</span> <span class="main">^</span> <span class="main">(</span><span class="bound">N</span> <span class="main">-</span> <span class="skolem">ji</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>c <span class="main">/</span> <span class="main">(</span><span class="main">(</span><span class="var">?c</span> <span class="bound">N</span><span class="main">^</span><span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">e2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e2</span> <span class="main">=</span> <span class="var">?e2</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e3</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">N</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">∏</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">ji</span><span class="main">.</span> <span class="main">(</span><span class="var">?c</span> <span class="bound">N</span> <span class="main">-</span> <span class="var">?c</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">/</span> <span class="var">?c</span> <span class="main">(</span><span class="skolem">ji</span> <span class="main">-</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">la</span> <span class="main">^</span> <span class="main">(</span><span class="bound">N</span> <span class="main">-</span> <span class="skolem">ji</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="var">?f</span> <span class="bound">N</span>"</span></span> 
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> ij'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> la0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">la</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">N</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">≥</span> <span class="free">k</span>"</span></span> 
      <span class="keyword1"><span class="command">with</span></span> ij ij' <span class="keyword1"><span class="command">have</span></span> ji<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="free">i</span> <span class="main">≤</span> <span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">+</span> <span class="free">i</span> <span class="main">-</span> <span class="free">j</span> <span class="main">=</span> <span class="skolem">N</span> <span class="main">-</span> <span class="skolem">ji</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ji_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?jb</span> <span class="skolem">N</span> <span class="main">=</span> <span class="main">(</span><span class="var">?c</span> <span class="main">(</span><span class="skolem">N</span> <span class="keyword1">choose</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">la</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">+</span> <span class="free">i</span> <span class="main">-</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> jordan_block_pow <span class="keyword1"><span class="command">using</span></span> ij ij' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?e1</span> <span class="skolem">N</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ji_def
        <span class="keyword1"><span class="command">unfolding</span></span> binomial_altdef_of_nat<span class="main">[</span><span class="operator">OF</span> ji<span class="main">]</span> id ji_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> prod.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span> 
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">N</span> <span class="main">≥</span> <span class="free">k</span>›</span></span> ij <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_nat_diff<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?jb</span> <span class="skolem">N</span> <span class="main">=</span> <span class="var">?e1</span> <span class="skolem">N</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?jbc</span> <span class="skolem">N</span> <span class="main">=</span> <span class="skolem">e2</span> <span class="skolem">N</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> id e2_def <span class="keyword1"><span class="command">using</span></span> c_gt_0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> norm_mult norm_divide norm_power<span class="main">)</span> 
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> jbc <span class="main">=</span> this
    <span class="keyword1"><span class="command">have</span></span> e23<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?e2</span> <span class="skolem">N</span> <span class="main">=</span> <span class="var">?e3</span> <span class="skolem">N</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">N</span> <span class="keyword1"><span class="command">using</span></span> c_gt_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">e2</span> <span class="keyword1">o</span> K <span class="free">off</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">e</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"cmod <span class="free">la</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">=</span> <span class="free">m</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">=</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>0<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">la</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="main">(</span>small<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">la</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"cmod <span class="free">la</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="main">|</span> 
        <span class="main">(</span>medium<span class="main">)</span> <span class="quoted"><span class="quoted">"cmod <span class="free">la</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">∨</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">j</span> <span class="main">≠</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> max_block<span class="main">[</span><span class="operator">OF</span> kla<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">hence</span></span> main<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e2</span> <span class="main">⇢</span> <span class="skolem">e</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> 0
        <span class="keyword1"><span class="command">hence</span></span> e0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> e_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> e0 0 LIMSEQ_iff e2_def
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">ji</span>"</span></span><span class="main"><span class="main">]</span></span> impI allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">r</span> <span class="skolem">n</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">-</span> <span class="skolem">ji</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> small
        <span class="keyword1"><span class="command">have</span></span> e0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="main">0</span> <span class="main">*</span> <span class="main">(</span>of_real <span class="main">(</span><span class="keyword1">if</span> <span class="free">m</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> c <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> small <span class="keyword1"><span class="command">unfolding</span></span> e_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> e0 <span class="keyword1"><span class="command">unfolding</span></span> e23 e2_def
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> tendsto_mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ tendsto_of_real<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> c <span class="main">/</span> real <span class="bound">x</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">m</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> c <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">real_asymp</span><span class="main">)</span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?laji</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inverse <span class="main">(</span><span class="free">la</span><span class="main">^</span><span class="skolem">ji</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∏</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">ji</span><span class="main">.</span> <span class="main">(</span><span class="var">?c</span> <span class="bound">x</span> <span class="main">-</span> <span class="var">?c</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">/</span> <span class="var">?c</span> <span class="main">(</span><span class="skolem">ji</span> <span class="main">-</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">la</span> <span class="main">^</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="skolem">ji</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∏</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">ji</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?c</span> <span class="bound">ia</span> <span class="main">*</span> inverse <span class="main">(</span><span class="var">?c</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="var">?c</span> <span class="main">(</span><span class="skolem">ji</span> <span class="main">-</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="var">?c</span> <span class="bound">x</span><span class="main">)</span><span class="main">^</span><span class="skolem">ji</span> <span class="main">*</span> <span class="free">la</span> <span class="main">^</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span> <span class="var">?laji</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">have</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> <span class="var">?f</span> <span class="bound">x</span> <span class="main">=</span> <span class="var">?g</span> <span class="bound">x</span>"</span></span> 
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eventually_sequentiallyI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">ji</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> prod_pow<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> prod.distrib<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> mult.assoc<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
            <span class="keyword1"><span class="command">unfolding</span></span> prod_pow mult.assoc
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">(*)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> prod.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main"><span class="keyword3">,</span></span> 
              <span class="operator">insert</span> small<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> power_diff<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> divide_inverse<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">ji</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> of_nat <span class="bound">ia</span> <span class="main">*</span> <span class="main">0</span><span class="main">)</span> <span class="main">/</span> of_nat <span class="main">(</span><span class="skolem">ji</span> <span class="main">-</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">0</span> <span class="main">*</span> <span class="var">?laji</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> tendsto_cong<span class="main">[</span><span class="operator">OF</span> fg<span class="main">]</span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> 0<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> tendsto_mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tendsto_prod tendsto_mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ tendsto_const<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> 
              <span class="operator">intro</span> <span class="dynamic"><span class="dynamic">tendsto_intros</span></span> inverse_of_nat_tendsto_zero<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> of_nat <span class="bound">x</span> <span class="main">^</span> <span class="skolem">ji</span> <span class="main">*</span> <span class="free">la</span> <span class="main">^</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">0</span>"</span></span>        
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> poly_times_exp_tendsto_zero<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> small<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> medium
        <span class="keyword1"><span class="command">with</span></span> max_block<span class="main">[</span><span class="operator">OF</span> kla<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> cmod <span class="free">la</span> <span class="main">^</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> ij medium <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ji</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ji_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> m1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> Suc <span class="skolem">d</span> <span class="main">+</span> <span class="skolem">ji</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> less_iff_Suc_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> e0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> medium <span class="keyword1"><span class="command">unfolding</span></span> e_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">ji</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?c</span> <span class="bound">ia</span> <span class="main">*</span> <span class="main">0</span><span class="main">)</span> <span class="main">/</span> <span class="var">?c</span> <span class="main">(</span><span class="skolem">ji</span> <span class="main">-</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>of_real c<span class="main">)</span> <span class="main">*</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>       
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">ia</span> <span class="bound">N</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">N</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?c</span> <span class="bound">ia</span> <span class="main">/</span> <span class="var">?c</span> <span class="bound">N</span><span class="main">)</span> <span class="main">/</span> <span class="var">?c</span> <span class="main">(</span><span class="skolem">ji</span> <span class="main">-</span> <span class="bound">ia</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">ia</span> <span class="bound">N</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?c</span> <span class="bound">ia</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="var">?c</span> <span class="bound">N</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="var">?c</span> <span class="main">(</span><span class="skolem">ji</span> <span class="main">-</span> <span class="bound">ia</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">N</span>          
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e2</span> <span class="skolem">N</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∏</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">ji</span><span class="main">.</span> <span class="main">(</span><span class="var">?c</span> <span class="skolem">N</span> <span class="main">-</span> <span class="var">?c</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">/</span> <span class="var">?c</span> <span class="main">(</span><span class="skolem">ji</span> <span class="main">-</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="var">?c</span> <span class="skolem">N</span> <span class="main">^</span> <span class="skolem">ji</span><span class="main">)</span> <span class="main">*</span> <span class="free">la</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="skolem">ji</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>of_real c <span class="main">/</span> <span class="var">?c</span> <span class="skolem">N</span> <span class="main">^</span> Suc <span class="skolem">d</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">unfolding</span></span> medium m1 power_add e2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">ji</span><span class="main">.</span> <span class="main">(</span><span class="var">?c</span> <span class="skolem">N</span> <span class="main">-</span> <span class="var">?c</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">/</span> <span class="var">?c</span> <span class="main">(</span><span class="skolem">ji</span> <span class="main">-</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="var">?c</span> <span class="skolem">N</span> <span class="main">^</span> <span class="skolem">ji</span> 
            <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">ji</span><span class="main">.</span> <span class="var">?e</span> <span class="bound">ia</span> <span class="skolem">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prod_pow<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> prod_dividef<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="skolem">N</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e2</span> <span class="skolem">N</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">ji</span><span class="main">.</span> <span class="var">?e</span> <span class="bound">ia</span> <span class="skolem">N</span><span class="main">)</span> <span class="main">*</span> of_real c <span class="main">*</span> inverse <span class="main">(</span><span class="var">?c</span> <span class="skolem">N</span> <span class="main">^</span> Suc <span class="skolem">d</span><span class="main">)</span> <span class="main">*</span> <span class="free">la</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="skolem">ji</span><span class="main">)</span>"</span></span>  
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divide_inverse<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cmod <span class="main">…</span> <span class="main">=</span> cmod <span class="main">(</span><span class="main">(</span><span class="main">∏</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">ji</span><span class="main">.</span> <span class="var">?e</span> <span class="bound">ia</span> <span class="skolem">N</span><span class="main">)</span> <span class="main">*</span> of_real c <span class="main">*</span> <span class="main">(</span>inverse <span class="main">(</span><span class="var">?c</span> <span class="skolem">N</span> <span class="main">^</span> Suc <span class="skolem">d</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">unfolding</span></span> norm_mult norm_power 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cmod <span class="main">(</span><span class="skolem">e2</span> <span class="skolem">N</span><span class="main">)</span> <span class="main">=</span> cmod <span class="main">(</span><span class="main">(</span><span class="main">∏</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">ji</span><span class="main">.</span> <span class="var">?e</span> <span class="bound">ia</span> <span class="skolem">N</span><span class="main">)</span> <span class="main">*</span> of_real c <span class="main">*</span> <span class="main">(</span>inverse <span class="main">(</span><span class="var">?c</span> <span class="skolem">N</span> <span class="main">^</span> Suc <span class="skolem">d</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> e2 <span class="main">=</span> this
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> e0
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> tendsto_norm_zero_cancel<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> e2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> tendsto_norm_zero<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 0<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> tendsto_mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tendsto_mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tendsto_prod tendsto_const<span class="main"><span class="main">]</span></span> inverse_power_tendsto_zero<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span><span class="main">)</span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?c</span> <span class="skolem">i</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> of_nat <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> of_nat <span class="main">(</span><span class="skolem">ji</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">∀<span class="hidden">⇩</span><sub>F</sub></span> <span class="bound">x</span> <span class="keyword1">in</span> sequentially<span class="main">.</span> <span class="var">?e</span> <span class="skolem">i</span> <span class="bound">x</span> <span class="main">=</span> <span class="var">?g</span> <span class="bound">x</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eventually_sequentiallyI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?e</span> <span class="skolem">i</span> <span class="main">⇢</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?c</span> <span class="skolem">i</span> <span class="main">*</span> <span class="main">0</span><span class="main">)</span> <span class="main">/</span> <span class="var">?c</span> <span class="main">(</span><span class="skolem">ji</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> 
            <span class="keyword1"><span class="command">unfolding</span></span> tendsto_cong<span class="main">[</span><span class="operator">OF</span> eq<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> 1
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">tendsto_intros</span></span> lim_1_over_n<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">e2</span> <span class="keyword1">o</span> K <span class="free">off</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LIMSEQ_subseq_LIMSEQ<span class="main"><span class="main">[</span></span><span class="operator">OF</span> main mono_K<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> large<span class="main">:</span> <span class="quoted"><span class="quoted">"cmod <span class="free">la</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> <span class="free">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="free">la</span><span class="main">^</span><span class="free">off</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> e_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> large k0 <span class="keyword1"><span class="command">have</span></span> m0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m1</span> <span class="main">=</span> <span class="free">m</span> <span class="main">-</span> <span class="main">1</span>"</span></span> 
      <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>real <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> real <span class="skolem">ia</span><span class="main">)</span> <span class="main">=</span> <span class="var">?r</span> <span class="free">m</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="var">?r</span> <span class="skolem">ia</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ia</span> <span class="keyword1"><span class="command">using</span></span> m0 <span class="keyword1"><span class="command">unfolding</span></span> m1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e4</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∏</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">m1</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="var">?cr</span> <span class="main">(</span><span class="var">?r</span> <span class="bound">ia</span> <span class="main">/</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">nat</span>
        <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?e2</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∏</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">m1</span><span class="main">.</span> <span class="main">(</span><span class="var">?c</span> <span class="skolem">x</span> <span class="main">-</span> <span class="var">?c</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">/</span> <span class="var">?c</span> <span class="main">(</span><span class="skolem">m1</span> <span class="main">-</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
            <span class="main">(</span><span class="main">∏</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">m1</span><span class="main">.</span> <span class="var">?cr</span> <span class="main">(</span>real <span class="skolem">m1</span> <span class="main">-</span> real <span class="bound">ia</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span>
            <span class="main">(</span><span class="main">∏</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">m1</span><span class="main">.</span> <span class="var">?c</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> <span class="free">la</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?A</span> <span class="main">/</span> <span class="var">?B</span> <span class="main">*</span> <span class="var">?C</span>"</span></span><span class="main">)</span> 
          <span class="keyword1"><span class="command">unfolding</span></span> m1_def ji_def large c_def prod_pow<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">m1</span><span class="main">.</span> <span class="main">(</span><span class="var">?cr</span> <span class="skolem">x</span> <span class="main">-</span> <span class="var">?c</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?A</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> prod.distrib<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> of_nat_diff<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">/</span> <span class="var">?B</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">m1</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="var">?cr</span> <span class="main">(</span><span class="var">?r</span> <span class="bound">ia</span> <span class="main">/</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">unfolding</span></span> prod_dividef<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prod.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?e2</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?e4</span> <span class="skolem">x</span> <span class="main">*</span> <span class="var">?C</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> this
      <span class="keyword1"><span class="command">from</span></span> d<span class="main">[</span><span class="operator">OF</span> kla large<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">la</span> <span class="main">^</span> d <span class="free">la</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> split_list<span class="main">[</span><span class="operator">OF</span> kla<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> n_as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n_as</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">la</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="main">=</span> d <span class="free">la</span> <span class="main">*</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> D_def <span class="keyword1"><span class="command">unfolding</span></span> n_as <span class="keyword1"><span class="command">using</span></span> large <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="var">?e4</span> <span class="bound">x</span> <span class="main">*</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">⇢</span> <span class="main">(</span><span class="main">∏</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">m1</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="var">?cr</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">e</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="dynamic"><span class="dynamic">tendsto_intros</span></span> real_tendsto_divide_at_top<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filterlim_real_sequentially<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">m1</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="var">?cr</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> e <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="var">?e4</span> <span class="bound">x</span> <span class="main">*</span> <span class="skolem">e</span><span class="main">)</span>  <span class="main">⇢</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> LIMSEQ_subseq_LIMSEQ<span class="main">[</span><span class="operator">OF</span> this mono_K<span class="main">]</span> 
      <span class="keyword1"><span class="command">have</span></span> e4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="var">?e4</span> <span class="keyword1">o</span> K <span class="free">off</span><span class="main">)</span> <span class="bound">k</span> <span class="main">*</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">e</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⇢</span> <span class="skolem">e</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="main">::</span> <span class="quoted">nat</span>
        <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
        <span class="keyword1"><span class="command">hence</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"K <span class="free">off</span> <span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> K_def <span class="keyword1"><span class="command">using</span></span> D0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?e2</span> <span class="main">(</span>K <span class="free">off</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="var">?e4</span> <span class="main">(</span>K <span class="free">off</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">la</span><span class="main">^</span><span class="main">(</span>K <span class="free">off</span> <span class="skolem">k</span> <span class="main">-</span> <span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> main<span class="main">[</span><span class="operator">OF</span> 0<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"K <span class="free">off</span> <span class="skolem">k</span> <span class="main">-</span> <span class="main">(</span><span class="free">m</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> D <span class="main">*</span> <span class="skolem">k</span> <span class="main">+</span> <span class="free">off</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> K_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">la</span> <span class="main">^</span> <span class="main">…</span> <span class="main">=</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> e power_add D power_mult 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e2</span> <span class="main">(</span>K <span class="free">off</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?e4</span> <span class="keyword1">o</span> K <span class="free">off</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">*</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> o_def e2_def <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> this
      <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?A</span> <span class="main">⇢</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">e2</span> <span class="keyword1">o</span> K <span class="free">off</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tendsto_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> eventually_at_top_linorder<span class="main"><span class="keyword3">,</span></span> 
            <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> main<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> e4<span class="main">[</span><span class="operator">unfolded</span> id<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">e2</span> <span class="keyword1">o</span> K <span class="free">off</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="var">?jbc</span> <span class="keyword1">o</span> K <span class="free">off</span><span class="main">)</span>  <span class="main">⇢</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> tendsto_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> eventually_at_top_linorder<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">intro</span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> mono_K<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">off</span></span><span class="main">]</span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"K <span class="free">off</span> <span class="skolem">n</span> <span class="main">≥</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> le_trans seq_suble <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> jbc<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?jbc</span> <span class="keyword1">o</span> K <span class="free">off</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> part1 <span class="main">=</span> this  
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&gt;</span> <span class="free">j</span> <span class="main">∨</span> <span class="free">la</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> jbn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">≥</span> <span class="free">k</span> <span class="main">⟹</span> <span class="var">?jbc</span> <span class="skolem">N</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">N</span> 
      <span class="keyword1"><span class="command">unfolding</span></span> jordan_block_pow e_def <span class="keyword1"><span class="command">using</span></span> ij <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?jbc</span> <span class="main">⇢</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> e LIMSEQ_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="main">]</span></span> allI impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> jbn<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> LIMSEQ_subseq_LIMSEQ<span class="main">[</span><span class="operator">OF</span> this mono_K<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?jbc</span> <span class="keyword1">o</span> K <span class="free">off</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> part2 <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> part1 part2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?jbc</span> <span class="keyword1">o</span> K <span class="free">off</span><span class="main">)</span> <span class="main">⇢</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> e_def o_def C_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Lam</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Lam</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> snd <span class="main">(</span><span class="free">n_as</span> <span class="main">!</span> fst <span class="main">(</span>j_to_jb_index <span class="free">n_as</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> cmod_Lam<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> I <span class="main">⟹</span> cmod <span class="main">(</span>Lam <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> I_def Lam_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  

<span class="keyword1"><span class="command">lemma</span></span> I_Lam<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> I"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span><span class="main">,</span> Lam <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">n_as</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> i<span class="main">[</span><span class="operator">unfolded</span> I_def<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bi</span></span> <span class="skolem"><span class="skolem">li</span></span> <span class="skolem"><span class="skolem">la</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> jb<span class="main">:</span> <span class="quoted"><span class="quoted">"j_to_jb_index <span class="free">n_as</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">bi</span><span class="main">,</span> <span class="skolem">li</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> nth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n_as</span> <span class="main">!</span> <span class="skolem">bi</span> <span class="main">=</span> <span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="skolem">la</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">la</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="skolem">li</span> <span class="main">=</span> <span class="free">m</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> lam<span class="main">:</span> <span class="quoted"><span class="quoted">"Lam <span class="free">i</span> <span class="main">=</span> <span class="skolem">la</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Lam_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword1"><span class="command">from</span></span> j_to_jb_index<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">n_as</span></span><span class="main">,</span> <span class="operator">unfolded</span> sumlist_nf<span class="main">,</span> <span class="operator">OF</span> i i jb jb nth<span class="main">]</span> lam
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> limit_jordan_matrix<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">N</span><span class="main">.</span> <span class="main">(</span>J <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>K <span class="free">off</span> <span class="bound">N</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">*</span> C <span class="free">off</span> <span class="bound">N</span><span class="main">)</span>
  <span class="main">⇢</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">j</span> <span class="main">∈</span> I <span class="main">∧</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>Lam <span class="free">j</span><span class="main">)</span><span class="main">^</span><span class="free">off</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bi</span></span> <span class="skolem"><span class="skolem">li</span></span> <span class="keyword2"><span class="keyword">where</span></span> bi<span class="main">:</span> <span class="quoted"><span class="quoted">"j_to_jb_index <span class="free">n_as</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">bi</span><span class="main">,</span> <span class="skolem">li</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bj</span></span> <span class="skolem"><span class="skolem">lj</span></span> <span class="keyword2"><span class="keyword">where</span></span> bj<span class="main">:</span> <span class="quoted"><span class="quoted">"j_to_jb_index <span class="free">n_as</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">bj</span><span class="main">,</span> <span class="skolem">lj</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">la</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">la</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">n_as</span> <span class="main">!</span> fst <span class="main">(</span>j_to_jb_index <span class="free">n_as</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nn</span></span> <span class="keyword2"><span class="keyword">where</span></span> nbj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n_as</span> <span class="main">!</span> <span class="skolem">bj</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">nn</span><span class="main">,</span><span class="skolem">la</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> la_def bj fst_conv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> j_to_jb_index<span class="main">[</span><span class="operator">OF</span> ij<span class="main"><span class="main">[</span></span><span class="operator">folded</span> sumlist_nf<span class="main"><span class="main">]</span></span> bi bj nbj<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bi</span> <span class="main">=</span> <span class="skolem">bj</span> <span class="main">⟹</span> <span class="skolem">li</span> <span class="main">&lt;</span> <span class="skolem">nn</span> <span class="main">∧</span> <span class="skolem">lj</span> <span class="main">&lt;</span> <span class="skolem">nn</span> <span class="main">∧</span> <span class="skolem">bj</span> <span class="main">&lt;</span> length <span class="free">n_as</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">nn</span><span class="main">,</span> <span class="skolem">la</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">n_as</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    index<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>J <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">r</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">bi</span> <span class="main">=</span> <span class="skolem">bj</span> <span class="keyword1">then</span> <span class="main">(</span>jordan_block <span class="skolem">nn</span> <span class="skolem">la</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">r</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">li</span><span class="main">,</span> <span class="skolem">lj</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">r</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> index_rev <span class="main">=</span> j_to_jb_index_rev<span class="main">[</span><span class="operator">OF</span> bj<span class="main">,</span> <span class="operator">unfolded</span> sumlist_nf<span class="main">,</span> <span class="operator">OF</span> ij<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> le_refl<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">bi</span> <span class="main">=</span> <span class="skolem">bj</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">bi</span> <span class="main">=</span> <span class="skolem">bj</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∈</span> I"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> I_def<span class="main">]</span> bj nbj <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">j</span> <span class="main">-</span> <span class="skolem">lj</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> index_rev<span class="main">[</span><span class="operator">folded</span> this<span class="main">]</span> bi False <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> index id if_False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">bi</span> <span class="main">=</span> <span class="skolem">bj</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> eq<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">li</span> <span class="main">&lt;</span> <span class="skolem">nn</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lj</span> <span class="main">&lt;</span> <span class="skolem">nn</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">nn</span><span class="main">,</span><span class="skolem">la</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">n_as</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bj</span> <span class="main">&lt;</span> length <span class="free">n_as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">N</span><span class="main">.</span> <span class="main">(</span>J <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>K <span class="free">off</span> <span class="bound">N</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">*</span> C <span class="free">off</span> <span class="bound">N</span><span class="main">)</span>
      <span class="main">⇢</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">li</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">lj</span> <span class="main">=</span> <span class="skolem">nn</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> cmod <span class="skolem">la</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="skolem">nn</span> <span class="main">=</span> <span class="free">m</span> <span class="keyword1">then</span> <span class="skolem">la</span><span class="main">^</span><span class="free">off</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> index id if_True <span class="keyword1"><span class="command">using</span></span> limit_jordan_block<span class="main">[</span><span class="operator">OF</span> eq<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">li</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">lj</span> <span class="main">=</span> <span class="skolem">nn</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> cmod <span class="skolem">la</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="skolem">nn</span> <span class="main">=</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">j</span> <span class="main">∈</span> I <span class="main">∧</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∈</span> I"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> I_def<span class="main">]</span> bj nbj 
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nn</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">la</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lj</span> <span class="main">=</span> <span class="skolem">nn</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?r</span>›</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">j</span> <span class="main">-</span> <span class="skolem">lj</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">li</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> index_rev bi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span>
      <span class="keyword1"><span class="command">hence</span></span> jI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∈</span> I"</span></span> <span class="keyword1"><span class="command">using</span></span> bj nbj ij <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> I_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?l</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">li</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> index_rev<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> bi ij<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="var">?l</span>›</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">j</span> <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> jI <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> la_def Lam_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> sumlist_nf<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> A_power_P<span class="main">:</span> <span class="quoted"><span class="quoted">"cA <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">k</span> <span class="main">*</span> P <span class="main">=</span> P <span class="main">*</span> J <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">k</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> A JNF <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cA <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> Suc <span class="skolem">k</span> <span class="main">*</span> P <span class="main">=</span> cA <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span> <span class="main">*</span> cA <span class="main">*</span> P"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> cA <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span> <span class="main">*</span> <span class="main">(</span>P <span class="main">*</span> J <span class="main">*</span> iP<span class="main">)</span> <span class="main">*</span> P"</span></span> <span class="keyword1"><span class="command">using</span></span> JNF <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>cA <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span> <span class="main">*</span> P<span class="main">)</span> <span class="main">*</span> <span class="main">(</span>J <span class="main">*</span> <span class="main">(</span>iP <span class="main">*</span> P<span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> A JNF<span class="main">(</span>1-3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assoc_mult_mat<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">n</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"J <span class="main">*</span> <span class="main">(</span>iP <span class="main">*</span> P<span class="main">)</span> <span class="main">=</span> J"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> JNF <span class="keyword1"><span class="command">using</span></span> JNF <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Suc 
    <span class="keyword1"><span class="command">using</span></span> A JNF<span class="main">(</span>1-3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assoc_mult_mat<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">n</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> C_nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"C <span class="free">off</span> <span class="free">k</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> C_def <span class="keyword1"><span class="command">using</span></span> c_gt_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> P_nonzero_entry<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> P <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span> 
  <span class="keyword1"><span class="command">hence</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> P <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> <span class="main">(</span>iP <span class="main">*</span> P<span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span><span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">unfolding</span></span> JNF <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> iP <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> P <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> j JNF<span class="main">(</span>1-2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scalar_prod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.neutral<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> 0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">i</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> I<span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"i <span class="main">∈</span> I"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> i_def <span class="keyword1"><span class="command">using</span></span> I_nonempty some_in_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> i_n<span class="main">:</span> <span class="quoted"><span class="quoted">"i <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> P <span class="main">$$</span> <span class="main">(</span><span class="bound">j</span><span class="main">,</span> i <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"j <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"P <span class="main">$$</span> <span class="main">(</span>j<span class="main">,</span> i <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> i_n <span class="keyword1"><span class="command">have</span></span> lt<span class="main">:</span> <span class="quoted"><span class="quoted">"i <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"j <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"P <span class="main">$$</span> <span class="main">(</span>j<span class="main">,</span> i <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> j_def <span class="keyword1"><span class="command">using</span></span> someI_ex<span class="main">[</span><span class="operator">OF</span> P_nonzero_entry<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lt<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> cmod <span class="main">(</span>P <span class="main">$$</span> <span class="main">(</span>j<span class="main">,</span> i <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> B"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> P <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> unit_vec <span class="free">n</span> i"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"w <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> JNF <span class="keyword1"><span class="command">unfolding</span></span> w_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> map_vec cmod w"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"v <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> v_def <span class="keyword1"><span class="command">using</span></span> w <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> main_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">a</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">l</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> Re <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>I<span class="main">.</span> <span class="bound">a</span> <span class="bound">i</span> <span class="main">*</span> Lam <span class="bound">i</span> <span class="main">^</span> <span class="bound">l</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"complex_of_real"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cv</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_vec <span class="var">?c</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cm</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_mat <span class="var">?c</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?cv</span> v"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> iP <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?v</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cc</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">cc</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">k</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">then</span> P <span class="main">$$</span> <span class="main">(</span>j<span class="main">,</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">u</span> <span class="keyword1">$v</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> P <span class="main">$$</span> <span class="main">(</span>j<span class="main">,</span> <span class="bound">i</span> <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">u</span> <span class="keyword1">$v</span> <span class="bound">i</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> u_def <span class="keyword1"><span class="command">using</span></span> JNF<span class="main">(</span>2<span class="main">)</span> v <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">off</span>
    <span class="keyword1"><span class="command">from</span></span> i i_n <span class="keyword1"><span class="command">have</span></span> iI<span class="main">:</span> <span class="quoted"><span class="quoted">"i <span class="main">∈</span> I"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"i <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?exp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> sum <span class="main">(</span><span class="main">λ</span> <span class="bound">ii</span><span class="main">.</span> P <span class="main">$$</span> <span class="main">(</span>j<span class="main">,</span> <span class="bound">ii</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>J <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">k</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">ii</span><span class="main">,</span>i<span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> 
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> cmod <span class="main">(</span><span class="var">?exp</span> <span class="main">(</span>K <span class="skolem">off</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> C <span class="skolem">off</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"i <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> K <span class="skolem">off</span> <span class="bound">k</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> v<span class="main">)</span> <span class="keyword1">$v</span> j <span class="main">*</span> C <span class="skolem">off</span> <span class="bound">k</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">kk</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> K <span class="skolem">off</span> <span class="skolem">kk</span>"</span></span> 
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cAk</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cAk</span> <span class="main">=</span> cA <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span>"</span></span> 
      <span class="keyword1"><span class="command">have</span></span> cAk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cAk</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cAk_def <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> v<span class="main">)</span> <span class="main">$</span> j <span class="main">=</span> <span class="main">(</span><span class="main">(</span>map_mat cmod <span class="skolem">cAk</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> map_vec cmod w<span class="main">)</span> <span class="main">$</span> j"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> v_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> cAk_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> v<span class="main">)</span> <span class="main">$</span> j"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
          <span class="operator">unfold</span> of_real_hom.mat_hom_pow<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">insert</span> nonneg_mat_power<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A nonneg<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i j<span class="main"><span class="keyword3">,</span></span> 
        <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nonneg_mat_def elements_mat_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≥</span> cmod <span class="main">(</span><span class="main">(</span><span class="skolem">cAk</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> w<span class="main">)</span> <span class="main">$</span> j<span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> index_mult_mat_vec<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> j cAk w<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scalar_prod_def
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_norm_le norm_mult_ineq<span class="main">)</span> 
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cAk</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> w <span class="main">=</span> <span class="main">(</span><span class="skolem">cAk</span> <span class="main">*</span> P<span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> unit_vec <span class="free">n</span> i"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> w_def i_def <span class="keyword1"><span class="command">using</span></span> JNF cAk <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> P <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>J <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> unit_vec <span class="free">n</span> i<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cAk_def A_power_P
        <span class="keyword1"><span class="command">using</span></span> JNF <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> assoc_mult_mat_vec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">n</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"J <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> unit_vec <span class="free">n</span> i <span class="main">=</span> col <span class="main">(</span>J <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span> i"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>P <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>col <span class="main">(</span>J <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span> i<span class="main">)</span><span class="main">)</span> <span class="main">$</span> j <span class="main">=</span> Matrix.row P j <span class="main">∙</span> col <span class="main">(</span>J <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span> i"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> index_mult_mat_vec<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> j JNF<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span> <span class="bound">ii</span><span class="main">.</span> P <span class="main">$$</span> <span class="main">(</span>j<span class="main">,</span> <span class="bound">ii</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>J <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">ii</span><span class="main">,</span>i<span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> scalar_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i j JNF<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>    
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> v<span class="main">)</span> <span class="keyword1">$v</span> j <span class="main">≥</span> cmod <span class="main">(</span><span class="var">?exp</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">from</span></span> mult_right_mono<span class="main">[</span><span class="operator">OF</span> this C_nonneg<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> v<span class="main">)</span> <span class="keyword1">$v</span> j <span class="main">*</span> C <span class="skolem">off</span> <span class="skolem">kk</span> <span class="main">≥</span> cmod <span class="main">(</span><span class="var">?exp</span> <span class="skolem">k</span> <span class="main">*</span> C <span class="skolem">off</span> <span class="skolem">kk</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> norm_mult
        <span class="keyword1"><span class="command">using</span></span> C_nonneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>      
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">hence</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> K <span class="skolem">off</span> <span class="skolem">k</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> v<span class="main">)</span> <span class="keyword1">$v</span> j <span class="main">*</span> C <span class="skolem">off</span> <span class="skolem">k</span> <span class="main">≥</span> <span class="skolem">M</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="keyword1"><span class="command">unfolding</span></span> M_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">from</span></span> i <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"i <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> <span class="var">?exp</span> <span class="main">(</span>K <span class="skolem">off</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> C <span class="skolem">off</span> <span class="bound">k</span><span class="main">)</span> <span class="main">⇢</span> 
      <span class="main">(</span><span class="main">∑</span><span class="bound">ii</span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> P <span class="main">$$</span> <span class="main">(</span>j<span class="main">,</span> <span class="bound">ii</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">if</span> i <span class="main">∈</span> I <span class="main">∧</span> <span class="bound">ii</span> <span class="main">=</span> i <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">then</span> Lam i <span class="main">^</span> <span class="skolem">off</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇢</span> <span class="var">?sum</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> sum_distrib_right mult.assoc 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tendsto_sum<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> tendsto_mult<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> limit_jordan_matrix<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ i<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sum</span> <span class="main">=</span> P <span class="main">$$</span> <span class="main">(</span>j<span class="main">,</span> i <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> Lam i <span class="main">^</span> <span class="skolem">off</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.remove<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ mem<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sum.neutral<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> iI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> tend1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="bound">k</span><span class="main">.</span> <span class="var">?exp</span> <span class="main">(</span>K <span class="skolem">off</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> C <span class="skolem">off</span> <span class="bound">k</span><span class="main">)</span> <span class="main">⇢</span> P <span class="main">$$</span> <span class="main">(</span>j<span class="main">,</span> i <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> Lam i <span class="main">^</span> <span class="skolem">off</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> tend2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">⇢</span> cmod <span class="main">(</span>P <span class="main">$$</span> <span class="main">(</span>j<span class="main">,</span> i <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> Lam i <span class="main">^</span> <span class="skolem">off</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> M_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tendsto_norm<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> tend1<span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span> j <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"P <span class="main">$$</span> <span class="main">(</span>j<span class="main">,</span> i <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> cmod <span class="main">(</span>P <span class="main">$$</span> <span class="main">(</span>j<span class="main">,</span> i <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> Lam i <span class="main">^</span> <span class="skolem">off</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">from</span></span> cmod_Lam<span class="main">[</span><span class="operator">OF</span> iI<span class="main">]</span> 0 <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> E_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> tend2<span class="main">[</span><span class="operator">folded</span> E_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> tend2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">⇢</span> <span class="skolem">E</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">from</span></span> ge <span class="keyword1"><span class="command">have</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="skolem">k</span> <span class="main">≥</span> <span class="skolem">M</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="keyword1"><span class="command">unfolding</span></span> G_def <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">from</span></span> tend2<span class="main">[</span><span class="operator">unfolded</span> LIMSEQ_iff<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> E<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≥</span> <span class="skolem">k'</span> <span class="main">⟹</span> norm <span class="main">(</span><span class="skolem">M</span> <span class="bound">k</span> <span class="main">-</span> <span class="skolem">E</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">E</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≥</span> <span class="skolem">k'</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> diff<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> norm<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">M</span> <span class="skolem">k</span> <span class="main">-</span> <span class="skolem">E</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">E</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="skolem">k</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> M_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> E norm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="skolem">k</span> <span class="main">≥</span> <span class="skolem">E</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> real_norm_def field_sum_of_halves<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> ge<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> E <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="skolem">k</span> <span class="main">≥</span> <span class="skolem">E</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">=</span> B"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> E_def B_def j norm_mult norm_power 
          cmod_Lam<span class="main">[</span><span class="operator">OF</span> iI<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="skolem">k</span> <span class="main">≥</span> B"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">k'</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≥</span> <span class="bound">k'</span> <span class="main">⟶</span> <span class="skolem">G</span> <span class="bound">k</span> <span class="main">≥</span> B"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>    
    <span class="keyword1"><span class="command">hence</span></span> Bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k'</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≥</span><span class="bound">k'</span><span class="main">.</span> B <span class="main">≤</span> <span class="skolem">G</span> <span class="bound">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">kk</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> K <span class="skolem">off</span> <span class="skolem">kk</span>"</span></span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> v<span class="main">)</span> <span class="main">$</span> j <span class="main">*</span> C <span class="skolem">off</span> <span class="skolem">kk</span> <span class="main">=</span> Re <span class="main">(</span><span class="var">?c</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> v<span class="main">)</span> <span class="main">$</span> j <span class="main">*</span> C <span class="skolem">off</span> <span class="skolem">kk</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> v<span class="main">)</span> <span class="main">$</span> j <span class="main">*</span> C <span class="skolem">off</span> <span class="skolem">kk</span><span class="main">)</span> <span class="main">=</span> <span class="var">?cv</span> <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> v<span class="main">)</span> <span class="main">$</span> j <span class="main">*</span> <span class="var">?c</span> <span class="main">(</span>C <span class="skolem">off</span> <span class="skolem">kk</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> j A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?cv</span> <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> v<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?cm</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> of_real_hom.mult_mat_vec_hom<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ v<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>cA <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?v</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_real_hom.mat_hom_pow<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>cA <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="main">(</span>P <span class="main">*</span> iP<span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="var">?v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> JNF <span class="keyword1"><span class="command">using</span></span> v <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>cA <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>P <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">u</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> u_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> assoc_mult_mat_vec<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> JNF v<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>P <span class="main">*</span> J <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A_power_P<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> assoc_mult_mat_vec<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> u JNF<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>P <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>J <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assoc_mult_mat_vec<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> u JNF<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> v<span class="main">)</span> <span class="keyword1">$v</span> j <span class="main">*</span> C <span class="skolem">off</span> <span class="skolem">kk</span> <span class="main">=</span> Re <span class="main">(</span><span class="main">(</span>P <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>J <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">u</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> j <span class="main">*</span> C <span class="skolem">off</span> <span class="skolem">kk</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Re <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span>
           P <span class="main">$$</span> <span class="main">(</span>j<span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="main">(</span>J <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">u</span> <span class="keyword1">$v</span> <span class="bound">ia</span> <span class="main">*</span> C <span class="skolem">off</span> <span class="skolem">kk</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> index_mult_mat_vec<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> JNF<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> j u<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scalar_prod_def sum_distrib_right<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
           mult.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>  
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> v<span class="main">)</span> <span class="keyword1">$v</span> j <span class="main">*</span> C <span class="skolem">off</span> <span class="skolem">kk</span> <span class="main">=</span>
        Re <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> P <span class="main">$$</span> <span class="main">(</span>j<span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span>J <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">ia</span><span class="main">)</span> <span class="main">*</span> C <span class="skolem">off</span> <span class="skolem">kk</span> <span class="main">*</span> <span class="skolem">u</span> <span class="keyword1">$v</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> k_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> A_to_u <span class="main">=</span> this
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ia</span><span class="main">∈</span>I<span class="main">.</span> <span class="skolem">a</span> <span class="bound">ia</span> <span class="main">*</span> Lam <span class="bound">ia</span> <span class="main">^</span> <span class="skolem">off</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">⇢</span> 
       Re <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> P <span class="main">$$</span> <span class="main">(</span>j<span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span>
           <span class="main">(</span><span class="main">∑</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">ia</span> <span class="main">∈</span> I <span class="main">∧</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">ia</span> <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>Lam <span class="bound">ia</span><span class="main">)</span><span class="main">^</span><span class="skolem">off</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">u</span> <span class="keyword1">$v</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> A_to_u G_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tendsto_Re<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tendsto_sum<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tendsto_mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ 
        tendsto_sum<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tendsto_mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> limit_jordan_matrix<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> P <span class="main">$$</span> <span class="main">(</span>j<span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span>
           <span class="main">(</span><span class="main">∑</span><span class="bound">ia</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">ia</span> <span class="main">∈</span> I <span class="main">∧</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">ia</span> <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>Lam <span class="bound">ia</span><span class="main">)</span><span class="main">^</span><span class="skolem">off</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">u</span> <span class="keyword1">$v</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span>
      <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ia</span> <span class="main">∈</span> I<span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">ia</span> <span class="main">∈</span> I <span class="main">∧</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">ia</span> <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">then</span> P <span class="main">$$</span> <span class="main">(</span>j<span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>Lam <span class="bound">ia</span><span class="main">)</span><span class="main">^</span><span class="skolem">off</span> <span class="main">*</span> <span class="skolem">u</span> <span class="keyword1">$v</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> sum_distrib_left<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sum.mono_neutral_left<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">insert</span> I_n<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ia</span> <span class="main">∈</span> I<span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">ia</span> <span class="main">-</span> <span class="main">(</span><span class="free">m</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">then</span> P <span class="main">$$</span> <span class="main">(</span>j<span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>Lam <span class="bound">ia</span><span class="main">)</span><span class="main">^</span><span class="skolem">off</span> <span class="main">*</span> <span class="skolem">u</span> <span class="keyword1">$v</span> <span class="bound">ia</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sum.swap<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted">I</span><span class="main">]</span> sum_distrib_right
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ia</span> <span class="main">∈</span> I<span class="main">.</span> <span class="skolem">cc</span> <span class="bound">ia</span> <span class="main">*</span> <span class="main">(</span>Lam <span class="bound">ia</span><span class="main">)</span><span class="main">^</span><span class="skolem">off</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cc_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cc_def a_def F_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> I_n<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> tend3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">⇢</span> Re <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> LIMSEQ_iff<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"B <span class="main">/</span> <span class="numeral">2</span>"</span></span><span class="main">]</span> B
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">kk</span></span> <span class="keyword2"><span class="keyword">where</span></span> kk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≥</span> <span class="skolem">kk</span> <span class="main">⟹</span> norm <span class="main">(</span><span class="skolem">G</span> <span class="bound">k</span> <span class="main">-</span> Re <span class="skolem">F</span><span class="main">)</span> <span class="main">&lt;</span> B <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> Bound <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">kk'</span></span> <span class="keyword2"><span class="keyword">where</span></span> kk'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≥</span> <span class="skolem">kk'</span> <span class="main">⟹</span> B <span class="main">≤</span> <span class="skolem">G</span> <span class="bound">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> max <span class="skolem">kk</span> <span class="skolem">kk'</span>"</span></span> 
    <span class="keyword1"><span class="command">with</span></span> kk kk' <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="skolem">G</span> <span class="skolem">k</span> <span class="main">-</span> Re <span class="skolem">F</span><span class="main">)</span> <span class="main">&lt;</span> B <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"B <span class="main">≤</span> <span class="skolem">G</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Re <span class="skolem">F</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> real_norm_def field_sum_of_halves<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> main_theorem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">n_as</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> main_step <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">l</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> Re <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>I<span class="main">.</span> <span class="skolem">a</span> <span class="bound">i</span> <span class="main">*</span> Lam <span class="bound">i</span> <span class="main">^</span> <span class="bound">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">∈</span> Lam <span class="main">`</span> I"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sum_root_unity_power_pos_implies_1<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted">Lam</span> <span class="quoted">I</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> pos<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> I"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> d<span class="main">[</span><span class="operator">OF</span> I_Lam<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span> cmod_Lam<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> Lam <span class="skolem">i</span> <span class="main">^</span> <span class="bound">d</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> I"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Lam <span class="skolem">i</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> I_Lam<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nonneg_sr_1_largest_jb<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_mat <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> jnf<span class="main">:</span> <span class="quoted"><span class="quoted">"jordan_nf <span class="main">(</span>map_mat complex_of_real <span class="free">A</span><span class="main">)</span> <span class="free">n_as</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="free">lam</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">n_as</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> lam1<span class="main">:</span> <span class="quoted"><span class="quoted">"cmod <span class="free">lam</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> sr1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">M</span><span class="main">.</span> <span class="bound">M</span> <span class="main">≥</span> <span class="free">m</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">M</span><span class="main">,</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">n_as</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> jnf' <span class="main">=</span> jnf<span class="main">[</span><span class="operator">unfolded</span> jordan_nf_def<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> jnf' similar_matD<span class="main">[</span><span class="operator">OF</span> jnf'<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> conjunct2<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="skolem">n</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n_as0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="free">n_as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound">m</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">lam</span><span class="main">.</span> <span class="main">(</span><span class="bound">m</span><span class="main">,</span><span class="bound">lam</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">n_as</span> <span class="main">∧</span> cmod <span class="bound">lam</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">∈</span> <span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mem lam1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?M</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_set<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"map fst <span class="free">n_as</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> Max <span class="var">?M</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∈</span> <span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fin m <span class="keyword1"><span class="command">unfolding</span></span> M_def <span class="keyword1"><span class="command">using</span></span> Max_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Lam</span></span> <span class="keyword2"><span class="keyword">where</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">M</span><span class="main">,</span><span class="skolem">Lam</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">n_as</span>"</span></span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">Lam</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> m fin <span class="keyword1"><span class="command">have</span></span> mM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> M_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">interpret</span></span> spectral_radius_1_jnf_max <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">M</span></span> <span class="quoted"><span class="skolem">Lam</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> nonneg<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> jnf<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> M<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> M<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sr1<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">la</span>
    <span class="keyword3"><span class="command">assume</span></span> kla<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">la</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">n_as</span>"</span></span> 
    <span class="keyword1"><span class="command">with</span></span> fin <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">la</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> M_def <span class="keyword1"><span class="command">using</span></span> Max_ge <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ks</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"decompose_prod_root_unity <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ks</span><span class="main">,</span> <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> n_as0 kla <span class="keyword1"><span class="command">have</span></span> k0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cA</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_mat complex_of_real <span class="free">A</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> split_list<span class="main">[</span><span class="operator">OF</span> kla<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> nas<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n_as</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span><span class="skolem">la</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>char_poly <span class="var">?cA</span><span class="main">)</span> <span class="skolem">la</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k0
      <span class="keyword1"><span class="command">unfolding</span></span> jordan_nf_char_poly<span class="main">[</span><span class="operator">OF</span> jnf<span class="main">]</span> nas poly_prod_list prod_list_zero_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> sumlist_nf<span class="main">:</span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map fst <span class="free">n_as</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map fst <span class="free">n_as</span><span class="main">)</span> <span class="main">=</span> dim_row <span class="main">(</span>jordan_matrix <span class="free">n_as</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> dim_row <span class="var">?cA</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> similar_matD<span class="main">[</span><span class="operator">OF</span> jnf'<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> conjunct2<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> nas<span class="main">]</span> k0 <span class="keyword1"><span class="command">have</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> perron_frobenius_for_complexity_jnf<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> A n0 nonneg sr1 decomp rt<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">la</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">la</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">(</span>cmod <span class="skolem">la</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> main_theorem
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mM <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">hide_const</span></span><span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> spectral_radius

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> ring_hom<span class="main">)</span> hom_smult_mat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">hom</span> <span class="free">a</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hom_mult<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> root_char_poly_smult<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex mat"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>poly <span class="main">(</span>char_poly <span class="main">(</span><span class="free">k</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>poly <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">/</span> <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> order_char_poly_smult<span class="main">[</span><span class="operator">OF</span> A k<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> A degree_0 degree_monic_char_poly monic_degree_0 order_root smult_carrier_mat<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> real_nonneg_mat_spectral_radius_largest_jordan_block<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"real_nonneg_mat <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"jordan_nf <span class="free">A</span> <span class="free">n_as</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="free">lam</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">n_as</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cmod <span class="free">lam</span> <span class="main">=</span> spectral_radius <span class="free">A</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound"><span class="bound">M</span></span> <span class="main">≥</span> <span class="free">m</span><span class="main">.</span> <span class="main">(</span><span class="bound">M</span><span class="main">,</span> of_real <span class="main">(</span>spectral_radius <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">n_as</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> similar_matD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> jordan_nf_def<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct2<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="skolem">n</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted">complex_of_real</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> map_mat Re <span class="free">A</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> carrier_mat <span class="skolem">n</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> AB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> map_mat <span class="var">?c</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> B_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> real_nonneg_mat_def elements_mat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_mat <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> AB 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> real_nonneg_mat_def elements_mat_def nonneg_mat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"spectral_radius <span class="free">A</span>"</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?sr</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">isr</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">isr</span> <span class="main">=</span> inverse <span class="var">?sr</span>"</span></span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nas</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="var">?c</span> <span class="skolem">isr</span> <span class="main">*</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="free">n_as</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> isr0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">isr</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> isr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> cisr0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="skolem">isr</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> False assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> isr_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">isr</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> isr_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> norm_ge_zero positive_imp_inverse_positive<span class="main">)</span>    
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="skolem">isr</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> carrier_mat <span class="skolem">n</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">unfolding</span></span> C_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> BC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="var">?sr</span> <span class="keyword1">⋅<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> isr0 <span class="keyword1"><span class="command">unfolding</span></span> C_def isr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_mat <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> C_def <span class="keyword1"><span class="command">using</span></span> isr_pos nonneg
      <span class="keyword1"><span class="command">unfolding</span></span> nonneg_mat_def elements_mat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> jordan_nf_smult<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> AB<span class="main"><span class="main">]</span></span> cisr0<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> jnf<span class="main">:</span> <span class="quoted"><span class="quoted">"jordan_nf <span class="main">(</span>map_mat <span class="var">?c</span> <span class="skolem">C</span><span class="main">)</span> <span class="var">?nas</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> C_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> of_real_hom.hom_smult_mat<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="var">?c</span> <span class="skolem">isr</span> <span class="main">*</span> <span class="free">lam</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?nas</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"cmod <span class="main">(</span><span class="var">?c</span> <span class="skolem">isr</span> <span class="main">*</span> <span class="free">lam</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False isr_pos <span class="keyword1"><span class="command">unfolding</span></span> isr_def norm_mult assms<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> mult.commute norm_of_real right_inverse<span class="main">)</span>        
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">have</span></span> B'<span class="main">:</span> <span class="quoted"><span class="quoted">"map_mat <span class="var">?c</span> <span class="skolem">B</span> <span class="main">∈</span> carrier_mat <span class="skolem">n</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>char_poly <span class="skolem">C</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>char_poly <span class="main">(</span>map_mat <span class="var">?c</span> <span class="skolem">C</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?c</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> of_real_hom.char_poly_hom<span class="main">[</span><span class="operator">OF</span> C<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="var">?c</span> <span class="skolem">x</span> <span class="main">/</span> <span class="var">?c</span> <span class="skolem">isr</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> C_def of_real_hom.hom_smult_mat AB
        <span class="keyword1"><span class="command">unfolding</span></span> root_char_poly_smult<span class="main">[</span><span class="operator">OF</span> B' cisr0<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"eigenvalue <span class="free">A</span> <span class="main">(</span><span class="var">?c</span> <span class="skolem">x</span> <span class="main">/</span> <span class="var">?c</span> <span class="skolem">isr</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eigenvalue_root_char_poly<span class="main">[</span><span class="operator">OF</span> A<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">hence</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"cmod <span class="main">(</span><span class="var">?c</span> <span class="skolem">x</span> <span class="main">/</span> <span class="var">?c</span> <span class="skolem">isr</span><span class="main">)</span> <span class="main">∈</span> cmod <span class="main">`</span> spectrum <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> spectrum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> Max_ge<span class="main">[</span><span class="operator">OF</span> finite_imageI this<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cmod <span class="main">(</span><span class="var">?c</span> <span class="skolem">x</span> <span class="main">/</span> <span class="var">?c</span> <span class="skolem">isr</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?sr</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Spectral_Radius.spectral_radius_def
        <span class="keyword1"><span class="command">using</span></span> A card_finite_spectrum<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cmod <span class="main">(</span><span class="var">?c</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> isr0 isr_pos <span class="keyword1"><span class="command">unfolding</span></span> isr_def 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> norm_divide norm_mult<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> sr <span class="main">=</span> this 
    <span class="keyword1"><span class="command">from</span></span> nonneg_sr_1_largest_jb<span class="main">[</span><span class="operator">OF</span> nonneg jnf mem 1 sr<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">≥</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">M</span><span class="main">,</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?nas</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> M<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">M</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">n_as</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> <span class="var">?c</span> <span class="skolem">isr</span> <span class="main">*</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="var">?c</span> <span class="var">?sr</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> isr0 <span class="keyword1"><span class="command">unfolding</span></span> isr_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">M</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> mem a M<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> jordan_nf_root_char_poly<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eigenvalue <span class="free">A</span> <span class="free">lam</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eigenvalue_root_char_poly<span class="main">[</span><span class="operator">OF</span> A<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cmod <span class="free">lam</span> <span class="main">∈</span> cmod <span class="main">`</span> spectrum <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> spectrum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> Max_ge<span class="main">[</span><span class="operator">OF</span> finite_imageI this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cmod <span class="free">lam</span> <span class="main">≤</span> <span class="var">?sr</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Spectral_Radius.spectral_radius_def
      <span class="keyword1"><span class="command">using</span></span> A card_finite_spectrum<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> True<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> lam0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lam</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> lam0<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Hom_Gauss_Jordan">
<div class="head">
<h1>Theory Hom_Gauss_Jordan</h1>
</div>
<pre class="source"><span class="comment1">(* author: Thiemann *)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Homomorphisms of Gauss-Jordan Elimination, Kernel and More›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Hom_Gauss_Jordan
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../Jordan_Normal_Form/Matrix_Kernel.html">Jordan_Normal_Form.Matrix_Kernel</a>
   <a href="../Jordan_Normal_Form/Jordan_Normal_Form_Uniqueness.html">Jordan_Normal_Form.Jordan_Normal_Form_Uniqueness</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> comm_ring_hom<span class="main">)</span> similar_mat_wit_hom<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span>
  <span class="quoted"><span class="quoted">"similar_mat_wit <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">D</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"similar_mat_wit <span class="main">(</span><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">C</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">D</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> dim_row <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> similar_mat_witD<span class="main">[</span><span class="operator">OF</span> n assms<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="free">C</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> C <span class="main">=</span> *<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> D <span class="main">=</span> *<span class="main">(</span>7<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> id <span class="main">=</span> mat_hom_mult<span class="main">[</span><span class="operator">OF</span> C D<span class="main">]</span> mat_hom_mult<span class="main">[</span><span class="operator">OF</span> D C<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> ** <span class="main">=</span> *<span class="main">(</span>1-3<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> arg_cong<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator"><span class="operator"><span class="operator">of</span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span></span></span>"</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main">,</span> <span class="operator">unfolded</span> id<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> mult <span class="main">=</span> mult_carrier_mat<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> hom_mult <span class="main">=</span> mat_hom_mult<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> similar_mat_wit_def Let_def <span class="keyword1"><span class="command">unfolding</span></span> **<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> **<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> hom_mult <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> *<span class="main"><span class="main">(</span></span>4-<span class="main"><span class="main">)</span></span> mult<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> comm_ring_hom<span class="main">)</span> similar_mat_hom<span class="main">:</span>
  <span class="quoted"><span class="quoted">"similar_mat <span class="free">A</span> <span class="free">B</span> <span class="main">⟹</span> similar_mat <span class="main">(</span><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> similar_mat_wit_hom<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="skolem">C</span></span> <span class="quoted"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="skolem">C</span> <span class="skolem">D</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> similar_mat_def<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> field_hom
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemma</span></span> hom_swaprows<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">⟹</span>
  <span class="keyword1">swaprows</span> <span class="free">i</span> <span class="free">j</span> <span class="main">(</span><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">(</span><span class="keyword1">swaprows</span> <span class="free">i</span> <span class="free">j</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mat_swaprows_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hom_gauss_jordan_main<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">nc</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">nc2</span> <span class="main">⟹</span>
  gauss_jordan_main <span class="main">(</span><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">B</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span>
  map_prod <span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">(</span>gauss_jordan_main <span class="free">A</span> <span class="free">B</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> gauss_jordan_main.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 1<span class="main">(</span>1-4<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> AB <span class="main">=</span> 1<span class="main">(</span>5-6<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> AB <span class="keyword1"><span class="command">have</span></span> dim<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="skolem">A</span> <span class="main">=</span> <span class="free">nr</span>"</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="skolem">A</span> <span class="main">=</span> <span class="free">nc</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?hp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_prod <span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> gauss_jordan_main.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> gauss_jordan_main.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="skolem">A</span>"</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span>
    index_map_mat Let_def if_distrib<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?hp</span></span></span><span class="main">]</span> dim
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> if_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">[</span><span class="operator">OF</span> dim<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator">symmetric</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span> 1 refl<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">nr</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">nc</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> hij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?h</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">hom</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> AB <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ixs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ixs</span> <span class="main">=</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i'</span><span class="main">.</span> <span class="keyword1">if</span> <span class="skolem">A</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i'</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[</span><span class="bound">i'</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[</span>Suc <span class="skolem">i</span><span class="main">..&lt;</span><span class="free">nr</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">i'</span><span class="main">.</span> <span class="keyword1">if</span> <span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="skolem">A</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i'</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[</span><span class="bound">i'</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[</span>Suc <span class="skolem">i</span><span class="main">..&lt;</span><span class="free">nr</span><span class="main">]</span> <span class="main">=</span>
       map <span class="main">(</span><span class="main">λ</span><span class="bound">i'</span><span class="main">.</span> <span class="keyword1">if</span> <span class="skolem">A</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i'</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[</span><span class="bound">i'</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[</span>Suc <span class="skolem">i</span><span class="main">..&lt;</span><span class="free">nr</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> map_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ij AB<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> hij hom_0_iff hom_1_iff id ixs_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> if_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl _ if_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 1<span class="main">,</span> <span class="operator">folded</span> ixs_def<span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ixs</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Nil <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Nil AB<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">I</span> <span class="skolem">ix</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">∈</span> set <span class="skolem">ixs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">&lt;</span> <span class="free">nr</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ixs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> AB <span class="keyword1"><span class="command">have</span></span> swap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">swaprows</span> <span class="skolem">i</span> <span class="skolem">I</span> <span class="skolem">A</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">nc</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">swaprows</span> <span class="skolem">i</span> <span class="skolem">I</span> <span class="skolem">B</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">nc2</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Cons list.simps IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Cons swap<span class="main">,</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> AB ij I
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hom_swaprows<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">from</span></span> AB <span class="keyword1"><span class="command">have</span></span> elim<span class="main">:</span> <span class="quoted"><span class="quoted">"eliminate_entries <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">A</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">nc</span>"</span></span>
          <span class="quoted"><span class="quoted">"eliminate_entries <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">A</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="skolem">B</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">nc2</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> eliminate_entries_gen_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> IH<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 2 refl elim<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="bound"><span class="bound"><span class="bound">y</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> gauss_jordan_main <span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="bound"><span class="bound"><span class="bound">y</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>Suc <span class="skolem"><span class="skolem"><span class="skolem">i</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>Suc <span class="skolem"><span class="skolem"><span class="skolem">j</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span>
        <span class="operator">intro</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> AB ij<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eliminate_entries_gen_def hom_minus hom_mult<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 3
      <span class="keyword1"><span class="command">from</span></span> AB <span class="keyword1"><span class="command">have</span></span> mult<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">multrow</span> <span class="skolem">i</span> <span class="main">(</span>inverse <span class="main">(</span><span class="skolem">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">nc</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="keyword1">multrow</span> <span class="skolem">i</span> <span class="main">(</span>inverse <span class="main">(</span><span class="skolem">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">B</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">nc2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> IH<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 3 refl mult<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="bound"><span class="bound"><span class="bound">y</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> gauss_jordan_main <span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="bound"><span class="bound"><span class="bound">y</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">i</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">j</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span>
        <span class="operator">intro</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> AB ij<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hom_inverse hom_mult<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hom_gauss_jordan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">nc</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">nc2</span> <span class="main">⟹</span>
  gauss_jordan <span class="main">(</span><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> map_prod <span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">(</span>gauss_jordan <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gauss_jordan_def <span class="keyword1"><span class="command">using</span></span> hom_gauss_jordan_main <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> hom_gauss_jordan_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"gauss_jordan_single <span class="main">(</span><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">(</span>gauss_jordan_single <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dim_row <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nc</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"dim_col <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="var">?nr</span> <span class="main">0</span> <span class="main">∈</span> carrier_mat <span class="var">?nr</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> dim<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="var">?nr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> hom0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="var">?nr</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="var">?nr</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="var">?nr</span> <span class="var">?nc</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> hom_gauss_jordan<span class="main">[</span><span class="operator">OF</span> A 0<span class="main">]</span> A
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> gauss_jordan_single_def dim hom0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_map_prod<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hom_pivot_positions_main_gen<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">nr</span> <span class="free">nc</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pivot_positions_main_gen <span class="main">0</span> <span class="main">(</span><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">A</span><span class="main">)</span> <span class="free">nr</span> <span class="free">nc</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> pivot_positions_main_gen <span class="main">0</span> <span class="free">A</span> <span class="free">nr</span> <span class="free">nc</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pivot_positions_main_gen.induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">nr</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">nc</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> pivot_positions_main_gen.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">nr</span></span> <span class="quoted"><span class="free">nc</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> if_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl if_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl _ refl<span class="main"><span class="main">]</span></span> refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">hom</span> <span class="main">(</span><span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> IH<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id hom_0_iff
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> if_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hom_pivot_positions<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pivot_positions <span class="main">(</span><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> pivot_positions <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pivot_positions_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> hom_pivot_positions_main_gen<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hom_kernel_dim<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"kernel_dim <span class="main">(</span><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> kernel_dim <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> kernel_dim_code <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> hom_char_matrix<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"char_matrix <span class="main">(</span><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">hom</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="main">(</span>char_matrix <span class="free">A</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> char_matrix_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_matI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hom_minus<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hom_dim_gen_eigenspace<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_gen_eigenspace <span class="main">(</span><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">hom</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> dim_gen_eigenspace <span class="free">A</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_gen_eigenspace <span class="main">(</span><span class="keyword1">mat<span class="hidden">⇩</span><sub>h</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">hom</span> <span class="free">x</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">=</span> dim_gen_eigenspace <span class="free">A</span> <span class="free">x</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dim_gen_eigenspace_def hom_char_matrix<span class="main">[</span><span class="operator">OF</span> A<span class="main">]</span>
      mat_hom_pow<span class="main">[</span><span class="operator">OF</span> char_matrix_closed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Spectral_Radius_Theory_2">
<div class="head">
<h1>Theory Spectral_Radius_Theory_2</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Thiemann *)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Combining Spectral Radius Theory with Perron Frobenius theorem›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Spectral_Radius_Theory_2
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Spectral_Radius_Largest_Jordan_Block.html">Spectral_Radius_Largest_Jordan_Block</a>
  <a href="Hom_Gauss_Jordan.html">Hom_Gauss_Jordan</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">hide_const</span></span><span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Coset.order

<span class="keyword1"><span class="command">lemma</span></span> jnf_complexity_generic<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> sr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> cmod <span class="bound">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> cmod <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span>
    order <span class="bound">x</span> <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∀</span> <span class="bound">bsize</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>compute_set_of_jordan_blocks <span class="free">A</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">bsize</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span> <span class="bound">c2</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> norm_bound <span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="bound">c1</span> <span class="main">+</span> <span class="bound">c2</span> <span class="main">*</span> of_nat <span class="bound">k</span> <span class="main">^</span> <span class="free">d</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> char_poly_factorized<span class="main">[</span><span class="operator">OF</span> A<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> cA<span class="main">:</span> <span class="quoted"><span class="quoted">"char_poly <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">a</span><span class="main">←</span><span class="skolem">as</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">a</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lenn<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">as</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> jordan_nf_exists<span class="main">[</span><span class="operator">OF</span> A cA<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n_xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> jnf<span class="main">:</span> <span class="quoted"><span class="quoted">"jordan_nf <span class="free">A</span> <span class="skolem">n_xs</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> dd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">^</span> <span class="free">d</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">^</span><span class="main">(</span><span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dd
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> jordan_nf_matrix_poly_bound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ _ jnf<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> nx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span><span class="main">,</span><span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">n_xs</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> jordan_nf_block_size_order_bound<span class="main">[</span><span class="operator">OF</span> jnf nx<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> no<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> order <span class="skolem">x</span> <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> no <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">x</span> <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> order_root <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> sr<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">note</span></span> rt
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> sr <span class="main">=</span> this
    <span class="keyword3"><span class="command">assume</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> sr <span class="keyword1"><span class="command">have</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> lt no <span class="keyword1"><span class="command">have</span></span> ord<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> order <span class="skolem">x</span> <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> 1<span class="main">[</span><span class="operator">OF</span> rt c1 ord<span class="main">,</span> <span class="operator">unfolded</span> compute_set_of_jordan_blocks<span class="main"><span class="main">[</span></span><span class="operator">OF</span> jnf<span class="main"><span class="main">]</span></span><span class="main">]</span> nx lt
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> norm_bound_complex_to_real<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> bnd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span> <span class="bound">c2</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> norm_bound <span class="main">(</span><span class="main">(</span>map_mat complex_of_real <span class="free">A</span><span class="main">)</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="bound">c1</span> <span class="main">+</span> <span class="bound">c2</span> <span class="main">*</span> of_nat <span class="bound">k</span> <span class="main">^</span> <span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span> <span class="bound">c2</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> elements_mat <span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">k</span><span class="main">)</span> <span class="main">⟶</span> abs <span class="bound">a</span> <span class="main">≤</span> <span class="main">(</span><span class="bound">c1</span> <span class="main">+</span> <span class="bound">c2</span> <span class="main">*</span> of_nat <span class="bound">k</span> <span class="main">^</span> <span class="free">d</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_mat complex_of_real <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> bnd <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1</span></span> <span class="skolem"><span class="skolem">c2</span></span> <span class="keyword2"><span class="keyword">where</span></span> nb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">k</span><span class="main">.</span> norm_bound <span class="main">(</span><span class="var">?B</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">c1</span> <span class="main">+</span> <span class="skolem">c2</span> <span class="main">*</span> real <span class="bound">k</span> <span class="main">^</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">c1</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">c2</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> elements_mat <span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> pow_carrier_mat<span class="main">[</span><span class="operator">OF</span> A<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> elements_mat <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> ij nb<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span><span class="main">(</span><span class="var">?B</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">c1</span> <span class="main">+</span> <span class="skolem">c2</span> <span class="main">*</span> real <span class="skolem">k</span> <span class="main">^</span> <span class="free">d</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> norm_bound_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?B</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> of_real <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> of_real_hom.mat_hom_pow<span class="main">[</span><span class="operator">OF</span> A<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> a <span class="keyword1"><span class="command">using</span></span> ij A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>complex_of_real <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> abs <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"abs <span class="skolem">a</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">c1</span> <span class="main">+</span> <span class="skolem">c2</span> <span class="main">*</span> real <span class="skolem">k</span> <span class="main">^</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dim_gen_eigenspace_max_jordan_block<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> jnf<span class="main">:</span> <span class="quoted"><span class="quoted">"jordan_nf <span class="free">A</span> <span class="free">n_as</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_gen_eigenspace <span class="free">A</span> <span class="free">l</span> <span class="free">d</span> <span class="main">=</span> order <span class="free">l</span> <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="main">⟷</span> 
    <span class="main">(</span><span class="main">∀</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span><span class="free">l</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">n_as</span> <span class="main">⟶</span> <span class="bound">n</span> <span class="main">≤</span> <span class="free">d</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?list</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span><span class="main">←</span><span class="free">n_as</span> <span class="main">.</span> <span class="bound">e</span> <span class="main">=</span> <span class="free">l</span><span class="main">]</span>"</span></span>   
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">list</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">list</span> <span class="main">=</span> <span class="main">[</span><span class="bound">na</span><span class="main">←</span><span class="free">n_as</span> <span class="main">.</span> snd <span class="bound">na</span> <span class="main">=</span> <span class="free">l</span><span class="main">]</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?list</span> <span class="main">=</span> <span class="skolem">list</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> list_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n_as</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="free">l</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">n_as</span> <span class="main">⟶</span> <span class="bound">n</span> <span class="main">≤</span> <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">n</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">list</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> <span class="free">d</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> list_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ns</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">=</span> map fst <span class="skolem">list</span>"</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dim_gen_eigenspace<span class="main">[</span><span class="operator">OF</span> jnf<span class="main">]</span> jordan_nf_order<span class="main">[</span><span class="operator">OF</span> jnf<span class="main">]</span> list list_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> id
    <span class="keyword1"><span class="command">unfolding</span></span> ns_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ns</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">n</span> <span class="skolem">ns</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="free">d</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map <span class="main">(</span>min <span class="free">d</span><span class="main">)</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">≤</span> sum_list <span class="skolem">ns</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ns</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> jnf_complexity_1_complex<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"complex mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"real_nonneg_mat <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> sr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> cmod <span class="bound">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span>  
    order <span class="main">1</span> <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⟹</span> 
    dim_gen_eigenspace <span class="free">A</span> <span class="main">1</span> <span class="main">(</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> order <span class="main">1</span> <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span> <span class="bound">c2</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> norm_bound <span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="bound">c1</span> <span class="main">+</span> <span class="bound">c2</span> <span class="main">*</span> of_nat <span class="bound">k</span> <span class="main">^</span> <span class="free">d</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">from</span></span> char_poly_factorized<span class="main">[</span><span class="operator">OF</span> A<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> cA<span class="main">:</span> <span class="quoted"><span class="quoted">"char_poly <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">a</span><span class="main">←</span><span class="skolem">as</span><span class="main">.</span> <span class="main">[:</span><span class="main">-</span> <span class="bound">a</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> lenn<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">as</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> jordan_nf_exists<span class="main">[</span><span class="operator">OF</span> A cA<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n_as</span></span> <span class="keyword2"><span class="keyword">where</span></span> jnf<span class="main">:</span> <span class="quoted"><span class="quoted">"jordan_nf <span class="free">A</span> <span class="skolem">n_as</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> dd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">^</span> <span class="free">d</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">^</span><span class="main">(</span><span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="free">n</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dd
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> jordan_nf_matrix_poly_bound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ _ jnf<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">assume</span></span> na<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">n_as</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> jordan_nf_root_char_poly<span class="main">[</span><span class="operator">OF</span> jnf na<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> degree_monic_char_poly<span class="main">[</span><span class="operator">OF</span> A<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> degree0_coeffs<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> sr<span class="main">[</span><span class="operator">OF</span> rt<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">a</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">a</span> <span class="main">=</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> rt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> spectrum <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A spectrum_root_char_poly <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">∈</span> cmod <span class="main">`</span> spectrum <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> spec <span class="main">=</span> spectral_radius_mem_max<span class="main">[</span><span class="operator">OF</span> A n0<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> spec<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 11<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> spectral_radius <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> spec<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> spectrum_root_char_poly<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">]</span> sr <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"spectral_radius <span class="free">A</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> le <span class="keyword1"><span class="command">have</span></span> sr<span class="main">:</span> <span class="quoted"><span class="quoted">"spectral_radius <span class="free">A</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span> 
      <span class="keyword1"><span class="command">hence</span></span> nd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> real_nonneg_mat_spectral_radius_largest_jordan_block<span class="main">[</span><span class="operator">OF</span> nonneg jnf na<span class="main">,</span> <span class="operator">unfolded</span> sr a<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">≥</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">N</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">n_as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> jordan_nf_root_char_poly<span class="main">[</span><span class="operator">OF</span> jnf mem<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">from</span></span> jordan_nf_block_size_order_bound<span class="main">[</span><span class="operator">OF</span> jnf mem<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">≤</span> order <span class="main">1</span> <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">with</span></span> N nd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> order <span class="main">1</span> <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> 1<span class="main">[</span><span class="operator">OF</span> rt this<span class="main">,</span> <span class="operator">unfolded</span> dim_gen_eigenspace_max_jordan_block<span class="main"><span class="main">[</span></span><span class="operator">OF</span> jnf<span class="main"><span class="main">]</span></span><span class="main">]</span> mem N nd 
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> jnf_complexity_1_real<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real mat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> nonneg<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_mat <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> sr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> jb<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span>  
    order <span class="main">1</span> <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⟹</span> 
    dim_gen_eigenspace <span class="free">A</span> <span class="main">1</span> <span class="main">(</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> order <span class="main">1</span> <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span> <span class="bound">c2</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> elements_mat <span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">k</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">¦</span><span class="bound">a</span><span class="main">¦</span> <span class="main">≤</span> <span class="bound">c1</span> <span class="main">+</span> <span class="bound">c2</span> <span class="main">*</span> real <span class="bound">k</span> <span class="main">^</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"complex_of_real"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_mat <span class="var">?c</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> A'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> nn<span class="main">:</span> <span class="quoted"><span class="quoted">"real_nonneg_mat <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nonneg A <span class="keyword1"><span class="command">unfolding</span></span> nonneg_mat_def real_nonneg_mat_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> elements_mat<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> <span class="var">?c</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> cp <span class="main">=</span> of_real_hom.char_poly_hom<span class="main">[</span><span class="operator">OF</span> A<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> hom<span class="main">:</span> <span class="quoted"><span class="quoted">"map_poly_inj_idom_divide_hom complex_of_real"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> norm_bound_complex_to_real<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A jnf_complexity_1_complex<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A' nn<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">unfold</span> cp of_real_hom.poly_map_poly_1<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> 1
      of_real_hom.hom_dim_gen_eigenspace<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span>
      map_poly_inj_idom_divide_hom.order_hom<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hom<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 2 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> jb <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"char_poly <span class="free">A</span>"</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>map_poly <span class="var">?c</span> <span class="var">?cp</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
    <span class="keyword1"><span class="command">with</span></span> degree_monic_char_poly<span class="main">[</span><span class="operator">OF</span> A'<span class="main">,</span> <span class="operator">unfolded</span> cp<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> degree0_coeffs<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?cp</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> perron_frobenius_nonneg<span class="main">[</span><span class="operator">OF</span> A nonneg n0<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sr</span></span> <span class="skolem"><span class="skolem">ks</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> sr0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">sr</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ks<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> set <span class="skolem">ks</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ks</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> cp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?cp</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">←</span><span class="skolem">ks</span><span class="main">.</span> monom <span class="main">1</span> <span class="bound">k</span> <span class="main">-</span> <span class="main">[:</span><span class="skolem">sr</span> <span class="main">^</span> <span class="bound">k</span><span class="main">:]</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">f</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> rtf<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>map_poly <span class="var">?c</span> <span class="skolem">f</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> cmod <span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">sr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> sr_rt<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="var">?cp</span> <span class="skolem">sr</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> cp poly_prod_list_zero_iff poly_mult_zero_iff <span class="keyword1"><span class="command">using</span></span> ks
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ks</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> poly_monom<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> sr<span class="main">[</span><span class="operator">OF</span> sr_rt<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> sr1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sr</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">interpret</span></span> c<span class="main">:</span> map_poly_comm_ring_hom <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">from</span></span> rt<span class="main">[</span><span class="operator">unfolded</span> cp c.hom_mult c.hom_prod_list poly_mult_zero_iff poly_prod_list_zero_iff<span class="main">]</span>   
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 2
      <span class="keyword1"><span class="command">with</span></span> rtf sr1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword1"><span class="command">from</span></span> this ks <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">ks</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>map_poly <span class="var">?c</span> <span class="main">(</span>monom <span class="main">1</span> <span class="skolem">p</span> <span class="main">-</span> <span class="main">[:</span><span class="skolem">sr</span> <span class="main">^</span> <span class="skolem">p</span><span class="main">:]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> p ks<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">from</span></span> rt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">^</span><span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="var">?c</span> <span class="skolem">sr</span><span class="main">)</span><span class="main">^</span><span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> c.hom_minus 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_monom of_real_hom.map_poly_pCons_hom<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">x</span> <span class="main">=</span> cmod <span class="main">(</span><span class="var">?c</span> <span class="skolem">sr</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p power_eq_imp_eq_norm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> sr0 sr1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cmod <span class="skolem">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Check_Matrix_Growth">
<div class="head">
<h1>Theory Check_Matrix_Growth</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Thiemann *)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹An efficient algorithm to compute the growth rate of $A^n$.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Check_Matrix_Growth
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="Spectral_Radius_Theory_2.html">Spectral_Radius_Theory_2</a>
  <a href="../Sturm_Sequences/Sturm_Method.html">Sturm_Sequences.Sturm_Method</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Coset.order

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_matrix_complexity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real mat <span class="main">⇒</span> real poly <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check_matrix_complexity</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">cp</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="main">(</span>count_roots_above <span class="free"><span class="bound"><span class="entity">cp</span></span></span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span>
     <span class="main">∧</span> <span class="main">(</span>poly <span class="free"><span class="bound"><span class="entity">cp</span></span></span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">ord</span> <span class="main">=</span> order <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">cp</span></span></span> <span class="keyword1">in</span> 
        <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="bound">ord</span> <span class="main">⟶</span> kernel_dim <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">-</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="bound">ord</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> check_matrix_complexity<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nn<span class="main">:</span> <span class="quoted"><span class="quoted">"nonneg_mat <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> check<span class="main">:</span> <span class="quoted"><span class="quoted">"check_matrix_complexity <span class="free">A</span> <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="free">d</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c1</span> <span class="bound">c2</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> elements_mat <span class="main">(</span><span class="free">A</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">k</span><span class="main">)</span> <span class="main">⟶</span> abs <span class="bound">a</span> <span class="main">≤</span> <span class="main">(</span><span class="bound">c1</span> <span class="main">+</span> <span class="bound">c2</span> <span class="main">*</span> of_nat <span class="bound">k</span> <span class="main">^</span> <span class="free">d</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> jnf_complexity_1_real<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A nn<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_gen_eigenspace <span class="free">A</span> <span class="main">1</span> <span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> kernel_dim <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> dim_gen_eigenspace_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> kernel_dim <span class="main">(</span><span class="bound">x</span> <span class="keyword1">^<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> char_matrix_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> check <span class="main">=</span> check<span class="main">[</span><span class="operator">unfolded</span> check_matrix_complexity_def 
      Let_def count_roots_above_correct<span class="main">,</span> <span class="operator">folded</span> id<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> poly <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> poly_roots_finite<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> degree_monic_char_poly<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> check <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">∧</span> poly <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> card_eq_0_iff<span class="main">]</span> fin 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">∧</span> poly <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"poly <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span> <span class="main">1</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&lt;</span> order <span class="main">1</span> <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">with</span></span> check <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_gen_eigenspace <span class="free">A</span> <span class="main">1</span> <span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> order <span class="main">1</span> <span class="main">(</span>char_poly <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>