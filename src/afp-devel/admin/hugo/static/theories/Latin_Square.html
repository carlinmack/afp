<div id="Latin_Square">
<div class="head"><h1>Theory Latin_Square</h1>
<span class="command">theory</span> <span class="name">Latin_Square</span><br/>
<span class="keyword">imports</span> <a href="Marriage.html"><span class="name">Marriage</span></a><br/>
</div>
<div class="source">
<pre class="source"><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*  Title:       Latin Squares
    Author:      Alexander Bentkamp &lt;bentkamp at gmail.com&gt;, 2015
    Maintainer:  Alexander Bentkamp &lt;bentkamp at gmail.com&gt;
*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">theory</span></span><span> </span><span>Latin_Square</span><span>
</span><span class="keyword2"><span class="keyword">imports</span></span><span> </span><span>Marriage.Marriage</span><span>
</span><span class="keyword2"><span class="keyword">begin</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹
  This theory is about Latin Squares. A Latin Square is a $n \times n$ table filled with
  integers from 1 to n where each number appears exactly once in each row and each column.

  As described in "Das Buch der Beweise" a nice way to describe these squares by a $3 \times n$ matrix.
  Each column of this matrix contains the index of the row r, the index of the column c and the
  number in the cell (r,c). This $3 \times n$ matrix is called orthogonal array ("Zeilenmatrix").

  I thought about different ways to formalize this orthogonal array, and came up with this:
  As the order of the columns in the array does not matter at all and no column can be a
  duplicate of another column, the orthogonal array is in fact a set of 3-tuples. Another
  advantage of formalizing it as a set is that it can easily model partially filled squares.
  For these 3-tuples I decided against 3-lists and against $nat \times nat \times nat$
  (which is really $(nat \times nat) \times nat$) in favor of
  a function from a type with three elements to nat.

  Additionally I use the numbers $0$ to $n-1$ instead of $1$ to $n$ for indexing the rows and columns as
  well as for filling the cells.
›</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>latin_type</span><span> </span><span class="delimiter">=</span><span> </span><span>Row</span><span> </span><span class="delimiter">|</span><span> </span><span>Col</span><span> </span><span class="delimiter">|</span><span> </span><span>Num</span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span class="cartouche"><span class="delete"><span class="delete">‹latin\_type is of sort enum, needed for "value" command›</span></span></span><span>
</span><span class="keyword1"><span class="command">instantiation</span></span><span> </span><span>latin_type</span><span> </span><span class="delimiter">::</span><span> </span><span>enum</span><span>
</span><span class="keyword2"><span class="keyword">begin</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">definition</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"enum_latin_type == [Row, Col, Num]"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">definition</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"enum_all_latin_type (P:: latin_type ⇒ bool) = (P Row ∧ P Col ∧ P Num)"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">definition</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"enum_ex_latin_type (P:: latin_type ⇒ bool) = (∃x. P x)"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">instance</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>standard</span><span>
</span><span>     </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>auto</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>enum_latin_type_def</span><span> </span><span>enum_all_latin_type_def</span><span> </span><span>enum_ex_latin_type_def</span><span class="delimiter">)</span><span>
</span><span>   </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>case_tac</span><span> </span><span>x</span><span class="delimiter">,</span><span>auto</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>latin_type.exhaust</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword2"><span class="keyword">end</span></span><span>
</span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span class="cartouche"><span class="delete"><span class="delete">‹Given a latin\_type t, you might want to reference the other two.
   These are "next t" and "next (next t)":›</span></span></span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span class="delimiter">[</span><span>simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">"next t ≡ (case t of Row ⇒ Col | Col ⇒ Num | Num ⇒ Row)"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>all_types_next_eqiv</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">"(∀t. P (next t)) ⟷ (∀t. P t)"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>iffI</span><span class="delimiter">)</span><span>
</span><span>   </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>next_def</span><span> </span><span>latin_type.case</span><span> </span><span>latin_type.exhaust</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span>  </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹We call a column of the orthogonal array a latin\_entry:›</span></span></span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span>latin_entry</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">"latin_type ⇒ nat"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹This function removes one element of the 3-tupel and returns the other two as a pair:›</span></span></span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>without</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"latin_type ⇒ latin_entry ⇒ nat × nat"</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span class="delimiter">[</span><span>simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">"without t ≡ λe. (e (next t), e (next (next t)))"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">value</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"without Row (λt. case t of Row ⇒ 0 | Col ⇒ 1 | Num ⇒ 2)"</span></span></span><span> </span><span class="comment">― ‹returns (1,2)›</span><span>
</span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"row_col ≡ without Num"</span></span></span><span> </span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹returns row and column of a latin\_entry as a pair.›</span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"col_num ≡ without Row"</span></span></span><span> </span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹returns column and number of a latin\_entry as a pair.›</span></span></span><span>
</span><span class="keyword1"><span class="command">abbreviation</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"num_row ≡ without Col"</span></span></span><span> </span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹returns number and row of a latin\_entry as a pair.›</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span class="cartouche"><span class="delete"><span class="delete">‹A partial latin square is a square that contains each number at most once in each row and each
   column, but not all cells have to be filled. Equivalently we can say that any two rows of the
   orthogonal array contain each pair of two numbers at most once. This can be expressed using the
   inj\_on predicate:›</span></span></span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>partial_latin_square</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"latin_entry set ⇒ nat ⇒ bool"</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span class="string"><span class="delete"><span class="delete">"partial_latin_square s n ≡
  (∀t. inj_on (without t) s) ∧ ― ‹numbers are unique in each column (t=Row), numbers are unique in each row (t=Col), rows-column combinations are specified unambiguously (t=Num)›
  (∀e∈s. ∀t. e t &lt; n) ― ‹all numbers, column indices and row indices are &lt;n›"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">value</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"partial_latin_square {
  (λt. case t of Row ⇒ 0 | Col ⇒ 1 | Num ⇒ 0),
  (λt. case t of Row ⇒ 1 | Col ⇒ 0 | Num ⇒ 1)
} 2"</span></span></span><span> </span><span class="comment">― ‹True›</span><span>
</span><span>
</span><span class="keyword1"><span class="command">value</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"partial_latin_square {
  (λt. case t of Row ⇒ 0 | Col ⇒ 0 | Num ⇒ 1),
  (λt. case t of Row ⇒ 1 | Col ⇒ 0 | Num ⇒ 1)
} 2"</span></span></span><span> </span><span class="comment">― ‹False, because 1 appears twice in column 0›</span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹Looking at the orthogonal array a latin square is given iff any two rows of the
   orthogonal array contain each pair of two numbers at exactly once:›</span></span></span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>latin_square</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"latin_entry set ⇒ nat ⇒ bool"</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span class="string"><span class="delete"><span class="delete">"latin_square s n ≡
  (∀t. bij_betw (without t) s ({0..&lt;n}×{0..&lt;n}))"</span></span></span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* numbers exactly once in each column (t=Row), numbers exactly once in each row (t=Col), rows-column combinations are specified exactly once (t=Num) *)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">value</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"latin_square {
  (λt. case t of Row ⇒ 0 | Col ⇒ 0 | Num ⇒ 1),  (λt. case t of Row ⇒ 0 | Col ⇒ 1 | Num ⇒ 0),
  (λt. case t of Row ⇒ 1 | Col ⇒ 0 | Num ⇒ 0),  (λt. case t of Row ⇒ 1 | Col ⇒ 1 | Num ⇒ 1)
} 2"</span></span></span><span> </span><span class="comment">― ‹True›</span><span>
</span><span>
</span><span class="keyword1"><span class="command">value</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"latin_square {
  (λt. case t of Row ⇒ 0 | Col ⇒ 0 | Num ⇒ 1),  (λt. case t of Row ⇒ 0 | Col ⇒ 1 | Num ⇒ 0),
  (λt. case t of Row ⇒ 1 | Col ⇒ 0 | Num ⇒ 0),  (λt. case t of Row ⇒ 1 | Col ⇒ 1 | Num ⇒ 0)
} 2"</span></span></span><span> </span><span class="comment">― ‹False, because 0 appears twice in Col 1 and twice in Row 1›</span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹A latin rectangle is a partial latin square in which the first m rows are filled and the following
   rows are empty:›</span></span></span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>latin_rect</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"latin_entry set ⇒ nat ⇒ nat ⇒ bool"</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span class="string"><span class="delete"><span class="delete">"latin_rect s m n ≡
  m ≤ n ∧
  partial_latin_square s n ∧
  bij_betw row_col s ({0..&lt;m}×{0..&lt;n}) ∧
  bij_betw num_row s ({0..&lt;n}×{0..&lt;m})"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">value</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"latin_rect {
  (λt. case t of Row ⇒ 0 | Col ⇒ 0 | Num ⇒ 1),  (λt. case t of Row ⇒ 0 | Col ⇒ 1 | Num ⇒ 0)
} 1 2"</span></span></span><span> </span><span class="comment">― ‹True›</span><span>
</span><span>
</span><span class="keyword1"><span class="command">value</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"latin_rect {
  (λt. case t of Row ⇒ 0 | Col ⇒ 0 | Num ⇒ 1),  (λt. case t of Row ⇒ 0 | Col ⇒ 1 | Num ⇒ 0),
  (λt. case t of Row ⇒ 1 | Col ⇒ 0 | Num ⇒ 0),  (λt. case t of Row ⇒ 1 | Col ⇒ 1 | Num ⇒ 1)
} 1 2"</span></span></span><span> </span><span class="comment">― ‹False›</span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹There is another equivalent description of latin rectangles, which is easier to prove:›</span></span></span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>latin_rect_iff</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">"m≤n ∧ partial_latin_square s n ∧ card s = n*m ∧ (∀e∈s. e Row &lt; m) ⟷ latin_rect s m n"</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>iffI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>prems</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">"m≤n ∧ partial_latin_square s n ∧ card s = n * m ∧ (∀e∈s. e Row &lt; m)"</span></span></span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>bij1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">"bij_betw row_col s ({0..&lt;m}×{0..&lt;n})"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>prems</span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"inj_on row_col s"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>prems</span><span> </span><span>partial_latin_square_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"{0..&lt;m} × {0..&lt;n} = row_col ` s"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"row_col ` s ⊆ {0..&lt;m} × {0..&lt;n}"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>prems</span><span> </span><span>partial_latin_square_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card (row_col ` s) = card ({0..&lt;m} × {0..&lt;n})"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>prems</span><span> </span><span>card_image</span><span class="delimiter">[</span><span>OF</span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹inj_on row_col s›</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"{0..&lt;m} × {0..&lt;n} = row_col ` s"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>card_subset_eq</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">"{0..&lt;m} × {0..&lt;n}"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"row_col ` s"</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>bij_betw_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>bij2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">"bij_betw num_row s ({0..&lt;n}×{0..&lt;m})"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>prems</span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"inj_on num_row s"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>prems</span><span> </span><span>partial_latin_square_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"{0..&lt;n} × {0..&lt;m} = num_row ` s"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span>-</span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"num_row ` s ⊆ {0..&lt;n} × {0..&lt;m}"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>prems</span><span> </span><span>partial_latin_square_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card (num_row ` s) = card ({0..&lt;n} × {0..&lt;m})"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>prems</span><span> </span><span>card_image</span><span class="delimiter">[</span><span>OF</span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹inj_on num_row s›</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"{0..&lt;n} × {0..&lt;m} = num_row ` s"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>card_subset_eq</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">"{0..&lt;n} × {0..&lt;m}"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"num_row ` s"</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>bij_betw_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>prems</span><span> </span><span>bij1</span><span> </span><span>bij2</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"latin_rect s m n"</span></span></span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>latin_rect_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">next</span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>prems</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">"latin_rect s m n"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"m≤n"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"partial_latin_square s n"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>latin_rect_def</span><span> </span><span>prems</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card s = m * n"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"bij_betw row_col s ({0..&lt;m} × {0..&lt;n})"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>latin_rect_def</span><span> </span><span>prems</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>bij_betw_same_card</span><span class="delimiter">[</span><span>of</span><span> </span><span>row_col</span><span> </span><span>s</span><span> </span><span class="string"><span class="delete"><span class="delete">"{0..&lt;m} × {0..&lt;n}"</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"∀e∈s. e Row &lt; m"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>latin_rect_def</span><span> </span><span>prems</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>atLeast0LessThan</span><span> </span><span>bij_betwE</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"m≤n ∧ partial_latin_square s n ∧ card s = n * m ∧ (∀e∈s. e Row &lt; m)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹A square is a latin square iff it is a partial latin square with all $n^2$ cells filled:›</span></span></span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>partial_latin_square_full</span><span class="delimiter">:</span><span>
</span><span class="string"><span class="delete"><span class="delete">"partial_latin_square s n ∧ card s = n*n ⟷ latin_square s n"</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>iffI</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>prem</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"partial_latin_square s n ∧ card s = n * n"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"∀t. (without t) ` s ⊆ {0..&lt;n} × {0..&lt;n}"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>t</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"(without t) ` s ⊆ {0..&lt;n} × {0..&lt;n}"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>partial_latin_square_def</span><span> </span><span>next_def</span><span> </span><span>atLeast0LessThan</span><span> </span><span>prem</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span>t</span><span class="delimiter">)</span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"partial_latin_square s n ∧ card s = n * n ⟹ latin_square s n"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>latin_square_def</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>partial_latin_square_def</span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>bij_betw_def</span><span> </span><span>card_atLeastLessThan</span><span> </span><span>card_cartesian_product</span><span> </span><span>card_image</span><span> </span><span>card_subset_eq</span><span> </span><span>diff_zero</span><span> </span><span>finite_SigmaI</span><span> </span><span>finite_atLeastLessThan</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">next</span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>prem</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">"latin_square s n"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"bij_betw row_col s ({0..&lt;n} × {0..&lt;n})"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>latin_square_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"partial_latin_square s n"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"∀t. ∀e∈s. (without t) e ∈ ({0..&lt;n}×{0..&lt;n})"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>prem</span><span> </span><span>latin_square_def</span><span> </span><span>bij_betwE</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>metis</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">"∀e∈s.∀t. e t &lt; n"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>latin_square_def</span><span> </span><span>all_types_next_eqiv</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">"λt. ∀e∈s. e t &lt; n"</span></span></span><span class="delimiter">]</span><span> </span><span>bij_betwE</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">"(∀t. inj_on (without t) s)"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>prem</span><span> </span><span>bij_betw_def</span><span> </span><span>latin_square_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>1</span><span> </span><span>2</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>partial_latin_square_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"partial_latin_square s n ∧ card s = n*n"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>auto</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>  </span><span>bij_betw_same_card</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹Now we prove Lemma 1 from chapter 27 in "Das Buch der Beweise". But first some lemmas, that prove
   very intuitive facts:›</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>bij_restrict</span><span class="delimiter">:</span><span>
</span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"bij_betw f A B"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"∀a∈A. P a ⟷ Q (f a)"</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"bij_betw f {a∈A. P a} {b∈B. Q b}"</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>inj</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"inj_on f {a∈A. P a}"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>assms</span><span> </span><span>bij_betw_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>mono_tags</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>inj_onD</span><span> </span><span>inj_onI</span><span> </span><span>mem_Collect_eq</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>surj1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"f ` {a∈A. P a} ⊆ {b∈B. Q b}"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>assms</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>assms</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span>bij_betwE</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>surj2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"{b∈B. Q b} ⊆ f ` {a∈A. P a}"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>b</span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"b ∈ {b ∈ B. Q b}"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">obtain</span></span><span> </span><span>a</span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"f a = b"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"a∈A"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>assms</span><span class="delimiter">(</span><span>1</span><span class="delimiter">)</span><span> </span><span>bij_betw_inv_into_right</span><span> </span><span>bij_betwE</span><span> </span><span>bij_betw_inv_into</span><span> </span><span>mem_Collect_eq</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"b ∈ f ` {a∈A. P a}"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹b ∈ {b ∈ B. Q b}›</span></span></span><span> </span><span>assms</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">with</span></span><span> </span><span>inj</span><span> </span><span>surj1</span><span> </span><span>surj2</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>bij_betw_imageI</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>cartesian_product_margin1</span><span class="delimiter">:</span><span>
</span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"a∈A"</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"{p∈A×B. fst p = a} = {a}×B"</span></span></span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>SigmaI</span><span> </span><span>assms</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>cartesian_product_margin2</span><span class="delimiter">:</span><span>
</span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"b∈B"</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"{p∈A×B. snd p = b} = A×{b}"</span></span></span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>SigmaI</span><span> </span><span>assms</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹The union of sets containing at most k elements each cannot contain more elements than
   the number of sets times k:›</span></span></span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>limited_family_union</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"finite B ⟹ ∀P∈B. card P ≤ k ⟹ card (⋃B) ≤ card B * k"</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>induction</span><span> </span><span>B</span><span> </span><span>rule</span><span class="delimiter">:</span><span>finite_induct</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>empty</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?case</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">next</span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">case</span></span><span> </span><span class="delimiter">(</span><span>insert</span><span> </span><span>P</span><span> </span><span>B</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card (⋃(insert P B)) ≤ card P + card (⋃B)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>card_Un_le</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card (⋃(insert P B)) ≤ card P + card B * k"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>insert</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?case</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>insert</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹If f hits each element at most k times, the domain of f can only be k times bigger than the
   image of f:›</span></span></span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>limited_preimages</span><span class="delimiter">:</span><span>
</span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"∀x ∈ f ` D. card ((f -` {x})∩D) ≤ k"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"finite D"</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card D ≤ card (f ` D) * k "</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?preimages</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">"(λx. (f -` {x})∩D) ` (f ` D)"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"D = ⋃?preimages"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card (⋃?preimages) ≤ card ?preimages * k"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>limited_family_union</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">"?preimages"</span></span></span><span> </span><span>k</span><span class="delimiter">]</span><span> </span><span>assms</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card (?preimages) * k ≤ card (f ` D) * k"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>card_image_le</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">"f ` D"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"λx. (f -` {x})∩D"</span></span></span><span class="delimiter">]</span><span> </span><span>assms</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card (⋃?preimages) ≤ card (f ` D) * k"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>le_trans</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹D = ⋃?preimages›</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>metis</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹Let $A_1, \dots, A_n$ be sets with $k&gt;0$ elements each. Any element is only contained in at most $k$ of
   these sets. Then there are more different elements in total than sets $A_i$:›</span></span></span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>union_limited_replicates</span><span class="delimiter">:</span><span>
</span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"finite I"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"∀i∈I. finite (A i)"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"k&gt;0"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"∀i∈I. card (A i) = k"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"∀i∈I. ∀x∈(A i). card {i∈I. x∈A i} ≤ k"</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card (⋃i∈I. (A i)) ≥ card I"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>assms</span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?pairs</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">"{(i,x). i∈I ∧ x∈A i}"</span></span></span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>card_pairs</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"card ?pairs = card I * k"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>assms</span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>induction</span><span> </span><span>I</span><span> </span><span>rule</span><span class="delimiter">:</span><span>finite_induct</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>empty</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?case</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>card_eq_0_iff</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">next</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">case</span></span><span> </span><span class="delimiter">(</span><span>insert</span><span> </span><span>i0</span><span> </span><span>I</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"∀i∈I. ∀x∈(A i). card {i∈I. x∈A i} ≤ k"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>ballI</span><span class="delimiter">)</span><span class="delimiter">+</span><span>
</span><span>      </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>i</span><span> </span><span>x</span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"i ∈ I"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"x∈A i"</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card {i ∈ insert i0 I. x ∈ A i} ≤ k"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>insert</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"finite {i ∈ insert i0 I. x ∈ A i}"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>insert</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card  {i∈I. x∈A i} ≤ k"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>card_mono</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">"{i ∈ insert i0 I. x ∈ A i}"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"{i ∈ I. x ∈ A i}"</span></span></span><span class="delimiter">]</span><span> </span><span>le_trans</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>    </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>card_S</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"card {(i, x). i ∈ I ∧ x ∈ A i} = card I * k"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>insert</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>card_B</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"card {(i, x). i=i0 ∧ x∈A i0} = k"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>insert</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"{(i, x). i ∈ insert i0 I ∧ x ∈ A i} = {(i, x). i ∈ I ∧ x ∈ A i} ∪ {(i, x). i=i0 ∧ x∈A i0}"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"{(i, x). i ∈ I ∧ x ∈ A i} ∩ {(i, x). i=i0 ∧ x∈A i0} = {}"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>insert</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"finite {(i, x). i ∈ I ∧ x ∈ A i}"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>insert</span><span> </span><span>rev_finite_subset</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">"I × ⋃(A ` I)"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"{(i, x). i ∈ I ∧ x ∈ A i}"</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"finite {(i, x). i=i0 ∧ x∈A i0}"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>insert</span><span> </span><span>card_B</span><span> </span><span>card_infinite</span><span> </span><span>neq0_conv</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>    </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card {(i, x). i ∈ insert i0 I ∧ x ∈ A i} = card {(i, x). i ∈ I ∧ x ∈ A i} + card {(i, x). i=i0 ∧ x∈A i0}"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>card_Un_disjoint</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">with</span></span><span> </span><span>card_S</span><span> </span><span>card_B</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card {(i, x). i ∈ insert i0 I ∧ x ∈ A i} = (card I + 1) * k"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?case</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>insert</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span>  </span><span class="keyword3"><span class="command">define</span></span><span> </span><span>f</span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"f ix = (case ix of (i,x) ⇒ x)"</span></span></span><span> </span><span class="keyword2"><span class="keyword">for</span></span><span> </span><span>ix</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a × 'b"</span></span></span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>preimages_le_k</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"∀x ∈ f ` ?pairs. card ((f -` {x}) ∩ ?pairs) ≤ k"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>x0</span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>x0_def</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"x0 ∈ f ` ?pairs"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"(f -` {x0}) ∩ ?pairs = {(i,x). i∈I ∧ x∈A i ∧ x=x0}"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>f_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card {(i,x). i∈I ∧ x∈A i ∧ x=x0} = card {i∈I. x0∈A i}"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹finite I›</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"inj_on (λi. (i,x0)) {i∈I. x0∈A i}"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>meson</span><span> </span><span>Pair_inject</span><span> </span><span>inj_onI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"(λi. (i,x0)) ` {i∈I. x0∈A i} = {(i,x). i∈I ∧ x∈A i ∧ x=x0}"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>subset_antisym</span><span class="delimiter">)</span><span> </span><span>blast</span><span class="delimiter">+</span><span>
</span><span>      </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>card_image</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>    </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">"card ((f -` {x0}) ∩ ?pairs) = card  {i∈I. x0∈A i}"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span class="string"><span class="delete"><span class="delete">"∃i0. x0∈A i0 ∧ i0∈I"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>x0_def</span><span> </span><span>f_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card {i∈I. x0∈A i} ≤ k"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>assms</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">with</span></span><span> </span><span>1</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card ((f -` {x0}) ∩ ?pairs) ≤ k"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card ?pairs ≤ card (f ` ?pairs) * k"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"finite {(i, x). i ∈ I ∧ x ∈ A i}"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>assms</span><span> </span><span>card_pairs</span><span> </span><span>not_finite_existsD</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>limited_preimages</span><span class="delimiter">[</span><span>of</span><span> </span><span>f</span><span> </span><span class="var">?pairs</span><span> </span><span>k</span><span class="delimiter">,</span><span> </span><span>OF</span><span> </span><span>preimages_le_k</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card I  ≤ card (f ` ?pairs) "</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>card_pairs</span><span> </span><span>assms</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"f ` ?pairs = (⋃i∈I. (A i))"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>f_def</span><span> </span><span class="delimiter">[</span><span>abs_def</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>f_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹In a $m \times n$ latin rectangle each number appears in m columns:›</span></span></span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>latin_rect_card_col</span><span class="delimiter">:</span><span>
</span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"latin_rect s m n"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"x&lt;n"</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card {e Col|e. e∈s ∧ e Num = x} = m"</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card {e ∈ s. e Num = x} = m"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">"bij_betw num_row s ({0..&lt;n}×{0..&lt;m})"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>assms</span><span> </span><span>latin_rect_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">"∀e∈s. e Num = x ⟷ fst (num_row e) = x"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"bij_betw num_row {e∈s. e Num = x} ({x}×{0..&lt;m})"</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>bij_restrict</span><span class="delimiter">[</span><span>OF</span><span> </span><span>1</span><span> </span><span>2</span><span class="delimiter">]</span><span> </span><span>cartesian_product_margin1</span><span class="delimiter">[</span><span>of</span><span> </span><span>x</span><span> </span><span class="string"><span class="delete"><span class="delete">"{0..&lt;n}"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">" {0..&lt;m}"</span></span></span><span class="delimiter">]</span><span> </span><span>assms</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>card_cartesian_product</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>bij_betw_same_card</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card {e∈s. e Num = x} = card {e Col |e. e ∈ s ∧ e Num = x}"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"inj_on col_num s"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>assms</span><span> </span><span>latin_rect_def</span><span class="delimiter">[</span><span>of</span><span> </span><span>s</span><span> </span><span>m</span><span> </span><span>n</span><span class="delimiter">]</span><span> </span><span>partial_latin_square_def</span><span class="delimiter">[</span><span>of</span><span> </span><span>s</span><span> </span><span>n</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"inj_on col_num {e∈s. e Num = x}"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>mono_tags</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>inj_onD</span><span> </span><span>inj_onI</span><span> </span><span>mem_Collect_eq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"inj_on (λe. e Col) {e∈s. e Num = x}"</span></span></span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inj_on_def</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>without_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"(λe. e Col) ` {e∈s. e Num = x} = {e Col |e. e ∈ s ∧ e Num = x}"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>subset_antisym</span><span class="delimiter">)</span><span> </span><span>blast</span><span class="delimiter">+</span><span>
</span><span>    </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>card_image</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹In a $m \times n$ latin rectangle each column contains m numbers:›</span></span></span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>latin_rect_card_num</span><span class="delimiter">:</span><span>
</span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"latin_rect s m n"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"x&lt;n"</span></span></span><span>
</span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card {e Num|e. e∈s ∧ e Col = x} = m"</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card {e ∈ s. e Col = x} = m"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>1</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">"bij_betw row_col s ({0..&lt;m}×{0..&lt;n})"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>assms</span><span> </span><span>latin_rect_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>2</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">"∀e∈s. e Col = x ⟷ snd (row_col e) = x"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"bij_betw row_col {e∈s. e Col = x} ({0..&lt;m}×{x})"</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>bij_restrict</span><span class="delimiter">[</span><span>OF</span><span> </span><span>1</span><span> </span><span>2</span><span class="delimiter">]</span><span> </span><span>cartesian_product_margin2</span><span class="delimiter">[</span><span>of</span><span> </span><span>x</span><span> </span><span class="string"><span class="delete"><span class="delete">"{0..&lt;n}"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">" {0..&lt;m}"</span></span></span><span class="delimiter">]</span><span> </span><span>assms</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>card_cartesian_product</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>bij_betw_same_card</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card {e∈s. e Col = x} = card {e Num |e. e ∈ s ∧ e Col = x}"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"inj_on col_num s"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>assms</span><span> </span><span>latin_rect_def</span><span class="delimiter">[</span><span>of</span><span> </span><span>s</span><span> </span><span>m</span><span> </span><span>n</span><span class="delimiter">]</span><span> </span><span>partial_latin_square_def</span><span class="delimiter">[</span><span>of</span><span> </span><span>s</span><span> </span><span>n</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"inj_on col_num {e∈s. e Col = x}"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>mono_tags</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>inj_onD</span><span> </span><span>inj_onI</span><span> </span><span>mem_Collect_eq</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"inj_on (λe. e Num) {e∈s. e Col = x}"</span></span></span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inj_on_def</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>without_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"(λe. e Num) ` {e∈s. e Col = x} = {e Num |e. e ∈ s ∧ e Col = x}"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>subset_antisym</span><span class="delimiter">)</span><span> </span><span>blast</span><span class="delimiter">+</span><span>
</span><span>    </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>card_image</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹Finally we prove lemma 1 chapter 27 of "Das Buch der Beweise":›</span></span></span><span>
</span><span class="keyword1"><span class="command">theorem</span></span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"latin_rect s (n-m) n"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"m≤n"</span></span></span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"∃s'. s⊆s' ∧ latin_square s' n"</span></span></span><span>
</span><span class="keyword1"><span class="command">using</span></span><span> </span><span>assms</span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>induction</span><span> </span><span>m</span><span> </span><span>arbitrary</span><span class="delimiter">:</span><span>s</span><span class="delimiter">)</span><span> </span><span class="comment">― ‹induction over the number of empty rows›</span><span>
</span><span>  </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>0</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"bij_betw row_col s ({0..&lt;n} × {0..&lt;n})"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>latin_rect_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card s = n*n"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>bij_betw_same_card</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?case</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>partial_latin_square_full</span><span> </span><span>0</span><span> </span><span>latin_rect_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">next</span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">case</span></span><span> </span><span class="delimiter">(</span><span>Suc</span><span> </span><span>m</span><span class="delimiter">)</span><span>
</span><span>
</span><span>  </span><span class="comment">― ‹We use the Hall theorem on the sets $A_j$ of numbers that do not occur in column $j$:›</span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?not_in_column</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">"λj. {0..&lt;n} - {e Num |e. e∈s ∧ e Col = j}"</span></span></span><span>
</span><span>
</span><span>  </span><span class="comment">― ‹Proof of the hall condition:›</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"∀J⊆{0..&lt;n}. card J ≤ card (⋃j∈J. ?not_in_column j)"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>allI</span><span class="delimiter">;</span><span> </span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>J</span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>J_def</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">"J⊆{0..&lt;n}"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"∀j∈J. card (?not_in_column j) = Suc m"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span>
</span><span>      </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>j</span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>j_def</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">"j∈J"</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"{e Num |e. e∈s ∧ e Col = j} ⊆ {0..&lt;n}"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>atLeastLessThan_iff</span><span> </span><span>Suc</span><span> </span><span>latin_rect_def</span><span> </span><span>partial_latin_square_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"finite {e Num |e. e∈s ∧ e Col = j}"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>finite_subset</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card (?not_in_column j) = card {0..&lt;n} - card {e Num |e. e ∈ s ∧ e Col = j}"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>card_Diff_subset</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">"{e Num |e. e∈s ∧ e Col = j}"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"{0..&lt;n}"</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card(?not_in_column j) = Suc m"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>latin_rect_card_num</span><span> </span><span>J_def</span><span> </span><span>j_def</span><span> </span><span>Suc</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"∀j0∈J. ∀x∈?not_in_column j0. card {j ∈ J. x ∈ ?not_in_column j} ≤ Suc m"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>ballI</span><span class="delimiter">;</span><span> </span><span>rule</span><span> </span><span>ballI</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>j0</span><span> </span><span>x</span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"j0 ∈ J"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"x ∈ ?not_in_column j0"</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card ({0..&lt;n} - {e Col|e. e∈s ∧ e Num = x}) = Suc m"</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card {e Col|e. e∈s ∧ e Num = x} = n - Suc m"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>latin_rect_card_col</span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹x ∈ ?not_in_column j0›</span></span></span><span> </span><span>Suc</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"{e Col|e. e∈s ∧ e Num = x}⊆{0..&lt;n}"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Suc</span><span> </span><span>latin_rect_def</span><span> </span><span>partial_latin_square_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"finite {e Col|e. e∈s ∧ e Num = x}"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>finite_subset</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>card_Diff_subset</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">"{e Col|e. e∈s ∧ e Num = x}"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"{0..&lt;n}"</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Suc.prems</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"{j ∈ J. x ∈ ?not_in_column j} ⊆ {0..&lt;n} - {e Col|e. e∈s ∧ e Num = x}"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Diff_mono</span><span> </span><span>J_def</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹x ∈ ?not_in_column j0›</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>      </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card {j ∈ J. x ∈ ?not_in_column j} ≤ Suc m"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>no_types</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>card_mono</span><span> </span><span>finite_Diff</span><span> </span><span>finite_atLeastLessThan</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"finite J"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>J_def</span><span> </span><span>finite_subset</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card J ≤ card (⋃j∈J. ?not_in_column j)"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>union_limited_replicates</span><span class="delimiter">[</span><span>of</span><span> </span><span>J</span><span> </span><span class="var">?not_in_column</span><span> </span><span class="string"><span class="delete"><span class="delete">"Suc m"</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span>  </span><span class="comment">― ‹The Hall theorem gives us a system of distinct representatives, which we can use to fill the next row:›</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">obtain</span></span><span> </span><span>R</span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span>R_def</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">"∀j∈{0..&lt;n}. R j ∈ ?not_in_column j ∧ inj_on R {0..&lt;n}"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>marriage_HV</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">"{0..&lt;n}"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"?not_in_column"</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>
</span><span>  </span><span class="keyword3"><span class="command">define</span></span><span> </span><span>new_row</span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"new_row = (λj. rec_latin_type (n - Suc m) j (R j)) ` {0..&lt;n}"</span></span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">define</span></span><span> </span><span>s'</span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"s' = s ∪ new_row"</span></span></span><span>
</span><span>
</span><span>  </span><span class="comment">― ‹s' is now a latin rect with one more row:›</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"latin_rect s' (n-m) n"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>    </span><span class="comment">― ‹We prove all four criteria specified in the lemma latinrectiff:›</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"n-m ≤ n"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"partial_latin_square s' n"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"inj_on (without Col) s'"</span></span></span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inj_on_def</span><span>
</span><span>      </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>ballI</span><span class="delimiter">;</span><span> </span><span>rule</span><span> </span><span>ballI</span><span class="delimiter">;</span><span> </span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>e1</span><span> </span><span>e2</span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 ∈ s'"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e2 ∈ s'"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"num_row e1 = num_row e2"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 Num = e2 Num"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 Row = e2 Row"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>without_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 Col = e2 Col"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>cases</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 Row = n - Suc m"</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e2 Row = n - Suc m"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>without_def</span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹num_row e1 = num_row e2›</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"∀e∈s. e Row &lt; n - Suc m"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Suc</span><span> </span><span>latin_rect_iff</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 ∈ new_row"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e2 ∈ new_row"</span></span></span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>s'_def</span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e1 ∈ s'›</span></span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e2 ∈ s'›</span></span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e1 Row = n - Suc m›</span></span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e2 Row = n - Suc m›</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 Num = R (e1 Col)"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e2 Num = R (e2 Col)"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>new_row_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"R (e1 Col) = R (e2 Col)"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e1 Num = e2 Num›</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 Col &lt; n"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e2 Col &lt; n"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e1 ∈ new_row›</span></span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e2 ∈ new_row›</span></span></span><span> </span><span>new_row_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 Col = e2 Col"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>R_def</span><span> </span><span>inj_on_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="delimiter">(</span><span>mono_tags</span><span class="delimiter">,</span><span> </span><span>lifting</span><span class="delimiter">)</span><span> </span><span>atLeast0LessThan</span><span> </span><span>lessThan_iff</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">next</span></span><span>
</span><span>          </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 Row ≠ n - Suc m"</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1∈s"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e2∈s"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>new_row_def</span><span> </span><span>s'_def</span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e1∈s'›</span></span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e2∈s'›</span></span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e1 Row = e2 Row›</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 Col = e2 Col"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Suc</span><span> </span><span>latin_rect_def</span><span> </span><span>bij_betw_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹num_row e1 = num_row e2›</span></span></span><span> </span><span>inj_onD</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1=e2"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>latin_type.induct</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">"λt. e1 t = e2 t"</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"inj_on (without Row) s'"</span></span></span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inj_on_def</span><span>
</span><span>      </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>ballI</span><span class="delimiter">;</span><span> </span><span>rule</span><span> </span><span>ballI</span><span class="delimiter">;</span><span> </span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>e1</span><span> </span><span>e2</span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 ∈ s'"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e2 ∈ s'"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"col_num e1 = col_num e2"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 Col = e2 Col"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 Num = e2 Num"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>without_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 Row = e2 Row"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>cases</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 Row = n - Suc m"</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"∀e∈s. e Row &lt; n - Suc m"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Suc</span><span> </span><span>latin_rect_iff</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e2 Num ∈ ?not_in_column (e2 Col)"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>R_def</span><span> </span><span>new_row_def</span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e1 Col = e2 Col›</span></span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e1 Num = e2 Num›</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>s'_def</span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e1 ∈ s'›</span></span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e1 Row = n - Suc m›</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 Row = e2 Row"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>new_row_def</span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e1 Row = n - Suc m›</span></span></span><span>  </span><span>s'_def</span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e2 ∈ s'›</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">next</span></span><span>
</span><span>          </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 Row ≠ n - Suc m"</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1∈s"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>new_row_def</span><span> </span><span>s'_def</span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e1∈s'›</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e2 Num ∉ ?not_in_column (e2 Col)"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e1 Col = e2 Col›</span></span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e1 Num = e2 Num›</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e2∈s"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>new_row_def</span><span> </span><span>s'_def</span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e2∈s'›</span></span></span><span> </span><span>R_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"inj_on col_num s"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Suc.prems</span><span> </span><span>latin_rect_def</span><span class="delimiter">[</span><span>of</span><span> </span><span>s</span><span> </span><span class="string"><span class="delete"><span class="delete">"(n - Suc m)"</span></span></span><span> </span><span>n</span><span class="delimiter">]</span><span> </span><span>partial_latin_square_def</span><span class="delimiter">[</span><span>of</span><span> </span><span>s</span><span> </span><span>n</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>          </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 Row = e2 Row"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Suc</span><span> </span><span>latin_rect_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹col_num e1 = col_num e2›</span></span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e1 ∈ s›</span></span></span><span> </span><span>inj_onD</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1=e2"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>latin_type.induct</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">"λt. e1 t = e2 t"</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"inj_on (without Num) s'"</span></span></span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inj_on_def</span><span>
</span><span>      </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>ballI</span><span class="delimiter">;</span><span> </span><span>rule</span><span> </span><span>ballI</span><span class="delimiter">;</span><span> </span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>e1</span><span> </span><span>e2</span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 ∈ s'"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e2 ∈ s'"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"row_col e1 = row_col e2"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 Row = e2 Row"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 Col = e2 Col"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>without_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 Num = e2 Num"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>cases</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 Row = n - Suc m"</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e2 Row = n - Suc m"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>without_def</span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹row_col e1 = row_col e2›</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"∀e∈s. e Row &lt; n - Suc m"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Suc</span><span> </span><span>latin_rect_iff</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 Num = e2 Num"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e1 Col = e2 Col›</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>new_row_def</span><span> </span><span>s'_def</span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e1 ∈ s'›</span></span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e2 ∈ s'›</span></span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e1 Row = n - Suc m›</span></span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e2 Row = n - Suc m›</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">next</span></span><span>
</span><span>          </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 Row ≠ n - Suc m"</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1∈s"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e2∈s"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>new_row_def</span><span> </span><span>s'_def</span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e1∈s'›</span></span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e2∈s'›</span></span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e1 Row = e2 Row›</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1 Num = e2 Num"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Suc</span><span> </span><span>latin_rect_def</span><span> </span><span>bij_betw_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹row_col e1 = row_col e2›</span></span></span><span> </span><span>inj_onD</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e1=e2"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>latin_type.induct</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">"λt. e1 t = e2 t"</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"∀e∈s'. ∀t. e t &lt; n"</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>ballI</span><span class="delimiter">;</span><span> </span><span>rule</span><span> </span><span>allI</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>e</span><span> </span><span>t</span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e∈s'"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e t &lt; n"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>cases</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e∈new_row"</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>new_row_def</span><span> </span><span>R_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>induction</span><span> </span><span>t</span><span class="delimiter">)</span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">next</span></span><span>
</span><span>          </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e∉new_row"</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>s'_def</span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e∈s'›</span></span></span><span> </span><span>latin_rect_def</span><span> </span><span>partial_latin_square_def</span><span> </span><span>Suc</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"partial_latin_square s' n"</span></span></span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>partial_latin_square_def</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>latin_type.induct</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">"λt. inj_on (without t) s'"</span></span></span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card s' = n * (n - m)"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>card_s</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">"card s = n * (n - Suc m)"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>latin_rect_iff</span><span> </span><span>Suc</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>card_new_row</span><span class="delimiter">:</span><span class="string"><span class="delete"><span class="delete">"card new_row = n"</span></span></span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>new_row_def</span><span>
</span><span>      </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"inj_on (λj. rec_latin_type (n - Suc m) j (R j)) {0..&lt;n}"</span></span></span><span> </span><span class="keyword1"><span class="command">unfolding</span></span><span> </span><span>inj_on_def</span><span>
</span><span>        </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>ballI</span><span class="delimiter">;</span><span> </span><span>rule</span><span> </span><span>ballI</span><span class="delimiter">;</span><span> </span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>j1</span><span> </span><span>j2</span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"j1 ∈ {0..&lt;n}"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"j2 ∈ {0..&lt;n}"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"rec_latin_type (n - Suc m) j1 (R j1) = rec_latin_type (n - Suc m) j2 (R j2)"</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span>  </span><span class="string"><span class="delete"><span class="delete">"j1 = j2"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>latin_type.rec</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">"(n - Suc m)"</span></span></span><span> </span><span>j1</span><span> </span><span class="string"><span class="delete"><span class="delete">"R j1"</span></span></span><span class="delimiter">]</span><span> </span><span>latin_type.rec</span><span class="delimiter">(</span><span>2</span><span class="delimiter">)</span><span class="delimiter">[</span><span>of</span><span> </span><span>_</span><span> </span><span>j2</span><span> </span><span>_</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card ((λj. rec_latin_type (n - Suc m) j (R j)) ` {0..&lt;n}) = n"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>card_image</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"s ∩ new_row = {}"</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"∀e∈s. e Row &lt; n - Suc m"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Suc</span><span> </span><span>latin_rect_iff</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"∀e ∈ new_row. e ∉ s"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>new_row_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>      </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"finite s"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Suc</span><span> </span><span>latin_rect_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>bij_betw_finite</span><span> </span><span>finite_SigmaI</span><span> </span><span>finite_atLeastLessThan</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"finite new_row"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>new_row_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"card s' = card s + card new_row"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>s'_def</span><span> </span><span>card_Un_disjoint</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">with</span></span><span> </span><span>card_s</span><span> </span><span>card_new_row</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Suc</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>metis</span><span> </span><span>Suc_diff_Suc</span><span> </span><span>Suc_le_lessD</span><span> </span><span>add.commute</span><span> </span><span>mult_Suc_right</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"∀e∈s'. e Row &lt; (n - m)"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>ballI</span><span class="delimiter">;</span><span> </span><span>cases</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>e</span><span>
</span><span>      </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e∈new_row"</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e Row &lt; n - m"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Suc</span><span> </span><span>new_row_def</span><span> </span><span>R_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">next</span></span><span>
</span><span>      </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>e</span><span>
</span><span>      </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e ∈ s'"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e∉new_row"</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e Row &lt; n - Suc m"</span></span></span><span>  </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>latin_rect_iff</span><span> </span><span>Suc</span><span>  </span><span>s'_def</span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹e∈s'›</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"e Row &lt; n - m"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>latin_rect_iff</span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">"n-m"</span></span></span><span> </span><span>n</span><span class="delimiter">]</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span>  </span><span class="comment">― ‹Finally we use the induction hypothesis:›</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">obtain</span></span><span> </span><span>s''</span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"s' ⊆ s''"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"latin_square s'' n"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>Suc</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"s ⊆ s''"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span>s'_def</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"∃s'. s ⊆ s' ∧ latin_square s' n"</span></span></span><span> </span><span class="keyword1"><span class="command">using</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹latin_square s'' n›</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword2"><span class="keyword">end</span></span><span>
</span></pre>
</div>
</div>