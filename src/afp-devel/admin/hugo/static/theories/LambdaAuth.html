<div id="Nominal2_Lemmas">
<div class="head">
<h1>Theory Nominal2_Lemmas</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Matthias Brun,   ETH Zürich, 2019 *)</span>
<span class="comment1">(* Author: Dmitriy Traytel, ETH Zürich, 2019 *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Nominal2_Lemmas
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Nominal2/Nominal2.html">Nominal2.Nominal2</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary freshness lemmas and simplifier setup.›</span></span>

<span class="keyword1"><span class="command">declare</span></span>
  fresh_star_Pair<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> fresh_star_insert<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> fresh_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  pure_supp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> pure_fresh<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_star_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">♯*</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fresh_star_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> supp_flip<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">::</span> at"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="main">{</span>atom <span class="free">a</span><span class="main">,</span> atom <span class="free">b</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> flip_def supp_swap<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Abs_lst_eq_flipI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">::</span> at"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">::</span> fs"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">b</span> <span class="main">♯</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[</span>atom <span class="free">a</span><span class="main">]</span><span class="keyword1">]lst.</span> <span class="free">t</span> <span class="main">=</span> <span class="main">[</span><span class="main">[</span>atom <span class="free">b</span><span class="main">]</span><span class="keyword1">]lst.</span> <span class="main">(</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Abs1_eq_iff<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms flip_commute flip_def swap_fresh_fresh<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> atom_not_fresh_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> atom <span class="free">a</span> <span class="main">♯</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms atom_eq_iff fresh_ineq_at_base <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_set_fresh_forall<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">y</span> <span class="main">♯</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> atom <span class="free">y</span> <span class="main">♯</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_fresh_set_fresh_all<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span> <span class="main">::</span> fs<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> atom <span class="free">a</span> <span class="main">♯</span> <span class="free">S</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> atom <span class="free">a</span> <span class="main">♯</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fresh_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_of_finite_sets<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> case_option_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> case_option <span class="free">a</span> <span class="free">b</span> <span class="free">opt</span> <span class="main">=</span> case_option <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">opt</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">opt</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="FMap_Lemmas">
<div class="head">
<h1>Theory FMap_Lemmas</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Matthias Brun,   ETH Zürich, 2019 *)</span>
<span class="comment1">(* Author: Dmitriy Traytel, ETH Zürich, 2019 *)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> FMap_Lemmas
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Finite_Map.html">HOL-Library.Finite_Map</a>"</span>
          <a href="Nominal2_Lemmas.html">Nominal2_Lemmas</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Nominal setup for finite maps.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fmap_update</span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">'(</span>_ <span class="keyword1">$$:=</span> _<span class="keyword1">')</span>"</span> <span class="main">[</span>1000<span class="main">,</span>0<span class="main">,</span>0<span class="main">]</span> 1000<span class="main">)</span>  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fmap_update</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">≡</span> fmupd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>"</span></span>
<span class="keyword1"><span class="command">notation</span></span> fmlookup <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">$$</span>"</span> 999<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> fmempty <span class="main">(</span><span class="quoted">"<span class="keyword1">{$$}</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> fmap <span class="main">::</span> <span class="main">(</span><span class="quoted">pt</span><span class="main">,</span> <span class="quoted">pt</span><span class="main">)</span> <span class="quoted">pt</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">unbundle</span></span> fmap.lifting

<span class="keyword1"><span class="command">lift_definition</span></span>
  <span class="class_parameter">permute_fmap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"perm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"permute <span class="main">::</span> perm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="skolem">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"permute <span class="skolem"><span class="skolem">p</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">unfold</span> dom_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">f</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">y</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> permute <span class="skolem">p</span> <span class="main">`</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">a</span> <span class="main">≠</span> None<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">-</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="main"><span class="main">∙</span></span> <span class="skolem"><span class="skolem">x</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> some <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">a</span> <span class="main">≠</span> None<span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permute_self pemute_minus_self
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"permute <span class="main">(</span><span class="main">-</span> <span class="skolem">p</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">y</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> permute_minus_cancel<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∙</span> <span class="skolem">q</span> <span class="main">∙</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fmempty_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="main">{$$}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{$$}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> fmap_update_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">f</span><span class="main">(</span><span class="free">a</span> <span class="main">$$:=</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span><span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">a</span><span class="main">)</span> <span class="main">$$:=</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_upd_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fmap_apply_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="main">(</span><span class="free">f</span> <span class="main">$$</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_fmempty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">♯</span> <span class="main">{$$}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fresh_def supp_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_fmap_update<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span> <span class="main">♯</span> <span class="free">f</span><span class="main">;</span> <span class="free">a</span> <span class="main">♯</span> <span class="free">x</span><span class="main">;</span> <span class="free">a</span> <span class="main">♯</span> <span class="free">y</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">♯</span> <span class="free">f</span><span class="main">(</span><span class="free">x</span> <span class="main">$$:=</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fresh_conv_MOST
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> MOST_rev_mp<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> supp_fmempty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">{$$}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> supp_fmap_update<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">x</span> <span class="main">$$:=</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> supp<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fresh_fmap_update
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_def supp_Pair<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> fmap <span class="main">::</span> <span class="main">(</span><span class="quoted">fs</span><span class="main">,</span> <span class="quoted">fs</span><span class="main">)</span> <span class="quoted">fs</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fmap_induct<span class="main">)</span>
      <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> supp_Pair finite_supp finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> supp_fmap_update<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_transfer<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(=)</span> <span class="main">===&gt;</span> pcr_fmap <span class="main">(=)</span> <span class="main">(=)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> fresh fresh"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fresh_def supp_def rel_fun_def pcr_fmap_def cr_fmap_def simp_thms
    option.rel_eq fun_eq_iff<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmap_ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fmmap_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="main">(</span>fmmap <span class="free">f</span> <span class="free">F</span><span class="main">)</span> <span class="main">=</span> fmmap <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">F</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fmap_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmap_update_eqvt fmmap_fmupd<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fmap_freshness_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>at<span class="main">,</span><span class="tfree">'b</span><span class="main">::</span>pt<span class="main">)</span> fmap"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">.</span> atom <span class="bound">a</span> <span class="main">♯</span> <span class="main">(</span><span class="free">h</span><span class="main">,</span> <span class="free">h</span> <span class="main">$$</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a</span><span class="main">.</span> atom <span class="bound">a</span> <span class="main">♯</span> <span class="free">h</span> <span class="main">⟶</span> <span class="free">h</span> <span class="main">$$</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> fresh_Pair
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair freshness_lemma<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fmap_freshness_lemma_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>at<span class="main">,</span><span class="tfree">'b</span><span class="main">::</span>pt<span class="main">)</span> fmap"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">.</span> atom <span class="bound">a</span> <span class="main">♯</span> <span class="main">(</span><span class="free">h</span><span class="main">,</span> <span class="free">h</span> <span class="main">$$</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">a</span><span class="main">.</span> atom <span class="bound">a</span> <span class="main">♯</span> <span class="free">h</span> <span class="main">⟶</span> <span class="free">h</span> <span class="main">$$</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> fresh_Pair
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> freshness_lemma_unique<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fmdrop_fset_fmupd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>fmdrop_fset <span class="free">A</span> <span class="free">f</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">$$:=</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> fmdrop_fset <span class="main">(</span><span class="free">A</span> <span class="main">|-|</span> <span class="main">{|</span><span class="free">x</span><span class="main">|}</span><span class="main">)</span> <span class="free">f</span><span class="main">(</span><span class="free">x</span> <span class="main">$$:=</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> fmap.lifting fset.lifting
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_drop_set_def map_upd_def map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_fset_fminus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">|-|</span> <span class="main">{|</span><span class="free">x</span><span class="main">|}</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finsert_fminus_if fresh_finsert<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_fun_app<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">F</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">F</span> <span class="free">y</span> <span class="main">=</span> Some <span class="free">a</span> <span class="main">⟹</span> atom <span class="free">x</span> <span class="main">♯</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> supp_fun_app<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">F</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_def supp_Some atom_not_fresh_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_fmap_fresh_Some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">F</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">F</span> <span class="main">$$</span> <span class="free">y</span> <span class="main">=</span> Some <span class="free">a</span> <span class="main">⟹</span> atom <span class="free">x</span> <span class="main">♯</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> fmap.lifting
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> fresh_fun_app<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fmdrop_eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> fmdrop <span class="free">x</span> <span class="free">F</span> <span class="main">=</span> fmdrop <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_drop_def map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fmfilter_eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> fmfilter <span class="free">Q</span> <span class="free">F</span> <span class="main">=</span> fmfilter <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">Q</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_filter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fmdrop_eq_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fmdrop <span class="free">x</span> <span class="free">B</span> <span class="main">=</span> fmdrop <span class="free">y</span> <span class="free">B</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∨</span> <span class="main">(</span><span class="free">x</span> <span class="main">∉</span> fmdom' <span class="free">B</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∉</span> fmdom' <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_drop_def map_filter_def fun_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_fun_upd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">a</span> <span class="main">♯</span> <span class="free">f</span><span class="main">;</span> <span class="free">a</span> <span class="main">♯</span> <span class="free">x</span><span class="main">;</span> <span class="free">a</span> <span class="main">♯</span> <span class="free">y</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">♯</span> <span class="free">f</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fresh_conv_MOST <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> MOST_rev_mp<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> supp_fun_upd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> supp<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fresh_fun_upd <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_def supp_Pair<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_drop_fun_upd<span class="main">:</span> <span class="quoted"><span class="quoted">"map_drop <span class="free">x</span> <span class="free">F</span> <span class="main">=</span> <span class="free">F</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_drop_def map_filter_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_fmdrop_in_fmdom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">∈</span> fmdom' <span class="free">B</span><span class="main">;</span> <span class="free">y</span> <span class="main">♯</span> <span class="free">B</span><span class="main">;</span> <span class="free">y</span> <span class="main">♯</span> <span class="free">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">♯</span> fmdrop <span class="free">x</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_drop_fun_upd fresh_None <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fresh_fun_upd<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_fmdrop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">♯</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">♯</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">♯</span> fmdrop <span class="free">y</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> fmdom' <span class="free">B</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fresh_fmdrop_in_fmdom <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmdrop_idle'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_fmdrop_fset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">atom</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span> <span class="main">::</span> at_base<span class="main">)</span> fset"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">♯</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">♯</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">♯</span> fmdrop_fset <span class="free">A</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_fmdrop assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fresh_finsert<span class="main">)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span></pre>
</div><div id="Syntax">
<div class="head">
<h1>Theory Syntax</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Matthias Brun,   ETH Zürich, 2019 *)</span>
<span class="comment1">(* Author: Dmitriy Traytel, ETH Zürich, 2019 *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Syntax of $\lambda\bullet$›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Syntax
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Nominal2_Lemmas.html">Nominal2_Lemmas</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">typedecl</span></span> hash
<span class="keyword1"><span class="command">instantiation</span></span> hash <span class="main">::</span> <span class="quoted">pure</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">permute_hash</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"perm <span class="main">⇒</span> hash <span class="main">⇒</span> hash"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">permute_hash</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permute_hash_def<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">atom_decl</span></span> var

<span class="keyword1"><span class="command">nominal_datatype</span></span> <span class="quoted">"term"</span> <span class="main">=</span>
  Unit <span class="main">|</span>
  Var <span class="quoted">var</span> <span class="main">|</span>
  Lam x<span class="main">::</span><span class="quoted">var</span> t<span class="main">::</span><span class="quoted"><span class="quoted">"term"</span></span> <span class="keyword2"><span class="keyword">binds</span></span> <span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword">in</span></span> t <span class="main">|</span>
  Rec x<span class="main">::</span><span class="quoted">var</span> t<span class="main">::</span><span class="quoted"><span class="quoted">"term"</span></span> <span class="keyword2"><span class="keyword">binds</span></span> <span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword">in</span></span> t <span class="main">|</span>
  Inj1 <span class="quoted"><span class="quoted">"term"</span></span> <span class="main">|</span>
  Inj2 <span class="quoted"><span class="quoted">"term"</span></span> <span class="main">|</span>
  Pair <span class="quoted"><span class="quoted">"term"</span></span> <span class="quoted"><span class="quoted">"term"</span></span> <span class="main">|</span>
  Let <span class="quoted"><span class="quoted">"term"</span></span> x<span class="main">::</span><span class="quoted">var</span> t<span class="main">::</span><span class="quoted"><span class="quoted">"term"</span></span> <span class="keyword2"><span class="keyword">binds</span></span> <span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword">in</span></span> t <span class="main">|</span>
  App <span class="quoted"><span class="quoted">"term"</span></span> <span class="quoted"><span class="quoted">"term"</span></span> <span class="main">|</span>
  Case <span class="quoted"><span class="quoted">"term"</span></span> <span class="quoted"><span class="quoted">"term"</span></span> <span class="quoted"><span class="quoted">"term"</span></span> <span class="main">|</span>
  Prj1 <span class="quoted"><span class="quoted">"term"</span></span> <span class="main">|</span>
  Prj2 <span class="quoted"><span class="quoted">"term"</span></span> <span class="main">|</span>
  Roll <span class="quoted"><span class="quoted">"term"</span></span> <span class="main">|</span>
  Unroll <span class="quoted"><span class="quoted">"term"</span></span> <span class="main">|</span>
  Auth <span class="quoted"><span class="quoted">"term"</span></span> <span class="main">|</span>
  Unauth <span class="quoted"><span class="quoted">"term"</span></span> <span class="main">|</span>
  Hash <span class="quoted">hash</span> <span class="main">|</span>
  Hashed <span class="quoted">hash</span> <span class="quoted"><span class="quoted">"term"</span></span>

<span class="keyword1"><span class="command">atom_decl</span></span> tvar

<span class="keyword1"><span class="command">nominal_datatype</span></span> ty <span class="main">=</span>
  One <span class="main">|</span>
  Fun <span class="quoted">ty</span> <span class="quoted">ty</span> <span class="main">|</span>
  Sum <span class="quoted">ty</span> <span class="quoted">ty</span> <span class="main">|</span>
  Prod <span class="quoted">ty</span> <span class="quoted">ty</span> <span class="main">|</span>
  Mu α<span class="main">::</span><span class="quoted">tvar</span> τ<span class="main">::</span><span class="quoted">ty</span> <span class="keyword2"><span class="keyword">binds</span></span> <span class="quoted"><span class="free">α</span></span> <span class="keyword2"><span class="keyword">in</span></span> τ <span class="main">|</span>
  Alpha <span class="quoted">tvar</span> <span class="main">|</span>
  AuthT <span class="quoted">ty</span>

<span class="keyword1"><span class="command">lemma</span></span> no_tvars_in_term<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="main">(</span><span class="free">x</span> <span class="main">::</span> tvar<span class="main">)</span> <span class="main">♯</span> <span class="main">(</span><span class="free">t</span> <span class="main">::</span> term<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> term.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> no_vars_in_ty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="main">(</span><span class="free">x</span> <span class="main">::</span> var<span class="main">)</span> <span class="main">♯</span> <span class="main">(</span><span class="free">τ</span> <span class="main">::</span> ty<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ty.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="quoted">"<span class="entity">value</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">value</span> Unit"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">value</span> <span class="main">(</span>Var <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">value</span> <span class="main">(</span>Lam <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">value</span> <span class="main">(</span>Rec <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">value</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⟹</span> <span class="free">value</span> <span class="main">(</span>Inj1 <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">value</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⟹</span> <span class="free">value</span> <span class="main">(</span>Inj2 <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">value</span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">;</span> <span class="free">value</span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">value</span> <span class="main">(</span>Pair <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">value</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⟹</span> <span class="free">value</span> <span class="main">(</span>Roll <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">value</span> <span class="main">(</span>Hash <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">value</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⟹</span> <span class="free">value</span> <span class="main">(</span>Hashed <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> value.intros<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> value.intros<span class="main">[</span><span class="operator">intro</span><span class="main">]</span>

<span class="keyword1"><span class="command">equivariance</span></span> <span class="quoted"><span class="quoted">"value"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> value_inv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> value <span class="main">(</span>Let <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> value <span class="main">(</span>App <span class="free">v</span> <span class="free">v'</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> value <span class="main">(</span>Case <span class="free">v</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> value <span class="main">(</span>Prj1 <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> value <span class="main">(</span>Prj2 <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> value <span class="main">(</span>Unroll <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> value <span class="main">(</span>Auth <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> value <span class="main">(</span>Unauth <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> value.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> value_Inj1_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"value <span class="main">(</span>Inj1 <span class="free">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> value_Inj2_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"value <span class="main">(</span>Inj2 <span class="free">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> value_Pair_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"value <span class="main">(</span>Pair <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> value_Roll_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"value <span class="main">(</span>Roll <span class="free">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> value_Hashed_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"value <span class="main">(</span>Hashed <span class="free">h</span> <span class="free">e</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">closed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closed</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">::</span>var<span class="main">.</span> atom <span class="bound">x</span> <span class="main">♯</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Semantics">
<div class="head">
<h1>Theory Semantics</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Matthias Brun,   ETH Zürich, 2019 *)</span>
<span class="comment1">(* Author: Dmitriy Traytel, ETH Zürich, 2019 *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Semantics of $\lambda\bullet$›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Semantics
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="FMap_Lemmas.html">FMap_Lemmas</a> <a href="Syntax.html">Syntax</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Avoid clash with substitution notation.›</span></span>
<span class="keyword1"><span class="command">no_notation</span></span> inverse_divide <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">'/</span>"</span> 70<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Help automated provers with smallsteps.›</span></span>
<span class="keyword1"><span class="command">declare</span></span> One_nat_def<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Equivariant Hash Function›</span></span>

<span class="keyword1"><span class="command">consts</span></span> hash_real <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> hash"</span></span>

<span class="keyword1"><span class="command">nominal_function</span></span> <span class="entity">map_fixed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"var <span class="main">⇒</span> var list <span class="main">⇒</span> term <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> Unit <span class="main">=</span> Unit"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">fp</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"atom <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">♯</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fp</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>Lam <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Lam <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"atom <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">♯</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fp</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>Rec <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Rec <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>Inj1 <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Inj1 <span class="main">(</span><span class="main">(</span><span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>Inj2 <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Inj2 <span class="main">(</span><span class="main">(</span><span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>Pair <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Pair <span class="main">(</span><span class="main">(</span><span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>Roll <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Roll <span class="main">(</span><span class="main">(</span><span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"atom <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">♯</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fp</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>Let <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Let <span class="main">(</span><span class="main">(</span><span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>App <span class="main">(</span><span class="main">(</span><span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>Case <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Case <span class="main">(</span><span class="main">(</span><span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>Prj1 <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Prj1 <span class="main">(</span><span class="main">(</span><span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>Prj2 <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Prj2 <span class="main">(</span><span class="main">(</span><span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>Unroll <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Unroll <span class="main">(</span><span class="main">(</span><span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>Auth <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Auth <span class="main">(</span><span class="main">(</span><span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>Unauth <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Unauth <span class="main">(</span><span class="main">(</span><span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>Hash <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Hash <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>Hashed <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Hashed <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free">map_fixed</span> <span class="free"><span class="bound"><span class="entity">fp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> alpha_lst defined_all<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_def map_fixed_graph_aux_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> map_fixed_graph.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_at_base<span class="main">)</span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> P fp l t
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> term.strong_exhaust<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">P</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">fp</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">l</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_Pair<span class="main">)</span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_at_base<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> y fp l t ya fpa la ta
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Abs_lst1_fcb2'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">fp</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">l</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_at_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> perm_supp_eq Abs_fresh_iff fresh_Pair<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> y fp l t ya fpa la ta
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Abs_lst1_fcb2'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">fp</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">l</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_at_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> perm_supp_eq Abs_fresh_iff fresh_Pair<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> y fp l t ya fpa la ta
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Abs_lst1_fcb2'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">fp</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">l</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_at_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> perm_supp_eq Abs_fresh_iff fresh_Pair<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">nominal_termination</span></span> <span class="main">(</span>eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hash</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hash</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> hash_real <span class="main">(</span>map_fixed undefined <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> permute_map_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="free">l</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">p</span> <span class="main">∙</span> <span class="bound">x</span><span class="main">)</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_fixed_eqvt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> <span class="free">l</span> <span class="main">=</span> <span class="free">l</span> <span class="main">⟹</span> map_fixed <span class="free">v</span> <span class="free">l</span> <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> map_fixed <span class="free">v</span> <span class="free">l</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> term.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term.supp supp_at_base permute_map_list list_eq_iff_nth_eq in_set_conv_nth<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Lam <span class="skolem">y</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Lam<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">,</span>5<span class="main">)</span> Lam<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">#</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_perm<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rec <span class="skolem">y</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Rec<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">,</span>5<span class="main">)</span> Rec<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">#</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_perm<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">e'</span> <span class="skolem">y</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Let<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">,</span>6<span class="main">)</span> Let<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span> Let<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">#</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_perm<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permute_pure<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hash_eqvt<span class="main">[</span><span class="operator">eqvt</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∙</span> hash <span class="free">t</span> <span class="main">=</span> hash <span class="main">(</span><span class="free">p</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> permute_pure hash_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_fixed_eqvt<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_fixed_idle<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> atom <span class="bound">x</span> <span class="main">♯</span> <span class="free">t</span><span class="main">}</span> <span class="main">⊆</span> set <span class="free">l</span> <span class="main">⟹</span> map_fixed <span class="free">v</span> <span class="free">l</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> term.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subset_iff fresh_at_base<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Lam <span class="skolem">y</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Lam<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">)</span> Lam<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">#</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair Abs1_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rec <span class="skolem">y</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Rec<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">)</span> Rec<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">#</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair Abs1_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">e'</span> <span class="skolem">y</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Let<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>5<span class="main">)</span> Let<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span> Let<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">#</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair Abs1_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subset_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_fixed_idle_closed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"closed <span class="free">t</span> <span class="main">⟹</span> map_fixed undefined <span class="main">[]</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> map_fixed_idle<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_fixed_inj_closed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"closed <span class="free">t</span> <span class="main">⟹</span> closed <span class="free">u</span> <span class="main">⟹</span> map_fixed undefined <span class="main">[]</span> <span class="free">t</span> <span class="main">=</span> map_fixed undefined <span class="main">[]</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ map_fixed_idle_closed map_fixed_idle_closed<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hash_eq_hash_real_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hash <span class="free">t</span> <span class="main">=</span> hash_real <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> hash_def map_fixed_idle_closed<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Substitution›</span></span>

<span class="keyword1"><span class="command">nominal_function</span></span> <span class="entity">subst_term</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> term <span class="main">⇒</span> var <span class="main">⇒</span> term"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_ <span class="keyword1">'/</span> _<span class="keyword1">]</span>"</span> <span class="main">[</span>250<span class="main">,</span> 200<span class="main">,</span> 200<span class="main">]</span> 250<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"Unit<span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> Unit"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="keyword1">else</span> Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"atom <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">♯</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>Lam <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> Lam <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"atom <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">♯</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>Rec <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> Rec <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Inj1 <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> Inj1 <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Inj2 <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> Inj2 <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Pair <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> Pair <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span> "</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Roll <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> Roll <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"atom <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">♯</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>Let <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> Let <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> App <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Case <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> Case <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Prj1 <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> Prj1 <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Prj2 <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> Prj2 <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Unroll <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> Unroll <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Auth <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> Auth <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Unauth <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> Unauth <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Hash <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> Hash <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Hashed <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span> <span class="main">=</span> Hashed <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main"><span class="free">/</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">]</span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> alpha_lst defined_all<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_def subst_term_graph_aux_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> subst_term_graph.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_at_base<span class="main">)</span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> P a b t
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> term.strong_exhaust<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">a</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">P</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">b</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">t</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_Pair<span class="main">)</span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_at_base<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Abs_lst1_fcb2'<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_at_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> perm_supp_eq Abs_fresh_iff fresh_Pair<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Abs_lst1_fcb2'<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_at_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> perm_supp_eq Abs_fresh_iff fresh_Pair<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Abs_lst1_fcb2'<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_at_def<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> perm_supp_eq Abs_fresh_iff fresh_Pair<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">nominal_termination</span></span> <span class="main">(</span>eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">type_synonym</span></span> tenv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>var<span class="main">,</span> term<span class="main">)</span> fmap"</span></span>

<span class="keyword1"><span class="command">nominal_function</span></span> <span class="entity">psubst_term</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> tenv <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">psubst_term</span> Unit <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Unit"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">psubst_term</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">of</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">|</span> None <span class="main">⇒</span> Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"atom <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">♯</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span> <span class="free">psubst_term</span> <span class="main">(</span>Lam <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Lam <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span><span class="free">psubst_term</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"atom <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">♯</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span> <span class="free">psubst_term</span> <span class="main">(</span>Rec <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Rec <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span><span class="free">psubst_term</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">psubst_term</span> <span class="main">(</span>Inj1 <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Inj1 <span class="main">(</span><span class="free">psubst_term</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">psubst_term</span> <span class="main">(</span>Inj2 <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Inj2 <span class="main">(</span><span class="free">psubst_term</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">psubst_term</span> <span class="main">(</span>Pair <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Pair <span class="main">(</span><span class="free">psubst_term</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">psubst_term</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> "</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">psubst_term</span> <span class="main">(</span>Roll <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Roll <span class="main">(</span><span class="free">psubst_term</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"atom <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">♯</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span> <span class="free">psubst_term</span> <span class="main">(</span>Let <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Let <span class="main">(</span><span class="free">psubst_term</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span><span class="free">psubst_term</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">psubst_term</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> App <span class="main">(</span><span class="free">psubst_term</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">psubst_term</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">psubst_term</span> <span class="main">(</span>Case <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Case <span class="main">(</span><span class="free">psubst_term</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">psubst_term</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">psubst_term</span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">psubst_term</span> <span class="main">(</span>Prj1 <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Prj1 <span class="main">(</span><span class="free">psubst_term</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">psubst_term</span> <span class="main">(</span>Prj2 <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Prj2 <span class="main">(</span><span class="free">psubst_term</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">psubst_term</span> <span class="main">(</span>Unroll <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Unroll <span class="main">(</span><span class="free">psubst_term</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">psubst_term</span> <span class="main">(</span>Auth <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Auth <span class="main">(</span><span class="free">psubst_term</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">psubst_term</span> <span class="main">(</span>Unauth <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Unauth <span class="main">(</span><span class="free">psubst_term</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">psubst_term</span> <span class="main">(</span>Hash <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Hash <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">psubst_term</span> <span class="main">(</span>Hashed <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Hashed <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span><span class="free">psubst_term</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> alpha_lst defined_all<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_def psubst_term_graph_aux_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> psubst_term_graph.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_at_base<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> P a b
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> term.strong_exhaust<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">a</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">P</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">b</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_Pair<span class="main">)</span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_at_base<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Abs_lst1_fcb2'<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_at_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> perm_supp_eq Abs_fresh_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Abs_lst1_fcb2'<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_at_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> perm_supp_eq Abs_fresh_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Abs_lst1_fcb2'<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_at_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> perm_supp_eq Abs_fresh_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">nominal_termination</span></span> <span class="main">(</span>eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">nominal_function</span></span> <span class="entity">subst_type</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ty <span class="main">⇒</span> ty <span class="main">⇒</span> tvar <span class="main">⇒</span> ty"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst_type</span> One <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> One"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">subst_type</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Fun <span class="main">(</span><span class="free">subst_type</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">subst_type</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">subst_type</span> <span class="main">(</span>Sum <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Sum <span class="main">(</span><span class="free">subst_type</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">subst_type</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">subst_type</span> <span class="main">(</span>Prod <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Prod <span class="main">(</span><span class="free">subst_type</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">subst_type</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"atom <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">♯</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">subst_type</span> <span class="main">(</span>Mu <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Mu <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span><span class="free">subst_type</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">subst_type</span> <span class="main">(</span>Alpha <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="keyword1">else</span> Alpha <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">subst_type</span> <span class="main">(</span>AuthT <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> AuthT <span class="main">(</span><span class="free">subst_type</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> alpha_lst defined_all<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_def subst_type_graph_aux_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> subst_type_graph.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_at_base<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> P a
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ty.strong_exhaust<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">a</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">P</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_star_def<span class="main">)</span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_at_base<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Abs_lst1_fcb2'<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_at_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> perm_supp_eq Abs_fresh_iff fresh_Pair<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">nominal_termination</span></span> <span class="main">(</span>eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_subst_term<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">t</span><span class="main">[</span><span class="free">t'</span> <span class="main">/</span> <span class="free">x'</span><span class="main">]</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="free">x'</span> <span class="main">∨</span> atom <span class="free">x</span> <span class="main">♯</span> <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>atom <span class="free">x'</span> <span class="main">♯</span> <span class="free">t</span> <span class="main">∨</span> atom <span class="free">x</span> <span class="main">♯</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">x'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> term.strong_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_at_base<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> term_fresh_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">t</span> <span class="main">⟹</span> atom <span class="free">x</span> <span class="main">♯</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span>atom <span class="main">(</span><span class="free">x</span><span class="main">::</span>var<span class="main">)</span><span class="main">)</span> <span class="main">♯</span> <span class="free">t</span><span class="main">[</span><span class="free">s</span> <span class="main">/</span> <span class="free">y</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> term.strong_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> term_subst_idle<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="free">y</span> <span class="main">♯</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span><span class="main">[</span><span class="free">s</span> <span class="main">/</span> <span class="free">y</span><span class="main">]</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> term.strong_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair fresh_at_base<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> term_subst_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="free">y1</span> <span class="main">≠</span> atom <span class="free">y2</span> <span class="main">⟹</span> atom <span class="free">y1</span> <span class="main">♯</span> <span class="free">s2</span> <span class="main">⟹</span> <span class="free">t</span><span class="main">[</span><span class="free">s1</span> <span class="main">/</span> <span class="free">y1</span><span class="main">]</span><span class="main">[</span><span class="free">s2</span> <span class="main">/</span> <span class="free">y2</span><span class="main">]</span> <span class="main">=</span> <span class="free">t</span><span class="main">[</span><span class="free">s2</span> <span class="main">/</span> <span class="free">y2</span><span class="main">]</span><span class="main">[</span><span class="free">s1</span><span class="main">[</span><span class="free">s2</span> <span class="main">/</span> <span class="free">y2</span><span class="main">]</span> <span class="main">/</span> <span class="free">y1</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">y1</span></span> <span class="quoted"><span class="free">y2</span></span> <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">s2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> term.strong_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_psubst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">var</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">vs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> psubst_term <span class="free">e</span> <span class="free">vs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> psubst_term.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_at_base <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> fresh_fmap_fresh_Some <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_subst_type<span class="main">:</span>
  <span class="quoted"><span class="quoted">"atom <span class="free">α</span> <span class="main">♯</span> subst_type <span class="free">τ</span> <span class="free">τ'</span> <span class="free">α'</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="free">α</span> <span class="main">=</span> <span class="free">α'</span> <span class="main">∨</span> atom <span class="free">α</span> <span class="main">♯</span> <span class="free">τ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>atom <span class="free">α'</span> <span class="main">♯</span> <span class="free">τ</span> <span class="main">∨</span> atom <span class="free">α</span> <span class="main">♯</span> <span class="free">τ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="free">α'</span></span> <span class="quoted"><span class="free">τ'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ty.strong_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_at_base<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> type_fresh_subst<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">t</span> <span class="main">⟹</span> atom <span class="free">x</span> <span class="main">♯</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">(</span>atom <span class="main">(</span><span class="free">x</span><span class="main">::</span>tvar<span class="main">)</span><span class="main">)</span> <span class="main">♯</span> subst_type <span class="free">t</span> <span class="free">s</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ty.strong_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> type_subst_idle<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="free">y</span> <span class="main">♯</span> <span class="free">t</span> <span class="main">⟹</span> subst_type <span class="free">t</span> <span class="free">s</span> <span class="free">y</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ty.strong_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair fresh_at_base<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> type_subst_subst<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="free">y1</span> <span class="main">≠</span> atom <span class="free">y2</span> <span class="main">⟹</span> atom <span class="free">y1</span> <span class="main">♯</span> <span class="free">s2</span> <span class="main">⟹</span>
  subst_type <span class="main">(</span>subst_type <span class="free">t</span> <span class="free">s1</span> <span class="free">y1</span><span class="main">)</span> <span class="free">s2</span> <span class="free">y2</span> <span class="main">=</span> subst_type <span class="main">(</span>subst_type <span class="free">t</span> <span class="free">s2</span> <span class="free">y2</span><span class="main">)</span> <span class="main">(</span>subst_type <span class="free">s1</span> <span class="free">s2</span> <span class="free">y2</span><span class="main">)</span> <span class="free">y1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">y1</span></span> <span class="quoted"><span class="free">y2</span></span> <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">s2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ty.strong_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Weak Typing Judgement›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> tyenv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>var<span class="main">,</span> ty<span class="main">)</span> fmap"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">judge_weak</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tyenv <span class="main">⇒</span> term <span class="main">⇒</span> ty <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> _ <span class="keyword1">:</span> _"</span> <span class="main">[</span>150<span class="main">,</span>0<span class="main">,</span>150<span class="main">]</span> 149<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  jw_Unit<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> Unit <span class="main"><span class="free">:</span></span> One"</span></span> <span class="main">|</span>
  jw_Var<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> Var <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span> <span class="main">|</span>
  jw_Lam<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> atom <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">♯</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">$$:=</span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> Lam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> Fun <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
  jw_App<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> Fun <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> App <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
  jw_Let<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> atom <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">♯</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">$$:=</span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> Let <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
  jw_Rec<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> atom <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">♯</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">;</span> atom <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">♯</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">$$:=</span> Fun <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> Lam <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> Fun <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> Rec <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Lam <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main"><span class="free">:</span></span> Fun <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
  jw_Inj1<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> Inj1 <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> Sum <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
  jw_Inj2<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> Inj2 <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> Sum <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
  jw_Case<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> Sum <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">:</span></span> Fun <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> Fun <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> Case <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span> <span class="main">|</span>
  jw_Pair<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> Pair <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> Prod <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
  jw_Prj1<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> Prod <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> Prj1 <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span>"</span></span> <span class="main">|</span>
  jw_Prj2<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> Prod <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> Prj2 <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
  jw_Roll<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span> atom <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">♯</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> subst_type <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">(</span>Mu <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> Roll <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> Mu <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span> <span class="main">|</span>
  jw_Unroll<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> atom <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">♯</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> Mu <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> Unroll <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> subst_type <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">(</span>Mu <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span>"</span></span> <span class="main">|</span>
  jw_Auth<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> Auth <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span> <span class="main">|</span>
  jw_Unauth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>W</sub></span></span> Unauth <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> judge_weak.intros<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> judge_weak.intros<span class="main">[</span><span class="operator">intro</span><span class="main">]</span>

<span class="keyword1"><span class="command">equivariance</span></span> <span class="quoted">judge_weak</span>
<span class="keyword1"><span class="command">nominal_inductive</span></span> judge_weak
  <span class="keyword2"><span class="keyword">avoids</span></span> jw_Lam<span class="main">:</span> <span class="quoted"><span class="free">x</span></span>
       <span class="main">|</span> jw_Rec<span class="main">:</span> <span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="free">y</span></span>
       <span class="main">|</span> jw_Let<span class="main">:</span> <span class="quoted"><span class="free">x</span></span>
       <span class="main">|</span> jw_Roll<span class="main">:</span> <span class="quoted"><span class="free">α</span></span>
       <span class="main">|</span> jw_Unroll<span class="main">:</span> <span class="quoted"><span class="free">α</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_subst_type fresh_Pair<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Inversion rules for typing judgment.›</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> jw_Unit_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> Unit <span class="main">:</span> <span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> jw_Var_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> Var <span class="free">x</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> jw_Lam_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> Lam <span class="free">x</span> <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">=</span> Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span><span class="main">(</span><span class="free">x</span> <span class="main">$$:=</span> <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">nominal_induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"Lam <span class="free">x</span> <span class="free">e</span>"</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> judge_weak.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>jw_Lam <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">y</span> <span class="skolem">u</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> perm_supp_eq <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>
        iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Abs_lst1_fcb2'<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">t</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> <span class="bound">τ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">(</span><span class="bound">x</span> <span class="main">$$:=</span> <span class="bound">τ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="bound">t</span> <span class="main">:</span> <span class="bound">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span> c <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span> a <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span> b <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span> x <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span> y <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">unfolded</span> prod.case<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span>
        <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_permute_swap<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">π</span> <span class="main">⟹</span> atom <span class="free">y</span> <span class="main">♯</span> <span class="free">π</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">↔</span> <span class="free">y</span><span class="main">)</span> <span class="main">∙</span> <span class="free">π</span> <span class="main">∙</span> <span class="main">(</span><span class="free">x</span> <span class="main">↔</span> <span class="free">y</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span> <span class="main">=</span> <span class="free">π</span> <span class="main">∙</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> permute_eqvt<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> flip_fresh_fresh<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> jw_Rec_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> Rec <span class="free">x</span> <span class="free">t</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="free">e</span> <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">y</span> <span class="main">♯</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span><span class="free">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Lam <span class="free">y</span> <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">=</span> Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">(</span><span class="free">x</span> <span class="main">$$:=</span> Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> Lam <span class="free">y</span> <span class="free">e</span> <span class="main">:</span> Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> alpha_lst<span class="main">]</span><span class="main">]</span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">nominal_induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"Rec <span class="free">x</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> judge_weak.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>jw_Rec <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">y</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span> <span class="skolem">z</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> term.strong_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Lam <span class="skolem">y'</span> <span class="skolem">e'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Lam.prems <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">y</span> <span class="main">♯</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> Lam.hyps<span class="main">(</span>1-3<span class="main">)</span> Lam.prems <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Lam <span class="skolem">y'</span> <span class="skolem">e'</span> <span class="main">=</span> Lam <span class="skolem">y</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y'</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">e'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> term.eq_iff<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> Abs_lst_eq_flipI<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_at_base<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Lam.hyps<span class="main">(</span>1-3<span class="main">)</span> Lam.prems <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">(</span><span class="skolem">z</span> <span class="main">$$:=</span> Fun <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> Lam <span class="skolem">y</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y'</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">e'</span><span class="main">)</span> <span class="main">:</span> Fun <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> judge_weak.eqvt<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">Γ</span></span></span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span> <span class="main"><span class="main"><span class="main">$$:=</span></span></span> Fun <span class="skolem"><span class="skolem"><span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Lam <span class="skolem"><span class="skolem"><span class="skolem">y</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Fun <span class="skolem"><span class="skolem"><span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span> <span class="main"><span class="main"><span class="main">↔</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">z</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">elim_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> perm_supp_eq Abs1_eq_iff fresh_at_base swap_permute_swap fresh_perm flip_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> jw_Inj1_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> Inj1 <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> jw_Inj2_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> Inj2 <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> jw_Pair_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> Pair <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="free">τ</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> jw_Let_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> Let <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="main">(</span><span class="free">e<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">:</span> <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">(</span><span class="free">x</span> <span class="main">$$:=</span> <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">nominal_induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"Let <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">e<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">e<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> judge_weak.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>jw_Let <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">x'</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair perm_supp_eq <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>
        iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Abs_lst1_fcb2'<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">t</span> <span class="main">(</span><span class="bound">Γ</span><span class="main">,</span> <span class="bound">τ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">.</span> <span class="bound">Γ</span><span class="main">(</span><span class="bound">x</span> <span class="main">$$:=</span> <span class="bound">τ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="bound">t</span> <span class="main">:</span> <span class="bound">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span> c <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span> a <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span> b <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span> x <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span> y <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="skolem">e<span class="hidden">⇩</span><sub>2</sub>'</span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">unfolded</span> prod.case<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span>
        <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> jw_Prj1_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> Prj1 <span class="free">e</span> <span class="main">:</span> <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> jw_Prj2_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> Prj2 <span class="free">e</span> <span class="main">:</span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> jw_App_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> App <span class="free">e</span> <span class="free">e'</span> <span class="main">:</span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> jw_Case_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> Case <span class="free">e</span> <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> jw_Auth_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> Auth <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> jw_Unauth_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> Unauth <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subst_type_perm_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">b</span> <span class="main">♯</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"subst_type <span class="free">t</span> <span class="main">(</span>Mu <span class="free">a</span> <span class="free">t</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> subst_type <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>Mu <span class="free">b</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="free">a</span> <span class="main">♯</span> subst_type <span class="free">t</span> <span class="main">(</span>Mu <span class="free">a</span> <span class="free">t</span><span class="main">)</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fresh_subst_type<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span>    <span class="quoted"><span class="quoted">"atom <span class="free">b</span> <span class="main">♯</span> subst_type <span class="free">t</span> <span class="main">(</span>Mu <span class="free">a</span> <span class="free">t</span><span class="main">)</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst_type <span class="free">t</span> <span class="main">(</span>Mu <span class="free">a</span> <span class="free">t</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">)</span> <span class="main">∙</span> subst_type <span class="free">t</span> <span class="main">(</span>Mu <span class="free">a</span> <span class="free">t</span><span class="main">)</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flip_fresh_fresh<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subst_type <span class="free">t</span> <span class="main">(</span>Mu <span class="free">a</span> <span class="free">t</span><span class="main">)</span> <span class="free">a</span>  <span class="main">=</span> subst_type <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>Mu <span class="free">b</span> <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">)</span> <span class="main">∙</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> jw_Roll_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> Roll <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"atom <span class="free">α</span> <span class="main">♯</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">τ'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">=</span> Mu <span class="free">α</span> <span class="free">τ'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="free">e</span> <span class="main">:</span> subst_type <span class="free">τ'</span> <span class="main">(</span>Mu <span class="free">α</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">α</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> alpha_lst<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">nominal_induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"Roll <span class="free">e</span>"</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">α</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> judge_weak.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>jw_Roll <span class="skolem">α</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">τ</span> <span class="skolem">α'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> perm_supp_eq fresh_Pair fresh_at_base subst_type.eqvt
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">α</span> <span class="main">↔</span> <span class="skolem">α'</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">τ</span>"</span></span><span class="main"><span class="main">]</span></span> Abs_lst_eq_flipI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> judge_weak.eqvt<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">α</span> <span class="main">↔</span> <span class="skolem">α'</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> jw_Unroll_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> Unroll <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"atom <span class="free">α</span> <span class="main">♯</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span> <span class="free">τ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">τ'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">=</span> subst_type <span class="free">τ'</span> <span class="main">(</span>Mu <span class="free">α</span> <span class="free">τ'</span><span class="main">)</span> <span class="free">α</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="free">e</span> <span class="main">:</span> Mu <span class="free">α</span> <span class="free">τ'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">nominal_induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"Unroll <span class="free">e</span>"</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">α</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> judge_weak.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>jw_Unroll <span class="skolem">α</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">τ</span> <span class="skolem">α'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> perm_supp_eq fresh_Pair subst_type_perm_eq fresh_subst_type
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">α</span> <span class="main">↔</span> <span class="skolem">α'</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">τ</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> judge_weak.eqvt<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">α</span> <span class="main">↔</span> <span class="skolem">α'</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Additional inversion rules based on type rather than term.›</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> jw_Prod_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="free">e</span> <span class="main">:</span> Prod <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> jw_Sum_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="free">e</span> <span class="main">:</span> Sum <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> jw_Fun_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="free">v</span> <span class="main">:</span> Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"value <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">e</span> <span class="free">x</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> Lam <span class="free">x</span> <span class="free">e</span> <span class="main">∨</span> <span class="free">v</span> <span class="main">=</span> Rec <span class="free">x</span> <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="main">(</span><span class="free">c</span><span class="main">::</span>term<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> alpha_lst<span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">nominal_induct</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">::</span> tyenv"</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="quoted">"Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> judge_weak.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>jw_Lam <span class="skolem">x</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">(</span><span class="skolem">x'</span><span class="main">::</span>var<span class="main">)</span> <span class="main">♯</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_supp obtain_fresh' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[</span>atom <span class="skolem">x</span><span class="main">]</span><span class="keyword1">]lst.</span> <span class="skolem">e</span> <span class="main">=</span> <span class="main">[</span><span class="main">[</span>atom <span class="skolem">x'</span><span class="main">]</span><span class="keyword1">]lst.</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">e</span> <span class="main">∧</span> atom <span class="skolem">x'</span> <span class="main">♯</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_lst_eq_flipI fresh_Pair<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>jw_Rec <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"atom <span class="main">(</span><span class="skolem">x'</span><span class="main">::</span>var<span class="main">)</span> <span class="main">♯</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> Lam <span class="skolem">y</span> <span class="skolem">e'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_supp obtain_fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[</span>atom <span class="skolem">x</span><span class="main">]</span><span class="keyword1">]lst.</span> Lam <span class="skolem">y</span> <span class="skolem">e'</span> <span class="main">=</span> <span class="main">[</span><span class="main">[</span>atom <span class="skolem">x'</span><span class="main">]</span><span class="keyword1">]lst.</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>Lam <span class="skolem">y</span> <span class="skolem">e'</span><span class="main">)</span> <span class="main">∧</span> atom <span class="skolem">x'</span> <span class="main">♯</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Abs_lst_eq_flipI fresh_Pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> jw_Mu_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="free">v</span> <span class="main">:</span> Mu <span class="free">α</span> <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"value <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">v'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> Roll <span class="free">v'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">nominal_induct</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">::</span> tyenv"</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="quoted">"Mu <span class="free">α</span> <span class="free">τ</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> judge_weak.strong_induct<span class="main">)</span> <span class="operator">simp_all</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Erasure of Authenticated Types›</span></span>

<span class="keyword1"><span class="command">nominal_function</span></span> <span class="entity">erase</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ty <span class="main">⇒</span> ty"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">erase</span> One <span class="main">=</span> One"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">erase</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> Fun <span class="main">(</span><span class="free">erase</span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">erase</span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">erase</span> <span class="main">(</span>Sum <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> Sum <span class="main">(</span><span class="free">erase</span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">erase</span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">erase</span> <span class="main">(</span>Prod <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> Prod <span class="main">(</span><span class="free">erase</span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">erase</span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">erase</span> <span class="main">(</span>Mu <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span> <span class="main">=</span> Mu <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">(</span><span class="free">erase</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">erase</span> <span class="main">(</span>Alpha <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span> <span class="main">=</span> Alpha <span class="free"><span class="bound"><span class="entity">α</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">erase</span> <span class="main">(</span>AuthT <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">erase</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> alpha_lst<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_def erase_graph_aux_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> erase_graph.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_at_base<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> P x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ty.strong_exhaust<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">P</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_star_def<span class="main">)</span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_at_base<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Abs_lst1_fcb2'<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_at_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> perm_supp_eq Abs_fresh_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">nominal_termination</span></span> <span class="main">(</span>eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_erase_fresh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> erase <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ty.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_fmmap_erase_fresh<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> fmmap erase <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> erase_subst_type_shift<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"erase <span class="main">(</span>subst_type <span class="free">τ</span> <span class="free">τ'</span> <span class="free">α</span><span class="main">)</span> <span class="main">=</span> subst_type <span class="main">(</span>erase <span class="free">τ</span><span class="main">)</span> <span class="main">(</span>erase <span class="free">τ'</span><span class="main">)</span> <span class="free">α</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">τ</span></span> <span class="quoted"><span class="free">τ'</span></span> <span class="quoted"><span class="free">α</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_type.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair fresh_erase_fresh<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">erase_env</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tyenv <span class="main">⇒</span> tyenv"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">erase_env</span> <span class="main">=</span> fmmap erase"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Strong Typing Judgement›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">judge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tyenv <span class="main">⇒</span> term <span class="main">⇒</span> ty <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">:</span> _"</span> <span class="main">[</span>150<span class="main">,</span>0<span class="main">,</span>150<span class="main">]</span> 149<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  j_Unit<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Unit <span class="main"><span class="free">:</span></span> One"</span></span> <span class="main">|</span>
  j_Var<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Var <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span> <span class="main">|</span>
  j_Lam<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> atom <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">♯</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">$$:=</span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Lam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> Fun <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
  j_App<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> Fun <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> App <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
  j_Let<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> atom <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">♯</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">$$:=</span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Let <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
  j_Rec<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> atom <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">♯</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">;</span> atom <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">♯</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">$$:=</span> Fun <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main"><span class="free">⊢</span></span> Lam <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">:</span></span> Fun <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Rec <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Lam <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">)</span> <span class="main"><span class="free">:</span></span> Fun <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
  j_Inj1<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Inj1 <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> Sum <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
  j_Inj2<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Inj2 <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> Sum <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
  j_Case<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> Sum <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">:</span></span> Fun <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> Fun <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Case <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span> <span class="main">|</span>
  j_Pair<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Pair <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> Prod <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
  j_Prj1<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> Prod <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Prj1 <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span>"</span></span> <span class="main">|</span>
  j_Prj2<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> Prod <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Prj2 <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
  j_Roll<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span> atom <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">♯</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> subst_type <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">(</span>Mu <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Roll <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> Mu <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span> <span class="main">|</span>
  j_Unroll<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> atom <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">♯</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> Mu <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Unroll <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> subst_type <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">(</span>Mu <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span>"</span></span> <span class="main">|</span>
  j_Auth<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Auth <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> AuthT <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span> <span class="main">|</span>
  j_Unauth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> AuthT <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Unauth <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> judge.intros<span class="main">[</span><span class="operator">intro</span><span class="main">]</span>

<span class="keyword1"><span class="command">equivariance</span></span> <span class="quoted">judge</span>
<span class="keyword1"><span class="command">nominal_inductive</span></span> judge
  <span class="keyword2"><span class="keyword">avoids</span></span> j_Lam<span class="main">:</span> <span class="quoted"><span class="free">x</span></span>
       <span class="main">|</span> j_Rec<span class="main">:</span> <span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="free">y</span></span>
       <span class="main">|</span> j_Let<span class="main">:</span> <span class="quoted"><span class="free">x</span></span>
       <span class="main">|</span> j_Roll<span class="main">:</span> <span class="quoted"><span class="free">α</span></span>
       <span class="main">|</span> j_Unroll<span class="main">:</span> <span class="quoted"><span class="free">α</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_subst_type fresh_Pair<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> judge_imp_judge_weak<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"erase_env <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="free">e</span> <span class="main">:</span> erase <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> erase_env_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> judge.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair fresh_fmmap_erase_fresh fmmap_fmupd<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Shallow Projection›</span></span>

<span class="keyword1"><span class="command">nominal_function</span></span> <span class="entity">shallow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> term"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⦇</span>_<span class="keyword1">⦈</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦇</span></span>Unit<span class="main"><span class="free">⦈</span></span>  <span class="main">=</span> Unit"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦇</span></span>Var <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main"><span class="free">⦈</span></span> <span class="main">=</span> Var <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦇</span></span>Lam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">⦈</span></span> <span class="main">=</span> Lam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">⦇</span></span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">⦈</span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦇</span></span>Rec <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">⦈</span></span> <span class="main">=</span> Rec <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">⦇</span></span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">⦈</span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦇</span></span>Inj1 <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">⦈</span></span> <span class="main">=</span> Inj1 <span class="main"><span class="free">⦇</span></span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">⦈</span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦇</span></span>Inj2 <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">⦈</span></span> <span class="main">=</span> Inj2 <span class="main"><span class="free">⦇</span></span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">⦈</span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦇</span></span>Pair <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="free">⦈</span></span> <span class="main">=</span> Pair <span class="main"><span class="free">⦇</span></span><span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main"><span class="free">⦈</span></span> <span class="main"><span class="free">⦇</span></span><span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="free">⦈</span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦇</span></span>Roll <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">⦈</span></span> <span class="main">=</span> Roll <span class="main"><span class="free">⦇</span></span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">⦈</span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦇</span></span>Let <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="free">⦈</span></span> <span class="main">=</span> Let <span class="main"><span class="free">⦇</span></span><span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main"><span class="free">⦈</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">⦇</span></span><span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="free">⦈</span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦇</span></span>App <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="free">⦈</span></span> <span class="main">=</span> App <span class="main"><span class="free">⦇</span></span><span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main"><span class="free">⦈</span></span> <span class="main"><span class="free">⦇</span></span><span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="free">⦈</span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦇</span></span>Case <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="free">⦈</span></span> <span class="main">=</span> Case <span class="main"><span class="free">⦇</span></span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">⦈</span></span> <span class="main"><span class="free">⦇</span></span><span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main"><span class="free">⦈</span></span> <span class="main"><span class="free">⦇</span></span><span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="free">⦈</span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦇</span></span>Prj1 <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">⦈</span></span> <span class="main">=</span> Prj1 <span class="main"><span class="free">⦇</span></span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">⦈</span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦇</span></span>Prj2 <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">⦈</span></span> <span class="main">=</span> Prj2 <span class="main"><span class="free">⦇</span></span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">⦈</span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦇</span></span>Unroll <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">⦈</span></span> <span class="main">=</span> Unroll <span class="main"><span class="free">⦇</span></span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">⦈</span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦇</span></span>Auth <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">⦈</span></span> <span class="main">=</span> Auth <span class="main"><span class="free">⦇</span></span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">⦈</span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦇</span></span>Unauth <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">⦈</span></span> <span class="main">=</span> Unauth <span class="main"><span class="free">⦇</span></span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">⦈</span></span>"</span></span> <span class="main">|</span>
  <span class="comment1">― ‹No rule is defined for Hash, but: "[..] preserving that structure in every case but that of &lt;h, v&gt; [..]"›</span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦇</span></span>Hash <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main"><span class="free">⦈</span></span> <span class="main">=</span> Hash <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦇</span></span>Hashed <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">⦈</span></span> <span class="main">=</span> Hash <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> alpha_lst<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_def shallow_graph_aux_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> shallow_graph.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_at_base<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> P a
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> term.strong_exhaust<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">a</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">P</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">a</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_star_def<span class="main">)</span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_star_def fresh_at_base<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Abs_lst1_fcb2'<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_at_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> perm_supp_eq Abs_fresh_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Abs_lst1_fcb2'<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_at_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> perm_supp_eq Abs_fresh_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> Abs_lst1_fcb2'<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqvt_at_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> perm_supp_eq Abs_fresh_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">nominal_termination</span></span> <span class="main">(</span>eqvt<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_shallow<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">e</span> <span class="main">⟹</span> atom <span class="free">x</span> <span class="main">♯</span> <span class="main">⦇</span><span class="free">e</span><span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> term.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Small-step Semantics›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> mode <span class="main">=</span> I <span class="main">|</span> P <span class="main">|</span> V <span class="comment1">― ‹Ideal, Prover and Verifier modes›</span>

<span class="keyword1"><span class="command">instantiation</span></span> mode <span class="main">::</span> <span class="quoted">pure</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">permute_mode</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"perm <span class="main">⇒</span> mode <span class="main">⇒</span> mode"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">permute_mode</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permute_mode_def<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> proofstream <span class="main">=</span> <span class="quoted"><span class="quoted">"term list"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">smallstep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"proofstream <span class="main">⇒</span> term <span class="main">⇒</span> mode <span class="main">⇒</span> proofstream <span class="main">⇒</span> term <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">≪</span>_<span class="keyword1">,</span> _<span class="keyword1">≫</span> _<span class="keyword1">→</span> <span class="keyword1">≪</span>_<span class="keyword1">,</span> _<span class="keyword1">≫</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  s_App1<span class="main">:</span>      <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub>'</span></span></span> <span class="main"><span class="free">≫</span></span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> App <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> App <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub>'</span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  s_App2<span class="main">:</span>      <span class="quoted"><span class="quoted">"<span class="main">⟦</span> value <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">;</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub>'</span></span></span> <span class="main"><span class="free">≫</span></span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> App <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> App <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub>'</span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  s_AppLam<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> value <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">;</span> atom <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">♯</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> App <span class="main">(</span>Lam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">/</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  s_AppRec<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> value <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">;</span> atom <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">♯</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> App <span class="main">(</span>Rec <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> App <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">[</span><span class="main">(</span>Rec <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">/</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  s_Let1<span class="main">:</span>      <span class="quoted"><span class="quoted">"<span class="main">⟦</span> atom <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">♯</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub>'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main">)</span><span class="main">;</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub>'</span></span></span> <span class="main"><span class="free">≫</span></span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> Let <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> Let <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub>'</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  s_Let2<span class="main">:</span>      <span class="quoted"><span class="quoted">"<span class="main">⟦</span> value <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">;</span> atom <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">♯</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> Let <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">/</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  s_Inj1<span class="main">:</span>      <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">≫</span></span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> Inj1 <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> Inj1 <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  s_Inj2<span class="main">:</span>      <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">≫</span></span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> Inj2 <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> Inj2 <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  s_Case<span class="main">:</span>      <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">≫</span></span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> Case <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> Case <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  <span class="comment1">― ‹Case rules are different from paper to account for recursive functions.›</span>
  s_CaseInj1<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> value <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> Case <span class="main">(</span>Inj1 <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> App <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  s_CaseInj2<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> value <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> Case <span class="main">(</span>Inj2 <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> App <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  s_Pair1<span class="main">:</span>     <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub>'</span></span></span> <span class="main"><span class="free">≫</span></span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> Pair <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> Pair <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub>'</span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  s_Pair2<span class="main">:</span>     <span class="quoted"><span class="quoted">"<span class="main">⟦</span> value <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">;</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub>'</span></span></span> <span class="main"><span class="free">≫</span></span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> Pair <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> Pair <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub>'</span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  s_Prj1<span class="main">:</span>      <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">≫</span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">≫</span></span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> Prj1 <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> Prj1 <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  s_Prj2<span class="main">:</span>      <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">≫</span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">≫</span></span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> Prj2 <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> Prj2 <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  s_PrjPair1<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> value <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">;</span> value <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> Prj1 <span class="main">(</span>Pair <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main"><span class="free">≫</span></span>  <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  s_PrjPair2<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> value <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">;</span> value <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> Prj2 <span class="main">(</span>Pair <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main"><span class="free">≫</span></span>  <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">v<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  s_Unroll<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">≫</span></span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> Unroll <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> Unroll <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  s_Roll<span class="main">:</span>      <span class="quoted"><span class="quoted">"<span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">≫</span></span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> Roll <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">≫</span></span>  <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> Roll <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  s_UnrollRoll<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⟦</span> value <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> Unroll <span class="main">(</span>Roll <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main"><span class="free">≫</span></span>  <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main"><span class="free">→</span></span>  <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  <span class="comment1">― ‹Mode-specific rules›</span>
  s_Auth<span class="main">:</span>      <span class="quoted"><span class="quoted">"<span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">≫</span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">≫</span></span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> Auth <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">≫</span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> Auth <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  s_Unauth<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">≫</span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">≫</span></span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> Unauth <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">≫</span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π'</span></span></span><span class="main"><span class="free">,</span></span> Unauth <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  s_AuthI<span class="main">:</span>     <span class="quoted"><span class="quoted">"<span class="main">⟦</span> value <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> Auth <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="free">≫</span></span> I<span class="main"><span class="free">→</span></span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  s_UnauthI<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span> value <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> Unauth <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="free">≫</span></span> I<span class="main"><span class="free">→</span></span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  s_AuthP<span class="main">:</span>     <span class="quoted"><span class="quoted">"<span class="main">⟦</span> closed <span class="main">⦇</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⦈</span><span class="main">;</span> value <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> Auth <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="free">≫</span></span> P<span class="main"><span class="free">→</span></span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> Hashed <span class="main">(</span>hash <span class="main">⦇</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⦈</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  s_UnauthP<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span> value <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> Unauth <span class="main">(</span>Hashed <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main"><span class="free">≫</span></span> P<span class="main"><span class="free">→</span></span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="main">⦇</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">⦈</span><span class="main">]</span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  s_AuthV<span class="main">:</span>     <span class="quoted"><span class="quoted">"<span class="main">⟦</span> closed <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">;</span> value <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> Auth <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="free">≫</span></span> V<span class="main"><span class="free">→</span></span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> Hash <span class="main">(</span>hash <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  s_UnauthV<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span> closed <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">;</span> hash <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">⟧</span>
              <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> Unauth <span class="main">(</span>Hash <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main"><span class="free">≫</span></span> V<span class="main"><span class="free">→</span></span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">s<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> smallstep.intros<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> smallstep.intros<span class="main">[</span><span class="operator">intro</span><span class="main">]</span>

<span class="keyword1"><span class="command">equivariance</span></span> <span class="quoted">smallstep</span>
<span class="keyword1"><span class="command">nominal_inductive</span></span> smallstep
  <span class="keyword2"><span class="keyword">avoids</span></span> s_AppLam<span class="main">:</span> <span class="quoted"><span class="free">x</span></span>
       <span class="main">|</span> s_AppRec<span class="main">:</span> <span class="quoted"><span class="free">x</span></span>
       <span class="main">|</span> s_Let1<span class="main">:</span>   <span class="quoted"><span class="free">x</span></span>
       <span class="main">|</span> s_Let2<span class="main">:</span>   <span class="quoted"><span class="free">x</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair fresh_subst_term<span class="main">)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">smallsteps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"proofstream <span class="main">⇒</span> term <span class="main">⇒</span> mode <span class="main">⇒</span> nat <span class="main">⇒</span> proofstream <span class="main">⇒</span> term <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">≪</span>_<span class="keyword1">,</span> _<span class="keyword1">≫</span> _<span class="keyword1">→</span>_ <span class="keyword1">≪</span>_<span class="keyword1">,</span> _<span class="keyword1">≫</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  s_Id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">≫</span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main"><span class="free">→</span></span><span class="main">0</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span> <span class="main">|</span>
  s_Tr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">≫</span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">≫</span></span><span class="main">;</span> <span class="main">≪</span> <span class="free"><span class="bound"><span class="entity">π<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">≫</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">→</span> <span class="main">≪</span> <span class="free"><span class="bound"><span class="entity">π<span class="hidden">⇩</span><sub>3</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>3</sub></span></span></span> <span class="main">≫</span> <span class="main">⟧</span>
       <span class="main">⟹</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">≫</span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">→</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main"><span class="free">≪</span></span> <span class="free"><span class="bound"><span class="entity">π<span class="hidden">⇩</span><sub>3</sub></span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>3</sub></span></span></span> <span class="main"><span class="free">≫</span></span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> smallsteps.intros<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> smallsteps.intros<span class="main">[</span><span class="operator">intro</span><span class="main">]</span>

<span class="keyword1"><span class="command">equivariance</span></span> <span class="quoted">smallsteps</span>
<span class="keyword1"><span class="command">nominal_inductive</span></span> smallsteps <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> steps_1_step<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> <span class="free">e</span> <span class="main">≫</span> <span class="free">m</span><span class="main">→</span><span class="main">1</span> <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span> <span class="main">=</span> <span class="main">≪</span> <span class="free">π</span><span class="main">,</span> <span class="free">e</span> <span class="main">≫</span> <span class="free">m</span><span class="main">→</span> <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">::</span>nat"</span></span> <span class="quoted"><span class="free">π'</span></span> <span class="quoted"><span class="free">e'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallsteps.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Tr <span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">m</span> <span class="skolem">i</span> <span class="skolem">π<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">π<span class="hidden">⇩</span><sub>3</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">π<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallsteps.induct<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> s_Tr<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Inversion rules for smallstep(s) predicates.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> value_no_step<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">v</span> <span class="main">≫</span> <span class="free">m</span><span class="main">→</span> <span class="main">≪</span> <span class="free">π<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">t</span> <span class="main">≫</span>"</span></span> <span class="quoted"><span class="quoted">"value <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"False"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">π<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">π<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallstep.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subst_term_perm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x'</span> <span class="main">♯</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span><span class="main">[</span><span class="free">v</span> <span class="main">/</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">↔</span> <span class="free">x'</span><span class="main">)</span> <span class="main">∙</span> <span class="free">e</span><span class="main">)</span><span class="main">[</span><span class="free">v</span> <span class="main">/</span> <span class="free">x'</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> alpha_lst<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">x'</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> term.strong_induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair fresh_at_base<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> permute_hash_def<span class="main">)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> s_Unit_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> Unit <span class="main">≫</span>  <span class="free">m</span><span class="main">→</span>  <span class="main">≪</span> <span class="free">π<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">v</span> <span class="main">≫</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> s_App_inv<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> App1 App2 AppLam AppRec<span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> App <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≫</span> <span class="free">m</span><span class="main">→</span> <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">e</span> <span class="main">≫</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> s_Let_inv'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> Let <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≫</span>  <span class="free">m</span><span class="main">→</span>  <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="main">(</span><span class="free">e<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="free">π</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">e<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">e'</span> <span class="main">=</span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">/</span> <span class="free">x</span><span class="main">]</span> <span class="main">∧</span> value <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">π</span> <span class="main">=</span> <span class="free">π'</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">≪</span> <span class="free">π</span><span class="main">,</span> <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≫</span>  <span class="free">m</span><span class="main">→</span>  <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">e<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">≫</span> <span class="main">∧</span> <span class="free">e'</span> <span class="main">=</span> Let <span class="free">e<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="free">x</span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="main">¬</span> value <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> alpha_lst<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="quoted">"Let <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">π'</span></span> <span class="quoted"><span class="free">e'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallstep.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair fresh_subst_term perm_supp_eq <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> Abs_lst1_fcb2'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> s_Let_inv<span class="main">[</span><span class="operator">consumes</span> 2<span class="main">,</span> <span class="operator">case_names</span> Let1 Let2<span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> Let <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">x</span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≫</span>  <span class="free">m</span><span class="main">→</span>  <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="main">(</span><span class="free">e<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="free">π</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="free">e'</span> <span class="main">=</span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">/</span> <span class="free">x</span><span class="main">]</span> <span class="main">∧</span> value <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">π</span> <span class="main">=</span> <span class="free">π'</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">e<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">.</span> <span class="main">≪</span> <span class="free">π</span><span class="main">,</span> <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≫</span>  <span class="free">m</span><span class="main">→</span>  <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="bound">e<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">≫</span> <span class="main">∧</span> <span class="free">e'</span> <span class="main">=</span> Let <span class="bound">e<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="free">x</span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="main">¬</span> value <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> s_Let_inv'<span class="main">)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> s_Case_inv<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Case Inj1 Inj2<span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> Case <span class="free">e</span> <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≫</span>  <span class="free">m</span><span class="main">→</span>  <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> s_Prj1_inv<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Prj1 PrjPair1<span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> Prj1 <span class="free">e</span> <span class="main">≫</span>  <span class="free">m</span><span class="main">→</span>  <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">v</span> <span class="main">≫</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> s_Prj2_inv<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Prj2 PrjPair2<span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> Prj2 <span class="free">e</span> <span class="main">≫</span>  <span class="free">m</span><span class="main">→</span>  <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">v</span> <span class="main">≫</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> s_Pair_inv<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Pair1 Pair2<span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> Pair <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≫</span> <span class="free">m</span><span class="main">→</span> <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> s_Inj1_inv<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Inj1<span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> Inj1 <span class="free">e</span> <span class="main">≫</span> <span class="free">m</span><span class="main">→</span> <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> s_Inj2_inv<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Inj2<span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> Inj2 <span class="free">e</span> <span class="main">≫</span> <span class="free">m</span><span class="main">→</span> <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> s_Roll_inv<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Roll<span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> Roll <span class="free">e</span> <span class="main">≫</span> <span class="free">m</span><span class="main">→</span> <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> s_Unroll_inv<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Unroll UnrollRoll<span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> Unroll <span class="free">e</span> <span class="main">≫</span>  <span class="free">m</span><span class="main">→</span>  <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> s_AuthI_inv<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Auth AuthI<span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> Auth <span class="free">e</span> <span class="main">≫</span>  I<span class="main">→</span>  <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> s_UnauthI_inv<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Unauth UnauthI<span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> Unauth <span class="free">e</span> <span class="main">≫</span>  I<span class="main">→</span>  <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> s_AuthP_inv<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Auth AuthP<span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> Auth <span class="free">e</span> <span class="main">≫</span>  P<span class="main">→</span>  <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> s_UnauthP_inv<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Unauth UnauthP<span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> Unauth <span class="free">e</span> <span class="main">≫</span>  P<span class="main">→</span>  <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> s_AuthV_inv<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Auth AuthV<span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> Auth <span class="free">e</span> <span class="main">≫</span>  V<span class="main">→</span>  <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> s_UnauthV_inv<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Unauth UnauthV<span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> Unauth <span class="free">e</span> <span class="main">≫</span>  V<span class="main">→</span>  <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> s_Id_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≫</span> <span class="free">m</span><span class="main">→</span><span class="main">0</span> <span class="main">≪</span> <span class="free">π<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≫</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> s_Tr_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≫</span> <span class="free">m</span><span class="main">→</span><span class="free">i</span> <span class="main">≪</span> <span class="free">π<span class="hidden">⇩</span><sub>3</sub></span><span class="main">,</span> <span class="free">e<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">≫</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Freshness with smallstep.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_smallstep_I<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">var</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> <span class="free">e</span> <span class="main">≫</span> I<span class="main">→</span> <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span>"</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">e'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted">I</span> <span class="quoted"><span class="free">π'</span></span> <span class="quoted"><span class="free">e'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallstep.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_subst_term<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_smallstep_P<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">var</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> <span class="free">e</span> <span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span>"</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">e'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted">P</span> <span class="quoted"><span class="free">π'</span></span> <span class="quoted"><span class="free">e'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallstep.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_subst_term<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_smallsteps_I<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">var</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> <span class="free">e</span> <span class="main">≫</span> I<span class="main">→</span><span class="free">i</span> <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span>"</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">e'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted">I</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">π'</span></span> <span class="quoted"><span class="free">e'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallsteps.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_smallstep_I<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_ps_smallstep_P<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">var</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> <span class="free">e</span> <span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span>"</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">π</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">π'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted">P</span> <span class="quoted"><span class="free">π'</span></span> <span class="quoted"><span class="free">e'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallstep.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_UnauthP <span class="skolem">v</span> <span class="skolem">π</span> <span class="skolem">h</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Cons fresh_append fresh_shallow<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proofstream lemmas.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> smallstepI_ps_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> <span class="free">e</span> <span class="main">≫</span> I<span class="main">→</span> <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">=</span> <span class="free">π'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted">I</span> <span class="quoted"><span class="free">π'</span></span> <span class="quoted"><span class="free">e'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallstep.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> smallstepI_ps_emptyD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="free">π</span><span class="main">,</span> <span class="free">e</span><span class="main">≫</span> I<span class="main">→</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">e'</span><span class="main">≫</span> <span class="main">⟹</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">e</span><span class="main">≫</span> I<span class="main">→</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">e'</span><span class="main">≫</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">e</span><span class="main">≫</span> I<span class="main">→</span> <span class="main">≪</span><span class="free">π</span><span class="main">,</span> <span class="free">e'</span><span class="main">≫</span> <span class="main">⟹</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">e</span><span class="main">≫</span> I<span class="main">→</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">e'</span><span class="main">≫</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> smallstepI_ps_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> smallstepsI_ps_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="free">π</span><span class="main">,</span> <span class="free">e</span><span class="main">≫</span> I<span class="main">→</span><span class="free">i</span> <span class="main">≪</span><span class="free">π'</span><span class="main">,</span> <span class="free">e'</span><span class="main">≫</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">=</span> <span class="free">π'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted">I</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">π'</span></span> <span class="quoted"><span class="free">e'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallsteps.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> smallstepI_ps_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smallstepsI_ps_emptyD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="free">π</span><span class="main">,</span> <span class="free">e</span><span class="main">≫</span> I<span class="main">→</span><span class="free">i</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">e'</span><span class="main">≫</span> <span class="main">⟹</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">e</span><span class="main">≫</span> I<span class="main">→</span><span class="free">i</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">e'</span><span class="main">≫</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">e</span><span class="main">≫</span> I<span class="main">→</span><span class="free">i</span> <span class="main">≪</span><span class="free">π</span><span class="main">,</span> <span class="free">e'</span><span class="main">≫</span> <span class="main">⟹</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">e</span><span class="main">≫</span> I<span class="main">→</span><span class="free">i</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">e'</span><span class="main">≫</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> smallstepsI_ps_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> smallstepV_consumes_proofstream<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">eV</span> <span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span> <span class="free">π<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">eV'</span> <span class="main">≫</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">π</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">π<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">π</span> <span class="main">@</span> <span class="free">π<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">π<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">eV</span></span> <span class="quoted">V</span> <span class="quoted"><span class="free">π<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">eV'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallstep.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> smallstepsV_consumes_proofstream<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">eV</span> <span class="main">≫</span> V<span class="main">→</span><span class="free">i</span> <span class="main">≪</span> <span class="free">π<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">eV'</span> <span class="main">≫</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">π</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">π<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">π</span> <span class="main">@</span> <span class="free">π<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">π<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">eV</span></span> <span class="quoted">V</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">π<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">eV'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallsteps.induct<span class="main">)</span>
                 <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> smallstepV_consumes_proofstream<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smallstepP_generates_proofstream<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">eP</span> <span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span> <span class="free">π<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">eP'</span> <span class="main">≫</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">π</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">π<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">π<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">π<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">eP</span></span> <span class="quoted">P</span> <span class="quoted"><span class="free">π<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">eP'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallstep.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> smallstepsP_generates_proofstream<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">eP</span> <span class="main">≫</span> P<span class="main">→</span><span class="free">i</span> <span class="main">≪</span> <span class="free">π<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">eP'</span> <span class="main">≫</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">π</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">π<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">π<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">π<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">eP</span></span> <span class="quoted">P</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">π<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="free">eP'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallsteps.induct<span class="main">)</span>
                 <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> smallstepP_generates_proofstream<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smallstepV_ps_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> <span class="free">eV</span> <span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">eV'</span> <span class="main">≫</span> <span class="main">⟷</span> <span class="main">≪</span> <span class="free">π</span> <span class="main">@</span> <span class="free">X</span><span class="main">,</span> <span class="free">eV</span> <span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span> <span class="free">π'</span> <span class="main">@</span> <span class="free">X</span><span class="main">,</span> <span class="free">eV'</span> <span class="main">≫</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="free">eV</span></span> <span class="quoted">V</span> <span class="quoted"><span class="free">π'</span></span> <span class="quoted"><span class="free">eV'</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallstep.strong_induct<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_append fresh_Pair<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">@</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="free">eV</span></span> <span class="quoted">V</span> <span class="quoted"><span class="quoted">"<span class="free">π'</span> <span class="main">@</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="free">eV'</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallstep.strong_induct<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_append fresh_Pair<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> smallstepV_ps_to_suffix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="free">π</span><span class="main">,</span> <span class="free">e</span><span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span><span class="free">π'</span> <span class="main">@</span> <span class="free">X</span><span class="main">,</span> <span class="free">e'</span><span class="main">≫</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">π''</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">=</span> <span class="free">π''</span> <span class="main">@</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted">V</span> <span class="quoted"><span class="quoted">"<span class="free">π'</span> <span class="main">@</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="free">e'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallstep.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> smallstepsV_ps_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> <span class="free">eV</span> <span class="main">≫</span> V<span class="main">→</span><span class="free">i</span> <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">eV'</span> <span class="main">≫</span> <span class="main">⟷</span> <span class="main">≪</span> <span class="free">π</span> <span class="main">@</span> <span class="free">X</span><span class="main">,</span> <span class="free">eV</span> <span class="main">≫</span> V<span class="main">→</span><span class="free">i</span> <span class="main">≪</span> <span class="free">π'</span> <span class="main">@</span> <span class="free">X</span><span class="main">,</span> <span class="free">eV'</span> <span class="main">≫</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="free">eV</span></span> <span class="quoted">V</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">π'</span></span> <span class="quoted"><span class="free">eV'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallsteps.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Tr <span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">i</span> <span class="skolem">π<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">π<span class="hidden">⇩</span><sub>3</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> smallstepV_ps_append<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">@</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="free">eV</span></span> <span class="quoted">V</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"<span class="free">π'</span> <span class="main">@</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="free">eV'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">π'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallsteps.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Tr <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">i</span> <span class="skolem">π<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> s_Tr<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">π'''</span> <span class="main">@</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> smallstepV_ps_to_suffix<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> s_Tr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> smallstepV_ps_append<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> smallstepP_ps_prepend<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> <span class="free">eP</span> <span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">eP'</span> <span class="main">≫</span> <span class="main">⟷</span> <span class="main">≪</span> <span class="free">X</span> <span class="main">@</span> <span class="free">π</span><span class="main">,</span> <span class="free">eP</span> <span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span> <span class="free">X</span> <span class="main">@</span> <span class="free">π'</span><span class="main">,</span> <span class="free">eP'</span> <span class="main">≫</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="free">eP</span></span> <span class="quoted">P</span> <span class="quoted"><span class="free">π'</span></span> <span class="quoted"><span class="free">eP'</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallstep.strong_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_UnauthP <span class="skolem">v</span> <span class="skolem">π</span> <span class="skolem">h</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> append_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">X</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">π</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[</span></span></span><span class="main"><span class="main"><span class="main">⦇</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">v</span></span></span><span class="main"><span class="main"><span class="main">⦈</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">erule</span> smallstep.s_UnauthP<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_append fresh_Pair<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">@</span> <span class="free">π</span>"</span></span> <span class="quoted"><span class="free">eP</span></span> <span class="quoted">P</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">@</span> <span class="free">π'</span>"</span></span> <span class="quoted"><span class="free">eP'</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallstep.strong_induct<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_append fresh_Pair<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> smallstepsP_ps_prepend<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> <span class="free">eP</span> <span class="main">≫</span> P<span class="main">→</span><span class="free">i</span> <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">eP'</span> <span class="main">≫</span> <span class="main">⟷</span> <span class="main">≪</span> <span class="free">X</span> <span class="main">@</span> <span class="free">π</span><span class="main">,</span> <span class="free">eP</span> <span class="main">≫</span> P<span class="main">→</span><span class="free">i</span> <span class="main">≪</span> <span class="free">X</span> <span class="main">@</span> <span class="free">π'</span><span class="main">,</span> <span class="free">eP'</span> <span class="main">≫</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="free">eP</span></span> <span class="quoted">P</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">π'</span></span> <span class="quoted"><span class="free">eP'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallsteps.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Tr <span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">i</span> <span class="skolem">π<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">π<span class="hidden">⇩</span><sub>3</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> smallstepP_ps_prepend<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">@</span> <span class="free">π</span>"</span></span> <span class="quoted"><span class="free">eP</span></span> <span class="quoted">P</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">@</span> <span class="free">π'</span>"</span></span> <span class="quoted"><span class="free">eP'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">π'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallsteps.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Tr <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">i</span> <span class="skolem">π<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π''</span></span> <span class="keyword2"><span class="keyword">where</span></span> π''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">π<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">X</span> <span class="main">@</span> <span class="free">π</span> <span class="main">@</span> <span class="skolem">π''</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> smallstepsP_generates_proofstream<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="free">π</span><span class="main">,</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span><span class="main">≫</span> P<span class="main">→</span><span class="skolem">i</span> <span class="main">≪</span><span class="free">π</span> <span class="main">@</span> <span class="skolem">π''</span><span class="main">,</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> s_Tr<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> π'' s_Tr<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> smallstepP_ps_prepend<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Type Progress›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> type_progress<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"value <span class="free">e</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">e'</span><span class="main">.</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="free">e</span> <span class="main">≫</span> I<span class="main">→</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="bound">e'</span> <span class="main">≫</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">::</span> tyenv"</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> judge_weak.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>jw_Let <span class="skolem">x</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_smallstep_I <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> s_Let2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="main">≪</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">≫</span> <span class="main">_</span><span class="main">→</span> <span class="main">≪</span><span class="main">_</span><span class="main">,</span> <span class="bound">e</span><span class="main">≫</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> s_Let1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>jw_Prj1 <span class="skolem">v</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> jw_Prod_inv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>jw_Prj2 <span class="skolem">v</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> jw_Prod_inv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>jw_App <span class="skolem">e</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> jw_Fun_inv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">e'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>jw_Case <span class="skolem">v</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> jw_Sum_inv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Weak Type Preservation›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fresh_tyenv_None<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Γ</span> <span class="main">::</span> <span class="quoted">tyenv</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">Γ</span> <span class="main">⟷</span> <span class="free">Γ</span> <span class="main">$$</span> <span class="free">x</span> <span class="main">=</span> None"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">$$</span> <span class="free">x</span> <span class="main">≠</span> None"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">$$</span> <span class="free">x</span> <span class="main">=</span> Some <span class="skolem">τ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> assm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="main">::</span> var<span class="main">.</span> atom <span class="bound">a</span> <span class="main">♯</span> <span class="free">Γ</span> <span class="main">⟶</span> <span class="free">Γ</span> <span class="main">$$</span> <span class="bound">a</span> <span class="main">=</span> Some <span class="skolem">τ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fmap_freshness_lemma_unique<span class="main">[</span><span class="operator">OF</span> exI<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">Γ</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair fresh_Some<span class="main">)</span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span> <span class="main">::</span> var<span class="main">.</span> atom <span class="bound">a</span> <span class="main">♯</span> <span class="free">Γ</span><span class="main">}</span> <span class="main">⊆</span> fmdom' <span class="free">Γ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff Ball_def fmlookup_dom'_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">a</span> <span class="main">::</span> var<span class="main">.</span> <span class="main">¬</span> atom <span class="bound">a</span> <span class="main">♯</span> <span class="free">Γ</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">a</span> <span class="main">::</span> var<span class="main">.</span> atom <span class="bound">a</span> <span class="main">∈</span> supp <span class="free">Γ</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> fresh_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>supp <span class="free">Γ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> contrapos_nn<span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff inv_f_f<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">atom</span><span class="main"><span class="main">]</span></span> inj_on_def
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"inv atom"</span></span><span class="main"><span class="main">]</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> finite_supp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">a</span> <span class="main">::</span> var<span class="main">.</span> atom <span class="bound">a</span> <span class="main">♯</span> <span class="free">Γ</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> finite_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> atom <span class="bound">a</span> <span class="main">♯</span> <span class="free">Γ</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"fmdom' <span class="free">Γ</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> fmdom'_alt_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fmupd <span class="skolem">y</span> <span class="skolem">z</span> <span class="skolem">Γ</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fresh_fmap_update<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> judge_weak_fresh_env_fresh_term<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">var</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">a</span> <span class="main">♯</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"atom <span class="free">a</span> <span class="main">♯</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> judge_weak.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>jw_Var <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_tyenv_None<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Cons fresh_fmap_update<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> judge_weak_weakening_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">y</span> <span class="main">♯</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">(</span><span class="free">y</span> <span class="main">$$:=</span> <span class="free">τ'</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">τ'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> judge_weak.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>jw_Lam <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> jw_Lam<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">τ'</span></span><span class="main">]</span> jw_Lam<span class="main">(</span>1-4<span class="main">,</span>6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_at_base fmupd_reorder_neq fresh_fmap_update<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>jw_App <span class="skolem">v</span> <span class="skolem">v'</span> <span class="skolem">Γ</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_at_base fmupd_reorder_neq fresh_fmap_update<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>jw_Let <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> jw_Let<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">τ'</span></span><span class="main">]</span> jw_Let<span class="main">(</span>8<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">τ'</span></span><span class="main">]</span> jw_Let<span class="main">(</span>1-5<span class="main">,</span>7<span class="main">,</span>9<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_at_base fmupd_reorder_neq fresh_fmap_update<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>jw_Rec <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">z</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> jw_Rec<span class="main">(</span>9<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">τ'</span></span><span class="main">]</span> jw_Rec<span class="main">(</span>1-8<span class="main">,</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_at_base fmupd_reorder_neq fresh_fmap_update fresh_Pair<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>jw_Case <span class="skolem">v</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_at_base fmupd_reorder_neq fresh_fmap_update<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>jw_Roll <span class="skolem">α</span> <span class="skolem">Γ</span> <span class="skolem">v</span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_fmap_update<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>jw_Unroll <span class="skolem">α</span> <span class="skolem">Γ</span> <span class="skolem">v</span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_fmap_update<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> judge_weak_weakening_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">y</span> <span class="main">♯</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">(</span><span class="free">y</span> <span class="main">$$:=</span> <span class="free">τ'</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">y</span> <span class="main">♯</span> <span class="free">e</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> judge_weak_fresh_env_fresh_term<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">(</span><span class="free">y</span> <span class="main">$$:=</span> <span class="free">τ'</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> judge_weak_weakening_1<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> judge_weak_weakening_env<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> fmempty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fmupd <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">Γ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_tyenv_None judge_weak_weakening_2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> value_subst_value<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"value <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"value <span class="free">e'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"value <span class="main">(</span><span class="free">e</span><span class="main">[</span><span class="free">e'</span> <span class="main">/</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">e</span></span>  <span class="quoted"><span class="free">e'</span></span>  <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subst_term.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> judge_weak_subst<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">$$:=</span> <span class="free">τ'</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="free">e'</span> <span class="main">:</span> <span class="free">τ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="free">e</span><span class="main">[</span><span class="free">e'</span> <span class="main">/</span> <span class="free">a</span><span class="main">]</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">$$:=</span> <span class="free">τ'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">e'</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> judge_weak.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>jw_Var <span class="skolem">x</span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> judge_weak_weakening_env<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>jw_Lam <span class="skolem">x</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmupd_reorder_neq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>jw_Rec <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmupd_reorder_neq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>jw_Let <span class="skolem">x</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmupd_reorder_neq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> type_preservation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="free">e</span> <span class="main">≫</span> I<span class="main">→</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="free">e'</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> alpha_lst<span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main">::</span>proofstream"</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted">I</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main">::</span>proofstream"</span></span> <span class="quoted"><span class="free">e'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallstep.strong_induct<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_AppLam <span class="skolem">v</span> <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_AppRec <span class="skolem">v</span> <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> jw_App_inv jw_Rec_inv<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subst_term.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Let1 <span class="skolem">x</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s_Let1<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>7<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> s_Let1<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> jw_Let_inv <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> jw_Let_inv<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Unroll <span class="skolem">e</span> <span class="skolem">e'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span><span class="main">::</span><span class="quoted">tvar</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">α</span> <span class="main">♯</span> <span class="skolem">τ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> obtain_fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> s_Unroll <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> jw_Unroll_inv<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> α <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">α</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Roll <span class="skolem">e</span> <span class="skolem">e'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span><span class="main">::</span><span class="quoted">tvar</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">α</span> <span class="main">♯</span> <span class="skolem">τ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> obtain_fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> s_Roll <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> jw_Roll_inv<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> α <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">α</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_UnrollRoll <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span><span class="main">::</span><span class="quoted">tvar</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">α</span> <span class="main">♯</span> <span class="skolem">τ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> obtain_fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> s_UnrollRoll <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Abs1_eq<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> jw_Roll_inv<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> α <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">α</span></span><span class="main"><span class="main">]</span></span> jw_Unroll_inv<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> α <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem">α</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Corrected Lemma 1 from Miller et al.~\cite{adsg}: Weak Type Soundness›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> type_soundness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"value <span class="free">e</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">e'</span><span class="main">.</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="free">e</span> <span class="main">≫</span> I<span class="main">→</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="bound">e'</span> <span class="main">≫</span> <span class="main">∧</span> <span class="main">{$$}</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="bound">e'</span> <span class="main">:</span> <span class="free">τ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"value <span class="free">e</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">e</span><span class="main">≫</span> I<span class="main">→</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">e'</span><span class="main">≫</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> type_progress<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> type_preservation<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Agreement">
<div class="head">
<h1>Theory Agreement</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Matthias Brun,   ETH Zürich, 2019 *)</span>
<span class="comment1">(* Author: Dmitriy Traytel, ETH Zürich, 2019 *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Agreement Relation›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Agreement
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Semantics.html">Semantics</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">agree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tyenv <span class="main">⇒</span> term <span class="main">⇒</span> term <span class="main">⇒</span> term <span class="main">⇒</span> ty <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _<span class="keyword1">,</span> _<span class="keyword1">,</span> _ <span class="keyword1">:</span> _"</span> <span class="main">[</span>150<span class="main">,</span>0<span class="main">,</span>0<span class="main">,</span>0<span class="main">,</span>150<span class="main">]</span> 149<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  a_Unit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Unit<span class="main"><span class="free">,</span></span> Unit<span class="main"><span class="free">,</span></span> Unit <span class="main"><span class="free">:</span></span> One"</span></span> <span class="main">|</span>
  a_Var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">$$</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">τ</span></span></span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">,</span></span> Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">,</span></span> Var <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span> <span class="main">|</span>
  a_Lam<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> atom <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">♯</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">$$:=</span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eP</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eV</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Lam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">,</span></span> Lam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">eP</span></span></span><span class="main"><span class="free">,</span></span> Lam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">eV</span></span></span> <span class="main"><span class="free">:</span></span> Fun <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
  a_App<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eP<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eV<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">:</span></span> Fun <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eP<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eV<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> App <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="free">,</span></span> App <span class="free"><span class="bound"><span class="entity">eP<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">eP<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="free">,</span></span> App <span class="free"><span class="bound"><span class="entity">eV<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">eV<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
  a_Let<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> atom <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">♯</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">eP<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">eV<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eP<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eV<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">$$:=</span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eP<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eV<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Let <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="free">,</span></span> Let <span class="free"><span class="bound"><span class="entity">eP<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">eP<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="free">,</span></span> Let <span class="free"><span class="bound"><span class="entity">eV<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">eV<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
  a_Rec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> atom <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">♯</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">;</span> atom <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">♯</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">$$:=</span> Fun <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main"><span class="free">⊢</span></span> Lam <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">,</span></span> Lam <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">eP</span></span></span><span class="main"><span class="free">,</span></span> Lam <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">eV</span></span></span> <span class="main"><span class="free">:</span></span> Fun <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Rec <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Lam <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main"><span class="free">,</span></span> Rec <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Lam <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">eP</span></span></span><span class="main">)</span><span class="main"><span class="free">,</span></span> Rec <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Lam <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">eV</span></span></span><span class="main">)</span> <span class="main"><span class="free">:</span></span> Fun <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
  a_Inj1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eP</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eV</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Inj1 <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">,</span></span> Inj1 <span class="free"><span class="bound"><span class="entity">eP</span></span></span><span class="main"><span class="free">,</span></span> Inj1 <span class="free"><span class="bound"><span class="entity">eV</span></span></span> <span class="main"><span class="free">:</span></span> Sum <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
  a_Inj2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eP</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eV</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Inj2 <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">,</span></span> Inj2 <span class="free"><span class="bound"><span class="entity">eP</span></span></span><span class="main"><span class="free">,</span></span> Inj2 <span class="free"><span class="bound"><span class="entity">eV</span></span></span> <span class="main"><span class="free">:</span></span> Sum <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
  a_Case<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eP</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eV</span></span></span> <span class="main"><span class="free">:</span></span> Sum <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eP<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eV<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">:</span></span> Fun <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eP<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eV<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> Fun <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Case <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="free">,</span></span> Case <span class="free"><span class="bound"><span class="entity">eP</span></span></span> <span class="free"><span class="bound"><span class="entity">eP<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">eP<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="free">,</span></span> Case <span class="free"><span class="bound"><span class="entity">eV</span></span></span> <span class="free"><span class="bound"><span class="entity">eV<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">eV<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span> <span class="main">|</span>
  a_Pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eP<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eV<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eP<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eV<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Pair <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="free">,</span></span> Pair <span class="free"><span class="bound"><span class="entity">eP<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">eP<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="free">,</span></span> Pair <span class="free"><span class="bound"><span class="entity">eV<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">eV<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main"><span class="free">:</span></span> Prod <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
  a_Prj1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eP</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eV</span></span></span> <span class="main"><span class="free">:</span></span> Prod <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Prj1 <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">,</span></span> Prj1 <span class="free"><span class="bound"><span class="entity">eP</span></span></span><span class="main"><span class="free">,</span></span> Prj1 <span class="free"><span class="bound"><span class="entity">eV</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span>"</span></span> <span class="main">|</span>
  a_Prj2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eP</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eV</span></span></span> <span class="main"><span class="free">:</span></span> Prod <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Prj2 <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">,</span></span> Prj2 <span class="free"><span class="bound"><span class="entity">eP</span></span></span><span class="main"><span class="free">,</span></span> Prj2 <span class="free"><span class="bound"><span class="entity">eV</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
  a_Roll<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> atom <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">♯</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eP</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eV</span></span></span> <span class="main"><span class="free">:</span></span> subst_type <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">(</span>Mu <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Roll <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">,</span></span> Roll <span class="free"><span class="bound"><span class="entity">eP</span></span></span><span class="main"><span class="free">,</span></span> Roll <span class="free"><span class="bound"><span class="entity">eV</span></span></span> <span class="main"><span class="free">:</span></span> Mu <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span> <span class="main">|</span>
  a_Unroll<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> atom <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">♯</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eP</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eV</span></span></span> <span class="main"><span class="free">:</span></span> Mu <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Unroll <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">,</span></span> Unroll <span class="free"><span class="bound"><span class="entity">eP</span></span></span><span class="main"><span class="free">,</span></span> Unroll <span class="free"><span class="bound"><span class="entity">eV</span></span></span> <span class="main"><span class="free">:</span></span> subst_type <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">(</span>Mu <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span>"</span></span> <span class="main">|</span>
  a_Auth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eP</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eV</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Auth <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">,</span></span> Auth <span class="free"><span class="bound"><span class="entity">eP</span></span></span><span class="main"><span class="free">,</span></span> Auth <span class="free"><span class="bound"><span class="entity">eV</span></span></span> <span class="main"><span class="free">:</span></span> AuthT <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span> <span class="main">|</span>
  a_Unauth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eP</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">eV</span></span></span> <span class="main"><span class="free">:</span></span> AuthT <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Unauth <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">,</span></span> Unauth <span class="free"><span class="bound"><span class="entity">eP</span></span></span><span class="main"><span class="free">,</span></span> Unauth <span class="free"><span class="bound"><span class="entity">eV</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span> <span class="main">|</span>
  a_HashI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">{$$}</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">vP</span></span></span><span class="main"><span class="free">,</span></span> <span class="main">⦇</span><span class="free"><span class="bound"><span class="entity">vP</span></span></span><span class="main">⦈</span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">;</span> hash <span class="main">⦇</span><span class="free"><span class="bound"><span class="entity">vP</span></span></span><span class="main">⦈</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">;</span> value <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">;</span> value <span class="free"><span class="bound"><span class="entity">vP</span></span></span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main"><span class="free">,</span></span> Hashed <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">vP</span></span></span><span class="main"><span class="free">,</span></span> Hash <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main"><span class="free">:</span></span> AuthT <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> agree.intros<span class="main">[</span><span class="operator">intro</span><span class="main">]</span>

<span class="keyword1"><span class="command">equivariance</span></span> <span class="quoted">agree</span>
<span class="keyword1"><span class="command">nominal_inductive</span></span> agree
  <span class="keyword2"><span class="keyword">avoids</span></span> a_Lam<span class="main">:</span> <span class="quoted"><span class="free">x</span></span>
       <span class="main">|</span> a_Rec<span class="main">:</span> <span class="quoted"><span class="free">x</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="free">y</span></span>
       <span class="main">|</span> a_Let<span class="main">:</span> <span class="quoted"><span class="free">x</span></span>
       <span class="main">|</span> a_Roll<span class="main">:</span> <span class="quoted"><span class="free">α</span></span>
       <span class="main">|</span> a_Unroll<span class="main">:</span> <span class="quoted"><span class="free">α</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair fresh_subst_type<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Abs_lst_eq_3tuple<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">x'</span> <span class="main">::</span> <span class="quoted">var</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span> <span class="free">eP</span> <span class="free">eV</span> <span class="free">e'</span> <span class="free">eP'</span> <span class="free">eV'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[</span>atom <span class="free">x</span><span class="main">]</span><span class="keyword1">]lst.</span> <span class="free">e</span> <span class="main">=</span> <span class="main">[</span><span class="main">[</span>atom <span class="free">x'</span><span class="main">]</span><span class="keyword1">]lst.</span> <span class="free">e'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[</span>atom <span class="free">x</span><span class="main">]</span><span class="keyword1">]lst.</span> <span class="free">eP</span> <span class="main">=</span> <span class="main">[</span><span class="main">[</span>atom <span class="free">x'</span><span class="main">]</span><span class="keyword1">]lst.</span> <span class="free">eP'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[</span>atom <span class="free">x</span><span class="main">]</span><span class="keyword1">]lst.</span> <span class="free">eV</span> <span class="main">=</span> <span class="main">[</span><span class="main">[</span>atom <span class="free">x'</span><span class="main">]</span><span class="keyword1">]lst.</span> <span class="free">eV'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[</span>atom <span class="free">x</span><span class="main">]</span><span class="keyword1">]lst.</span> <span class="main">(</span><span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">[</span>atom <span class="free">x'</span><span class="main">]</span><span class="keyword1">]lst.</span> <span class="main">(</span><span class="free">e'</span><span class="main">,</span> <span class="free">eP'</span><span class="main">,</span> <span class="free">eV'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Pair<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> agree_fresh_env_fresh_term<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">var</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">a</span> <span class="main">♯</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"atom <span class="free">a</span> <span class="main">♯</span> <span class="main">(</span><span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">eP</span></span> <span class="quoted"><span class="free">eV</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> agree.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Var <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_tyenv_None<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Cons fresh_fmap_update fresh_Pair<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> agree_empty_fresh<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">var</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">{</span>atom <span class="free">a</span><span class="main">}</span> <span class="main">♯*</span> <span class="main">{</span><span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> agree_fresh_env_fresh_term<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Inversion rules for agreement.›</span></span>

<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> alpha_lst<span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> a_Lam_inv_I<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span>Lam <span class="free">x</span> <span class="free">e'</span><span class="main">)</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> <span class="main">(</span>Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">eP'</span> <span class="free">eV'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">eP</span> <span class="main">=</span> Lam <span class="free">x</span> <span class="free">eP'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">eV</span> <span class="main">=</span> Lam <span class="free">x</span> <span class="free">eV'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">(</span><span class="free">x</span> <span class="main">$$:=</span> <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">⊢</span> <span class="free">e'</span><span class="main">,</span> <span class="free">eP'</span><span class="main">,</span> <span class="free">eV'</span> <span class="main">:</span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">nominal_induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"Lam <span class="free">x</span> <span class="free">e'</span>"</span></span> <span class="quoted"><span class="free">eP</span></span> <span class="quoted"><span class="free">eV</span></span> <span class="quoted"><span class="quoted">"Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">e'</span></span> <span class="quoted"><span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> agree.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Lam <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">y</span> <span class="skolem">e'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a_Lam <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Lam <span class="skolem">x</span> <span class="skolem">eP</span> <span class="main">=</span> Lam <span class="skolem">y</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">eP</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Abs_lst_eq_flipI  <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> agree_fresh_env_fresh_term
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_fmap_update fresh_Pair<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a_Lam <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Lam <span class="skolem">x</span> <span class="skolem">eV</span> <span class="main">=</span> Lam <span class="skolem">y</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">eV</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Abs_lst_eq_flipI  <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> agree_fresh_env_fresh_term
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_fmap_update fresh_Pair<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a_Lam<span class="main">(</span>1-6<span class="main">,</span>8<span class="main">,</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">(</span><span class="skolem">y</span> <span class="main">$$:=</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">e'</span><span class="main">,</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">eP</span><span class="main">,</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">eV</span> <span class="main">:</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> perm_supp_eq Abs1_eq_iff<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> agree.eqvt<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">$$:=</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> a_Lam_inv_P<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="free">v</span><span class="main">,</span> <span class="main">(</span>Lam <span class="free">x</span> <span class="free">vP'</span><span class="main">)</span><span class="main">,</span> <span class="free">vV</span> <span class="main">:</span> <span class="main">(</span>Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">v'</span> <span class="free">vV'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> Lam <span class="free">x</span> <span class="free">v'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">vV</span> <span class="main">=</span> Lam <span class="free">x</span> <span class="free">vV'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span><span class="main">(</span><span class="free">x</span> <span class="main">$$:=</span> <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">⊢</span> <span class="free">v'</span><span class="main">,</span> <span class="free">vP'</span><span class="main">,</span> <span class="free">vV'</span> <span class="main">:</span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">nominal_induct</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span><span class="main">::</span>tyenv"</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="quoted">"Lam <span class="free">x</span> <span class="free">vP'</span>"</span></span> <span class="quoted"><span class="free">vV</span></span> <span class="quoted"><span class="quoted">"Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">vP'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> agree.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Lam <span class="skolem">x'</span> <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a_Lam <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Lam <span class="skolem">x'</span> <span class="skolem">e</span> <span class="main">=</span> Lam <span class="skolem">x</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x'</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Abs_lst_eq_flipI  <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> agree_fresh_env_fresh_term
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_fmap_update fresh_Pair<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a_Lam <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Lam <span class="skolem">x'</span> <span class="skolem">eV</span> <span class="main">=</span> Lam <span class="skolem">x</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x'</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">eV</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Abs_lst_eq_flipI  <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> agree_fresh_env_fresh_term
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_fmap_update fresh_Pair<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a_Lam<span class="main">(</span>1-4<span class="main">,</span>6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span><span class="main">(</span><span class="skolem">x</span> <span class="main">$$:=</span> <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">x'</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">vP'</span><span class="main">,</span> <span class="main">(</span><span class="skolem">x'</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">eV</span> <span class="main">:</span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> perm_supp_eq Abs1_eq_iff<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> agree.eqvt<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x'</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span><span class="main">(</span><span class="skolem">x'</span> <span class="main">$$:=</span> <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> a_Lam_inv_V<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="free">v</span><span class="main">,</span> <span class="free">vP</span><span class="main">,</span> <span class="main">(</span>Lam <span class="free">x</span> <span class="free">vV'</span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span>Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">v'</span> <span class="free">vP'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> Lam <span class="free">x</span> <span class="free">v'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">vP</span> <span class="main">=</span> Lam <span class="free">x</span> <span class="free">vP'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span><span class="main">(</span><span class="free">x</span> <span class="main">$$:=</span> <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">⊢</span> <span class="free">v'</span><span class="main">,</span> <span class="free">vP'</span><span class="main">,</span> <span class="free">vV'</span> <span class="main">:</span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">nominal_induct</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span><span class="main">::</span>tyenv"</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">vP</span></span> <span class="quoted"><span class="quoted">"Lam <span class="free">x</span> <span class="free">vV'</span>"</span></span> <span class="quoted"><span class="quoted">"Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">vV'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> agree.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Lam <span class="skolem">x'</span> <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a_Lam <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Lam <span class="skolem">x'</span> <span class="skolem">e</span> <span class="main">=</span> Lam <span class="skolem">x</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x'</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Abs_lst_eq_flipI  <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> agree_fresh_env_fresh_term
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_fmap_update fresh_Pair<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a_Lam <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Lam <span class="skolem">x'</span> <span class="skolem">eP</span> <span class="main">=</span> Lam <span class="skolem">x</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x'</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">eP</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Abs_lst_eq_flipI  <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> agree_fresh_env_fresh_term
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_fmap_update fresh_Pair<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a_Lam<span class="main">(</span>1-4<span class="main">,</span>6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span><span class="main">(</span><span class="skolem">x</span> <span class="main">$$:=</span> <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">x'</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">e</span><span class="main">,</span> <span class="main">(</span><span class="skolem">x'</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">eP</span><span class="main">,</span> <span class="skolem">vV'</span> <span class="main">:</span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> perm_supp_eq Abs1_eq_iff<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> agree.eqvt<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x'</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span><span class="main">(</span><span class="skolem">x'</span> <span class="main">$$:=</span> <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> a_Rec_inv_I<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> Rec <span class="free">x</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="free">e'</span> <span class="free">eP'</span> <span class="free">eV'</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> Lam <span class="free">y</span> <span class="free">e'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">eP</span> <span class="main">=</span> Rec <span class="free">x</span> <span class="main">(</span>Lam <span class="free">y</span> <span class="free">eP'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">eV</span> <span class="main">=</span> Rec <span class="free">x</span> <span class="main">(</span>Lam <span class="free">y</span> <span class="free">eV'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">y</span> <span class="main">♯</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span><span class="free">x</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">(</span><span class="free">x</span> <span class="main">$$:=</span> Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⊢</span> Lam <span class="free">y</span> <span class="free">e'</span><span class="main">,</span> Lam <span class="free">y</span> <span class="free">eP'</span><span class="main">,</span> Lam <span class="free">y</span> <span class="free">eV'</span> <span class="main">:</span> Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">nominal_induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"Rec <span class="free">x</span> <span class="free">e</span>"</span></span> <span class="quoted"><span class="free">eP</span></span> <span class="quoted"><span class="free">eV</span></span> <span class="quoted"><span class="quoted">"Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> agree.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Rec <span class="skolem">x'</span> <span class="skolem">Γ</span> <span class="skolem">y</span> <span class="skolem">e'</span> <span class="skolem">eP</span> <span class="skolem">eV</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="skolem">e</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">x'</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> term.strong_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Unit
    <span class="keyword1"><span class="command">from</span></span> Unit<span class="main">(</span>9<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Var<span class="main">(</span>9<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Lam <span class="skolem">z</span> <span class="skolem">ee</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Lam<span class="main">(</span>1-3<span class="main">,</span>5-13<span class="main">,</span>15<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Lam <span class="skolem">z</span> <span class="skolem">ee</span> <span class="main">=</span> Lam <span class="skolem">y</span> <span class="main">(</span><span class="main">(</span><span class="skolem">z</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">ee</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Abs_lst_eq_flipI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_fmap_update fresh_Pair<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Lam<span class="main">(</span>1-3<span class="main">,</span>5-13<span class="main">,</span>15<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Rec <span class="skolem">x'</span> <span class="main">(</span>Lam <span class="skolem">y</span> <span class="skolem">eP</span><span class="main">)</span> <span class="main">=</span> Rec <span class="skolem">x</span> <span class="main">(</span>Lam <span class="skolem">y</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x'</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">eP</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Abs_lst_eq_flipI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"Lam <span class="skolem">y</span> <span class="skolem">eP</span>"</span></span> <span class="quoted"><span class="skolem">x'</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> agree_fresh_env_fresh_term<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">elim_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_fmap_update fresh_Pair<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Lam<span class="main">(</span>1-3<span class="main">,</span>5-13<span class="main">,</span>15<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Rec <span class="skolem">x'</span> <span class="main">(</span>Lam <span class="skolem">y</span> <span class="skolem">eV</span><span class="main">)</span> <span class="main">=</span> Rec <span class="skolem">x</span> <span class="main">(</span>Lam <span class="skolem">y</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x'</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">eV</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Abs_lst_eq_flipI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"Lam <span class="skolem">y</span> <span class="skolem">eV</span>"</span></span> <span class="quoted"><span class="skolem">x'</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> agree_fresh_env_fresh_term<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">elim_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_fmap_update fresh_Pair<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Lam<span class="main">(</span>7<span class="main">,</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">y</span> <span class="main">♯</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> Lam<span class="main">(</span>1-3<span class="main">,</span>5-11<span class="main">,</span>13<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x'</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">e'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">ee</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff flip_commute swap_permute_swap fresh_perm fresh_at_base<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Lam<span class="main">(</span>1-2<span class="main">,</span>7<span class="main">,</span>9<span class="main">,</span>11-12<span class="main">,</span>15<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">$$:=</span> Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⊢</span>
        Lam <span class="skolem">y</span> <span class="main">(</span><span class="main">(</span><span class="skolem">z</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">ee</span><span class="main">)</span><span class="main">,</span> Lam <span class="skolem">y</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x'</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">eP</span><span class="main">)</span><span class="main">,</span> Lam <span class="skolem">y</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x'</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">eV</span><span class="main">)</span> <span class="main">:</span> Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> agree.eqvt<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Lam <span class="skolem"><span class="skolem"><span class="skolem">y</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e'</span></span></span>"</span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">x'</span></span></span> <span class="main"><span class="main"><span class="main">↔</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">elim_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  perm_supp_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rec <span class="skolem">x1</span> <span class="skolem">x2a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Rec<span class="main">(</span>13<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inj1 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Inj1<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inj2 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Inj2<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">x1</span> <span class="skolem">x2a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Pair<span class="main">(</span>11<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Roll <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Roll<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">x1</span> <span class="skolem">x2a</span> <span class="skolem">x3</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Let<span class="main">(</span>14<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">x1</span> <span class="skolem">x2a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> App<span class="main">(</span>11<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Case <span class="skolem">x1</span> <span class="skolem">x2a</span> <span class="skolem">x3</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Case<span class="main">(</span>12<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prj1 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Prj1<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prj2 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Prj2<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Unroll <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Unroll<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Auth <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Auth<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Unauth <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Unauth<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hash <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Hash<span class="main">(</span>9<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hashed <span class="skolem">x1</span> <span class="skolem">x2a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Hashed<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> a_Rec_inv_P<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> Rec <span class="free">x</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="free">e'</span> <span class="free">eP'</span> <span class="free">eV'</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> Rec <span class="free">x</span> <span class="main">(</span>Lam <span class="free">y</span> <span class="free">e'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">eP</span> <span class="main">=</span> Lam <span class="free">y</span> <span class="free">eP'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">eV</span> <span class="main">=</span> Rec <span class="free">x</span> <span class="main">(</span>Lam <span class="free">y</span> <span class="free">eV'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">y</span> <span class="main">♯</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span><span class="free">x</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">(</span><span class="free">x</span> <span class="main">$$:=</span> Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⊢</span> Lam <span class="free">y</span> <span class="free">e'</span><span class="main">,</span> Lam <span class="free">y</span> <span class="free">eP'</span><span class="main">,</span> Lam <span class="free">y</span> <span class="free">eV'</span> <span class="main">:</span> Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="quoted">"Rec <span class="free">x</span> <span class="free">eP</span>"</span></span> <span class="quoted"><span class="free">eV</span></span> <span class="quoted"><span class="quoted">"Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">eP</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> agree.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Rec <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">y</span> <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">x'</span> <span class="skolem">eP'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="skolem">eP'</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">x'</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> term.strong_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Unit
    <span class="keyword1"><span class="command">from</span></span> Unit<span class="main">(</span>9<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Var<span class="main">(</span>9<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Lam <span class="skolem">ya</span> <span class="skolem">eP'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Lam<span class="main">(</span>1-3<span class="main">,</span>5-13<span class="main">,</span>15<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Rec <span class="skolem">x</span> <span class="main">(</span>Lam <span class="skolem">y</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> Rec <span class="skolem">x'</span> <span class="main">(</span>Lam <span class="skolem">y</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Abs_lst_eq_flipI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x'</span></span> <span class="quoted"><span class="quoted">"Lam <span class="skolem">y</span> <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> agree_fresh_env_fresh_term<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x'</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">elim_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_fmap_update fresh_Pair<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Lam<span class="main">(</span>1-3<span class="main">,</span>5-13<span class="main">,</span>15<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Lam <span class="skolem">ya</span> <span class="skolem">eP'</span> <span class="main">=</span> Lam <span class="skolem">y</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">eP</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> trans<span class="main">[</span><span class="operator">OF</span> eq_sym_conv Abs1_eq_iff<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flip_commute fresh_at_base<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Lam<span class="main">(</span>1-3<span class="main">,</span>5-13<span class="main">,</span>15<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Rec <span class="skolem">x</span> <span class="main">(</span>Lam <span class="skolem">y</span> <span class="skolem">eV</span><span class="main">)</span> <span class="main">=</span> Rec <span class="skolem">x'</span> <span class="main">(</span>Lam <span class="skolem">y</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">eV</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Abs_lst_eq_flipI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x'</span></span> <span class="quoted"><span class="quoted">"Lam <span class="skolem">y</span> <span class="skolem">eV</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> agree_fresh_env_fresh_term<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x'</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">elim_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_fmap_update fresh_Pair<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Lam<span class="main">(</span>7<span class="main">,</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">y</span> <span class="main">♯</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">x'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> Lam<span class="main">(</span>1-2<span class="main">,</span>7<span class="main">,</span>9<span class="main">,</span>11-12<span class="main">,</span>15<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x'</span> <span class="main">$$:=</span> Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⊢</span>
        Lam <span class="skolem">y</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">e</span><span class="main">)</span><span class="main">,</span> Lam <span class="skolem">y</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">eP</span><span class="main">)</span><span class="main">,</span> Lam <span class="skolem">y</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">eV</span><span class="main">)</span> <span class="main">:</span> Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> agree.eqvt<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Lam <span class="skolem"><span class="skolem"><span class="skolem">y</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span>"</span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">x'</span></span></span> <span class="main"><span class="main"><span class="main">↔</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">elim_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  perm_supp_eq flip_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rec <span class="skolem">x1</span> <span class="skolem">x2a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Rec<span class="main">(</span>13<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inj1 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Inj1<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inj2 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Inj2<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">x1</span> <span class="skolem">x2a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Pair<span class="main">(</span>11<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Roll <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Roll<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">x1</span> <span class="skolem">x2a</span> <span class="skolem">x3</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Let<span class="main">(</span>14<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">x1</span> <span class="skolem">x2a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> App<span class="main">(</span>11<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Case <span class="skolem">x1</span> <span class="skolem">x2a</span> <span class="skolem">x3</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Case<span class="main">(</span>12<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prj1 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Prj1<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prj2 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Prj2<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Unroll <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Unroll<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Auth <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Auth<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Unauth <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Unauth<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hash <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Hash<span class="main">(</span>9<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hashed <span class="skolem">x1</span> <span class="skolem">x2a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Hashed<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> a_Rec_inv_V<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> Rec <span class="free">x</span> <span class="free">eV</span> <span class="main">:</span> Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"atom <span class="free">x</span> <span class="main">♯</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="free">e'</span> <span class="free">eP'</span> <span class="free">eV'</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> Rec <span class="free">x</span> <span class="main">(</span>Lam <span class="free">y</span> <span class="free">e'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">eP</span> <span class="main">=</span> Rec <span class="free">x</span> <span class="main">(</span>Lam <span class="free">y</span> <span class="free">eP'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">eV</span> <span class="main">=</span> Lam <span class="free">y</span> <span class="free">eV'</span>"</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">y</span> <span class="main">♯</span> <span class="main">(</span><span class="free">Γ</span><span class="main">,</span><span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">(</span><span class="free">x</span> <span class="main">$$:=</span> Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⊢</span> Lam <span class="free">y</span> <span class="free">e'</span><span class="main">,</span> Lam <span class="free">y</span> <span class="free">eP'</span><span class="main">,</span> Lam <span class="free">y</span> <span class="free">eV'</span> <span class="main">:</span> Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">nominal_induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">eP</span></span> <span class="quoted"><span class="quoted">"Rec <span class="free">x</span> <span class="free">eV</span>"</span></span> <span class="quoted"><span class="quoted">"Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">eV</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> agree.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Rec <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">y</span> <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">x'</span> <span class="skolem">eV'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="skolem">eV'</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">x'</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> term.strong_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Unit
    <span class="keyword1"><span class="command">from</span></span> Unit<span class="main">(</span>9<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Var<span class="main">(</span>9<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Lam <span class="skolem">ya</span> <span class="skolem">eV'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Lam<span class="main">(</span>1-3<span class="main">,</span>5-13<span class="main">,</span>15<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Rec <span class="skolem">x</span> <span class="main">(</span>Lam <span class="skolem">y</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> Rec <span class="skolem">x'</span> <span class="main">(</span>Lam <span class="skolem">y</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Abs_lst_eq_flipI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x'</span></span> <span class="quoted"><span class="quoted">"Lam <span class="skolem">y</span> <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> agree_fresh_env_fresh_term<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x'</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">elim_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_fmap_update fresh_Pair<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Lam<span class="main">(</span>1-3<span class="main">,</span>5-13<span class="main">,</span>15<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Lam <span class="skolem">ya</span> <span class="skolem">eV'</span> <span class="main">=</span> Lam <span class="skolem">y</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">eV</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> trans<span class="main">[</span><span class="operator">OF</span> eq_sym_conv Abs1_eq_iff<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flip_commute fresh_at_base<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Lam<span class="main">(</span>1-3<span class="main">,</span>5-13<span class="main">,</span>15<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Rec <span class="skolem">x</span> <span class="main">(</span>Lam <span class="skolem">y</span> <span class="skolem">eP</span><span class="main">)</span> <span class="main">=</span> Rec <span class="skolem">x'</span> <span class="main">(</span>Lam <span class="skolem">y</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">eP</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Abs_lst_eq_flipI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x'</span></span> <span class="quoted"><span class="quoted">"Lam <span class="skolem">y</span> <span class="skolem">eP</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> agree_fresh_env_fresh_term<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x'</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">elim_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_fmap_update fresh_Pair<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Lam<span class="main">(</span>7<span class="main">,</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">y</span> <span class="main">♯</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">,</span> <span class="skolem">x'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> Lam<span class="main">(</span>1-2<span class="main">,</span>7<span class="main">,</span>9<span class="main">,</span>11-12<span class="main">,</span>15<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x'</span> <span class="main">$$:=</span> Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⊢</span>
        Lam <span class="skolem">y</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">e</span><span class="main">)</span><span class="main">,</span> Lam <span class="skolem">y</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">eP</span><span class="main">)</span><span class="main">,</span> Lam <span class="skolem">y</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">x'</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">eV</span><span class="main">)</span> <span class="main">:</span> Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> agree.eqvt<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Lam <span class="skolem"><span class="skolem"><span class="skolem">y</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span>"</span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">x'</span></span></span> <span class="main"><span class="main"><span class="main">↔</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">elim_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  perm_supp_eq flip_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rec <span class="skolem">x1</span> <span class="skolem">x2a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Rec<span class="main">(</span>13<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inj1 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Inj1<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inj2 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Inj2<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">x1</span> <span class="skolem">x2a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Pair<span class="main">(</span>11<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Roll <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Roll<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">x1</span> <span class="skolem">x2a</span> <span class="skolem">x3</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Let<span class="main">(</span>14<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">x1</span> <span class="skolem">x2a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> App<span class="main">(</span>11<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Case <span class="skolem">x1</span> <span class="skolem">x2a</span> <span class="skolem">x3</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Case<span class="main">(</span>12<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prj1 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Prj1<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prj2 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Prj2<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Unroll <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Unroll<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Auth <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Auth<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Unauth <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Unauth<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hash <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Hash<span class="main">(</span>9<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hashed <span class="skolem">x1</span> <span class="skolem">x2a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Hashed<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> a_Inj1_inv_I<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> Inj1 <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> Sum <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> a_Inj1_inv_P<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> Inj1 <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> Sum <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> a_Inj1_inv_V<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> Inj1 <span class="free">eV</span> <span class="main">:</span> Sum <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> a_Inj2_inv_I<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> Inj2 <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> Sum <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> a_Inj2_inv_P<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> Inj2 <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> Sum <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> a_Inj2_inv_V<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> Inj2 <span class="free">eV</span> <span class="main">:</span> Sum <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> a_Pair_inv_I<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> Pair <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> Prod <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> a_Pair_inv_P<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> Pair <span class="free">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> Prod <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> a_Roll_inv_I<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> Roll <span class="free">e'</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> Mu <span class="free">α</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">eP'</span> <span class="free">eV'</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">eP</span> <span class="main">=</span> Roll <span class="free">eP'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">eV</span> <span class="main">=</span> Roll <span class="free">eV'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e'</span><span class="main">,</span> <span class="free">eP'</span><span class="main">,</span> <span class="free">eV'</span> <span class="main">:</span> subst_type <span class="free">τ</span> <span class="main">(</span>Mu <span class="free">α</span> <span class="free">τ</span><span class="main">)</span> <span class="free">α</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="quoted">"Roll <span class="free">e'</span>"</span></span> <span class="quoted"><span class="free">eP</span></span> <span class="quoted"><span class="free">eV</span></span> <span class="quoted"><span class="quoted">"Mu <span class="free">α</span> <span class="free">τ</span>"</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> agree.strong_induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Abs_lst_eq_flipI subst_type_perm_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> a_Roll_inv_P<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> Roll <span class="free">eP'</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> Mu <span class="free">α</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">e'</span> <span class="free">eV'</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> Roll <span class="free">e'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">eV</span> <span class="main">=</span> Roll <span class="free">eV'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e'</span><span class="main">,</span> <span class="free">eP'</span><span class="main">,</span> <span class="free">eV'</span> <span class="main">:</span> subst_type <span class="free">τ</span> <span class="main">(</span>Mu <span class="free">α</span> <span class="free">τ</span><span class="main">)</span> <span class="free">α</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="quoted">"Roll <span class="free">eP'</span>"</span></span> <span class="quoted"><span class="free">eV</span></span> <span class="quoted"><span class="quoted">"Mu <span class="free">α</span> <span class="free">τ</span>"</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> agree.strong_induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Abs_lst_eq_flipI subst_type_perm_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> a_Roll_inv_V<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> Roll <span class="free">eV'</span> <span class="main">:</span> Mu <span class="free">α</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">e'</span> <span class="free">eP'</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> Roll <span class="free">e'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">eP</span> <span class="main">=</span> Roll <span class="free">eP'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e'</span><span class="main">,</span> <span class="free">eP'</span><span class="main">,</span> <span class="free">eV'</span> <span class="main">:</span> subst_type <span class="free">τ</span> <span class="main">(</span>Mu <span class="free">α</span> <span class="free">τ</span><span class="main">)</span> <span class="free">α</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">eP</span></span> <span class="quoted"><span class="quoted">"Roll <span class="free">eV'</span>"</span></span> <span class="quoted"><span class="quoted">"Mu <span class="free">α</span> <span class="free">τ</span>"</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> agree.strong_induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Abs_lst_eq_flipI subst_type_perm_eq<span class="main">)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> a_HashI_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">v</span><span class="main">,</span> Hashed <span class="main">(</span>hash <span class="main">⦇</span><span class="free">vP</span><span class="main">⦈</span><span class="main">)</span> <span class="free">vP</span><span class="main">,</span> Hash <span class="main">(</span>hash <span class="main">⦇</span><span class="free">vP</span><span class="main">⦈</span><span class="main">)</span> <span class="main">:</span> AuthT <span class="free">τ</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Inversion on types for agreement.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> a_AuthT_value_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="free">v</span><span class="main">,</span> <span class="free">vP</span><span class="main">,</span> <span class="free">vV</span> <span class="main">:</span> AuthT <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"value <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"value <span class="free">vP</span>"</span></span> <span class="quoted"><span class="quoted">"value <span class="free">vV</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">vP'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">vP</span> <span class="main">=</span> Hashed <span class="main">(</span>hash <span class="main">⦇</span><span class="free">vP'</span><span class="main">⦈</span><span class="main">)</span> <span class="free">vP'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">vV</span> <span class="main">=</span> Hash <span class="main">(</span>hash <span class="main">⦇</span><span class="free">vP'</span><span class="main">⦈</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"value <span class="free">vP'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span><span class="main">::</span>tyenv"</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">vP</span></span> <span class="quoted"><span class="free">vV</span></span> <span class="quoted"><span class="quoted">"AuthT <span class="free">τ</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> agree.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> a_Mu_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> Mu <span class="free">α</span> <span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> a_Sum_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> Sum <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> a_Prod_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> Prod <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> a_Fun_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> Fun <span class="free">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alpha_lst<span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> agree_weakening_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">y</span> <span class="main">♯</span> <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">y</span> <span class="main">♯</span> <span class="free">eP</span>"</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">y</span> <span class="main">♯</span> <span class="free">eV</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">(</span><span class="free">y</span> <span class="main">$$:=</span> <span class="free">τ'</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">eP</span></span> <span class="quoted"><span class="free">eV</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">τ'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> agree.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Lam <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_at_base fresh_fmap_update fmupd_reorder_neq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_App <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">vP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">vP<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">vV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">vV<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> term.fresh<span class="main">(</span>9<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Let <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_at_base fresh_Pair fresh_fmap_update fmupd_reorder_neq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_Let<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span> agree.a_Let<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Rec <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">z</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_at_base fresh_Pair fresh_fmap_update fmupd_reorder_neq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_Rec<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> agree.a_Rec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Case <span class="skolem">v</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">vP</span> <span class="skolem">vP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">vP<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">vV</span> <span class="skolem">vV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">vV<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">Γ</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_at_base<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Prj1 <span class="skolem">v</span> <span class="skolem">vP</span> <span class="skolem">vV</span> <span class="skolem">Γ</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_at_base<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Prj2 <span class="skolem">v</span> <span class="skolem">vP</span> <span class="skolem">vV</span> <span class="skolem">Γ</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_at_base<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_fmap_update<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> agree_weakening_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"atom <span class="free">y</span> <span class="main">♯</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">(</span><span class="free">y</span> <span class="main">$$:=</span> <span class="free">τ'</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>atom <span class="free">y</span><span class="main">}</span> <span class="main">♯*</span> <span class="main">{</span><span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> agree_fresh_env_fresh_term<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">(</span><span class="free">y</span> <span class="main">$$:=</span> <span class="free">τ'</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> agree_weakening_1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> agree_weakening_env<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> fmempty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fmupd <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">Γ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_tyenv_None agree_weakening_2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span></pre>
</div><div id="Results">
<div class="head">
<h1>Theory Results</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Matthias Brun,   ETH Zürich, 2019 *)</span>
<span class="comment1">(* Author: Dmitriy Traytel, ETH Zürich, 2019 *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Formalization of Miller et al.'s~\cite{adsg} Main Results›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Results
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Agreement.html">Agreement</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">lemma</span></span> judge_imp_agree<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">τ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lemma 2.1›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma2_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⦇</span><span class="free">eP</span><span class="main">⦈</span> <span class="main">=</span> <span class="free">eV</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">eP</span></span> <span class="quoted"><span class="free">eV</span></span> <span class="quoted"><span class="free">τ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs1_eq<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Counterexample to Lemma 2.2›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma2_2_false<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">var</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Γ</span> <span class="bound">e</span> <span class="bound">eP</span> <span class="bound">eV</span> <span class="bound">τ</span> <span class="bound">eP'</span> <span class="bound">eV'</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">Γ</span> <span class="main">⊢</span> <span class="bound">e</span><span class="main">,</span> <span class="bound">eP</span><span class="main">,</span> <span class="bound">eV</span> <span class="main">:</span> <span class="bound">τ</span><span class="main">;</span> <span class="bound">Γ</span> <span class="main">⊢</span> <span class="bound">e</span><span class="main">,</span> <span class="bound">eP'</span><span class="main">,</span> <span class="bound">eV'</span> <span class="main">:</span> <span class="bound">τ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">eP</span> <span class="main">=</span> <span class="bound">eP'</span> <span class="main">∧</span> <span class="bound">eV</span> <span class="main">=</span> <span class="bound">eV'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted">False</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> Prj1 <span class="main">(</span>Pair Unit Unit<span class="main">)</span><span class="main">,</span> Prj1 <span class="main">(</span>Pair Unit Unit<span class="main">)</span><span class="main">,</span> Prj1 <span class="main">(</span>Pair Unit Unit<span class="main">)</span> <span class="main">:</span> One"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> Prj1 <span class="main">(</span>Pair Unit Unit<span class="main">)</span><span class="main">,</span> Prj1 <span class="main">(</span>Pair Unit <span class="main">(</span>Hashed <span class="main">(</span>hash Unit<span class="main">)</span> Unit<span class="main">)</span><span class="main">)</span><span class="main">,</span> Prj1 <span class="main">(</span>Pair Unit <span class="main">(</span>Hash <span class="main">(</span>hash Unit<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> One"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> a1 a2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Prj1 <span class="main">(</span>Pair Unit Unit<span class="main">)</span> <span class="main">=</span> Prj1 <span class="main">(</span>Pair Unit <span class="main">(</span>Hash <span class="main">(</span>hash Unit<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> smallstep_ideal_deterministic<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">t</span><span class="main">≫</span> I<span class="main">→</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">u</span><span class="main">≫</span> <span class="main">⟹</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">t</span><span class="main">≫</span> I<span class="main">→</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">u'</span><span class="main">≫</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">=</span> <span class="free">u'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main">::</span>proofstream"</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted">I</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main">::</span>proofstream"</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallstep.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_App1 <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s_App1<span class="main">(</span>3<span class="main">)</span> value_no_step<span class="main">[</span><span class="operator">OF</span> s_App1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> s_App1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_App2 <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s_App2<span class="main">(</span>4<span class="main">)</span> value_no_step<span class="main">[</span><span class="operator">OF</span> s_App2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> value_no_step<span class="main">[</span><span class="operator">OF</span> _ s_App2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> s_App2<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_AppLam <span class="skolem">v</span> <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span>  s_AppLam<span class="main">(</span>5<span class="main">,</span>1<span class="main">,</span>3<span class="main">)</span> value_no_step<span class="main">[</span><span class="operator">OF</span> _ s_AppLam<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_App_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>AppLam <span class="skolem">y</span> <span class="skolem">e'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="main">::</span> <span class="quoted">var</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">z</span> <span class="main">♯</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">y</span><span class="main">,</span> <span class="skolem">e'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> obtain_fresh<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> AppLam s_AppLam<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ subst_term_perm<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="main"><span class="main">]</span></span></span> subst_term_perm<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> value_no_step<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_AppRec <span class="skolem">v</span> <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s_AppRec<span class="main">(</span>5<span class="main">,</span>1<span class="main">,</span>3<span class="main">)</span> value_no_step<span class="main">[</span><span class="operator">OF</span> _ s_AppRec<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_App_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>AppRec <span class="skolem">y</span> <span class="skolem">e'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="main">::</span> <span class="quoted">var</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">z</span> <span class="main">♯</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">y</span><span class="main">,</span> <span class="skolem">e'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> obtain_fresh<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> AppRec<span class="main">(</span>1-4<span class="main">)</span> AppRec<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">simplified</span><span class="main">]</span> s_AppRec<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair AppRec<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ subst_term_perm<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">z</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> subst_term_perm<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">z</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> AppRec<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> value_no_step<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Let1 <span class="skolem">x</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s_Let1<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">,</span>8<span class="main">)</span> value_no_step<span class="main">[</span><span class="operator">OF</span> s_Let1<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> s_Let1<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Let2 <span class="skolem">v</span> <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s_Let2<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>5<span class="main">)</span> value_no_step<span class="main">[</span><span class="operator">OF</span> _ s_Let2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Inj1 <span class="skolem">e</span> <span class="skolem">e'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s_Inj1<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Inj2 <span class="skolem">e</span> <span class="skolem">e'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s_Inj2<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Case <span class="skolem">e</span> <span class="skolem">e'</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s_Case<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> value_no_step<span class="main">[</span><span class="operator">OF</span> s_Case<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Pair1 <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s_Pair1<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> value_no_step<span class="main">[</span><span class="operator">OF</span> s_Pair1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Pair2 <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s_Pair2<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> value_no_step<span class="main">[</span><span class="operator">OF</span> _ s_Pair2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> value_no_step<span class="main">[</span><span class="operator">OF</span> s_Pair2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Prj1 <span class="skolem">e</span> <span class="skolem">e'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s_Prj1<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> value_no_step<span class="main">[</span><span class="operator">OF</span> s_Prj1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Prj2 <span class="skolem">e</span> <span class="skolem">e'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s_Prj2<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> value_no_step<span class="main">[</span><span class="operator">OF</span> s_Prj2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Unroll <span class="skolem">e</span> <span class="skolem">e'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s_Unroll<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> value_no_step<span class="main">[</span><span class="operator">OF</span> s_Unroll<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Roll <span class="skolem">e</span> <span class="skolem">e'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s_Roll<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Auth <span class="skolem">e</span> <span class="skolem">e'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s_Auth<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> value_no_step<span class="main">[</span><span class="operator">OF</span> s_Auth<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Unauth <span class="skolem">e</span> <span class="skolem">e'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s_Unauth<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> value_no_step<span class="main">[</span><span class="operator">OF</span> s_Unauth<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> value_no_step<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smallsteps_ideal_deterministic<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">t</span><span class="main">≫</span> I<span class="main">→</span><span class="free">i</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">u</span><span class="main">≫</span> <span class="main">⟹</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">t</span><span class="main">≫</span> I<span class="main">→</span><span class="free">i</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">u'</span><span class="main">≫</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">=</span> <span class="free">u'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main">::</span>proofstream"</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted">I</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main">::</span>proofstream"</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallsteps.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Tr <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">i</span> <span class="skolem">π<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s_Tr<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallsteps.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> _<span class="main">:</span> <span class="main">(</span>s_Tr <span class="skolem">i</span> <span class="skolem">π<span class="hidden">⇩</span><sub>4</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>4</sub></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> s_Tr<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> s_Tr<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">e<span class="hidden">⇩</span><sub>4</sub></span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> smallstepsI_ps_emptyD<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">π<span class="hidden">⇩</span><sub>4</sub></span></span> <span class="quoted"><span class="skolem">e<span class="hidden">⇩</span><sub>4</sub></span></span><span class="main">]</span> smallstepI_ps_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">π<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="skolem">e<span class="hidden">⇩</span><sub>3</sub></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smallstep_ideal_deterministic <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smallstepI_ps_emptyD<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lemma 2.3›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma2_3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"erase_env <span class="free">Γ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>W</sub></span> <span class="free">e</span> <span class="main">:</span> erase <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> erase_env_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">eP</span></span> <span class="quoted"><span class="free">eV</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> agree.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_HashI <span class="skolem">v</span> <span class="skolem">vP</span> <span class="skolem">τ</span> <span class="skolem">h</span> <span class="skolem">Γ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">Γ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> judge_weak_weakening_2 fmmap_fmupd judge_weak_fresh_env_fresh_term fresh_tyenv_None<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_fmmap_erase_fresh fmmap_fmupd judge_weak_fresh_env_fresh_term<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lemma 2.4›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma2_4<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"value <span class="free">e</span> <span class="main">∧</span> value <span class="free">eP</span> <span class="main">∧</span> value <span class="free">eV</span> <span class="main">∨</span> <span class="main">¬</span> value <span class="free">e</span> <span class="main">∧</span> <span class="main">¬</span> value <span class="free">eP</span> <span class="main">∧</span> <span class="main">¬</span> value <span class="free">eV</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">eP</span></span> <span class="quoted"><span class="free">eV</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> agree.strong_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lemma 3›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma3_general<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Γ</span> <span class="main">::</span> <span class="quoted">tyenv</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">vs</span> <span class="free">vPs</span> <span class="free">vVs</span> <span class="main">::</span> <span class="quoted">tenv</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">|⊆|</span> fmdom <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"fmdom <span class="free">vs</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="free">vPs</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="free">vVs</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">|∈|</span> <span class="free">A</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">τ'</span> <span class="bound">v</span> <span class="bound">vP</span> <span class="bound">h</span><span class="main">.</span>
    <span class="free">Γ</span> <span class="main">$$</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="main">(</span>AuthT <span class="bound">τ'</span><span class="main">)</span> <span class="main">∧</span>
    <span class="free">vs</span> <span class="main">$$</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">∧</span>
   <span class="free">vPs</span> <span class="main">$$</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="main">(</span>Hashed <span class="bound">h</span> <span class="bound">vP</span><span class="main">)</span> <span class="main">∧</span>
   <span class="free">vVs</span> <span class="main">$$</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="main">(</span>Hash <span class="bound">h</span><span class="main">)</span> <span class="main">∧</span>
   <span class="main">{$$}</span> <span class="main">⊢</span> <span class="bound">v</span><span class="main">,</span> Hashed <span class="bound">h</span> <span class="bound">vP</span><span class="main">,</span> Hash <span class="bound">h</span> <span class="main">:</span> <span class="main">(</span>AuthT <span class="bound">τ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"fmdrop_fset <span class="free">A</span> <span class="free">Γ</span> <span class="main">⊢</span> psubst_term <span class="free">e</span> <span class="free">vs</span><span class="main">,</span> psubst_term <span class="free">e</span> <span class="free">vPs</span><span class="main">,</span> psubst_term <span class="free">e</span> <span class="free">vVs</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quoted"><span class="free">vPs</span></span> <span class="quoted"><span class="free">vVs</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> judge.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>j_Unit <span class="skolem">Γ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>j_Var <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> j_Var <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">|∈|</span> <span class="skolem">A</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> j_Var <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> agree_weakening_env<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> j_Var <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a_Var <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fmdomI <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>j_Lam <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> j_Lam<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">|-|</span> <span class="main">{|</span><span class="skolem">x</span><span class="main">|}</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_fset_fminus<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> j_Lam<span class="main">(</span>5<span class="main">,</span>8-<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdrop_fset <span class="skolem">A</span> <span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">$$:=</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">⊢</span> psubst_term <span class="skolem">e</span> <span class="skolem">vs</span><span class="main">,</span> psubst_term <span class="skolem">e</span> <span class="skolem">vPs</span><span class="main">,</span> psubst_term <span class="skolem">e</span> <span class="skolem">vVs</span> <span class="main">:</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> j_Lam<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">A</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">vs</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">vPs</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">vVs</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_tyenv_None<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> j_Lam<span class="main">(</span>1-5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_fmdrop_fset<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>j_App <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdrop_fset <span class="skolem">A</span> <span class="skolem">Γ</span> <span class="main">⊢</span> psubst_term <span class="skolem">e</span> <span class="skolem">vs</span><span class="main">,</span> psubst_term <span class="skolem">e</span> <span class="skolem">vPs</span><span class="main">,</span> psubst_term <span class="skolem">e</span> <span class="skolem">vVs</span> <span class="main">:</span> Fun <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fmdrop_fset <span class="skolem">A</span> <span class="skolem">Γ</span> <span class="main">⊢</span> psubst_term <span class="skolem">e'</span> <span class="skolem">vs</span><span class="main">,</span> psubst_term <span class="skolem">e'</span> <span class="skolem">vPs</span><span class="main">,</span> psubst_term <span class="skolem">e'</span> <span class="skolem">vVs</span> <span class="main">:</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>j_Let <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> j_Let<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">|-|</span> <span class="main">{|</span><span class="skolem">x</span><span class="main">|}</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_fset_fminus<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> j_Let<span class="main">(</span>8<span class="main">,</span>11-<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdrop_fset <span class="skolem">A</span> <span class="skolem">Γ</span> <span class="main">⊢</span> psubst_term <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">vs</span><span class="main">,</span> psubst_term <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">vPs</span><span class="main">,</span> psubst_term <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">vVs</span> <span class="main">:</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> j_Let<span class="main">(</span>4<span class="main">,</span>5<span class="main">,</span>11-<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdrop_fset <span class="skolem">A</span> <span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">$$:=</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">⊢</span> psubst_term <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">vs</span><span class="main">,</span> psubst_term <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">vPs</span><span class="main">,</span> psubst_term <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">vVs</span> <span class="main">:</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> j_Let<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_tyenv_None<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> j_Let<span class="main">(</span>1-6<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_fmdrop_fset fresh_Pair fresh_psubst<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>j_Rec <span class="skolem">x</span> <span class="skolem">Γ</span> <span class="skolem">y</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> j_Rec<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">|-|</span> <span class="main">{|</span><span class="skolem">x</span><span class="main">|}</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_fset_fminus<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> j_Rec<span class="main">(</span>9<span class="main">,</span>14-<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdrop_fset <span class="skolem">A</span> <span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">$$:=</span> Fun <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⊢</span> psubst_term <span class="main">(</span>Lam <span class="skolem">y</span> <span class="skolem">e'</span><span class="main">)</span> <span class="skolem">vs</span><span class="main">,</span> psubst_term <span class="main">(</span>Lam <span class="skolem">y</span> <span class="skolem">e'</span><span class="main">)</span> <span class="skolem">vPs</span><span class="main">,</span> psubst_term <span class="main">(</span>Lam <span class="skolem">y</span> <span class="skolem">e'</span><span class="main">)</span> <span class="skolem">vVs</span> <span class="main">:</span> Fun <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> j_Rec<span class="main"><span class="main">(</span></span>13<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_tyenv_None<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> j_Rec<span class="main">(</span>1-11<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_fmdrop_fset<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>j_Case <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdrop_fset <span class="skolem">A</span> <span class="skolem">Γ</span> <span class="main">⊢</span> psubst_term <span class="skolem">e</span>  <span class="skolem">vs</span><span class="main">,</span> psubst_term <span class="skolem">e</span>  <span class="skolem">vPs</span><span class="main">,</span> psubst_term <span class="skolem">e</span>  <span class="skolem">vVs</span> <span class="main">:</span> Sum <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fmdrop_fset <span class="skolem">A</span> <span class="skolem">Γ</span> <span class="main">⊢</span> psubst_term <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">vs</span><span class="main">,</span> psubst_term <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">vPs</span><span class="main">,</span> psubst_term <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">vVs</span> <span class="main">:</span> Fun <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fmdrop_fset <span class="skolem">A</span> <span class="skolem">Γ</span> <span class="main">⊢</span> psubst_term <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">vs</span><span class="main">,</span> psubst_term <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">vPs</span><span class="main">,</span> psubst_term <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">vVs</span> <span class="main">:</span> Fun <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">τ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>j_Prj1 <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdrop_fset <span class="skolem">A</span> <span class="skolem">Γ</span> <span class="main">⊢</span> psubst_term <span class="skolem">e</span> <span class="skolem">vs</span><span class="main">,</span> psubst_term <span class="skolem">e</span> <span class="skolem">vPs</span><span class="main">,</span> psubst_term <span class="skolem">e</span> <span class="skolem">vVs</span> <span class="main">:</span> Prod <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>j_Prj2 <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdrop_fset <span class="skolem">A</span> <span class="skolem">Γ</span> <span class="main">⊢</span> psubst_term <span class="skolem">e</span> <span class="skolem">vs</span><span class="main">,</span> psubst_term <span class="skolem">e</span> <span class="skolem">vPs</span><span class="main">,</span> psubst_term <span class="skolem">e</span> <span class="skolem">vVs</span> <span class="main">:</span> Prod <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>j_Roll <span class="skolem">α</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdrop_fset <span class="skolem">A</span> <span class="skolem">Γ</span> <span class="main">⊢</span> psubst_term <span class="skolem">e</span> <span class="skolem">vs</span><span class="main">,</span> psubst_term <span class="skolem">e</span> <span class="skolem">vPs</span><span class="main">,</span> psubst_term <span class="skolem">e</span> <span class="skolem">vVs</span> <span class="main">:</span> subst_type <span class="skolem">τ</span> <span class="main">(</span>Mu <span class="skolem">α</span> <span class="skolem">τ</span><span class="main">)</span> <span class="skolem">α</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> j_Roll<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_fmdrop_fset<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>j_Unroll <span class="skolem">α</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmdrop_fset <span class="skolem">A</span> <span class="skolem">Γ</span> <span class="main">⊢</span> psubst_term <span class="skolem">e</span> <span class="skolem">vs</span><span class="main">,</span> psubst_term <span class="skolem">e</span> <span class="skolem">vPs</span><span class="main">,</span> psubst_term <span class="skolem">e</span> <span class="skolem">vVs</span> <span class="main">:</span> Mu <span class="skolem">α</span> <span class="skolem">τ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> j_Unroll<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_fmdrop_fset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> lemma3 <span class="main">=</span> lemma3_general<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="free">Γ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Γ <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">Γ</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">Γ</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lemma 4›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma4<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">(</span><span class="free">x</span> <span class="main">$$:=</span> <span class="free">τ'</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="free">v</span><span class="main">,</span> <span class="free">vP</span><span class="main">,</span> <span class="free">vV</span> <span class="main">:</span> <span class="free">τ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"value <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"value <span class="free">vP</span>"</span></span> <span class="quoted"><span class="quoted">"value <span class="free">vV</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">[</span><span class="free">v</span> <span class="main">/</span> <span class="free">x</span><span class="main">]</span><span class="main">,</span> <span class="free">eP</span><span class="main">[</span><span class="free">vP</span> <span class="main">/</span> <span class="free">x</span><span class="main">]</span><span class="main">,</span> <span class="free">eV</span><span class="main">[</span><span class="free">vV</span> <span class="main">/</span> <span class="free">x</span><span class="main">]</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">nominal_induct</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">(</span><span class="free">x</span> <span class="main">$$:=</span> <span class="free">τ'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">eP</span></span> <span class="quoted"><span class="free">eV</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> agree.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> a_Unit
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Var <span class="skolem">y</span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">Γ</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> fmempty
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> agree.a_Var fmupd_lookup option.sel subst_term.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fmupd <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">Γ</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> agree_weakening_2 fresh_tyenv_None <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Lam <span class="skolem">y</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Lam<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>5<span class="main">,</span>6<span class="main">,</span>7-<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> agree_empty_fresh <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmupd_reorder_neq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_App <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub>P</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub>P</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub>V</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub>V</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_App<span class="main">(</span>5-<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> a_App<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Let <span class="skolem">y</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> agree_empty_fresh <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmupd_reorder_neq <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> agree.a_Let<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Rec <span class="skolem">y</span> <span class="skolem">z</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Rec<span class="main">(</span>10<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">::</span>var<span class="main">.</span> atom <span class="bound">a</span> <span class="main">♯</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">::</span>var<span class="main">.</span> atom <span class="bound">a</span> <span class="main">♯</span> <span class="free">vP</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">::</span>var<span class="main">.</span> atom <span class="bound">a</span> <span class="main">♯</span> <span class="free">vV</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> a_Rec<span class="main">(</span>1-8<span class="main">,</span>10-<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> a_Rec<span class="main">(</span>9<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> fmupd_reorder_neq<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmupd_reorder_neq <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> agree.a_Rec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Case <span class="skolem">v</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">vP</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub>P</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub>P</span> <span class="skolem">vV</span> <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub>V</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub>V</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Case<span class="main">(</span>7-<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> a_Case<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">,</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_HashI <span class="skolem">v</span> <span class="skolem">vP</span> <span class="skolem">τ</span> <span class="skolem">h</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">x</span> <span class="main">♯</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">x</span> <span class="main">♯</span> <span class="skolem">vP</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> a_HashI <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lemma 5:  Single-Step Correctness›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma5<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="free">e</span> <span class="main">≫</span> I<span class="main">→</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">eP'</span> <span class="free">eV'</span> <span class="free">π</span>
  <span class="keyword2"><span class="keyword">where</span></span>   <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="free">e'</span><span class="main">,</span> <span class="free">eP'</span><span class="main">,</span> <span class="free">eV'</span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">.</span> <span class="main">≪</span> <span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">,</span> <span class="free">eP</span> <span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span> <span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">@</span> <span class="free">π</span><span class="main">,</span> <span class="free">eP'</span> <span class="main">≫</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π'</span><span class="main">.</span> <span class="main">≪</span> <span class="free">π</span> <span class="main">@</span> <span class="bound">π'</span><span class="main">,</span> <span class="free">eV</span> <span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span> <span class="bound">π'</span><span class="main">,</span> <span class="free">eV'</span> <span class="main">≫</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">nominal_induct</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span><span class="main">::</span>tyenv"</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">eP</span></span> <span class="quoted"><span class="free">eV</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">e'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> agree.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_App <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_App<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_App_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App1 <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_App<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="skolem"><span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">:</span> Fun <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">.</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span><span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">@</span> <span class="skolem">π</span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">≫</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π'</span><span class="main">.</span> <span class="main">≪</span><span class="skolem">π</span> <span class="main">@</span> <span class="bound">π'</span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span><span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span><span class="bound">π'</span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">≫</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> * App1 a_App<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>5-<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e'</span><span class="main">,</span> App <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> App <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">.</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">,</span> App <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">@</span> <span class="skolem">π</span><span class="main">,</span> App <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π'</span><span class="main">.</span> <span class="main">≪</span><span class="skolem">π</span> <span class="main">@</span> <span class="bound">π'</span><span class="main">,</span> App <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span><span class="bound">π'</span><span class="main">,</span> App <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App2 <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_App<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="skolem"><span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">:</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">.</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">@</span> <span class="skolem">π</span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">≫</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π'</span><span class="main">.</span> <span class="main">≪</span><span class="skolem">π</span> <span class="main">@</span> <span class="bound">π'</span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span><span class="bound">π'</span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">≫</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> * App2 a_App<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>5-<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e'</span><span class="main">,</span> App <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">,</span> App <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">:</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">.</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">,</span> App <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">@</span> <span class="skolem">π</span><span class="main">,</span> App <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">≫</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π'</span><span class="main">.</span> <span class="main">≪</span><span class="skolem">π</span> <span class="main">@</span> <span class="bound">π'</span><span class="main">,</span> App <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span><span class="bound">π'</span><span class="main">,</span> App <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">≫</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>AppLam <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a_App<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Lam <span class="skolem">x</span> <span class="skolem">e</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> a_Lam_inv_I<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> _ Lam<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Lam <span class="skolem">eP</span> <span class="skolem">eV</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> Lam a_App<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span> AppLam <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e'</span><span class="main">,</span> <span class="skolem">eP</span><span class="main">[</span><span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">/</span> <span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="skolem">eV</span><span class="main">[</span><span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">/</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">:</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lemma4<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> Lam a_App<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span> AppLam <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">.</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">,</span> App <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">@</span> <span class="main">[]</span><span class="main">,</span> <span class="skolem">eP</span><span class="main">[</span><span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">/</span> <span class="skolem">x</span><span class="main">]</span><span class="main">≫</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> allI iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> smallstepP_ps_prepend<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> π <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">simplified</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> s_AppLam<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> v<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> Lam a_App<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span> AppLam <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π'</span><span class="main">.</span> <span class="main">≪</span><span class="main">[]</span> <span class="main">@</span> <span class="bound">π'</span><span class="main">,</span> App <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span><span class="bound">π'</span><span class="main">,</span> <span class="skolem">eV</span><span class="main">[</span><span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">/</span> <span class="skolem">x</span><span class="main">]</span><span class="main">≫</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> allI iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> smallstepV_ps_append<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> π' <span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">simplified</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> s_AppLam<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> v<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>AppRec <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a_App<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Rec <span class="skolem">x</span> <span class="skolem">e</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> a_Rec_inv_I<span class="main"><span class="main">[</span></span><span class="operator">consumes</span> 1<span class="main"><span class="main">,</span></span> <span class="operator">case_names</span> _ Rec<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rec <span class="skolem">y</span> <span class="skolem">e''</span> <span class="skolem">eP'</span> <span class="skolem">eV'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Rec<span class="main">(</span>5<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> a_Lam_inv_I<span class="main"><span class="main">[</span></span><span class="operator">consumes</span> 1<span class="main"><span class="main">,</span></span> <span class="operator">case_names</span> _ Lam<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Lam <span class="skolem">eP''</span> <span class="skolem">eV''</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main">)</span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?eP</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"App <span class="main">(</span>Lam <span class="skolem">y</span> <span class="skolem">eP''</span><span class="main">[</span>Rec <span class="skolem">x</span> <span class="main">(</span>Lam <span class="skolem">y</span> <span class="skolem">eP''</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?eV</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"App <span class="main">(</span>Lam <span class="skolem">y</span> <span class="skolem">eV''</span><span class="main">[</span>Rec <span class="skolem">x</span> <span class="main">(</span>Lam <span class="skolem">y</span> <span class="skolem">eV''</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> a_App<span class="main">(</span>3<span class="main">)</span> AppRec <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"value <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">x</span> <span class="main">♯</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"value <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">x</span> <span class="main">♯</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> Lam a_App<span class="main">(</span>3<span class="main">,</span>5-<span class="main">)</span> AppRec Rec <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e'</span><span class="main">,</span> <span class="var">?eP</span><span class="main">,</span> <span class="var">?eV</span> <span class="main">:</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> term.eq_iff Abs1_eq<span class="main">(</span>3<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmupd_reorder_neq
              <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> agree.a_App<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{$$}</span>"</span></span><span class="main"><span class="main">]</span></span> a_Lam<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="main">]</span></span> lemma4<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> Lam a_App<span class="main">(</span>3<span class="main">,</span>5-<span class="main">)</span> AppRec Rec <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">.</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">,</span> App <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">@</span> <span class="main">[]</span><span class="main">,</span> <span class="var">?eP</span><span class="main">≫</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> term.eq_iff Abs1_eq<span class="main">(</span>3<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> s_AppRec<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> v<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> π<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> e<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Lam <span class="skolem">y</span> <span class="skolem">eP''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> uv<span class="main"><span class="main">=</span></span><span class="quoted">P</span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> allI iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> smallstepP_ps_prepend<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">simplified</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> s_AppRec<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> Lam a_App<span class="main">(</span>3<span class="main">,</span>5-<span class="main">)</span> AppRec Rec <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π'</span><span class="main">.</span> <span class="main">≪</span><span class="main">[]</span> <span class="main">@</span> <span class="bound">π'</span><span class="main">,</span> App <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span><span class="bound">π'</span><span class="main">,</span> <span class="var">?eV</span><span class="main">≫</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> term.eq_iff Abs1_eq<span class="main">(</span>3<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> s_AppRec<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> v<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> π<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> e<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Lam <span class="skolem">y</span> <span class="skolem">eV''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> uv<span class="main"><span class="main">=</span></span><span class="quoted">V</span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> allI iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> smallstepV_ps_append<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">simplified</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> s_AppRec<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_fmap_update<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Let <span class="skolem">x</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">x</span> <span class="main">♯</span> <span class="main">(</span><span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> a_Let<span class="main">(</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Let_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Let1
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> a_Let<span class="main">(</span>6<span class="main">,</span>8<span class="main">)</span> Let1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e'</span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">/</span> <span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">/</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">:</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lemma4<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> a_Let<span class="main">(</span>4<span class="main">,</span>6<span class="main">)</span> Let1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">.</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">,</span> Let <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">@</span> <span class="main">[]</span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">/</span> <span class="skolem">x</span><span class="main">]</span><span class="main">≫</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> allI iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> smallstepP_ps_prepend<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">simplified</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> s_Let2<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> a_Let<span class="main">(</span>5<span class="main">,</span>6<span class="main">)</span> Let1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π'</span><span class="main">.</span> <span class="main">≪</span><span class="main">[]</span> <span class="main">@</span> <span class="bound">π'</span><span class="main">,</span> Let <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span><span class="bound">π'</span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">/</span> <span class="skolem">x</span><span class="main">]</span><span class="main">≫</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> allI iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> smallstepV_ps_append<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">simplified</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> s_Let2<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let2 <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> Let2 a_Let<span class="main">(</span>7<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="skolem"><span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="skolem"><span class="skolem">π</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">:</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">.</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span><span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">@</span> <span class="skolem">π</span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">≫</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π'</span><span class="main">.</span> <span class="main">≪</span><span class="skolem">π</span> <span class="main">@</span> <span class="bound">π'</span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span><span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span><span class="bound">π'</span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">≫</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="skolem">x</span> <span class="main">♯</span> <span class="main">(</span><span class="main">{$$}</span><span class="main">,</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> agree_empty_fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> ih a_Let<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="skolem">x</span> <span class="main">♯</span> <span class="skolem">π</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fresh_Nil fresh_append fresh_ps_smallstep_P <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> a_Let ih <span class="keyword1"><span class="command">have</span></span> agree<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> Let <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Let <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Let <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> a_Let<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> ih<span class="main">(</span>1<span class="main">)</span> spec<span class="main">[</span><span class="operator">OF</span> ih<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="skolem">π'</span><span class="main">,</span> Let <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span><span class="skolem">π'</span> <span class="main">@</span> <span class="skolem">π</span><span class="main">,</span> Let <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">π'</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> smallstepP_ps_prepend<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">simplified</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> s_Let1<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> a_Let<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> ih<span class="main">(</span>1<span class="main">)</span> spec<span class="main">[</span><span class="operator">OF</span> ih<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="skolem">π</span> <span class="main">@</span> <span class="skolem">π'</span><span class="main">,</span> Let <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span><span class="skolem">π'</span><span class="main">,</span> Let <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">π'</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> smallstepV_ps_append<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">π</span></span></span></span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">simplified</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> s_Let1<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Case <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Case<span class="main">(</span>7<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Case_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Case <span class="skolem">e''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Case<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">e''</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">eP''</span></span> <span class="skolem"><span class="skolem">eV''</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="keyword2"><span class="keyword">where</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e''</span><span class="main">,</span> <span class="skolem">eP''</span><span class="main">,</span> <span class="skolem">eV''</span> <span class="main">:</span> Syntax.Sum <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">.</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">,</span> <span class="skolem">eP</span><span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">@</span> <span class="skolem">π</span><span class="main">,</span> <span class="skolem">eP''</span><span class="main">≫</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π'</span><span class="main">.</span> <span class="main">≪</span><span class="skolem">π</span> <span class="main">@</span> <span class="bound">π'</span><span class="main">,</span> <span class="skolem">eV</span><span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span><span class="bound">π'</span><span class="main">,</span> <span class="skolem">eV''</span><span class="main">≫</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">π</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> ih<span class="main">(</span>1<span class="main">)</span> a_Case<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span> Case <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e'</span><span class="main">,</span> Case <span class="skolem">eP''</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Case <span class="skolem">eV''</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">τ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> a_Case<span class="main">(</span>5<span class="main">)</span> spec<span class="main">[</span><span class="operator">OF</span> ih<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">.</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">,</span> Case <span class="skolem">eP</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">@</span> <span class="skolem">π</span><span class="main">,</span> Case <span class="skolem">eP''</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> allI iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> smallstepP_ps_prepend<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">simplified</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> s_Case<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> a_Case<span class="main">(</span>5<span class="main">)</span> spec<span class="main">[</span><span class="operator">OF</span> ih<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π'</span><span class="main">.</span> <span class="main">≪</span><span class="skolem">π</span> <span class="main">@</span> <span class="bound">π'</span><span class="main">,</span> Case <span class="skolem">eV</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span><span class="bound">π'</span><span class="main">,</span> Case <span class="skolem">eV''</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> allI iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> smallstepV_ps_append<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">simplified</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> s_Case<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inj1 <span class="skolem">v</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a_Case<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">=</span> Inj1 <span class="skolem">v</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> a_Inj1_inv_I<span class="main"><span class="main">[</span></span><span class="operator">consumes</span> 1<span class="main"><span class="main">,</span></span> <span class="operator">case_names</span> Case<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Case <span class="skolem">vP</span> <span class="skolem">vV</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> a_Case<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span> Inj1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> Case a_Case<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span> Inj1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e'</span><span class="main">,</span> App <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">vP</span><span class="main">,</span> App <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">vV</span> <span class="main">:</span> <span class="skolem">τ</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inj2 <span class="skolem">v</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a_Case<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">=</span> Inj2 <span class="skolem">v</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> a_Inj2_inv_I<span class="main"><span class="main">[</span></span><span class="operator">consumes</span> 1<span class="main"><span class="main">,</span></span> <span class="operator">case_names</span> Case<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Case <span class="skolem">vP</span> <span class="skolem">vV</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> a_Case<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span> Inj2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> Case a_Case<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span> Inj2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e'</span><span class="main">,</span> App <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">vP</span><span class="main">,</span> App <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">vV</span> <span class="main">:</span> <span class="skolem">τ</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Prj1 <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Prj1<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Prj1_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prj1 <span class="skolem">e''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_Prj1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PrjPair1 <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a_Prj1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">=</span> Syntax.Pair <span class="skolem">e'</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> a_Pair_inv_I<span class="main"><span class="main">[</span></span><span class="operator">consumes</span> 1<span class="main"><span class="main">,</span></span> <span class="operator">case_names</span> Pair<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> PrjPair1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e'</span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">:</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Pair<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Prj2 <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Prj2<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Prj2_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prj2 <span class="skolem">e''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_Prj2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PrjPair2 <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a_Prj2<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">=</span> Syntax.Pair <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e'</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> a_Pair_inv_I<span class="main"><span class="main">[</span></span><span class="operator">consumes</span> 1<span class="main"><span class="main">,</span></span> <span class="operator">case_names</span> Pair<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> PrjPair2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e'</span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Pair<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Roll <span class="skolem">α</span> <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Roll<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Roll_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Roll <span class="skolem">e''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Roll<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">eP''</span></span> <span class="skolem"><span class="skolem">eV''</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e''</span><span class="main">,</span> <span class="skolem">eP''</span><span class="main">,</span> <span class="skolem">eV''</span> <span class="main">:</span> subst_type <span class="skolem">τ</span> <span class="main">(</span>Mu <span class="skolem">α</span> <span class="skolem">τ</span><span class="main">)</span> <span class="skolem">α</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">.</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">,</span> <span class="skolem">eP</span><span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">@</span> <span class="skolem">π</span><span class="main">,</span> <span class="skolem">eP''</span><span class="main">≫</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π'</span><span class="main">.</span> <span class="main">≪</span><span class="skolem">π</span> <span class="main">@</span> <span class="bound">π'</span><span class="main">,</span> <span class="skolem">eV</span><span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span><span class="bound">π'</span><span class="main">,</span> <span class="skolem">eV''</span><span class="main">≫</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> * Roll
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e'</span><span class="main">,</span> Roll <span class="skolem">eP''</span><span class="main">,</span> Roll <span class="skolem">eV''</span> <span class="main">:</span> Mu <span class="skolem">α</span> <span class="skolem">τ</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">.</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">,</span> Roll <span class="skolem">eP</span><span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">@</span> <span class="skolem">π</span><span class="main">,</span> Roll <span class="skolem">eP''</span><span class="main">≫</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π'</span><span class="main">.</span> <span class="main">≪</span><span class="skolem">π</span> <span class="main">@</span> <span class="bound">π'</span><span class="main">,</span> Roll <span class="skolem">eV</span><span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span><span class="bound">π'</span><span class="main">,</span> Roll <span class="skolem">eV''</span><span class="main">≫</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Unroll <span class="skolem">α</span> <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Unroll<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Unroll_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Unroll <span class="skolem">e''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Unroll<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">eP''</span></span> <span class="skolem"><span class="skolem">eV''</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e''</span><span class="main">,</span> <span class="skolem">eP''</span><span class="main">,</span> <span class="skolem">eV''</span> <span class="main">:</span> Mu <span class="skolem">α</span> <span class="skolem">τ</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">.</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">,</span> <span class="skolem">eP</span><span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">@</span> <span class="skolem">π</span><span class="main">,</span> <span class="skolem">eP''</span><span class="main">≫</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π'</span><span class="main">.</span> <span class="main">≪</span><span class="skolem">π</span> <span class="main">@</span> <span class="bound">π'</span><span class="main">,</span> <span class="skolem">eV</span><span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span><span class="bound">π'</span><span class="main">,</span> <span class="skolem">eV''</span><span class="main">≫</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> * Unroll
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e'</span><span class="main">,</span> Unroll <span class="skolem">eP''</span><span class="main">,</span> Unroll <span class="skolem">eV''</span> <span class="main">:</span> subst_type <span class="skolem">τ</span> <span class="main">(</span>Mu <span class="skolem">α</span> <span class="skolem">τ</span><span class="main">)</span> <span class="skolem">α</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">.</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">,</span> Unroll <span class="skolem">eP</span><span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">@</span> <span class="skolem">π</span><span class="main">,</span> Unroll <span class="skolem">eP''</span><span class="main">≫</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π'</span><span class="main">.</span> <span class="main">≪</span><span class="skolem">π</span> <span class="main">@</span> <span class="bound">π'</span><span class="main">,</span> Unroll <span class="skolem">eV</span><span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span><span class="bound">π'</span><span class="main">,</span> Unroll <span class="skolem">eV''</span><span class="main">≫</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> UnrollRoll
    <span class="keyword1"><span class="command">with</span></span> a_Unroll<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">e</span> <span class="main">=</span> Roll <span class="skolem">e'</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> a_Roll_inv_I<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Roll<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Roll <span class="skolem">eP'</span> <span class="skolem">eV'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> UnrollRoll <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e'</span><span class="main">,</span> <span class="skolem">eP'</span><span class="main">,</span> <span class="skolem">eV'</span> <span class="main">:</span> subst_type <span class="skolem">τ</span> <span class="main">(</span>Mu <span class="skolem">α</span> <span class="skolem">τ</span><span class="main">)</span> <span class="skolem">α</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Auth <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Auth<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="skolem">x</span> <span class="main">♯</span> <span class="skolem">eP</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">var</span>
    <span class="keyword1"><span class="command">using</span></span> agree_empty_fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> a_Auth<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_AuthI_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Auth <span class="skolem">e''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_Auth<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> AuthI
    <span class="keyword1"><span class="command">with</span></span> a_Auth<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"value <span class="skolem">eP</span>"</span></span> <span class="quoted"><span class="quoted">"value <span class="skolem">eV</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> a_Auth<span class="main">(</span>1<span class="main">)</span> AuthI<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> a_Auth<span class="main">(</span>1<span class="main">)</span> AuthI<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹value <span class="skolem">eP</span>›</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e'</span><span class="main">,</span> Hashed <span class="main">(</span>hash <span class="main">⦇</span><span class="skolem">eP</span><span class="main">⦈</span><span class="main">)</span> <span class="skolem">eP</span><span class="main">,</span> Hash <span class="main">(</span>hash <span class="main">⦇</span><span class="skolem">eP</span><span class="main">⦈</span><span class="main">)</span> <span class="main">:</span> AuthT <span class="skolem">τ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> lemma2_1 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_shallow<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> lemma2_1 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_shallow<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Unauth <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Unauth<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> eP_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"closed <span class="skolem">eP</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> agree_empty_fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> a_Unauth<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_UnauthI_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Unauth <span class="skolem">e'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_Unauth<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> UnauthI
    <span class="keyword1"><span class="command">with</span></span> a_Unauth<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"value <span class="skolem">eP</span>"</span></span> <span class="quoted"><span class="quoted">"value <span class="skolem">eV</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> a_Unauth<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> a_AuthT_value_inv<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> _ _ _ Unauth<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Unauth <span class="skolem">vP'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span><span class="main"><span class="main">⦇</span></span><span class="skolem"><span class="skolem">vP'</span></span><span class="main"><span class="main">⦈</span></span><span class="main"><span class="main">]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> Unauth<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> UnauthI<span class="main">(</span>2<span class="main">)</span> a_Unauth<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e'</span><span class="main">,</span> <span class="skolem">vP'</span><span class="main">,</span> <span class="main">⦇</span><span class="skolem">vP'</span><span class="main">⦈</span> <span class="main">:</span> <span class="skolem">τ</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_shallow<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">vP'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> Unauth<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> a_Unauth<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">.</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">,</span> Unauth <span class="skolem">eP</span><span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">@</span> <span class="main">[</span><span class="main">⦇</span><span class="skolem">vP'</span><span class="main">⦈</span><span class="main">]</span><span class="main">,</span> <span class="skolem">vP'</span><span class="main">≫</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π'</span><span class="main">.</span> <span class="main">≪</span><span class="main">[</span><span class="main">⦇</span><span class="skolem">vP'</span><span class="main">⦈</span><span class="main">]</span> <span class="main">@</span> <span class="bound">π'</span><span class="main">,</span> Unauth <span class="skolem">eV</span><span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span><span class="bound">π'</span><span class="main">,</span> <span class="main">⦇</span><span class="skolem">vP'</span><span class="main">⦈</span><span class="main">≫</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_shallow<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹value <span class="skolem">e</span>›</span></span> <span class="quoted"><span class="quoted">‹value <span class="skolem">eP</span>›</span></span> <span class="quoted"><span class="quoted">‹value <span class="skolem">eV</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Pair <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Pair<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Pair_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair1 <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Pair<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_Pair<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair2 <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Pair<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_Pair<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Inj1 <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Inj1<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Inj1_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inj1 <span class="skolem">e'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Inj1<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_Inj1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Inj2 <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Inj2<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Inj2_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inj2 <span class="skolem">e''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Inj2<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_Inj2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">meson</span> value.intros value_no_step<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lemma 6: Single-Step Security›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma6<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π<span class="hidden">⇩</span><sub>A</sub></span><span class="main">,</span> <span class="free">eV</span> <span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">eV'</span> <span class="main">≫</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">e'</span> <span class="free">eP'</span> <span class="free">π</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="free">e</span> <span class="main">≫</span> I<span class="main">→</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">.</span> <span class="main">≪</span> <span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">,</span> <span class="free">eP</span> <span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span> <span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">@</span> <span class="free">π</span><span class="main">,</span> <span class="free">eP'</span> <span class="main">≫</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="free">e'</span><span class="main">,</span> <span class="free">eP'</span><span class="main">,</span> <span class="free">eV'</span> <span class="main">:</span> <span class="free">τ</span> <span class="main">∧</span> <span class="free">π<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">=</span> <span class="free">π</span> <span class="main">@</span> <span class="free">π'</span> <span class="main">∨</span>
         <span class="main">(</span><span class="main">∃</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> closed <span class="bound">s</span> <span class="main">∧</span> closed <span class="bound">s'</span> <span class="main">∧</span> <span class="free">π</span> <span class="main">=</span> <span class="main">[</span><span class="bound">s</span><span class="main">]</span> <span class="main">∧</span> <span class="free">π<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">=</span> <span class="main">[</span><span class="bound">s'</span><span class="main">]</span> <span class="main">@</span> <span class="free">π'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">s'</span> <span class="main">∧</span> hash <span class="bound">s</span> <span class="main">=</span> hash <span class="bound">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">nominal_induct</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span><span class="main">::</span>tyenv"</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">eP</span></span> <span class="quoted"><span class="free">eV</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">π<span class="hidden">⇩</span><sub>A</sub></span></span> <span class="quoted"><span class="free">π'</span></span> <span class="quoted"><span class="free">eV'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> agree.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_App <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_App<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_App_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App1 <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_App<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_App<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App2 <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_App<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_App<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>AppLam <span class="skolem">x</span> <span class="skolem">eV''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a_App<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Lam <span class="skolem">x</span> <span class="skolem">eV''</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> a_Lam_inv_V<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Lam<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Lam <span class="skolem">e''</span> <span class="skolem">eP''</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> a_App<span class="main">(</span>3<span class="main">)</span> AppLam <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI disjI1<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> Lam a_App<span class="main">(</span>3<span class="main">)</span> AppLam <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e''</span><span class="main">[</span><span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">/</span> <span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="skolem">eP''</span><span class="main">[</span><span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">/</span> <span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="skolem">eV'</span> <span class="main">:</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lemma4<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> s_AppLam<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> π<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> smallstepP_ps_prepend<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">simplified</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>AppRec <span class="skolem">x</span> <span class="skolem">eV''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a_App<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Rec <span class="skolem">x</span> <span class="skolem">eV''</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> a_Rec_inv_V<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> _ Rec<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rec <span class="skolem">y</span> <span class="skolem">e'''</span>  <span class="skolem">eP'''</span> <span class="skolem">eV'''</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> a_App<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> AppRec <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI disjI1<span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"App <span class="main">(</span>Lam <span class="skolem">y</span> <span class="skolem">e'''</span><span class="main">[</span>Rec <span class="skolem">x</span> <span class="main">(</span>Lam <span class="skolem">y</span> <span class="skolem">e'''</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?eP</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"App <span class="main">(</span>Lam <span class="skolem">y</span> <span class="skolem">eP'''</span><span class="main">[</span>Rec <span class="skolem">x</span> <span class="main">(</span>Lam <span class="skolem">y</span> <span class="skolem">eP'''</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> Rec a_App<span class="main">(</span>3<span class="main">)</span> AppRec <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="var">?e</span><span class="main">,</span> <span class="var">?eP</span><span class="main">,</span> <span class="skolem">eV'</span> <span class="main">:</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subst_term.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> agree.a_App<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{$$}</span>"</span></span><span class="main"><span class="main">]</span></span> lemma4<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subst_term.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> s_AppRec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> π<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> smallstepP_ps_prepend<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">simplified</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Let <span class="skolem">x</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">x</span> <span class="main">♯</span> <span class="main">(</span><span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">π<span class="hidden">⇩</span><sub>A</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> a_Let<span class="main">(</span>12<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Let_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Let1
    <span class="keyword1"><span class="command">with</span></span> a_Let<span class="main">(</span>5<span class="main">,</span>6<span class="main">,</span>8<span class="main">,</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI disjI1<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Let1 a_Let<span class="main">(</span>5<span class="main">,</span>6<span class="main">,</span>8<span class="main">,</span>10<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">/</span> <span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">[</span><span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">/</span> <span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="skolem">eV'</span> <span class="main">:</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lemma4<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> smallstepP_ps_prepend<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">simplified</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let2 <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Let<span class="main">(</span>9<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">π<span class="hidden">⇩</span><sub>A</sub></span></span> <span class="quoted"><span class="skolem">π'</span></span> <span class="quoted"><span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub>'</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="skolem"><span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span><span class="main">≫</span> I<span class="main">→</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">≫</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">.</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span><span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">@</span> <span class="skolem">π</span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">≫</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">:</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="skolem">π<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">=</span> <span class="skolem">π</span> <span class="main">@</span> <span class="skolem">π'</span> <span class="main">∨</span>
         closed <span class="skolem">s</span> <span class="main">∧</span> closed <span class="skolem">s'</span> <span class="main">∧</span> <span class="skolem">π</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">s</span><span class="main">]</span> <span class="main">∧</span> <span class="skolem">π<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">=</span> <span class="main">[</span><span class="skolem">s'</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">π'</span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">s'</span> <span class="main">∧</span> hash <span class="skolem">s</span> <span class="main">=</span> hash <span class="skolem">s'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> a_Let<span class="main">(</span>5<span class="main">,</span>6<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="skolem">x</span> <span class="main">♯</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">x</span> <span class="main">♯</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fresh_smallstep_I fresh_smallstep_P <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">from</span></span> ih a_Let<span class="main">(</span>2<span class="main">,</span>6<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">x</span> <span class="main">♯</span> <span class="skolem">π</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fresh_append fresh_ps_smallstep_P <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> Let2 a_Let<span class="main">(</span>1-8<span class="main">,</span>10<span class="main">,</span>12-<span class="main">)</span> fresh ih <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">π</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹atom <span class="skolem">x</span> <span class="main">♯</span> <span class="skolem">π</span>›</span></span> Let2 a_Let<span class="main">(</span>1-8<span class="main">,</span>10<span class="main">,</span>12-<span class="main">)</span> fresh ih
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> Let <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> Let <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">x</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">eV'</span> <span class="main">:</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="skolem">π<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">=</span> <span class="skolem">π</span> <span class="main">@</span> <span class="skolem">π'</span> <span class="main">∨</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> closed <span class="bound">s</span> <span class="main">∧</span> closed <span class="bound">s'</span> <span class="main">∧</span> <span class="skolem">π</span> <span class="main">=</span> <span class="main">[</span><span class="bound">s</span><span class="main">]</span> <span class="main">∧</span> <span class="skolem">π<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">=</span> <span class="main">[</span><span class="bound">s'</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">π'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">s'</span> <span class="main">∧</span> hash <span class="bound">s</span> <span class="main">=</span> hash <span class="bound">s'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> smallstepP_ps_prepend<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Case <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Case<span class="main">(</span>7<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Case_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Case <span class="skolem">eV''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a_Case<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Case<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> exE disjE conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> ok collision<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ok <span class="skolem">e''</span> <span class="skolem">π</span> <span class="skolem">eP''</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Case a_Case<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>collision <span class="skolem">e''</span> <span class="skolem">π</span> <span class="skolem">eP''</span> <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Case a_Case<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span><span class="skolem"><span class="skolem">s</span></span><span class="main"><span class="main">]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI conjI disjI2<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> Case a_Case<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span> collision <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="main">[]</span><span class="main">,</span> Case <span class="skolem">e</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> I<span class="main">→</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> Case <span class="skolem">e''</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">.</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">,</span> Case <span class="skolem">eP</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">@</span> <span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">,</span> Case <span class="skolem">eP''</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> collision <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"hash <span class="skolem">s</span> <span class="main">=</span> hash <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inj1 <span class="skolem">vV</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a_Case<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">eV</span> <span class="main">=</span> Inj1 <span class="skolem">vV</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> a_Inj1_inv_V<span class="main"><span class="main">[</span></span><span class="operator">consumes</span> 1<span class="main"><span class="main">,</span></span> <span class="operator">case_names</span> Inj<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inj <span class="skolem">v'</span> <span class="skolem">vP'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Inj1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI disjI1<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> a_Case<span class="main">(</span>3<span class="main">)</span> Inj Inj1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> App <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">v'</span><span class="main">,</span> App <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">vP'</span><span class="main">,</span> <span class="skolem">eV'</span> <span class="main">:</span> <span class="skolem">τ</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inj2 <span class="skolem">vV</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a_Case<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">eV</span> <span class="main">=</span> Inj2 <span class="skolem">vV</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> a_Inj2_inv_V<span class="main"><span class="main">[</span></span><span class="operator">consumes</span> 1<span class="main"><span class="main">,</span></span> <span class="operator">case_names</span> Inj<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inj <span class="skolem">v'</span> <span class="skolem">vP'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Inj2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI disjI1<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> a_Case<span class="main">(</span>5<span class="main">)</span> Inj Inj2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> App <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">v'</span><span class="main">,</span> App <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">vP'</span><span class="main">,</span> <span class="skolem">eV'</span> <span class="main">:</span> <span class="skolem">τ</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Prj1 <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Prj1<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Prj1_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prj1 <span class="skolem">eV''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_Prj1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PrjPair1 <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Prj1<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> a_Prod_inv<span class="main"><span class="main">[</span></span><span class="operator">consumes</span> 1<span class="main"><span class="main">,</span></span> <span class="operator">case_names</span> _ _ _ _ Pair<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> PrjPair1 a_Prj1<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI disjI1<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> Pair PrjPair1 a_Prj1<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">eV'</span> <span class="main">:</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Prj2 <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Prj2<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Prj2_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prj2 <span class="skolem">eV''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_Prj2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PrjPair2 <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Prj2<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> a_Prod_inv<span class="main"><span class="main">[</span></span><span class="operator">consumes</span> 1<span class="main"><span class="main">,</span></span> <span class="operator">case_names</span> _ _ _ _ Pair<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> PrjPair2 a_Prj2<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI disjI1<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> Pair PrjPair2 a_Prj2<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">eV'</span> <span class="main">:</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Roll <span class="skolem">α</span> <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Roll<span class="main">(</span>7<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Roll_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Roll <span class="skolem">eV''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a_Roll<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Roll<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e''</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="skolem"><span class="skolem">eP''</span></span> <span class="keyword2"><span class="keyword">where</span></span> ih<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">e</span><span class="main">≫</span> I<span class="main">→</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">e''</span><span class="main">≫</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">.</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">,</span> <span class="skolem">eP</span><span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">@</span> <span class="skolem">π</span><span class="main">,</span> <span class="skolem">eP''</span><span class="main">≫</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e''</span><span class="main">,</span> <span class="skolem">eP''</span><span class="main">,</span> <span class="skolem">eV''</span> <span class="main">:</span> subst_type <span class="skolem">τ</span> <span class="main">(</span>Mu <span class="skolem">α</span> <span class="skolem">τ</span><span class="main">)</span> <span class="skolem">α</span> <span class="main">∧</span> <span class="skolem">π<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">=</span> <span class="skolem">π</span> <span class="main">@</span> <span class="skolem">π'</span> <span class="main">∨</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> closed <span class="bound">s</span> <span class="main">∧</span> closed <span class="bound">s'</span> <span class="main">∧</span> <span class="skolem">π</span> <span class="main">=</span> <span class="main">[</span><span class="bound">s</span><span class="main">]</span> <span class="main">∧</span> <span class="skolem">π<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">=</span> <span class="main">[</span><span class="bound">s'</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">π'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">s'</span> <span class="main">∧</span> hash <span class="bound">s</span> <span class="main">=</span> hash <span class="bound">s'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> Roll <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">π</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI conjI<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> ih Roll <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> Roll <span class="skolem">e''</span><span class="main">,</span> Roll <span class="skolem">eP''</span><span class="main">,</span> <span class="skolem">eV'</span> <span class="main">:</span> Mu <span class="skolem">α</span> <span class="skolem">τ</span> <span class="main">∧</span> <span class="skolem">π<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">=</span> <span class="skolem">π</span> <span class="main">@</span> <span class="skolem">π'</span> <span class="main">∨</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> closed <span class="bound">s</span> <span class="main">∧</span> closed <span class="bound">s'</span> <span class="main">∧</span> <span class="skolem">π</span> <span class="main">=</span> <span class="main">[</span><span class="bound">s</span><span class="main">]</span> <span class="main">∧</span> <span class="skolem">π<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">=</span> <span class="main">[</span><span class="bound">s'</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">π'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">s'</span> <span class="main">∧</span> hash <span class="bound">s</span> <span class="main">=</span> hash <span class="bound">s'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Unroll <span class="skolem">α</span> <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Unroll<span class="main">(</span>7<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Unroll_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Unroll <span class="skolem">eV''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a_Unroll<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Unroll<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e''</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="skolem"><span class="skolem">eP''</span></span> <span class="keyword2"><span class="keyword">where</span></span> ih<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">e</span><span class="main">≫</span> I<span class="main">→</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">e''</span><span class="main">≫</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">.</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">,</span> <span class="skolem">eP</span><span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span><span class="bound">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">@</span> <span class="skolem">π</span><span class="main">,</span> <span class="skolem">eP''</span><span class="main">≫</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e''</span><span class="main">,</span> <span class="skolem">eP''</span><span class="main">,</span> <span class="skolem">eV''</span> <span class="main">:</span> Mu <span class="skolem">α</span> <span class="skolem">τ</span> <span class="main">∧</span> <span class="skolem">π<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">=</span> <span class="skolem">π</span> <span class="main">@</span> <span class="skolem">π'</span> <span class="main">∨</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> closed <span class="bound">s</span> <span class="main">∧</span> closed <span class="bound">s'</span> <span class="main">∧</span> <span class="skolem">π</span> <span class="main">=</span> <span class="main">[</span><span class="bound">s</span><span class="main">]</span> <span class="main">∧</span> <span class="skolem">π<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">=</span> <span class="main">[</span><span class="bound">s'</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">π'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">s'</span> <span class="main">∧</span> hash <span class="bound">s</span> <span class="main">=</span> hash <span class="bound">s'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> Unroll <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">π</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI conjI<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> ih Unroll <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> Unroll <span class="skolem">e''</span><span class="main">,</span> Unroll <span class="skolem">eP''</span><span class="main">,</span> <span class="skolem">eV'</span> <span class="main">:</span> subst_type <span class="skolem">τ</span> <span class="main">(</span>Mu <span class="skolem">α</span> <span class="skolem">τ</span><span class="main">)</span> <span class="skolem">α</span> <span class="main">∧</span> <span class="skolem">π<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">=</span> <span class="skolem">π</span> <span class="main">@</span> <span class="skolem">π'</span> <span class="main">∨</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> closed <span class="bound">s</span> <span class="main">∧</span> closed <span class="bound">s'</span> <span class="main">∧</span> <span class="skolem">π</span> <span class="main">=</span> <span class="main">[</span><span class="bound">s</span><span class="main">]</span> <span class="main">∧</span> <span class="skolem">π<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">=</span> <span class="main">[</span><span class="bound">s'</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">π'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">s'</span> <span class="main">∧</span> hash <span class="bound">s</span> <span class="main">=</span> hash <span class="bound">s'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> UnrollRoll
    <span class="keyword1"><span class="command">with</span></span> a_Unroll<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Auth <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Auth<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="skolem">x</span> <span class="main">♯</span> <span class="skolem">eP</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">var</span>
    <span class="keyword1"><span class="command">using</span></span> agree_empty_fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> a_Auth<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_AuthV_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Auth <span class="skolem">eV''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a_Auth<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Auth<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> exE disjE conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> ok collision<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ok <span class="skolem">e''</span> <span class="skolem">π</span> <span class="skolem">eP''</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Auth <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">π</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI disjI1<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> ok Auth <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> Auth <span class="skolem">e''</span><span class="main">,</span> Auth <span class="skolem">eP''</span><span class="main">,</span> <span class="skolem">eV'</span> <span class="main">:</span> AuthT <span class="skolem">τ</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>collision <span class="skolem">e''</span> <span class="skolem">π</span> <span class="skolem">eP''</span> <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> AuthV
    <span class="keyword1"><span class="command">with</span></span> a_Auth<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI conjI disjI1<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> a_Auth<span class="main">(</span>1<span class="main">)</span> AuthV <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e</span><span class="main">,</span> Hashed <span class="main">(</span>hash <span class="main">⦇</span><span class="skolem">eP</span><span class="main">⦈</span><span class="main">)</span> <span class="skolem">eP</span><span class="main">,</span> <span class="skolem">eV'</span> <span class="main">:</span> AuthT <span class="skolem">τ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> lemma2_1<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_shallow<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Unauth <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Unauth<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_UnauthV_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Unauth <span class="skolem">e'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_Unauth<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> UnauthV
    <span class="keyword1"><span class="command">from</span></span> a_Unauth<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">eV</span> <span class="main">=</span> Hash <span class="main">(</span>hash <span class="skolem">eV'</span><span class="main">)</span>›</span></span><span class="main">]</span> UnauthV a_Unauth<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> a_AuthT_value_inv<span class="main"><span class="main">[</span></span><span class="operator">consumes</span> 1<span class="main"><span class="main">,</span></span> <span class="operator">case_names</span> _ _ _ Hashed<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hashed <span class="skolem">vP'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> UnauthV a_Unauth<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span><span class="main"><span class="main">⦇</span></span><span class="skolem"><span class="skolem">vP'</span></span><span class="main"><span class="main">⦈</span></span><span class="main"><span class="main">]</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> exI conjI<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> Hashed UnauthV a_Unauth<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e</span><span class="main">,</span> <span class="skolem">vP'</span><span class="main">,</span> <span class="skolem">eV'</span> <span class="main">:</span> <span class="skolem">τ</span> <span class="main">∧</span> <span class="skolem">π<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">=</span> <span class="main">[</span><span class="main">⦇</span><span class="skolem">vP'</span><span class="main">⦈</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">π'</span> <span class="main">∨</span>
          <span class="main">(</span><span class="main">∃</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> closed <span class="bound">s</span> <span class="main">∧</span> closed <span class="bound">s'</span> <span class="main">∧</span> <span class="main">[</span><span class="main">⦇</span><span class="skolem">vP'</span><span class="main">⦈</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">s</span><span class="main">]</span> <span class="main">∧</span> <span class="skolem">π<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">=</span> <span class="main">[</span><span class="bound">s'</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">π'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">s'</span> <span class="main">∧</span> hash <span class="bound">s</span> <span class="main">=</span> hash <span class="bound">s'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> a_HashI_inv<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{$$}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Pair <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Pair<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Pair_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair1 <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Pair<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> a_Pair<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">π<span class="hidden">⇩</span><sub>A</sub></span></span> <span class="quoted"><span class="skolem">π'</span></span> <span class="quoted"><span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub>'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair2 <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Pair<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> a_Pair<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">π<span class="hidden">⇩</span><sub>A</sub></span></span> <span class="quoted"><span class="skolem">π'</span></span> <span class="quoted"><span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub>'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Inj1 <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Inj1<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Inj1_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inj1 <span class="skolem">eV''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> a_Inj1<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">π<span class="hidden">⇩</span><sub>A</sub></span></span> <span class="quoted"><span class="skolem">π'</span></span> <span class="quoted"><span class="skolem">eV''</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Inj2 <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Inj2<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Inj2_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inj2 <span class="skolem">eV''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Inj2<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> a_Inj2<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">π<span class="hidden">⇩</span><sub>A</sub></span></span> <span class="quoted"><span class="skolem">π'</span></span> <span class="quoted"><span class="skolem">eV''</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">meson</span> value.intros value_no_step<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Theorem 1: Correctness›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> theorem1_correctness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="free">e</span> <span class="main">≫</span> I<span class="main">→</span><span class="free">i</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">eP'</span> <span class="free">eV'</span> <span class="free">π</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="free">eP</span> <span class="main">≫</span> P<span class="main">→</span><span class="free">i</span> <span class="main">≪</span> <span class="free">π</span><span class="main">,</span> <span class="free">eP'</span> <span class="main">≫</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> <span class="free">eV</span> <span class="main">≫</span> V<span class="main">→</span><span class="free">i</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="free">eV'</span> <span class="main">≫</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="free">e'</span><span class="main">,</span> <span class="free">eP'</span><span class="main">,</span> <span class="free">eV'</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main">::</span>proofstream"</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted">I</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main">::</span>proofstream"</span></span> <span class="quoted"><span class="free">e'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallsteps.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Id <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Tr <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">i</span> <span class="skolem">π<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> smallstepI_ps_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> s_Tr <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="skolem"><span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> ih<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">eP</span><span class="main">≫</span> P<span class="main">→</span><span class="skolem">i</span> <span class="main">≪</span><span class="skolem">π</span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="skolem">π</span><span class="main">,</span> <span class="free">eV</span><span class="main">≫</span> V<span class="main">→</span><span class="skolem">i</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> s_Tr<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">eP<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="skolem"><span class="skolem">eV<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="skolem"><span class="skolem">π'</span></span> <span class="keyword2"><span class="keyword">where</span></span> agree<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e<span class="hidden">⇩</span><sub>3</sub></span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>3</sub></span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="skolem">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span><span class="skolem">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">@</span> <span class="skolem">π'</span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>3</sub></span><span class="main">≫</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="skolem">π'</span> <span class="main">@</span> <span class="skolem">π''</span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span><span class="skolem">π''</span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>3</sub></span><span class="main">≫</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="skolem">π''</span> <span class="keyword1"><span class="command">using</span></span> lemma5<span class="main">[</span><span class="operator">OF</span> ih<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> s_Tr<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">[]</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">thesis</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">eP</span><span class="main">≫</span> P<span class="main">→</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≪</span><span class="skolem">π</span> <span class="main">@</span> <span class="skolem">π'</span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>3</sub></span><span class="main">≫</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="skolem">π</span> <span class="main">@</span> <span class="skolem">π'</span><span class="main">,</span> <span class="free">eV</span><span class="main">≫</span> V<span class="main">→</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>3</sub></span><span class="main">≫</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smallstepsV_ps_append<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
       <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smallsteps.s_Tr<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">@</span> <span class="skolem">π'</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> agree <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Counterexamples to Theorem 1: Security›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Counterexample using administrative normal form.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> security_false<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> agree<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">e</span> <span class="bound">eP</span> <span class="bound">eV</span> <span class="bound">τ</span> <span class="bound">πA</span> <span class="bound">i</span> <span class="bound">π'</span> <span class="bound">eV'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">{$$}</span> <span class="main">⊢</span> <span class="bound">e</span><span class="main">,</span> <span class="bound">eP</span><span class="main">,</span> <span class="bound">eV</span> <span class="main">:</span> <span class="bound">τ</span><span class="main">;</span> <span class="main">≪</span> <span class="bound">πA</span><span class="main">,</span> <span class="bound">eV</span> <span class="main">≫</span> V<span class="main">→</span><span class="bound">i</span> <span class="main">≪</span> <span class="bound">π'</span><span class="main">,</span> <span class="bound">eV'</span> <span class="main">≫</span> <span class="main">⟧</span> <span class="main">⟹</span>
      <span class="main">∃</span><span class="bound">e'</span> <span class="bound">eP'</span> <span class="bound">π</span> <span class="bound">j</span> <span class="bound">π0</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="bound">e</span> <span class="main">≫</span> I<span class="main">→</span><span class="bound">i</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="bound">e'</span> <span class="main">≫</span> <span class="main">∧</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="bound">eP</span> <span class="main">≫</span> P<span class="main">→</span><span class="bound">i</span> <span class="main">≪</span> <span class="bound">π</span><span class="main">,</span> <span class="bound">eP'</span> <span class="main">≫</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">πA</span> <span class="main">=</span> <span class="bound">π</span> <span class="main">@</span> <span class="bound">π'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{$$}</span> <span class="main">⊢</span> <span class="bound">e'</span><span class="main">,</span> <span class="bound">eP'</span><span class="main">,</span> <span class="bound">eV'</span> <span class="main">:</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">∨</span>
       <span class="main">(</span><span class="bound">j</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="bound">eP</span> <span class="main">≫</span> P<span class="main">→</span><span class="bound">j</span> <span class="main">≪</span> <span class="bound">π0</span> <span class="main">@</span> <span class="main">[</span><span class="bound">s</span><span class="main">]</span><span class="main">,</span> <span class="bound">eP'</span> <span class="main">≫</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">πA</span> <span class="main">=</span> <span class="bound">π0</span> <span class="main">@</span> <span class="main">[</span><span class="bound">s'</span><span class="main">]</span> <span class="main">@</span> <span class="bound">π'</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">s'</span> <span class="main">∧</span> hash <span class="bound">s</span> <span class="main">=</span> hash <span class="bound">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     collision<span class="main">:</span> <span class="quoted"><span class="quoted">"hash <span class="main">(</span>Inj1 Unit<span class="main">)</span> <span class="main">=</span> hash <span class="main">(</span>Inj2 Unit<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     no_collision_with_Unit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> hash Unit <span class="main">=</span> hash <span class="bound">t</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">=</span> Unit"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted">False</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="main">::</span> <span class="quoted">var</span> <span class="keyword2"><span class="keyword">where</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="skolem">y</span> <span class="main">♯</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">z</span> <span class="main">♯</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> obtain_fresh<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Let <span class="main">(</span>Let <span class="main">(</span>Auth <span class="main">(</span>Inj1 Unit<span class="main">)</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">(</span>Unauth <span class="main">(</span>Var <span class="skolem">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">(</span>Let <span class="main">(</span>Let <span class="main">(</span>Auth Unit<span class="main">)</span> <span class="skolem">z</span> <span class="main">(</span>Unauth <span class="main">(</span>Var <span class="skolem">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> fresh_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> prover<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">≫</span> P<span class="main">→</span><span class="skolem">i</span> <span class="main">≪</span> <span class="main">[</span>Inj1 Unit<span class="main">,</span> Unit<span class="main">]</span><span class="main">,</span> Inj1 Unit <span class="main">≫</span>"</span></span> <span class="comment1">― ‹prover execution›</span>
    <span class="keyword1"><span class="command">unfolding</span></span> i_def t_def Suc_eq_plus1 <span class="keyword1"><span class="command">using</span></span> fresh
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smallsteps.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_AuthP<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let2<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_UnauthP<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let2<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_AuthP<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_UnauthP<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">Unit</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Inj1 Unit"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> verifier1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="main">[</span>Inj1 Unit<span class="main">,</span> Unit<span class="main">]</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">≫</span> V<span class="main">→</span><span class="skolem">i</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> Inj1 Unit <span class="main">≫</span>"</span></span> <span class="comment1">― ‹verifier execution›</span>
    <span class="keyword1"><span class="command">unfolding</span></span> i_def t_def Suc_eq_plus1 <span class="keyword1"><span class="command">using</span></span> fresh
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smallsteps.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_AuthV<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let2<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_UnauthV<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let2<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_AuthV<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_UnauthV<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">Unit</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Inj1 Unit"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> verifier2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="main">[</span>Inj2 Unit<span class="main">,</span> Unit<span class="main">]</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">≫</span> V<span class="main">→</span><span class="skolem">i</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> Inj2 Unit <span class="main">≫</span>"</span></span> <span class="comment1">― ‹verifier execution with proofstream containing collision›</span>
    <span class="keyword1"><span class="command">unfolding</span></span> i_def t_def Suc_eq_plus1 <span class="keyword1"><span class="command">using</span></span> fresh
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smallsteps.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_AuthV<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let2<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_UnauthV<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> collision<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let2<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_AuthV<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_UnauthV<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">Unit</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Inj2 Unit"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> judge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">t</span> <span class="main">:</span> Sum One One"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> t_def <span class="keyword1"><span class="command">using</span></span> fresh
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair fresh_fmap_update<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ideal_deterministic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> Inj1 Unit"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">t</span><span class="main">≫</span> I<span class="main">→</span><span class="skolem">i</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">e</span><span class="main">≫</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">e</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smallsteps_ideal_deterministic<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> i_def t_def Suc_eq_plus1 <span class="keyword1"><span class="command">using</span></span> fresh
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smallsteps.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_AuthI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let2<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_UnauthI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let2<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_AuthI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_UnauthI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">Unit</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Inj1 Unit"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> agree<span class="main">[</span><span class="operator">OF</span> judge_imp_agree<span class="main"><span class="main">[</span></span><span class="operator">OF</span> judge<span class="main"><span class="main">]</span></span> verifier2<span class="main">]</span> collision prover verifier1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e'</span> <span class="skolem">eP'</span>
    <span class="keyword3"><span class="command">assume</span></span> agree<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e'</span><span class="main">,</span> <span class="skolem">eP'</span><span class="main">,</span> Inj2 Unit <span class="main">:</span> Sum One One"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">t</span><span class="main">≫</span> I<span class="main">→</span><span class="skolem">i</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">e'</span><span class="main">≫</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e'</span> <span class="main">=</span> Inj1 Unit"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ideal_deterministic<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> agree <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> no_collision_with_Unit<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Alternative, shorter counterexample not in administrative normal form.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> security_false_alt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> agree<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">e</span> <span class="bound">eP</span> <span class="bound">eV</span> <span class="bound">τ</span> <span class="bound">πA</span> <span class="bound">i</span> <span class="bound">π'</span> <span class="bound">eV'</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">{$$}</span> <span class="main">⊢</span> <span class="bound">e</span><span class="main">,</span> <span class="bound">eP</span><span class="main">,</span> <span class="bound">eV</span> <span class="main">:</span> <span class="bound">τ</span><span class="main">;</span> <span class="main">≪</span> <span class="bound">πA</span><span class="main">,</span> <span class="bound">eV</span> <span class="main">≫</span> V<span class="main">→</span><span class="bound">i</span> <span class="main">≪</span> <span class="bound">π'</span><span class="main">,</span> <span class="bound">eV'</span> <span class="main">≫</span> <span class="main">⟧</span> <span class="main">⟹</span>
      <span class="main">∃</span><span class="bound">e'</span> <span class="bound">eP'</span> <span class="bound">π</span> <span class="bound">j</span> <span class="bound">π0</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="bound">e</span> <span class="main">≫</span> I<span class="main">→</span><span class="bound">i</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="bound">e'</span> <span class="main">≫</span> <span class="main">∧</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="bound">eP</span> <span class="main">≫</span> P<span class="main">→</span><span class="bound">i</span> <span class="main">≪</span> <span class="bound">π</span><span class="main">,</span> <span class="bound">eP'</span> <span class="main">≫</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">πA</span> <span class="main">=</span> <span class="bound">π</span> <span class="main">@</span> <span class="bound">π'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{$$}</span> <span class="main">⊢</span> <span class="bound">e'</span><span class="main">,</span> <span class="bound">eP'</span><span class="main">,</span> <span class="bound">eV'</span> <span class="main">:</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">∨</span>
       <span class="main">(</span><span class="bound">j</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="bound">eP</span> <span class="main">≫</span> P<span class="main">→</span><span class="bound">j</span> <span class="main">≪</span> <span class="bound">π0</span> <span class="main">@</span> <span class="main">[</span><span class="bound">s</span><span class="main">]</span><span class="main">,</span> <span class="bound">eP'</span> <span class="main">≫</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">πA</span> <span class="main">=</span> <span class="bound">π0</span> <span class="main">@</span> <span class="main">[</span><span class="bound">s'</span><span class="main">]</span> <span class="main">@</span> <span class="bound">π'</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">s'</span> <span class="main">∧</span> hash <span class="bound">s</span> <span class="main">=</span> hash <span class="bound">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     collision<span class="main">:</span> <span class="quoted"><span class="quoted">"hash <span class="main">(</span>Inj1 Unit<span class="main">)</span> <span class="main">=</span> hash <span class="main">(</span>Inj2 Unit<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     no_collision_with_Unit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> hash Unit <span class="main">=</span> hash <span class="bound">t</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">=</span> Unit"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted">False</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="main">::</span> <span class="quoted">var</span> <span class="keyword2"><span class="keyword">where</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"atom <span class="skolem">y</span> <span class="main">♯</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">z</span> <span class="main">♯</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> obtain_fresh<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Let <span class="main">(</span>Unauth <span class="main">(</span>Auth <span class="main">(</span>Inj1 Unit<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">(</span>Let <span class="main">(</span>Unauth <span class="main">(</span>Auth Unit<span class="main">)</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> fresh_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> prover<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">≫</span> P<span class="main">→</span><span class="skolem">i</span> <span class="main">≪</span> <span class="main">[</span>Inj1 Unit<span class="main">,</span> Unit<span class="main">]</span><span class="main">,</span> Inj1 Unit <span class="main">≫</span>"</span></span> <span class="comment1">― ‹prover execution›</span>
    <span class="keyword1"><span class="command">unfolding</span></span> i_def t_def Suc_eq_plus1 <span class="keyword1"><span class="command">using</span></span> fresh
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smallsteps.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Unauth<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_AuthP<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_UnauthP<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Unauth<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_AuthP<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_UnauthP<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">Unit</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Inj1 Unit"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> verifier1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="main">[</span>Inj1 Unit<span class="main">,</span> Unit<span class="main">]</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">≫</span> V<span class="main">→</span><span class="skolem">i</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> Inj1 Unit <span class="main">≫</span>"</span></span> <span class="comment1">― ‹verifier execution›</span>
    <span class="keyword1"><span class="command">unfolding</span></span> i_def t_def Suc_eq_plus1 <span class="keyword1"><span class="command">using</span></span> fresh
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smallsteps.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Unauth<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_AuthV<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_UnauthV<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Unauth<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_AuthV<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_UnauthV<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">Unit</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Inj1 Unit"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> verifier2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="main">[</span>Inj2 Unit<span class="main">,</span> Unit<span class="main">]</span><span class="main">,</span> <span class="skolem">t</span> <span class="main">≫</span> V<span class="main">→</span><span class="skolem">i</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> Inj2 Unit <span class="main">≫</span>"</span></span> <span class="comment1">― ‹verifier execution with proofstream containing collision›</span>
    <span class="keyword1"><span class="command">unfolding</span></span> i_def t_def Suc_eq_plus1 <span class="keyword1"><span class="command">using</span></span> fresh
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smallsteps.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Unauth<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_AuthV<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_UnauthV<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> collision<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Unauth<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_AuthV<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_UnauthV<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">Unit</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Inj2 Unit"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> judge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">t</span> <span class="main">:</span> Sum One One"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> t_def <span class="keyword1"><span class="command">using</span></span> fresh
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair fresh_fmap_update<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ideal_deterministic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> Inj1 Unit"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">t</span><span class="main">≫</span> I<span class="main">→</span><span class="skolem">i</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">e</span><span class="main">≫</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">e</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smallsteps_ideal_deterministic<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> i_def t_def Suc_eq_plus1 <span class="keyword1"><span class="command">using</span></span> fresh
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> smallsteps.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Unauth<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_AuthI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_UnauthI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Unauth<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_AuthI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_UnauthI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> s_Let2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">Unit</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Inj1 Unit"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> agree<span class="main">[</span><span class="operator">OF</span> judge_imp_agree<span class="main"><span class="main">[</span></span><span class="operator">OF</span> judge<span class="main"><span class="main">]</span></span> verifier2<span class="main">]</span> collision prover verifier1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e'</span> <span class="skolem">eP'</span>
    <span class="keyword3"><span class="command">assume</span></span> agree<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e'</span><span class="main">,</span> <span class="skolem">eP'</span><span class="main">,</span> Inj2 Unit <span class="main">:</span> Sum One One"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">t</span><span class="main">≫</span> I<span class="main">→</span><span class="skolem">i</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">e'</span><span class="main">≫</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e'</span> <span class="main">=</span> Inj1 Unit"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ideal_deterministic<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> agree <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> no_collision_with_Unit<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Corrected Theorem 1: Security›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> theorem1_security<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π<span class="hidden">⇩</span><sub>A</sub></span><span class="main">,</span> <span class="free">eV</span> <span class="main">≫</span> V<span class="main">→</span><span class="free">i</span> <span class="main">≪</span> <span class="free">π'</span><span class="main">,</span> <span class="free">eV'</span> <span class="main">≫</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">e'</span> <span class="bound">eP'</span> <span class="bound">π</span><span class="main">.</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="free">e</span> <span class="main">≫</span> I<span class="main">→</span><span class="free">i</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="bound">e'</span> <span class="main">≫</span> <span class="main">∧</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="free">eP</span> <span class="main">≫</span> P<span class="main">→</span><span class="free">i</span> <span class="main">≪</span> <span class="bound">π</span><span class="main">,</span> <span class="bound">eP'</span> <span class="main">≫</span> <span class="main">∧</span> <span class="free">π<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">=</span> <span class="bound">π</span> <span class="main">@</span> <span class="free">π'</span> <span class="main">∧</span> <span class="main">{$$}</span> <span class="main">⊢</span> <span class="bound">e'</span><span class="main">,</span> <span class="bound">eP'</span><span class="main">,</span> <span class="free">eV'</span> <span class="main">:</span> <span class="free">τ</span><span class="main">)</span> <span class="main">∨</span>
       <span class="main">(</span><span class="main">∃</span><span class="bound">eP'</span> <span class="bound">j</span> <span class="bound">π<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">π<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">∧</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="free">eP</span> <span class="main">≫</span> P<span class="main">→</span><span class="bound">j</span> <span class="main">≪</span> <span class="bound">π<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">@</span> <span class="main">[</span><span class="bound">s</span><span class="main">]</span><span class="main">,</span> <span class="bound">eP'</span> <span class="main">≫</span> <span class="main">∧</span> <span class="free">π<span class="hidden">⇩</span><sub>A</sub></span> <span class="main">=</span> <span class="bound">π<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">@</span> <span class="main">[</span><span class="bound">s'</span><span class="main">]</span> <span class="main">@</span> <span class="bound">π<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">@</span> <span class="free">π'</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">s'</span> <span class="main">∧</span> hash <span class="bound">s</span> <span class="main">=</span> hash <span class="bound">s'</span> <span class="main">∧</span> closed <span class="bound">s</span> <span class="main">∧</span> closed <span class="bound">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">π<span class="hidden">⇩</span><sub>A</sub></span></span> <span class="quoted"><span class="free">eV</span></span> <span class="quoted">V</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">π'</span></span> <span class="quoted"><span class="free">eV'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallsteps.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Id <span class="skolem">π</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Tr <span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">i</span> <span class="skolem">π<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">π<span class="hidden">⇩</span><sub>3</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="skolem"><span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">π<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">π<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">s'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">e</span><span class="main">≫</span> I<span class="main">→</span><span class="skolem">i</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> <span class="main">∧</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">eP</span><span class="main">≫</span> P<span class="main">→</span><span class="skolem">i</span> <span class="main">≪</span><span class="skolem">π</span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> <span class="main">∧</span> <span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">π</span> <span class="main">@</span> <span class="skolem">π<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="free">τ</span> <span class="main">∨</span>
            <span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">eP</span><span class="main">≫</span> P<span class="main">→</span><span class="skolem">j</span> <span class="main">≪</span><span class="skolem">π<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">@</span> <span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> <span class="main">∧</span> closed <span class="skolem">s</span> <span class="main">∧</span> closed <span class="skolem">s'</span> <span class="main">∧</span> <span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">π<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">@</span> <span class="main">[</span><span class="skolem">s'</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">π<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">@</span> <span class="skolem">π<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="skolem">s'</span> <span class="main">∧</span> hash <span class="skolem">s</span> <span class="main">=</span> hash <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> ok collision<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> ok
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="skolem"><span class="skolem">eP<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="skolem"><span class="skolem">π'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> I<span class="main">→</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">e<span class="hidden">⇩</span><sub>3</sub></span><span class="main">≫</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="skolem">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span><span class="skolem">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">@</span> <span class="skolem">π'</span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>3</sub></span><span class="main">≫</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e<span class="hidden">⇩</span><sub>3</sub></span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>3</sub></span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">:</span> <span class="free">τ</span> <span class="main">∧</span> <span class="skolem">π<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">π'</span> <span class="main">@</span> <span class="skolem">π<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∨</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> closed <span class="bound">s</span> <span class="main">∧</span> closed <span class="bound">s'</span> <span class="main">∧</span> <span class="skolem">π'</span> <span class="main">=</span> <span class="main">[</span><span class="bound">s</span><span class="main">]</span> <span class="main">∧</span> <span class="skolem">π<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="main">[</span><span class="bound">s'</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">π<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">≠</span> <span class="bound">s'</span> <span class="main">∧</span> hash <span class="bound">s</span> <span class="main">=</span> hash <span class="bound">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1"><span class="command">using</span></span> lemma6<span class="main">[</span><span class="operator">OF</span> ok<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> s_Tr<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">thesis</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE conjE exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> ok2 collision<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> ok2
      <span class="keyword1"><span class="command">with</span></span> s_Tr<span class="main">(</span>1<span class="main">,</span>3-<span class="main">)</span> ok <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>collision <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> disjI2 exI conjI<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> ok collision <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">eP</span><span class="main">≫</span> P<span class="main">→</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≪</span><span class="skolem">π</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>3</sub></span><span class="main">≫</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> smallsteps.s_Tr<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> ok collision <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">π</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">s'</span><span class="main">]</span> <span class="main">@</span> <span class="main">[]</span> <span class="main">@</span> <span class="skolem">π<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> collision
    <span class="keyword1"><span class="command">from</span></span> s_Tr<span class="main">(</span>3<span class="main">)</span> collision <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> smallstepV_consumes_proofstream<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> disjI2 exI conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">π<span class="hidden">⇩</span><sub>0</sub>''</span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">π<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">π<span class="hidden">⇩</span><sub>0</sub>''</span> <span class="main">@</span> <span class="skolem">π<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> collision * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">π<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">@</span> <span class="main">[</span><span class="skolem">s'</span><span class="main">]</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">π<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">@</span> <span class="skolem">π<span class="hidden">⇩</span><sub>0</sub>''</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">π<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Remark 1›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> remark1_single<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">πP</span><span class="main">,</span> <span class="free">eP</span> <span class="main">≫</span> P<span class="main">→</span> <span class="main">≪</span> <span class="free">πP</span> <span class="main">@</span> <span class="free">π</span><span class="main">,</span> <span class="free">eP'</span> <span class="main">≫</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">e'</span> <span class="free">eV'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="free">e'</span><span class="main">,</span> <span class="free">eP'</span><span class="main">,</span> <span class="free">eV'</span> <span class="main">:</span> <span class="free">τ</span> <span class="main">∧</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="free">e</span> <span class="main">≫</span> I<span class="main">→</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span> <span class="main">∧</span> <span class="main">≪</span> <span class="free">π</span><span class="main">,</span> <span class="free">eV</span> <span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="free">eV'</span> <span class="main">≫</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">nominal_induct</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span><span class="main">::</span>tyenv"</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">eP</span></span> <span class="quoted"><span class="free">eV</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">avoiding</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">πP</span></span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="free">eP'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> agree.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_App <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_App<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_App_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App1 <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_App<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App2 <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_App<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>AppLam <span class="skolem">x</span> <span class="skolem">eP</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a_App<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Lam <span class="skolem">x</span> <span class="skolem">eP</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> a_Lam_inv_P<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> Lam<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Lam <span class="skolem">v'</span> <span class="skolem">vV'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> a_App<span class="main">(</span>3<span class="main">)</span> AppLam <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> s_AppLam <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> s_AppLam lemma4<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>AppRec <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a_App<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Rec <span class="skolem">x</span> <span class="skolem">e</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> a_Rec_inv_P<span class="main"><span class="main">[</span></span><span class="operator">case_names</span> _ Rec<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Rec <span class="skolem">y</span> <span class="skolem">e''</span> <span class="skolem">eP''</span> <span class="skolem">eV''</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"App <span class="main">(</span>Lam <span class="skolem">y</span> <span class="main">(</span><span class="skolem">e''</span><span class="main">[</span>Rec <span class="skolem">x</span> <span class="main">(</span>Lam <span class="skolem">y</span> <span class="skolem">e''</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?eV</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"App <span class="main">(</span>Lam <span class="skolem">y</span> <span class="main">(</span><span class="skolem">eV''</span><span class="main">[</span>Rec <span class="skolem">x</span> <span class="main">(</span>Lam <span class="skolem">y</span> <span class="skolem">eV''</span><span class="main">)</span> <span class="main">/</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> a_App<span class="main">(</span>3<span class="main">)</span> Rec AppRec <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="var">?e</span><span class="main">,</span> <span class="skolem">eP'</span><span class="main">,</span> <span class="var">?eV</span> <span class="main">:</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> agree.a_App<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{$$}</span>"</span></span><span class="main"><span class="main">]</span></span> lemma4
            <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subst_term.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_term.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> a_App<span class="main">(</span>3<span class="main">)</span> Rec AppRec <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="main">[]</span><span class="main">,</span> App <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> I<span class="main">→</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="var">?e</span><span class="main">≫</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> s_AppRec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> v<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subst_term.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_term.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> fresh_Pair<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> a_App<span class="main">(</span>3<span class="main">)</span> Rec AppRec <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="skolem">π</span><span class="main">,</span> App <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="var">?eV</span><span class="main">≫</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> s_AppRec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> v<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subst_term.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_term.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> fresh_Pair<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Let <span class="skolem">x</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"atom <span class="skolem">x</span> <span class="main">♯</span> <span class="main">(</span><span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">πP</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> a_Let<span class="main">(</span>12<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Let_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Let1
    <span class="keyword1"><span class="command">with</span></span> a_Let <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">∃</span></span></span><span class="bound"><span class="bound"><span class="bound">y</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">Q</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="bound"><span class="bound"><span class="bound">y</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">Q</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> exI<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="main"><span class="main">/</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="main"><span class="main">/</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> lemma4<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let2 <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Let<span class="main">(</span>9<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="skolem"><span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub>'</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">:</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span><span class="main">≫</span> I<span class="main">→</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">≫</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="skolem">π</span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span><span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">≫</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> a_Let Let2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> value <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> value <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> value <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Let2 a_Let<span class="main">(</span>2<span class="main">,</span>5<span class="main">,</span>7<span class="main">,</span>10<span class="main">)</span> ih <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">∃</span></span></span><span class="bound"><span class="bound"><span class="bound">y</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">Q</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="bound"><span class="bound"><span class="bound">y</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">Q</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> exI<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Let <span class="skolem"><span class="skolem"><span class="skolem">e<span class="hidden">⇩</span><sub>1</sub>'</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Let <span class="skolem"><span class="skolem"><span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub>'</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_Pair <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> agree.a_Let <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> agree.a_Let<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Case <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Case<span class="main">(</span>7<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Case_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Case <span class="skolem">eP''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Case<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inj1 <span class="skolem">v</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Case<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inj2 <span class="skolem">v</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Case<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Prj1 <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">πP</span> <span class="skolem">π</span> <span class="skolem">eP'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Prj1<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Prj1_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prj1 <span class="skolem">eP''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Prj1<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PrjPair1 <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Prj1<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Prj2 <span class="skolem">v</span> <span class="skolem">vP</span> <span class="skolem">vV</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Prj2<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Prj2_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prj2 <span class="skolem">eP''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Prj2<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PrjPair2 <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Prj2<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Roll <span class="skolem">α</span> <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Roll<span class="main">(</span>7<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Roll_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Roll <span class="skolem">eP''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Roll<span class="main">(</span>4<span class="main">,</span>5<span class="main">,</span>6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Unroll <span class="skolem">α</span> <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Unroll<span class="main">(</span>7<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Unroll_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Unroll <span class="skolem">eP''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Unroll<span class="main">(</span>5<span class="main">,</span>6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> UnrollRoll
    <span class="keyword1"><span class="command">with</span></span> a_Unroll<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Auth <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Auth<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_AuthP_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Auth <span class="skolem">eP''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Auth<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> a_Auth<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">πP</span></span> <span class="quoted"><span class="skolem">π</span></span> <span class="quoted"><span class="skolem">eP''</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> AuthP
    <span class="keyword1"><span class="command">with</span></span> a_Auth<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lemma2_1 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Hash <span class="main">(</span>hash <span class="main">⦇</span><span class="skolem">eP</span><span class="main">⦈</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">e</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Unauth <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Unauth<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> eP_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"closed <span class="skolem">eP</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> agree_empty_fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> a_Unauth<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_UnauthP_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Unauth <span class="skolem">e'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Unauth<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>UnauthP <span class="skolem">h</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Unauth<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> eP_closed <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> a_AuthT_value_inv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> a_Unauth<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fresh_shallow<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Inj1 <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Inj1<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Inj1_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inj1 <span class="skolem">eP''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Inj1<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Inj2 <span class="skolem">e</span> <span class="skolem">eP</span> <span class="skolem">eV</span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Inj2<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Inj2_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inj2 <span class="skolem">eP''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Inj2<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>a_Pair <span class="skolem">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">τ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> a_Pair<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> s_Pair_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair1 <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Pair<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair2 <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a_Pair<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> value_no_step<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> remark1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">,</span> <span class="free">eP</span><span class="main">,</span> <span class="free">eV</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π<span class="hidden">⇩</span><sub>P</sub></span><span class="main">,</span> <span class="free">eP</span> <span class="main">≫</span> P<span class="main">→</span><span class="free">i</span> <span class="main">≪</span> <span class="free">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">@</span> <span class="free">π</span><span class="main">,</span> <span class="free">eP'</span> <span class="main">≫</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">e'</span> <span class="free">eV'</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="free">e'</span><span class="main">,</span> <span class="free">eP'</span><span class="main">,</span> <span class="free">eV'</span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="free">e</span> <span class="main">≫</span> I<span class="main">→</span><span class="free">i</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="free">e'</span> <span class="main">≫</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span> <span class="free">π</span><span class="main">,</span> <span class="free">eV</span> <span class="main">≫</span> V<span class="main">→</span><span class="free">i</span> <span class="main">≪</span> <span class="main">[]</span><span class="main">,</span> <span class="free">eV'</span> <span class="main">≫</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">nominal_induct</span> <span class="quoted"><span class="free">π<span class="hidden">⇩</span><sub>P</sub></span></span> <span class="quoted"><span class="free">eP</span></span> <span class="quoted">P</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"<span class="free">π<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">@</span> <span class="free">π</span>"</span></span> <span class="quoted"><span class="free">eP'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">π</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> smallsteps.strong_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Id <span class="skolem">e</span> <span class="skolem">πP</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> s_Id_inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_Tr <span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">i</span> <span class="skolem">π<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">eP<span class="hidden">⇩</span><sub>3</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s_Tr <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π'</span></span> <span class="skolem"><span class="skolem">π''</span></span> <span class="keyword2"><span class="keyword">where</span></span> ps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">π<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">π<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">π'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">=</span> <span class="skolem">π'</span> <span class="main">@</span> <span class="skolem">π''</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> smallstepP_generates_proofstream smallstepsP_generates_proofstream<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> s_Tr <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="skolem"><span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">e</span><span class="main">≫</span> I<span class="main">→</span><span class="skolem">i</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="skolem">π'</span><span class="main">,</span> <span class="free">eV</span><span class="main">≫</span> V<span class="main">→</span><span class="skolem">i</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> s_Tr<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">π'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="skolem"><span class="skolem">eV<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> agree<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{$$}</span> <span class="main">⊢</span> <span class="skolem">e<span class="hidden">⇩</span><sub>3</sub></span><span class="main">,</span> <span class="skolem">eP<span class="hidden">⇩</span><sub>3</sub></span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> I<span class="main">→</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">e<span class="hidden">⇩</span><sub>3</sub></span><span class="main">≫</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="skolem">π''</span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>2</sub></span><span class="main">≫</span> V<span class="main">→</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>3</sub></span><span class="main">≫</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> remark1_single<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ih<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> smallstepP_ps_prepend s_Tr<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ps<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="free">e</span><span class="main">≫</span> I<span class="main">→</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">e<span class="hidden">⇩</span><sub>3</sub></span><span class="main">≫</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">≪</span><span class="skolem">π</span><span class="main">,</span> <span class="free">eV</span><span class="main">≫</span> V<span class="main">→</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≪</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">eV<span class="hidden">⇩</span><sub>3</sub></span><span class="main">≫</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> smallstepsV_ps_append<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ps
       <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> smallsteps.s_Tr<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">V</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> π<span class="hidden">⇩</span><sub>1</sub><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">π'</span> <span class="main">@</span> <span class="skolem">π''</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> π<span class="hidden">⇩</span><sub>2</sub><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">π''</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> agree <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span></pre>
</div>