<div id="DPT_SAT_Solver">
<div class="head">
<h1>Theory DPT_SAT_Solver</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       DPT (Decision Procedure Toolkit) SAT solver ported to SML
    Author:      Armin Heller, 2008
    Maintainer:  Jasmin Blanchette &lt;blanchette at in.tum.de&gt;
*)</span>

<span class="keyword1"><span class="command">theory</span></span> DPT_SAT_Solver
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹dpt_sat_solver.ML›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/dpt_sat_solver.ML">
<div class="head">
<h1>File ‹dpt_sat_solver.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       DPT (Decision Procedure Toolkit) SAT solver ported to SML
    Author:      Armin Heller, TU Muenchen
    Maintainer:  Jasmin Blanchette &lt;blanchette at in.tum.de&gt;
*)</span>

<span class="comment1">(* Ported to Standard ML by Armin Heller. The original OCaml files are
available from http://sourceforge.net/projects/dpt/.

Original copyright notice from the OCaml sources: 

 Copyright 2007 Intel Corporation 

 Licensed under the Apache License, Version 2.0 (the "License"); you
 may not use this file except in compliance with the License.  You
 may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
 implied.  See the License for the specific language governing
 permissions and limitations under the License. *)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">DPT_SAT_SOLVER</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">solver</span>
  <span class="keyword1"><span class="keyword">val</span></span> empty_solver <span class="main">:</span> unit <span class="main">-&gt;</span> <span class="entity">solver</span>
  <span class="keyword1"><span class="keyword">val</span></span> init <span class="main">:</span> <span class="entity">solver</span> <span class="main">-&gt;</span> int list list <span class="main">-&gt;</span> unit
  <span class="keyword1"><span class="keyword">val</span></span> solve <span class="main">:</span> <span class="entity">solver</span> <span class="main">-&gt;</span> unit
  <span class="keyword1"><span class="keyword">val</span></span> satisfied <span class="main">:</span> <span class="entity">solver</span> <span class="main">-&gt;</span> bool
  <span class="keyword1"><span class="keyword">val</span></span> assignment <span class="main">:</span> <span class="entity">solver</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> bool option
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">DPT_SAT_Solver</span> <span class="main">:</span> <span class="entity">DPT_SAT_SOLVER</span> <span class="main">=</span> 
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Vec</span> <span class="main">=</span> 
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">limit_for</span> <span class="entity">x</span> <span class="main">=</span> Array.maxLen

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">capacity_for</span> <span class="entity">n</span> <span class="entity">x</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span><span class="entity">n</span> &gt; Array.maxLen<span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> 
       error <span class="inner_quoted">"capacity_for: Invalid_argument \"exceeds limit\""</span>
   <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">;</span>
   Int.max <span class="main">(</span><span class="inner_numeral">1</span><span class="main">,</span> <span class="entity">n</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">capacity_atleast</span> <span class="entity">m</span> <span class="entity">n</span> <span class="entity">x</span> <span class="main">=</span> 
<span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">result</span> <span class="main">=</span> Int.min <span class="main">(</span><span class="entity">limit_for</span> <span class="entity">x</span><span class="main">,</span> <span class="main">(</span>Int.max <span class="main">(</span><span class="inner_numeral">2</span> * <span class="entity">n</span><span class="main">,</span> <span class="entity">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span><span class="entity">m</span> &gt; <span class="entity">result</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
       error <span class="inner_quoted">"capacity_atleast: Invalid_argument \"exceeds limit\""</span>
   <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">;</span>
   <span class="entity">result</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_make</span> <span class="entity">size</span> <span class="entity">x</span> <span class="entity">cap</span> <span class="entity">triv</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">a</span> <span class="main">=</span> Array.array <span class="main">(</span><span class="entity">cap</span><span class="main">,</span> <span class="entity">triv</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n</span> <span class="main">=</span> Unsynchronized.ref <span class="inner_numeral">0</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">while</span></span> !<span class="entity">n</span> &lt; <span class="entity">size</span> <span class="keyword2"><span class="keyword">do</span></span>
     <span class="main">(</span>
         Array.update <span class="main">(</span><span class="entity">a</span><span class="main">,</span> !<span class="entity">n</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span> <span class="main">;</span>
         <span class="entity">n</span> := !<span class="entity">n</span> + <span class="inner_numeral">1</span>
     <span class="main">)</span> <span class="main">;</span>
     <span class="entity">a</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_init</span> <span class="entity">size</span> <span class="entity">f</span> <span class="entity">cap</span> <span class="entity">triv</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">a</span> <span class="main">=</span> Array.array <span class="main">(</span><span class="entity">cap</span><span class="main">,</span> <span class="entity">triv</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n</span> <span class="main">=</span> Unsynchronized.ref <span class="inner_numeral">0</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">while</span></span> !<span class="entity">n</span> &lt; <span class="entity">size</span> <span class="keyword2"><span class="keyword">do</span></span>
     <span class="main">(</span>
         Array.update <span class="main">(</span><span class="entity">a</span><span class="main">,</span> !<span class="entity">n</span><span class="main">,</span> <span class="entity">f</span> <span class="main">(</span>!<span class="entity">n</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
         <span class="entity">n</span> := !<span class="entity">n</span> + <span class="inner_numeral">1</span>
     <span class="main">)</span> <span class="main">;</span>
     <span class="entity">a</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_extend</span> <span class="entity">a</span> <span class="entity">size</span> <span class="entity">cap</span> <span class="entity">triv</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">a'</span> <span class="main">=</span> Array.array <span class="main">(</span><span class="entity">cap</span><span class="main">,</span> <span class="entity">triv</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> ArraySlice.copy <span class="main">{</span>src <span class="main">=</span> ArraySlice.slice <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">,</span> SOME <span class="entity">size</span><span class="main">)</span><span class="main">,</span> 
                      dst <span class="main">=</span> <span class="entity">a'</span><span class="main">,</span> 
                      di <span class="main">=</span> <span class="inner_numeral">0</span><span class="main">}</span> <span class="main">;</span> <span class="entity">a'</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_top</span> <span class="entity">a</span> <span class="entity">size</span> <span class="main">=</span> Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">size</span> - <span class="inner_numeral">1</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_pop</span> <span class="entity">a</span> <span class="entity">size</span> <span class="entity">triv</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">last</span> <span class="main">=</span> <span class="entity">size</span> - <span class="inner_numeral">1</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">result</span> <span class="main">=</span> Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">last</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> Array.update <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">last</span><span class="main">,</span> <span class="entity">triv</span><span class="main">)</span> <span class="main">;</span>
     <span class="entity">result</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_push</span> <span class="entity">a</span> <span class="entity">size</span> <span class="entity">x</span> <span class="main">=</span> Array.update <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">size</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_delete</span> <span class="entity">a</span> <span class="entity">size</span> <span class="entity">i</span> <span class="entity">triv</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">last</span> <span class="main">=</span> <span class="entity">size</span> - <span class="inner_numeral">1</span>
  <span class="keyword2"><span class="keyword">in</span></span> ArraySlice.copy <span class="main">{</span>src <span class="main">=</span> ArraySlice.slice <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">,</span> SOME <span class="main">(</span><span class="entity">last</span> - <span class="entity">i</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
                      dst <span class="main">=</span> <span class="entity">a</span><span class="main">,</span> 
                      di <span class="main">=</span> <span class="entity">i</span><span class="main">}</span> <span class="main">;</span>
     <span class="entity">last</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_swap_out</span> <span class="entity">a</span> <span class="entity">size</span> <span class="entity">i</span> <span class="entity">triv</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">last</span> <span class="main">=</span> <span class="entity">size</span> - <span class="inner_numeral">1</span>
  <span class="keyword2"><span class="keyword">in</span></span> Array.update <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">i</span><span class="main">,</span> Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">last</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
     Array.update <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">last</span><span class="main">,</span> <span class="entity">triv</span><span class="main">)</span> <span class="main">;</span>
     <span class="entity">last</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_insert</span> <span class="entity">a</span> <span class="entity">size</span> <span class="entity">i</span> <span class="entity">x</span> <span class="main">=</span> 
  <span class="main">(</span>ArraySlice.copy <span class="main">{</span>src <span class="main">=</span> ArraySlice.slice <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">i</span><span class="main">,</span> SOME <span class="main">(</span><span class="entity">size</span> - <span class="entity">i</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
                    dst <span class="main">=</span> <span class="entity">a</span><span class="main">,</span> 
                    di <span class="main">=</span> <span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">}</span> <span class="main">;</span>
   Array.update <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">i</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_fast_filter</span> <span class="entity">p</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">size</span> <span class="entity">triv</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> <span class="main">=</span> <span class="entity">size</span> <span class="keyword2"><span class="keyword">then</span></span> 
      <span class="entity">size</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="entity">array_fast_filter</span> <span class="entity">p</span> <span class="entity">a</span> <span class="main">(</span><span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">size</span> <span class="entity">triv</span>
  <span class="keyword2"><span class="keyword">else</span></span>
  <span class="main">(</span>
      Array.update <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">i</span><span class="main">,</span> Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">size</span> - <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
      Array.update <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">size</span> - <span class="inner_numeral">1</span><span class="main">,</span> <span class="entity">triv</span><span class="main">)</span> <span class="main">;</span>
      <span class="entity">array_fast_filter</span> <span class="entity">p</span> <span class="entity">a</span> <span class="entity">i</span> <span class="main">(</span><span class="entity">size</span> - <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">triv</span>
  <span class="main">)</span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_fast_filter_const</span> <span class="entity">p</span> <span class="entity">x</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">size</span> <span class="entity">triv</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> <span class="main">=</span> <span class="entity">size</span> <span class="keyword2"><span class="keyword">then</span></span> 
  <span class="entity">size</span>
<span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p</span> <span class="entity">x</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
  <span class="entity">array_fast_filter_const</span> <span class="entity">p</span> <span class="entity">x</span> <span class="entity">a</span> <span class="main">(</span><span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">size</span> <span class="entity">triv</span>
<span class="keyword2"><span class="keyword">else</span></span>
<span class="main">(</span>
  Array.update <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">i</span><span class="main">,</span> Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">size</span> - <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
  Array.update <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">size</span> - <span class="inner_numeral">1</span><span class="main">,</span> <span class="entity">triv</span><span class="main">)</span> <span class="main">;</span>
  <span class="entity">array_fast_filter_const</span> <span class="entity">p</span> <span class="entity">x</span> <span class="entity">a</span> <span class="entity">i</span> <span class="main">(</span><span class="entity">size</span> - <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">triv</span>
<span class="main">)</span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_first_not</span> <span class="entity">p</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">size</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> <span class="main">=</span> <span class="entity">size</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">size</span> 
<span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span><span class="entity">p</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">i</span>
<span class="keyword2"><span class="keyword">else</span></span> <span class="entity">array_first_not</span> <span class="entity">p</span> <span class="entity">a</span> <span class="main">(</span><span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">size</span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_first_not2</span> <span class="entity">p</span> <span class="entity">x</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">size</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> <span class="main">=</span> <span class="entity">size</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">size</span> 
<span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span><span class="entity">p</span> <span class="entity">x</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">i</span> 
<span class="keyword2"><span class="keyword">else</span></span> <span class="entity">array_first_not2</span> <span class="entity">p</span> <span class="entity">x</span> <span class="entity">a</span> <span class="main">(</span><span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">size</span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_first_noti</span> <span class="entity">p</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">size</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> <span class="main">=</span> <span class="entity">size</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">size</span>
<span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span><span class="entity">p</span> <span class="entity">i</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">i</span>
<span class="keyword2"><span class="keyword">else</span></span> <span class="entity">array_first_noti</span> <span class="entity">p</span> <span class="entity">a</span> <span class="main">(</span><span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">size</span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_first_noti2</span> <span class="entity">p</span> <span class="entity">x</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">size</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> <span class="main">=</span> <span class="entity">size</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">size</span>
<span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span><span class="entity">p</span> <span class="entity">x</span> <span class="entity">i</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">i</span>
<span class="keyword2"><span class="keyword">else</span></span> <span class="entity">array_first_noti2</span> <span class="entity">p</span> <span class="entity">x</span> <span class="entity">a</span> <span class="main">(</span><span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">size</span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_filter</span> <span class="entity">p</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">size</span> <span class="entity">triv</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">j</span> <span class="main">=</span> Unsynchronized.ref <span class="main">(</span><span class="entity">array_first_not</span> <span class="entity">p</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">size</span><span class="main">)</span> 
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">k</span> <span class="main">=</span> Unsynchronized.ref <span class="main">(</span>!<span class="entity">j</span> + <span class="inner_numeral">1</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">while</span></span> !<span class="entity">k</span> &lt; <span class="entity">size</span> <span class="keyword2"><span class="keyword">do</span></span>
    <span class="main">(</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">x</span> <span class="main">=</span> Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> !<span class="entity">k</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p</span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">then</span></span>
           <span class="main">(</span>
                     Array.update <span class="main">(</span><span class="entity">a</span><span class="main">,</span> !<span class="entity">j</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span> <span class="main">;</span>
                     <span class="entity">j</span> := !<span class="entity">j</span> + <span class="inner_numeral">1</span>
                 <span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">;</span> 
           <span class="entity">k</span> := !<span class="entity">k</span> + <span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">)</span> <span class="main">;</span>
    <span class="entity">k</span> := !<span class="entity">j</span> <span class="main">;</span>
    <span class="keyword2"><span class="keyword">while</span></span> !<span class="entity">k</span> &lt; <span class="entity">size</span> <span class="keyword2"><span class="keyword">do</span></span>
    <span class="main">(</span>
        Array.update <span class="main">(</span><span class="entity">a</span><span class="main">,</span> !<span class="entity">k</span><span class="main">,</span> <span class="entity">triv</span><span class="main">)</span> <span class="main">;</span>
        <span class="entity">k</span> := !<span class="entity">k</span> + <span class="inner_numeral">1</span>
    <span class="main">)</span> <span class="main">;</span>
    !<span class="entity">j</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_filter_const</span> <span class="entity">p</span> <span class="entity">x</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">size</span> <span class="entity">triv</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">j</span> <span class="main">=</span> Unsynchronized.ref <span class="main">(</span><span class="entity">array_first_not2</span> <span class="entity">p</span> <span class="entity">x</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">size</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">k</span> <span class="main">=</span> Unsynchronized.ref <span class="main">(</span>!<span class="entity">j</span> + <span class="inner_numeral">1</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">while</span></span> !<span class="entity">k</span> &lt; <span class="entity">size</span> <span class="keyword2"><span class="keyword">do</span></span>
    <span class="main">(</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">y</span> <span class="main">=</span> Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> !<span class="entity">k</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p</span> <span class="entity">x</span> <span class="entity">y</span> <span class="keyword2"><span class="keyword">then</span></span>
           <span class="main">(</span>
                     Array.update <span class="main">(</span><span class="entity">a</span><span class="main">,</span> !<span class="entity">j</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span> <span class="main">;</span>
                     <span class="entity">j</span> := !<span class="entity">j</span> + <span class="inner_numeral">1</span>
                 <span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">)</span> <span class="main">;</span>
    <span class="entity">k</span> := !<span class="entity">j</span> <span class="main">;</span>
    <span class="keyword2"><span class="keyword">while</span></span> !<span class="entity">k</span> &lt; <span class="entity">size</span> <span class="keyword2"><span class="keyword">do</span></span>
    <span class="main">(</span>
        Array.update <span class="main">(</span><span class="entity">a</span><span class="main">,</span> !<span class="entity">k</span><span class="main">,</span> <span class="entity">triv</span><span class="main">)</span> <span class="main">;</span>
        <span class="entity">k</span> := !<span class="entity">k</span> + <span class="inner_numeral">1</span>
    <span class="main">)</span> <span class="main">;</span>
    !<span class="entity">j</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_filteri</span> <span class="entity">p</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">size</span> <span class="entity">triv</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">j</span> <span class="main">=</span> Unsynchronized.ref <span class="main">(</span><span class="entity">array_first_noti</span> <span class="entity">p</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">size</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">k</span> <span class="main">=</span> Unsynchronized.ref <span class="main">(</span>!<span class="entity">j</span> + <span class="inner_numeral">1</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">while</span></span> !<span class="entity">k</span> &lt; <span class="entity">size</span> <span class="keyword2"><span class="keyword">do</span></span>
    <span class="main">(</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">x</span> <span class="main">=</span> Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> !<span class="entity">k</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
                  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p</span> <span class="main">(</span>!<span class="entity">k</span><span class="main">)</span> <span class="entity">x</span> <span class="keyword2"><span class="keyword">then</span></span>
            <span class="main">(</span>
                      Array.update <span class="main">(</span><span class="entity">a</span><span class="main">,</span> !<span class="entity">j</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span> <span class="main">;</span>
                      <span class="entity">j</span> := !<span class="entity">j</span> + <span class="inner_numeral">1</span>
                  <span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">;</span>
            <span class="entity">k</span> := !<span class="entity">k</span> + <span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">)</span> <span class="main">;</span>
    <span class="entity">k</span> := !<span class="entity">j</span> <span class="main">;</span>
    <span class="keyword2"><span class="keyword">while</span></span> !<span class="entity">k</span> &lt; <span class="entity">size</span> <span class="keyword2"><span class="keyword">do</span></span>
    <span class="main">(</span>
        Array.update <span class="main">(</span><span class="entity">a</span><span class="main">,</span> !<span class="entity">k</span><span class="main">,</span> <span class="entity">triv</span><span class="main">)</span> <span class="main">;</span>
        <span class="entity">k</span> := !<span class="entity">k</span> + <span class="inner_numeral">1</span>
    <span class="main">)</span> <span class="main">;</span>
    !<span class="entity">j</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_filteri_const</span> <span class="entity">p</span> <span class="entity">x</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">size</span> <span class="entity">triv</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">j</span> <span class="main">=</span> Unsynchronized.ref <span class="main">(</span><span class="entity">array_first_noti2</span> <span class="entity">p</span> <span class="entity">x</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">size</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">k</span> <span class="main">=</span> Unsynchronized.ref <span class="main">(</span>!<span class="entity">j</span> + <span class="inner_numeral">1</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">while</span></span> !<span class="entity">k</span> &lt; <span class="entity">size</span> <span class="keyword2"><span class="keyword">do</span></span>
    <span class="main">(</span>
        <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">y</span> <span class="main">=</span> Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> !<span class="entity">k</span><span class="main">)</span> 
        <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p</span> <span class="entity">x</span> <span class="main">(</span>!<span class="entity">k</span><span class="main">)</span> <span class="entity">y</span> <span class="keyword2"><span class="keyword">then</span></span>
           <span class="main">(</span>
                     Array.update <span class="main">(</span><span class="entity">a</span><span class="main">,</span> !<span class="entity">j</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span> <span class="main">;</span>
                     <span class="entity">j</span> := !<span class="entity">j</span> + <span class="inner_numeral">1</span>
           <span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
    <span class="main">)</span> <span class="main">;</span>
    <span class="entity">k</span> := !<span class="entity">j</span> <span class="main">;</span>
    <span class="keyword2"><span class="keyword">while</span></span> !<span class="entity">k</span> &lt; <span class="entity">size</span> <span class="keyword2"><span class="keyword">do</span></span>
    <span class="main">(</span>
        Array.update <span class="main">(</span><span class="entity">a</span><span class="main">,</span> !<span class="entity">k</span><span class="main">,</span> <span class="entity">triv</span><span class="main">)</span> <span class="main">;</span>
        <span class="entity">k</span> := !<span class="entity">k</span> + <span class="inner_numeral">1</span>
    <span class="main">)</span> <span class="main">;</span>
    !<span class="entity">j</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">subarray_first</span> <span class="entity">p</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">j</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> <span class="main">=</span> <span class="entity">j</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">j</span> 
<span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">i</span>
<span class="keyword2"><span class="keyword">else</span></span> <span class="entity">subarray_first</span> <span class="entity">p</span> <span class="entity">a</span> <span class="main">(</span><span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">j</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">subarray_first_const</span> <span class="entity">p</span> <span class="entity">x</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">j</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> <span class="main">=</span> <span class="entity">j</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">j</span> 
<span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">p</span> <span class="entity">x</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">i</span> 
<span class="keyword2"><span class="keyword">else</span></span> <span class="entity">subarray_first_const</span> <span class="entity">p</span> <span class="entity">x</span> <span class="entity">a</span> <span class="main">(</span><span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">j</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_first</span> <span class="entity">p</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">j</span> <span class="main">=</span> 
<span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">result</span> <span class="main">=</span> <span class="entity">subarray_first</span> <span class="entity">p</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">j</span>
<span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">result</span> <span class="main">=</span> <span class="entity">j</span> <span class="keyword2"><span class="keyword">then</span></span> error <span class="inner_quoted">"array_first: Not_found"</span>
   <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">result</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_first_const</span> <span class="entity">p</span> <span class="entity">x</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">j</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">result</span> <span class="main">=</span> <span class="entity">subarray_first_const</span> <span class="entity">p</span> <span class="entity">x</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">j</span>
<span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">result</span> <span class="main">=</span> <span class="entity">j</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="keyword3"><span class="keyword">raise</span></span> error <span class="inner_quoted">"array_first: Not_found"</span>
   <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">result</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">t</span> <span class="main">=</span> 
   <span class="main">{</span>contents <span class="main">:</span> 'a array Unsynchronized.ref<span class="main">,</span> 
    size <span class="main">:</span> int Unsynchronized.ref<span class="main">,</span> 
    dummy<span class="main">:</span> 'a<span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">make</span> <span class="entity">n</span> <span class="entity">x</span> <span class="entity">triv</span> <span class="main">=</span> 
  <span class="main">{</span>contents <span class="main">=</span> Unsynchronized.ref <span class="main">(</span><span class="entity">array_make</span> <span class="entity">n</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">capacity_for</span> <span class="entity">n</span> <span class="entity">triv</span><span class="main">)</span> <span class="entity">triv</span><span class="main">)</span><span class="main">,</span> 
   size <span class="main">=</span> Unsynchronized.ref <span class="entity">n</span><span class="main">,</span>
   dummy <span class="main">=</span> <span class="entity">triv</span><span class="main">}</span> <span class="main">:</span> 'a <span class="entity">t</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">create</span> <span class="main">=</span> <span class="entity">make</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">init</span> <span class="entity">n</span> <span class="entity">f</span> <span class="entity">triv</span> <span class="main">=</span> 
  <span class="main">{</span>contents <span class="main">=</span> Unsynchronized.ref <span class="main">(</span><span class="entity">array_init</span> <span class="entity">n</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">capacity_for</span> <span class="entity">n</span> <span class="entity">triv</span><span class="main">)</span> <span class="entity">triv</span><span class="main">)</span><span class="main">,</span> 
   size <span class="main">=</span> Unsynchronized.ref <span class="entity">n</span><span class="main">,</span> 
   dummy <span class="main">=</span> <span class="entity">triv</span><span class="main">}</span> <span class="main">:</span> 'a <span class="entity">t</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">copy</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> 
<span class="main">{</span>contents <span class="main">=</span> Unsynchronized.ref <span class="main">(</span>Array.tabulate
                     <span class="main">(</span>Array.length <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
                      <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">i</span> <span class="main">=&gt;</span> Array.sub <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
 size <span class="main">=</span> Unsynchronized.ref <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
 dummy <span class="main">=</span> <span class="main">(</span><span class="main">#</span>dummy <span class="entity">v</span><span class="main">)</span><span class="main">}</span> <span class="main">:</span> 'a <span class="entity">t</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">capacity_above</span> <span class="entity">n</span> <span class="entity">x</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">result</span> <span class="main">=</span> Int.min <span class="main">(</span><span class="entity">limit_for</span> <span class="entity">x</span><span class="main">,</span> <span class="inner_numeral">2</span> * <span class="entity">n</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span><span class="entity">n</span> &gt;= <span class="entity">result</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
      error <span class="inner_quoted">"capacity_above: Invalid_argument \"exceeds limit\""</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">;</span>
  <span class="entity">result</span> <span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ensure_cap</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cap</span> <span class="main">=</span> Array.length <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> 
<span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> !<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span> <span class="main">=</span> <span class="entity">cap</span> <span class="keyword2"><span class="keyword">then</span></span>
       <span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span> := <span class="entity">array_extend</span> 
                            <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="entity">cap</span> 
                            <span class="main">(</span><span class="entity">capacity_above</span> <span class="entity">cap</span> <span class="main">(</span><span class="main">#</span>dummy <span class="entity">v</span><span class="main">)</span><span class="main">)</span> 
                            <span class="main">(</span><span class="main">#</span>dummy <span class="entity">v</span><span class="main">)</span>
   <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">of_array</span> <span class="entity">a</span> <span class="entity">triv</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n</span> <span class="main">=</span> Array.length <span class="entity">a</span>
<span class="keyword2"><span class="keyword">in</span></span> <span class="main">{</span>contents <span class="main">=</span> Unsynchronized.ref <span class="main">(</span><span class="entity">array_extend</span> <span class="entity">a</span> <span class="entity">n</span> <span class="main">(</span><span class="entity">capacity_for</span> <span class="entity">n</span> <span class="entity">triv</span><span class="main">)</span> <span class="entity">triv</span><span class="main">)</span><span class="main">,</span> 
          size <span class="main">=</span> Unsynchronized.ref <span class="entity">n</span><span class="main">,</span> 
          dummy <span class="main">=</span> <span class="entity">triv</span><span class="main">}</span> <span class="main">:</span> 'a <span class="entity">t</span> <span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">of_list</span> <span class="entity">l</span> <span class="entity">triv</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n</span> <span class="main">=</span> length <span class="entity">l</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">a</span> <span class="main">=</span> Array.array <span class="main">(</span><span class="entity">capacity_for</span> <span class="entity">n</span> <span class="entity">triv</span><span class="main">,</span> <span class="entity">triv</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">init</span> <span class="entity">i</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="main">)</span>
      <span class="main">|</span> <span class="entity">init</span> <span class="entity">i</span> <span class="main">(</span><span class="entity">h</span> :: <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Array.update <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">i</span><span class="main">,</span> <span class="entity">h</span><span class="main">)</span> <span class="main">;</span> 
                           <span class="entity">init</span> <span class="main">(</span><span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">t</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">in</span></span> <span class="entity">init</span> <span class="inner_numeral">0</span> <span class="entity">l</span> <span class="main">;</span>
   <span class="main">{</span>contents <span class="main">=</span> Unsynchronized.ref <span class="entity">a</span><span class="main">,</span> 
          size <span class="main">=</span> Unsynchronized.ref <span class="entity">n</span><span class="main">,</span> 
          dummy <span class="main">=</span> <span class="entity">triv</span><span class="main">}</span> <span class="main">:</span> 'a <span class="entity">t</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">to_array</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> 
<span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">a</span> <span class="main">=</span> Array.array <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">,</span> <span class="main">#</span>dummy <span class="entity">v</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">in</span></span> ArraySlice.copy <span class="main">{</span>src <span class="main">=</span> ArraySlice.slice 
                              <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">,</span> SOME <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
                    dst <span class="main">=</span> <span class="entity">a</span><span class="main">,</span> di <span class="main">=</span> <span class="inner_numeral">0</span><span class="main">}</span> <span class="main">;</span> <span class="entity">a</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">to_list</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> 
  ArraySlice.foldr <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> ::<span class="main">)</span> <span class="main">[</span><span class="main">]</span> 
                   <span class="main">(</span>ArraySlice.slice 
                        <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">,</span> SOME <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">length</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> !<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_empty</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> !<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span> <span class="main">=</span> <span class="inner_numeral">0</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">grow</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="entity">n</span> <span class="entity">x</span> <span class="main">=</span> 
<span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cap</span> <span class="main">=</span> Array.length <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span> &gt; <span class="entity">cap</span> <span class="keyword2"><span class="keyword">then</span></span> 
   <span class="main">(</span>
       <span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span> :=
       <span class="entity">array_extend</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span> 
                          <span class="main">(</span><span class="entity">capacity_atleast</span> <span class="entity">n</span> <span class="entity">cap</span> <span class="main">(</span><span class="main">#</span>dummy <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span>dummy <span class="entity">v</span><span class="main">)</span>
   <span class="main">)</span>
   <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">;</span>
   ArraySlice.modify <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">x</span><span class="main">)</span>
                     <span class="main">(</span>ArraySlice.slice <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">,</span> 
                                        !<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">,</span> 
                                        SOME <span class="main">(</span><span class="entity">n</span> - !<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
   <span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span> := <span class="entity">n</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">grow_init</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="entity">n</span> <span class="entity">f</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cap</span> <span class="main">=</span> Array.length <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span> &gt; <span class="entity">cap</span> <span class="keyword2"><span class="keyword">then</span></span> 
   <span class="main">(</span>
       <span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span> :=
       <span class="entity">array_extend</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span> 
                          <span class="main">(</span><span class="entity">capacity_atleast</span> <span class="entity">n</span> <span class="entity">cap</span> <span class="main">(</span><span class="main">#</span>dummy <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span>dummy <span class="entity">v</span><span class="main">)</span>
   <span class="main">)</span>
   <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">;</span>
   ArraySlice.modify <span class="entity">f</span> 
                     <span class="main">(</span>ArraySlice.slice <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">,</span> 
                                        !<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">,</span> 
                                        SOME <span class="main">(</span><span class="entity">n</span> - !<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
   <span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span> := <span class="entity">n</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">shrink</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="entity">n</span> <span class="main">=</span>
  <span class="main">(</span>ArraySlice.modify <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">#</span>dummy <span class="entity">v</span><span class="main">)</span>
                     <span class="main">(</span>ArraySlice.slice <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">,</span> <span class="entity">n</span><span class="main">,</span> 
                                        SOME <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span> - <span class="entity">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
   <span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span> := <span class="entity">n</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">clear</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">shrink</span> <span class="entity">v</span> <span class="inner_numeral">0</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">get</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="entity">i</span> <span class="main">=</span> Array.sub <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">set</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">x</span> <span class="main">=</span> Array.update <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">,</span> <span class="entity">i</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">set_all</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">j</span> <span class="entity">x</span> <span class="main">=</span> 
  ArraySlice.modify <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">x</span><span class="main">)</span>
                    <span class="main">(</span>ArraySlice.slice <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">,</span> 
                                       <span class="entity">i</span><span class="main">,</span> SOME <span class="main">(</span><span class="entity">j</span> - <span class="entity">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">top</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">array_top</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pop</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">result</span> <span class="main">=</span> <span class="entity">array_pop</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span>dummy <span class="entity">v</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span> := !<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span> - <span class="inner_numeral">1</span> <span class="main">;</span>
   <span class="entity">result</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">push</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="entity">x</span> <span class="main">=</span> 
  <span class="main">(</span><span class="entity">ensure_cap</span> <span class="entity">v</span> <span class="main">;</span>
   <span class="entity">array_push</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="entity">x</span> <span class="main">;</span>
   <span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span> := !<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span> + <span class="inner_numeral">1</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">insert</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">x</span> <span class="main">=</span>
  <span class="main">(</span><span class="entity">ensure_cap</span> <span class="entity">v</span> <span class="main">;</span>
   <span class="entity">array_insert</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">x</span> <span class="main">;</span>
   <span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span> := !<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span> + <span class="inner_numeral">1</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">delete</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="entity">i</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span> := <span class="entity">array_delete</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="entity">i</span> <span class="main">(</span><span class="main">#</span>dummy <span class="entity">v</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_swap</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">j</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> &lt;&gt; <span class="entity">j</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tmp</span> <span class="main">=</span> Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span> Array.update <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">i</span><span class="main">,</span> Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">j</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
         Array.update <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">j</span><span class="main">,</span> <span class="entity">tmp</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">swap</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">j</span> <span class="main">=</span>
  <span class="entity">array_swap</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">j</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">swap_out</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="entity">i</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span> := <span class="entity">array_swap_out</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="entity">i</span> <span class="main">(</span><span class="main">#</span>dummy <span class="entity">v</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_rev</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">j</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> &lt; <span class="entity">j</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="main">(</span><span class="entity">array_swap</span> <span class="entity">a</span> <span class="entity">i</span> <span class="main">(</span><span class="entity">j</span> - <span class="inner_numeral">1</span><span class="main">)</span> <span class="main">;</span>
       <span class="entity">array_rev</span> <span class="entity">a</span> <span class="main">(</span><span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="main">(</span><span class="entity">j</span> - <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rev</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">array_rev</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="inner_numeral">0</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_iter</span> <span class="entity">c</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">j</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> &lt;&gt; <span class="entity">j</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="main">(</span><span class="entity">c</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
       <span class="entity">array_iter</span> <span class="entity">c</span> <span class="entity">a</span> <span class="main">(</span><span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">j</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">iter</span> <span class="entity">c</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">array_iter</span> <span class="entity">c</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="inner_numeral">0</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_iter_const</span> <span class="entity">c</span> <span class="entity">x</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">j</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> &lt;&gt; <span class="entity">j</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="main">(</span><span class="entity">c</span> <span class="entity">x</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
       <span class="entity">array_iter_const</span> <span class="entity">c</span> <span class="entity">x</span> <span class="entity">a</span> <span class="main">(</span><span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">j</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">iter_const</span> <span class="entity">c</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">array_iter_const</span> <span class="entity">c</span> <span class="entity">x</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="inner_numeral">0</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_iteri</span> <span class="entity">c</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">j</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> &lt;&gt; <span class="entity">j</span> <span class="keyword2"><span class="keyword">then</span></span>
    <span class="main">(</span><span class="entity">c</span> <span class="entity">i</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
     <span class="entity">array_iteri</span> <span class="entity">c</span> <span class="entity">a</span> <span class="main">(</span><span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">j</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">iteri</span> <span class="entity">c</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">array_iteri</span> <span class="entity">c</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="inner_numeral">0</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_iter_const</span> <span class="entity">c</span> <span class="entity">x</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">j</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> &lt;&gt; <span class="entity">j</span> <span class="keyword2"><span class="keyword">then</span></span>
    <span class="main">(</span><span class="entity">c</span> <span class="entity">x</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
     <span class="entity">array_iter_const</span> <span class="entity">c</span> <span class="entity">x</span> <span class="entity">a</span> <span class="main">(</span><span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">j</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">iteri_const</span> <span class="entity">c</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">array_iter_const</span> <span class="entity">c</span> <span class="entity">x</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="inner_numeral">0</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">modify</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> ArraySlice.modify <span class="entity">f</span> <span class="main">(</span>ArraySlice.slice <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">,</span> 
                                                      <span class="inner_numeral">0</span><span class="main">,</span> SOME <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">modify_const</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">modify</span> <span class="main">(</span><span class="entity">f</span> <span class="entity">x</span><span class="main">)</span> <span class="entity">v</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fold_left</span> <span class="entity">f</span> <span class="entity">acc</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> ArraySlice.foldl <span class="main">(</span>uncurry <span class="entity">f</span><span class="main">)</span> <span class="entity">acc</span> 
                                       <span class="main">(</span>ArraySlice.slice
                                            <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">,</span> SOME <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fold_right</span> <span class="entity">f</span> <span class="entity">acc</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> ArraySlice.foldr <span class="main">(</span>uncurry <span class="entity">f</span><span class="main">)</span> <span class="entity">acc</span> 
                                        <span class="main">(</span>ArraySlice.slice
                                             <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">,</span> SOME <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">uncurry3</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">,</span> <span class="entity">z</span><span class="main">)</span> <span class="main">=</span> <span class="entity">f</span> <span class="entity">x</span> <span class="entity">y</span> <span class="entity">z</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">foldi_left</span> <span class="entity">f</span> <span class="entity">acc</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> ArraySlice.foldli <span class="main">(</span><span class="entity">uncurry3</span> <span class="entity">f</span><span class="main">)</span> <span class="entity">acc</span> 
                                         <span class="main">(</span>ArraySlice.slice
                                              <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">,</span> SOME <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">foldi_right</span> <span class="entity">f</span> <span class="entity">acc</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> ArraySlice.foldri <span class="main">(</span><span class="entity">uncurry3</span> <span class="entity">f</span><span class="main">)</span> <span class="entity">acc</span> 
                        <span class="main">(</span>ArraySlice.slice
                             <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">,</span> SOME <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">first</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">array_first</span> <span class="entity">p</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="inner_numeral">0</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">first_const</span> <span class="entity">p</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">array_first_const</span> <span class="entity">p</span> <span class="entity">x</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="inner_numeral">0</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">find</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> Array.sub <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">,</span> <span class="entity">array_first</span> <span class="entity">p</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="inner_numeral">0</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">find_const</span> <span class="entity">p</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">,</span> <span class="entity">array_first_const</span> <span class="entity">p</span> <span class="entity">x</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="inner_numeral">0</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">memb</span> <span class="entity">eq</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> 
  ArraySlice.exists <span class="main">(</span><span class="entity">eq</span> <span class="entity">x</span><span class="main">)</span>
                    <span class="main">(</span>ArraySlice.slice <span class="main">(</span><span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
                                       <span class="inner_numeral">0</span><span class="main">,</span> SOME <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">exists</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> ArraySlice.exists <span class="entity">p</span> 
                                 <span class="main">(</span>ArraySlice.slice <span class="main">(</span><span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
                                                    <span class="inner_numeral">0</span><span class="main">,</span> SOME <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">exists_const</span> <span class="entity">p</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">exists</span> <span class="main">(</span><span class="entity">p</span> <span class="entity">x</span><span class="main">)</span> <span class="entity">v</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">for_all</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> ArraySlice.all <span class="entity">p</span> 
                                        <span class="main">(</span>ArraySlice.slice <span class="main">(</span><span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
                                                           <span class="inner_numeral">0</span><span class="main">,</span> SOME <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">for_all_const</span> <span class="entity">p</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">for_all</span> <span class="main">(</span><span class="entity">p</span> <span class="entity">x</span><span class="main">)</span> <span class="entity">v</span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fast_filter</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span> := <span class="entity">array_filter</span> <span class="entity">p</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="inner_numeral">0</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span>dummy <span class="entity">v</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fast_filter_const</span> <span class="entity">p</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span> := <span class="entity">array_filter_const</span> <span class="entity">p</span> <span class="entity">x</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="inner_numeral">0</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span>dummy <span class="entity">v</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">filter</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span> := <span class="entity">array_filter</span> <span class="entity">p</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="inner_numeral">0</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span>dummy <span class="entity">v</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">filter_const</span> <span class="entity">p</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span> := <span class="entity">array_filter_const</span> <span class="entity">p</span> <span class="entity">x</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="inner_numeral">0</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span>dummy <span class="entity">v</span><span class="main">)</span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">filteri</span> <span class="entity">p</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span> := <span class="entity">array_filteri</span> <span class="entity">p</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="inner_numeral">0</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span>dummy <span class="entity">v</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">filteri_const</span> <span class="entity">p</span> <span class="entity">x</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span> := <span class="entity">array_filteri_const</span> <span class="entity">p</span> <span class="entity">x</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="inner_numeral">0</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span>dummy <span class="entity">v</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">merge</span> <span class="entity">cmp</span> <span class="entity">b</span> <span class="entity">n</span> <span class="entity">m</span> <span class="entity">i</span> <span class="entity">a</span> <span class="entity">j</span> <span class="entity">k</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span> &lt;&gt; <span class="entity">m</span> <span class="keyword2"><span class="keyword">then</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">j</span> <span class="main">=</span> <span class="entity">k</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">res</span> <span class="main">=&gt;</span> <span class="entity">res</span> <span class="main">=</span> LESS <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">res</span> <span class="main">=</span> EQUAL<span class="main">)</span> 
                      <span class="main">(</span><span class="entity">cmp</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">b</span><span class="main">,</span> <span class="entity">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="keyword2"><span class="keyword">then</span></span>
      <span class="main">(</span>Array.update <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">i</span><span class="main">,</span> Array.sub <span class="main">(</span><span class="entity">b</span><span class="main">,</span> <span class="entity">n</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
       <span class="entity">merge</span> <span class="entity">cmp</span> <span class="entity">b</span> <span class="main">(</span><span class="entity">n</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">m</span> <span class="main">(</span><span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">a</span> <span class="entity">j</span> <span class="entity">k</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">else</span></span>
      <span class="main">(</span>Array.update <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">i</span><span class="main">,</span> Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">j</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
       <span class="entity">merge</span> <span class="entity">cmp</span> <span class="entity">b</span> <span class="entity">n</span> <span class="entity">m</span> <span class="main">(</span><span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">a</span> <span class="main">(</span><span class="entity">j</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">k</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">msort</span> <span class="entity">cmp</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">j</span> <span class="entity">tmp</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> + <span class="inner_numeral">1</span> &lt; <span class="entity">j</span> <span class="keyword2"><span class="keyword">then</span></span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">mid</span> <span class="main">=</span> <span class="entity">i</span> + <span class="main">(</span><span class="entity">j</span> - <span class="entity">i</span><span class="main">)</span> div <span class="inner_numeral">2</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">msort</span> <span class="entity">cmp</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">mid</span> <span class="entity">tmp</span> <span class="main">;</span>
     <span class="entity">msort</span> <span class="entity">cmp</span> <span class="entity">a</span> <span class="entity">mid</span> <span class="entity">j</span> <span class="entity">tmp</span> <span class="main">;</span>
     ArraySlice.copy <span class="main">{</span>src <span class="main">=</span> ArraySlice.slice <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">i</span><span class="main">,</span> SOME <span class="main">(</span><span class="entity">mid</span> - <span class="entity">i</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
                      dst <span class="main">=</span> <span class="entity">tmp</span><span class="main">,</span> 
                      di <span class="main">=</span> <span class="inner_numeral">0</span><span class="main">}</span> <span class="main">;</span>
     <span class="entity">merge</span> <span class="entity">cmp</span> <span class="entity">tmp</span> <span class="inner_numeral">0</span> <span class="main">(</span><span class="entity">mid</span> - <span class="entity">i</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">a</span> <span class="entity">mid</span> <span class="entity">j</span> <span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">merge_sort</span> <span class="entity">cmp</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">j</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">tmp</span> <span class="main">=</span> Array.array <span class="main">(</span><span class="main">(</span><span class="entity">j</span> - <span class="entity">i</span><span class="main">)</span> div <span class="inner_numeral">2</span><span class="main">,</span> Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">msort</span> <span class="entity">cmp</span> <span class="entity">a</span> <span class="entity">i</span> <span class="entity">j</span> <span class="entity">tmp</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">array_sort</span> <span class="main">=</span> <span class="entity">merge_sort</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">array_stable_sort</span> <span class="main">=</span> <span class="entity">merge_sort</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sort</span> <span class="entity">cmp</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">array_sort</span> <span class="entity">cmp</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="inner_numeral">0</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">stable_sort</span> <span class="entity">cmp</span> <span class="main">(</span><span class="entity">v</span> <span class="main">:</span> 'a <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">array_stable_sort</span> <span class="entity">cmp</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>contents <span class="entity">v</span><span class="main">)</span><span class="main">)</span> <span class="inner_numeral">0</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>size <span class="entity">v</span><span class="main">)</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">type</span></span> 'a <span class="entity">vec</span> <span class="main">=</span> 'a <span class="entity">Vec.t</span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">PriorityQueue</span> <span class="main">=</span> 
<span class="keyword2"><span class="keyword">struct</span></span>


<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">invalid_position</span> <span class="main">=</span> <span class="inner_numeral">~1</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">int_add</span> <span class="entity">m</span> <span class="entity">n</span> <span class="entity">x</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span> &lt; <span class="entity">Vec.length</span> <span class="entity">m</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="entity">Vec.set</span> <span class="entity">m</span> <span class="entity">n</span> <span class="entity">x</span>
  <span class="keyword2"><span class="keyword">else</span></span>
      <span class="entity">Vec.grow</span> <span class="entity">m</span> <span class="main">(</span><span class="entity">n</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">x</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">real_add</span> <span class="entity">m</span> <span class="entity">n</span> <span class="entity">x</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span> &lt; <span class="entity">Vec.length</span> <span class="entity">m</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="entity">Vec.set</span> <span class="entity">m</span> <span class="entity">n</span> <span class="entity">x</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">Vec.grow</span> <span class="entity">m</span> <span class="main">(</span><span class="entity">n</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">x</span>

<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">t</span> <span class="main">=</span> <span class="main">{</span>priority<span class="main">:</span> real <span class="entity">vec</span><span class="main">,</span> 
        position<span class="main">:</span> int <span class="entity">vec</span><span class="main">,</span> 
        heap<span class="main">:</span> int <span class="entity">vec</span><span class="main">}</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">queue_length</span> <span class="main">(</span><span class="entity">x</span> <span class="main">:</span> <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">Vec.length</span> <span class="main">(</span><span class="main">#</span>heap <span class="entity">x</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">root_position</span> <span class="main">=</span> <span class="inner_numeral">0</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">parent_position</span> <span class="entity">i</span> <span class="main">=</span> <span class="main">(</span><span class="entity">i</span> - <span class="inner_numeral">1</span><span class="main">)</span> div <span class="inner_numeral">2</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">left_child_position</span> <span class="entity">i</span> <span class="main">=</span> <span class="inner_numeral">2</span> * <span class="entity">i</span> + <span class="inner_numeral">1</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">right_sibling_position</span> <span class="entity">i</span> <span class="main">=</span> <span class="entity">i</span> + <span class="inner_numeral">1</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ensure_map_memb</span> <span class="entity">q</span> <span class="entity">e</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span><span class="entity">e</span> &lt; <span class="entity">Vec.length</span> <span class="main">(</span><span class="main">#</span>priority <span class="entity">q</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
  <span class="main">(</span>
      <span class="entity">real_add</span> <span class="main">(</span><span class="main">#</span>priority <span class="entity">q</span><span class="main">)</span> <span class="entity">e</span> <span class="inner_numeral">0.0</span> <span class="main">;</span>
      <span class="entity">int_add</span> <span class="main">(</span><span class="main">#</span>position <span class="entity">q</span><span class="main">)</span> <span class="entity">e</span> <span class="entity">invalid_position</span>
  <span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">higher_priority</span> <span class="entity">q</span> <span class="entity">x</span> <span class="entity">y</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">x_score</span> <span class="main">:</span> real <span class="main">=</span> <span class="entity">Vec.get</span> <span class="main">(</span><span class="main">#</span>priority <span class="entity">q</span><span class="main">)</span> <span class="entity">x</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">y_score</span> <span class="main">:</span> real <span class="main">=</span> <span class="entity">Vec.get</span> <span class="main">(</span><span class="main">#</span>priority <span class="entity">q</span><span class="main">)</span> <span class="entity">y</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">x_score</span> &gt; <span class="entity">y_score</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="main">(</span><span class="main">(</span><span class="entity">x_score</span> - <span class="entity">y_score</span><span class="main">)</span> * <span class="main">(</span><span class="entity">x_score</span> - <span class="entity">y_score</span><span class="main">)</span> &lt;= <span class="inner_numeral">0.0</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">x</span> &gt; <span class="entity">y</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">create</span> <span class="entity">e</span> <span class="main">=</span> 
  <span class="main">{</span>priority <span class="main">=</span> <span class="entity">Vec.make</span> <span class="inner_numeral">0</span> <span class="inner_numeral">0.0</span> <span class="inner_numeral">0.0</span><span class="main">,</span> 
   position <span class="main">=</span> <span class="entity">Vec.make</span> <span class="inner_numeral">0</span> <span class="entity">invalid_position</span> <span class="entity">invalid_position</span><span class="main">,</span> 
   heap <span class="main">=</span> <span class="entity">Vec.make</span> <span class="inner_numeral">0</span> <span class="entity">e</span> <span class="entity">e</span><span class="main">}</span> <span class="main">:</span> <span class="entity">t</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_empty</span> <span class="main">(</span><span class="entity">q</span> <span class="main">:</span> <span class="entity">t</span><span class="main">)</span> <span class="main">=</span> <span class="entity">Vec.is_empty</span> <span class="main">(</span><span class="main">#</span>heap <span class="entity">q</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">memb</span> <span class="main">(</span><span class="entity">h</span> <span class="main">:</span> <span class="entity">t</span><span class="main">)</span> <span class="entity">x</span> <span class="main">=</span> 
  <span class="inner_numeral">0</span> &lt;= <span class="entity">x</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">x</span> &lt; <span class="entity">Vec.length</span> <span class="main">(</span><span class="main">#</span>position <span class="entity">h</span><span class="main">)</span>
  <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">Vec.get</span> <span class="main">(</span><span class="main">#</span>position <span class="entity">h</span><span class="main">)</span> <span class="entity">x</span> &lt;&gt; <span class="entity">invalid_position</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">percolate_up</span> <span class="main">(</span><span class="entity">h</span> <span class="main">:</span> <span class="entity">t</span><span class="main">)</span> <span class="entity">j</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">j</span> &gt; <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">je</span> <span class="main">=</span> <span class="entity">Vec.get</span> <span class="main">(</span><span class="main">#</span>heap <span class="entity">h</span><span class="main">)</span> <span class="entity">j</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">i</span> <span class="main">=</span> <span class="entity">parent_position</span> <span class="entity">j</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ie</span> <span class="main">=</span> <span class="entity">Vec.get</span> <span class="main">(</span><span class="main">#</span>heap <span class="entity">h</span><span class="main">)</span> <span class="entity">i</span>
      <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">higher_priority</span> <span class="entity">h</span> <span class="entity">je</span> <span class="entity">ie</span> <span class="keyword2"><span class="keyword">then</span></span>
         <span class="main">(</span>
             <span class="entity">Vec.set</span> <span class="main">(</span><span class="main">#</span>heap <span class="entity">h</span><span class="main">)</span> <span class="entity">j</span> <span class="entity">ie</span> <span class="main">;</span>
             <span class="entity">Vec.set</span> <span class="main">(</span><span class="main">#</span>heap <span class="entity">h</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">je</span> <span class="main">;</span>
             <span class="entity">Vec.set</span> <span class="main">(</span><span class="main">#</span>position <span class="entity">h</span><span class="main">)</span> <span class="entity">je</span> <span class="entity">i</span> <span class="main">;</span>
             <span class="entity">Vec.set</span> <span class="main">(</span><span class="main">#</span>position <span class="entity">h</span><span class="main">)</span> <span class="entity">ie</span> <span class="entity">j</span> <span class="main">;</span>
             <span class="entity">percolate_up</span> <span class="entity">h</span> <span class="entity">i</span>
         <span class="main">)</span>
         <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">percolate_down</span> <span class="main">(</span><span class="entity">h</span> <span class="main">:</span> <span class="entity">t</span><span class="main">)</span> <span class="entity">i</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">size</span> <span class="main">=</span> <span class="entity">Vec.length</span> <span class="main">(</span><span class="main">#</span>heap <span class="entity">h</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">l</span> <span class="main">=</span> <span class="entity">left_child_position</span> <span class="entity">i</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">l</span> &lt; <span class="entity">size</span> <span class="keyword2"><span class="keyword">then</span></span>
         <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">r</span> <span class="main">=</span> <span class="entity">right_sibling_position</span> <span class="entity">l</span>
             <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">j</span> <span class="main">=</span> 
                 <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">r</span> &lt; <span class="entity">size</span> <span class="keyword1"><span class="keyword">andalso</span></span>
                    <span class="main">(</span><span class="entity">higher_priority</span> <span class="entity">h</span><span class="main">)</span> 
                        <span class="main">(</span><span class="entity">Vec.get</span> <span class="main">(</span><span class="main">#</span>heap <span class="entity">h</span><span class="main">)</span> <span class="entity">r</span><span class="main">)</span> 
                        <span class="main">(</span><span class="entity">Vec.get</span> <span class="main">(</span><span class="main">#</span>heap <span class="entity">h</span><span class="main">)</span> <span class="entity">l</span><span class="main">)</span>
                 <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">r</span>
                 <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">l</span>
             <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ie</span> <span class="main">=</span> <span class="entity">Vec.get</span> <span class="main">(</span><span class="main">#</span>heap <span class="entity">h</span><span class="main">)</span> <span class="entity">i</span>
             <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">je</span> <span class="main">=</span> <span class="entity">Vec.get</span> <span class="main">(</span><span class="main">#</span>heap <span class="entity">h</span><span class="main">)</span> <span class="entity">j</span>
         <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="main">(</span><span class="entity">higher_priority</span> <span class="entity">h</span><span class="main">)</span> <span class="entity">je</span> <span class="entity">ie</span> <span class="keyword2"><span class="keyword">then</span></span>
            <span class="main">(</span>
                <span class="entity">Vec.set</span> <span class="main">(</span><span class="main">#</span>heap <span class="entity">h</span><span class="main">)</span> <span class="entity">i</span> <span class="entity">je</span> <span class="main">;</span>
                <span class="entity">Vec.set</span> <span class="main">(</span><span class="main">#</span>heap <span class="entity">h</span><span class="main">)</span> <span class="entity">j</span> <span class="entity">ie</span> <span class="main">;</span>
                <span class="entity">Vec.set</span> <span class="main">(</span><span class="main">#</span>position <span class="entity">h</span><span class="main">)</span> <span class="entity">je</span> <span class="entity">i</span> <span class="main">;</span>
                <span class="entity">Vec.set</span> <span class="main">(</span><span class="main">#</span>position <span class="entity">h</span><span class="main">)</span> <span class="entity">ie</span> <span class="entity">j</span> <span class="main">;</span>
                <span class="entity">percolate_down</span> <span class="entity">h</span> <span class="entity">j</span>
            <span class="main">)</span>
            <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
         <span class="keyword2"><span class="keyword">end</span></span>
     <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">enqueue</span> <span class="main">(</span><span class="entity">h</span> <span class="main">:</span> <span class="entity">t</span><span class="main">)</span> <span class="entity">e</span> <span class="main">=</span> 
  <span class="main">(</span><span class="entity">ensure_map_memb</span> <span class="entity">h</span> <span class="entity">e</span> <span class="main">;</span>
   <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">Vec.get</span> <span class="main">(</span><span class="main">#</span>position <span class="entity">h</span><span class="main">)</span> <span class="entity">e</span> <span class="main">=</span> <span class="entity">invalid_position</span>
   <span class="keyword2"><span class="keyword">then</span></span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">i</span> <span class="main">=</span> <span class="entity">Vec.length</span> <span class="main">(</span><span class="main">#</span>heap <span class="entity">h</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">Vec.push</span> <span class="main">(</span><span class="main">#</span>heap <span class="entity">h</span><span class="main">)</span> <span class="entity">e</span> <span class="main">;</span>
           <span class="entity">Vec.set</span> <span class="main">(</span><span class="main">#</span>position <span class="entity">h</span><span class="main">)</span> <span class="entity">e</span> <span class="entity">i</span> <span class="main">;</span>
           <span class="entity">percolate_up</span> <span class="entity">h</span> <span class="entity">i</span> <span class="keyword2"><span class="keyword">end</span></span>
   <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">head</span> <span class="entity">q</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_empty</span> <span class="entity">q</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="keyword3"><span class="keyword">raise</span></span> error <span class="inner_quoted">"queue empty!"</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">Vec.get</span> <span class="main">(</span><span class="main">#</span>heap <span class="entity">q</span><span class="main">)</span> <span class="entity">root_position</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">drop</span> <span class="entity">q</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_empty</span> <span class="entity">q</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="keyword3"><span class="keyword">raise</span></span> error <span class="inner_quoted">"queue empty!"</span>
  <span class="keyword2"><span class="keyword">else</span></span>
  <span class="main">(</span>
      <span class="entity">Vec.set</span> <span class="main">(</span><span class="main">#</span>position <span class="entity">q</span><span class="main">)</span> <span class="main">(</span><span class="entity">head</span> <span class="entity">q</span><span class="main">)</span> <span class="entity">invalid_position</span> <span class="main">;</span>
      <span class="entity">Vec.swap_out</span> <span class="main">(</span><span class="main">#</span>heap <span class="entity">q</span><span class="main">)</span> <span class="entity">root_position</span> <span class="main">;</span>
      <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span><span class="entity">is_empty</span> <span class="entity">q</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
          <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">e</span> <span class="main">=</span> <span class="entity">head</span> <span class="entity">q</span> 
          <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">Vec.set</span> <span class="main">(</span><span class="main">#</span>position <span class="entity">q</span><span class="main">)</span> <span class="entity">e</span> <span class="entity">root_position</span> <span class="main">;</span>
             <span class="entity">percolate_down</span> <span class="entity">q</span> <span class="entity">root_position</span> <span class="keyword2"><span class="keyword">end</span></span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
  <span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dequeue</span> <span class="entity">q</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">result</span> <span class="main">=</span> <span class="entity">head</span> <span class="entity">q</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">drop</span> <span class="entity">q</span> <span class="main">;</span> <span class="entity">result</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">priority</span> <span class="main">(</span><span class="entity">q</span> <span class="main">:</span> <span class="entity">t</span><span class="main">)</span> <span class="entity">e</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">e</span> &lt; <span class="entity">Vec.length</span> <span class="main">(</span><span class="main">#</span>priority <span class="entity">q</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="entity">Vec.get</span> <span class="main">(</span><span class="main">#</span>priority <span class="entity">q</span><span class="main">)</span> <span class="entity">e</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_numeral">0.0</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">inc_priority</span> <span class="entity">q</span> <span class="entity">e</span> <span class="main">(</span><span class="entity">x</span> <span class="main">:</span> real<span class="main">)</span> <span class="main">=</span> 
<span class="main">(</span>
  <span class="entity">ensure_map_memb</span> <span class="entity">q</span> <span class="entity">e</span> <span class="main">;</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">old</span> <span class="main">=</span> <span class="entity">Vec.get</span> <span class="main">(</span><span class="main">#</span>priority <span class="entity">q</span><span class="main">)</span> <span class="entity">e</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">Vec.set</span> <span class="main">(</span><span class="main">#</span>priority <span class="entity">q</span><span class="main">)</span> <span class="entity">e</span> <span class="main">(</span><span class="entity">old</span> + <span class="entity">x</span><span class="main">)</span> <span class="main">;</span>
     <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">memb</span> <span class="entity">q</span> <span class="entity">e</span> <span class="keyword2"><span class="keyword">then</span></span>
         <span class="entity">percolate_up</span> <span class="entity">q</span> <span class="main">(</span><span class="entity">Vec.get</span> <span class="main">(</span><span class="main">#</span>position <span class="entity">q</span><span class="main">)</span> <span class="entity">e</span><span class="main">)</span>
     <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">scale</span> <span class="main">(</span><span class="entity">q</span> <span class="main">:</span> <span class="entity">t</span><span class="main">)</span> <span class="entity">x</span> <span class="main">=</span> <span class="entity">Vec.modify</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">y</span> <span class="main">=&gt;</span> <span class="entity">x</span> * <span class="entity">y</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span>priority <span class="entity">q</span><span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">priority_queue</span> <span class="main">=</span> <span class="entity">PriorityQueue.t</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">check_assertions</span> <span class="main">:</span> bool Unsynchronized.ref <span class="main">=</span> Unsynchronized.ref true

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">assert</span> <span class="entity">condition</span> <span class="entity">err_str</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">if</span></span> !<span class="entity">check_assertions</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span><span class="entity">condition</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> error <span class="entity">err_str</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">clause</span> <span class="main">=</span> <span class="main">{</span>literals <span class="main">:</span> int array<span class="main">,</span> activity <span class="main">:</span> real Unsynchronized.ref<span class="main">}</span>
<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">reason</span> <span class="main">=</span> <span class="entity">Unassigned</span>
              <span class="main">|</span> <span class="entity">Decision</span>
              <span class="main">|</span> <span class="entity">Propagation</span> <span class="keyword2"><span class="keyword">of</span></span> clause


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">new_clause</span> <span class="entity">lit_list</span> <span class="main">=</span> 
  <span class="main">{</span>literals <span class="main">=</span> Array.fromList <span class="entity">lit_list</span><span class="main">,</span> activity <span class="main">=</span> Unsynchronized.ref <span class="inner_numeral">0.0</span><span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_to_list</span> <span class="entity">a</span> <span class="main">=</span> Array.foldr <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> ::<span class="main">)</span> <span class="main">[</span><span class="main">]</span> <span class="entity">a</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">max_float</span> <span class="main">:</span> real<span class="main">)</span> <span class="main">=</span> Real.maxFinite

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">min_float</span> <span class="main">:</span> real<span class="main">)</span> <span class="main">=</span> Real.minNormalPos

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">empty_queue</span> <span class="main">:</span> unit <span class="main">-&gt;</span> <span class="entity">priority_queue</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">PriorityQueue.create</span> <span class="main">(</span><span class="inner_numeral">~1</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">queue_length</span> <span class="main">:</span> <span class="entity">priority_queue</span> <span class="main">-&gt;</span> int<span class="main">)</span> <span class="main">=</span> <span class="entity">PriorityQueue.queue_length</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">empty_clause</span> <span class="main">:</span> <span class="entity">clause</span><span class="main">)</span> <span class="main">=</span> <span class="entity">new_clause</span> <span class="main">[</span><span class="main">]</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">invalid_level</span> <span class="main">:</span> int<span class="main">)</span> <span class="main">=</span> <span class="inner_numeral">~1</span>

<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">solver</span> <span class="main">=</span> 
<span class="main">{</span>
   clause <span class="main">:</span> <span class="entity">clause</span> <span class="entity">vec</span><span class="main">,</span> 
   learned <span class="main">:</span> <span class="entity">clause</span> <span class="entity">vec</span><span class="main">,</span> 
   trace <span class="main">:</span> int <span class="entity">vec</span><span class="main">,</span> 
   assignment_array <span class="main">:</span> bool option array Unsynchronized.ref<span class="main">,</span> 
   reason_array <span class="main">:</span> <span class="entity">reason</span> array Unsynchronized.ref<span class="main">,</span> 
   level_array <span class="main">:</span> int array Unsynchronized.ref<span class="main">,</span> 
   conflict_detected <span class="main">:</span> bool Unsynchronized.ref<span class="main">,</span> 
   decision_level <span class="main">:</span> int Unsynchronized.ref<span class="main">,</span> 
   position <span class="main">:</span> int array Unsynchronized.ref<span class="main">,</span> 
   early_level_array <span class="main">:</span> int array Unsynchronized.ref<span class="main">,</span> 
   cls_increment <span class="main">:</span> real Unsynchronized.ref<span class="main">,</span> 
   early_reason_array <span class="main">:</span> <span class="entity">clause</span> array Unsynchronized.ref<span class="main">,</span> 
   scale <span class="main">:</span> real Unsynchronized.ref<span class="main">,</span> 
   conflict_level <span class="main">:</span> int Unsynchronized.ref<span class="main">,</span> 
   decision_queue <span class="main">:</span> <span class="entity">priority_queue</span> Unsynchronized.ref<span class="main">,</span> 
   lower_conflict_lits <span class="main">:</span> int list Unsynchronized.ref<span class="main">,</span> 
   next_inference_lit <span class="main">:</span> int Unsynchronized.ref<span class="main">,</span> 
   num_implication_points <span class="main">:</span> int Unsynchronized.ref<span class="main">,</span> 
   var_increment <span class="main">:</span> real Unsynchronized.ref<span class="main">,</span> 
   num_vars <span class="main">:</span> int Unsynchronized.ref<span class="main">,</span> 
   max_var <span class="main">:</span> int Unsynchronized.ref<span class="main">,</span> 
   shy_of_max <span class="main">:</span> real Unsynchronized.ref<span class="main">,</span> 
   conflict_vars <span class="main">:</span> int list Unsynchronized.ref<span class="main">,</span> 
   pending_literals <span class="main">:</span> int Queue.T Unsynchronized.ref<span class="main">,</span> 
   num_conflicts <span class="main">:</span> int Unsynchronized.ref<span class="main">,</span> 
   dispatch_lit <span class="main">:</span> int Unsynchronized.ref<span class="main">,</span> 
   next_inference_cls <span class="main">:</span> int Unsynchronized.ref<span class="main">,</span> 
   pending_clauses <span class="main">:</span> int list Queue.T Unsynchronized.ref<span class="main">,</span> 
   bias <span class="main">:</span> <span class="main">(</span>bool array<span class="main">)</span> Unsynchronized.ref<span class="main">,</span> 
   num_decisions <span class="main">:</span> int Unsynchronized.ref<span class="main">,</span> 
   watchers <span class="main">:</span> <span class="entity">clause</span> list Unsynchronized.ref array Unsynchronized.ref<span class="main">,</span> 
   num_inferences <span class="main">:</span> int Unsynchronized.ref<span class="main">,</span> 
   conflict_limit <span class="main">:</span> int Unsynchronized.ref<span class="main">,</span>
   learneds_limit <span class="main">:</span> int Unsynchronized.ref
<span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">empty_solver</span> <span class="main">(</span><span class="main">)</span> <span class="main">:</span> <span class="entity">solver</span> <span class="main">=</span> 
  <span class="main">{</span>
      clause <span class="main">=</span> <span class="entity">Vec.make</span> <span class="inner_numeral">0</span> <span class="entity">empty_clause</span> <span class="entity">empty_clause</span><span class="main">,</span> 
      learned <span class="main">=</span> <span class="entity">Vec.make</span> <span class="inner_numeral">0</span> <span class="entity">empty_clause</span> <span class="entity">empty_clause</span><span class="main">,</span> 
      trace <span class="main">=</span> <span class="entity">Vec.of_list</span> <span class="main">[</span><span class="main">]</span> <span class="inner_numeral">0</span><span class="main">,</span> 
      assignment_array <span class="main">=</span> Unsynchronized.ref <span class="main">(</span>Array.fromList <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> 
      reason_array <span class="main">=</span> Unsynchronized.ref <span class="main">(</span>Array.fromList <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> 
      level_array <span class="main">=</span> Unsynchronized.ref <span class="main">(</span>Array.fromList <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> 
      conflict_detected <span class="main">=</span> Unsynchronized.ref false<span class="main">,</span> 
      decision_level <span class="main">=</span> Unsynchronized.ref <span class="inner_numeral">0</span><span class="main">,</span> 
      position <span class="main">=</span> Unsynchronized.ref <span class="main">(</span>Array.fromList <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> 
      early_level_array <span class="main">=</span> Unsynchronized.ref <span class="main">(</span>Array.fromList <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> 
      cls_increment <span class="main">=</span> Unsynchronized.ref <span class="inner_numeral">1.0</span><span class="main">,</span> 
      early_reason_array <span class="main">=</span> Unsynchronized.ref <span class="main">(</span>Array.fromList <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> 
      scale <span class="main">=</span> Unsynchronized.ref <span class="inner_numeral">1.05</span><span class="main">,</span> 
      conflict_level <span class="main">=</span> Unsynchronized.ref <span class="inner_numeral">0</span><span class="main">,</span> 
      decision_queue <span class="main">=</span> Unsynchronized.ref <span class="main">(</span><span class="entity">empty_queue</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
      lower_conflict_lits <span class="main">=</span> Unsynchronized.ref <span class="main">[</span><span class="main">]</span><span class="main">,</span> 
      next_inference_lit <span class="main">=</span> Unsynchronized.ref <span class="inner_numeral">0</span><span class="main">,</span> 
      num_implication_points <span class="main">=</span> Unsynchronized.ref <span class="inner_numeral">0</span><span class="main">,</span> 
      var_increment <span class="main">=</span> Unsynchronized.ref <span class="inner_numeral">0.0</span><span class="main">,</span> 
      num_vars <span class="main">=</span> Unsynchronized.ref <span class="inner_numeral">0</span><span class="main">,</span> 
      max_var <span class="main">=</span> Unsynchronized.ref <span class="inner_numeral">0</span><span class="main">,</span> 
      shy_of_max <span class="main">=</span> Unsynchronized.ref <span class="main">(</span><span class="entity">max_float</span> / <span class="inner_numeral">1.05</span><span class="main">)</span><span class="main">,</span> 
      conflict_vars <span class="main">=</span> Unsynchronized.ref <span class="main">[</span><span class="main">]</span><span class="main">,</span> 
      pending_literals <span class="main">=</span> Unsynchronized.ref <span class="main">(</span>Queue.empty<span class="main">)</span><span class="main">,</span> 
      num_conflicts <span class="main">=</span> Unsynchronized.ref <span class="inner_numeral">0</span><span class="main">,</span> 
      dispatch_lit <span class="main">=</span> Unsynchronized.ref <span class="inner_numeral">0</span><span class="main">,</span> 
      next_inference_cls <span class="main">=</span> Unsynchronized.ref <span class="inner_numeral">0</span><span class="main">,</span> 
      pending_clauses <span class="main">=</span> Unsynchronized.ref <span class="main">(</span>Queue.empty<span class="main">)</span><span class="main">,</span> 
      bias <span class="main">=</span> Unsynchronized.ref <span class="main">(</span>Array.fromList <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> 
      num_decisions <span class="main">=</span> Unsynchronized.ref <span class="inner_numeral">0</span><span class="main">,</span> 
      watchers <span class="main">=</span> Unsynchronized.ref <span class="main">(</span>Array.fromList <span class="main">[</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> 
      num_inferences <span class="main">=</span> Unsynchronized.ref <span class="inner_numeral">0</span><span class="main">,</span> 
      conflict_limit <span class="main">=</span> Unsynchronized.ref <span class="inner_numeral">100</span><span class="main">,</span> 
      learneds_limit <span class="main">=</span> Unsynchronized.ref <span class="inner_numeral">0</span>
  <span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">assignment</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lit</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">var</span> <span class="main">=</span> abs <span class="entity">lit</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">var_val</span> <span class="main">=</span> Array.sub <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>assignment_array <span class="entity">s</span><span class="main">)</span><span class="main">,</span> <span class="entity">var</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">lit</span> &gt; <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">var_val</span> <span class="keyword2"><span class="keyword">else</span></span> Option.map not <span class="entity">var_val</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_true</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lit</span> <span class="main">=</span> <span class="entity">assignment</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="main">=</span> SOME true

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_false</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lit</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">result</span> <span class="main">=</span> <span class="entity">assignment</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="main">=</span> SOME false <span class="keyword2"><span class="keyword">in</span></span> 
      <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">result</span> <span class="main">=</span> <span class="entity">is_true</span> <span class="entity">s</span> <span class="main">(</span>~<span class="entity">lit</span><span class="main">)</span><span class="main">)</span> <span class="inner_quoted">""</span> <span class="main">;</span>
      <span class="entity">result</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">reason</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lit</span> <span class="main">=</span> Array.sub <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>reason_array <span class="entity">s</span><span class="main">)</span><span class="main">,</span> abs <span class="entity">lit</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_assigned</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lit</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">result</span> <span class="main">=</span> <span class="entity">reason</span> <span class="entity">s</span> <span class="entity">lit</span> &lt;&gt; <span class="entity">Unassigned</span> <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">result</span> <span class="main">=</span> <span class="entity">is_true</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">is_false</span> <span class="entity">s</span> <span class="entity">lit</span><span class="main">)</span> 
             <span class="inner_quoted">"is_assigned violates: result = is_true lit orelse is_false lit"</span> <span class="main">;</span>
      <span class="entity">result</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_forall</span> <span class="entity">f</span> <span class="entity">a</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">i</span> <span class="main">=</span> Unsynchronized.ref <span class="inner_numeral">0</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">result</span> <span class="main">=</span> Unsynchronized.ref true <span class="keyword2"><span class="keyword">in</span></span> 
      <span class="keyword2"><span class="keyword">while</span></span> !<span class="entity">i</span> &lt; Array.length <span class="entity">a</span> <span class="keyword1"><span class="keyword">andalso</span></span> !<span class="entity">result</span> <span class="keyword2"><span class="keyword">do</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">f</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> !<span class="entity">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="main">)</span>
           <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">result</span> := false <span class="main">;</span>
           <span class="entity">i</span> := !<span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="main">;</span>
      !<span class="entity">result</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_mem</span> <span class="entity">x</span> <span class="entity">a</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">i</span> <span class="main">=</span> Unsynchronized.ref <span class="inner_numeral">0</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">result</span> <span class="main">=</span> Unsynchronized.ref false <span class="keyword2"><span class="keyword">in</span></span> 
      <span class="keyword2"><span class="keyword">while</span></span> !<span class="entity">i</span> &lt; Array.length <span class="entity">a</span> <span class="keyword1"><span class="keyword">andalso</span></span> not <span class="main">(</span>!<span class="entity">result</span><span class="main">)</span> <span class="keyword2"><span class="keyword">do</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">x</span> <span class="main">=</span> Array.sub <span class="main">(</span><span class="entity">a</span><span class="main">,</span> !<span class="entity">i</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">result</span> := true <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">;</span>
           <span class="entity">i</span> := !<span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="main">;</span>
      !<span class="entity">result</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">explanation_valid</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lit</span> <span class="entity">lits</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">others_false</span> <span class="entity">l</span> <span class="main">=</span> <span class="entity">is_false</span> <span class="entity">s</span> <span class="entity">l</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">l</span> <span class="main">=</span> <span class="entity">lit</span> <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">array_mem</span> <span class="entity">lit</span> <span class="entity">lits</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">array_forall</span> <span class="entity">others_false</span> <span class="entity">lits</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">reason_valid</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lit</span> <span class="entity">r</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">r</span>
   <span class="keyword2"><span class="keyword">of</span></span> <span class="entity">Unassigned</span> <span class="main">=&gt;</span> false
    <span class="main">|</span> <span class="entity">Decision</span> <span class="main">=&gt;</span> true
    <span class="main">|</span> <span class="entity">Propagation</span> <span class="entity">cls</span> <span class="main">=&gt;</span> <span class="entity">explanation_valid</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="main">(</span><span class="main">#</span>literals <span class="entity">cls</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">assign_lit</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lit</span> <span class="entity">reason'</span> <span class="main">=</span>
<span class="main">(</span>
  <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
         <span class="inner_quoted">"assign_lit violates: not (!(#conflict_detected s))"</span> <span class="main">;</span>
  <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span><span class="entity">is_assigned</span> <span class="entity">s</span> <span class="entity">lit</span><span class="main">)</span><span class="main">)</span> <span class="inner_quoted">"assign_lit violates: not (is_assigned lit)"</span> <span class="main">;</span>
  <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">reason_valid</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="entity">reason'</span><span class="main">)</span> <span class="main">(</span><span class="inner_quoted">"assign_lit violates: reason_valid lit reason'"</span><span class="main">)</span> <span class="main">;</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">var</span> <span class="main">=</span> abs <span class="entity">lit</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">var_val</span> <span class="main">=</span> SOME <span class="main">(</span><span class="entity">lit</span> &gt; <span class="inner_numeral">0</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">reason'</span> <span class="main">=</span> <span class="entity">Decision</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="main">#</span>decision_level <span class="entity">s</span><span class="main">)</span> := !<span class="main">(</span><span class="main">#</span>decision_level <span class="entity">s</span><span class="main">)</span> + <span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">;</span>
      Array.update <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>reason_array <span class="entity">s</span><span class="main">)</span><span class="main">,</span> <span class="entity">var</span><span class="main">,</span> <span class="entity">reason'</span><span class="main">)</span> <span class="main">;</span>
      Array.update <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>assignment_array <span class="entity">s</span><span class="main">)</span><span class="main">,</span> <span class="entity">var</span><span class="main">,</span> <span class="entity">var_val</span><span class="main">)</span> <span class="main">;</span>
      Array.update <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>level_array <span class="entity">s</span><span class="main">)</span><span class="main">,</span> <span class="entity">var</span><span class="main">,</span> !<span class="main">(</span><span class="main">#</span>decision_level <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
      Array.update <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>position <span class="entity">s</span><span class="main">)</span><span class="main">,</span> <span class="entity">var</span><span class="main">,</span> <span class="entity">Vec.length</span> <span class="main">(</span><span class="main">#</span>trace <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
      <span class="entity">Vec.push</span> <span class="main">(</span><span class="main">#</span>trace <span class="entity">s</span><span class="main">)</span> <span class="entity">lit</span>
  <span class="keyword2"><span class="keyword">end</span></span>
<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">early_level</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lit</span> <span class="main">=</span> Array.sub <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>early_level_array <span class="entity">s</span><span class="main">)</span><span class="main">,</span> abs <span class="entity">lit</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">early_reason</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lit</span> <span class="main">=</span> Array.sub <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>early_reason_array <span class="entity">s</span><span class="main">)</span><span class="main">,</span> abs <span class="entity">lit</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rescale_clause_activities</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rescale</span> <span class="entity">c</span> <span class="main">=</span> <span class="main">#</span>activity <span class="entity">c</span> := !<span class="main">(</span><span class="main">#</span>activity <span class="entity">c</span><span class="main">)</span> * <span class="entity">min_float</span> <span class="keyword2"><span class="keyword">in</span></span> 
      <span class="entity">Vec.iter</span> <span class="entity">rescale</span> <span class="main">(</span><span class="main">#</span>learned <span class="entity">s</span><span class="main">)</span> <span class="main">;</span>
      <span class="main">(</span><span class="main">#</span>cls_increment <span class="entity">s</span><span class="main">)</span> := !<span class="main">(</span><span class="main">#</span>cls_increment <span class="entity">s</span><span class="main">)</span> * <span class="entity">min_float</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">inc_clause_activity</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">cls</span> <span class="main">=</span> 
<span class="main">(</span>
  <span class="keyword2"><span class="keyword">if</span></span> !<span class="main">(</span><span class="main">#</span>activity <span class="entity">cls</span><span class="main">)</span> &gt; <span class="entity">max_float</span> - !<span class="main">(</span><span class="main">#</span>cls_increment <span class="entity">s</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="entity">rescale_clause_activities</span> <span class="entity">s</span>
  <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">;</span>
  <span class="main">#</span>activity <span class="entity">cls</span> := !<span class="main">(</span><span class="main">#</span>activity <span class="entity">cls</span><span class="main">)</span> + !<span class="main">(</span><span class="main">#</span>cls_increment <span class="entity">s</span><span class="main">)</span>
<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">level</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lit</span> <span class="main">=</span> <span class="main">(</span>Array.sub <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>level_array <span class="entity">s</span><span class="main">)</span><span class="main">,</span> abs <span class="entity">lit</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">unit_propagation_possible</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="main">=</span> 
  !<span class="main">(</span><span class="main">#</span>next_inference_lit <span class="entity">s</span><span class="main">)</span> &lt; <span class="entity">Vec.length</span> <span class="main">(</span><span class="main">#</span>trace <span class="entity">s</span><span class="main">)</span> 

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">invariant</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> !<span class="main">(</span><span class="main">#</span>num_vars <span class="entity">s</span><span class="main">)</span> &gt; <span class="inner_numeral">1</span><span class="main">)</span> <span class="inner_quoted">"invariant violates: !(#num_vars s) &gt; 1"</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> !<span class="main">(</span><span class="main">#</span>decision_level <span class="entity">s</span><span class="main">)</span> &gt;= <span class="inner_numeral">0</span><span class="main">)</span> <span class="inner_quoted">"invariant violates: !(#decision_level s) &gt;= 0"</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">Vec.length</span> <span class="main">(</span><span class="main">#</span>trace <span class="entity">s</span><span class="main">)</span> &gt;= !<span class="main">(</span><span class="main">#</span>decision_level <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="inner_quoted">"invariant violates: Vec.length (#trace s) &gt;= !(#decision_level s)"</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">Vec.length</span> <span class="main">(</span><span class="main">#</span>trace <span class="entity">s</span><span class="main">)</span> + <span class="entity">queue_length</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>decision_queue <span class="entity">s</span><span class="main">)</span><span class="main">)</span> &gt;= !<span class="main">(</span><span class="main">#</span>num_vars <span class="entity">s</span><span class="main">)</span><span class="main">)</span>
          <span class="inner_quoted">"invariant violates: Vec.length (#trace s) + queue_length (!(#decision_queue s)) &gt;= !(#num_vars s)"</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">Vec.length</span> <span class="main">(</span><span class="main">#</span>trace <span class="entity">s</span><span class="main">)</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">is_true</span> <span class="entity">s</span> <span class="main">(</span><span class="entity">Vec.top</span> <span class="main">(</span><span class="main">#</span>trace <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="inner_quoted">"invariant violates: Vec.length (#trace s) = 0 orelse is_true (Vec.top (#trace s))"</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> !<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">Vec.length</span> <span class="main">(</span><span class="main">#</span>trace <span class="entity">s</span><span class="main">)</span> &gt;= !<span class="main">(</span><span class="main">#</span>next_inference_lit <span class="entity">s</span><span class="main">)</span><span class="main">)</span>
          <span class="inner_quoted">"invariant violates: !(#conflict_detected s) orelse Vec.length (#trace s) &gt;= !(#next_inference_lit s)"</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> !<span class="main">(</span><span class="main">#</span>next_inference_lit <span class="entity">s</span><span class="main">)</span> + <span class="inner_numeral">1</span> &gt;= !<span class="main">(</span><span class="main">#</span>decision_level <span class="entity">s</span><span class="main">)</span><span class="main">)</span>
          <span class="inner_quoted">"invariant violates: !(#next_inference_lit s) + 1 &gt;= !(#decision_level s)"</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> !<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span> <span class="keyword1"><span class="keyword">orelse</span></span> not <span class="main">(</span><span class="entity">unit_propagation_possible</span> <span class="entity">s</span><span class="main">)</span> <span class="keyword1"><span class="keyword">orelse</span></span>
            <span class="entity">level</span> <span class="entity">s</span> <span class="main">(</span><span class="entity">Vec.get</span> <span class="main">(</span><span class="main">#</span>trace <span class="entity">s</span><span class="main">)</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>next_inference_lit <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> !<span class="main">(</span><span class="main">#</span>decision_level <span class="entity">s</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span><span class="inner_quoted">"invariant violates: !(#conflict_detected s) orelse not (unit_propagation_possible ()) orelse\n"</span> ^
           <span class="inner_quoted">"level (Vec.get (#trace s) (!(#next_inference_lit s))) = !(#decision_level s)"</span><span class="main">)</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> !<span class="main">(</span><span class="main">#</span>num_implication_points <span class="entity">s</span><span class="main">)</span> &gt;= <span class="inner_numeral">0</span><span class="main">)</span> <span class="inner_quoted">"invariant violates: !(#num_implication_points s) &gt;= 0"</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> !<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span> <span class="keyword1"><span class="keyword">orelse</span></span> !<span class="main">(</span><span class="main">#</span>num_implication_points <span class="entity">s</span><span class="main">)</span> <span class="main">=</span> <span class="inner_numeral">0</span><span class="main">)</span>
          <span class="inner_quoted">"invariant violates: !(#conflict_detected s) orelse !(#num_implication_points s) = 0"</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> !<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span> <span class="keyword1"><span class="keyword">orelse</span></span> !<span class="main">(</span><span class="main">#</span>lower_conflict_lits <span class="entity">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span><span class="main">)</span>
          <span class="inner_quoted">"invariant violates: !(#conflict_detected s) orelse !(#lower_conflict_lits s) = []"</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1"><span class="keyword">orelse</span></span> !<span class="main">(</span><span class="main">#</span>conflict_level <span class="entity">s</span><span class="main">)</span> &lt;= !<span class="main">(</span><span class="main">#</span>decision_level <span class="entity">s</span><span class="main">)</span><span class="main">)</span>
          <span class="inner_quoted">"invariant violates: not (!(#conflict_detected s)) orelse !(#conflict_level s) &lt;= !(#decision_level s)"</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1"><span class="keyword">orelse</span></span> !<span class="main">(</span><span class="main">#</span>conflict_level <span class="entity">s</span><span class="main">)</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword1"><span class="keyword">orelse</span></span> 
            !<span class="main">(</span><span class="main">#</span>num_implication_points <span class="entity">s</span><span class="main">)</span> &gt; <span class="inner_numeral">0</span><span class="main">)</span>
          <span class="main">(</span><span class="inner_quoted">"invariant violates: not (!(#conflict_detected s)) orelse !(#conflict_level s) = 0 orelse \n"</span> ^
           <span class="inner_quoted">"!(#num_implication_points s) &gt; 0"</span><span class="main">)</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1"><span class="keyword">orelse</span></span> !<span class="main">(</span><span class="main">#</span>conflict_level <span class="entity">s</span><span class="main">)</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword1"><span class="keyword">orelse</span></span>
            !<span class="main">(</span><span class="main">#</span>decision_level <span class="entity">s</span><span class="main">)</span> <span class="main">=</span> !<span class="main">(</span><span class="main">#</span>conflict_level <span class="entity">s</span><span class="main">)</span><span class="main">)</span> 
          <span class="main">(</span><span class="inner_quoted">"invariant violates: not (!(#conflict_detected s)) orelse !(#conflict_level s) = 0 orelse\n"</span> ^
           <span class="inner_quoted">"!(#decision_level s) = !(#conflict_level s)"</span><span class="main">)</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1"><span class="keyword">orelse</span></span> !<span class="main">(</span><span class="main">#</span>conflict_level <span class="entity">s</span><span class="main">)</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword1"><span class="keyword">orelse</span></span>
            !<span class="main">(</span><span class="main">#</span>num_implication_points <span class="entity">s</span><span class="main">)</span> <span class="main">=</span> <span class="inner_numeral">1</span><span class="main">)</span>
          <span class="main">(</span><span class="inner_quoted">"invariant violates: not (!(#conflict_detected s)) orelse !(#conflict_level s) = 0 orelse"</span> ^
           <span class="inner_quoted">"!(#num_implication_points s) = 1"</span><span class="main">)</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="inner_numeral">0.0</span> &lt; !<span class="main">(</span><span class="main">#</span>cls_increment <span class="entity">s</span><span class="main">)</span> <span class="keyword1"><span class="keyword">andalso</span></span> !<span class="main">(</span><span class="main">#</span>cls_increment <span class="entity">s</span><span class="main">)</span> &lt;= !<span class="main">(</span><span class="main">#</span>shy_of_max <span class="entity">s</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span><span class="inner_quoted">"invariant violates: 0.0 &lt; !(#cls_increment s) andalso !(#cls_increment s) &lt;= !(#shy_of_max s)"</span><span class="main">)</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="inner_numeral">0.0</span> &lt; !<span class="main">(</span><span class="main">#</span>var_increment <span class="entity">s</span><span class="main">)</span> <span class="keyword1"><span class="keyword">andalso</span></span> !<span class="main">(</span><span class="main">#</span>var_increment <span class="entity">s</span><span class="main">)</span> &lt;= !<span class="main">(</span><span class="main">#</span>shy_of_max <span class="entity">s</span><span class="main">)</span><span class="main">)</span>
          <span class="inner_quoted">"invariant violates: 0.0 &lt; !(#var_increment s) andalso !(#var_increment s) &lt;= !(#shy_of_max s)"</span> <span class="main">;</span>
   true
  <span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">remove_early_implication</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lit</span> <span class="main">=</span> 
<span class="main">(</span>
  <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
         <span class="inner_quoted">"remove_early_implication violates: not (!(#conflict_detected s))"</span> <span class="main">;</span>
  <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">early_level</span> <span class="entity">s</span> <span class="entity">lit</span> &gt; !<span class="main">(</span><span class="main">#</span>decision_level <span class="entity">s</span><span class="main">)</span><span class="main">)</span> 
         <span class="inner_quoted">"remove_early_implication violates: early_level lit &gt; !(#decision_level s)"</span> <span class="main">;</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">var</span> <span class="main">=</span> abs <span class="entity">lit</span> <span class="keyword2"><span class="keyword">in</span></span>
      Array.update <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>early_reason_array <span class="entity">s</span><span class="main">)</span><span class="main">,</span> <span class="entity">var</span><span class="main">,</span> <span class="entity">empty_clause</span><span class="main">)</span> <span class="main">;</span>
      Array.update <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>early_level_array <span class="entity">s</span><span class="main">)</span><span class="main">,</span> <span class="entity">var</span><span class="main">,</span> <span class="entity">invalid_level</span><span class="main">)</span> <span class="main">;</span>
      <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
             <span class="inner_quoted">"remove_early_implication violates: not (!(#conflict_detected s))"</span>
  <span class="keyword2"><span class="keyword">end</span></span>
<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rescale_decision_priorities</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span>
      <span class="entity">PriorityQueue.scale</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>decision_queue <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="entity">min_float</span> <span class="main">;</span>
      <span class="main">(</span><span class="main">#</span>var_increment <span class="entity">s</span><span class="main">)</span> := !<span class="main">(</span><span class="main">#</span>var_increment <span class="entity">s</span><span class="main">)</span> * <span class="entity">min_float</span>
  <span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">inc_decision_priority</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lit</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">var</span> <span class="main">=</span> abs <span class="entity">lit</span> 
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">priority</span> <span class="main">=</span> <span class="entity">PriorityQueue.priority</span> <span class="main">(</span><span class="main">(</span>!<span class="main">(</span><span class="main">#</span>decision_queue <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">var</span> <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">priority</span> &gt; <span class="entity">max_float</span> - !<span class="main">(</span><span class="main">#</span>var_increment <span class="entity">s</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
          <span class="entity">rescale_decision_priorities</span> <span class="entity">s</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">;</span>
      <span class="entity">PriorityQueue.inc_priority</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>decision_queue <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="entity">var</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>var_increment <span class="entity">s</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_conflict_lit</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lit</span> <span class="main">=</span> member <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_vars <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>abs <span class="entity">lit</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_conflict_lit</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lit</span> <span class="main">=</span> 
<span class="main">(</span>
  <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> !<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="inner_quoted">"add_conflict_lit violates: !(#conflict_detected s)"</span> <span class="main">;</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lit_level</span> <span class="main">=</span> <span class="entity">level</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">lit_level</span> &lt;= !<span class="main">(</span><span class="main">#</span>conflict_level <span class="entity">s</span><span class="main">)</span><span class="main">)</span> 
             <span class="inner_quoted">"add_conflict_lit violates: lit_level &lt;= !(#conflict_level s)"</span> <span class="main">;</span>
      <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span><span class="entity">is_conflict_lit</span> <span class="entity">s</span> <span class="entity">lit</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="main">(</span>
          <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">is_false</span> <span class="entity">s</span> <span class="entity">lit</span><span class="main">)</span> <span class="inner_quoted">"add_conflict_lit violates: is_false lit"</span> <span class="main">;</span>
          <span class="main">(</span><span class="main">#</span>conflict_vars <span class="entity">s</span><span class="main">)</span> := insert <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="main">(</span>abs <span class="entity">lit</span><span class="main">)</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_vars <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
          <span class="entity">inc_decision_priority</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="main">;</span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">lit_level</span> <span class="main">=</span> !<span class="main">(</span><span class="main">#</span>conflict_level <span class="entity">s</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
              <span class="main">(</span><span class="main">(</span><span class="main">#</span>num_implication_points <span class="entity">s</span><span class="main">)</span> := !<span class="main">(</span><span class="main">#</span>num_implication_points <span class="entity">s</span><span class="main">)</span> + <span class="inner_numeral">1</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">#</span>lower_conflict_lits <span class="entity">s</span><span class="main">)</span> := <span class="entity">lit</span> :: !<span class="main">(</span><span class="main">#</span>lower_conflict_lits <span class="entity">s</span><span class="main">)</span>
      <span class="main">)</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">unsatisfiable</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="main">=</span> !<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span> <span class="keyword1"><span class="keyword">andalso</span></span> !<span class="main">(</span><span class="main">#</span>conflict_level <span class="entity">s</span><span class="main">)</span> <span class="main">=</span> <span class="inner_numeral">0</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">unassign_last_lit</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span><span class="entity">Vec.is_empty</span> <span class="main">(</span><span class="main">#</span>trace <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="inner_quoted">"unassign_last_lit violates: not (null (#trace s))"</span> <span class="main">;</span>
   <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lit</span> <span class="main">=</span> <span class="entity">Vec.pop</span> <span class="main">(</span><span class="main">#</span>trace <span class="entity">s</span><span class="main">)</span>
       <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">var</span> <span class="main">=</span> abs <span class="entity">lit</span>
       <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">reason</span> <span class="main">=</span> Array.sub <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>reason_array <span class="entity">s</span><span class="main">)</span><span class="main">,</span> <span class="entity">var</span><span class="main">)</span>
   <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">is_assigned</span> <span class="entity">s</span> <span class="entity">lit</span><span class="main">)</span> <span class="inner_quoted">"unassign_last_lit violates: is_assigned lit"</span> <span class="main">;</span>
      <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">reason_valid</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="entity">reason</span><span class="main">)</span> <span class="inner_quoted">"unassign_last_lit violates: reason_valid lit reason"</span> <span class="main">;</span>
      <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">level</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="main">=</span> !<span class="main">(</span><span class="main">#</span>decision_level <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="inner_quoted">"unassign_last_lit violates: level lit = !(#decision_level s)"</span> <span class="main">;</span>
      Array.update <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>reason_array <span class="entity">s</span><span class="main">)</span><span class="main">,</span> <span class="entity">var</span><span class="main">,</span> <span class="entity">Unassigned</span><span class="main">)</span> <span class="main">;</span>
      Array.update <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>assignment_array <span class="entity">s</span><span class="main">)</span><span class="main">,</span> <span class="entity">var</span><span class="main">,</span> NONE<span class="main">)</span> <span class="main">;</span>
      <span class="entity">PriorityQueue.enqueue</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>decision_queue <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="entity">var</span> <span class="main">;</span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">reason</span> <span class="main">=</span> <span class="entity">Decision</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="main">#</span>decision_level <span class="entity">s</span><span class="main">)</span> := !<span class="main">(</span><span class="main">#</span>decision_level <span class="entity">s</span><span class="main">)</span> - <span class="inner_numeral">1</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">;</span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">early_level</span> <span class="entity">s</span> <span class="entity">lit</span> &lt;&gt; <span class="entity">invalid_level</span> <span class="keyword2"><span class="keyword">then</span></span> 
      <span class="main">(</span>
          <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">early_level</span> <span class="entity">s</span> <span class="entity">lit</span> &lt;= <span class="entity">level</span> <span class="entity">s</span> <span class="entity">lit</span><span class="main">)</span> 
                 <span class="inner_quoted">"unassign_last_lit violates: early_level lit &lt;= level lit"</span> <span class="main">;</span>
          <span class="main">(</span><span class="main">#</span>pending_literals <span class="entity">s</span><span class="main">)</span> := Queue.enqueue <span class="entity">lit</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>pending_literals <span class="entity">s</span><span class="main">)</span><span class="main">)</span>
      <span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_inferred</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lit</span> <span class="main">=</span> 
  <span class="main">(</span><span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">is_true</span> <span class="entity">s</span> <span class="entity">lit</span><span class="main">)</span> <span class="inner_quoted">"is_inferred violates: is_true lit"</span> <span class="main">;</span>
   <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">reason</span> <span class="entity">s</span> <span class="entity">lit</span>
    <span class="keyword2"><span class="keyword">of</span></span> <span class="entity">Propagation</span> <span class="main">_</span> <span class="main">=&gt;</span> true
     <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">unit_propagating_clause</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lit</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">reason</span> <span class="entity">s</span> <span class="entity">lit</span>
   <span class="keyword2"><span class="keyword">of</span></span> <span class="entity">Propagation</span> <span class="entity">cls</span> <span class="main">=&gt;</span> 
      <span class="main">(</span><span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">explanation_valid</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="main">(</span><span class="main">#</span>literals <span class="entity">cls</span><span class="main">)</span><span class="main">)</span> 
              <span class="inner_quoted">"unit_propagating_clause violates: explanation_valid lit (#literals cls)"</span> <span class="main">;</span> <span class="entity">cls</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword3"><span class="keyword">raise</span></span> error <span class="inner_quoted">"unit_propagating_clause violates: false"</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">del_conflict_lit</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lit</span> <span class="main">=</span> 
  <span class="main">(</span><span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> !<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="inner_quoted">"del_conflict_lit violates: !(#conflict_detected s)"</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">is_conflict_lit</span> <span class="entity">s</span> <span class="entity">lit</span><span class="main">)</span> <span class="inner_quoted">"del_conflict_lit violates: is_conflict_lit lit"</span> <span class="main">;</span>
   <span class="main">(</span><span class="main">#</span>conflict_vars <span class="entity">s</span><span class="main">)</span> := filter <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">x</span> &lt;&gt; abs <span class="entity">lit</span><span class="main">)</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_vars <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">set_explanation</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lits</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lit</span> <span class="main">=</span> <span class="entity">Vec.top</span> <span class="main">(</span><span class="main">#</span>trace <span class="entity">s</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>  Array.app <span class="main">(</span><span class="entity">add_conflict_lit</span> <span class="entity">s</span><span class="main">)</span> <span class="entity">lits</span> <span class="main">;</span>
      <span class="entity">del_conflict_lit</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="main">;</span>
      <span class="main">(</span><span class="main">#</span>num_implication_points <span class="entity">s</span><span class="main">)</span> := !<span class="main">(</span><span class="main">#</span>num_implication_points <span class="entity">s</span><span class="main">)</span> - <span class="inner_numeral">1</span> <span class="main">;</span>
      <span class="entity">unassign_last_lit</span> <span class="entity">s</span> <span class="main">;</span>
      <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> !<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="inner_quoted">"set_explanation violates: !(#conflict_detected s)"</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">explain_inferences</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> !<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span> 
          <span class="inner_quoted">"explain_inferences violates: (#conflict_detected s) ()"</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span><span class="entity">unsatisfiable</span> <span class="entity">s</span><span class="main">)</span><span class="main">)</span> 
          <span class="inner_quoted">"explain_inferences violates: not (unsatisfiable ())"</span> <span class="main">;</span>
   <span class="keyword2"><span class="keyword">while</span></span> not <span class="main">(</span><span class="entity">is_conflict_lit</span> <span class="entity">s</span> <span class="main">(</span><span class="entity">Vec.top</span> <span class="main">(</span><span class="main">#</span>trace <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">do</span></span>
       <span class="entity">unassign_last_lit</span> <span class="entity">s</span> <span class="main">;</span>
   <span class="keyword2"><span class="keyword">if</span></span> !<span class="main">(</span><span class="main">#</span>num_implication_points <span class="entity">s</span><span class="main">)</span> &gt; <span class="inner_numeral">1</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">is_inferred</span> <span class="entity">s</span> <span class="main">(</span><span class="entity">Vec.top</span> <span class="main">(</span><span class="main">#</span>trace <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
       <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cls</span> <span class="main">=</span> <span class="entity">unit_propagating_clause</span> <span class="entity">s</span> <span class="main">(</span><span class="entity">Vec.top</span> <span class="main">(</span><span class="main">#</span>trace <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
           <span class="entity">inc_clause_activity</span> <span class="entity">s</span> <span class="entity">cls</span> <span class="main">;</span>
           <span class="entity">set_explanation</span> <span class="entity">s</span> <span class="main">(</span><span class="main">#</span>literals <span class="entity">cls</span><span class="main">)</span> <span class="main">;</span>
           <span class="entity">explain_inferences</span> <span class="entity">s</span>
       <span class="keyword2"><span class="keyword">end</span></span>
   <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
  <span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">set_conflict</span>
      <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">iter</span> <span class="entity">fold</span> <span class="entity">lits</span> <span class="main">=</span> 
<span class="main">(</span>
  <span class="main">(</span><span class="main">#</span>num_conflicts <span class="entity">s</span><span class="main">)</span> := !<span class="main">(</span><span class="main">#</span>num_conflicts <span class="entity">s</span><span class="main">)</span> + <span class="inner_numeral">1</span> <span class="main">;</span>
  <span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span> := true <span class="main">;</span>
  <span class="main">(</span><span class="main">#</span>conflict_level <span class="entity">s</span><span class="main">)</span> := <span class="entity">fold</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">l</span><span class="main">,</span> <span class="entity">acc</span><span class="main">)</span> <span class="main">=&gt;</span> Int.max <span class="main">(</span><span class="entity">acc</span><span class="main">,</span> <span class="main">(</span><span class="entity">level</span> <span class="entity">s</span> <span class="entity">l</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="inner_numeral">0</span> <span class="entity">lits</span> <span class="main">;</span>
  <span class="entity">iter</span> <span class="main">(</span><span class="entity">add_conflict_lit</span> <span class="entity">s</span><span class="main">)</span> <span class="entity">lits</span> <span class="main">;</span>
  <span class="keyword2"><span class="keyword">if</span></span> !<span class="main">(</span><span class="main">#</span>conflict_level <span class="entity">s</span><span class="main">)</span> &lt;&gt; <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">explain_inferences</span> <span class="entity">s</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">set_conflict_lits</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lits</span> <span class="main">=</span> 
<span class="main">(</span>
  <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
         <span class="inner_quoted">"set_conflict_lits violates: not (!(#conflict_detected s))"</span> <span class="main">;</span>
  <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">array_forall</span> <span class="main">(</span><span class="entity">is_false</span> <span class="entity">s</span><span class="main">)</span> <span class="entity">lits</span><span class="main">)</span> 
         <span class="inner_quoted">"set_conflict_lits violates: array_forall is_false lits"</span> <span class="main">;</span>
  <span class="entity">set_conflict</span> <span class="entity">s</span> Array.app Array.foldl <span class="entity">lits</span> <span class="main">;</span>
  <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> !<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="inner_quoted">"set_conflict_lits violates: !(#conflict_detected s)"</span>
<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">assign_early_implication</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lit</span> <span class="main">=</span> 
<span class="main">(</span>
  <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
         <span class="inner_quoted">"assign_early_implication violates: not (!(#conflict_detected s))"</span> <span class="main">;</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">level</span> <span class="main">=</span> <span class="entity">early_level</span> <span class="entity">s</span> <span class="entity">lit</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">reason</span> <span class="main">=</span> <span class="entity">early_reason</span> <span class="entity">s</span> <span class="entity">lit</span>
  <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">level</span> &lt;= !<span class="main">(</span><span class="main">#</span>decision_level <span class="entity">s</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
      <span class="main">(</span>
          <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">explanation_valid</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="main">(</span><span class="main">#</span>literals <span class="entity">reason</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_false</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="keyword2"><span class="keyword">then</span></span>
          <span class="main">(</span>
              <span class="entity">set_conflict_lits</span> <span class="entity">s</span> <span class="main">(</span><span class="main">#</span>literals <span class="entity">reason</span><span class="main">)</span> <span class="main">;</span>
              <span class="entity">inc_clause_activity</span> <span class="entity">s</span> <span class="entity">reason</span>
          <span class="main">)</span>
          <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span><span class="entity">is_assigned</span> <span class="entity">s</span> <span class="entity">lit</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
              <span class="main">(</span><span class="entity">assign_lit</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="main">(</span><span class="entity">Propagation</span> <span class="entity">reason</span><span class="main">)</span>
              <span class="main">)</span>
          <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
      <span class="main">)</span>
      <span class="keyword2"><span class="keyword">else</span></span>
          <span class="entity">remove_early_implication</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="main">;</span>
      <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">invariant</span> <span class="entity">s</span><span class="main">)</span> <span class="inner_quoted">"assign_early_implication violates: invariant ()"</span>
  <span class="keyword2"><span class="keyword">end</span></span>
<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">backjump_possible</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="main">=</span> 
  !<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span> <span class="keyword1"><span class="keyword">andalso</span></span> 
  !<span class="main">(</span><span class="main">#</span>conflict_level <span class="entity">s</span><span class="main">)</span> &gt; <span class="inner_numeral">0</span> <span class="keyword1"><span class="keyword">andalso</span></span> 
  !<span class="main">(</span><span class="main">#</span>num_implication_points <span class="entity">s</span><span class="main">)</span> <span class="main">=</span> <span class="inner_numeral">1</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">backtrack</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lev</span> <span class="main">=</span> 
  <span class="main">(</span>
      <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> !<span class="main">(</span><span class="main">#</span>decision_level <span class="entity">s</span><span class="main">)</span> &gt; <span class="inner_numeral">0</span><span class="main">)</span> <span class="inner_quoted">"backtrack violates: !(#decision_level s) &gt; 0"</span> <span class="main">;</span>
      <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> !<span class="main">(</span><span class="main">#</span>decision_level <span class="entity">s</span><span class="main">)</span> &gt; <span class="entity">lev</span><span class="main">)</span> <span class="inner_quoted">"backtrack violates: !(#decision_level s) &gt; lev"</span> <span class="main">;</span>
      <span class="keyword2"><span class="keyword">while</span></span> !<span class="main">(</span><span class="main">#</span>decision_level <span class="entity">s</span><span class="main">)</span> &gt; <span class="entity">lev</span> <span class="keyword2"><span class="keyword">do</span></span>
          <span class="main">(</span>
           <span class="entity">unassign_last_lit</span> <span class="entity">s</span>
          <span class="main">)</span> <span class="main">;</span>
      <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n</span> <span class="main">=</span> <span class="entity">Vec.length</span> <span class="main">(</span><span class="main">#</span>trace <span class="entity">s</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span> 
          <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> !<span class="main">(</span><span class="main">#</span>next_inference_lit <span class="entity">s</span><span class="main">)</span> &gt;= <span class="entity">n</span><span class="main">)</span> <span class="inner_quoted">"backtrack violates: !(#next_inference_lit s) &gt;= n"</span> <span class="main">;</span>
          <span class="main">(</span><span class="main">#</span>next_inference_lit <span class="entity">s</span><span class="main">)</span> := <span class="entity">n</span> <span class="main">;</span>
          <span class="main">(</span><span class="main">#</span>next_inference_cls <span class="entity">s</span><span class="main">)</span> := <span class="inner_numeral">0</span> <span class="main">;</span>
          <span class="main">(</span><span class="main">#</span>dispatch_lit <span class="entity">s</span><span class="main">)</span> := Int.min <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>dispatch_lit <span class="entity">s</span><span class="main">)</span><span class="main">,</span> <span class="entity">n</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">clear_conflict</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">backjump_possible</span> <span class="entity">s</span><span class="main">)</span> <span class="inner_quoted">"clear_conflict violates: backjump_possible s"</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> !<span class="main">(</span><span class="main">#</span>decision_level <span class="entity">s</span><span class="main">)</span> <span class="main">=</span> !<span class="main">(</span><span class="main">#</span>conflict_level <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="inner_quoted">"clear_conflict violates: !(#decision_level s) = !(#conflict_level s)"</span> <span class="main">;</span>
   <span class="entity">del_conflict_lit</span> <span class="entity">s</span> <span class="main">(</span><span class="entity">Vec.top</span> <span class="main">(</span><span class="main">#</span>trace <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
   <span class="main">(</span><span class="main">#</span>num_implication_points <span class="entity">s</span><span class="main">)</span> := <span class="inner_numeral">0</span> <span class="main">;</span>
   List.app <span class="main">(</span><span class="entity">del_conflict_lit</span> <span class="entity">s</span><span class="main">)</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>lower_conflict_lits <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
   <span class="main">(</span><span class="main">#</span>lower_conflict_lits <span class="entity">s</span><span class="main">)</span> := <span class="main">[</span><span class="main">]</span> <span class="main">;</span>
   <span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span> := false
  <span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">inference_possible</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="main">=</span> 
  <span class="entity">unit_propagation_possible</span> <span class="entity">s</span> <span class="keyword1"><span class="keyword">orelse</span></span>
  not <span class="main">(</span>Queue.is_empty <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>pending_literals <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1"><span class="keyword">orelse</span></span>
  not <span class="main">(</span>Queue.is_empty <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>pending_clauses <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_empty</span> <span class="entity">xs</span> <span class="main">=</span> null <span class="entity">xs</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_implication_point</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lit</span> <span class="main">=</span> 
  <span class="entity">is_conflict_lit</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">level</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="main">=</span> !<span class="main">(</span><span class="main">#</span>conflict_level <span class="entity">s</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">literal_map_find</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">arr</span> <span class="entity">lit</span> <span class="main">=</span> Array.sub <span class="main">(</span>!<span class="entity">arr</span><span class="main">,</span> <span class="entity">lit</span> + !<span class="main">(</span><span class="main">#</span>max_var <span class="entity">s</span><span class="main">)</span> + <span class="inner_numeral">1</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">remove_known_false</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lits</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">keep</span> <span class="entity">lit</span> <span class="main">=</span> <span class="main">(</span>not <span class="main">(</span><span class="entity">level</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="main">=</span> <span class="inner_numeral">0</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">is_false</span> <span class="entity">s</span> <span class="entity">lit</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> filter <span class="entity">keep</span> <span class="entity">lits</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">array_sort</span> <span class="entity">cmp</span> <span class="entity">a</span> <span class="main">=</span> 
  <span class="entity">Vec.array_sort</span> <span class="entity">cmp</span> <span class="entity">a</span> <span class="inner_numeral">0</span> <span class="main">(</span>Array.length <span class="entity">a</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_not_false</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lit</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">result</span> <span class="main">=</span> <span class="entity">assignment</span> <span class="entity">s</span> <span class="entity">lit</span> &lt;&gt; SOME false 
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">result</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">watch_valid</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">cls</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">earliest_level</span> <span class="entity">i</span> <span class="main">=</span> 
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">early_level</span> <span class="entity">s</span> <span class="entity">i</span> &lt;&gt; <span class="entity">invalid_level</span> <span class="keyword2"><span class="keyword">then</span></span>
              <span class="main">(</span><span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">early_level</span> <span class="entity">s</span> <span class="entity">i</span> &lt;= <span class="entity">level</span> <span class="entity">s</span> <span class="entity">i</span><span class="main">)</span> 
                      <span class="inner_quoted">"watch_valid violates: early_level i &lt;&gt; invalid_level"</span> <span class="main">;</span>
               <span class="entity">early_level</span> <span class="entity">s</span> <span class="entity">i</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">level</span> <span class="entity">s</span> <span class="entity">i</span>
      <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">ok</span> <span class="entity">i</span> <span class="entity">j</span> <span class="main">=</span> 
          <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lit</span> <span class="main">=</span> Array.sub <span class="main">(</span><span class="main">#</span>literals <span class="entity">cls</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">other_lit</span> <span class="main">=</span> Array.sub <span class="main">(</span><span class="main">#</span>literals <span class="entity">cls</span><span class="main">,</span> <span class="entity">j</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">is_not_false</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="keyword1"><span class="keyword">orelse</span></span>
             <span class="main">(</span><span class="entity">is_true</span> <span class="entity">s</span> <span class="entity">other_lit</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">earliest_level</span> <span class="entity">other_lit</span> &lt;= <span class="entity">level</span> <span class="entity">s</span> <span class="entity">lit</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">ok</span> <span class="inner_numeral">0</span> <span class="inner_numeral">1</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">ok</span> <span class="inner_numeral">1</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">backjump</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="main">=</span> 
<span class="main">(</span>
  <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">backjump_possible</span> <span class="entity">s</span><span class="main">)</span> <span class="inner_quoted">"backjump violates: backjump_possible s"</span> <span class="main">;</span>
  <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> !<span class="main">(</span><span class="main">#</span>decision_level <span class="entity">s</span><span class="main">)</span> <span class="main">=</span> !<span class="main">(</span><span class="main">#</span>conflict_level <span class="entity">s</span><span class="main">)</span><span class="main">)</span> 
         <span class="inner_quoted">"backjump violates: !(#decision_level s) = !(#conflict_level s)"</span> <span class="main">;</span>
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lit</span> <span class="main">=</span> <span class="entity">Vec.top</span> <span class="main">(</span><span class="main">#</span>trace <span class="entity">s</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span> 
      <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">is_implication_point</span> <span class="entity">s</span> <span class="entity">lit</span><span class="main">)</span> 
             <span class="inner_quoted">"backjump violates: is_implication_point lit"</span> <span class="main">;</span>
      <span class="keyword2"><span class="keyword">let</span></span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">learn_lits</span> <span class="main">=</span> ~ <span class="entity">lit</span> :: !<span class="main">(</span><span class="main">#</span>lower_conflict_lits <span class="entity">s</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">norm_learn_lits</span> <span class="main">=</span> <span class="entity">remove_known_false</span> <span class="entity">s</span> <span class="entity">learn_lits</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cls</span> <span class="main">=</span> <span class="entity">new_clause</span> <span class="entity">norm_learn_lits</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lits</span> <span class="main">=</span> <span class="main">#</span>literals <span class="entity">cls</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n</span> <span class="main">=</span> Array.length <span class="entity">lits</span>
      <span class="keyword2"><span class="keyword">in</span></span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span> &gt;= <span class="inner_numeral">2</span> <span class="keyword2"><span class="keyword">then</span></span>
              <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lit_level_compare</span> <span class="entity">l0</span> <span class="entity">l1</span> <span class="main">=</span> 
                      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">level</span> <span class="entity">s</span> <span class="entity">l1</span> &lt; <span class="entity">level</span> <span class="entity">s</span> <span class="entity">l0</span> <span class="keyword2"><span class="keyword">then</span></span> LESS 
                      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">level</span> <span class="entity">s</span> <span class="entity">l1</span> <span class="main">=</span> <span class="entity">level</span> <span class="entity">s</span> <span class="entity">l0</span> <span class="keyword2"><span class="keyword">then</span></span> EQUAL 
                      <span class="keyword2"><span class="keyword">else</span></span> GREATER  <span class="keyword2"><span class="keyword">in</span></span>
                  <span class="entity">array_sort</span> <span class="entity">lit_level_compare</span> <span class="entity">lits</span> <span class="main">;</span>
                  <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> Array.sub <span class="main">(</span><span class="entity">lits</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span> <span class="main">=</span> ~ <span class="entity">lit</span><span class="main">)</span> 
                         <span class="inner_quoted">"backjump violates: Array.sub (lits, 0) = ~ lit"</span> <span class="main">;</span>
                  <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">level</span> <span class="entity">s</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">lits</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span><span class="main">)</span> &gt; <span class="entity">level</span> <span class="entity">s</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">lits</span><span class="main">,</span> <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                         <span class="main">(</span><span class="inner_quoted">"backjump violates: level (Array.sub (lits, 0)) &gt; "</span> ^ 
                          <span class="inner_quoted">"level (Array.sub (lits, 1))"</span><span class="main">)</span> <span class="main">;</span>
                  <span class="entity">Vec.push</span> <span class="main">(</span><span class="main">#</span>learned <span class="entity">s</span><span class="main">)</span> <span class="entity">cls</span> <span class="main">;</span>
                  <span class="keyword2"><span class="keyword">let</span></span>
                      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">watcher0</span> <span class="main">=</span> <span class="main">(</span><span class="entity">literal_map_find</span> <span class="entity">s</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span>watchers <span class="entity">s</span><span class="main">)</span> 
                                     <span class="main">(</span>Array.sub <span class="main">(</span><span class="main">#</span>literals <span class="entity">cls</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span><span class="main">)</span>
                      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">watcher1</span> <span class="main">=</span> <span class="main">(</span><span class="entity">literal_map_find</span> <span class="entity">s</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span>watchers <span class="entity">s</span><span class="main">)</span> 
                                     <span class="main">(</span>Array.sub <span class="main">(</span><span class="main">#</span>literals <span class="entity">cls</span><span class="main">,</span> <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span>
                  <span class="keyword2"><span class="keyword">in</span></span>
                      <span class="entity">watcher0</span> := <span class="entity">cls</span> :: !<span class="entity">watcher0</span> <span class="main">;</span>
                      <span class="entity">watcher1</span> := <span class="entity">cls</span> :: !<span class="entity">watcher1</span>
                  <span class="keyword2"><span class="keyword">end</span></span> <span class="main">;</span>
                  <span class="entity">clear_conflict</span> <span class="entity">s</span> <span class="main">;</span>
                  <span class="entity">backtrack</span> <span class="entity">s</span> <span class="main">(</span><span class="entity">level</span> <span class="entity">s</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">lits</span><span class="main">,</span> <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="keyword2"><span class="keyword">end</span></span>
          <span class="keyword2"><span class="keyword">else</span></span>
          <span class="main">(</span>
              <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> Array.length <span class="entity">lits</span> <span class="main">=</span> <span class="inner_numeral">1</span><span class="main">)</span> 
                     <span class="inner_quoted">"backjump violates: Array.length lits = 1"</span> <span class="main">;</span>
              <span class="entity">clear_conflict</span> <span class="entity">s</span> <span class="main">;</span>
              <span class="entity">backtrack</span> <span class="entity">s</span> <span class="inner_numeral">0</span>
          <span class="main">)</span> <span class="main">;</span>
          <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> Array.sub <span class="main">(</span><span class="entity">lits</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span> <span class="main">=</span> ~ <span class="entity">lit</span><span class="main">)</span> 
                 <span class="inner_quoted">"backjump violates: Array.sub (lits, 0) = ~ lit"</span> <span class="main">;</span>
          <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span><span class="entity">is_assigned</span> <span class="entity">s</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">lits</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
          <span class="keyword2"><span class="keyword">while</span></span> not <span class="main">(</span>Queue.is_empty <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>pending_literals <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">do</span></span>
              <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">pending_literal</span><span class="main">,</span> 
                       <span class="entity">pending_literals</span><span class="main">)</span> <span class="main">=</span> Queue.dequeue <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>pending_literals <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">in</span></span>
                  <span class="main">(</span><span class="main">#</span>pending_literals <span class="entity">s</span><span class="main">)</span> := <span class="entity">pending_literals</span> <span class="main">;</span>
                  <span class="entity">assign_early_implication</span> <span class="entity">s</span> <span class="main">(</span><span class="entity">pending_literal</span><span class="main">)</span>
              <span class="keyword2"><span class="keyword">end</span></span> <span class="main">;</span>
          <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span><span class="entity">is_assigned</span> <span class="entity">s</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">lits</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1"><span class="keyword">orelse</span></span> 
                  <span class="entity">early_level</span> <span class="entity">s</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">lits</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span><span class="main">)</span> &lt;&gt; <span class="entity">invalid_level</span><span class="main">)</span> 
                 <span class="main">(</span><span class="inner_quoted">"backjump violates: not (is_assigned (Array.sub (lits, 0))) "</span> ^ 
                  <span class="inner_quoted">"orelse early_level (Array.sub (lits, 0)) &lt;&gt; invalid_level"</span><span class="main">)</span> <span class="main">;</span>
          <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span><span class="entity">is_true</span> <span class="entity">s</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">lits</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                 <span class="inner_quoted">"backjump violates: not (is_true (Array.sub (lits, 0)))"</span> <span class="main">;</span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_false</span> <span class="entity">s</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">lits</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
              <span class="main">(</span><span class="entity">set_conflict_lits</span> <span class="entity">s</span> <span class="main">(</span><span class="main">#</span>literals <span class="entity">cls</span><span class="main">)</span> <span class="main">;</span>
               <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> !<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="inner_quoted">"backjump violates: !(#conflict_detected s)"</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">else</span></span>
          <span class="main">(</span>
              <span class="entity">assign_lit</span> <span class="entity">s</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">lits</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Propagation</span> <span class="entity">cls</span><span class="main">)</span> <span class="main">;</span>
              <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">n</span> <span class="main">=</span> <span class="inner_numeral">1</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">watch_valid</span> <span class="entity">s</span> <span class="entity">cls</span><span class="main">)</span> 
                     <span class="inner_quoted">"backjump violates: n = 1 orelse watch_valid cls"</span> <span class="main">;</span>
              <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> !<span class="main">(</span><span class="main">#</span>decision_level <span class="entity">s</span><span class="main">)</span> &lt; !<span class="main">(</span><span class="main">#</span>conflict_level <span class="entity">s</span><span class="main">)</span><span class="main">)</span> 
                     <span class="inner_quoted">"backjump violates: (#decision_level s) () &lt; (#conflict_level s) ()"</span> <span class="main">;</span>
              <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                     <span class="inner_quoted">"backjump violates: not ((#conflict_detected s) ())"</span> <span class="main">;</span>
              <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">inference_possible</span> <span class="entity">s</span><span class="main">)</span> 
                     <span class="inner_quoted">"backjump violates: inference_possible ()"</span>
          <span class="main">)</span> <span class="main">;</span>
          <span class="keyword2"><span class="keyword">if</span></span> !<span class="main">(</span><span class="main">#</span>var_increment <span class="entity">s</span><span class="main">)</span> &gt; !<span class="main">(</span><span class="main">#</span>shy_of_max <span class="entity">s</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">rescale_decision_priorities</span> <span class="entity">s</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">;</span>
          <span class="main">(</span><span class="main">#</span>var_increment <span class="entity">s</span><span class="main">)</span> := !<span class="main">(</span><span class="main">#</span>var_increment <span class="entity">s</span><span class="main">)</span> * !<span class="main">(</span><span class="main">#</span>scale <span class="entity">s</span><span class="main">)</span> <span class="main">;</span>
          <span class="keyword2"><span class="keyword">if</span></span> !<span class="main">(</span><span class="main">#</span>cls_increment <span class="entity">s</span><span class="main">)</span> &gt; !<span class="main">(</span><span class="main">#</span>shy_of_max <span class="entity">s</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">rescale_clause_activities</span> <span class="entity">s</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">;</span>
          <span class="main">(</span><span class="main">#</span>cls_increment <span class="entity">s</span><span class="main">)</span> := !<span class="main">(</span><span class="main">#</span>cls_increment <span class="entity">s</span><span class="main">)</span> * !<span class="main">(</span><span class="main">#</span>scale <span class="entity">s</span><span class="main">)</span> <span class="main">;</span>
          <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">invariant</span> <span class="entity">s</span><span class="main">)</span> <span class="inner_quoted">"backjump violates: invariant ()"</span>
      <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>
<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">is_assigned_var</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">var</span> <span class="main">=</span> Array.sub <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>assignment_array <span class="entity">s</span><span class="main">)</span><span class="main">,</span> <span class="entity">var</span><span class="main">)</span> &lt;&gt; NONE

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">decision_possible</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="main">=</span> <span class="entity">Vec.length</span> <span class="main">(</span><span class="main">#</span>trace <span class="entity">s</span><span class="main">)</span> &lt; !<span class="main">(</span><span class="main">#</span>num_vars <span class="entity">s</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">decide</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="inner_quoted">"decide violates: not (!(#conflict_detected s))"</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span><span class="entity">inference_possible</span> <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="inner_quoted">"decide violates: not (inference_possible ())"</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">decision_possible</span> <span class="entity">s</span><span class="main">)</span> <span class="inner_quoted">"decide violates: decision_possible ()"</span> <span class="main">;</span>
   <span class="keyword2"><span class="keyword">while</span></span> <span class="entity">is_assigned_var</span> <span class="entity">s</span> <span class="main">(</span><span class="entity">PriorityQueue.head</span> <span class="main">(</span><span class="main">(</span>!<span class="main">(</span><span class="main">#</span>decision_queue <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">do</span></span>
       <span class="entity">PriorityQueue.drop</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>decision_queue <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span><span class="entity">PriorityQueue.is_empty</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>decision_queue <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="inner_quoted">"decide violates: not (PriorityQueue.is_empty (#decision_queue s))"</span> <span class="main">;</span>
   <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">var</span> <span class="main">=</span> <span class="entity">PriorityQueue.dequeue</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>decision_queue <span class="entity">s</span><span class="main">)</span><span class="main">)</span>
       <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lit</span> <span class="main">=</span> 
           <span class="keyword2"><span class="keyword">if</span></span> Array.sub <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>bias <span class="entity">s</span><span class="main">)</span><span class="main">,</span> <span class="entity">var</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">var</span>
           <span class="keyword2"><span class="keyword">else</span></span> ~ <span class="entity">var</span>
   <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="main">#</span>num_decisions <span class="entity">s</span><span class="main">)</span> := !<span class="main">(</span><span class="main">#</span>num_decisions <span class="entity">s</span><span class="main">)</span> + <span class="inner_numeral">1</span> <span class="main">;</span>
      <span class="entity">assign_lit</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="entity">Decision</span>  <span class="main">;</span>
      <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">inference_possible</span> <span class="entity">s</span><span class="main">)</span> <span class="inner_quoted">"decide violates: inference_possible ()"</span> <span class="main">;</span>
      <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">invariant</span> <span class="entity">s</span><span class="main">)</span> <span class="inner_quoted">"decide violates: invariant ()"</span> <span class="main">;</span>
      <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> !<span class="main">(</span><span class="main">#</span>decision_level <span class="entity">s</span><span class="main">)</span> &gt; <span class="inner_numeral">0</span><span class="main">)</span> <span class="inner_quoted">"decide violates: !(#decision_level s) &gt; 0"</span> <span class="main">;</span>
      <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="inner_quoted">"decide violates: not (!(#conflict_detected s))"</span> 
   <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">cls_compare</span> <span class="entity">cls0</span> <span class="entity">cls1</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">len0</span> <span class="main">=</span> Array.length <span class="main">(</span><span class="main">#</span>literals <span class="entity">cls0</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">len1</span> <span class="main">=</span> Array.length <span class="main">(</span><span class="main">#</span>literals <span class="entity">cls1</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">len0</span> &gt;= <span class="inner_numeral">2</span><span class="main">)</span> <span class="inner_quoted">"cls_compare violates: len0 &gt;= 2"</span> <span class="main">;</span>
     <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">len1</span> &gt;= <span class="inner_numeral">2</span><span class="main">)</span> <span class="inner_quoted">"cls_compare violates: len1 &gt;= 2"</span> <span class="main">;</span>
     <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">len0</span> <span class="main">=</span> <span class="inner_numeral">2</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">len1</span> <span class="main">=</span> <span class="inner_numeral">2</span> <span class="keyword2"><span class="keyword">then</span></span> EQUAL <span class="keyword2"><span class="keyword">else</span></span> LESS<span class="main">)</span>
     <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">len1</span> <span class="main">=</span> <span class="inner_numeral">2</span> <span class="keyword2"><span class="keyword">then</span></span> GREATER
     <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> !<span class="main">(</span><span class="main">#</span>activity <span class="entity">cls0</span><span class="main">)</span> &lt; !<span class="main">(</span><span class="main">#</span>activity <span class="entity">cls1</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> LESS
                      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> !<span class="main">(</span><span class="main">#</span>activity <span class="entity">cls0</span><span class="main">)</span> &gt; !<span class="main">(</span><span class="main">#</span>activity <span class="entity">cls1</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span> GREATER
                      <span class="keyword2"><span class="keyword">else</span></span> EQUAL
          <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">n</span> <span class="main">=</span> EQUAL <span class="keyword2"><span class="keyword">then</span></span> 
                 <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">len0</span> &lt; <span class="entity">len1</span> <span class="keyword2"><span class="keyword">then</span></span> LESS
                  <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">len0</span> &gt; <span class="entity">len1</span> <span class="keyword2"><span class="keyword">then</span></span> GREATER
                  <span class="keyword2"><span class="keyword">else</span></span> EQUAL<span class="main">)</span>
             <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">n</span> <span class="keyword2"><span class="keyword">end</span></span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">filteri</span> <span class="entity">f</span> <span class="entity">xs</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fltr</span> <span class="main">[</span><span class="main">]</span> <span class="entity">i</span> <span class="main">=</span> <span class="main">[</span><span class="main">]</span>
        <span class="main">|</span> <span class="entity">fltr</span> <span class="main">(</span><span class="entity">y</span> :: <span class="entity">ys</span><span class="main">)</span> <span class="entity">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">f</span> <span class="entity">i</span> <span class="entity">y</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">[</span><span class="entity">y</span><span class="main">]</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">[</span><span class="main">]</span><span class="main">)</span> @ <span class="entity">fltr</span> <span class="entity">ys</span> <span class="main">(</span><span class="entity">i</span> + <span class="inner_numeral">1</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">fltr</span> <span class="entity">xs</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">forget</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">cls</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">w0</span> <span class="main">=</span> <span class="main">(</span><span class="entity">literal_map_find</span> <span class="entity">s</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span>watchers <span class="entity">s</span><span class="main">)</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="main">#</span>literals <span class="entity">cls</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">w1</span> <span class="main">=</span> <span class="main">(</span><span class="entity">literal_map_find</span> <span class="entity">s</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span>watchers <span class="entity">s</span><span class="main">)</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="main">#</span>literals <span class="entity">cls</span><span class="main">,</span> <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">w0</span> := filter <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">x</span> &lt;&gt; <span class="entity">cls</span><span class="main">)</span> <span class="main">(</span>!<span class="entity">w0</span><span class="main">)</span> <span class="main">;</span>
     <span class="entity">w1</span> := filter <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">x</span> <span class="main">=&gt;</span> <span class="entity">x</span> &lt;&gt; <span class="entity">cls</span><span class="main">)</span> <span class="main">(</span>!<span class="entity">w1</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">forget_some_learned_clauses</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
         <span class="inner_quoted">"forget_some_learned_clauses violates: not ((#conflict_detected s) ())"</span> <span class="main">;</span>
   <span class="entity">Vec.sort</span> <span class="entity">cls_compare</span> <span class="main">(</span><span class="main">#</span>learned <span class="entity">s</span><span class="main">)</span> <span class="main">;</span>
   <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">half</span> <span class="main">=</span> <span class="entity">Vec.length</span> <span class="main">(</span><span class="main">#</span>learned <span class="entity">s</span><span class="main">)</span> div <span class="inner_numeral">2</span>
       <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">keep</span> <span class="entity">i</span> <span class="entity">cls</span> <span class="main">=</span> 
           <span class="entity">i</span> &lt; <span class="entity">half</span> <span class="keyword1"><span class="keyword">orelse</span></span> Array.length <span class="main">(</span><span class="main">#</span>literals <span class="entity">cls</span><span class="main">)</span> <span class="main">=</span> <span class="inner_numeral">2</span> 
           <span class="keyword1"><span class="keyword">orelse</span></span> <span class="main">(</span><span class="entity">forget</span> <span class="entity">s</span> <span class="entity">cls</span> <span class="main">;</span> false<span class="main">)</span>
   <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">Vec.filteri</span> <span class="entity">keep</span> <span class="main">(</span><span class="main">#</span>learned <span class="entity">s</span><span class="main">)</span> <span class="main">;</span>
      <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">invariant</span> <span class="entity">s</span><span class="main">)</span> 
             <span class="inner_quoted">"forget_some_learned_clauses violates: invariant ()"</span> <span class="main">;</span>
      <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
             <span class="inner_quoted">"forget_some_learned_clauses violates: not (!(#conflict_detected s))"</span>
   <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rev_rem_dup</span> <span class="entity">comp</span> <span class="entity">x</span> <span class="entity">acc</span> <span class="main">=</span> 
<span class="keyword1"><span class="keyword">fn</span></span> <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">acc</span>
<span class="main">|</span> <span class="main">(</span><span class="entity">h</span>::<span class="entity">t</span><span class="main">)</span> <span class="main">=&gt;</span> 
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">comp</span> <span class="entity">h</span> <span class="entity">x</span> <span class="main">=</span> EQUAL <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">rev_rem_dup</span> <span class="entity">comp</span> <span class="entity">x</span> <span class="entity">acc</span> <span class="entity">t</span> 
  <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">rev_rem_dup</span> <span class="entity">comp</span> <span class="entity">h</span> <span class="main">(</span><span class="entity">h</span>::<span class="entity">acc</span><span class="main">)</span> <span class="entity">t</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">flip</span> <span class="entity">f</span> <span class="entity">x</span> <span class="entity">y</span> <span class="main">=</span> <span class="entity">f</span> <span class="entity">y</span> <span class="entity">x</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">remove_sorted_duplicates</span> <span class="entity">comp</span> <span class="entity">l</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> sort <span class="main">(</span>uncurry <span class="main">(</span><span class="entity">flip</span> <span class="entity">comp</span><span class="main">)</span><span class="main">)</span> <span class="entity">l</span> 
   <span class="keyword2"><span class="keyword">of</span></span> <span class="main">[</span><span class="main">]</span> <span class="main">=&gt;</span> <span class="entity">l</span>
    <span class="main">|</span> <span class="entity">h</span> :: <span class="entity">t</span> <span class="main">=&gt;</span> <span class="entity">rev_rem_dup</span> <span class="entity">comp</span> <span class="entity">h</span> <span class="main">[</span><span class="entity">h</span><span class="main">]</span> <span class="entity">t</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">lit_compare</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lit1</span> <span class="entity">lit2</span> <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">a1</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_true</span> <span class="entity">s</span> <span class="entity">lit1</span> <span class="keyword2"><span class="keyword">then</span></span> SOME true <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_false</span> <span class="entity">s</span> <span class="entity">lit1</span> <span class="keyword2"><span class="keyword">then</span></span> SOME false <span class="keyword2"><span class="keyword">else</span></span> NONE
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">a2</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_true</span> <span class="entity">s</span> <span class="entity">lit2</span> <span class="keyword2"><span class="keyword">then</span></span> SOME true <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_false</span> <span class="entity">s</span> <span class="entity">lit2</span> <span class="keyword2"><span class="keyword">then</span></span> SOME false <span class="keyword2"><span class="keyword">else</span></span> NONE
  <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> SOME true <span class="main">=</span> <span class="entity">a1</span> <span class="keyword2"><span class="keyword">then</span></span>
         <span class="keyword2"><span class="keyword">if</span></span> SOME true <span class="main">=</span> <span class="entity">a2</span> <span class="keyword2"><span class="keyword">then</span></span>
             <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">level1</span> <span class="main">=</span> <span class="entity">level</span> <span class="entity">s</span> <span class="entity">lit1</span>
                 <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">level2</span> <span class="main">=</span> <span class="entity">level</span> <span class="entity">s</span> <span class="entity">lit2</span>
             <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">level1</span> <span class="main">=</span> <span class="entity">level2</span> <span class="keyword2"><span class="keyword">then</span></span>
                    int_ord <span class="main">(</span><span class="entity">lit1</span><span class="main">,</span> <span class="entity">lit2</span><span class="main">)</span>
                <span class="keyword2"><span class="keyword">else</span></span> int_ord <span class="main">(</span><span class="entity">level1</span><span class="main">,</span> <span class="entity">level2</span><span class="main">)</span>
             <span class="keyword2"><span class="keyword">end</span></span>
         <span class="keyword2"><span class="keyword">else</span></span> LESS
     <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> SOME true <span class="main">=</span> <span class="entity">a2</span> <span class="keyword2"><span class="keyword">then</span></span>
         GREATER
     <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> NONE <span class="main">=</span> <span class="entity">a1</span> <span class="keyword2"><span class="keyword">then</span></span>
         <span class="keyword2"><span class="keyword">if</span></span> NONE <span class="main">=</span> <span class="entity">a2</span> <span class="keyword2"><span class="keyword">then</span></span>
             int_ord <span class="main">(</span><span class="entity">lit1</span><span class="main">,</span> <span class="entity">lit2</span><span class="main">)</span>
         <span class="keyword2"><span class="keyword">else</span></span> LESS
     <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> NONE <span class="main">=</span> <span class="entity">a2</span> <span class="keyword2"><span class="keyword">then</span></span>
         GREATER
     <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">level1</span> <span class="main">=</span> <span class="entity">level</span> <span class="entity">s</span> <span class="entity">lit1</span>
              <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">level2</span> <span class="main">=</span> <span class="entity">level</span> <span class="entity">s</span> <span class="entity">lit2</span>
          <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">level1</span> <span class="main">=</span> <span class="entity">level2</span> <span class="keyword2"><span class="keyword">then</span></span>
                 int_ord <span class="main">(</span><span class="entity">lit1</span><span class="main">,</span> <span class="entity">lit2</span><span class="main">)</span>
             <span class="keyword2"><span class="keyword">else</span></span> int_ord <span class="main">(</span><span class="entity">level2</span><span class="main">,</span> <span class="entity">level1</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">end</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">level_valid</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lit</span> <span class="main">=</span> 
  not <span class="main">(</span><span class="entity">is_assigned</span> <span class="entity">s</span> <span class="entity">lit</span><span class="main">)</span> <span class="keyword1"><span class="keyword">orelse</span></span> 
  <span class="inner_numeral">0</span> &lt;= <span class="entity">level</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">level</span> <span class="entity">s</span> <span class="entity">lit</span> &lt;= !<span class="main">(</span><span class="main">#</span>decision_level <span class="entity">s</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">register_early_implication</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lit</span> <span class="entity">lev</span> <span class="entity">cls</span> <span class="main">=</span> 
  <span class="main">(</span><span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="inner_quoted">"register_early_implication violates: not (!(#conflict_detected s))"</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">is_true</span> <span class="entity">s</span> <span class="entity">lit</span><span class="main">)</span> <span class="inner_quoted">"register_early_implication violates: is_true lit"</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">lev</span> &lt; <span class="entity">level</span> <span class="entity">s</span> <span class="entity">lit</span><span class="main">)</span> <span class="inner_quoted">"register_early_implication violates: lev &lt; level lit"</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">explanation_valid</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="main">(</span><span class="main">#</span>literals <span class="entity">cls</span><span class="main">)</span><span class="main">)</span> 
          <span class="inner_quoted">"register_early_implication violates: explanation_valid lit (#literals cls)"</span> <span class="main">;</span>
   <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">old_early_level</span> <span class="main">=</span> <span class="entity">early_level</span> <span class="entity">s</span> <span class="entity">lit</span>
   <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">old_early_level</span> <span class="main">=</span> <span class="entity">invalid_level</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">lev</span> &lt; <span class="entity">old_early_level</span> <span class="keyword2"><span class="keyword">then</span></span>
          <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">var</span> <span class="main">=</span> abs <span class="entity">lit</span>
          <span class="keyword2"><span class="keyword">in</span></span> Array.update <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>early_reason_array <span class="entity">s</span><span class="main">)</span><span class="main">,</span> <span class="entity">var</span><span class="main">,</span> <span class="entity">cls</span><span class="main">)</span> <span class="main">;</span>
             Array.update <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>early_level_array <span class="entity">s</span><span class="main">)</span><span class="main">,</span> <span class="entity">var</span><span class="main">,</span> <span class="entity">lev</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">;</span>
      <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="inner_quoted">"register_early_implication violates: not (!(#conflict_detected s))"</span> <span class="main">;</span>
      <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">is_true</span> <span class="entity">s</span> <span class="entity">lit</span><span class="main">)</span> <span class="inner_quoted">"register_early_implication violates: is_true lit"</span>
   <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_clause</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lit_list</span> <span class="main">=</span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
       <span class="main">(</span><span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">norm_lits</span> <span class="main">=</span> <span class="entity">remove_known_false</span> <span class="entity">s</span> 
                                <span class="main">(</span><span class="entity">remove_sorted_duplicates</span> 
                                     <span class="main">(</span><span class="entity">lit_compare</span> <span class="entity">s</span><span class="main">)</span> <span class="entity">lit_list</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cls</span> <span class="main">=</span> <span class="entity">new_clause</span> <span class="entity">norm_lits</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lits</span> <span class="main">=</span> <span class="main">#</span>literals <span class="entity">cls</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">len</span> <span class="main">=</span> Array.length <span class="entity">lits</span>
        <span class="keyword2"><span class="keyword">in</span></span> Array.app <span class="main">(</span><span class="entity">inc_decision_priority</span> <span class="entity">s</span><span class="main">)</span> <span class="entity">lits</span> <span class="main">;</span>
           <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">len</span>
            <span class="keyword2"><span class="keyword">of</span></span> <span class="inner_numeral">0</span> <span class="main">=&gt;</span> <span class="entity">set_conflict_lits</span> <span class="entity">s</span> <span class="main">(</span><span class="main">#</span>literals <span class="entity">empty_clause</span><span class="main">)</span>
             <span class="main">|</span> <span class="inner_numeral">1</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lit</span> <span class="main">=</span> Array.sub <span class="main">(</span><span class="entity">lits</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span>
                    <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">is_not_false</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="keyword1"><span class="keyword">orelse</span></span> !<span class="main">(</span><span class="main">#</span>decision_level <span class="entity">s</span><span class="main">)</span> &gt; <span class="inner_numeral">0</span><span class="main">)</span>
                              <span class="inner_quoted">"add_clause violates: is_not_false lit orelse !(#decision_level s) &gt; 0"</span> <span class="main">;</span>
                       <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">level_valid</span> <span class="entity">s</span> <span class="entity">lit</span><span class="main">)</span> <span class="inner_quoted">"add_clause violates: level_valid lit"</span> <span class="main">;</span>
                       <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_false</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="keyword2"><span class="keyword">then</span></span>
                           <span class="main">(</span><span class="entity">set_conflict_lits</span> <span class="entity">s</span> <span class="main">(</span><span class="main">#</span>literals <span class="entity">cls</span><span class="main">)</span> <span class="main">;</span>
                            <span class="entity">inc_clause_activity</span> <span class="entity">s</span> <span class="entity">cls</span><span class="main">)</span>
                       <span class="keyword2"><span class="keyword">else</span></span>
                           <span class="main">(</span>
                            <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span><span class="entity">is_assigned</span> <span class="entity">s</span> <span class="entity">lit</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
                                <span class="main">(</span><span class="entity">assign_lit</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="main">(</span><span class="entity">Propagation</span> <span class="entity">cls</span><span class="main">)</span> <span class="main">;</span>
                                 <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">is_true</span> <span class="entity">s</span> <span class="entity">lit</span><span class="main">)</span> <span class="inner_quoted">"add_clause violates: is_true lit"</span><span class="main">)</span>
                            <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">;</span>
                            <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">level</span> <span class="entity">s</span> <span class="entity">lit</span> &gt; <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span>
                                <span class="entity">register_early_implication</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="inner_numeral">0</span> <span class="entity">cls</span>
                            <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
                           <span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
             <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> 
               <span class="main">(</span><span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">len</span> &gt;= <span class="inner_numeral">2</span><span class="main">)</span> <span class="inner_quoted">"add_clause violates: len &gt;= 2"</span> <span class="main">;</span>
                <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lit0</span> <span class="main">=</span> Array.sub <span class="main">(</span><span class="entity">lits</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span>
                    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lit1</span> <span class="main">=</span> Array.sub <span class="main">(</span><span class="entity">lits</span><span class="main">,</span> <span class="inner_numeral">1</span><span class="main">)</span>
                <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">is_not_false</span> <span class="entity">s</span> <span class="entity">lit0</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">is_false</span> <span class="entity">s</span> <span class="entity">lit1</span><span class="main">)</span> 
                          <span class="inner_quoted">"add_clause violates: is_not_false lit0 orelse is_false lit1"</span> <span class="main">;</span>
                   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">level_valid</span> <span class="entity">s</span> <span class="entity">lit0</span><span class="main">)</span> <span class="inner_quoted">"add_clause violates: level_valid lit0"</span> <span class="main">;</span>
                   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">level_valid</span> <span class="entity">s</span> <span class="entity">lit1</span><span class="main">)</span> <span class="inner_quoted">"add_clause violates: level_valid lit1"</span> <span class="main">;</span>
                   <span class="entity">Vec.push</span> <span class="main">(</span><span class="main">#</span>clause <span class="entity">s</span><span class="main">)</span> <span class="entity">cls</span> <span class="main">;</span>
                   Array.sub <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>watchers <span class="entity">s</span><span class="main">)</span><span class="main">,</span> <span class="entity">lit0</span> + !<span class="main">(</span><span class="main">#</span>max_var <span class="entity">s</span><span class="main">)</span> + <span class="inner_numeral">1</span><span class="main">)</span> := <span class="entity">cls</span> :: !<span class="main">(</span>Array.sub <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>watchers <span class="entity">s</span><span class="main">)</span><span class="main">,</span> <span class="entity">lit0</span> + !<span class="main">(</span><span class="main">#</span>max_var <span class="entity">s</span><span class="main">)</span> + <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
                   Array.sub <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>watchers <span class="entity">s</span><span class="main">)</span><span class="main">,</span> <span class="entity">lit1</span> + !<span class="main">(</span><span class="main">#</span>max_var <span class="entity">s</span><span class="main">)</span> + <span class="inner_numeral">1</span><span class="main">)</span> := <span class="entity">cls</span> :: !<span class="main">(</span>Array.sub <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>watchers <span class="entity">s</span><span class="main">)</span><span class="main">,</span> <span class="entity">lit1</span> + !<span class="main">(</span><span class="main">#</span>max_var <span class="entity">s</span><span class="main">)</span> + <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
                   <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_false</span> <span class="entity">s</span> <span class="entity">lit1</span> <span class="keyword2"><span class="keyword">then</span></span>
                       <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_false</span> <span class="entity">s</span> <span class="entity">lit0</span> <span class="keyword2"><span class="keyword">then</span></span>
                           <span class="main">(</span><span class="entity">set_conflict_lits</span> <span class="entity">s</span> <span class="main">(</span><span class="main">#</span>literals <span class="entity">cls</span><span class="main">)</span> <span class="main">;</span>
                            <span class="entity">inc_clause_activity</span> <span class="entity">s</span> <span class="entity">cls</span><span class="main">)</span>
                       <span class="keyword2"><span class="keyword">else</span></span> 
                           <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span><span class="entity">is_assigned</span> <span class="entity">s</span> <span class="entity">lit0</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
                                <span class="main">(</span><span class="entity">assign_lit</span> <span class="entity">s</span> <span class="entity">lit0</span> <span class="main">(</span><span class="entity">Propagation</span> <span class="entity">cls</span><span class="main">)</span> <span class="main">;</span>
                                 <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">is_true</span> <span class="entity">s</span> <span class="entity">lit0</span><span class="main">)</span> <span class="inner_quoted">"add_clause violates: is_true lit0"</span> <span class="main">;</span>
                                 <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lev0</span> <span class="main">=</span> <span class="entity">level</span> <span class="entity">s</span> <span class="entity">lit0</span>
                                     <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lev1</span> <span class="main">=</span> <span class="entity">level</span> <span class="entity">s</span> <span class="entity">lit1</span>
                                 <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">lev0</span> &gt; <span class="entity">lev1</span> <span class="keyword2"><span class="keyword">then</span></span>
                                        <span class="entity">register_early_implication</span> <span class="entity">s</span> <span class="entity">lit0</span> <span class="entity">lev1</span> <span class="entity">cls</span>
                                    <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
                            <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span><span class="main">)</span>
                   <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">;</span>
                   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> !<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">watch_valid</span> <span class="entity">s</span> <span class="entity">cls</span><span class="main">)</span> 
                          <span class="inner_quoted">"add_clause violates: !(#conflict_detected s) orelse watch_valid cls"</span>
                <span class="keyword2"><span class="keyword">end</span></span>
               <span class="main">)</span>
        <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
   <span class="keyword2"><span class="keyword">else</span></span>
       <span class="main">(</span><span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> !<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="inner_quoted">"add_clause violates: !(#conflict_detected s)"</span> <span class="main">;</span>
        <span class="main">(</span><span class="main">#</span>pending_clauses <span class="entity">s</span><span class="main">)</span> := Queue.enqueue <span class="entity">lit_list</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>pending_clauses <span class="entity">s</span><span class="main">)</span><span class="main">)</span>
       <span class="main">)</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">invariant</span> <span class="entity">s</span><span class="main">)</span> <span class="inner_quoted">"add_clause violates: invariant ()"</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">unit_propagate_or_conflict</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="entity">lit</span> <span class="entity">watcher</span> <span class="main">=</span> 
  <span class="main">(</span><span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="inner_quoted">"unit_propagate_or_conflict violates: not (!(#conflict_detected s))"</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">inference_possible</span> <span class="entity">s</span><span class="main">)</span> 
          <span class="inner_quoted">"unit_propagate_or_conflict violates: inference_possible ()"</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">is_false</span> <span class="entity">s</span> <span class="entity">lit</span><span class="main">)</span> <span class="inner_quoted">"unit_propagate_or_conflict violates: is_false lit"</span> <span class="main">;</span>
   <span class="keyword2"><span class="keyword">if</span></span> !<span class="main">(</span><span class="main">#</span>next_inference_cls <span class="entity">s</span><span class="main">)</span> &lt; length <span class="main">(</span>!<span class="entity">watcher</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
       <span class="main">(</span><span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">cls</span> <span class="main">=</span> nth <span class="main">(</span>!<span class="entity">watcher</span><span class="main">)</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>next_inference_cls <span class="entity">s</span><span class="main">)</span><span class="main">)</span>
            <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lits</span> <span class="main">=</span> <span class="main">(</span><span class="main">#</span>literals <span class="entity">cls</span><span class="main">)</span>
        <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> Array.length <span class="entity">lits</span> &gt;= <span class="inner_numeral">2</span><span class="main">)</span>
                  <span class="inner_quoted">"unit_propagate_or_conflict violates: Array.length lits &gt;= 2"</span> <span class="main">;</span>
           <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> Array.sub <span class="main">(</span><span class="entity">lits</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span> <span class="main">=</span> <span class="entity">lit</span> <span class="keyword1"><span class="keyword">orelse</span></span>
                   Array.sub <span class="main">(</span><span class="entity">lits</span><span class="main">,</span> <span class="inner_numeral">1</span><span class="main">)</span> <span class="main">=</span> <span class="entity">lit</span><span class="main">)</span>
                  <span class="main">(</span><span class="inner_quoted">"unit_propagate_or_conflict violates: Array.sub (lits, 0) = lit orelse "</span> ^ 
                   <span class="inner_quoted">"Array.sub (lits, 1) = lit"</span><span class="main">)</span> <span class="main">;</span>
           <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">lit_idx</span><span class="main">,</span> <span class="entity">other_idx</span><span class="main">)</span> <span class="main">=</span> 
                   <span class="keyword2"><span class="keyword">if</span></span> Array.sub <span class="main">(</span><span class="entity">lits</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span> <span class="main">=</span> <span class="entity">lit</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="main">(</span><span class="inner_numeral">0</span><span class="main">,</span> <span class="inner_numeral">1</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="inner_numeral">1</span><span class="main">,</span> <span class="inner_numeral">0</span><span class="main">)</span>
               <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">other_lit</span> <span class="main">=</span> Array.sub <span class="main">(</span><span class="entity">lits</span><span class="main">,</span> <span class="entity">other_idx</span><span class="main">)</span>
               <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">other_assign</span> <span class="main">=</span> <span class="entity">assignment</span> <span class="entity">s</span> <span class="entity">other_lit</span>
           <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">other_assign</span> <span class="main">=</span> SOME true <span class="keyword2"><span class="keyword">then</span></span>
                  <span class="main">(</span><span class="main">(</span><span class="main">#</span>next_inference_cls <span class="entity">s</span><span class="main">)</span> := !<span class="main">(</span><span class="main">#</span>next_inference_cls <span class="entity">s</span><span class="main">)</span> + <span class="inner_numeral">1</span> <span class="main">;</span>
                   <span class="entity">unit_propagate_or_conflict</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="entity">watcher</span><span class="main">)</span>
              <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">other_assign</span> &lt;&gt; SOME true<span class="main">)</span>
                           <span class="inner_quoted">"unit_propagate_or_conflict violates: other_assign &lt;&gt; SOME true"</span> <span class="main">;</span>
                    <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">len</span> <span class="main">=</span> Array.length <span class="main">(</span><span class="entity">lits</span><span class="main">)</span>
                        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">i</span> <span class="main">=</span> Array.foldli <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">i</span><span class="main">,</span> <span class="entity">j</span><span class="main">,</span> <span class="inner_numeral">~1</span><span class="main">)</span> <span class="main">=&gt;</span> 
                                                 <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">is_false</span> <span class="entity">s</span> <span class="entity">j</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_numeral">~1</span>
                                                 <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> &gt;= <span class="inner_numeral">2</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">i</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_numeral">~1</span>
                                               <span class="main">|</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="entity">x</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">x</span><span class="main">)</span>
                                             <span class="inner_numeral">~1</span> <span class="main">(</span><span class="entity">lits</span><span class="main">)</span>
                        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">i</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> &gt;= <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">i</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">len</span>
                    <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> &lt;&gt; <span class="entity">len</span> <span class="keyword2"><span class="keyword">then</span></span>
                           <span class="main">(</span>Array.update <span class="main">(</span><span class="entity">lits</span><span class="main">,</span> <span class="entity">lit_idx</span><span class="main">,</span> Array.sub <span class="main">(</span><span class="entity">lits</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
                            Array.update <span class="main">(</span><span class="entity">lits</span><span class="main">,</span> <span class="entity">i</span><span class="main">,</span> <span class="entity">lit</span><span class="main">)</span> <span class="main">;</span>
                            <span class="entity">watcher</span> := List.take <span class="main">(</span>!<span class="entity">watcher</span><span class="main">,</span> !<span class="main">(</span><span class="main">#</span>next_inference_cls <span class="entity">s</span><span class="main">)</span><span class="main">)</span> @ 
                                       List.drop <span class="main">(</span>!<span class="entity">watcher</span><span class="main">,</span> !<span class="main">(</span><span class="main">#</span>next_inference_cls <span class="entity">s</span><span class="main">)</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="main">;</span>
                            <span class="main">(</span><span class="entity">literal_map_find</span> <span class="entity">s</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span>watchers <span class="entity">s</span><span class="main">)</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">lits</span><span class="main">,</span> <span class="entity">lit_idx</span><span class="main">)</span><span class="main">)</span> := 
                            <span class="entity">cls</span> :: !<span class="main">(</span><span class="main">(</span><span class="entity">literal_map_find</span> <span class="entity">s</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span>watchers <span class="entity">s</span><span class="main">)</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">lits</span><span class="main">,</span> <span class="entity">lit_idx</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
                            <span class="entity">unit_propagate_or_conflict</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="entity">watcher</span>
                           <span class="main">)</span>
                       <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">other_assign</span> <span class="main">=</span> NONE <span class="keyword2"><span class="keyword">then</span></span>
                           <span class="main">(</span><span class="entity">assign_lit</span> <span class="entity">s</span> <span class="main">(</span>Array.sub <span class="main">(</span><span class="entity">lits</span><span class="main">,</span> <span class="entity">other_idx</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Propagation</span> <span class="entity">cls</span><span class="main">)</span> <span class="main">;</span>
                            <span class="main">(</span><span class="main">#</span>num_inferences <span class="entity">s</span><span class="main">)</span> := !<span class="main">(</span><span class="main">#</span>num_inferences <span class="entity">s</span><span class="main">)</span> + <span class="inner_numeral">1</span> <span class="main">;</span>
                            <span class="main">(</span><span class="main">#</span>next_inference_cls <span class="entity">s</span><span class="main">)</span> := !<span class="main">(</span><span class="main">#</span>next_inference_cls <span class="entity">s</span><span class="main">)</span> + <span class="inner_numeral">1</span> <span class="main">;</span>
                            <span class="entity">unit_propagate_or_conflict</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="entity">watcher</span><span class="main">)</span>
                       <span class="keyword2"><span class="keyword">else</span></span>
                           <span class="main">(</span><span class="entity">set_conflict_lits</span> <span class="entity">s</span> <span class="main">(</span><span class="main">#</span>literals <span class="entity">cls</span><span class="main">)</span> <span class="main">;</span>
                            <span class="entity">inc_clause_activity</span> <span class="entity">s</span> <span class="entity">cls</span><span class="main">)</span>
                    <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
           <span class="keyword2"><span class="keyword">end</span></span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
   <span class="keyword2"><span class="keyword">else</span></span>
       <span class="main">(</span><span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> !<span class="main">(</span><span class="main">#</span>next_inference_cls <span class="entity">s</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>!<span class="entity">watcher</span><span class="main">)</span><span class="main">)</span>
               <span class="inner_quoted">"unit_propagate_or_conflict violates: !(#next_inference_cls s) = length (!watcher)"</span> <span class="main">;</span>
        <span class="main">(</span><span class="main">#</span>next_inference_lit <span class="entity">s</span><span class="main">)</span> := !<span class="main">(</span><span class="main">#</span>next_inference_lit <span class="entity">s</span><span class="main">)</span> + <span class="inner_numeral">1</span> <span class="main">;</span>
        <span class="main">(</span><span class="main">#</span>next_inference_cls <span class="entity">s</span><span class="main">)</span> := <span class="inner_numeral">0</span> <span class="main">;</span>
        <span class="keyword2"><span class="keyword">if</span></span> !<span class="main">(</span><span class="main">#</span>next_inference_lit <span class="entity">s</span><span class="main">)</span> &lt; <span class="entity">Vec.length</span> <span class="main">(</span><span class="main">#</span>trace <span class="entity">s</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
            <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lit</span> <span class="main">=</span> ~ <span class="main">(</span><span class="entity">Vec.get</span> <span class="main">(</span><span class="main">#</span>trace <span class="entity">s</span><span class="main">)</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>next_inference_lit <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">watcher</span> <span class="main">=</span> <span class="main">(</span><span class="entity">literal_map_find</span> <span class="entity">s</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span>watchers <span class="entity">s</span><span class="main">)</span> <span class="entity">lit</span>
            <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">unit_propagate_or_conflict</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="entity">watcher</span> <span class="keyword2"><span class="keyword">end</span></span>
        <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">infer</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="inner_quoted">"infer violates: not ((#conflict_detected s) ())"</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">inference_possible</span> <span class="entity">s</span><span class="main">)</span> <span class="inner_quoted">"infer violates: inference_possible ()"</span> <span class="main">;</span>
   <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span>Queue.is_empty <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>pending_literals <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
       <span class="entity">assign_early_implication</span> <span class="entity">s</span> <span class="main">(</span><span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">pending_literal</span><span class="main">,</span> 
                                            <span class="entity">pending_literals</span><span class="main">)</span> <span class="main">=</span> Queue.dequeue <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>pending_literals <span class="entity">s</span><span class="main">)</span><span class="main">)</span>
                                   <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="main">(</span><span class="main">#</span>pending_literals <span class="entity">s</span><span class="main">)</span> := <span class="entity">pending_literals</span> <span class="main">;</span> <span class="entity">pending_literal</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
   <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span>Queue.is_empty <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>pending_clauses <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
       <span class="main">(</span><span class="entity">add_clause</span> <span class="entity">s</span> <span class="main">(</span><span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">pending_clause</span><span class="main">,</span> 
                               <span class="entity">pending_clauses</span><span class="main">)</span> <span class="main">=</span> Queue.dequeue <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>pending_clauses <span class="entity">s</span><span class="main">)</span><span class="main">)</span>
                      <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="main">(</span><span class="main">#</span>pending_clauses <span class="entity">s</span><span class="main">)</span> := <span class="entity">pending_clauses</span> <span class="main">;</span> <span class="entity">pending_clause</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">)</span>
   <span class="keyword2"><span class="keyword">else</span></span>
   <span class="main">(</span>
       <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> !<span class="main">(</span><span class="main">#</span>next_inference_lit <span class="entity">s</span><span class="main">)</span> &lt; <span class="entity">Vec.length</span> <span class="main">(</span><span class="main">#</span>trace <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
       <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">lit</span> <span class="main">=</span> ~ <span class="main">(</span><span class="entity">Vec.get</span> <span class="main">(</span><span class="main">#</span>trace <span class="entity">s</span><span class="main">)</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>next_inference_lit <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
           <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">watcher</span> <span class="main">=</span> <span class="main">(</span><span class="entity">literal_map_find</span> <span class="entity">s</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span>watchers <span class="entity">s</span><span class="main">)</span> <span class="entity">lit</span>
       <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">unit_propagate_or_conflict</span> <span class="entity">s</span> <span class="entity">lit</span> <span class="entity">watcher</span> <span class="keyword2"><span class="keyword">end</span></span>
   <span class="main">)</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">invariant</span> <span class="entity">s</span><span class="main">)</span> <span class="inner_quoted">"infer violates: invariant ()"</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">num_learneds</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="main">=</span> <span class="entity">Vec.length</span> <span class="main">(</span><span class="main">#</span>learned <span class="entity">s</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">satisfied</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="main">=</span> 
  not <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">decision_possible</span> <span class="entity">s</span> 
       <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">inference_possible</span> <span class="entity">s</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">solved</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="main">=</span> 
  <span class="entity">satisfied</span> <span class="entity">s</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">unsatisfiable</span> <span class="entity">s</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">search</span> <span class="main">(</span><span class="entity">s</span> <span class="main">:</span> <span class="entity">solver</span><span class="main">)</span> <span class="main">=</span> 
<span class="main">(</span>
  <span class="keyword2"><span class="keyword">while</span></span> not <span class="main">(</span><span class="entity">solved</span> <span class="entity">s</span><span class="main">)</span> <span class="keyword1"><span class="keyword">andalso</span></span> !<span class="main">(</span><span class="main">#</span>num_conflicts <span class="entity">s</span><span class="main">)</span> &lt; !<span class="main">(</span><span class="main">#</span>conflict_limit <span class="entity">s</span><span class="main">)</span> <span class="keyword2"><span class="keyword">do</span></span>
  <span class="main">(</span>
      <span class="keyword2"><span class="keyword">while</span></span> <span class="main">(</span>not <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1"><span class="keyword">andalso</span></span> <span class="entity">inference_possible</span> <span class="entity">s</span><span class="main">)</span> <span class="keyword2"><span class="keyword">do</span></span>
      <span class="main">(</span>
          <span class="entity">infer</span> <span class="entity">s</span>
      <span class="main">)</span> <span class="main">;</span>
      <span class="keyword2"><span class="keyword">if</span></span> !<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
          <span class="keyword2"><span class="keyword">if</span></span> not <span class="main">(</span><span class="entity">unsatisfiable</span> <span class="entity">s</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
          <span class="main">(</span>
              <span class="entity">backjump</span> <span class="entity">s</span> <span class="main">;</span>
              <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">num_learneds</span> <span class="entity">s</span> &gt; !<span class="main">(</span><span class="main">#</span>learneds_limit <span class="entity">s</span><span class="main">)</span> <span class="keyword2"><span class="keyword">then</span></span>
                  <span class="entity">forget_some_learned_clauses</span> <span class="entity">s</span>
              <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
          <span class="main">)</span>
          <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">decision_possible</span> <span class="entity">s</span> <span class="keyword2"><span class="keyword">then</span></span>
          <span class="entity">decide</span> <span class="entity">s</span>
      <span class="keyword2"><span class="keyword">else</span></span>
          <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">satisfied</span> <span class="entity">s</span><span class="main">)</span> <span class="inner_quoted">"search violates: satisfied ()"</span>
  <span class="main">)</span> <span class="main">;</span>
  <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">unsatisfiable</span> <span class="entity">s</span><span class="main">)</span> 
         <span class="inner_quoted">"search violates: not (!(#conflict_detected s)) orelse unsatisfiable ()"</span> <span class="main">;</span>
  <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">invariant</span> <span class="entity">s</span><span class="main">)</span> <span class="inner_quoted">"search violates: invariant ()"</span>
<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">num_clauses</span> <span class="entity">s</span> <span class="main">=</span> <span class="entity">Vec.length</span> <span class="main">(</span><span class="main">#</span>clause <span class="entity">s</span><span class="main">)</span>


<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">simplify</span> <span class="entity">s</span> <span class="main">=</span> 
<span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">keep</span> <span class="entity">cls</span> <span class="main">=</span>
        Array.all <span class="main">(</span>not o <span class="main">(</span><span class="entity">is_true</span> <span class="entity">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">#</span>literals <span class="entity">cls</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">orelse</span></span> <span class="main">(</span><span class="entity">forget</span> <span class="entity">s</span> <span class="entity">cls</span><span class="main">;</span> false<span class="main">)</span>
<span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">Vec.filter</span> <span class="entity">keep</span> <span class="main">(</span><span class="main">#</span>clause <span class="entity">s</span><span class="main">)</span> <span class="main">;</span>
  <span class="entity">Vec.filter</span> <span class="entity">keep</span> <span class="main">(</span><span class="main">#</span>learned <span class="entity">s</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">restart</span> <span class="entity">s</span> <span class="main">=</span> 
  <span class="main">(</span><span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="inner_quoted">"restart violates: not (conflict_detected s)"</span> <span class="main">;</span>
   <span class="keyword2"><span class="keyword">if</span></span> !<span class="main">(</span><span class="main">#</span>decision_level <span class="entity">s</span><span class="main">)</span> &gt; <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">backtrack</span> <span class="entity">s</span> <span class="inner_numeral">0</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">;</span>
   <span class="entity">simplify</span> <span class="entity">s</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">invariant</span> <span class="entity">s</span><span class="main">)</span> <span class="inner_quoted">"restart violates: invariant s"</span> <span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> not <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="inner_quoted">"restart violates: not (conflict_detected s)"</span><span class="main">;</span>
   <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> !<span class="main">(</span><span class="main">#</span>decision_level <span class="entity">s</span><span class="main">)</span> <span class="main">=</span> <span class="inner_numeral">0</span><span class="main">)</span> <span class="inner_quoted">"restart violates: !(#decision_level s) = 0"</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">solve</span> <span class="entity">s</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">#</span>learneds_limit <span class="entity">s</span> := Int.max <span class="main">(</span><span class="inner_numeral">1000</span><span class="main">,</span> <span class="main">(</span><span class="entity">num_clauses</span> <span class="entity">s</span> div <span class="inner_numeral">3</span><span class="main">)</span><span class="main">)</span> <span class="main">;</span>
   <span class="keyword2"><span class="keyword">while</span></span> not <span class="main">(</span><span class="entity">solved</span> <span class="entity">s</span><span class="main">)</span> <span class="keyword2"><span class="keyword">do</span></span>
       <span class="main">(</span><span class="entity">restart</span> <span class="entity">s</span> <span class="main">;</span>
        <span class="entity">search</span> <span class="entity">s</span> <span class="main">;</span>
        <span class="main">#</span>conflict_limit <span class="entity">s</span> := !<span class="main">(</span><span class="main">#</span>conflict_limit <span class="entity">s</span><span class="main">)</span> * <span class="inner_numeral">2</span> <span class="main">;</span>
        <span class="main">#</span>learneds_limit <span class="entity">s</span> := !<span class="main">(</span><span class="main">#</span>learneds_limit <span class="entity">s</span><span class="main">)</span> * <span class="inner_numeral">12</span> div <span class="inner_numeral">10</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">invalid_position</span> <span class="main">=</span> <span class="inner_numeral">~1</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">initialize_arrays</span> <span class="entity">s</span> <span class="entity">max_vars_plus_one</span> <span class="main">=</span> 
  <span class="main">(</span><span class="main">(</span><span class="main">#</span>assignment_array <span class="entity">s</span><span class="main">)</span> := Array.array <span class="main">(</span><span class="entity">max_vars_plus_one</span><span class="main">,</span> NONE<span class="main">)</span> <span class="main">;</span>
   <span class="main">(</span><span class="main">#</span>level_array <span class="entity">s</span><span class="main">)</span> := Array.array <span class="main">(</span><span class="entity">max_vars_plus_one</span><span class="main">,</span> <span class="entity">invalid_level</span><span class="main">)</span> <span class="main">;</span>
   <span class="main">(</span><span class="main">#</span>position <span class="entity">s</span><span class="main">)</span> := Array.array <span class="main">(</span><span class="entity">max_vars_plus_one</span><span class="main">,</span> <span class="entity">invalid_position</span><span class="main">)</span> <span class="main">;</span>
   <span class="main">(</span><span class="main">#</span>reason_array <span class="entity">s</span><span class="main">)</span> := Array.array <span class="main">(</span><span class="entity">max_vars_plus_one</span><span class="main">,</span> <span class="entity">Unassigned</span><span class="main">)</span> <span class="main">;</span>
   <span class="main">(</span><span class="main">#</span>early_reason_array <span class="entity">s</span><span class="main">)</span> := Array.array <span class="main">(</span><span class="entity">max_vars_plus_one</span><span class="main">,</span> <span class="entity">empty_clause</span><span class="main">)</span> <span class="main">;</span>
   <span class="main">(</span><span class="main">#</span>early_level_array <span class="entity">s</span><span class="main">)</span> := Array.array <span class="main">(</span><span class="entity">max_vars_plus_one</span><span class="main">,</span> <span class="entity">invalid_level</span><span class="main">)</span> <span class="main">;</span>
   <span class="main">(</span><span class="main">#</span>bias <span class="entity">s</span><span class="main">)</span> := Array.array <span class="main">(</span><span class="entity">max_vars_plus_one</span><span class="main">,</span> true<span class="main">)</span> <span class="main">;</span>
   <span class="main">(</span><span class="main">#</span>watchers <span class="entity">s</span><span class="main">)</span> := Array.array <span class="main">(</span><span class="inner_numeral">2</span> * <span class="entity">max_vars_plus_one</span><span class="main">,</span> Unsynchronized.ref <span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">;</span>
   Array.modify <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> Unsynchronized.ref <span class="main">[</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>watchers <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">init</span> <span class="entity">s</span> <span class="entity">clauses</span> <span class="main">=</span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">vars</span> <span class="main">=</span> sort_distinct int_ord <span class="main">(</span>map abs <span class="main">(</span>flat <span class="entity">clauses</span><span class="main">)</span><span class="main">)</span>
   <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="main">#</span>decision_level <span class="entity">s</span><span class="main">)</span> := <span class="inner_numeral">0</span> <span class="main">;</span>
      <span class="main">(</span><span class="main">#</span>decision_queue <span class="entity">s</span><span class="main">)</span> := <span class="entity">empty_queue</span> <span class="main">(</span><span class="main">)</span> <span class="main">;</span>
      List.app <span class="main">(</span><span class="entity">PriorityQueue.enqueue</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>decision_queue <span class="entity">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">vars</span> <span class="main">;</span>
      <span class="main">(</span><span class="main">#</span>conflict_detected <span class="entity">s</span><span class="main">)</span> := false <span class="main">;</span>
      <span class="main">(</span><span class="main">#</span>conflict_level <span class="entity">s</span><span class="main">)</span> := <span class="inner_numeral">0</span> <span class="main">;</span>
      <span class="main">(</span><span class="main">#</span>conflict_vars <span class="entity">s</span><span class="main">)</span> := <span class="main">[</span><span class="main">]</span> <span class="main">;</span>
      <span class="main">(</span><span class="main">#</span>num_implication_points <span class="entity">s</span><span class="main">)</span> := <span class="inner_numeral">0</span> <span class="main">;</span>
      <span class="main">(</span><span class="main">#</span>lower_conflict_lits <span class="entity">s</span><span class="main">)</span> := <span class="main">[</span><span class="main">]</span> <span class="main">;</span>
      <span class="main">(</span><span class="main">#</span>next_inference_lit <span class="entity">s</span><span class="main">)</span> := <span class="inner_numeral">0</span> <span class="main">;</span>
      <span class="main">(</span><span class="main">#</span>next_inference_cls <span class="entity">s</span><span class="main">)</span> := <span class="inner_numeral">0</span> <span class="main">;</span>
      <span class="main">(</span><span class="main">#</span>pending_clauses <span class="entity">s</span><span class="main">)</span> := Queue.empty <span class="main">;</span>
      <span class="main">(</span><span class="main">#</span>pending_literals <span class="entity">s</span><span class="main">)</span> := Queue.empty <span class="main">;</span>
      <span class="main">(</span><span class="main">#</span>dispatch_lit <span class="entity">s</span><span class="main">)</span> := <span class="inner_numeral">0</span> <span class="main">;</span>
      <span class="main">(</span><span class="main">#</span>var_increment <span class="entity">s</span><span class="main">)</span> := <span class="inner_numeral">1.0</span> <span class="main">;</span>
      <span class="main">(</span><span class="main">#</span>cls_increment <span class="entity">s</span><span class="main">)</span> := <span class="inner_numeral">1.0</span> <span class="main">;</span>
      <span class="main">(</span><span class="main">#</span>num_decisions <span class="entity">s</span><span class="main">)</span> := <span class="inner_numeral">0</span> <span class="main">;</span>
      <span class="main">(</span><span class="main">#</span>num_conflicts <span class="entity">s</span><span class="main">)</span> := <span class="inner_numeral">0</span> <span class="main">;</span>
      <span class="main">(</span><span class="main">#</span>num_inferences <span class="entity">s</span><span class="main">)</span> := <span class="inner_numeral">0</span> <span class="main">;</span>
      <span class="main">(</span><span class="main">#</span>max_var <span class="entity">s</span><span class="main">)</span> := fold <span class="main">(</span>curry Int.max<span class="main">)</span> <span class="entity">vars</span> <span class="inner_numeral">0</span> <span class="main">;</span>
      <span class="entity">initialize_arrays</span> <span class="entity">s</span> <span class="main">(</span>!<span class="main">(</span><span class="main">#</span>max_var <span class="entity">s</span><span class="main">)</span> + <span class="inner_numeral">1</span><span class="main">)</span> <span class="main">;</span>
      <span class="main">(</span><span class="main">#</span>num_vars <span class="entity">s</span><span class="main">)</span> := length <span class="entity">vars</span> <span class="main">;</span>
      <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">invariant</span> <span class="entity">s</span><span class="main">)</span> <span class="inner_quoted">"init violates at 1: invariant ()"</span> <span class="main">;</span>
      List.app <span class="main">(</span><span class="entity">add_clause</span> <span class="entity">s</span><span class="main">)</span> <span class="entity">clauses</span> <span class="main">;</span>
      <span class="entity">assert</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">invariant</span> <span class="entity">s</span><span class="main">)</span> <span class="inner_quoted">"init violates at 2: invariant ()"</span>
   <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword2"><span class="keyword">let</span></span>
  <span class="keyword3"><span class="keyword">open</span></span> SAT_Solver
  <span class="keyword3"><span class="keyword">open</span></span> Prop_Logic

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_clauses</span> <span class="entity">f</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_clause</span> <span class="entity">g</span> <span class="main">=</span> 
              <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_lit</span> <span class="main">(</span><span class="entity">BoolVar</span> <span class="entity">i</span><span class="main">)</span> <span class="main">=</span> <span class="entity">i</span>
                    <span class="main">|</span> <span class="entity">mk_lit</span> <span class="main">(</span><span class="entity">Not</span> <span class="main">(</span><span class="entity">BoolVar</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ~<span class="entity">i</span>
                    <span class="main">|</span> <span class="entity">mk_lit</span> <span class="main">_</span> <span class="main">=</span> error <span class="inner_quoted">"mk_clauses: formula is not in CNF!"</span>
              <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">g</span>
                  <span class="keyword2"><span class="keyword">of</span></span> <span class="entity">Or</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">mk_clause</span> <span class="entity">x</span> @ <span class="entity">mk_clause</span> <span class="entity">y</span>
                   <span class="main">|</span> <span class="entity">True</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="inner_numeral">1</span><span class="main">,</span> <span class="inner_numeral">~1</span><span class="main">]</span>
                   <span class="main">|</span> <span class="entity">False</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">]</span>
                   <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="entity">mk_lit</span> <span class="entity">g</span><span class="main">]</span> <span class="keyword2"><span class="keyword">end</span></span>
      <span class="keyword2"><span class="keyword">in</span></span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">f</span>
          <span class="keyword2"><span class="keyword">of</span></span> <span class="entity">And</span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">mk_clauses</span> <span class="entity">x</span> @ <span class="entity">mk_clauses</span> <span class="entity">y</span>
           <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="entity">mk_clause</span> <span class="entity">f</span><span class="main">]</span> <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">dptsat</span> <span class="entity">fm</span> <span class="main">=</span> 
      <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fm</span> <span class="main">=</span> <span class="entity">Prop_Logic.defcnf</span> <span class="entity">fm</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">s</span> <span class="main">=</span> <span class="entity">DPT_SAT_Solver.empty_solver</span> <span class="main">(</span><span class="main">)</span>
          <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">clauses</span> <span class="main">=</span> <span class="main">[</span><span class="inner_numeral">1</span><span class="main">,</span> <span class="inner_numeral">~1</span><span class="main">,</span> <span class="inner_numeral">2</span><span class="main">,</span> <span class="inner_numeral">~2</span><span class="main">]</span> :: <span class="entity">mk_clauses</span> <span class="entity">fm</span>
      <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">DPT_SAT_Solver.init</span> <span class="entity">s</span> <span class="main">(</span><span class="entity">clauses</span><span class="main">)</span> <span class="main">;</span>
          <span class="entity">DPT_SAT_Solver.solve</span> <span class="entity">s</span> <span class="main">;</span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">DPT_SAT_Solver.satisfied</span> <span class="entity">s</span> <span class="keyword2"><span class="keyword">then</span></span>
              <span class="entity">SATISFIABLE</span> <span class="main">(</span><span class="entity">DPT_SAT_Solver.assignment</span> <span class="entity">s</span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">UNSATISFIABLE</span> NONE<span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">in</span></span>
  <span class="entity">SAT_Solver.add_solver</span> <span class="main">(</span><span class="inner_quoted">"dptsat"</span><span class="main">,</span> <span class="entity">dptsat</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DPT_SAT_Tests">
<div class="head">
<h1>Theory DPT_SAT_Tests</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Tests for DPTSAT
    Author:      Jasmin Blanchette &lt;blanchette at in.tum.de&gt;, 2009
    Maintainer:  Jasmin Blanchette &lt;blanchette at in.tum.de&gt;
*)</span>

<span class="keyword1"><span class="command">theory</span></span> DPT_SAT_Tests
<span class="keyword2"><span class="keyword">imports</span></span> <a href="DPT_SAT_Solver.html">DPT_SAT_Solver</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">path</span> <span class="main">=</span> File.tmp_path <span class="main">(</span>Path.explode <span class="inner_quoted">"sat.out"</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">max_secs</span> <span class="main">=</span> <span class="inner_numeral">60</span>

<span class="comment1">(*
val _ = File.write path ""
fun write_out s = (tracing s; File.append path (s ^ "\n"))
*)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">write_out</span> <span class="main">=</span> tracing

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">test</span> <span class="entity">name</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">solver</span> <span class="main">=</span> <span class="inner_quoted">"dptsat"</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">aux</span> <span class="main">(</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">name</span> <span class="main">=</span> <span class="inner_quoted">"cnf/"</span> ^ <span class="entity">name</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">timer1</span> <span class="main">=</span> Timer.startRealTimer <span class="main">(</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">formula</span> <span class="main">=</span> <span class="entity">SAT_Solver.read_dimacs_cnf_file</span> <span class="main">(</span><span class="antiquoted"><span class="operator"><span class="entity"><span class="hidden">\&lt;^</span><span class="control">master_dir</span><span class="hidden">&gt;</span></span></span></span> + Path.explode <span class="entity">name</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">timer2</span> <span class="main">=</span> Timer.startRealTimer <span class="main">(</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> <span class="entity">SAT_Solver.invoke_solver</span> <span class="entity">solver</span> <span class="entity">formula</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">code</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">res</span> <span class="keyword2"><span class="keyword">of</span></span>
                     <span class="entity">SAT_Solver.SATISFIABLE</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="inner_quoted">"SAT"</span>
                   <span class="main">|</span> <span class="entity">SAT_Solver.UNSATISFIABLE</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="inner_quoted">"UNSAT"</span>
                   <span class="main">|</span> <span class="entity">SAT_Solver.UNKNOWN</span> <span class="main">=&gt;</span> <span class="inner_quoted">"UNKNOWN"</span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">show_time</span> <span class="entity">timer</span> <span class="main">=</span>
          signed_string_of_int <span class="main">(</span>Time.toMilliseconds <span class="main">(</span>Timer.checkRealTimer <span class="entity">timer1</span><span class="main">)</span><span class="main">)</span> ^ <span class="inner_quoted">" ms"</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">write_out</span> <span class="main">(</span><span class="entity">solver</span> ^ <span class="inner_quoted">":"</span> ^ <span class="entity">name</span> ^ <span class="inner_quoted">": "</span> ^ <span class="entity">code</span> ^ <span class="inner_quoted">" "</span> ^ <span class="entity">show_time</span> <span class="entity">timer1</span> ^ <span class="inner_quoted">" "</span> ^
                  <span class="entity">show_time</span> <span class="entity">timer2</span><span class="main">)</span><span class="main">;</span> <span class="entity">code</span>
      <span class="keyword2"><span class="keyword">end</span></span>
      <span class="keyword3"><span class="keyword">handle</span></span> Timeout.TIMEOUT <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">write_out</span> <span class="main">(</span><span class="entity">solver</span> ^ <span class="inner_quoted">":"</span> ^ <span class="entity">name</span> ^ <span class="inner_quoted">": TIMEOUT"</span><span class="main">)</span><span class="main">;</span> <span class="inner_quoted">"UNKNOWN"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    Timeout.apply <span class="main">(</span>Time.fromSeconds <span class="entity">max_secs</span><span class="main">)</span> <span class="entity">aux</span> <span class="main">(</span><span class="main">)</span>
      <span class="keyword3"><span class="keyword">handle</span></span> Timeout.TIMEOUT <span class="main">_</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="entity">write_out</span> <span class="main">(</span><span class="entity">solver</span> ^ <span class="inner_quoted">":"</span> ^ <span class="entity">name</span> ^ <span class="inner_quoted">": TIMEOUT"</span><span class="main">)</span><span class="main">;</span> <span class="inner_quoted">"UNKNOWN"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sat</span> <span class="entity">name</span> <span class="main">=</span> <span class="main">(</span><span class="entity">test</span> <span class="entity">name</span> <span class="main">=</span> <span class="inner_quoted">"SAT"</span> <span class="keyword1"><span class="keyword">orelse</span></span> error <span class="inner_quoted">"Expected SAT"</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">unsat</span> <span class="entity">name</span> <span class="main">=</span> <span class="main">(</span><span class="entity">test</span> <span class="entity">name</span> <span class="main">=</span> <span class="inner_quoted">"UNSAT"</span> <span class="keyword1"><span class="keyword">orelse</span></span> error <span class="inner_quoted">"Expected UNSAT"</span><span class="main">)</span>
›</span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.398356.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">sat</span> <span class="inner_quoted">"np.core.398568.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.398723.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.398761.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.398773.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.398787.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.398823.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.398855.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.398863.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.398889.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.398907.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">sat</span> <span class="inner_quoted">"np.core.399306.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">sat</span> <span class="inner_quoted">"np.core.399317.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">sat</span> <span class="inner_quoted">"np.core.399458.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">sat</span> <span class="inner_quoted">"np.core.399645.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.399856.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.399874.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.399904.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.399960.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.400034.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.400046.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.400209.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.400219.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.400351.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.400353.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.400474.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.400496.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">sat</span> <span class="inner_quoted">"np.core.400660.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">sat</span> <span class="inner_quoted">"np.core.400683.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.400719.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.400745.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.400795.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.401023.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">sat</span> <span class="inner_quoted">"np.core.401292.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.401685.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.401784.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">sat</span> <span class="inner_quoted">"np.core.402032.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.402136.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.402512.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">sat</span> <span class="inner_quoted">"np.core.402547.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.402722.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.402730.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.402742.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.402772.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.402774.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.402778.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.402794.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.403005.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.403015.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.403051.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.403079.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.403559.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.403586.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.403624.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.403642.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.403836.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.403838.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.403862.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.404160.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.404182.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.404186.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.404196.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.404200.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.404234.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.404238.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.404246.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.404266.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.404318.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.404326.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.404334.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.404344.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.404368.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.404388.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.404394.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.404414.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.404460.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.404506.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.404510.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.404534.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.404592.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.404596.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.404866.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.404876.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405031.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405035.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405052.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405056.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405095.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405097.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405100.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405125.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405155.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405184.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405205.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405217.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405254.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405286.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405296.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405314.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405343.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405362.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405372.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405391.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405443.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405445.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405455.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405464.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405536.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405571.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405579.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405588.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405647.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405649.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405657.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405687.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405701.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405703.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405721.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405740.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405811.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405817.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405823.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.405869.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.406136.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.406138.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">sat</span> <span class="inner_quoted">"np.core.406192.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">sat</span> <span class="inner_quoted">"np.core.406216.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.406290.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.406294.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.406310.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.406355.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.406411.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.406413.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">sat</span> <span class="inner_quoted">"np.core.406457.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">sat</span> <span class="inner_quoted">"np.core.406541.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.406599.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.406601.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.406609.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">sat</span> <span class="inner_quoted">"np.core.406679.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.406857.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.406866.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.406927.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.406994.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.407020.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.407028.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">sat</span> <span class="inner_quoted">"np.core.407044.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">sat</span> <span class="inner_quoted">"np.core.407130.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.407514.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.core.407526.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.huff.402973.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.huff.403048.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.huff.403214.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.huff.403497.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.huff.405095.cnf"</span>›</span>
<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="entity">unsat</span> <span class="inner_quoted">"np.huff.405186.cnf"</span>›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>