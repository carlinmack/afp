<div id="Square_Matrix">
<div class="head">
<h1>Theory Square_Matrix</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Cayley_Hamilton/Square_Matrix.thy
    Author:     Johannes Hölzl, TU München *)</span>

<span class="keyword1"><span class="command">theory</span></span> Square_Matrix
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Analysis/Determinants.html">HOL-Analysis.Determinants</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Analysis/Cartesian_Euclidean_Space.html">HOL-Analysis.Cartesian_Euclidean_Space</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> smult_axis<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">*s</span> axis <span class="free">i</span> <span class="free">y</span> <span class="main">=</span> axis <span class="free">i</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">::</span><span class="main">_</span><span class="main">::</span>mult_zero<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> axis_def vec_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'n</span><span class="main">)</span> sq_matrix <span class="main">=</span> <span class="quoted"><span class="quoted">"UNIV <span class="main">::</span> <span class="main">(</span><span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">morphisms</span></span> to_fun of_fun
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> UNIV_witness<span class="main">)</span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_sq_matrix"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"type <span class="main">⇒</span> type <span class="main">⇒</span> type"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_ <span class="keyword1">^^</span><span class="keyword3">/ </span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>15<span class="main">,</span> 16<span class="main">]</span> 15<span class="main">)</span>

<span class="keyword1"><span class="command">parse_translation</span></span> <span class="quoted">‹
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">vec</span> <span class="entity">t</span> <span class="entity">u</span> <span class="main">=</span> Syntax.const <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">type_syntax</span> sq_matrix<span class="antiquote">}</span></span> $ <span class="entity">t</span> $ <span class="entity">u</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sq_matrix_tr</span> <span class="main">[</span><span class="entity">t</span><span class="main">,</span> <span class="entity">u</span><span class="main">]</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> Term_Position.strip_positions <span class="entity">u</span> <span class="keyword2"><span class="keyword">of</span></span>
        <span class="entity">v</span> <span class="keyword1"><span class="keyword">as</span></span> Free <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span>
          <span class="keyword2"><span class="keyword">if</span></span> Lexicon.is_tid <span class="entity">x</span> <span class="keyword2"><span class="keyword">then</span></span>
            <span class="entity">vec</span> <span class="entity">t</span> <span class="main">(</span>Syntax.const <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_ofsort"<span class="antiquote">}</span></span> $ <span class="entity">v</span> $
              Syntax.const <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">class_syntax</span> finite<span class="antiquote">}</span></span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">else</span></span> <span class="entity">vec</span> <span class="entity">t</span> <span class="entity">u</span>
      <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">vec</span> <span class="entity">t</span> <span class="entity">u</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="main">[</span><span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_sq_matrix"<span class="antiquote">}</span></span><span class="main">,</span> K <span class="entity">sq_matrix_tr</span><span class="main">)</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_sq_matrix

<span class="keyword1"><span class="command">lift_definition</span></span> map_sq_matrix <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">^^</span><span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="bound">M</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">M</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> from_vec <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">^</span><span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'n</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">M</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">M</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> to_vec <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'n</span><span class="main">^</span><span class="tfree">'n</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">M</span><span class="main">.</span> <span class="keyword1">χ</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">M</span> <span class="bound">i</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> from_vec_eq_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"from_vec <span class="free">M</span> <span class="main">=</span> from_vec <span class="free">N</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">=</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_eq_iff fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> to_vec_from_vec<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"to_vec <span class="main">(</span>from_vec <span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> from_vec_to_vec<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"from_vec <span class="main">(</span>to_vec <span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_eq_iff fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_sq_matrix_compose<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_sq_matrix <span class="free">f</span> <span class="main">(</span>map_sq_matrix <span class="free">g</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> map_sq_matrix <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> map_sq_matrix_ident<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_sq_matrix <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="free">M</span> <span class="main">=</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_sq_matrix_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="free">N</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>to_fun <span class="free">N</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="main">(</span>to_fun <span class="free">N</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> map_sq_matrix <span class="free">f</span> <span class="free">M</span> <span class="main">=</span> map_sq_matrix <span class="free">g</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lift_definition</span></span> diag <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>zero <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'n</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="bound">k</span> <span class="keyword1">else</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diag_eq_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"diag <span class="free">x</span> <span class="main">=</span> diag <span class="free">y</span> <span class="main">⟷</span>  <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_sq_matrix_diag<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> map_sq_matrix <span class="free">f</span> <span class="main">(</span>diag <span class="free">c</span><span class="main">)</span> <span class="main">=</span> diag <span class="main">(</span><span class="free">f</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> smult_sq_matrix <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>times <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'n</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span>"</span> 75<span class="main">)</span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">c</span> <span class="bound">M</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">c</span> <span class="main">*</span> <span class="bound">M</span> <span class="bound">i</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> smult_map_sq_matrix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">z</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> map_sq_matrix <span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">z</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> map_sq_matrix <span class="free">f</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> map_sq_matrix_smult<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> map_sq_matrix <span class="free">f</span> <span class="free">A</span> <span class="main">=</span> map_sq_matrix <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> one_smult<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="main">_</span><span class="main">::</span>monoid_mult<span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> smult_diag<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> diag <span class="free">y</span> <span class="main">=</span> diag <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">::</span><span class="main">_</span><span class="main">::</span>mult_zero<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> sq_matrix <span class="main">::</span> <span class="main">(</span><span class="quoted">semigroup_add</span><span class="main">,</span> <span class="quoted">finite</span><span class="main">)</span> <span class="quoted">semigroup_add</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">plus_sq_matrix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">A</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">+</span> <span class="bound">B</span> <span class="bound">i</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_sq_matrix_add<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">+</span> <span class="free">f</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⟹</span> map_sq_matrix <span class="free">f</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> map_sq_matrix <span class="free">f</span> <span class="free">A</span> <span class="main">+</span> map_sq_matrix <span class="free">f</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> add_map_sq_matrix<span class="main">:</span> <span class="quoted"><span class="quoted">"map_sq_matrix <span class="free">f</span> <span class="free">A</span> <span class="main">+</span> map_sq_matrix <span class="free">g</span> <span class="free">A</span> <span class="main">=</span> map_sq_matrix <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">instantiation</span></span> sq_matrix <span class="main">::</span> <span class="main">(</span><span class="quoted">monoid_add</span><span class="main">,</span> <span class="quoted">finite</span><span class="main">)</span> <span class="quoted">monoid_add</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">zero_sq_matrix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diag_0<span class="main">:</span> <span class="quoted"><span class="quoted">"diag <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> diag_0_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"diag <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zero_map_sq_matrix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> map_sq_matrix <span class="free">f</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> map_sq_matrix_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_sq_matrix <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">instance</span></span> sq_matrix <span class="main">::</span> <span class="main">(</span><span class="quoted">ab_semigroup_add</span><span class="main">,</span> <span class="quoted">finite</span><span class="main">)</span> <span class="quoted">ab_semigroup_add</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> sq_matrix <span class="main">::</span> <span class="main">(</span><span class="quoted">minus</span><span class="main">,</span> <span class="quoted">finite</span><span class="main">)</span> <span class="quoted">minus</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">minus_sq_matrix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">A</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">-</span> <span class="bound">B</span> <span class="bound">i</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> sq_matrix <span class="main">::</span> <span class="main">(</span><span class="quoted">group_add</span><span class="main">,</span> <span class="quoted">finite</span><span class="main">)</span> <span class="quoted">group_add</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">uminus_sq_matrix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"uminus"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_sq_matrix_diff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">a</span> <span class="main">-</span> <span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">-</span> <span class="free">f</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⟹</span> map_sq_matrix <span class="free">f</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> map_sq_matrix <span class="free">f</span> <span class="free">A</span> <span class="main">-</span> map_sq_matrix <span class="free">f</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smult_diff<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>comm_ring_1"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">A</span> <span class="main">-</span> <span class="free">a</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> sq_matrix <span class="main">::</span> <span class="main">(</span><span class="quoted">cancel_semigroup_add</span><span class="main">,</span> <span class="quoted">finite</span><span class="main">)</span> <span class="quoted">cancel_semigroup_add</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> sq_matrix <span class="main">::</span> <span class="main">(</span><span class="quoted">cancel_ab_semigroup_add</span><span class="main">,</span> <span class="quoted">finite</span><span class="main">)</span> <span class="quoted">cancel_ab_semigroup_add</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> sq_matrix <span class="main">::</span> <span class="main">(</span><span class="quoted">comm_monoid_add</span><span class="main">,</span> <span class="quoted">finite</span><span class="main">)</span> <span class="quoted">comm_monoid_add</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_sq_matrix_sum<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">+</span> <span class="free">f</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⟹</span>
  map_sq_matrix <span class="free">f</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> map_sq_matrix <span class="free">f</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">I</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_map_sq_matrix map_sq_matrix_add<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_map_sq_matrix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> map_sq_matrix <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> map_sq_matrix <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">I</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_map_sq_matrix<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smult_zero<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ring_1"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smult_right_add<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ring_1"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">x</span> <span class="main">+</span> <span class="free">a</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_eq_iff <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smult_sum<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ring_1"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">a</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">(</span>sum <span class="free">f</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">I</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> smult_right_add vec_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> sq_matrix <span class="main">::</span> <span class="main">(</span><span class="quoted">ab_group_add</span><span class="main">,</span> <span class="quoted">finite</span><span class="main">)</span> <span class="quoted">ab_group_add</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> sq_matrix <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"semiring_0"</span></span><span class="main">,</span> <span class="quoted">finite</span><span class="main">)</span> <span class="quoted">semiring_0</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">times_sq_matrix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">M</span> <span class="bound">N</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">∑</span><span class="bound">k</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="bound">M</span> <span class="bound">i</span> <span class="bound">k</span> <span class="main">*</span> <span class="bound">N</span> <span class="bound">k</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span>"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">c</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">*</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff sum_distrib_left sum_distrib_right <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.swap<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_eq_iff sum.distrib <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diag_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"diag <span class="free">x</span> <span class="main">*</span> <span class="free">A</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span>  <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> if_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">a</span><span class="main"><span class="main">]</span></span> sum.If_cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_diag<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>comm_ring_1"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">*</span> diag <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> if_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">a</span><span class="main"><span class="main">]</span></span> mult.commute sum.If_cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smult_mult1<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>comm_ring_1"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">*</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smult_mult2<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>comm_ring_1"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">*</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_sq_matrix_mult<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>semiring_1 <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>semiring_1"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">+</span> <span class="free">f</span> <span class="bound">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">a</span> <span class="main">*</span> <span class="bound">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_sq_matrix <span class="free">f</span> <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> map_sq_matrix <span class="free">f</span> <span class="free">A</span> <span class="main">*</span> map_sq_matrix <span class="free">f</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> <span class="skolem">A</span> <span class="skolem">i</span> <span class="bound">k</span> <span class="main">*</span> <span class="skolem">B</span> <span class="bound">k</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">A</span> <span class="skolem">i</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">B</span> <span class="bound">k</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">I</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="skolem">A</span> <span class="bound">i</span> <span class="bound">k</span> <span class="main">*</span> <span class="skolem">B</span> <span class="bound">k</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">∑</span><span class="bound">k</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">A</span> <span class="bound">i</span> <span class="bound">k</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">B</span> <span class="bound">k</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> from_vec_mult<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"from_vec <span class="main">(</span><span class="free">M</span> <span class="main">**</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> from_vec <span class="free">M</span> <span class="main">*</span> from_vec <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matrix_matrix_mult_def fun_eq_iff vec_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> sq_matrix <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"semiring_1"</span></span><span class="main">,</span> <span class="quoted">finite</span><span class="main">)</span> <span class="quoted">semiring_1</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">one_sq_matrix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff sum.If_cases
       if_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">b</span><span class="main"><span class="main">]</span></span> if_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">b</span> <span class="main">*</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">b</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instance</span></span> sq_matrix <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"semiring_1"</span></span><span class="main">,</span> <span class="quoted">finite</span><span class="main">)</span> <span class="quoted">numeral</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diag_1<span class="main">:</span> <span class="quoted"><span class="quoted">"diag <span class="main">1</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> diag_1_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"diag <span class="free">x</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> sq_matrix <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"ring_1"</span></span><span class="main">,</span> <span class="quoted">finite</span><span class="main">)</span> <span class="quoted">ring_1</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">interpretation</span></span> sq_matrix<span class="main">:</span> vector_space <span class="quoted">smult_sq_matrix</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_eq_iff <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> sq_matrix <span class="main">::</span> <span class="main">(</span><span class="quoted">real_vector</span><span class="main">,</span> <span class="quoted">finite</span><span class="main">)</span> <span class="quoted">real_vector</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">scaleR_sq_matrix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">r</span> <span class="bound">A</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">r</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">A</span> <span class="bound">i</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> scaleR_add_right scaleR_add_left<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instance</span></span> sq_matrix <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"semiring_1"</span></span><span class="main">,</span> <span class="quoted">finite</span><span class="main">)</span> <span class="quoted">Rings.dvd</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> transpose <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'n</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">M</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">M</span> <span class="bound">j</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> transpose_transpose<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"transpose <span class="main">(</span>transpose <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> transpose_diag<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"transpose <span class="main">(</span>diag <span class="free">c</span><span class="main">)</span> <span class="main">=</span> diag <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> transpose_zero<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"transpose <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> transpose_one<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"transpose <span class="main">1</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> transpose_add<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"transpose <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> transpose <span class="free">A</span> <span class="main">+</span> transpose <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> transpose_minus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"transpose <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> transpose <span class="free">A</span> <span class="main">-</span> transpose <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> transpose_uminus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"transpose <span class="main">(</span><span class="main">-</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> transpose <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> transpose_mult<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"transpose <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>comm_semiring_0<span class="main">^^</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">=</span> transpose <span class="free">B</span> <span class="main">*</span> transpose <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> trace <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>comm_monoid_add<span class="main">^^</span><span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">M</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="bound">M</span> <span class="bound">i</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trace_diag<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>diag <span class="free">c</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>semiring_1<span class="main">^^</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">=</span> of_nat <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">*</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> trace_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> trace_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>semiring_1<span class="main">^^</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">=</span> of_nat <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> trace_plus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> trace <span class="free">A</span> <span class="main">+</span> trace <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.distrib<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trace_minus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>trace <span class="free">A</span> <span class="main">-</span> trace <span class="free">B</span><span class="main">::</span><span class="main">_</span><span class="main">::</span>ab_group_add<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_subtractf<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trace_uminus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span><span class="main">-</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="main">(</span>trace <span class="free">A</span><span class="main">::</span><span class="main">_</span><span class="main">::</span>ab_group_add<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_negf<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trace_smult<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span><span class="free">s</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span> <span class="main">*</span> trace <span class="free">A</span><span class="main">::</span><span class="main">_</span><span class="main">::</span>semiring_0<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trace_transpose<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span>transpose <span class="free">A</span><span class="main">)</span> <span class="main">=</span> trace <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> trace_mult_symm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>comm_semiring_0<span class="main">^^</span><span class="tfree">'n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trace <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> trace <span class="main">(</span><span class="free">B</span> <span class="main">*</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.swap <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult.commute<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> det <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>comm_ring_1<span class="main">^^</span><span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span><span class="main">|</span><span class="bound">p</span> <span class="keyword1">permutes</span> UNIV<span class="main">.</span> of_int <span class="main">(</span>sign <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="bound">A</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">p</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> det_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span><span class="main">|</span><span class="bound">p</span> <span class="keyword1">permutes</span> UNIV<span class="main">.</span> of_int <span class="main">(</span>sign <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> to_fun <span class="free">A</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">p</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">rule</span>

<span class="keyword1"><span class="command">lemma</span></span> permutes_UNIV_permutation<span class="main">:</span> <span class="quoted"><span class="quoted">"permutation <span class="free">p</span> <span class="main">⟷</span> <span class="free">p</span> <span class="keyword1">permutes</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="main">_</span><span class="main">::</span>finite<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> permutation_permutes permutes_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> det_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_power<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> det_transpose<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>transpose <span class="free">A</span><span class="main">)</span> <span class="main">=</span> det <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_permutations_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sign_inverse permutes_UNIV_permutation<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> prod.reindex_bij_betw<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> permutes_imp_bij<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutes_inverses<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> det_diagonal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>comm_ring_1<span class="main">^^</span><span class="tfree">'n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟹</span> to_fun <span class="free">A</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> det <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> to_fun <span class="free">A</span> <span class="bound">i</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">transfer</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword3"><span class="command">assume</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≠</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="skolem">A</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> of_int <span class="main">(</span>sign <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="skolem">A</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">p</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'n</span>"</span></span> <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">permutes</span> UNIV"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> id"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">p</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> id_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">with</span></span> neq<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="skolem">A</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">p</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod_zero<span class="main">)</span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> <span class="bound">p</span> <span class="keyword1">permutes</span> UNIV<span class="main">.</span> <span class="var">?pp</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈</span><span class="main">{</span>id<span class="main">}</span><span class="main">.</span> <span class="var">?pp</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_cong_right<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> permutes_id<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> <span class="bound">p</span> <span class="keyword1">permutes</span> UNIV<span class="main">.</span> <span class="var">?pp</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="skolem">A</span> <span class="bound">i</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sign_id<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> det_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="main">(</span><span class="main">1</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>comm_ring_1<span class="main">^^</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> det_diagonal<span class="main">)</span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> det_lowerdiagonal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>comm_ring_1<span class="main">^^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span>wellorder<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟹</span> to_fun <span class="free">A</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> det <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> to_fun <span class="free">A</span> <span class="bound">i</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">transfer</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword3"><span class="command">assume</span></span> ld<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="skolem">A</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pp</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> of_int <span class="main">(</span>sign <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="skolem">A</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">p</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'n</span>"</span></span> <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">permutes</span> UNIV"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> id"</span></span>
    <span class="keyword1"><span class="command">with</span></span> permutes_natset_le<span class="main">[</span><span class="operator">OF</span> p<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_le<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> ld<span class="main">[</span><span class="operator">OF</span> i<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="skolem">A</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">p</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prod_zero<span class="main">)</span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> <span class="bound">p</span> <span class="keyword1">permutes</span> UNIV<span class="main">.</span> <span class="var">?pp</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈</span><span class="main">{</span>id<span class="main">}</span><span class="main">.</span> <span class="var">?pp</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_cong_right<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> permutes_id<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> <span class="bound">p</span> <span class="keyword1">permutes</span> UNIV<span class="main">.</span> <span class="var">?pp</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="skolem">A</span> <span class="bound">i</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sign_id<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> det_upperdiagonal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>comm_ring_1<span class="main">^^</span><span class="tfree">'n</span><span class="main">::</span><span class="main">{</span>finite<span class="main">,</span> wellorder<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">⟹</span> to_fun <span class="free">A</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> det <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> to_fun <span class="free">A</span> <span class="bound">i</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> det_lowerdiagonal<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"transpose <span class="free">A</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> det_transpose transpose.rep_eq <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> perm_rows <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">M</span> <span class="bound">p</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">M</span> <span class="main">(</span><span class="bound">p</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> perm_cols <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">M</span> <span class="bound">p</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">M</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">p</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> upd_rows <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">M</span> <span class="bound">S</span> <span class="bound">v</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">∈</span> <span class="bound">S</span> <span class="keyword1">then</span> <span class="bound">v</span> <span class="bound">i</span> <span class="main">$</span> <span class="bound">j</span> <span class="keyword1">else</span> <span class="bound">M</span> <span class="bound">i</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> upd_cols <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">M</span> <span class="bound">S</span> <span class="bound">v</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">∈</span> <span class="bound">S</span> <span class="keyword1">then</span> <span class="bound">v</span> <span class="bound">j</span> <span class="main">$</span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="bound">M</span> <span class="bound">i</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> upd_row <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">M</span> <span class="bound">i'</span> <span class="bound">v</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">i'</span> <span class="keyword1">then</span> <span class="bound">v</span> <span class="main">$</span> <span class="bound">j</span> <span class="keyword1">else</span> <span class="bound">M</span> <span class="bound">i</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> upd_col <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">M</span> <span class="bound">j'</span> <span class="bound">v</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">j</span> <span class="main">=</span> <span class="bound">j'</span> <span class="keyword1">then</span> <span class="bound">v</span> <span class="main">$</span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="bound">M</span> <span class="bound">i</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> row <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">M</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">M</span> <span class="bound">i</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> col <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^</span><span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">M</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">M</span> <span class="bound">i</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> perm_rows_transpose<span class="main">:</span> <span class="quoted"><span class="quoted">"perm_rows <span class="main">(</span>transpose <span class="free">M</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> transpose <span class="main">(</span>perm_cols <span class="free">M</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> perm_cols_transpose<span class="main">:</span> <span class="quoted"><span class="quoted">"perm_cols <span class="main">(</span>transpose <span class="free">M</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> transpose <span class="main">(</span>perm_rows <span class="free">M</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> upd_row_transpose<span class="main">:</span> <span class="quoted"><span class="quoted">"upd_row <span class="main">(</span>transpose <span class="free">M</span><span class="main">)</span> <span class="free">i</span> <span class="free">p</span> <span class="main">=</span> transpose <span class="main">(</span>upd_col <span class="free">M</span> <span class="free">i</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> upd_col_transpose<span class="main">:</span> <span class="quoted"><span class="quoted">"upd_col <span class="main">(</span>transpose <span class="free">M</span><span class="main">)</span> <span class="free">i</span> <span class="free">p</span> <span class="main">=</span> transpose <span class="main">(</span>upd_row <span class="free">M</span> <span class="free">i</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> upd_rows_transpose<span class="main">:</span> <span class="quoted"><span class="quoted">"upd_rows <span class="main">(</span>transpose <span class="free">M</span><span class="main">)</span> <span class="free">i</span> <span class="free">p</span> <span class="main">=</span> transpose <span class="main">(</span>upd_cols <span class="free">M</span> <span class="free">i</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> upd_cols_transpose<span class="main">:</span> <span class="quoted"><span class="quoted">"upd_cols <span class="main">(</span>transpose <span class="free">M</span><span class="main">)</span> <span class="free">i</span> <span class="free">p</span> <span class="main">=</span> transpose <span class="main">(</span>upd_rows <span class="free">M</span> <span class="free">i</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> upd_rows_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"upd_rows <span class="free">M</span> <span class="main">{}</span> <span class="free">f</span> <span class="main">=</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> upd_cols_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"upd_cols <span class="free">M</span> <span class="main">{}</span> <span class="free">f</span> <span class="main">=</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> upd_rows_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"upd_rows <span class="free">M</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="free">f</span> <span class="main">=</span> upd_row <span class="free">M</span> <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> upd_cols_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"upd_cols <span class="free">M</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="free">f</span> <span class="main">=</span> upd_col <span class="free">M</span> <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> upd_rows_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"upd_rows <span class="free">M</span> <span class="main">(</span>insert <span class="free">i</span> <span class="free">I</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> upd_row <span class="main">(</span>upd_rows <span class="free">M</span> <span class="free">I</span> <span class="free">f</span><span class="main">)</span> <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> upd_rows_insert_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"upd_rows <span class="free">M</span> <span class="main">(</span>insert <span class="free">i</span> <span class="free">I</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> upd_rows <span class="main">(</span>upd_row <span class="free">M</span> <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> upd_rows_upd_row_swap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">I</span> <span class="main">⟹</span> upd_rows <span class="main">(</span>upd_row <span class="free">M</span> <span class="free">i</span> <span class="free">x</span><span class="main">)</span> <span class="free">I</span> <span class="free">f</span> <span class="main">=</span> upd_row <span class="main">(</span>upd_rows <span class="free">M</span> <span class="free">I</span> <span class="free">f</span><span class="main">)</span> <span class="free">i</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> upd_cols_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"upd_cols <span class="free">M</span> <span class="main">(</span>insert <span class="free">i</span> <span class="free">I</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> upd_col <span class="main">(</span>upd_cols <span class="free">M</span> <span class="free">I</span> <span class="free">f</span><span class="main">)</span> <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> upd_cols_insert_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"upd_cols <span class="free">M</span> <span class="main">(</span>insert <span class="free">i</span> <span class="free">I</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> upd_cols <span class="main">(</span>upd_col <span class="free">M</span> <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> upd_cols_upd_col_swap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">I</span> <span class="main">⟹</span> upd_cols <span class="main">(</span>upd_col <span class="free">M</span> <span class="free">i</span> <span class="free">x</span><span class="main">)</span> <span class="free">I</span> <span class="free">f</span> <span class="main">=</span> upd_col <span class="main">(</span>upd_cols <span class="free">M</span> <span class="free">I</span> <span class="free">f</span><span class="main">)</span> <span class="free">i</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> upd_rows_cong<span class="main">[</span><span class="operator">cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="free">N</span> <span class="main">⟹</span> <span class="free">T</span> <span class="main">=</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="keyword1">=simp=&gt;</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> upd_rows <span class="free">M</span> <span class="free">T</span> <span class="free">f</span> <span class="main">=</span> upd_rows <span class="free">N</span> <span class="free">S</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> simp_implies_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> upd_cols_cong<span class="main">[</span><span class="operator">cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="free">N</span> <span class="main">⟹</span> <span class="free">T</span> <span class="main">=</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="keyword1">=simp=&gt;</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> upd_cols <span class="free">M</span> <span class="free">T</span> <span class="free">f</span> <span class="main">=</span> upd_cols <span class="free">N</span> <span class="free">S</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> simp_implies_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> row_upd_row_If<span class="main">:</span> <span class="quoted"><span class="quoted">"row <span class="main">(</span>upd_row <span class="free">M</span> <span class="free">i</span> <span class="free">x</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="keyword1">else</span> row <span class="free">M</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_eq_iff fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> row_upd_row<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"row <span class="main">(</span>upd_row <span class="free">M</span> <span class="free">i</span> <span class="free">x</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> row_upd_row_If<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> col_upd_col_If<span class="main">:</span> <span class="quoted"><span class="quoted">"col <span class="main">(</span>upd_col <span class="free">M</span> <span class="free">i</span> <span class="free">x</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="keyword1">else</span> col <span class="free">M</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> col_upd_col<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"col <span class="main">(</span>upd_col <span class="free">M</span> <span class="free">i</span> <span class="free">x</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> col_upd_col_If<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> upd_row_row<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"upd_row <span class="free">M</span> <span class="free">i</span> <span class="main">(</span>row <span class="free">M</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> upd_row_upd_row_cancel<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"upd_row <span class="main">(</span>upd_row <span class="free">M</span> <span class="free">i</span> <span class="free">x</span><span class="main">)</span> <span class="free">i</span> <span class="free">y</span> <span class="main">=</span> upd_row <span class="free">M</span> <span class="free">i</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> upd_col_upd_col_cancel<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"upd_col <span class="main">(</span>upd_col <span class="free">M</span> <span class="free">i</span> <span class="free">x</span><span class="main">)</span> <span class="free">i</span> <span class="free">y</span> <span class="main">=</span> upd_col <span class="free">M</span> <span class="free">i</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> upd_col_col<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"upd_col <span class="free">M</span> <span class="free">i</span> <span class="main">(</span>col <span class="free">M</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> row_transpose<span class="main">:</span> <span class="quoted"><span class="quoted">"row <span class="main">(</span>transpose <span class="free">M</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> col <span class="free">M</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> col_transpose<span class="main">:</span> <span class="quoted"><span class="quoted">"col <span class="main">(</span>transpose <span class="free">M</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> row <span class="free">M</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> det_perm_cols<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>comm_ring_1<span class="main">^^</span><span class="tfree">'n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">permutes</span> UNIV"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>perm_cols <span class="free">A</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> of_int <span class="main">(</span>sign <span class="free">p</span><span class="main">)</span> <span class="main">*</span> det <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">q</span></span> <span class="main">|</span> <span class="bound">q</span> <span class="keyword1">permutes</span> UNIV<span class="main">.</span> of_int <span class="main">(</span>sign <span class="bound">q</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="skolem">A</span> <span class="bound">i</span> <span class="main">(</span><span class="free">p</span> <span class="main">(</span><span class="bound">q</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">q</span></span> <span class="main">|</span> <span class="bound">q</span> <span class="keyword1">permutes</span> UNIV<span class="main">.</span> of_int <span class="main">(</span>sign <span class="main">(</span>inv <span class="free">p</span> <span class="main">∘</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="skolem">A</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">q</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.reindex_bij_witness<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">q</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="free"><span class="free"><span class="free">p</span></span></span> <span class="main"><span class="main"><span class="main">∘</span></span></span> <span class="bound"><span class="bound"><span class="bound">q</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">q</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> inv <span class="free"><span class="free"><span class="free">p</span></span></span> <span class="main"><span class="main"><span class="main">∘</span></span></span> <span class="bound"><span class="bound"><span class="bound">q</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> permutes_inv_o permutes_compose permutes_inv<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> p <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">q</span></span> <span class="main">|</span> <span class="bound">q</span> <span class="keyword1">permutes</span> UNIV<span class="main">.</span> of_int <span class="main">(</span>sign <span class="bound">q</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="skolem">A</span> <span class="bound">i</span> <span class="main">(</span><span class="free">p</span> <span class="main">(</span><span class="bound">q</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      of_int <span class="main">(</span>sign <span class="free">p</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> <span class="bound">p</span> <span class="keyword1">permutes</span> UNIV<span class="main">.</span> of_int <span class="main">(</span>sign <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="skolem">A</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">p</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sum_distrib_left sign_compose permutes_inv sign_inverse permutes_UNIV_permutation<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> det_perm_rows<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>comm_ring_1<span class="main">^^</span><span class="tfree">'n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">permutes</span> UNIV"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>perm_rows <span class="free">A</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> of_int <span class="main">(</span>sign <span class="free">p</span><span class="main">)</span> <span class="main">*</span> det <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> det_perm_cols<span class="main">[</span><span class="operator">OF</span> p<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"transpose <span class="free">A</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> det_transpose perm_cols_transpose<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> det_row_add<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>upd_row <span class="free">M</span> <span class="free">i</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> det <span class="main">(</span>upd_row <span class="free">M</span> <span class="free">i</span> <span class="free">a</span><span class="main">)</span> <span class="main">+</span> det <span class="main">(</span>upd_row <span class="free">M</span> <span class="free">i</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.If_cases sum.distrib<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> det_row_mul<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>upd_row <span class="free">M</span> <span class="free">i</span> <span class="main">(</span><span class="free">c</span> <span class="keyword1">*s</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span> <span class="main">*</span> det <span class="main">(</span>upd_row <span class="free">M</span> <span class="free">i</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.If_cases sum_distrib_left <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> det_row_uminus<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>upd_row <span class="free">M</span> <span class="free">i</span> <span class="main">(</span><span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> det <span class="main">(</span>upd_row <span class="free">M</span> <span class="free">i</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vector_sneg_minus1 det_row_mul<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> det_row_minus<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>upd_row <span class="free">M</span> <span class="free">i</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> det <span class="main">(</span>upd_row <span class="free">M</span> <span class="free">i</span> <span class="free">a</span><span class="main">)</span> <span class="main">-</span> det <span class="main">(</span>upd_row <span class="free">M</span> <span class="free">i</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> diff_conv_add_uminus det_row_add det_row_uminus <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">lemma</span></span> det_row_0<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>upd_row <span class="free">M</span> <span class="free">i</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> det_row_mul<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> det_row_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>upd_row <span class="free">M</span> <span class="free">i</span> <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">a</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> det <span class="main">(</span>upd_row <span class="free">M</span> <span class="free">i</span> <span class="main">(</span><span class="free">a</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> det_row_0 det_row_add<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> det_col_add<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>upd_col <span class="free">M</span> <span class="free">i</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> det <span class="main">(</span>upd_col <span class="free">M</span> <span class="free">i</span> <span class="free">a</span><span class="main">)</span> <span class="main">+</span> det <span class="main">(</span>upd_col <span class="free">M</span> <span class="free">i</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> det_row_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"transpose <span class="free">M</span>"</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upd_row_transpose det_transpose<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> det_col_mul<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>upd_col <span class="free">M</span> <span class="free">i</span> <span class="main">(</span><span class="free">c</span> <span class="keyword1">*s</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span> <span class="main">*</span> det <span class="main">(</span>upd_col <span class="free">M</span> <span class="free">i</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> det_row_mul<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"transpose <span class="free">M</span>"</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upd_row_transpose det_transpose<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> det_col_uminus<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>upd_col <span class="free">M</span> <span class="free">i</span> <span class="main">(</span><span class="main">-</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> det <span class="main">(</span>upd_col <span class="free">M</span> <span class="free">i</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vector_sneg_minus1 det_col_mul<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> det_col_minus<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>upd_col <span class="free">M</span> <span class="free">i</span> <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> det <span class="main">(</span>upd_col <span class="free">M</span> <span class="free">i</span> <span class="free">a</span><span class="main">)</span> <span class="main">-</span> det <span class="main">(</span>upd_col <span class="free">M</span> <span class="free">i</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> diff_conv_add_uminus det_col_add det_col_uminus <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">lemma</span></span> det_col_0<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>upd_col <span class="free">M</span> <span class="free">i</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> det_col_mul<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> det_col_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>upd_col <span class="free">M</span> <span class="free">i</span> <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">a</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> det <span class="main">(</span>upd_col <span class="free">M</span> <span class="free">i</span> <span class="main">(</span><span class="free">a</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> det_col_0 det_col_add<span class="main">)</span>

<span class="comment1">(* Proof by Jose Divason *)</span>
<span class="keyword1"><span class="command">lemma</span></span> det_identical_cols<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">i'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"col <span class="free">A</span> <span class="free">i</span> <span class="main">=</span> col <span class="free">A</span> <span class="free">i'</span> <span class="main">⟹</span> det <span class="free">A</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">i'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="skolem">A</span> <span class="bound">j</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">χ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">A</span> <span class="bound">i</span> <span class="free">i'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span> <span class="bound">q</span><span class="main">.</span> <span class="skolem">A</span> <span class="bound">j</span> <span class="main">(</span>Fun.swap <span class="free">i</span> <span class="free">i'</span> id <span class="main">(</span><span class="bound">q</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">A</span> <span class="bound">j</span> <span class="main">(</span><span class="bound">q</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_eq_iff swap_def<span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> of_int <span class="main">(</span>sign <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="skolem">A</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">p</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">q</span><span class="main">.</span> Fun.swap <span class="free">i</span> <span class="free">i'</span> id <span class="main">∘</span> <span class="bound">q</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?E</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="keyword1">permutes</span> UNIV <span class="main">∧</span> evenperm <span class="bound">p</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="var">?s</span> <span class="var">?E</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def fun_eq_iff swap_def<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> p <span class="main">=</span> permutes_UNIV_permutation evenperm_comp permutes_swap_id evenperm_swap permutes_compose
    sign_compose sign_swap_id
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≠</span> <span class="free">i'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"evenperm <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∉</span> <span class="var">?s</span><span class="main">`</span><span class="var">?E</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">permutes</span> UNIV"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">q</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> image_iff p <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> allE<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="skolem">q</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> <span class="bound">p</span> <span class="keyword1">permutes</span> UNIV<span class="main">.</span> <span class="var">?p</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span> <span class="main">∈</span> <span class="var">?E</span> <span class="main">∪</span> <span class="var">?s</span><span class="main">`</span><span class="var">?E</span><span class="main">.</span> <span class="var">?p</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutes_compose permutes_swap_id <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> * sum.cong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈</span><span class="var">?E</span><span class="main">.</span> <span class="var">?p</span> <span class="bound">p</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈</span><span class="var">?s</span><span class="main">`</span><span class="var">?E</span><span class="main">.</span> <span class="var">?p</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.union_disjoint<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≠</span> <span class="free">i'</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈</span><span class="var">?s</span><span class="main">`</span><span class="var">?E</span><span class="main">.</span> <span class="var">?p</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">p</span><span class="main">∈</span><span class="var">?E</span><span class="main">.</span> <span class="main">-</span> <span class="var">?p</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≠</span> <span class="free">i'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.reindex<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> <span class="bound">p</span> <span class="keyword1">permutes</span> UNIV<span class="main">.</span> <span class="var">?p</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_negf<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> det_identical_rows<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">i'</span> <span class="main">⟹</span> row <span class="free">A</span> <span class="free">i</span> <span class="main">=</span> row <span class="free">A</span> <span class="free">i'</span> <span class="main">⟹</span> det <span class="free">A</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> det_identical_cols<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">i'</span></span> <span class="quoted"><span class="quoted">"transpose <span class="free">A</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> det_transpose col_transpose<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> det_cols_sum<span class="main">:</span>
  <span class="quoted"><span class="quoted">"det <span class="main">(</span>upd_cols <span class="free">M</span> <span class="free">T</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">f</span><span class="main">∈</span><span class="free">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">S</span><span class="main">.</span> det <span class="main">(</span>upd_cols <span class="free">M</span> <span class="free">T</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">T</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">f</span><span class="main">∈</span>insert <span class="skolem">i</span> <span class="skolem">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">S</span><span class="main">.</span> det <span class="main">(</span>upd_cols <span class="skolem">M</span> <span class="main">(</span>insert <span class="skolem">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">∑</span><span class="bound">f</span><span class="main">∈</span><span class="skolem">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">S</span><span class="main">.</span> det <span class="main">(</span>upd_cols <span class="main">(</span>upd_col <span class="skolem">M</span> <span class="skolem">i</span> <span class="main">(</span><span class="free">a</span> <span class="skolem">i</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">T</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sum.cartesian_product PiE_insert_eq <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> <span class="skolem">T</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.reindex<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inj_combinator<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> <span class="skolem">T</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.cong arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">det</span><span class="main"><span class="main">]</span></span> upd_cols_cong
             <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upd_cols_insert_rev simp_implies_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> det <span class="main">(</span>upd_col <span class="main">(</span>upd_cols <span class="skolem">M</span> <span class="skolem">T</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> sum <span class="main">(</span><span class="free">a</span> <span class="bound">i</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">a</span> <span class="skolem">i</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> insert<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upd_cols_upd_col_swap<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> <span class="skolem">T</span>›</span></span><span class="main"><span class="main">]</span></span> det_col_sum<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upd_cols_insert<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> det_rows_sum<span class="main">:</span>
  <span class="quoted"><span class="quoted">"det <span class="main">(</span>upd_rows <span class="free">M</span> <span class="free">T</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">∑</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">f</span><span class="main">∈</span><span class="free">T</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>E</sub></span> <span class="free">S</span><span class="main">.</span> det <span class="main">(</span>upd_rows <span class="free">M</span> <span class="free">T</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> det_cols_sum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"transpose <span class="free">M</span>"</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upd_cols_transpose det_transpose<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> det_rows_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>upd_rows <span class="free">M</span> <span class="free">T</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">c</span> <span class="bound">i</span> <span class="keyword1">*s</span> <span class="free">a</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span><span class="free">T</span><span class="main">.</span> <span class="free">c</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> det <span class="main">(</span>upd_rows <span class="free">M</span> <span class="free">T</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.If_cases sum_distrib_left <span class="dynamic"><span class="dynamic">field_simps</span></span> prod.distrib<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> det_cols_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>upd_cols <span class="free">M</span> <span class="free">T</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">c</span> <span class="bound">i</span> <span class="keyword1">*s</span> <span class="free">a</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span><span class="free">T</span><span class="main">.</span> <span class="free">c</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> det <span class="main">(</span>upd_cols <span class="free">M</span> <span class="free">T</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> det_rows_mult<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"transpose <span class="free">M</span>"</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> det_transpose upd_rows_transpose<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> det_perm_rows_If<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>perm_rows <span class="free">B</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">f</span> <span class="keyword1">permutes</span> UNIV <span class="keyword1">then</span> of_int <span class="main">(</span>sign <span class="free">f</span><span class="main">)</span> <span class="main">*</span> det <span class="free">B</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">f</span> <span class="keyword1">permutes</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> bij_imp_permutes<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted">UNIV</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> inj <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_UNIV_inj_surj<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"row <span class="main">(</span>perm_rows <span class="free">B</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> row <span class="main">(</span>perm_rows <span class="free">B</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> det_identical_rows<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> det_perm_rows<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> det_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> det <span class="free">A</span> <span class="main">*</span> det <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">*</span> <span class="free">B</span> <span class="main">=</span> upd_rows <span class="main">0</span> UNIV <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">∑</span><span class="bound">j</span><span class="main">∈</span>UNIV<span class="main">.</span> to_fun <span class="free">A</span> <span class="bound">i</span> <span class="bound">j</span> <span class="keyword1">*s</span> row <span class="free">B</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> upd_rows <span class="main">0</span> UNIV <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Square_Matrix.row <span class="free">B</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> perm_rows <span class="free">B</span> <span class="bound">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"det <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> <span class="bound">p</span> <span class="keyword1">permutes</span> UNIV<span class="main">.</span> of_int <span class="main">(</span>sign <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> to_fun <span class="free">A</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">p</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> det_rows_sum det_rows_mult sum_distrib_right det_perm_rows_If
             <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.mono_neutral_cong_right<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> minor <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>semiring_1<span class="main">^^</span><span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">A</span> <span class="bound">i</span> <span class="bound">j</span> <span class="bound">k</span> <span class="bound">l</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">∨</span> <span class="bound">l</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="bound">A</span> <span class="bound">k</span> <span class="bound">l</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> minor_transpose<span class="main">:</span> <span class="quoted"><span class="quoted">"minor <span class="main">(</span>transpose <span class="free">A</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> transpose <span class="main">(</span>minor <span class="free">A</span> <span class="free">j</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> minor_eq_row_col<span class="main">:</span> <span class="quoted"><span class="quoted">"minor <span class="free">M</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> upd_row <span class="main">(</span>upd_col <span class="free">M</span> <span class="free">j</span> <span class="main">(</span>axis <span class="free">i</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="main">(</span>axis <span class="free">j</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff axis_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> minor_eq_col_row<span class="main">:</span> <span class="quoted"><span class="quoted">"minor <span class="free">M</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> upd_col <span class="main">(</span>upd_row <span class="free">M</span> <span class="free">i</span> <span class="main">(</span>axis <span class="free">j</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span> <span class="main">(</span>axis <span class="free">i</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff axis_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> row_minor<span class="main">:</span> <span class="quoted"><span class="quoted">"row <span class="main">(</span>minor <span class="free">M</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> axis <span class="free">j</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minor_eq_row_col<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> col_minor<span class="main">:</span> <span class="quoted"><span class="quoted">"col <span class="main">(</span>minor <span class="free">M</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> axis <span class="free">i</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minor_eq_col_row<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> det_minor_row'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"row <span class="free">B</span> <span class="free">i</span> <span class="main">=</span> axis <span class="free">j</span> <span class="main">1</span> <span class="main">⟹</span> det <span class="main">(</span>minor <span class="free">B</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> det <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">k</span><span class="main">.</span> to_fun <span class="free">B</span> <span class="bound">k</span> <span class="free">j</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≠</span> <span class="free">i</span> <span class="main">⟶</span> to_fun <span class="skolem">B</span> <span class="bound">k</span> <span class="free">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_eq_0_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> empty.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"axis <span class="free">i</span> <span class="main">1</span> <span class="main">=</span> col <span class="skolem">B</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vec_eq_iff axis_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> empty.prems<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minor_eq_row_col<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">r</span> <span class="skolem">NZ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"to_fun <span class="skolem">B</span> <span class="skolem">r</span> <span class="free">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"upd_row <span class="skolem">B</span> <span class="skolem">r</span> <span class="main">(</span>row <span class="skolem">B</span> <span class="skolem">r</span> <span class="main">-</span> <span class="main">(</span>to_fun <span class="skolem">B</span> <span class="skolem">r</span> <span class="free">j</span><span class="main">)</span> <span class="keyword1">*s</span> row <span class="skolem">B</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>minor <span class="var">?B'</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> det <span class="var">?B'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> insert.hyps<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">NZ</span> <span class="main">=</span> <span class="main">{</span><span class="bound">k</span><span class="main">.</span> to_fun <span class="var">?B'</span> <span class="bound">k</span> <span class="free">j</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert.hyps<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> insert.prems
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> axis_def set_eq_iff<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"row <span class="var">?B'</span> <span class="free">i</span> <span class="main">=</span> axis <span class="free">j</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r insert <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> row_upd_row_If<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"minor <span class="var">?B'</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> minor <span class="skolem">B</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r insert.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff axis_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"det <span class="var">?B'</span> <span class="main">=</span> det <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">≠</span> <span class="free">i</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> det_row_minus det_row_mul det_identical_rows<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">≠</span> <span class="free">i</span>›</span></span><span class="main"><span class="main">]</span></span> row_upd_row_If<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> det_minor_row<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>minor <span class="free">B</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> det <span class="main">(</span>upd_row <span class="free">B</span> <span class="free">i</span> <span class="main">(</span>axis <span class="free">j</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>minor <span class="main">(</span>upd_row <span class="free">B</span> <span class="free">i</span> <span class="main">(</span>axis <span class="free">j</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> det <span class="main">(</span>upd_row <span class="free">B</span> <span class="free">i</span> <span class="main">(</span>axis <span class="free">j</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> det_minor_row'<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minor_eq_col_row<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> det_minor_col<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>minor <span class="free">B</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> det <span class="main">(</span>upd_col <span class="free">B</span> <span class="free">j</span> <span class="main">(</span>axis <span class="free">i</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> det_minor_row<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"transpose <span class="free">B</span>"</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minor_transpose det_transpose upd_row_transpose<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> cofactor <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>comm_ring_1<span class="main">^^</span><span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">A</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> det <span class="main">(</span>minor <span class="bound">A</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cofactor_transpose<span class="main">:</span> <span class="quoted"><span class="quoted">"cofactor <span class="main">(</span>transpose <span class="free">A</span><span class="main">)</span> <span class="main">=</span> transpose <span class="main">(</span>cofactor <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cofactor_def minor_transpose det_transpose transpose.rep_eq to_fun_inject<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> of_fun_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">adjugate</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> transpose <span class="main">(</span>cofactor <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> adjugate_transpose<span class="main">:</span> <span class="quoted"><span class="quoted">"adjugate <span class="main">(</span>transpose <span class="free">A</span><span class="main">)</span> <span class="main">=</span> transpose <span class="main">(</span>adjugate <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adjugate_def cofactor_transpose<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> adjugate_mult_det<span class="main">:</span> <span class="quoted"><span class="quoted">"adjugate <span class="free">A</span> <span class="main">*</span> <span class="free">A</span> <span class="main">=</span> diag <span class="main">(</span>det <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> to_fun_inject<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span> fun_eq_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span> allI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">k</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"to_fun <span class="main">(</span>adjugate <span class="free">A</span> <span class="main">*</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span>UNIV<span class="main">.</span> to_fun <span class="free">A</span> <span class="bound">j</span> <span class="skolem">k</span> <span class="main">*</span> det <span class="main">(</span>minor <span class="free">A</span> <span class="bound">j</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adjugate_def times_sq_matrix.rep_eq transpose.rep_eq cofactor_def mult.commute of_fun_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> det <span class="main">(</span>upd_col <span class="free">A</span> <span class="skolem">i</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span>UNIV<span class="main">.</span> to_fun <span class="free">A</span> <span class="bound">j</span> <span class="skolem">k</span> <span class="keyword1">*s</span> axis <span class="bound">j</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> det_minor_col det_col_mul det_col_sum<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span>UNIV<span class="main">.</span> to_fun <span class="free">A</span> <span class="bound">j</span> <span class="skolem">k</span> <span class="keyword1">*s</span> axis <span class="bound">j</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> col <span class="free">A</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> smult_axis vec_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> axis_def sum.If_cases<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>upd_col <span class="free">A</span> <span class="skolem">i</span> <span class="main">(</span>col <span class="free">A</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span> <span class="keyword1">then</span> det <span class="free">A</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> col_upd_col_If det_identical_cols<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> to_fun <span class="main">(</span>diag <span class="main">(</span>det <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diag.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"to_fun <span class="main">(</span>adjugate <span class="free">A</span> <span class="main">*</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">k</span> <span class="main">=</span> to_fun <span class="main">(</span>diag <span class="main">(</span>det <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mult_adjugate_det<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">*</span> adjugate <span class="free">A</span> <span class="main">=</span> diag <span class="main">(</span>det <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"transpose <span class="main">(</span>transpose <span class="main">(</span><span class="free">A</span> <span class="main">*</span> adjugate <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> transpose <span class="main">(</span>diag <span class="main">(</span>det <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> transpose_mult adjugate_transpose<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> adjugate_mult_det det_transpose <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Cayley_Hamilton">
<div class="head">
<h1>Theory Cayley_Hamilton</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Cayley_Hamilton/Cayley_Hamilton.thy
    Author:     Johannes Hölzl, TU München
    Author:     Stefan Hetzl, TU Wien
    Author:     Stephan Adelsberge, WU Wien
    Author:     Florian Pollak, TU Wien
*)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Cayley_Hamilton
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Square_Matrix.html">Square_Matrix</a>
  <span class="quoted">"<a href="../../HOL/HOL-Computational_Algebra/Polynomial.html">HOL-Computational_Algebra.Polynomial</a>"</span>  
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">C</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>ring_1 poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">[:</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">:]</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">CC</span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>C</b></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free"><span class="hidden">❙</span><b>C</b></span></span> <span class="main">≡</span> map_sq_matrix C"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> degree_C<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>C <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> C_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_C_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>C <span class="free">x</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> C_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_C_gt0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> coeff <span class="main">(</span>C <span class="free">x</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> C_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_C_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>C <span class="free">x</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_mult_C<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span><span class="free">a</span> <span class="main">*</span> C <span class="free">x</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> coeff <span class="free">a</span> <span class="free">n</span> <span class="main">*</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coeff_mult coeff_C_eq if_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">a</span><span class="main"><span class="main">]</span></span> sum.If_cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_C_mult<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>C <span class="free">x</span> <span class="main">*</span> <span class="free">a</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> coeff <span class="free">a</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coeff_mult coeff_C_eq if_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">a</span><span class="main"><span class="main">]</span></span> sum.If_cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> C_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"C <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> C_def<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> C_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"C <span class="main">1</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> C_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> C_linear<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> C_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"C <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> C <span class="free">b</span> <span class="main">*</span> C <span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> C_add<span class="main">:</span> <span class="quoted"><span class="quoted">"C <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> C <span class="free">a</span> <span class="main">+</span> C <span class="free">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> C_minus<span class="main">:</span> <span class="quoted"><span class="quoted">"C <span class="main">(</span><span class="main">-</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> C <span class="free">a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> C_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"C <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> C <span class="free">a</span> <span class="main">-</span> C <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> C_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ring_1 poly"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="main">[:</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">:]</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">XX</span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>X</b></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free"><span class="hidden">❙</span><b>X</b></span></span> <span class="main">≡</span> diag X"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> degree_X<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"degree X <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> X_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_X_Suc_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"coeff X <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_X_mult<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>X <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">=</span> coeff <span class="free">p</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_mult_X<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span><span class="free">p</span> <span class="main">*</span> X<span class="main">)</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">=</span> coeff <span class="free">p</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_X_mult_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>X <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_mult_X_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span><span class="free">p</span> <span class="main">*</span> X<span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_X<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff X <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X_def gr0_conv_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_pow_X<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>X <span class="main">^</span> <span class="free">i</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_pow_X_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>X<span class="main">^</span><span class="free">i</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coeff_pow_X<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> monoid_mult<span class="main">)</span> power_ac<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">a</span><span class="main">^</span><span class="free">n</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span><span class="main">^</span><span class="free">n</span> <span class="main">*</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> power_Suc2 power_Suc mult.assoc<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This theory contains auxiliary lemmas on polynomials.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> degree_prod_le<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> degree <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> degree_mult_le dual_order.trans nat_add_left_cancel_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_mult_sum<span class="main">:</span>
  <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span> degree <span class="free">q</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> coeff <span class="main">(</span><span class="free">p</span> <span class="main">*</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> coeff <span class="free">p</span> <span class="free">m</span> <span class="main">*</span> coeff <span class="free">q</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> degree_mult_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_less coeff_eq_0 coeff_mult_degree_sum<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_mult_prod_sum<span class="main">:</span>
  <span class="quoted"><span class="quoted">"coeff <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> degree <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> coeff <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>degree <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coeff_mult_sum degree_prod_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> degree_sum_less<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> degree <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> degree <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> degree_add_less<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> degree_sum_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> degree <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> degree <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> infinite_finite_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> degree_add_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> degree_sum_le_Max<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">F</span> <span class="main">⟹</span> degree <span class="main">(</span>sum <span class="free">f</span> <span class="free">F</span><span class="main">)</span> <span class="main">≤</span> Max <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> degree <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">`</span><span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> degree_sum_le<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Max.coboundedI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> poly_as_sum_of_monoms'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">p</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> X<span class="main">^</span><span class="bound">i</span> <span class="main">*</span> C <span class="main">(</span>coeff <span class="free">p</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">{..</span><span class="free">n</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">i</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="keyword1">then</span> <span class="main">{</span><span class="bound">i</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> n
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_eq_iff coeff_sum coeff_eq_0 sum.If_cases eq coeff_pow_X
                  if_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">a</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> poly_as_sum_of_monoms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>degree <span class="free">p</span><span class="main">.</span> X<span class="main">^</span><span class="bound">i</span> <span class="main">*</span> C <span class="main">(</span>coeff <span class="free">p</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> poly_as_sum_of_monoms' order_refl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> degree_sum_unique'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> degree <span class="main">(</span><span class="free">p</span> <span class="bound">j</span><span class="main">)</span> <span class="main">&lt;</span> degree <span class="main">(</span><span class="free">p</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>insert <span class="free">i</span> <span class="free">I</span><span class="main">.</span> <span class="free">p</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> degree <span class="main">(</span><span class="free">p</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> I
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">I</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">j</span> <span class="skolem">I</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> insert_commute<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degree_add_eq_right<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> degree_sum_unique<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">I</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">≠</span> <span class="free">i</span> <span class="main">⟹</span> degree <span class="main">(</span><span class="free">p</span> <span class="bound">j</span><span class="main">)</span> <span class="main">&lt;</span> degree <span class="main">(</span><span class="free">p</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
    degree <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">p</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> degree <span class="main">(</span><span class="free">p</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> degree_sum_unique'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insert_absorb<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_sum_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>semiring_0 poly"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">≠</span> <span class="free">i</span> <span class="main">⟹</span> degree <span class="main">(</span><span class="free">p</span> <span class="bound">j</span><span class="main">)</span> <span class="main">&lt;</span> degree <span class="main">(</span><span class="free">p</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">p</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>degree <span class="main">(</span><span class="free">p</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> coeff <span class="main">(</span><span class="free">p</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>degree <span class="main">(</span><span class="free">p</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> coeff <span class="main">(</span><span class="free">p</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>degree <span class="main">(</span><span class="free">p</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> coeff <span class="main">(</span><span class="free">p</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>degree <span class="main">(</span><span class="free">p</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum.mono_neutral_cong_right<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> coeff_eq_0<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coeff_sum<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> diag_coeff<span class="main">:</span> <span class="quoted"><span class="quoted">"diag <span class="main">(</span>coeff <span class="free">x</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> map_sq_matrix <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> coeff <span class="bound">x</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>diag <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smult_one<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">1</span> <span class="main">=</span> diag <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_telescope_Ico<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="free">a</span> <span class="main">..&lt;</span> <span class="free">b</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">-</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">::</span><span class="main">_</span><span class="main">::</span>ab_group_add<span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">a</span> <span class="main">-</span> <span class="free">f</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">b</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dec_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> map_sq_matrix <span class="main">=</span> map_sq_matrix_diff map_sq_matrix_add map_sq_matrix_smult map_sq_matrix_sum

<span class="keyword1"><span class="command">lemma</span></span> sign_permut<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>of_int <span class="main">(</span>sign <span class="free">p</span><span class="main">)</span> <span class="main">*</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> degree <span class="free">q</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sign_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> degree_det<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="keyword1">permutes</span> UNIV <span class="main">⟹</span> <span class="bound">j</span> <span class="main">≠</span> id <span class="main">⟹</span> degree <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> to_fun <span class="free">A</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">j</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> degree <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> to_fun <span class="free">A</span> <span class="bound">i</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>det <span class="free">A</span><span class="main">)</span> <span class="main">=</span> degree <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> to_fun <span class="free">A</span> <span class="bound">i</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> det_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> degree_sum_unique<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">id</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sign_permut permutes_id assms<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_degree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>zero poly<span class="main">^^</span><span class="tfree">'n</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_degree</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> Max <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> degree <span class="main">(</span>to_fun <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> degree_le_max_degree<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>to_fun <span class="free">A</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">≤</span> max_degree <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> max_degree_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Max_ge_iff<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">charpoly</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> det <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>X</b></span> <span class="main">-</span> <span class="keyword1"><span class="hidden">❙</span><b>C</b></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> degree_diff_cancel<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="free">q</span> <span class="main">&lt;</span> degree <span class="free">p</span> <span class="main">⟹</span> degree <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="free">q</span><span class="main">::</span><span class="main">_</span><span class="main">::</span>ab_group_add poly<span class="main">)</span> <span class="main">=</span> degree <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_uminus_conv_diff degree_add_eq_left degree_minus<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>comm_ring_1<span class="main">^^</span><span class="tfree">'n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> degree_charpoly<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> coeff_charpoly<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span> <span class="main">(</span>degree <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"diag X <span class="main">-</span> map_sq_matrix C <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">∏</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> to_fun <span class="var">?B</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">p</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> of_int <span class="main">(</span>sign <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> <span class="var">?f</span> <span class="bound">p</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> dB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> degree <span class="main">(</span>to_fun <span class="var">?B</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> degree_diff_cancel<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> cB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> coeff <span class="main">(</span>to_fun <span class="var">?B</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> degree_f_id<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="var">?f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> coeff_mult_prod_sum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> to_fun <span class="var">?B</span> <span class="bound">i</span> <span class="bound">i</span>"</span></span> <span class="quoted">UNIV</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> antisym degree_prod_le<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span> le_degree<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dB cB<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> degree_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> id <span class="main">⟹</span> degree <span class="main">(</span><span class="var">?f</span> <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> degree <span class="main">(</span><span class="var">?f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> degree_f_id
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> le_less_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> degree_prod_le<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dB sum.If_cases set_eq_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> psubset_card_mono<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> degree_charpoly<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span> <span class="main">=</span> degree <span class="main">(</span><span class="var">?f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> degree_less <span class="keyword1"><span class="command">unfolding</span></span> charpoly_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> degree_det<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> degree_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> degree_charpoly degree_f_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">p</span></span> <span class="main">|</span> <span class="bound">p</span> <span class="keyword1">permutes</span> UNIV<span class="main">.</span> <span class="var">?g</span> <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>degree <span class="main">(</span><span class="var">?g</span> id<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> coeff_sum_unique<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span><span class="var">?g</span> id<span class="main">)</span> <span class="main">(</span>degree <span class="main">(</span><span class="var">?g</span> id<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> coeff_mult_prod_sum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> to_fun <span class="var">?B</span> <span class="bound">i</span> <span class="bound">i</span>"</span></span> <span class="quoted">UNIV</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dB cB sign_id degree_f_id<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degree_less sign_permut permutes_id<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span> <span class="main">(</span>degree <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> degree_charpoly <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sign_permut charpoly_def det_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">max_perm_degree</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> Max <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> degree <span class="main">(</span>to_fun <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">i</span> <span class="main">(</span><span class="bound">p</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">`</span><span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="keyword1">permutes</span> UNIV<span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> max_perm_degree_eqI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="keyword1">permutes</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>finite set<span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> degree <span class="main">(</span>to_fun <span class="free">A</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">p</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="keyword1">permutes</span> UNIV <span class="main">∧</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> degree <span class="main">(</span>to_fun <span class="free">A</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">p</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span>
    max_perm_degree <span class="free">A</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Max_eqI  <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_perm_degree_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> degree_prod_le_max_perm_degree<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="keyword1">permutes</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>finite set<span class="main">)</span> <span class="main">⟹</span> degree <span class="main">(</span><span class="main">∏</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> to_fun <span class="free">A</span> <span class="bound">i</span> <span class="main">(</span><span class="free">j</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> max_perm_degree <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> max_perm_degree_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> degree_prod_le<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> degree_le_max_perm_degree<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>det <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> max_perm_degree <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> det_eq
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> degree_sum_le_Max<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> degree_prod_le_max_perm_degree Max_le_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span> permutes_id <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sign_permut<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> max_degree_adjugate<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">^^</span><span class="tfree">'n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"max_degree <span class="main">(</span>adjugate <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>X</b></span> <span class="main">-</span> <span class="keyword1"><span class="hidden">❙</span><b>C</b></span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"minor <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>X</b></span> <span class="main">-</span> <span class="keyword1"><span class="hidden">❙</span><b>C</b></span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?D</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span> <span class="bound">k</span> <span class="bound">l</span><span class="main">.</span> degree <span class="main">(</span>to_fun <span class="main">(</span><span class="var">?M</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">k</span> <span class="bound">l</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span> <span class="bound">k</span> <span class="bound">l</span><span class="main">.</span> to_fun <span class="main">(</span><span class="var">?M</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">k</span> <span class="bound">l</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">k</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">l</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="main">1</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">=</span> <span class="bound">i</span> <span class="main">∨</span> <span class="bound">l</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="main">0</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">=</span> <span class="bound">l</span> <span class="keyword1">then</span> <span class="main">[:</span> <span class="main">-</span> to_fun <span class="free">A</span> <span class="bound">k</span> <span class="bound">l</span><span class="main">,</span> <span class="main">1</span> <span class="main">:]</span> <span class="keyword1">else</span> <span class="main">[:</span> <span class="main">-</span> to_fun <span class="free">A</span> <span class="bound">k</span> <span class="bound">l</span> <span class="main">:]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_eq_iff C_def X_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> Max <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> degree <span class="main">(</span>det <span class="main">(</span><span class="var">?M</span> <span class="bound">j</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> Max <span class="var">?Max</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> max_degree_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transpose.rep_eq cofactor_def adjugate_def of_fun_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Max <span class="var">?Max</span> <span class="main">≤</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Max.boundedI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"max_perm_degree <span class="main">(</span><span class="var">?M</span> <span class="skolem">j</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> max_perm_degree_eqI<span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M sum.If_cases if_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">degree</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> card_Diff_insert
                 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> card_mono permutes_id arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">card</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>det <span class="main">(</span><span class="var">?M</span> <span class="skolem">j</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> degree_le_max_perm_degree<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="skolem">j</span> <span class="skolem">i</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'n</span></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted">True</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span> <span class="bound">k</span> <span class="bound">p</span><span class="main">.</span> <span class="main">∏</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> to_fun <span class="main">(</span><span class="var">?M</span> <span class="bound">j</span> <span class="bound">k</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">p</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span>det <span class="main">(</span><span class="var">?M</span> <span class="skolem">x</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> degree_det<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="var">?D</span> <span class="skolem">x</span> <span class="skolem">x</span> <span class="bound">i</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M if_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"degree"</span></span><span class="main"><span class="main">]</span></span> sum.If_cases Collect_neg_eq Compl_eq_Diff_UNIV<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> degree <span class="main">(</span><span class="var">?P</span> <span class="skolem">x</span> <span class="skolem">x</span> id<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> antisym degree_prod_le le_degree <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coeff_mult_prod_sum<span class="main">)</span>
           <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M if_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> coeff <span class="bound">x</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">b</span><span class="main"><span class="main">]</span></span> prod.If_cases<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="var">?P</span> <span class="skolem">x</span> <span class="skolem">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'n</span>"</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">permutes</span> UNIV"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> id"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> ij<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">p</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="skolem">p</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> id_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> permutes_univ<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="skolem">i</span><span class="main">,</span><span class="skolem">j</span><span class="main">}</span> <span class="main">≤</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="var">?P</span> <span class="skolem">x</span> <span class="skolem">x</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> degree_prod_le
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M if_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"degree"</span></span><span class="main"><span class="main">]</span></span> sum.If_cases Collect_neg_eq Compl_eq_Diff_UNIV p <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> card_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹card <span class="main">{</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">}</span> <span class="main">≤</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span>›</span></span> ij <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"degree <span class="main">(</span><span class="var">?P</span> <span class="skolem">x</span> <span class="skolem">x</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">&lt;</span> degree <span class="main">(</span><span class="var">?P</span> <span class="skolem">x</span> <span class="skolem">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> Max <span class="var">?Max</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Max_ge_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">poly_mat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ring_1 poly <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'n</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">^^</span><span class="tfree">'n</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">poly_mat</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span>degree <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">.</span> coeff <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">i</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">^</span><span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zero_smult<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">M</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>semiring_1<span class="main">^^</span><span class="tfree">'n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> smult_smult<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">b</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">M</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>monoid_mult<span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_sq_matrix_mult_eq_smult<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_sq_matrix <span class="main">(</span><span class="main">(*)</span> <span class="free">a</span><span class="main">)</span> <span class="free">M</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">rule</span>

<span class="keyword1"><span class="command">lemma</span></span> coeff_smult_1<span class="main">:</span> <span class="quoted"><span class="quoted">"coeff <span class="free">p</span> <span class="free">i</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">m</span> <span class="main">=</span> <span class="free">m</span> <span class="main">*</span> map_sq_matrix <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> coeff <span class="bound">p</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">1</span><span class="main">::</span><span class="main">_</span><span class="main">::</span>comm_ring_1 <span class="main">^^</span> <span class="tfree">'n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> smult_one mult_diag<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_sq_matrix_if_distrib<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_sq_matrix <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">P</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="keyword1">then</span> map_sq_matrix <span class="free">f</span> <span class="keyword1">else</span> map_sq_matrix <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">theorem</span></span> Cayley_Hamilton<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>comm_ring_1 <span class="main">^^</span> <span class="tfree">'n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"poly_mat <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
<span class="keyword1"><span class="command">text</span></span> <span class="main">%</span>visible <span class="quoted"><span class="plain_text">‹\hrulefill ~~ Part 1 ~~ \hrulefill›</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="keyword1">CARD</span><span class="main">(</span><span class="tfree">'n</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> d_charpoly<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> degree <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
      d_adj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> max_degree <span class="main">(</span>adjugate <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>X</b></span> <span class="main">-</span> <span class="keyword1"><span class="hidden">❙</span><b>C</b></span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">%</span>invisible <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> degree_charpoly n_def max_degree_adjugate monom_0 diag_1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="skolem">i</span> <span class="main">=</span> map_sq_matrix <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> coeff <span class="bound">p</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>adjugate <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>X</b></span> <span class="main">-</span> <span class="keyword1"><span class="hidden">❙</span><b>C</b></span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">have</span></span> A_eq_B<span class="main">:</span> <span class="quoted"><span class="quoted">"adjugate <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>X</b></span> <span class="main">-</span> <span class="keyword1"><span class="hidden">❙</span><b>C</b></span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> X<span class="main">^</span><span class="bound">i</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="keyword1"><span class="hidden">❙</span><b>C</b></span> <span class="main">(</span><span class="skolem">B</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">%</span>invisible <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_sq_matrix_smult sum_map_sq_matrix B_def d_adj
                        degree_le_max_degree poly_as_sum_of_monoms' <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> map_sq_matrix_cong<span class="main">)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="main">%</span>visible <span class="quoted"><span class="plain_text">‹\hrulefill ~~ Part 2 ~~ \hrulefill›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"charpoly <span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">1</span> <span class="main">=</span> X <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> adjugate <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>X</b></span> <span class="main">-</span> <span class="keyword1"><span class="hidden">❙</span><b>C</b></span> <span class="free">A</span><span class="main">)</span> <span class="main">-</span> <span class="keyword1"><span class="hidden">❙</span><b>C</b></span> <span class="free">A</span> <span class="main">*</span> adjugate <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>X</b></span> <span class="main">-</span> <span class="keyword1"><span class="hidden">❙</span><b>C</b></span> <span class="free">A</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">%</span>invisible <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> smult_one charpoly_def mult_adjugate_det<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> diag_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> X<span class="main">^</span><span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="keyword1"><span class="hidden">❙</span><b>C</b></span> <span class="main">(</span><span class="skolem">B</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> X<span class="main">^</span><span class="bound">i</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="keyword1"><span class="hidden">❙</span><b>C</b></span> <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="skolem">B</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="main">%</span>invisible A_eq_B <span class="keyword1"><span class="command">by</span></span> <span class="main">%</span>invisible <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left smult_mult2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
      map_sq_matrix_mult<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> C_linear smult_sum<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> smult_smult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> X<span class="main">^</span><span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="keyword1"><span class="hidden">❙</span><b>C</b></span> <span class="main">(</span><span class="skolem">B</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> X<span class="main">^</span><span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="keyword1"><span class="hidden">❙</span><b>C</b></span> <span class="main">(</span><span class="skolem">B</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> X<span class="main">^</span><span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="keyword1"><span class="hidden">❙</span><b>C</b></span> <span class="main">(</span><span class="skolem">B</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">%</span>invisible <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lessThan_Suc_atMost<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> X<span class="main">^</span><span class="bound">i</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="keyword1"><span class="hidden">❙</span><b>C</b></span> <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="skolem">B</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> X<span class="main">^</span><span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="keyword1"><span class="hidden">❙</span><b>C</b></span> <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="skolem">B</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="keyword1"><span class="hidden">❙</span><b>C</b></span> <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="skolem">B</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="main">%</span>invisible lessThan_Suc_atMost<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> lessThan_Suc_eq_insert_0
    <span class="keyword1"><span class="command">by</span></span> <span class="main">%</span>invisible <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_notin_Suc_image monom_0 sum.reindex one_poly_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> diag_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> diag_charpoly<span class="main">:</span>
    <span class="quoted"><span class="quoted">"charpoly <span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="main">1</span> <span class="main">=</span> X<span class="main">^</span><span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="keyword1"><span class="hidden">❙</span><b>C</b></span> <span class="main">(</span><span class="skolem">B</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">+</span>
      <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> X<span class="main">^</span><span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="keyword1"><span class="hidden">❙</span><b>C</b></span> <span class="main">(</span><span class="skolem">B</span> <span class="bound">i</span> <span class="main">-</span> <span class="free">A</span> <span class="main">*</span> <span class="skolem">B</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="keyword1"><span class="hidden">❙</span><b>C</b></span> <span class="main">(</span><span class="free">A</span> <span class="main">*</span> <span class="skolem">B</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">%</span>invisible <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_sq_matrix_diff C_linear sum_subtractf smult_diff<span class="main">)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="main">%</span>visible <span class="quoted"><span class="plain_text">‹\hrulefill ~~ Part 3 ~~ \hrulefill›</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> coeff <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span> <span class="bound">i</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>S</sub></span> <span class="free">A</span><span class="main">^</span><span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?AB</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">A</span><span class="main">^</span><span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">B</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">≤</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">.</span> <span class="var">?p</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="var">?p</span> <span class="main">0</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="var">?p</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="var">?p</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="main">%</span>invisible sum.atMost_Suc_shift Suc_eq_plus1<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">%</span>invisible <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lessThan_Suc_atMost<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">0</span> <span class="main">=</span> <span class="main">-</span> <span class="var">?AB</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">%</span>invisible <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coeff_smult_1 diag_charpoly map_sq_matrix<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="var">?p</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="var">?AB</span> <span class="bound">i</span> <span class="main">-</span> <span class="var">?AB</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">%</span>invisible <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> coeff_smult_1 coeff_pow_X diag_charpoly map_sq_matrix sum_subtractf
                     if_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">a</span><span class="main"><span class="main">]</span></span> if_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">a</span><span class="main"><span class="main">]</span></span>
                     <span class="dynamic"><span class="dynamic">field_simps</span></span> sum.If_cases power_Suc2
               <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> power_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?AB</span> <span class="main">0</span> <span class="main">-</span> <span class="var">?AB</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="main">%</span>invisible Suc_eq_plus1<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">%</span>invisible <span class="main">(</span><span class="operator">subst</span> sum_telescope_Ico<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?AB</span> <span class="skolem">n</span> <span class="main">=</span> <span class="var">?p</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="main">%</span>invisible coeff_smult_1 diag_charpoly
    <span class="keyword1"><span class="command">by</span></span> <span class="main">%</span>invisible <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_diag map_sq_matrix coeff_pow_X<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coeff <span class="main">(</span>charpoly <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">%</span>invisible <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> coeff_charpoly d_charpoly<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">%</span>invisible <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> poly_mat_def d_charpoly<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span> diag_0_eq mult_diag<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*&lt;*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div>