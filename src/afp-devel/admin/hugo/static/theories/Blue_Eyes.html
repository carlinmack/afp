<div id="Blue_Eyes">
<div class="head">
<h1>Theory Blue_Eyes</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Blue_Eyes
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Introduction›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The original problem statement <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> xkcd<span class="antiquote"><span class="antiquote">}</span></span></span></span> explains the puzzle well:

\begin{quotation}
A group of people with assorted eye colors live on an island.
They are all perfect logicians -- if a conclusion can be logically deduced,
they will do it instantly.
No one knows the color of their eyes.
Every night at midnight, a ferry stops at the island.
Any islanders who have figured out the color of their own eyes then leave the island, and the rest stay.
Everyone can see everyone else at all times
and keeps a count of the number of people they see with each eye color (excluding themselves),
but they cannot otherwise communicate.
Everyone on the island knows all the rules in this paragraph.

On this island there are 100 blue-eyed people,
100 brown-eyed people,
and the Guru (she happens to have green eyes).
So any given blue-eyed person can see 100 people with brown eyes and 99 people with blue eyes (and one with green),
but that does not tell him his own eye color;
as far as he knows the totals could be 101 brown and 99 blue.
Or 100 brown, 99 blue, and he could have red eyes.

The Guru is allowed to speak once (let's say at noon),
on one day in all their endless years on the island.
Standing before the islanders, she says the following:

``I can see someone who has blue eyes.''

Who leaves the island, and on what night?
\end{quotation}

It might seem weird that the Guru's declaration gives anyone any new information.
For an informal discussion, see \cite[Section~1.1]{fagin1995}.›</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Modeling the world \label{sec:world}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We begin by fixing two type variables: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'color</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'person</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
The puzzle doesn't specify how many eye colors are possible, but four are mentioned.
Crucially, we must assume they are distinct. We specify the existence of colors other
than blue and brown, even though we don't mention them later, because when blue and brown
are the only possible colors, the puzzle has a different solution — the brown-eyed logicians
may leave one day after the blue-eyed ones.

We refrain from specifying the exact population of the island, choosing to only assume
it is finite and denote a specific person as the Guru.

We could also model the Guru as an outside entity instead of a participant. This doesn't change
the answer and results in a slightly simpler proof, but is less faithful to the problem statement.›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">blue</span> <span class="free">brown</span> <span class="free">green</span> <span class="free">red</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'color</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> colors_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">[</span><span class="free">blue</span><span class="main">,</span> <span class="free">brown</span><span class="main">,</span> <span class="free">green</span><span class="main">,</span> <span class="free">red</span><span class="main">]</span>"</span></span>

  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">guru</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'person</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> <span class="tfree">'person</span> set<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹It's slightly tricky to formalize the behavior of perfect logicians.
The representation we use is centered around the type of a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">emph</span></span> ‹world›<span class="antiquote"><span class="antiquote">}</span></span></span></span>,
which describes the entire state of the environment. In our case, it's a function
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'person</span></span> <span class="main"><span class="main">=&gt;</span></span> <span class="tfree"><span class="tfree">'color</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that assigns an eye color to everyone.<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">footnote</span></span> ‹We would introduce
a type synonym, but at the time of writing Isabelle doesn't support including type variables fixed
by a locale in a type synonym.›<span class="antiquote"><span class="antiquote">}</span></span></span></span>

The only condition known to everyone and not dependent on the observer is Guru's declaration:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">valid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'person</span> <span class="main">⇒</span> <span class="tfree">'color</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≠</span> <span class="free">guru</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">p</span> <span class="main">=</span> <span class="free">blue</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We then define the function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">possible</span></span> <span class="free"><span class="free">n</span></span> <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">w</span></span> <span class="free"><span class="free">w'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which returns <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">True</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
if on day <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span> the potential world <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>w'›</span></span></span></span> is plausible from the perspective of person <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span>,
based on the observations they made in the actual world <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>w›</span></span></span></span>.

Then, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">leaves</span></span> <span class="free"><span class="free">n</span></span> <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">w</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">True</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> is able to unambiguously deduce
the color of their own eyes, i.e. if it is the same in all possible worlds. Note that if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> actually
left many moons ago, this function still returns <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">True</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">leaves</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'person</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'person</span> <span class="main">⇒</span> <span class="tfree">'color</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">possible</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'person</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'person</span> <span class="main">⇒</span> <span class="tfree">'color</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'person</span> <span class="main">⇒</span> <span class="tfree">'color</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">leaves</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">w'</span><span class="main">.</span> <span class="free">possible</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">w'</span> <span class="main">⟶</span> <span class="bound">w'</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
    <span class="quoted"><span class="quoted">"<span class="free">possible</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">w'</span></span></span> <span class="main">⟷</span> valid <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">∧</span> valid <span class="free"><span class="bound"><span class="entity">w'</span></span></span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">p'</span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">p'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">w'</span></span></span> <span class="bound">p'</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n'</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">p'</span><span class="main">.</span> <span class="free">leaves</span> <span class="bound">n'</span> <span class="bound">p'</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="free">leaves</span> <span class="bound">n'</span> <span class="bound">p'</span> <span class="free"><span class="bound"><span class="entity">w'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Naturally, the act of someone leaving can be observed by others, thus the two definitions
are mutually recursive. As such, we need to instruct the simplifier to not unfold these definitions endlessly.›</span></span>
<span class="keyword1"><span class="command">declare</span></span> possible.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span> leaves.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A world is possible if
  <span class="antiquoted"><span class="antiquoted">▸</span></span> The Guru's declaration holds.
  <span class="antiquoted"><span class="antiquoted">▸</span></span> The eye color of everyone but the observer matches.
  <span class="antiquoted"><span class="antiquoted">▸</span></span> The same people left on each of the previous days.

Moreover, we require that the actual world <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>w›</span></span></span></span> is <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>valid›</span></span></span></span>, so that the relation is symmetric:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> possible_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"possible <span class="free">n</span> <span class="free">p</span> <span class="free">w</span> <span class="free">w'</span> <span class="main">=</span> possible <span class="free">n</span> <span class="free">p</span> <span class="free">w'</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> possible.simps<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In fact, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>possible n p›</span></span></span></span> is an equivalence relation:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> possible_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="free">w</span> <span class="main">⟹</span> possible <span class="free">n</span> <span class="free">p</span> <span class="free">w</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> possible.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> possible_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"possible <span class="free">n</span> <span class="free">p</span> <span class="free">w1</span> <span class="free">w2</span> <span class="main">⟹</span> possible <span class="free">n</span> <span class="free">p</span> <span class="free">w2</span> <span class="free">w3</span> <span class="main">⟹</span> possible <span class="free">n</span> <span class="free">p</span> <span class="free">w1</span> <span class="free">w3</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> possible.simps<span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Eye colors other than blue›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Since there is no way to distinguish between the colors other than blue,
only the blue-eyed people will ever leave. To formalize this notion, we define
a function that takes a world and replaces the eye color of a specified person.
The original color is specified too, so that the transformation composes nicely
with the recursive hypothetical worlds of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> possible<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">try_swap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'person</span> <span class="main">⇒</span> <span class="tfree">'color</span> <span class="main">⇒</span> <span class="tfree">'color</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'person</span> <span class="main">⇒</span> <span class="tfree">'color</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'person</span> <span class="main">⇒</span> <span class="tfree">'color</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">try_swap</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> <span class="free">blue</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">=</span> <span class="free">blue</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> Fun.swap <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> id <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> try_swap_valid<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="main">(</span>try_swap <span class="free">p</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> valid <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> try_swap_def valid_def swap_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> try_swap_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"try_swap <span class="free">p</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span> <span class="free">x</span> <span class="main">=</span> try_swap <span class="free">p</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w'</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">w</span> <span class="free">x</span> <span class="main">=</span> <span class="free">w'</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> try_swap_def swap_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> try_swap_inv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"try_swap <span class="free">p</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>try_swap <span class="free">p</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> try_swap_def swap_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> leaves_try_swap<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"leaves <span class="free">n</span> <span class="free">p</span> <span class="main">(</span>try_swap <span class="free">p'</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> leaves <span class="free">n</span> <span class="free">p</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"leaves <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">w</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"leaves <span class="skolem">n</span> <span class="skolem">p</span> <span class="main">(</span>try_swap <span class="free">p'</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">w</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> leaves.simps<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"possible <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">w</span> <span class="skolem">w'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"possible <span class="skolem">n</span> <span class="skolem">p</span> <span class="main">(</span>try_swap <span class="free">p'</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">w</span><span class="main">)</span> <span class="main">(</span>try_swap <span class="free">p'</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">w'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> possible.simps less.IH<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">`leaves <span class="skolem">n</span> <span class="skolem">p</span> <span class="main">(</span>try_swap <span class="free">p'</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">w</span><span class="main">)</span>`</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"try_swap <span class="free">p'</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">w'</span> <span class="skolem">p</span> <span class="main">=</span> try_swap <span class="free">p'</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">w</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> leaves.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">w</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">with</span></span> try_swap_inv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This lets us prove that only blue-eyed people will ever leave the island.›</span></span>

<span class="keyword1"><span class="command">proposition</span></span> only_blue_eyes_leave<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"leaves <span class="free">n</span> <span class="free">p</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"valid <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="free">p</span> <span class="main">=</span> <span class="free">blue</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="free">p</span> <span class="main">≠</span> <span class="free">blue</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="free">p</span> <span class="main">≠</span> <span class="skolem">c</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> <span class="free">blue</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> colors_distinct
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinct_length_2_or_more<span class="main">)</span> 

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?w'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"try_swap <span class="free">p</span> <span class="main">(</span><span class="free">w</span> <span class="free">p</span><span class="main">)</span> <span class="skolem">c</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"possible <span class="free">n</span> <span class="free">p</span> <span class="free">w</span> <span class="var">?w'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">`valid <span class="free">w</span>`</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> try_swap_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?w'</span> <span class="free">p</span> <span class="main">≠</span> <span class="free">w</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c <span class="quoted"><span class="quoted">`<span class="free">w</span> <span class="free">p</span> <span class="main">≠</span> <span class="free">blue</span>`</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> try_swap_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leaves <span class="free">n</span> <span class="free">p</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> leaves.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"The blue-eyed logicians"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We will now consider the behavior of the logicians with blue eyes. First,
some simple lemmas. Reasoning about set cardinalities often requires considering infinite
sets separately. Usefully, all sets of people are finite by assumption.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> people_finite<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">S</span><span class="main">::</span><span class="tfree">'person</span> set<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'person</span> set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Secondly, we prove a destruction rule for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> possible<span class="antiquote"><span class="antiquote">}</span></span></span></span>. It is strictly weaker than
the definition, but thanks to the simpler form, it's easier to guide the automation with it.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> possibleD_colors<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"possible <span class="free">n</span> <span class="free">p</span> <span class="free">w</span> <span class="free">w'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">≠</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w'</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">w</span> <span class="free">p'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> possible.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A central concept in the reasoning is the set of blue-eyed people someone can see.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">blues_seen</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'person</span> <span class="main">⇒</span> <span class="tfree">'color</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'person</span> <span class="main">⇒</span> <span class="tfree">'person</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">blues_seen</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">p'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">p'</span> <span class="main">=</span> <span class="free">blue</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> blues_seen_others<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">blue</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="free">p'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="free">p</span> <span class="main">=</span> <span class="free">blue</span> <span class="main">⟹</span> card <span class="main">(</span>blues_seen <span class="free">w</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>blues_seen <span class="free">w</span> <span class="free">p'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="free">p</span> <span class="main">≠</span> <span class="free">blue</span> <span class="main">⟹</span> card <span class="main">(</span>blues_seen <span class="free">w</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>card <span class="main">(</span>blues_seen <span class="free">w</span> <span class="free">p'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="free">p</span> <span class="main">=</span> <span class="free">blue</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"blues_seen <span class="free">w</span> <span class="free">p'</span> <span class="main">=</span> blues_seen <span class="free">w</span> <span class="free">p</span> <span class="main">∪</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">p'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blues_seen_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">∉</span> blues_seen <span class="free">w</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> blues_seen_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">∈</span> blues_seen <span class="free">w</span> <span class="free">p</span> <span class="main">∪</span> <span class="main">{</span><span class="free">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> blues_seen_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">`<span class="free">p</span> <span class="main">≠</span> <span class="free">p'</span>`</span></span> <span class="quoted"><span class="quoted">`<span class="free">w</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">blue</span>`</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>blues_seen <span class="free">w</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>blues_seen <span class="free">w</span> <span class="free">p'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="free">p</span> <span class="main">≠</span> <span class="free">blue</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"blues_seen <span class="free">w</span> <span class="free">p'</span> <span class="main">=</span> blues_seen <span class="free">w</span> <span class="free">p</span> <span class="main">-</span> <span class="main">{</span><span class="free">p'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> blues_seen_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">∈</span> blues_seen <span class="free">w</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> blues_seen_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">`<span class="free">p</span> <span class="main">≠</span> <span class="free">p'</span>`</span></span> <span class="quoted"><span class="quoted">`<span class="free">w</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">blue</span>`</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>blues_seen <span class="free">w</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>card <span class="main">(</span>blues_seen <span class="free">w</span> <span class="free">p'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> card_Suc_Diff1 people_finite<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> blues_seen_same<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"possible <span class="free">n</span> <span class="free">p</span> <span class="free">w</span> <span class="free">w'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"blues_seen <span class="free">w'</span> <span class="free">p</span> <span class="main">=</span> blues_seen <span class="free">w</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> blues_seen_def possible.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> possible_blues_seen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"possible <span class="free">n</span> <span class="free">p</span> <span class="free">w</span> <span class="free">w'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="free">p'</span> <span class="main">=</span> <span class="free">blue</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="free">p'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w'</span> <span class="free">p</span> <span class="main">=</span> <span class="free">blue</span> <span class="main">⟹</span> card <span class="main">(</span>blues_seen <span class="free">w</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>blues_seen <span class="free">w'</span> <span class="free">p'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">w'</span> <span class="free">p</span> <span class="main">≠</span> <span class="free">blue</span> <span class="main">⟹</span> card <span class="main">(</span>blues_seen <span class="free">w</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>card <span class="main">(</span>blues_seen <span class="free">w'</span> <span class="free">p'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> possibleD_colors<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">`possible <span class="free">n</span> <span class="free">p</span> <span class="free">w</span> <span class="free">w'</span>`</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> blues_seen_others assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> blues_seen_same<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally, the crux of the solution. We proceed by strong induction.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> blue_leaves<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="free">p</span> <span class="main">=</span> <span class="free">blue</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"valid <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> guru<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="free">guru</span> <span class="main">≠</span> <span class="free">blue</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"leaves <span class="free">n</span> <span class="free">p</span> <span class="free">w</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">≥</span> card <span class="main">(</span>blues_seen <span class="free">w</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="comment1">― ‹First, we show that day <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>n›</span></span> is sufficient to deduce that the eyes are blue.›</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> card <span class="main">(</span>blues_seen <span class="skolem">w</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="skolem">p</span> <span class="main">=</span> <span class="free">blue</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"possible <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">w</span> <span class="skolem">w'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">w'</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>blues_seen <span class="skolem">w'</span> <span class="skolem">p</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">`possible <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">w</span> <span class="skolem">w'</span>`</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid <span class="skolem">w'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> possible.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="skolem">p</span> <span class="main">=</span> <span class="free">blue</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> valid_def blues_seen_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
      <span class="comment1">― ‹We consider the behavior of somebody else, who also has blue eyes.›</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"blues_seen <span class="skolem">w'</span> <span class="skolem">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="free">blue</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">p'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> blues_seen_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="free">blue</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> possibleD_colors<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">`possible <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">w</span> <span class="skolem">w'</span>`</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="free">guru</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">`<span class="skolem">w</span> <span class="skolem">p</span> <span class="main">=</span> <span class="free">blue</span>`</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">`<span class="skolem">w</span> <span class="free">guru</span> <span class="main">≠</span> <span class="free">blue</span>`</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="free">guru</span> <span class="main">≠</span> <span class="free">blue</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">`<span class="skolem">w</span> <span class="free">guru</span> <span class="main">≠</span> <span class="free">blue</span>`</span></span> <span class="keyword2"><span class="keyword">and</span></span> possibleD_colors<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">`possible <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">w</span> <span class="skolem">w'</span>`</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid <span class="skolem">w'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">`possible <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">w</span> <span class="skolem">w'</span>`</span></span> <span class="keyword1"><span class="command">unfolding</span></span> possible.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="skolem">p</span> <span class="main">=</span> <span class="free">blue</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="skolem">p</span> <span class="main">≠</span> <span class="free">blue</span>"</span></span>
        <span class="comment1">― ‹If our eyes weren't blue, then <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>p'›</span></span> would see one blue-eyed person less than us.›</span>
        <span class="keyword1"><span class="command">with</span></span> possible_blues_seen<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted">`possible <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">w'</span></span>`</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">`<span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">blue</span></span>`</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">`<span class="skolem"><span class="skolem">p</span></span> <span class="main"><span class="main">≠</span></span> <span class="skolem"><span class="skolem">p'</span></span>`</span></span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>blues_seen <span class="skolem">w</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>card <span class="main">(</span>blues_seen <span class="skolem">w'</span> <span class="skolem">p'</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="comment1">― ‹By induction, they would've left on day <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>k = blues_seen w' p'›</span></span>.›</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>blues_seen <span class="skolem">w'</span> <span class="skolem">p'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">`<span class="skolem">n</span> <span class="main">≥</span> card <span class="main">(</span>blues_seen <span class="skolem">w</span> <span class="skolem">p</span><span class="main">)</span>`</span></span> <span class="keyword2"><span class="keyword">and</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"leaves <span class="var">?k</span> <span class="skolem">p'</span> <span class="skolem">w'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">`valid <span class="skolem">w'</span>`</span></span> <span class="quoted"><span class="quoted">`<span class="skolem">w'</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="free">blue</span>`</span></span> <span class="quoted"><span class="quoted">`<span class="skolem">w'</span> <span class="free">guru</span> <span class="main">≠</span> <span class="free">blue</span>`</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> less.IH<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="comment1">― ‹However, we know that actually, <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>p'›</span></span> didn't leave that day yet.›</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leaves <span class="var">?k</span> <span class="skolem">p'</span> <span class="skolem">w</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"leaves <span class="var">?k</span> <span class="skolem">p'</span> <span class="skolem">w</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">≥</span> card <span class="main">(</span>blues_seen <span class="skolem">w</span> <span class="skolem">p'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">`<span class="var">?k</span> <span class="main">&lt;</span> <span class="skolem">n</span>`</span></span> <span class="quoted"><span class="quoted">`<span class="skolem">w</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="free">blue</span>`</span></span> <span class="quoted"><span class="quoted">`valid <span class="skolem">w</span>`</span></span> <span class="quoted"><span class="quoted">`<span class="skolem">w</span> <span class="free">guru</span> <span class="main">≠</span> <span class="free">blue</span>`</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> less.IH<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>blues_seen <span class="skolem">w</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>blues_seen <span class="skolem">w</span> <span class="skolem">p'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> blues_seen_others<span class="main"><span class="keyword3">;</span></span> <span class="operator">fact</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">&lt;</span> card <span class="main">(</span>blues_seen <span class="skolem">w</span> <span class="skolem">p'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">`<span class="var">?k</span> <span class="main">≥</span> card <span class="main">(</span>blues_seen <span class="skolem">w</span> <span class="skolem">p'</span><span class="main">)</span>`</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"leaves <span class="var">?k</span> <span class="skolem">p'</span> <span class="skolem">w'</span> <span class="main">=</span> leaves <span class="var">?k</span> <span class="skolem">p'</span> <span class="skolem">w</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">`possible <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">w</span> <span class="skolem">w'</span>`</span></span> <span class="quoted"><span class="quoted">`<span class="var">?k</span> <span class="main">&lt;</span> <span class="skolem">n</span>`</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> possible.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"leaves <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">w</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> leaves.simps <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">`<span class="skolem">w</span> <span class="skolem">p</span> <span class="main">=</span> <span class="free">blue</span>`</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="comment1">― ‹Then, we show that it's not possible to deduce the eye color any earlier.›</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> card <span class="main">(</span>blues_seen <span class="skolem">w</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="comment1">― ‹Consider a hypothetical world where <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>p›</span></span> has brown eyes instead. We will prove that this
        world is <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>possible›</span></span>.›</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?w'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> <span class="free">brown</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?w'</span> <span class="free">guru</span> <span class="main">≠</span> <span class="free">blue</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">`<span class="skolem">w</span> <span class="free">guru</span> <span class="main">≠</span> <span class="free">blue</span>`</span></span> <span class="quoted"><span class="quoted">`<span class="skolem">w</span> <span class="skolem">p</span> <span class="main">=</span> <span class="free">blue</span>`</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid <span class="var">?w'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">`<span class="skolem">n</span> <span class="main">&lt;</span> card <span class="main">(</span>blues_seen <span class="skolem">w</span> <span class="skolem">p</span><span class="main">)</span>`</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>blues_seen <span class="skolem">w</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"blues_seen <span class="skolem">w</span> <span class="skolem">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> blues_seen <span class="skolem">w</span> <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">p'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="free">blue</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> blues_seen_def<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?w'</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="free">blue</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">`<span class="var">?w'</span> <span class="free">guru</span> <span class="main">≠</span> <span class="free">blue</span>`</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"valid <span class="var">?w'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> valid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"leaves <span class="skolem">n'</span> <span class="skolem">p'</span> <span class="skolem">w</span> <span class="main">=</span> leaves <span class="skolem">n'</span> <span class="skolem">p'</span> <span class="var">?w'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n'</span> <span class="skolem">p'</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> not_leavesI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>leaves <span class="skolem">n'</span> <span class="skolem">p'</span> <span class="skolem">w'</span>"</span></span>
          <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"valid <span class="skolem">w'</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="free">guru</span> <span class="main">≠</span> <span class="free">blue</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="free">blue</span> <span class="main">⟹</span> <span class="skolem">n'</span> <span class="main">&lt;</span> card <span class="main">(</span>blues_seen <span class="skolem">w'</span> <span class="skolem">p'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">w'</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="free">blue</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"leaves <span class="skolem">n'</span> <span class="skolem">p'</span> <span class="skolem">w'</span> <span class="main">⟷</span> <span class="skolem">n'</span> <span class="main">≥</span> card <span class="main">(</span>blues_seen <span class="skolem">w'</span> <span class="skolem">p'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> less.IH <span class="quoted"><span class="quoted">`<span class="skolem">n'</span> <span class="main">&lt;</span> <span class="skolem">n</span>`</span></span> <span class="quoted"><span class="quoted">`valid <span class="skolem">w'</span>`</span></span> <span class="quoted"><span class="quoted">`<span class="skolem">w'</span> <span class="free">guru</span> <span class="main">≠</span> <span class="free">blue</span>`</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> P<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">`<span class="skolem">w'</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="free">blue</span>`</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>leaves <span class="skolem">n'</span> <span class="skolem">p'</span> <span class="skolem">w'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leaves <span class="skolem">n'</span> <span class="skolem">p'</span> <span class="skolem">w'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> only_blue_eyes_leave <span class="quoted"><span class="quoted">`valid <span class="skolem">w'</span>`</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>leaves <span class="skolem">n'</span> <span class="skolem">p'</span> <span class="skolem">w</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> not_leavesI<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="free">blue</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">`<span class="skolem">w</span> <span class="skolem">p</span> <span class="main">=</span> <span class="free">blue</span>`</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>blues_seen <span class="skolem">w</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>blues_seen <span class="skolem">w</span> <span class="skolem">p'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">p'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> blues_seen_others<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">`<span class="skolem">n'</span> <span class="main">&lt;</span> <span class="skolem">n</span>`</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">`<span class="skolem">n</span> <span class="main">&lt;</span> card <span class="main">(</span>blues_seen <span class="skolem">w</span> <span class="skolem">p</span><span class="main">)</span>`</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">&lt;</span> card <span class="main">(</span>blues_seen <span class="skolem">w</span> <span class="skolem">p'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>

        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leaves <span class="skolem">n'</span> <span class="skolem">p'</span> <span class="var">?w'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> not_leavesI<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?w'</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="free">blue</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> colors_distinct <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≠</span> <span class="skolem">p'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?w'</span> <span class="skolem">p</span> <span class="main">≠</span> <span class="free">blue</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>blues_seen <span class="var">?w'</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>card <span class="main">(</span>blues_seen <span class="var">?w'</span> <span class="skolem">p'</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">`<span class="var">?w'</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="free">blue</span>`</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> blues_seen_others<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"blues_seen <span class="skolem">w</span> <span class="skolem">p</span> <span class="main">=</span> blues_seen <span class="var">?w'</span> <span class="skolem">p</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> blues_seen_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">&lt;</span> card <span class="main">(</span>blues_seen <span class="var">?w'</span> <span class="skolem">p'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">`<span class="skolem">n'</span> <span class="main">&lt;</span> <span class="skolem">n</span>`</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">`<span class="skolem">n</span> <span class="main">&lt;</span> card <span class="main">(</span>blues_seen <span class="skolem">w</span> <span class="skolem">p</span><span class="main">)</span>`</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>

        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"leaves <span class="skolem">n'</span> <span class="skolem">p'</span> <span class="skolem">w</span> <span class="main">=</span> leaves <span class="skolem">n'</span> <span class="skolem">p'</span> <span class="var">?w'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"possible <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">w</span> <span class="var">?w'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">`valid <span class="skolem">w</span>`</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> possible.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?w'</span> <span class="skolem">p</span> <span class="main">≠</span> <span class="free">blue</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> colors_distinct <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> leaves <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">w</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> leaves.simps
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">`<span class="skolem">w</span> <span class="skolem">p</span> <span class="main">=</span> <span class="free">blue</span>`</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"leaves <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">w</span> <span class="main">⟹</span> <span class="skolem">n</span> <span class="main">≥</span> card <span class="main">(</span>blues_seen <span class="skolem">w</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This can be combined into a theorem that describes the behavior of the logicians based
on the objective count of blue-eyed people, and not the count by a specific person. The xkcd
puzzle is the instance where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n = 99›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> blue_eyes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="free">w</span> <span class="bound">p</span> <span class="main">=</span> <span class="free">blue</span><span class="main">}</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"valid <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="free">guru</span> <span class="main">≠</span> <span class="free">blue</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"leaves <span class="free">k</span> <span class="free">p</span> <span class="free">w</span> <span class="main">⟷</span> <span class="free">w</span> <span class="free">p</span> <span class="main">=</span> <span class="free">blue</span> <span class="main">∧</span> <span class="free">k</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="free">p</span> <span class="main">=</span> <span class="free">blue</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>blues_seen <span class="free">w</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> blues_seen_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">`<span class="free">w</span> <span class="free">p</span> <span class="main">=</span> <span class="free">blue</span>`</span></span> <span class="quoted"><span class="quoted">`valid <span class="free">w</span>`</span></span> <span class="quoted"><span class="quoted">`<span class="free">w</span> <span class="free">guru</span> <span class="main">≠</span> <span class="free">blue</span>`</span></span> blue_leaves
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> only_blue_eyes_leave <span class="quoted"><span class="quoted">`valid <span class="free">w</span>`</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Future work›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹After completing this formalization, I have been made aware of epistemic logic.
The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">emph</span></span> ‹possible worlds›<span class="antiquote"><span class="antiquote">}</span></span></span></span> model in \cref{sec:world} turns out to be quite similar
to the usual semantics of this logic. It might be interesting to solve this puzzle within
the axiom system of epistemic logic, without explicit reasoning about possible worlds.›</span></span></pre>
</div>