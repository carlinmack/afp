<div id="BinaryTree">
<div class="head">
<h1>Theory BinaryTree</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Binary Search Trees, Isar-Style
    Author:      Viktor Kuncak, MIT CSAIL, November 2003
    Maintainer:  Larry Paulson &lt;Larry.Paulson at cl.cam.ac.uk&gt;
    License:     LGPL
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Isar-style Reasoning for Binary Tree Operations›</span></span>
<span class="keyword1"><span class="command">theory</span></span> BinaryTree <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We prove correctness of operations on 
 binary search tree implementing a set.

 This document is LGPL.

 Author: Viktor Kuncak, MIT CSAIL, November 2003›</span></span>

<span class="comment1">(*============================================================*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Tree Definition›</span></span>
<span class="comment1">(*============================================================*)</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> Tree <span class="main">=</span> Tip <span class="main">|</span> T <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Tree"</span></span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Tree"</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">setOf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Tree <span class="main">=&gt;</span> <span class="tfree">'a</span> set"</span></span> 
  <span class="comment1">― ‹set abstraction of a tree›</span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">setOf</span> Tip <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">setOf</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">setOf</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="keyword1">Un</span> <span class="main">(</span><span class="free">setOf</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="keyword1">Un</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span>
  <span class="comment1">― ‹we require index to have an irreflexive total order &lt;›</span>
  <span class="comment1">― ‹apart from that, we do not rely on index being int›</span>
  index <span class="main">=</span> <span class="quoted">int</span> 

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="comment1">― ‹hash function type›</span>
  <span class="tfree">'a</span> hash <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">=&gt;</span> index"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eqs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> hash <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">― ‹equivalence class of elements with the same hash code›</span>
  <span class="quoted"><span class="quoted">"<span class="free">eqs</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">==</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="bound">y</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">sortedTree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> hash <span class="main">=&gt;</span> <span class="tfree">'a</span> Tree <span class="main">=&gt;</span> bool"</span></span>
  <span class="comment1">― ‹check if a tree is sorted›</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sortedTree</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> Tip <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sortedTree</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="free">sortedTree</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">&amp;</span> 
     <span class="main">(</span><span class="main">∀</span><span class="bound">l</span> <span class="main">∈</span> setOf <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">&amp;</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> setOf <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="main">&amp;</span>
     <span class="free">sortedTree</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sortLemmaL<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="main">(</span>T <span class="free">t1</span> <span class="free">x</span> <span class="free">t2</span><span class="main">)</span> <span class="main">==&gt;</span> sortedTree <span class="free">h</span> <span class="free">t1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lemma</span></span> sortLemmaR<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="main">(</span>T <span class="free">t1</span> <span class="free">x</span> <span class="free">t2</span><span class="main">)</span> <span class="main">==&gt;</span> sortedTree <span class="free">h</span> <span class="free">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(*============================================================*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Tree Lookup›</span></span>
<span class="comment1">(*============================================================*)</span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">tlookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> hash <span class="main">=&gt;</span> index <span class="main">=&gt;</span> <span class="tfree">'a</span> Tree <span class="main">=&gt;</span> <span class="tfree">'a</span> option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tlookup</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> Tip <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tlookup</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> 
   <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="free">tlookup</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> <span class="free">tlookup</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>
    <span class="keyword1">else</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tlookup_none<span class="main">:</span> 
     <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="free">t</span> <span class="main">&amp;</span> <span class="main">(</span>tlookup <span class="free">h</span> <span class="free">k</span> <span class="free">t</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">--&gt;</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>setOf <span class="free">t</span><span class="main">.</span> <span class="free">h</span> <span class="bound">x</span> <span class="main">~=</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> tlookup_some<span class="main">:</span>
     <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="free">t</span> <span class="main">&amp;</span> <span class="main">(</span>tlookup <span class="free">h</span> <span class="free">k</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">x</span><span class="main">)</span> <span class="main">--&gt;</span> <span class="free">x</span><span class="main">:</span>setOf <span class="free">t</span> <span class="main">&amp;</span> <span class="free">h</span> <span class="free">x</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="comment1">― ‹Just auto will do it, but very slowly›</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sorted_distinct_pred</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> hash <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> Tree <span class="main">=&gt;</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">― ‹No two elements have the same hash code›</span>
  <span class="quoted"><span class="quoted">"<span class="free">sorted_distinct_pred</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> sortedTree <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">&amp;</span> 
      <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">:</span>setOf <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">:</span>setOf <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">--&gt;</span> 
      <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> sorted_distinct_pred_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="comment1">― ‹for case analysis on three cases›</span>
<span class="keyword1"><span class="command">lemma</span></span> cases3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="free">C1</span> <span class="main">==&gt;</span> <span class="free">G</span><span class="main">;</span> <span class="free">C2</span> <span class="main">==&gt;</span> <span class="free">G</span><span class="main">;</span> <span class="free">C3</span> <span class="main">==&gt;</span> <span class="free">G</span><span class="main">;</span>
                  <span class="free">C1</span> <span class="main">|</span> <span class="free">C2</span> <span class="main">|</span> <span class="free">C3</span> <span class="main">|]</span> <span class="main">==&gt;</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">sorted_distinct_pred</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> holds for out trees:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_distinct_pred <span class="free">h</span> <span class="free">a</span> <span class="free">b</span> <span class="free">t</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> Tip"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Tree"</span></span> <span class="keyword3"><span class="command">assume</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">t1</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Tree"</span></span> <span class="keyword3"><span class="command">assume</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">t2</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> sorted_distinct_pred_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> adef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">:</span> setOf <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bdef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">:</span> setOf <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> hahb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="free">a</span> <span class="main">=</span> <span class="free">h</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> s <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="skolem">t1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> s <span class="keyword1"><span class="command">have</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
    <span class="comment1">― ‹We consider 9 cases for the position of a and b are in the tree›</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="comment1">― ‹three cases for a›</span>
    <span class="keyword1"><span class="command">from</span></span> adef <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">:</span> setOf <span class="skolem">t1</span> <span class="main">|</span> <span class="free">a</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">|</span> <span class="free">a</span> <span class="main">:</span> setOf <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> adef1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">:</span> setOf <span class="skolem">t1</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="comment1">― ‹three cases for b›</span>
      <span class="keyword1"><span class="command">from</span></span> bdef <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">:</span> setOf <span class="skolem">t1</span> <span class="main">|</span> <span class="free">b</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">|</span> <span class="free">b</span> <span class="main">:</span> setOf <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> bdef1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">:</span> setOf <span class="skolem">t1</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> s1 adef1 bdef1 hahb h1 <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> bdef1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> adef1 bdef1 s <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> this hahb <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> bdef1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">:</span> setOf <span class="skolem">t2</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> adef1 s <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> bdef1 s <span class="keyword1"><span class="command">have</span></span> o2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> o1 o2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> this hahb <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span> <span class="comment1">― ‹case impossible›</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span> 
    <span class="keyword1"><span class="command">}</span></span> 
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> adef1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="comment1">― ‹three cases for b›</span>
      <span class="keyword1"><span class="command">from</span></span> bdef <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">:</span> setOf <span class="skolem">t1</span> <span class="main">|</span> <span class="free">b</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">|</span> <span class="free">b</span> <span class="main">:</span> setOf <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> bdef1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">:</span> setOf <span class="skolem">t1</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> this s <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> this adef1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> hahb this <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span> <span class="comment1">― ‹case impossible›</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> bdef1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> adef1 bdef1 <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> bdef1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">:</span> setOf <span class="skolem">t2</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> this s <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> this adef1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> hahb this <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span> <span class="comment1">― ‹case impossible›</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> adef1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">:</span> setOf <span class="skolem">t2</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="comment1">― ‹three cases for b›</span>
      <span class="keyword1"><span class="command">from</span></span> bdef <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">:</span> setOf <span class="skolem">t1</span> <span class="main">|</span> <span class="free">b</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">|</span> <span class="free">b</span> <span class="main">:</span> setOf <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> bdef1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">:</span> setOf <span class="skolem">t1</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> bdef1 s <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> adef1 s <span class="keyword1"><span class="command">have</span></span> o2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> o1 o2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> this hahb <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span> <span class="comment1">― ‹case impossible›</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> bdef1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> adef1 bdef1 s <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> this hahb <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span> <span class="comment1">― ‹case impossible›</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> bdef1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">:</span> setOf <span class="skolem">t2</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> s2 adef1 bdef1 hahb h2 <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tlookup_finds<span class="main">:</span> <span class="comment1">― ‹if a node is in the tree, lookup finds it›</span>
<span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="free">t</span> <span class="main">&amp;</span> <span class="free">y</span><span class="main">:</span>setOf <span class="free">t</span> <span class="main">--&gt;</span> 
 tlookup <span class="free">h</span> <span class="main">(</span><span class="free">h</span> <span class="free">y</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">assume</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="free">t</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> yint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">:</span> setOf <span class="free">t</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tlookup <span class="free">h</span> <span class="main">(</span><span class="free">h</span> <span class="free">y</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"tlookup <span class="free">h</span> <span class="main">(</span><span class="free">h</span> <span class="free">y</span><span class="main">)</span> <span class="free">t</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> None <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> this    
    <span class="keyword1"><span class="command">from</span></span> s res <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="free">t</span> <span class="main">&amp;</span> <span class="main">(</span>tlookup <span class="free">h</span> <span class="main">(</span><span class="free">h</span> <span class="free">y</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> None<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>setOf <span class="free">t</span><span class="main">.</span> <span class="free">h</span> <span class="bound">x</span> <span class="main">~=</span> <span class="free">h</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tlookup_none<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> o1 yint <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="free">y</span> <span class="main">~=</span> <span class="free">h</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> <span class="comment1">(* auto does not work *)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">z</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> this
    <span class="keyword1"><span class="command">have</span></span> ls<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="free">t</span> <span class="main">&amp;</span> <span class="main">(</span>tlookup <span class="free">h</span> <span class="main">(</span><span class="free">h</span> <span class="free">y</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Some <span class="skolem">z</span><span class="main">)</span> <span class="main">--&gt;</span>
              <span class="skolem">z</span><span class="main">:</span>setOf <span class="free">t</span> <span class="main">&amp;</span> <span class="free">h</span> <span class="skolem">z</span> <span class="main">=</span> <span class="free">h</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tlookup_some<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> sd<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_distinct_pred <span class="free">h</span> <span class="free">y</span> <span class="skolem">z</span> <span class="free">t</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> sorted_distinct <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">h</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">y</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">z</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span> 
       <span class="comment1">(* for some reason simplifier would never guess this substitution *)</span>
    <span class="keyword1"><span class="command">from</span></span> s res ls <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span><span class="main">:</span>setOf <span class="free">t</span> <span class="main">&amp;</span> <span class="free">h</span> <span class="skolem">z</span> <span class="main">=</span> <span class="free">h</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> s yint o1 sd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this res <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tlookup <span class="free">h</span> <span class="main">(</span><span class="free">h</span> <span class="free">y</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Tree membership as a special case of lookup›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">memb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> hash <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> Tree <span class="main">=&gt;</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">memb</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> 
   <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>tlookup <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      None <span class="main">=&gt;</span> False
    <span class="main">|</span> Some <span class="bound">z</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">=</span><span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="free">t</span>"</span></span> 
      <span class="keyword2"><span class="keyword">shows</span></span> memb_spec<span class="main">:</span> <span class="quoted"><span class="quoted">"memb <span class="free">h</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">:</span> setOf <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"tlookup <span class="free">h</span> <span class="main">(</span><span class="free">h</span> <span class="free">x</span><span class="main">)</span> <span class="free">t</span>"</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> None <span class="keyword1"><span class="command">note</span></span> tNone <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> tNone <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"memb <span class="free">h</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> memb_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s tNone tlookup_none <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>setOf <span class="free">t</span><span class="main">.</span> <span class="free">h</span> <span class="bound">y</span> <span class="main">~=</span> <span class="free">h</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> notIn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">~:</span> setOf <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">:</span> setOf <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> h o1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="free">x</span> <span class="main">~=</span> <span class="free">h</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> res notIn <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">z</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> tSome <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> s tSome tlookup_some <span class="keyword1"><span class="command">have</span></span> zin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">:</span> setOf <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">=</span><span class="skolem">z</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> xez <span class="main">=</span> this
    <span class="keyword1"><span class="command">from</span></span> tSome xez <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"memb <span class="free">h</span> <span class="free">x</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> memb_def<span class="main">)</span>  
    <span class="keyword1"><span class="command">from</span></span> res zin xez <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> xnez <span class="main">=</span> this
    <span class="keyword1"><span class="command">from</span></span> tSome xnez <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> memb <span class="free">h</span> <span class="free">x</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> memb_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">~:</span> setOf <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> xin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">:</span> setOf <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> s tSome tlookup_some <span class="keyword1"><span class="command">have</span></span> hzhx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="free">x</span> <span class="main">=</span> <span class="free">h</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_distinct_pred <span class="free">h</span> <span class="free">x</span> <span class="skolem">z</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> sorted_distinct <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">h</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">z</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> s xin zin hzhx o1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">from</span></span> this xnez <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>  
    <span class="keyword1"><span class="command">from</span></span> this res <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> sorted_distinct_pred_def <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="comment1">(*============================================================*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Insertion into a Tree›</span></span>
<span class="comment1">(*============================================================*)</span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">binsert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> hash <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> Tree <span class="main">=&gt;</span> <span class="tfree">'a</span> Tree"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">binsert</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> Tip <span class="main">=</span> <span class="main">(</span>T Tip <span class="free"><span class="bound"><span class="entity">e</span></span></span> Tip<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">binsert</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span>
                             <span class="main">(</span>T <span class="main">(</span><span class="free">binsert</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>
                            <span class="keyword1">else</span>
                             <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">then</span>
                               <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">binsert</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span>
                              <span class="keyword1">else</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A technique for proving disjointness of sets.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> disjCond<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="main">!!</span> <span class="bound">x</span><span class="main">.</span> <span class="main">[|</span> <span class="bound">x</span><span class="main">:</span><span class="free">A</span><span class="main">;</span> <span class="bound">x</span><span class="main">:</span><span class="free">B</span> <span class="main">|]</span> <span class="main">==&gt;</span> False <span class="main">|]</span> <span class="main">==&gt;</span> <span class="free">A</span> <span class="keyword1">Int</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following is a proof that insertion correctly implements
        the set interface.
        Compared to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>BinaryTree_TacticStyle›</span></span></span></span>, the claim is more
        difficult, and this time we need to assume as a hypothesis
        that the tree is sorted.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> binsert_set<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="free">t</span> <span class="main">--&gt;</span>
                    setOf <span class="main">(</span>binsert <span class="free">h</span> <span class="free">e</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>setOf <span class="free">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>eqs <span class="free">h</span> <span class="free">e</span><span class="main">)</span> <span class="keyword1">Un</span> <span class="main">{</span><span class="free">e</span><span class="main">}</span>"</span></span> 
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="comment1">― ‹base case›</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> Tip"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqs_def<span class="main">)</span>
  <span class="comment1">― ‹inductition step›</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Tree"</span></span> <span class="keyword3"><span class="command">assume</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">t1</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Tree"</span></span> <span class="keyword3"><span class="command">assume</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">t2</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> s <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="skolem">t1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sortLemmaL<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> s1 <span class="keyword2"><span class="keyword">and</span></span> h1 <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">"setOf <span class="main">(</span>binsert <span class="free">h</span> <span class="free">e</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">=</span> setOf <span class="skolem">t1</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span> <span class="keyword1">Un</span> <span class="main">{</span><span class="free">e</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> s <span class="keyword1"><span class="command">have</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sortLemmaR<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> s2 <span class="keyword2"><span class="keyword">and</span></span> h2 <span class="keyword1"><span class="command">have</span></span> c2<span class="main">:</span> <span class="quoted"><span class="quoted">"setOf <span class="main">(</span>binsert <span class="free">h</span> <span class="free">e</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> setOf <span class="skolem">t2</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span> <span class="keyword1">Un</span> <span class="main">{</span><span class="free">e</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"setOf <span class="main">(</span>binsert <span class="free">h</span> <span class="free">e</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          setOf <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span> <span class="keyword1">Un</span> <span class="main">{</span><span class="free">e</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="free">e</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> eLess <span class="main">=</span> this
        <span class="keyword1"><span class="command">from</span></span> eLess <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"binsert <span class="free">h</span> <span class="free">e</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>T <span class="main">(</span>binsert <span class="free">h</span> <span class="free">e</span> <span class="skolem">t1</span><span class="main">)</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"setOf <span class="main">(</span>binsert <span class="free">h</span> <span class="free">e</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
              setOf <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span> <span class="keyword1">Un</span> <span class="main">{</span><span class="free">e</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> res eLess c1<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">x</span> <span class="main">(</span>insert <span class="free">e</span> <span class="main">(</span>setOf <span class="skolem">t1</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span> <span class="keyword1">Un</span> setOf <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
                insert <span class="free">e</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="main">(</span>setOf <span class="skolem">t1</span> <span class="keyword1">Un</span> setOf <span class="skolem">t2</span><span class="main">)</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> eqsLessX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">el</span> <span class="main">∈</span> eqs <span class="free">h</span> <span class="free">e</span><span class="main">.</span> <span class="free">h</span> <span class="bound">el</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqs_def eLess<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> eqsDisjX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">el</span> <span class="main">∈</span> eqs <span class="free">h</span> <span class="free">e</span><span class="main">.</span> <span class="free">h</span> <span class="bound">el</span> <span class="main">~=</span> <span class="free">h</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
            <span class="keyword1"><span class="command">from</span></span> s <span class="keyword1"><span class="command">have</span></span> xLessT2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> setOf <span class="skolem">t2</span><span class="main">.</span> <span class="free">h</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="bound">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> eqsLessT2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">el</span> <span class="main">∈</span> eqs <span class="free">h</span> <span class="free">e</span><span class="main">.</span> <span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> setOf <span class="skolem">t2</span><span class="main">.</span> <span class="free">h</span> <span class="bound">el</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="bound">r</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">el</span> <span class="keyword3"><span class="command">assume</span></span> hel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">el</span> <span class="main">:</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span>
              <span class="keyword1"><span class="command">from</span></span> hel eqs_def <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">el</span> <span class="main">=</span> <span class="free">h</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> <span class="comment1">(* auto fails here! *)</span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="keyword3"><span class="command">assume</span></span> hr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">:</span> setOf <span class="skolem">t2</span>"</span></span>
              <span class="keyword1"><span class="command">from</span></span> xLessT2 hr o1 eLess <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">el</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">from</span></span> eqsLessT2 <span class="keyword1"><span class="command">have</span></span> eqsDisjT2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">el</span> <span class="main">∈</span> eqs <span class="free">h</span> <span class="free">e</span><span class="main">.</span> <span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> setOf <span class="skolem">t2</span><span class="main">.</span> <span class="free">h</span> <span class="bound">el</span> <span class="main">~=</span> <span class="free">h</span> <span class="bound">r</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> <span class="comment1">(* auto fails here *)</span>
            <span class="keyword1"><span class="command">from</span></span> eqsDisjX eqsDisjT2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> eNotLess <span class="main">=</span> this
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"setOf <span class="main">(</span>binsert <span class="free">h</span> <span class="free">e</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> setOf <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span> <span class="keyword1">Un</span> <span class="main">{</span><span class="free">e</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="free">e</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> xLess <span class="main">=</span> this
        <span class="keyword1"><span class="command">from</span></span> xLess <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"binsert <span class="free">h</span> <span class="free">e</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="main">(</span>binsert <span class="free">h</span> <span class="free">e</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"setOf <span class="main">(</span>binsert <span class="free">h</span> <span class="free">e</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
              setOf <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span> <span class="keyword1">Un</span> <span class="main">{</span><span class="free">e</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> res xLess eNotLess c2<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">x</span> <span class="main">(</span>insert <span class="free">e</span> <span class="main">(</span>setOf <span class="skolem">t1</span> <span class="keyword1">Un</span> <span class="main">(</span>setOf <span class="skolem">t2</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
                insert <span class="free">e</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="main">(</span>setOf <span class="skolem">t1</span> <span class="keyword1">Un</span> setOf <span class="skolem">t2</span><span class="main">)</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> XLessEqs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">el</span> <span class="main">∈</span> eqs <span class="free">h</span> <span class="free">e</span><span class="main">.</span> <span class="free">h</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="bound">el</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqs_def xLess<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> eqsDisjX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">el</span> <span class="main">∈</span> eqs <span class="free">h</span> <span class="free">e</span><span class="main">.</span> <span class="free">h</span> <span class="bound">el</span> <span class="main">~=</span> <span class="free">h</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> s <span class="keyword1"><span class="command">have</span></span> t1LessX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span> <span class="main">∈</span> setOf <span class="skolem">t1</span><span class="main">.</span> <span class="free">h</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> T1lessEqs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">el</span> <span class="main">∈</span> eqs <span class="free">h</span> <span class="free">e</span><span class="main">.</span> <span class="main">∀</span><span class="bound">l</span> <span class="main">∈</span> setOf <span class="skolem">t1</span><span class="main">.</span> <span class="free">h</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="bound">el</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">el</span> <span class="keyword3"><span class="command">assume</span></span> hel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">el</span> <span class="main">:</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="keyword3"><span class="command">assume</span></span> hl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">:</span> setOf <span class="skolem">t1</span>"</span></span>
              <span class="keyword1"><span class="command">from</span></span> hel eqs_def <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">el</span> <span class="main">=</span> <span class="free">h</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> <span class="comment1">(* auto fails here! *)</span>
              <span class="keyword1"><span class="command">from</span></span> t1LessX hl o1 xLess <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">l</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">el</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">from</span></span> T1lessEqs <span class="keyword1"><span class="command">have</span></span> T1disjEqs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">el</span> <span class="main">∈</span> eqs <span class="free">h</span> <span class="free">e</span><span class="main">.</span> <span class="main">∀</span><span class="bound">l</span> <span class="main">∈</span> setOf <span class="skolem">t1</span><span class="main">.</span> <span class="free">h</span> <span class="bound">el</span> <span class="main">~=</span> <span class="free">h</span> <span class="bound">l</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
            <span class="keyword1"><span class="command">from</span></span> eqsDisjX T1lessEqs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>      
      <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> xNotLess <span class="main">=</span> this
        <span class="keyword1"><span class="command">from</span></span> xNotLess eNotLess <span class="keyword1"><span class="command">have</span></span> xeqe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">h</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> xeqe <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"binsert <span class="free">h</span> <span class="free">e</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="free">e</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"setOf <span class="main">(</span>binsert <span class="free">h</span> <span class="free">e</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
              setOf <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span> <span class="keyword1">Un</span> <span class="main">{</span><span class="free">e</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> res eNotLess xeqe<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">e</span> <span class="main">(</span>setOf <span class="skolem">t1</span> <span class="keyword1">Un</span> setOf <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> 
                insert <span class="free">e</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="main">(</span>setOf <span class="skolem">t1</span> <span class="keyword1">Un</span> setOf <span class="skolem">t2</span><span class="main">)</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">x</span> <span class="main">(</span>setOf <span class="skolem">t1</span> <span class="keyword1">Un</span> setOf <span class="skolem">t2</span><span class="main">)</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span> <span class="main">=</span> 
                  setOf <span class="skolem">t1</span> <span class="keyword1">Un</span> setOf <span class="skolem">t2</span>"</span></span> 
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="comment1">(* o1: *)</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">:</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqs_def xeqe<span class="main">)</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="comment1">(* o2: *)</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>setOf <span class="skolem">t1</span><span class="main">)</span> <span class="keyword1">Int</span> <span class="main">(</span>eqs <span class="free">h</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjCond<span class="main">)</span>
                <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
                <span class="keyword3"><span class="command">assume</span></span> whSet<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">:</span> setOf <span class="skolem">t1</span>"</span></span>
                <span class="keyword3"><span class="command">assume</span></span> whEq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">:</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span>
                <span class="keyword1"><span class="command">from</span></span> whSet s <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">w</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">from</span></span> whEq eqs_def <span class="keyword1"><span class="command">have</span></span> o2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">w</span> <span class="main">=</span> <span class="free">h</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
                <span class="keyword1"><span class="command">from</span></span> o2 xeqe <span class="keyword1"><span class="command">have</span></span> o3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="free">h</span> <span class="skolem">w</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">from</span></span> o1 o3 <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="comment1">(* o3: *)</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>setOf <span class="skolem">t2</span><span class="main">)</span> <span class="keyword1">Int</span> <span class="main">(</span>eqs <span class="free">h</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjCond<span class="main">)</span>
                <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
                <span class="keyword3"><span class="command">assume</span></span> whSet<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">:</span> setOf <span class="skolem">t2</span>"</span></span>
                <span class="keyword3"><span class="command">assume</span></span> whEq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">:</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span>
                <span class="keyword1"><span class="command">from</span></span> whSet s <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">from</span></span> whEq eqs_def <span class="keyword1"><span class="command">have</span></span> o2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">w</span> <span class="main">=</span> <span class="free">h</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
                <span class="keyword1"><span class="command">from</span></span> o2 xeqe <span class="keyword1"><span class="command">have</span></span> o3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="free">h</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command">from</span></span> o1 o3 <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Using the correctness of set implementation,
        preserving sortedness is still simple.›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> binsert_sorted<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="free">t</span> <span class="main">--&gt;</span> sortedTree <span class="free">h</span> <span class="main">(</span>binsert <span class="free">h</span> <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binsert_set<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We summarize the specification of binsert as follows.›</span></span>
<span class="keyword1"><span class="command">corollary</span></span> binsert_spec<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="free">t</span> <span class="main">--&gt;</span>
                     sortedTree <span class="free">h</span> <span class="main">(</span>binsert <span class="free">h</span> <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">&amp;</span>
                     setOf <span class="main">(</span>binsert <span class="free">h</span> <span class="free">e</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>setOf <span class="free">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>eqs <span class="free">h</span> <span class="free">e</span><span class="main">)</span> <span class="keyword1">Un</span> <span class="main">{</span><span class="free">e</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binsert_set binsert_sorted<span class="main">)</span>

<span class="comment1">(*============================================================*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Removing an element from a tree›</span></span>
<span class="comment1">(*============================================================*)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹These proofs are influenced by those in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>BinaryTree_Tactic›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">rm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> hash <span class="main">=&gt;</span> <span class="tfree">'a</span> Tree <span class="main">=&gt;</span> <span class="tfree">'a</span>"</span></span>
  <span class="comment1">― ‹rightmost element of a tree›</span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rm</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">=</span>Tip <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> <span class="free">rm</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">wrm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> hash <span class="main">=&gt;</span> <span class="tfree">'a</span> Tree <span class="main">=&gt;</span> <span class="tfree">'a</span> Tree"</span></span>
  <span class="comment1">― ‹tree without the rightmost element›</span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">wrm</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">=</span>Tip <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="keyword1">else</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">wrm</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">wrmrm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> hash <span class="main">=&gt;</span> <span class="tfree">'a</span> Tree <span class="main">=&gt;</span> <span class="tfree">'a</span> Tree <span class="main">*</span> <span class="tfree">'a</span>"</span></span>
  <span class="comment1">― ‹computing rightmost and removal in one pass›</span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">wrmrm</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">=</span>Tip <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>
   <span class="keyword1">else</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>fst <span class="main">(</span><span class="free">wrmrm</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
         snd <span class="main">(</span><span class="free">wrmrm</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">remove</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> hash <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> Tree <span class="main">=&gt;</span> <span class="tfree">'a</span> Tree"</span></span>
   <span class="comment1">― ‹removal of an element from the tree›</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remove</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> Tip <span class="main">=</span> Tip"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">remove</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>T <span class="main">(</span><span class="free">remove</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>T <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">remove</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span>
     <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">=</span>Tip <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>
           <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">t1p</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">=</span> wrmrm <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span>
                <span class="keyword1">in</span> <span class="main">(</span>T <span class="bound">t1p</span> <span class="bound">r</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> wrmrm_decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">~=</span> Tip <span class="main">--&gt;</span> wrmrm <span class="free">h</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span>wrm <span class="free">h</span> <span class="free">t</span><span class="main">,</span> rm <span class="free">h</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> rm_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">~=</span> Tip <span class="main">&amp;</span> sortedTree <span class="free">h</span> <span class="free">t</span> <span class="main">--&gt;</span> rm <span class="free">h</span> <span class="free">t</span> <span class="main">:</span> setOf <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> wrm_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">~=</span> Tip <span class="main">&amp;</span> sortedTree <span class="free">h</span> <span class="free">t</span> <span class="main">--&gt;</span> 
                setOf <span class="main">(</span>wrm <span class="free">h</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> setOf <span class="free">t</span> <span class="main">-</span> <span class="main">{</span>rm <span class="free">h</span> <span class="free">t</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> Tip"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Tree"</span></span> <span class="keyword3"><span class="command">assume</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">t1</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Tree"</span></span> <span class="keyword3"><span class="command">assume</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">t2</span>"</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"setOf <span class="main">(</span>wrm <span class="free">h</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
          setOf <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span>rm <span class="free">h</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">=</span> Tip"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> t2tip <span class="main">=</span> this
      <span class="keyword1"><span class="command">from</span></span> t2tip <span class="keyword1"><span class="command">have</span></span> rm_res<span class="main">:</span> <span class="quoted"><span class="quoted">"rm <span class="free">h</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> t2tip <span class="keyword1"><span class="command">have</span></span> wrm_res<span class="main">:</span> <span class="quoted"><span class="quoted">"wrm <span class="free">h</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> s <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">~:</span> setOf <span class="skolem">t1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> this rm_res wrm_res t2tip <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> t2nTip <span class="main">=</span> this
      <span class="keyword1"><span class="command">from</span></span> t2nTip <span class="keyword1"><span class="command">have</span></span> rm_res<span class="main">:</span> <span class="quoted"><span class="quoted">"rm <span class="free">h</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> rm <span class="free">h</span> <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> t2nTip <span class="keyword1"><span class="command">have</span></span> wrm_res<span class="main">:</span> <span class="quoted"><span class="quoted">"wrm <span class="free">h</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="main">(</span>wrm <span class="free">h</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> s <span class="keyword1"><span class="command">have</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>    
      <span class="keyword1"><span class="command">from</span></span> h2 t2nTip s2 
      <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"setOf <span class="main">(</span>wrm <span class="free">h</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> setOf <span class="skolem">t2</span> <span class="main">-</span> <span class="main">{</span>rm <span class="free">h</span> <span class="skolem">t2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rm_res wrm_res t2nTip h2 o1<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">x</span> <span class="main">(</span>setOf <span class="skolem">t1</span> <span class="keyword1">Un</span> <span class="main">(</span>setOf <span class="skolem">t2</span> <span class="main">-</span> <span class="main">{</span>rm <span class="free">h</span> <span class="skolem">t2</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
              insert <span class="skolem">x</span> <span class="main">(</span>setOf <span class="skolem">t1</span> <span class="keyword1">Un</span> setOf <span class="skolem">t2</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span>rm <span class="free">h</span> <span class="skolem">t2</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">from</span></span> s rm_set t2nTip <span class="keyword1"><span class="command">have</span></span> xOk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="main">(</span>rm <span class="free">h</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
          <span class="keyword1"><span class="command">have</span></span> t1Ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span> <span class="main">∈</span> setOf <span class="skolem">t1</span><span class="main">.</span> <span class="free">h</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="main">(</span>rm <span class="free">h</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>  <span class="keyword3"><span class="command">assume</span></span> ldef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">:</span> setOf <span class="skolem">t1</span>"</span></span>
            <span class="keyword1"><span class="command">from</span></span> ldef s <span class="keyword1"><span class="command">have</span></span> lx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">l</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> lx xOk <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">l</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="main">(</span>rm <span class="free">h</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">from</span></span> xOk t1Ok <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wrm_set1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">~=</span> Tip <span class="main">&amp;</span> sortedTree <span class="free">h</span> <span class="free">t</span> <span class="main">--&gt;</span> setOf <span class="main">(</span>wrm <span class="free">h</span> <span class="free">t</span><span class="main">)</span> <span class="main">&lt;=</span> setOf <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wrm_set<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wrm_sort<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">~=</span> Tip <span class="main">&amp;</span> sortedTree <span class="free">h</span> <span class="free">t</span> <span class="main">--&gt;</span> sortedTree <span class="free">h</span> <span class="main">(</span>wrm <span class="free">h</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> Tip"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Tree"</span></span> <span class="keyword3"><span class="command">assume</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">t1</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Tree"</span></span> <span class="keyword3"><span class="command">assume</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">t2</span>"</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">assume</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="main">(</span>wrm <span class="free">h</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">=</span> Tip"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> t2tip <span class="main">=</span> this
      <span class="keyword1"><span class="command">from</span></span> t2tip <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"wrm <span class="free">h</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> res s <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> t2nTip <span class="main">=</span> this
      <span class="keyword1"><span class="command">from</span></span> t2nTip <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"wrm <span class="free">h</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="main">(</span>wrm <span class="free">h</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> s <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="skolem">t1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> s <span class="keyword1"><span class="command">have</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> s2 h2 t2nTip <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="main">(</span>wrm <span class="free">h</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> s2 t2nTip wrm_set1 <span class="keyword1"><span class="command">have</span></span> o2<span class="main">:</span> <span class="quoted"><span class="quoted">"setOf <span class="main">(</span>wrm <span class="free">h</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">&lt;=</span> setOf <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> s o2 <span class="keyword1"><span class="command">have</span></span> o3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> setOf <span class="main">(</span>wrm <span class="free">h</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">.</span> <span class="free">h</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="bound">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> s1 o1 o3 res s <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="main">(</span>wrm <span class="free">h</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wrm_less_rm<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">~=</span> Tip <span class="main">&amp;</span> sortedTree <span class="free">h</span> <span class="free">t</span> <span class="main">--&gt;</span> 
   <span class="main">(</span><span class="main">∀</span><span class="bound">l</span> <span class="main">∈</span> setOf <span class="main">(</span>wrm <span class="free">h</span> <span class="free">t</span><span class="main">)</span><span class="main">.</span> <span class="free">h</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="main">(</span>rm <span class="free">h</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> Tip"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Tree"</span></span> <span class="keyword3"><span class="command">assume</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">t1</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Tree"</span></span> <span class="keyword3"><span class="command">assume</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">t2</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>   
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span> <span class="keyword3"><span class="command">assume</span></span> ldef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">:</span> setOf <span class="main">(</span>wrm <span class="free">h</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> s <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="skolem">t1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> s <span class="keyword1"><span class="command">have</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">l</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="main">(</span>rm <span class="free">h</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">=</span> Tip"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> t2tip <span class="main">=</span> this
      <span class="keyword1"><span class="command">from</span></span> t2tip <span class="keyword1"><span class="command">have</span></span> rm_res<span class="main">:</span> <span class="quoted"><span class="quoted">"rm <span class="free">h</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> t2tip <span class="keyword1"><span class="command">have</span></span> wrm_res<span class="main">:</span> <span class="quoted"><span class="quoted">"wrm <span class="free">h</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> ldef wrm_res <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">:</span> setOf <span class="skolem">t1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> rm_res o1 s <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> t2nTip <span class="main">=</span> this
      <span class="keyword1"><span class="command">from</span></span> t2nTip <span class="keyword1"><span class="command">have</span></span> rm_res<span class="main">:</span> <span class="quoted"><span class="quoted">"rm <span class="free">h</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> rm <span class="free">h</span> <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> t2nTip <span class="keyword1"><span class="command">have</span></span> wrm_res<span class="main">:</span> <span class="quoted"><span class="quoted">"wrm <span class="free">h</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="main">(</span>wrm <span class="free">h</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> ldef wrm_res 
      <span class="keyword1"><span class="command">have</span></span> l_scope<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">:</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="keyword1">Un</span> setOf <span class="skolem">t1</span> <span class="keyword1">Un</span> setOf <span class="main">(</span>wrm <span class="free">h</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> hLess<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">l</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="main">(</span>rm <span class="free">h</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> lx <span class="main">=</span> this
        <span class="keyword1"><span class="command">from</span></span> s t2nTip rm_set s2 <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="main">(</span>rm <span class="free">h</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> lx o1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> lnx <span class="main">=</span> this
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">:</span> setOf <span class="skolem">t1</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> l_in_t1 <span class="main">=</span> this
          <span class="keyword1"><span class="command">from</span></span> s t2nTip rm_set s2 <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="main">(</span>rm <span class="free">h</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> l_in_t1 s <span class="keyword1"><span class="command">have</span></span> o2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">l</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> o1 o2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> l_notin_t1 <span class="main">=</span> this
          <span class="keyword1"><span class="command">from</span></span> l_scope lnx l_notin_t1 
          <span class="keyword1"><span class="command">have</span></span> l_in_res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">:</span> setOf <span class="main">(</span>wrm <span class="free">h</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> l_in_res h2 t2nTip s2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> rm_res hLess <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> remove_set<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="free">t</span> <span class="main">--&gt;</span> 
  setOf <span class="main">(</span>remove <span class="free">h</span> <span class="free">e</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> setOf <span class="free">t</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> Tip"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Tree"</span></span> <span class="keyword3"><span class="command">assume</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">t1</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Tree"</span></span> <span class="keyword3"><span class="command">assume</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">t2</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"setOf <span class="main">(</span>remove <span class="free">h</span> <span class="free">e</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> setOf <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="free">e</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> elx <span class="main">=</span> this
      <span class="keyword1"><span class="command">from</span></span> elx <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"remove <span class="free">h</span> <span class="free">e</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> T <span class="main">(</span>remove <span class="free">h</span> <span class="free">e</span> <span class="skolem">t1</span><span class="main">)</span> <span class="skolem">x</span> <span class="skolem">t2</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> s <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="skolem">t1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> s1 h1 <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"setOf <span class="main">(</span>remove <span class="free">h</span> <span class="free">e</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">=</span> setOf <span class="skolem">t1</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o1 elx<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">x</span> <span class="main">(</span>setOf <span class="skolem">t1</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span> <span class="keyword1">Un</span> setOf <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> 
              insert <span class="skolem">x</span> <span class="main">(</span>setOf <span class="skolem">t1</span> <span class="keyword1">Un</span> setOf <span class="skolem">t2</span><span class="main">)</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> xOk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">~:</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span> 
          <span class="keyword1"><span class="command">proof</span></span> 
            <span class="keyword3"><span class="command">assume</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">:</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span>
            <span class="keyword1"><span class="command">from</span></span> h <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="main">(</span><span class="free">h</span> <span class="free">e</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqs_def<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> elx o1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">have</span></span> t2Ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>setOf <span class="skolem">t2</span><span class="main">)</span> <span class="keyword1">Int</span> <span class="main">(</span>eqs <span class="free">h</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjCond<span class="main">)</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> 
            <span class="keyword3"><span class="command">assume</span></span> y_in_t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">:</span> setOf <span class="skolem">t2</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> y_in_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">:</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span>
            <span class="keyword1"><span class="command">from</span></span> y_in_t2 s <span class="keyword1"><span class="command">have</span></span> xly<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> y_in_eq <span class="keyword1"><span class="command">have</span></span> eey<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">y</span> <span class="main">=</span> <span class="free">h</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqs_def<span class="main">)</span> <span class="comment1">(* must "add:" not "from" *)</span>
            <span class="keyword1"><span class="command">from</span></span> xly eey <span class="keyword1"><span class="command">have</span></span> nelx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="main">(</span><span class="free">h</span> <span class="free">e</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">from</span></span> nelx elx <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">from</span></span> xOk t2Ok <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> nelx <span class="main">=</span> this
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="free">e</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> xle <span class="main">=</span> this
        <span class="keyword1"><span class="command">from</span></span> xle <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"remove <span class="free">h</span> <span class="free">e</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="main">(</span>remove <span class="free">h</span> <span class="free">e</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> s <span class="keyword1"><span class="command">have</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> s2 h2 <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"setOf <span class="main">(</span>remove <span class="free">h</span> <span class="free">e</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> setOf <span class="skolem">t2</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o1 xle nelx<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">x</span> <span class="main">(</span>setOf <span class="skolem">t1</span> <span class="keyword1">Un</span> <span class="main">(</span>setOf <span class="skolem">t2</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
                insert <span class="skolem">x</span> <span class="main">(</span>setOf <span class="skolem">t1</span> <span class="keyword1">Un</span> setOf <span class="skolem">t2</span><span class="main">)</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> xOk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">~:</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span> 
            <span class="keyword1"><span class="command">proof</span></span> 
              <span class="keyword3"><span class="command">assume</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">:</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span>
              <span class="keyword1"><span class="command">from</span></span> h <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="main">(</span><span class="free">h</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="free">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqs_def<span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> xle o1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">have</span></span> t1Ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>setOf <span class="skolem">t1</span><span class="main">)</span> <span class="keyword1">Int</span> <span class="main">(</span>eqs <span class="free">h</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjCond<span class="main">)</span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> 
              <span class="keyword3"><span class="command">assume</span></span> y_in_t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">:</span> setOf <span class="skolem">t1</span>"</span></span>
              <span class="keyword3"><span class="command">assume</span></span> y_in_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">:</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span>
              <span class="keyword1"><span class="command">from</span></span> y_in_t1 s <span class="keyword1"><span class="command">have</span></span> ylx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">y</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">from</span></span> y_in_eq <span class="keyword1"><span class="command">have</span></span> eey<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">y</span> <span class="main">=</span> <span class="free">h</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqs_def<span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> ylx eey <span class="keyword1"><span class="command">have</span></span> nxle<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="main">(</span><span class="free">h</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="free">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">from</span></span> nxle xle <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">from</span></span> xOk t1Ok <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> nxle <span class="main">=</span> this
        <span class="keyword1"><span class="command">from</span></span> nelx nxle <span class="keyword1"><span class="command">have</span></span> ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="free">e</span> <span class="main">=</span> <span class="free">h</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> t2Ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>setOf <span class="skolem">t2</span><span class="main">)</span> <span class="keyword1">Int</span> <span class="main">(</span>eqs <span class="free">h</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjCond<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> 
          <span class="keyword3"><span class="command">assume</span></span> y_in_t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">:</span> setOf <span class="skolem">t2</span>"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> y_in_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">:</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> y_in_t2 s <span class="keyword1"><span class="command">have</span></span> xly<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> y_in_eq <span class="keyword1"><span class="command">have</span></span> eey<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">y</span> <span class="main">=</span> <span class="free">h</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqs_def<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> y_in_eq ex eey <span class="keyword1"><span class="command">have</span></span> nxly<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="main">(</span><span class="free">h</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">from</span></span> nxly xly <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">=</span> Tip"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> t1tip <span class="main">=</span> this
          <span class="keyword1"><span class="command">from</span></span> ex t1tip <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"remove <span class="free">h</span> <span class="free">e</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> res t1tip ex<span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"setOf <span class="skolem">t2</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="main">(</span>setOf <span class="skolem">t2</span><span class="main">)</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span>              
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">from</span></span> ex <span class="keyword1"><span class="command">have</span></span> x_in_eqs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">:</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqs_def<span class="main">)</span>
              <span class="keyword1"><span class="command">from</span></span> x_in_eqs t2Ok <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> t1nTip <span class="main">=</span> this
          <span class="keyword1"><span class="command">from</span></span> nelx nxle ex t1nTip
          <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"remove <span class="free">h</span> <span class="free">e</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span>
                     T <span class="main">(</span>wrm <span class="free">h</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">(</span>rm <span class="free">h</span> <span class="skolem">t1</span><span class="main">)</span> <span class="skolem">t2</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def wrmrm_decomp<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> res <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">from</span></span> s <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="skolem">t1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span>rm <span class="free">h</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">(</span>setOf <span class="main">(</span>wrm <span class="free">h</span> <span class="skolem">t1</span><span class="main">)</span> <span class="keyword1">Un</span> setOf <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> 
                  insert <span class="skolem">x</span> <span class="main">(</span>setOf <span class="skolem">t1</span> <span class="keyword1">Un</span> setOf <span class="skolem">t2</span><span class="main">)</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t1nTip s1 rm_set wrm_set<span class="main">)</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span>rm <span class="free">h</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">(</span>setOf <span class="skolem">t1</span> <span class="main">-</span> <span class="main">{</span>rm <span class="free">h</span> <span class="skolem">t1</span><span class="main">}</span> <span class="keyword1">Un</span> setOf <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> 
                    insert <span class="skolem">x</span> <span class="main">(</span>setOf <span class="skolem">t1</span> <span class="keyword1">Un</span> setOf <span class="skolem">t2</span><span class="main">)</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">from</span></span> t1nTip s1 rm_set
                <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span>rm <span class="free">h</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">(</span>setOf <span class="skolem">t1</span> <span class="main">-</span> <span class="main">{</span>rm <span class="free">h</span> <span class="skolem">t1</span><span class="main">}</span> <span class="keyword1">Un</span> setOf <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span>
                          setOf <span class="skolem">t1</span> <span class="keyword1">Un</span> setOf <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> o2<span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="skolem">x</span> <span class="main">(</span>setOf <span class="skolem">t1</span> <span class="keyword1">Un</span> setOf <span class="skolem">t2</span><span class="main">)</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span> <span class="main">=</span>
                          setOf <span class="skolem">t1</span> <span class="keyword1">Un</span> setOf <span class="skolem">t2</span>"</span></span> 
                <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                  <span class="keyword1"><span class="command">from</span></span> ex <span class="keyword1"><span class="command">have</span></span> xOk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">:</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqs_def<span class="main">)</span>                  
                  <span class="keyword1"><span class="command">have</span></span> t1Ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>setOf <span class="skolem">t1</span><span class="main">)</span> <span class="keyword1">Int</span> <span class="main">(</span>eqs <span class="free">h</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
                  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjCond<span class="main">)</span>
                    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> 
                    <span class="keyword3"><span class="command">assume</span></span> y_in_t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">:</span> setOf <span class="skolem">t1</span>"</span></span>
                    <span class="keyword3"><span class="command">assume</span></span> y_in_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">:</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span>
                    <span class="keyword1"><span class="command">from</span></span> y_in_t1 s ex <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">y</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                    <span class="keyword1"><span class="command">from</span></span> y_in_eq <span class="keyword1"><span class="command">have</span></span> o2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="main">(</span><span class="free">h</span> <span class="skolem">y</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="free">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqs_def<span class="main">)</span>
                    <span class="keyword1"><span class="command">from</span></span> o1 o2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
                  <span class="keyword1"><span class="command">qed</span></span>
                  <span class="keyword1"><span class="command">from</span></span> xOk t1Ok t2Ok <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">from</span></span> o1 o2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> remove_sort<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="free">t</span> <span class="main">--&gt;</span> 
                    sortedTree <span class="free">h</span> <span class="main">(</span>remove <span class="free">h</span> <span class="free">e</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> Tip"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Tree"</span></span> <span class="keyword3"><span class="command">assume</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">t1</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> Tree"</span></span> <span class="keyword3"><span class="command">assume</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">t2</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> s <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="skolem">t1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> s <span class="keyword1"><span class="command">have</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> h1 s1 <span class="keyword1"><span class="command">have</span></span> sr1<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="main">(</span>remove <span class="free">h</span> <span class="free">e</span> <span class="skolem">t1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> h2 s2 <span class="keyword1"><span class="command">have</span></span> sr2<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="main">(</span>remove <span class="free">h</span> <span class="free">e</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>   
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="main">(</span>remove <span class="free">h</span> <span class="free">e</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="free">e</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> elx <span class="main">=</span> this
      <span class="keyword1"><span class="command">from</span></span> elx <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"remove <span class="free">h</span> <span class="free">e</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> T <span class="main">(</span>remove <span class="free">h</span> <span class="free">e</span> <span class="skolem">t1</span><span class="main">)</span> <span class="skolem">x</span> <span class="skolem">t2</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s sr1 s2 elx res<span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span> <span class="main">∈</span> setOf <span class="main">(</span>remove <span class="free">h</span> <span class="free">e</span> <span class="skolem">t1</span><span class="main">)</span><span class="main">.</span> <span class="free">h</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> setOf <span class="skolem">t2</span><span class="main">.</span> <span class="free">h</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="bound">r</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?C1</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">from</span></span> s1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"setOf <span class="main">(</span>remove <span class="free">h</span> <span class="free">e</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">=</span> setOf <span class="skolem">t1</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_set<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> s this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">from</span></span> o1 s <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C1</span> <span class="main">&amp;</span> <span class="var">?C2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> nelx <span class="main">=</span> this
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="free">e</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> xle <span class="main">=</span> this
        <span class="keyword1"><span class="command">from</span></span> xle <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"remove <span class="free">h</span> <span class="free">e</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="main">(</span>remove <span class="free">h</span> <span class="free">e</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s s1 sr2 xle nelx res<span class="main">)</span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span> <span class="main">∈</span> setOf <span class="skolem">t1</span><span class="main">.</span> <span class="free">h</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> setOf <span class="main">(</span>remove <span class="free">h</span> <span class="free">e</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">.</span> <span class="free">h</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="bound">r</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> o2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?C2</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">from</span></span> s2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"setOf <span class="main">(</span>remove <span class="free">h</span> <span class="free">e</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> setOf <span class="skolem">t2</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_set<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> s this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">from</span></span> o2 s <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C1</span> <span class="main">&amp;</span> <span class="var">?C2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> nxle <span class="main">=</span> this
        <span class="keyword1"><span class="command">from</span></span> nelx nxle <span class="keyword1"><span class="command">have</span></span> ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="free">e</span> <span class="main">=</span> <span class="free">h</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">=</span> Tip"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> t1tip <span class="main">=</span> this
          <span class="keyword1"><span class="command">from</span></span> ex t1tip <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"remove <span class="free">h</span> <span class="free">e</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> res t1tip ex s2<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> t1nTip <span class="main">=</span> this
          <span class="keyword1"><span class="command">from</span></span> nelx nxle ex t1nTip
          <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"remove <span class="free">h</span> <span class="free">e</span> <span class="main">(</span>T <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span>
                     T <span class="main">(</span>wrm <span class="free">h</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">(</span>rm <span class="free">h</span> <span class="skolem">t1</span><span class="main">)</span> <span class="skolem">t2</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def wrmrm_decomp<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> res <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="main">(</span>wrm <span class="free">h</span> <span class="skolem">t1</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span> <span class="main">∈</span> setOf <span class="main">(</span>wrm <span class="free">h</span> <span class="skolem">t1</span><span class="main">)</span><span class="main">.</span> <span class="free">h</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="main">(</span>rm <span class="free">h</span> <span class="skolem">t1</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C3</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> setOf <span class="skolem">t2</span><span class="main">.</span> <span class="free">h</span> <span class="main">(</span>rm <span class="free">h</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="bound">r</span>"</span></span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C4</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="skolem">t2</span>"</span></span>
            <span class="keyword1"><span class="command">from</span></span> s1 t1nTip <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?C1</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wrm_sort<span class="main">)</span>
            <span class="keyword1"><span class="command">from</span></span> s1 t1nTip <span class="keyword1"><span class="command">have</span></span> o2<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?C2</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wrm_less_rm<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> o3<span class="main">:</span> <span class="var"><span class="quoted"><span class="var">?C3</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> 
              <span class="keyword3"><span class="command">assume</span></span> rt2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">:</span> setOf <span class="skolem">t2</span>"</span></span>
              <span class="keyword1"><span class="command">from</span></span> s rm_set s1 t1nTip <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">(</span>rm <span class="free">h</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">from</span></span> rt2 s <span class="keyword1"><span class="command">have</span></span> o2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">from</span></span> o1 o2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">(</span>rm <span class="free">h</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">h</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">from</span></span> o1 o2 o3 s2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C1</span> <span class="main">&amp;</span> <span class="var">?C2</span> <span class="main">&amp;</span> <span class="var">?C3</span> <span class="main">&amp;</span> <span class="var">?C4</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We summarize the specification of remove as follows.›</span></span>
<span class="keyword1"><span class="command">corollary</span></span> remove_spec<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree <span class="free">h</span> <span class="free">t</span> <span class="main">--&gt;</span> 
     sortedTree <span class="free">h</span> <span class="main">(</span>remove <span class="free">h</span> <span class="free">e</span> <span class="free">t</span><span class="main">)</span> <span class="main">&amp;</span>
     setOf <span class="main">(</span>remove <span class="free">h</span> <span class="free">e</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> setOf <span class="free">t</span> <span class="main">-</span> eqs <span class="free">h</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_sort remove_set<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">test</span> <span class="main">=</span> tlookup id <span class="numeral">4</span> <span class="main">(</span>remove id <span class="numeral">3</span> <span class="main">(</span>binsert id <span class="numeral">4</span> <span class="main">(</span>binsert id <span class="numeral">3</span> Tip<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">test</span></span>
  <span class="keyword2"><span class="keyword">in</span></span> SML <span class="keyword2"><span class="keyword">module_name</span></span> BinaryTree_Code <span class="keyword2"><span class="keyword">file</span></span> <span class="quoted">‹BinaryTree_Code.ML›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="BinaryTree_Map">
<div class="head">
<h1>Theory BinaryTree_Map</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Binary Search Trees, Isar-Style
    Author:      Viktor Kuncak, MIT CSAIL, November 2003
    Maintainer:  Larry Paulson &lt;Larry.Paulson at cl.cam.ac.uk&gt;
    License:     LGPL
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Mostly Isar-style Reasoning for Binary Tree Operations›</span></span>
<span class="keyword1"><span class="command">theory</span></span> BinaryTree_Map <span class="keyword2"><span class="keyword">imports</span></span> <a href="BinaryTree.html">BinaryTree</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We prove correctness of map operations
 implemented using binary search trees from BinaryTree.

 This document is LGPL.

 Author: Viktor Kuncak, MIT CSAIL, November 2003›</span></span>


<span class="comment1">(*============================================================*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Map implementation and an abstraction function›</span></span>
<span class="comment1">(*============================================================*)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> 
  <span class="tfree">'a</span> tarray <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>index <span class="main">*</span> <span class="tfree">'a</span><span class="main">)</span> Tree"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">valid_tmap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tarray <span class="main">=&gt;</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid_tmap</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> sortedTree fst <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> valid_tmap_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mapOf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tarray <span class="main">=&gt;</span> index <span class="main">=&gt;</span> <span class="tfree">'a</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">― ‹the abstraction function from trees to maps›</span>
  <span class="quoted"><span class="quoted">"<span class="free">mapOf</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">==</span> 
   <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>tlookup fst <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
     None <span class="main">=&gt;</span> None
   <span class="main">|</span> Some <span class="bound">ia</span> <span class="main">=&gt;</span> Some <span class="main">(</span>snd <span class="bound">ia</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(*============================================================*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary Properties of our Implementation›</span></span>
<span class="comment1">(*============================================================*)</span>

<span class="keyword1"><span class="command">lemma</span></span> mapOf_lookup1<span class="main">:</span> <span class="quoted"><span class="quoted">"tlookup fst <span class="free">i</span> <span class="free">t</span> <span class="main">=</span> None <span class="main">==&gt;</span> mapOf <span class="free">t</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mapOf_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mapOf_lookup2<span class="main">:</span> <span class="quoted"><span class="quoted">"tlookup fst <span class="free">i</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">j</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="main">==&gt;</span> mapOf <span class="free">t</span> <span class="free">i</span> <span class="main">=</span> Some <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mapOf_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"mapOf <span class="free">t</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> mapOf_lookup3<span class="main">:</span> <span class="quoted"><span class="quoted">"tlookup fst <span class="free">i</span> <span class="free">t</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"tlookup fst <span class="free">i</span> <span class="free">t</span>"</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> None <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">ia</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> tsome <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"tlookup fst <span class="free">i</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span>fst <span class="skolem">ia</span><span class="main">,</span> snd <span class="skolem">ia</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mapOf <span class="free">t</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span>snd <span class="skolem">ia</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> mapOf_lookup2 <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="skolem"><span class="skolem"><span class="skolem">ia</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"snd <span class="skolem"><span class="skolem"><span class="skolem">ia</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o1<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mapOf <span class="free">t</span> <span class="free">i</span> <span class="main">~=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> this h <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="comment1">― ‹contradiction›</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_tmap <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"mapOf <span class="free">t</span> <span class="free">i</span> <span class="main">=</span> Some <span class="free">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> mapOf_lookup4<span class="main">:</span> <span class="quoted"><span class="quoted">"tlookup fst <span class="free">i</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"tlookup fst <span class="free">i</span> <span class="free">t</span>"</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> None 
  <span class="keyword1"><span class="command">from</span></span> this mapOf_lookup1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mapOf <span class="free">t</span> <span class="free">i</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this h <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="comment1">― ‹contradiction›</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">ia</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> tsome <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> tlookup_some_inst<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree fst <span class="free">t</span> <span class="main">&amp;</span> <span class="main">(</span>tlookup fst <span class="free">i</span> <span class="free">t</span> <span class="main">=</span> Some <span class="skolem">ia</span><span class="main">)</span> <span class="main">--&gt;</span> 
        <span class="skolem">ia</span> <span class="main">:</span> setOf <span class="free">t</span> <span class="main">&amp;</span> fst <span class="skolem">ia</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tlookup_some<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> tlookup_some_inst tsome v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">:</span> setOf <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> tsome <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mapOf <span class="free">t</span> <span class="free">i</span> <span class="main">=</span> Some <span class="main">(</span>snd <span class="skolem">ia</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mapOf_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this h <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">ia</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> tlookup_some_inst tsome v <span class="keyword1"><span class="command">have</span></span> o2<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">ia</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> o1 o2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ia</span> <span class="main">=</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this tsome <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"tlookup fst <span class="free">i</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lemmas <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>mapset_none›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>mapset_some›</span></span></span></span> establish 
              a relation between the set and map abstraction of the tree›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_tmap <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> mapset_none<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mapOf <span class="free">t</span> <span class="free">i</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="main">∉</span> setOf <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="comment1">― ‹==&gt;›</span>
  <span class="keyword3"><span class="command">assume</span></span> mapNone<span class="main">:</span> <span class="quoted"><span class="quoted">"mapOf <span class="free">t</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">from</span></span> v mapNone mapOf_lookup3 <span class="keyword1"><span class="command">have</span></span> lnone<span class="main">:</span> <span class="quoted"><span class="quoted">"tlookup fst <span class="free">i</span> <span class="free">t</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="main">∉</span> setOf <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span> <span class="main">~:</span> setOf <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> iain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span> <span class="main">:</span> setOf <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> tlookup_none_inst<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"sortedTree fst <span class="free">t</span> <span class="main">&amp;</span> <span class="main">(</span>tlookup fst <span class="free">i</span> <span class="free">t</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">--&gt;</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> setOf <span class="free">t</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">~=</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> tlookup_none <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"fst"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">t</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">i</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> v lnone tlookup_none_inst <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> setOf <span class="free">t</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">~=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> this iain <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span> <span class="main">~=</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="comment1">― ‹&lt;==›</span>
  <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">assume</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="main">∉</span> setOf <span class="free">t</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mapOf <span class="free">t</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mapOf <span class="free">t</span> <span class="free">i</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> None <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> mapsome <span class="main">=</span> this
    <span class="keyword1"><span class="command">from</span></span> v mapsome <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"tlookup fst <span class="free">i</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mapOf_lookup4<span class="main">)</span>
    <span class="comment1">(* moving mapOf_lookup4 to assumption does not work, although it uses
       no == !! *)</span>
    <span class="keyword1"><span class="command">from</span></span> tlookup_some <span class="keyword1"><span class="command">have</span></span> tlookup_some_inst<span class="main">:</span>
    <span class="quoted"><span class="quoted">"sortedTree fst <span class="free">t</span> <span class="main">&amp;</span> tlookup fst <span class="free">i</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span> <span class="main">--&gt;</span> 
     <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span> <span class="main">:</span> setOf <span class="free">t</span> <span class="main">&amp;</span> fst <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> tlookup_some <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">fst</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span><span class="free"><span class="free"><span class="free">i</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">a</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>   
    <span class="keyword1"><span class="command">from</span></span> v o1 this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span> <span class="main">:</span> setOf <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> this h <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="comment1">― ‹contradiction›</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_tmap <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> mapset_some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mapOf <span class="free">t</span> <span class="free">i</span> <span class="main">=</span> Some <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="main">:</span> setOf <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="comment1">― ‹==&gt;›</span>
  <span class="keyword3"><span class="command">assume</span></span> mapsome<span class="main">:</span> <span class="quoted"><span class="quoted">"mapOf <span class="free">t</span> <span class="free">i</span> <span class="main">=</span> Some <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> v mapsome <span class="keyword1"><span class="command">have</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"tlookup fst <span class="free">i</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mapOf_lookup4<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> tlookup_some <span class="keyword1"><span class="command">have</span></span> tlookup_some_inst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sortedTree fst <span class="free">t</span> <span class="main">&amp;</span> tlookup fst <span class="free">i</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="main">--&gt;</span> 
   <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="main">:</span> setOf <span class="free">t</span> <span class="main">&amp;</span> fst <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> tlookup_some <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">fst</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span><span class="free"><span class="free"><span class="free">i</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span><span class="free"><span class="free"><span class="free">a</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>   
  <span class="keyword1"><span class="command">from</span></span> v o1 this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="main">:</span> setOf <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="comment1">― ‹&lt;==›</span>
  <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">assume</span></span> iain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="main">:</span> setOf <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> v iain tlookup_finds <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tlookup fst <span class="main">(</span>fst <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tlookup fst <span class="free">i</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mapOf <span class="free">t</span> <span class="free">i</span> <span class="main">=</span> Some <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mapOf_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*============================================================*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Empty Map›</span></span>
<span class="comment1">(*============================================================*)</span>

<span class="keyword1"><span class="command">lemma</span></span> mnew_spec_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_tmap Tip"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mapOf_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mtip_spec_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"mapOf Tip <span class="free">k</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mapOf_def<span class="main">)</span>


<span class="comment1">(*============================================================*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Map Update Operation›</span></span>
<span class="comment1">(*============================================================*)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mupdate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"index <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> tarray <span class="main">=&gt;</span> <span class="tfree">'a</span> tarray"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mupdate</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> binsert fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_tmap <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> mupdate_map<span class="main">:</span> <span class="quoted"><span class="quoted">"mapOf <span class="main">(</span>mupdate <span class="free">i</span> <span class="free">a</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>mapOf <span class="free">t</span><span class="main">)</span><span class="main">(</span><span class="free">i</span> <span class="main">|-&gt;</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i2</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"binsert fst <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> upres<span class="main">:</span> <span class="quoted"><span class="quoted">"mupdate <span class="free">i</span> <span class="free">a</span> <span class="free">t</span> <span class="main">=</span> <span class="var">?tr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mupdate_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> v binsert_set 
  <span class="keyword1"><span class="command">have</span></span> setSpec<span class="main">:</span> <span class="quoted"><span class="quoted">"setOf <span class="var">?tr</span> <span class="main">=</span> setOf <span class="free">t</span> <span class="main">-</span> eqs fst <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="keyword1">Un</span> <span class="main">{</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> v binsert_sorted <span class="keyword1"><span class="command">have</span></span> vr<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_tmap <span class="var">?tr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mapOf <span class="main">(</span>mupdate <span class="free">i</span> <span class="free">a</span> <span class="free">t</span><span class="main">)</span> <span class="skolem">i2</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>mapOf <span class="free">t</span><span class="main">)</span><span class="main">(</span><span class="free">i</span> <span class="main">|-&gt;</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i2</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> i2ei <span class="main">=</span> this
    <span class="keyword1"><span class="command">from</span></span> i2ei <span class="keyword1"><span class="command">have</span></span> rhs_res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>mapOf <span class="free">t</span><span class="main">)</span><span class="main">(</span><span class="free">i</span> <span class="main">|-&gt;</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i2</span> <span class="main">=</span> Some <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> lhs_res<span class="main">:</span> <span class="quoted"><span class="quoted">"mapOf <span class="main">(</span>mupdate <span class="free">i</span> <span class="free">a</span> <span class="free">t</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> Some <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> will_find<span class="main">:</span> <span class="quoted"><span class="quoted">"tlookup fst <span class="free">i</span> <span class="var">?tr</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> setSpec <span class="keyword1"><span class="command">have</span></span> kvin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="main">:</span> setOf <span class="var">?tr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> binsert_sorted_inst<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree fst <span class="free">t</span> <span class="main">--&gt;</span> 
                                 sortedTree fst <span class="var">?tr</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> binsert_sorted <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"fst"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">t</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span><span class="free"><span class="free"><span class="free">i</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span><span class="free"><span class="free"><span class="free">a</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> v binsert_sorted_inst <span class="keyword1"><span class="command">have</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree fst <span class="var">?tr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> tlookup_finds_inst<span class="main">:</span> <span class="quoted"><span class="quoted">"sortedTree fst <span class="var">?tr</span> <span class="main">&amp;</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="main">:</span> setOf <span class="var">?tr</span> <span class="main">--&gt;</span> 
                                  tlookup fst <span class="free">i</span> <span class="var">?tr</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> tlookup_finds <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"fst"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var"><span class="var">?tr</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span><span class="free"><span class="free"><span class="free">i</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span><span class="free"><span class="free"><span class="free">a</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> rs kvin tlookup_finds_inst <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">from</span></span> upres will_find <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mapOf_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> lhs_res rhs_res i2ei <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> i2nei <span class="main">=</span> this
    <span class="keyword1"><span class="command">from</span></span> i2nei <span class="keyword1"><span class="command">have</span></span> rhs_res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>mapOf <span class="free">t</span><span class="main">)</span><span class="main">(</span><span class="free">i</span> <span class="main">|-&gt;</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i2</span> <span class="main">=</span> mapOf <span class="free">t</span> <span class="skolem">i2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> lhs_res<span class="main">:</span> <span class="quoted"><span class="quoted">"mapOf <span class="main">(</span>mupdate <span class="free">i</span> <span class="free">a</span> <span class="free">t</span><span class="main">)</span> <span class="skolem">i2</span> <span class="main">=</span> mapOf <span class="free">t</span> <span class="skolem">i2</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mapOf <span class="free">t</span> <span class="skolem">i2</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> mapNone<span class="main">:</span> <span class="quoted"><span class="quoted">"mapOf <span class="free">t</span> <span class="skolem">i2</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> v mapNone mapset_none <span class="keyword1"><span class="command">have</span></span> i2nin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="skolem">i2</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="main">∉</span> setOf <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">have</span></span> noneIn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">i2</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">∉</span> setOf <span class="var">?tr</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> 
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> 
        <span class="keyword1"><span class="command">from</span></span> v binsert_set 
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"setOf <span class="var">?tr</span> <span class="main">=</span> setOf <span class="free">t</span> <span class="main">-</span> eqs fst <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="keyword1">Un</span> <span class="main">{</span><span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">a</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">from</span></span> this i2nei i2nin <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i2</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">~:</span> setOf <span class="var">?tr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> mapset_none_inst<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"valid_tmap <span class="var">?tr</span> <span class="main">--&gt;</span> <span class="main">(</span>mapOf <span class="var">?tr</span> <span class="skolem">i2</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="skolem">i2</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∉</span> setOf <span class="var">?tr</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> mapset_none <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var"><span class="var">?tr</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i2</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> vr noneIn mapset_none_inst <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mapOf <span class="var">?tr</span> <span class="skolem">i2</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">from</span></span> this upres mapNone <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">z</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> mapSome<span class="main">:</span> <span class="quoted"><span class="quoted">"mapOf <span class="free">t</span> <span class="skolem">i2</span> <span class="main">=</span> Some <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> v mapSome mapset_some <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i2</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">:</span> setOf <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">from</span></span> this setSpec i2nei <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i2</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">:</span> setOf <span class="var">?tr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqs_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> this vr mapset_some <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mapOf <span class="var">?tr</span> <span class="skolem">i2</span> <span class="main">=</span> Some <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">from</span></span> this upres mapSome <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> lhs_res rhs_res <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_tmap <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> mupdate_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_tmap <span class="main">(</span>mupdate <span class="free">i</span> <span class="free">a</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"binsert fst <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">a</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> upres<span class="main">:</span> <span class="quoted"><span class="quoted">"mupdate <span class="free">i</span> <span class="free">a</span> <span class="free">t</span> <span class="main">=</span> <span class="var">?tr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mupdate_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> v binsert_sorted <span class="keyword1"><span class="command">have</span></span> vr<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_tmap <span class="var">?tr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> vr upres <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*============================================================*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Map Remove Operation›</span></span>
<span class="comment1">(*============================================================*)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mremove</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"index <span class="main">=&gt;</span> <span class="tfree">'a</span> tarray <span class="main">=&gt;</span> <span class="tfree">'a</span> tarray"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mremove</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> remove fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> undefined<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_tmap <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> mremove_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_tmap <span class="main">(</span>mremove <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mremove_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> v remove_sort 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sortedTree fst <span class="main">(</span>remove fst <span class="main">(</span><span class="free">i</span><span class="main">,</span> undefined<span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_tmap <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> mremove_map<span class="main">:</span> <span class="quoted"><span class="quoted">"mapOf <span class="main">(</span>mremove <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mremove_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"remove fst <span class="main">(</span><span class="free">i</span><span class="main">,</span> undefined<span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mapOf <span class="var">?tr</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> v remove_spec 
    <span class="keyword1"><span class="command">have</span></span> remSet<span class="main">:</span> <span class="quoted"><span class="quoted">"setOf <span class="var">?tr</span> <span class="main">=</span> setOf <span class="free">t</span> <span class="main">-</span> eqs fst <span class="main">(</span><span class="free">i</span><span class="main">,</span> undefined<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> noneIn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="main">∉</span> setOf <span class="var">?tr</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> 
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
      <span class="keyword1"><span class="command">from</span></span> remSet <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span> <span class="main">~:</span> setOf <span class="var">?tr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eqs_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> v remove_sort <span class="keyword1"><span class="command">have</span></span> vr<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_tmap <span class="var">?tr</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> mapset_none_inst<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_tmap <span class="var">?tr</span> <span class="main">==&gt;</span>
    <span class="main">(</span>mapOf <span class="var">?tr</span> <span class="free">i</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="main">∉</span> setOf <span class="var">?tr</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> mapset_none <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var"><span class="var">?tr</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">i</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> vr this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mapOf <span class="var">?tr</span> <span class="free">i</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span> <span class="main">∉</span> setOf <span class="var">?tr</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">from</span></span> this noneIn <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mapOf <span class="var">?tr</span> <span class="free">i</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>    
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="BinaryTree_TacticStyle">
<div class="head">
<h1>Theory BinaryTree_TacticStyle</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Binary Search Trees, Tactic-Style
    Author:      Viktor Kuncak, MIT CSAIL, November 2003
    Maintainer:  Larry Paulson &lt;Larry.Paulson at cl.cam.ac.uk&gt;
    License:     LGPL
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Tactic-Style Reasoning for Binary Tree Operations›</span></span>
<span class="keyword1"><span class="command">theory</span></span> BinaryTree_TacticStyle <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This example theory illustrates automated proofs of correctness
   for binary tree operations using tactic-style reasoning.
   The current proofs for remove operation are by Tobias Nipkow, 
   some modifications and the remaining tree operations are 
   by Viktor Kuncak.›</span></span>

<span class="comment1">(*============================================================*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Definition of a sorted binary tree›</span></span>
<span class="comment1">(*============================================================*)</span>

<span class="keyword1"><span class="command">datatype</span></span> tree <span class="main">=</span> Tip <span class="main">|</span> Nd <span class="quoted">tree</span> <span class="quoted">nat</span> <span class="quoted">tree</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">set_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tree <span class="main">=&gt;</span> nat set"</span></span>
<span class="comment1">― ‹The set of nodes stored in a tree.›</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">set_of</span> Tip <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">set_of</span><span class="main">(</span>Nd <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">set_of</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">Un</span> <span class="free">set_of</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>  <span class="keyword1">Un</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">sorted</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tree <span class="main">=&gt;</span> bool"</span></span>
<span class="comment1">― ‹Tree is sorted›</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sorted</span> Tip <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sorted</span><span class="main">(</span>Nd <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="free">sorted</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">&amp;</span> <span class="free">sorted</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set_of <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">&amp;</span> <span class="main">(</span><span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> set_of <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">&lt;</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(*============================================================*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Tree Membership›</span></span>
<span class="comment1">(*============================================================*)</span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">memb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">=&gt;</span> tree <span class="main">=&gt;</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">memb</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> Tip <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">memb</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>Nd <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> 
   <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="free">memb</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">then</span> <span class="free">memb</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>
    <span class="keyword1">else</span> True<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> member_set<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="free">t</span> <span class="main">--&gt;</span> memb <span class="free">e</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">e</span> <span class="main">:</span> set_of <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(*============================================================*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Insertion operation›</span></span>
<span class="comment1">(*============================================================*)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">binsert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">=&gt;</span> tree <span class="main">=&gt;</span> tree"</span></span>
<span class="comment1">― ‹Insert a node into sorted tree.›</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">binsert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> Tip <span class="main">=</span> <span class="main">(</span>Nd Tip <span class="free"><span class="bound"><span class="entity">x</span></span></span> Tip<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">binsert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Nd <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span>
                                 <span class="main">(</span>Nd <span class="main">(</span><span class="free">binsert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>
                             <span class="keyword1">else</span>
                               <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span>
                                 <span class="main">(</span>Nd <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span><span class="free">binsert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span>
                                <span class="keyword1">else</span> <span class="main">(</span>Nd <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> set_of_binsert <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set_of <span class="main">(</span>binsert <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> set_of <span class="free">t</span> <span class="keyword1">Un</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> binsert_sorted<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="free">t</span> <span class="main">--&gt;</span> sorted <span class="main">(</span>binsert <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_of_binsert<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> binsert_spec<span class="main">:</span>  <span class="comment1">(* summary specification of binsert *)</span>
<span class="quoted"><span class="quoted">"sorted <span class="free">t</span> <span class="main">==&gt;</span>
   sorted <span class="main">(</span>binsert <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">&amp;</span> 
   set_of <span class="main">(</span>binsert <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> set_of <span class="free">t</span> <span class="keyword1">Un</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binsert_sorted<span class="main">)</span>

<span class="comment1">(*============================================================*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Remove operation›</span></span>
<span class="comment1">(*============================================================*)</span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">rm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tree <span class="main">=&gt;</span> nat"</span></span> <span class="comment1">― ‹find the rightmost element in the tree›</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rm</span><span class="main">(</span>Nd <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Tip <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> <span class="free">rm</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">rem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tree <span class="main">=&gt;</span> tree"</span></span> <span class="comment1">― ‹find the tree without the rightmost element›</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rem</span><span class="main">(</span>Nd <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">=</span>Tip <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">else</span> Nd <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">rem</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">remove</span><span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">=&gt;</span> tree <span class="main">=&gt;</span> tree"</span></span> <span class="comment1">― ‹remove a node from sorted tree›</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remove</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> Tip <span class="main">=</span> Tip"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">remove</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Nd <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> Nd <span class="main">(</span><span class="free">remove</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span>
     <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> Nd <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span><span class="free">remove</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">else</span>
     <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> Tip <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
     <span class="keyword1">else</span> Nd <span class="main">(</span>rem <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>rm <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rm_in_set_of<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">~=</span> Tip <span class="main">==&gt;</span> rm <span class="free">t</span> <span class="main">:</span> set_of <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> set_of_rem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">~=</span> Tip <span class="main">==&gt;</span> set_of <span class="free">t</span> <span class="main">=</span> set_of<span class="main">(</span>rem <span class="free">t</span><span class="main">)</span> <span class="keyword1">Un</span> <span class="main">{</span>rm <span class="free">t</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="free">t</span> <span class="main">~=</span> Tip<span class="main">;</span> sorted <span class="free">t</span>  <span class="main">|]</span> <span class="main">==&gt;</span> sorted<span class="main">(</span>rem <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>set_of_rem<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_rem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[|</span> <span class="free">t</span> <span class="main">~=</span> Tip<span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> set_of<span class="main">(</span>rem <span class="free">t</span><span class="main">)</span><span class="main">;</span> sorted <span class="free">t</span> <span class="main">|]</span> <span class="main">==&gt;</span> <span class="free">x</span> <span class="main">&lt;</span> rm <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>set_of_rem <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> set_of_remove <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="free">t</span> <span class="main">==&gt;</span> set_of<span class="main">(</span>remove <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> set_of <span class="free">t</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>set_of_rem<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> remove_sorted<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="free">t</span> <span class="main">==&gt;</span> sorted<span class="main">(</span>remove <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> less_trans rm_in_set_of sorted_rem<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> remove_spec<span class="main">:</span> <span class="comment1">― ‹summary specification of remove›</span>
<span class="quoted"><span class="quoted">"sorted <span class="free">t</span> <span class="main">==&gt;</span>
   sorted <span class="main">(</span>remove <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">&amp;</span>
   set_of <span class="main">(</span>remove <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> set_of <span class="free">t</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_sorted<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally, note that rem and rm can be computed
        using a single tree traversal given by remrm.›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">remrm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tree <span class="main">=&gt;</span> tree <span class="main">*</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">remrm</span><span class="main">(</span>Nd <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">=</span>Tip <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">else</span>
                    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">r'</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">remrm</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">in</span> <span class="main">(</span>Nd <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">r'</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">~=</span> Tip <span class="main">==&gt;</span> remrm <span class="free">t</span> <span class="main">=</span> <span class="main">(</span>rem <span class="free">t</span><span class="main">,</span> rm <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can test this implementation by generating code.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">test</span> <span class="main">=</span> memb <span class="numeral">4</span> <span class="main">(</span>remove <span class="main">(</span><span class="numeral">3</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">(</span>binsert <span class="numeral">4</span> <span class="main">(</span>binsert <span class="numeral">3</span> Tip<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">test</span></span>
  <span class="keyword2"><span class="keyword">in</span></span> SML <span class="keyword2"><span class="keyword">module_name</span></span> BinaryTree_TacticStyle_Code <span class="keyword2"><span class="keyword">file</span></span> <span class="quoted">‹BinaryTree_TacticStyle_Code.ML›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>