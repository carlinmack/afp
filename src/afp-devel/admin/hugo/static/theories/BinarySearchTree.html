<div id="BinaryTree">
<div class="head"><h1>Theory BinaryTree</h1>
<span class="command">theory</span> <span class="name">BinaryTree</span><br/>
<span class="keyword">imports</span> <a href="../../HOL/HOL/Main.html"><span class="name">Main</span></a><br/>
</div>
<div class="source">
<pre class="source"><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*  Title:       Binary Search Trees, Isar-Style
    Author:      Viktor Kuncak, MIT CSAIL, November 2003
    Maintainer:  Larry Paulson &lt;Larry.Paulson at cl.cam.ac.uk&gt;
    License:     LGPL
*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">section</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹Isar-style Reasoning for Binary Tree Operations›</span></span></span><span>
</span><span class="keyword1"><span class="command">theory</span></span><span> </span><span>BinaryTree</span><span> </span><span class="keyword2"><span class="keyword">imports</span></span><span> </span><span>Main</span><span> </span><span class="keyword2"><span class="keyword">begin</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹We prove correctness of operations on 
 binary search tree implementing a set.

 This document is LGPL.

 Author: Viktor Kuncak, MIT CSAIL, November 2003›</span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*============================================================*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">section</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹Tree Definition›</span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*============================================================*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span class="tfree">'a</span><span> </span><span>Tree</span><span> </span><span class="delimiter">=</span><span> </span><span>Tip</span><span> </span><span class="delimiter">|</span><span> </span><span>T</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a Tree"</span></span></span><span> </span><span class="tfree">'a</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a Tree"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span>
</span><span>  </span><span>setOf</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a Tree =&gt; 'a set"</span></span></span><span> 
</span><span>  </span><span class="comment">― ‹set abstraction of a tree›</span><span> 
</span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">"setOf Tip = {}"</span></span></span><span>
</span><span class="delimiter">|</span><span> </span><span class="string"><span class="delete"><span class="delete">"setOf (T t1 x t2) = (setOf t1) Un (setOf t2) Un {x}"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span>
</span><span>  </span><span class="comment">― ‹we require index to have an irreflexive total order &lt;›</span><span>
</span><span>  </span><span class="comment">― ‹apart from that, we do not rely on index being int›</span><span>
</span><span>  </span><span>index</span><span> </span><span class="delimiter">=</span><span> </span><span>int</span><span> 
</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> </span><span class="comment">― ‹hash function type›</span><span>
</span><span>  </span><span class="tfree">'a</span><span> </span><span>hash</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a =&gt; index"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>eqs</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a hash =&gt; 'a =&gt; 'a set"</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="comment">― ‹equivalence class of elements with the same hash code›</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">"eqs h x == {y. h y = h x}"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span>
</span><span>  </span><span>sortedTree</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a hash =&gt; 'a Tree =&gt; bool"</span></span></span><span>
</span><span>  </span><span class="comment">― ‹check if a tree is sorted›</span><span>
</span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">"sortedTree h Tip = True"</span></span></span><span>
</span><span class="delimiter">|</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h (T t1 x t2) = 
    (sortedTree h t1 &amp; 
     (∀l ∈ setOf t1. h l &lt; h x) &amp;
     (∀r ∈ setOf t2. h x &lt; h r) &amp;
     sortedTree h t2)"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>sortLemmaL</span><span class="delimiter">:</span><span> 
</span><span>  </span><span class="string"><span class="delete"><span class="delete">"sortedTree h (T t1 x t2) ==&gt; sortedTree h t1"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>sortLemmaR</span><span class="delimiter">:</span><span> 
</span><span>  </span><span class="string"><span class="delete"><span class="delete">"sortedTree h (T t1 x t2) ==&gt; sortedTree h t2"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*============================================================*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">section</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹Tree Lookup›</span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*============================================================*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span>
</span><span>  </span><span>tlookup</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a hash =&gt; index =&gt; 'a Tree =&gt; 'a option"</span></span></span><span>
</span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">"tlookup h k Tip = None"</span></span></span><span>
</span><span class="delimiter">|</span><span> </span><span class="string"><span class="delete"><span class="delete">"tlookup h k (T t1 x t2) = 
   (if k &lt; h x then tlookup h k t1
    else if h x &lt; k then tlookup h k t2
    else Some x)"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>tlookup_none</span><span class="delimiter">:</span><span> 
</span><span>     </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t &amp; (tlookup h k t = None) --&gt; (∀x∈setOf t. h x ~= k)"</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>induct</span><span> </span><span>t</span><span class="delimiter">,</span><span> </span><span>auto</span><span class="delimiter">)</span><span> 
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>tlookup_some</span><span class="delimiter">:</span><span>
</span><span>     </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t &amp; (tlookup h k t = Some x) --&gt; x:setOf t &amp; h x = k"</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>induct</span><span> </span><span>t</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="comment">― ‹Just auto will do it, but very slowly›</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>clarify</span><span class="delimiter">,</span><span> </span><span>auto</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>simp_all</span><span> </span><span>split</span><span class="delimiter">:</span><span> </span><span>if_split_asm</span><span class="delimiter">)</span><span> 
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>sorted_distinct_pred</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a hash =&gt; 'a =&gt; 'a =&gt; 'a Tree =&gt; bool"</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="comment">― ‹No two elements have the same hash code›</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">"sorted_distinct_pred h a b t == sortedTree h t &amp; 
      a:setOf t &amp; b:setOf t &amp; h a = h b --&gt; 
      a = b"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">declare</span></span><span> </span><span>sorted_distinct_pred_def</span><span> </span><span class="delimiter">[</span><span>simp</span><span class="delimiter">]</span><span>
</span><span>
</span><span class="comment">― ‹for case analysis on three cases›</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>cases3</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"[| C1 ==&gt; G; C2 ==&gt; G; C3 ==&gt; G;
                  C1 | C2 | C3 |] ==&gt; G"</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹@{term sorted_distinct_pred} holds for out trees:›</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>sorted_distinct</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sorted_distinct_pred h a b t"</span></span></span><span> </span><span class="delimiter">(</span><span class="keyword2"><span class="keyword">is</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"?P t"</span></span></span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>induct</span><span> </span><span>t</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"?P Tip"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>t1</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a Tree"</span></span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>h1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"?P t1"</span></span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>t2</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a Tree"</span></span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>h2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"?P t2"</span></span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>x</span><span> </span><span class="delimiter">::</span><span> </span><span class="tfree">'a</span><span>
</span><span>  </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"?P (T t1 x t2)"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>unfold</span><span> </span><span>sorted_distinct_pred_def</span><span class="delimiter">,</span><span> </span><span>safe</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>s</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h (T t1 x t2)"</span></span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>adef</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"a : setOf (T t1 x t2)"</span></span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>bdef</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"b : setOf (T t1 x t2)"</span></span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>hahb</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h a = h b"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>s1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t1"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>s2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t2"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"a = b"</span></span></span><span>
</span><span>    </span><span class="comment">― ‹We consider 9 cases for the position of a and b are in the tree›</span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>    </span><span class="comment">― ‹three cases for a›</span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>adef</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"a : setOf t1 | a = x | a : setOf t2"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>adef1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"a : setOf t1"</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span>
</span><span>      </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span> 
</span><span>      </span><span class="comment">― ‹three cases for b›</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>bdef</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"b : setOf t1 | b = x | b : setOf t2"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>bdef1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"b : setOf t1"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s1</span><span> </span><span>adef1</span><span> </span><span>bdef1</span><span> </span><span>hahb</span><span> </span><span>h1</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>bdef1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"b = x"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>adef1</span><span> </span><span>bdef1</span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"h a &lt; h b"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span>hahb</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>bdef1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"b : setOf t2"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>adef1</span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h a &lt; h x"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>bdef1</span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h x &lt; h b"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>o1</span><span> </span><span>o2</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"h a &lt; h b"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span>hahb</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="comment">― ‹case impossible›</span><span>
</span><span>      </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>      </span><span class="keyword1"><span class="command">qed</span></span><span> 
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span> 
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>adef1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"a = x"</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> 
</span><span>      </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>      </span><span class="comment">― ‹three cases for b›</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>bdef</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"b : setOf t1 | b = x | b : setOf t2"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>bdef1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"b : setOf t1"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"h b &lt; h x"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span>adef1</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"h b &lt; h a"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>hahb</span><span> </span><span>this</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="comment">― ‹case impossible›</span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>bdef1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"b = x"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>adef1</span><span> </span><span>bdef1</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>bdef1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"b : setOf t2"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"h x &lt; h b"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span>adef1</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"h a &lt; h b"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>hahb</span><span> </span><span>this</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="comment">― ‹case impossible›</span><span>
</span><span>      </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>      </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>adef1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"a : setOf t2"</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span>
</span><span>      </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>      </span><span class="comment">― ‹three cases for b›</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>bdef</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"b : setOf t1 | b = x | b : setOf t2"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>bdef1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"b : setOf t1"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>bdef1</span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h b &lt; h x"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>adef1</span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h x &lt; h a"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>o1</span><span> </span><span>o2</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"h b &lt; h a"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span>hahb</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="comment">― ‹case impossible›</span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>bdef1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"b = x"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>adef1</span><span> </span><span>bdef1</span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"h b &lt; h a"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span>hahb</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">}</span></span><span> </span><span class="comment">― ‹case impossible›</span><span>
</span><span>      </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">{</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>bdef1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"b : setOf t2"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s2</span><span> </span><span>adef1</span><span> </span><span>bdef1</span><span> </span><span>hahb</span><span> </span><span>h2</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span> </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>      </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">}</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>blast</span><span>
</span><span>    </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>tlookup_finds</span><span class="delimiter">:</span><span> </span><span class="comment">― ‹if a node is in the tree, lookup finds it›</span><span>
</span><span class="string"><span class="delete"><span class="delete">"sortedTree h t &amp; y:setOf t --&gt; 
 tlookup h (h y) t = Some y"</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>safe</span><span>
</span><span>  </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>s</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t"</span></span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>yint</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"y : setOf t"</span></span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"tlookup h (h y) t = Some y"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">"tlookup h (h y) t"</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>None</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>res</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>    
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span>res</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t &amp; (tlookup h (h y) t = None)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"∀x∈setOf t. h x ~= h y"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>tlookup_none</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>o1</span><span> </span><span>yint</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"h y ~= h y"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* auto does not work *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">next</span></span><span> </span><span class="keyword3"><span class="command">case</span></span><span> </span><span class="delimiter">(</span><span>Some</span><span> </span><span>z</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>res</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>ls</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t &amp; (tlookup h (h y) t = Some z) --&gt;
              z:setOf t &amp; h z = h y"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>tlookup_some</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>sd</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sorted_distinct_pred h y z t"</span></span></span><span> 
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>insert</span><span> </span><span>sorted_distinct</span><span> </span><span class="delimiter">[</span><span>of</span><span> </span><span>h</span><span> </span><span>y</span><span> </span><span>z</span><span> </span><span>t</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>simp</span><span class="delimiter">)</span><span> 
</span><span>       </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* for some reason simplifier would never guess this substitution *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span>res</span><span> </span><span>ls</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"z:setOf t &amp; h z = h y"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span>yint</span><span> </span><span>o1</span><span> </span><span>sd</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"y = z"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span>res</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"tlookup h (h y) t = Some y"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹Tree membership as a special case of lookup›</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>memb</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a hash =&gt; 'a =&gt; 'a Tree =&gt; bool"</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">"memb h x t == 
   (case (tlookup h (h x) t) of
      None =&gt; False
    | Some z =&gt; (x=z))"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>s</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t"</span></span></span><span> 
</span><span>      </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span>memb_spec</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"memb h x t = (x : setOf t)"</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">"tlookup h (h x) t"</span></span></span><span class="delimiter">)</span><span>
</span><span class="keyword3"><span class="command">case</span></span><span> </span><span>None</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>tNone</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>tNone</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"memb h x t = False"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>memb_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span>tNone</span><span> </span><span>tlookup_none</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"∀y∈setOf t. h y ~= h x"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>notIn</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"x ~: setOf t"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>h</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"x : setOf t"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>h</span><span> </span><span>o1</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"h x ~= h x"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span>False</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>res</span><span> </span><span>notIn</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command">next</span></span><span> </span><span class="keyword3"><span class="command">case</span></span><span> </span><span class="delimiter">(</span><span>Some</span><span> </span><span>z</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>tSome</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span>tSome</span><span> </span><span>tlookup_some</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>zin</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"z : setOf t"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">"x=z"</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>True</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>xez</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>tSome</span><span> </span><span>xez</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"memb h x t"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>memb_def</span><span class="delimiter">)</span><span>  
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>res</span><span> </span><span>zin</span><span> </span><span>xez</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">next</span></span><span> </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>False</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>xnez</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>tSome</span><span> </span><span>xnez</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"~ memb h x t"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>memb_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"x ~: setOf t"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span>
</span><span>      </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>xin</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"x : setOf t"</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span>tSome</span><span> </span><span>tlookup_some</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>hzhx</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h x = h z"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sorted_distinct_pred h x z t"</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>insert</span><span> </span><span>sorted_distinct</span><span> </span><span class="delimiter">[</span><span>of</span><span> </span><span>h</span><span> </span><span>x</span><span> </span><span>z</span><span> </span><span>t</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>simp</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span>xin</span><span> </span><span>zin</span><span> </span><span>hzhx</span><span> </span><span>o1</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"x = z"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span>xnez</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span>False</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">qed</span></span><span>  
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span>res</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">declare</span></span><span> </span><span>sorted_distinct_pred_def</span><span> </span><span class="delimiter">[</span><span>simp</span><span> </span><span>del</span><span class="delimiter">]</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*============================================================*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">section</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹Insertion into a Tree›</span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*============================================================*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span>
</span><span>  </span><span>binsert</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a hash =&gt; 'a =&gt; 'a Tree =&gt; 'a Tree"</span></span></span><span>
</span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">"binsert h e Tip = (T Tip e Tip)"</span></span></span><span>
</span><span class="delimiter">|</span><span> </span><span class="string"><span class="delete"><span class="delete">"binsert h e (T t1 x t2) = (if h e &lt; h x then
                             (T (binsert h e t1) x t2)
                            else
                             (if h x &lt; h e then
                               (T t1 x (binsert h e t2))
                              else (T t1 e t2)))"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹A technique for proving disjointness of sets.›</span></span></span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>disjCond</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"[| !! x. [| x:A; x:B |] ==&gt; False |] ==&gt; A Int B = {}"</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹The following is a proof that insertion correctly implements
        the set interface.
        Compared to ‹BinaryTree_TacticStyle›, the claim is more
        difficult, and this time we need to assume as a hypothesis
        that the tree is sorted.›</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>binsert_set</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t --&gt;
                    setOf (binsert h e t) = (setOf t) - (eqs h e) Un {e}"</span></span></span><span> 
</span><span>      </span><span class="delimiter">(</span><span class="keyword2"><span class="keyword">is</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"?P t"</span></span></span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>induct</span><span> </span><span>t</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="comment">― ‹base case›</span><span>
</span><span>  </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"?P Tip"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>eqs_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="comment">― ‹inductition step›</span><span>
</span><span>  </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>t1</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a Tree"</span></span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>h1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"?P t1"</span></span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>t2</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a Tree"</span></span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>h2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"?P t2"</span></span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>x</span><span> </span><span class="delimiter">::</span><span> </span><span class="tfree">'a</span><span>
</span><span>  </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"?P (T t1 x t2)"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span> 
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>s</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h (T t1 x t2)"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>s1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t1"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>sortLemmaL</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s1</span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>h1</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>c1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"setOf (binsert h e t1) = setOf t1 - eqs h e Un {e}"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>s2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t2"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>sortLemmaR</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s2</span><span> </span><span class="keyword2"><span class="keyword">and</span></span><span> </span><span>h2</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>c2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"setOf (binsert h e t2) = setOf t2 - eqs h e Un {e}"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"setOf (binsert h e (T t1 x t2)) = 
          setOf (T t1 x t2) - eqs h e Un {e}"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">"h e &lt; h x"</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>True</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>eLess</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>eLess</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"binsert h e (T t1 x t2) = (T (binsert h e t1) x t2)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"setOf (binsert h e (T t1 x t2)) = 
              setOf (T t1 x t2) - eqs h e Un {e}"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>res</span><span> </span><span>eLess</span><span> </span><span>c1</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"insert x (insert e (setOf t1 - eqs h e Un setOf t2)) = 
                insert e (insert x (setOf t1 Un setOf t2) - eqs h e)"</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>            </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eqsLessX</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"∀el ∈ eqs h e. h el &lt; h x"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>eqs_def</span><span> </span><span>eLess</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eqsDisjX</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"∀el ∈ eqs h e. h el ~= h x"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>            </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>xLessT2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"∀r ∈ setOf t2. h x &lt; h r"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>            </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eqsLessT2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"∀el ∈ eqs h e. ∀r ∈ setOf t2. h el &lt; h r"</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>safe</span><span>
</span><span>              </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>el</span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>hel</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"el : eqs h e"</span></span></span><span>
</span><span>              </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>hel</span><span> </span><span>eqs_def</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h el = h e"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* auto fails here! *)</span></span></span></span></span><span>
</span><span>              </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>r</span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>hr</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"r : setOf t2"</span></span></span><span>
</span><span>              </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>xLessT2</span><span> </span><span>hr</span><span> </span><span>o1</span><span> </span><span>eLess</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"h el &lt; h r"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>            </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>eqsLessT2</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eqsDisjT2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"∀el ∈ eqs h e. ∀r ∈ setOf t2. h el ~= h r"</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* auto fails here *)</span></span></span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>eqsDisjX</span><span> </span><span>eqsDisjT2</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>          </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">next</span></span><span> </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>False</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>eNotLess</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>      </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"setOf (binsert h e (T t1 x t2)) = setOf (T t1 x t2) - eqs h e Un {e}"</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">"h x &lt; h e"</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>True</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>xLess</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>xLess</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"binsert h e (T t1 x t2) = (T t1 x (binsert h e t2))"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"setOf (binsert h e (T t1 x t2)) = 
              setOf (T t1 x t2) - eqs h e Un {e}"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>res</span><span> </span><span>xLess</span><span> </span><span>eNotLess</span><span> </span><span>c2</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"insert x (insert e (setOf t1 Un (setOf t2 - eqs h e))) = 
                insert e (insert x (setOf t1 Un setOf t2) - eqs h e)"</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>            </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>XLessEqs</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"∀el ∈ eqs h e. h x &lt; h el"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>eqs_def</span><span> </span><span>xLess</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eqsDisjX</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"∀el ∈ eqs h e. h el ~= h x"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>            </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>t1LessX</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"∀l ∈ setOf t1. h l &lt; h x"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>            </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>T1lessEqs</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"∀el ∈ eqs h e. ∀l ∈ setOf t1. h l &lt; h el"</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>safe</span><span>
</span><span>              </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>el</span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>hel</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"el : eqs h e"</span></span></span><span>
</span><span>              </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>l</span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>hl</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"l : setOf t1"</span></span></span><span>
</span><span>              </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>hel</span><span> </span><span>eqs_def</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h el = h e"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* auto fails here! *)</span></span></span></span></span><span>
</span><span>              </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>t1LessX</span><span> </span><span>hl</span><span> </span><span>o1</span><span> </span><span>xLess</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"h l &lt; h el"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>            </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>T1lessEqs</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>T1disjEqs</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"∀el ∈ eqs h e. ∀l ∈ setOf t1. h el ~= h l"</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>            </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>eqsDisjX</span><span> </span><span>T1lessEqs</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">qed</span></span><span>      
</span><span>      </span><span class="keyword1"><span class="command">next</span></span><span> </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>False</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>xNotLess</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>xNotLess</span><span> </span><span>eNotLess</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>xeqe</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h x = h e"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>xeqe</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"binsert h e (T t1 x t2) = (T t1 e t2)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"setOf (binsert h e (T t1 x t2)) = 
              setOf (T t1 x t2) - eqs h e Un {e}"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>res</span><span> </span><span>eNotLess</span><span> </span><span>xeqe</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"insert e (setOf t1 Un setOf t2) = 
                insert e (insert x (setOf t1 Un setOf t2) - eqs h e)"</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>            </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"insert x (setOf t1 Un setOf t2) - eqs h e = 
                  setOf t1 Un setOf t2"</span></span></span><span> 
</span><span>            </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>              </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* o1: *)</span></span></span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"x : eqs h e"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>eqs_def</span><span> </span><span>xeqe</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* o2: *)</span></span></span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"(setOf t1) Int (eqs h e) = {}"</span></span></span><span>
</span><span>              </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjCond</span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>w</span><span>
</span><span>                </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>whSet</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"w : setOf t1"</span></span></span><span>
</span><span>                </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>whEq</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"w : eqs h e"</span></span></span><span>
</span><span>                </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>whSet</span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h w &lt; h x"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>                </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>whEq</span><span> </span><span>eqs_def</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h w = h e"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>                </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>o2</span><span> </span><span>xeqe</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o3</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"~ h w &lt; h x"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>                </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>o1</span><span> </span><span>o3</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span>False</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>contradiction</span><span>
</span><span>              </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>              </span><span class="keyword1"><span class="command">moreover</span></span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* o3: *)</span></span></span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"(setOf t2) Int (eqs h e) = {}"</span></span></span><span>
</span><span>              </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjCond</span><span class="delimiter">)</span><span>
</span><span>                </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>w</span><span>
</span><span>                </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>whSet</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"w : setOf t2"</span></span></span><span>
</span><span>                </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>whEq</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"w : eqs h e"</span></span></span><span>
</span><span>                </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>whSet</span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h x &lt; h w"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>                </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>whEq</span><span> </span><span>eqs_def</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h w = h e"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>                </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>o2</span><span> </span><span>xeqe</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o3</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"~ h x &lt; h w"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>                </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>o1</span><span> </span><span>o3</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span>False</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>contradiction</span><span>
</span><span>              </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>              </span><span class="keyword1"><span class="command">ultimately</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>            </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>          </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹Using the correctness of set implementation,
        preserving sortedness is still simple.›</span></span></span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>binsert_sorted</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t --&gt; sortedTree h (binsert h x t)"</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>induct</span><span> </span><span>t</span><span class="delimiter">)</span><span> </span><span class="delimiter">(</span><span>auto</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>binsert_set</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹We summarize the specification of binsert as follows.›</span></span></span><span>
</span><span class="keyword1"><span class="command">corollary</span></span><span> </span><span>binsert_spec</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t --&gt;
                     sortedTree h (binsert h x t) &amp;
                     setOf (binsert h e t) = (setOf t) - (eqs h e) Un {e}"</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>binsert_set</span><span> </span><span>binsert_sorted</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*============================================================*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">section</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹Removing an element from a tree›</span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*============================================================*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹These proofs are influenced by those in ‹BinaryTree_Tactic››</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span>
</span><span>  </span><span>rm</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a hash =&gt; 'a Tree =&gt; 'a"</span></span></span><span>
</span><span>  </span><span class="comment">― ‹rightmost element of a tree›</span><span>
</span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span class="string"><span class="delete"><span class="delete">"rm h (T t1 x t2) =
  (if t2=Tip then x else rm h t2)"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span>
</span><span>  </span><span>wrm</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a hash =&gt; 'a Tree =&gt; 'a Tree"</span></span></span><span>
</span><span>  </span><span class="comment">― ‹tree without the rightmost element›</span><span>
</span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span class="string"><span class="delete"><span class="delete">"wrm h (T t1 x t2) =
  (if t2=Tip then t1 else (T t1 x (wrm h t2)))"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span>
</span><span>  </span><span>wrmrm</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a hash =&gt; 'a Tree =&gt; 'a Tree * 'a"</span></span></span><span>
</span><span>  </span><span class="comment">― ‹computing rightmost and removal in one pass›</span><span>
</span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span class="string"><span class="delete"><span class="delete">"wrmrm h (T t1 x t2) =
  (if t2=Tip then (t1,x)
   else (T t1 x (fst (wrmrm h t2)),
         snd (wrmrm h t2)))"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span>
</span><span>  </span><span>remove</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a hash =&gt; 'a =&gt; 'a Tree =&gt; 'a Tree"</span></span></span><span>
</span><span>   </span><span class="comment">― ‹removal of an element from the tree›</span><span>
</span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">"remove h e Tip = Tip"</span></span></span><span>
</span><span class="delimiter">|</span><span> </span><span class="string"><span class="delete"><span class="delete">"remove h e (T t1 x t2) = 
    (if h e &lt; h x then (T (remove h e t1) x t2)
     else if h x &lt; h e then (T t1 x (remove h e t2))
     else (if t1=Tip then t2
           else let (t1p,r) = wrmrm h t1
                in (T t1p r t2)))"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">theorem</span></span><span> </span><span>wrmrm_decomp</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"t ~= Tip --&gt; wrmrm h t = (wrm h t, rm h t)"</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>induct_tac</span><span> </span><span>t</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp_all</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>rm_set</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"t ~= Tip &amp; sortedTree h t --&gt; rm h t : setOf t"</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span class="delimiter">(</span><span>induct_tac</span><span> </span><span>t</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp_all</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>wrm_set</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"t ~= Tip &amp; sortedTree h t --&gt; 
                setOf (wrm h t) = setOf t - {rm h t}"</span></span></span><span> </span><span class="delimiter">(</span><span class="keyword2"><span class="keyword">is</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"?P t"</span></span></span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>induct</span><span> </span><span>t</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"?P Tip"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>t1</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a Tree"</span></span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>h1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"?P t1"</span></span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>t2</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a Tree"</span></span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>h2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"?P t2"</span></span></span><span> 
</span><span>  </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>x</span><span> </span><span class="delimiter">::</span><span> </span><span class="tfree">'a</span><span>
</span><span>  </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"?P (T t1 x t2)"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">,</span><span> </span><span>erule</span><span> </span><span>conjE</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>s</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h (T t1 x t2)"</span></span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"setOf (wrm h (T t1 x t2)) = 
          setOf (T t1 x t2) - {rm h (T t1 x t2)}"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">"t2 = Tip"</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>True</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>t2tip</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>t2tip</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>rm_res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"rm h (T t1 x t2) = x"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>t2tip</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>wrm_res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"wrm h (T t1 x t2) = t1"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"x ~: setOf t1"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span>rm_res</span><span> </span><span>wrm_res</span><span> </span><span>t2tip</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">next</span></span><span> </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>False</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>t2nTip</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>t2nTip</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>rm_res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"rm h (T t1 x t2) = rm h t2"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>t2nTip</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>wrm_res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"wrm h (T t1 x t2) = T t1 x (wrm h t2)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>s2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t2"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>    
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>h2</span><span> </span><span>t2nTip</span><span> </span><span>s2</span><span> 
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"setOf (wrm h t2) = setOf t2 - {rm h t2}"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span>
</span><span>      </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>rm_res</span><span> </span><span>wrm_res</span><span> </span><span>t2nTip</span><span> </span><span>h2</span><span> </span><span>o1</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"insert x (setOf t1 Un (setOf t2 - {rm h t2})) = 
              insert x (setOf t1 Un setOf t2) - {rm h t2}"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>          </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span>rm_set</span><span> </span><span>t2nTip</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>xOk</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h x &lt; h (rm h t2)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span> 
</span><span>          </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>t1Ok</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"∀l ∈ setOf t1. h l &lt; h (rm h t2)"</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>safe</span><span>
</span><span>            </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>l</span><span> </span><span class="delimiter">::</span><span> </span><span class="tfree">'a</span><span>  </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>ldef</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"l : setOf t1"</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>ldef</span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>lx</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h l &lt; h x"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>            </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>lx</span><span> </span><span>xOk</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"h l &lt; h (rm h t2)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>xOk</span><span> </span><span>t1Ok</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>wrm_set1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"t ~= Tip &amp; sortedTree h t --&gt; setOf (wrm h t) &lt;= setOf t"</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>auto</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>wrm_set</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>wrm_sort</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"t ~= Tip &amp; sortedTree h t --&gt; sortedTree h (wrm h t)"</span></span></span><span> </span><span class="delimiter">(</span><span class="keyword2"><span class="keyword">is</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"?P t"</span></span></span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>induct</span><span> </span><span>t</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"?P Tip"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>  
</span><span>  </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>t1</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a Tree"</span></span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>h1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"?P t1"</span></span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>t2</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a Tree"</span></span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>h2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"?P t2"</span></span></span><span> 
</span><span>  </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>x</span><span> </span><span class="delimiter">::</span><span> </span><span class="tfree">'a</span><span>
</span><span>  </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"?P (T t1 x t2)"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>safe</span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>s</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h (T t1 x t2)"</span></span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h (wrm h (T t1 x t2))"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">"t2 = Tip"</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>True</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>t2tip</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>t2tip</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"wrm h (T t1 x t2) = t1"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>res</span><span> </span><span>s</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">next</span></span><span> </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>False</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>t2nTip</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>t2nTip</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"wrm h (T t1 x t2) = T t1 x (wrm h t2)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>s1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t1"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>s2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t2"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s2</span><span> </span><span>h2</span><span> </span><span>t2nTip</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h (wrm h t2)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s2</span><span> </span><span>t2nTip</span><span> </span><span>wrm_set1</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"setOf (wrm h t2) &lt;= setOf t2"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span>o2</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o3</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"∀r ∈ setOf (wrm h t2). h x &lt; h r"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s1</span><span> </span><span>o1</span><span> </span><span>o3</span><span> </span><span>res</span><span> </span><span>s</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h (wrm h (T t1 x t2))"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>wrm_less_rm</span><span class="delimiter">:</span><span> 
</span><span>  </span><span class="string"><span class="delete"><span class="delete">"t ~= Tip &amp; sortedTree h t --&gt; 
   (∀l ∈ setOf (wrm h t). h l &lt; h (rm h t))"</span></span></span><span> </span><span class="delimiter">(</span><span class="keyword2"><span class="keyword">is</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"?P t"</span></span></span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>induct</span><span> </span><span>t</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"?P Tip"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>t1</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a Tree"</span></span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>h1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"?P t1"</span></span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>t2</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a Tree"</span></span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>h2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"?P t2"</span></span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>x</span><span> </span><span class="delimiter">::</span><span> </span><span class="tfree">'a</span><span>   
</span><span>  </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"?P (T t1 x t2)"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>safe</span><span> 
</span><span>    </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>l</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a"</span></span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>ldef</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"l : setOf (wrm h (T t1 x t2))"</span></span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>s</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h (T t1 x t2)"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>s1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t1"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>s2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t2"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"h l &lt; h (rm h (T t1 x t2))"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">"t2 = Tip"</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>True</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>t2tip</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>t2tip</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>rm_res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"rm h (T t1 x t2) = x"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>t2tip</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>wrm_res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"wrm h (T t1 x t2) = t1"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>ldef</span><span> </span><span>wrm_res</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"l : setOf t1"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>rm_res</span><span> </span><span>o1</span><span> </span><span>s</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">next</span></span><span> </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>False</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>t2nTip</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>t2nTip</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>rm_res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"rm h (T t1 x t2) = rm h t2"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>t2nTip</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>wrm_res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"wrm h (T t1 x t2) = T t1 x (wrm h t2)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>ldef</span><span> </span><span>wrm_res</span><span> 
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>l_scope</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"l : {x} Un setOf t1 Un setOf (wrm h t2)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>hLess</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h l &lt; h (rm h t2)"</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">"l = x"</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>True</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>lx</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span>t2nTip</span><span> </span><span>rm_set</span><span> </span><span>s2</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h x &lt; h (rm h t2)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>lx</span><span> </span><span>o1</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">next</span></span><span> </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>False</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>lnx</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>        </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span>
</span><span>        </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">"l : setOf t1"</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>True</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>l_in_t1</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>          </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span>t2nTip</span><span> </span><span>rm_set</span><span> </span><span>s2</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h x &lt; h (rm h t2)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>l_in_t1</span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h l &lt; h x"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>o1</span><span> </span><span>o2</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword1"><span class="command">next</span></span><span> </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>False</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>l_notin_t1</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>          </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>l_scope</span><span> </span><span>lnx</span><span> </span><span>l_notin_t1</span><span> 
</span><span>          </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>l_in_res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"l : setOf (wrm h t2)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>l_in_res</span><span> </span><span>h2</span><span> </span><span>t2nTip</span><span> </span><span>s2</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>rm_res</span><span> </span><span>hLess</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>remove_set</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t --&gt; 
  setOf (remove h e t) = setOf t - eqs h e"</span></span></span><span> </span><span class="delimiter">(</span><span class="keyword2"><span class="keyword">is</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"?P t"</span></span></span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>induct</span><span> </span><span>t</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"?P Tip"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>t1</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a Tree"</span></span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>h1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"?P t1"</span></span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>t2</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a Tree"</span></span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>h2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"?P t2"</span></span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>x</span><span> </span><span class="delimiter">::</span><span> </span><span class="tfree">'a</span><span>
</span><span>  </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"?P (T t1 x t2)"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span> 
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>s</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h (T t1 x t2)"</span></span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"setOf (remove h e (T t1 x t2)) = setOf (T t1 x t2) - eqs h e"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">"h e &lt; h x"</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>True</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>elx</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>elx</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"remove h e (T t1 x t2) = T (remove h e t1) x t2"</span></span></span><span> 
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>s1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t1"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s1</span><span> </span><span>h1</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"setOf (remove h e t1) = setOf t1 - eqs h e"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span>
</span><span>      </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>o1</span><span> </span><span>elx</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"insert x (setOf t1 - eqs h e Un setOf t2) = 
              insert x (setOf t1 Un setOf t2) - eqs h e"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>          </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>xOk</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"x ~: eqs h e"</span></span></span><span> 
</span><span>          </span><span class="keyword1"><span class="command">proof</span></span><span> 
</span><span>            </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>h</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"x : eqs h e"</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>h</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"~ (h e &lt; h x)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>eqs_def</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>elx</span><span> </span><span>o1</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"False"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>contradiction</span><span>
</span><span>          </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>t2Ok</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"(setOf t2) Int (eqs h e) = {}"</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjCond</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>y</span><span> </span><span class="delimiter">::</span><span> </span><span class="tfree">'a</span><span> 
</span><span>            </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>y_in_t2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"y : setOf t2"</span></span></span><span>
</span><span>            </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>y_in_eq</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"y : eqs h e"</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>y_in_t2</span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>xly</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h x &lt; h y"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>            </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>y_in_eq</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eey</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h y = h e"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>eqs_def</span><span class="delimiter">)</span><span> </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* must "add:" not "from" *)</span></span></span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>xly</span><span> </span><span>eey</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>nelx</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"~ (h e &lt; h x)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>            </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>nelx</span><span> </span><span>elx</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span>False</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>contradiction</span><span>
</span><span>          </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>xOk</span><span> </span><span>t2Ok</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">next</span></span><span> </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>False</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>nelx</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>      </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> 
</span><span>      </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">"h x &lt; h e"</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>True</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>xle</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>xle</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"remove h e (T t1 x t2) = T t1 x (remove h e t2)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>s2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t2"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s2</span><span> </span><span>h2</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"setOf (remove h e t2) = setOf t2 - eqs h e"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span>
</span><span>        </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>o1</span><span> </span><span>xle</span><span> </span><span>nelx</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"insert x (setOf t1 Un (setOf t2 - eqs h e)) = 
                insert x (setOf t1 Un setOf t2) - eqs h e"</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>            </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>xOk</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"x ~: eqs h e"</span></span></span><span> 
</span><span>            </span><span class="keyword1"><span class="command">proof</span></span><span> 
</span><span>              </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>h</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"x : eqs h e"</span></span></span><span>
</span><span>              </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>h</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"~ (h x &lt; h e)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>eqs_def</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>xle</span><span> </span><span>o1</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"False"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>contradiction</span><span>
</span><span>            </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>t1Ok</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"(setOf t1) Int (eqs h e) = {}"</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjCond</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>y</span><span> </span><span class="delimiter">::</span><span> </span><span class="tfree">'a</span><span> 
</span><span>              </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>y_in_t1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"y : setOf t1"</span></span></span><span>
</span><span>              </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>y_in_eq</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"y : eqs h e"</span></span></span><span>
</span><span>              </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>y_in_t1</span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>ylx</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h y &lt; h x"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>              </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>y_in_eq</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eey</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h y = h e"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>eqs_def</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>ylx</span><span> </span><span>eey</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>nxle</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"~ (h x &lt; h e)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>              </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>nxle</span><span> </span><span>xle</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span>False</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>contradiction</span><span>
</span><span>            </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>xOk</span><span> </span><span>t1Ok</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">next</span></span><span> </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>False</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>nxle</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>nelx</span><span> </span><span>nxle</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>ex</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h e = h x"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>t2Ok</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"(setOf t2) Int (eqs h e) = {}"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjCond</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>y</span><span> </span><span class="delimiter">::</span><span> </span><span class="tfree">'a</span><span> 
</span><span>          </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>y_in_t2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"y : setOf t2"</span></span></span><span>
</span><span>          </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>y_in_eq</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"y : eqs h e"</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>y_in_t2</span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>xly</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h x &lt; h y"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>y_in_eq</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>eey</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h y = h e"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>eqs_def</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>y_in_eq</span><span> </span><span>ex</span><span> </span><span>eey</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>nxly</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"~ (h x &lt; h y)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>          </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>nxly</span><span> </span><span>xly</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span>False</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>contradiction</span><span>
</span><span>        </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>        </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> 
</span><span>        </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">"t1 = Tip"</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>True</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>t1tip</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>          </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>ex</span><span> </span><span>t1tip</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"remove h e (T t1 x t2) = t2"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>          </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span>
</span><span>          </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>res</span><span> </span><span>t1tip</span><span> </span><span>ex</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"setOf t2 = insert x (setOf t2) - eqs h e"</span></span></span><span>              
</span><span>            </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>              </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>ex</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>x_in_eqs</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"x : eqs h e"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>eqs_def</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>x_in_eqs</span><span> </span><span>t2Ok</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>           </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">next</span></span><span> </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>False</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>t1nTip</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>          </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>nelx</span><span> </span><span>nxle</span><span> </span><span>ex</span><span> </span><span>t1nTip</span><span>
</span><span>          </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"remove h e (T t1 x t2) =
                     T (wrm h t1) (rm h t1) t2"</span></span></span><span> 
</span><span>          </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Let_def</span><span> </span><span>wrmrm_decomp</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>res</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span>
</span><span>          </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>simp</span><span>
</span><span>            </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>s1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t1"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>            </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"insert (rm h t1) (setOf (wrm h t1) Un setOf t2) = 
                  insert x (setOf t1 Un setOf t2) - eqs h e"</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>t1nTip</span><span> </span><span>s1</span><span> </span><span>rm_set</span><span> </span><span>wrm_set</span><span class="delimiter">)</span><span>
</span><span>              </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"insert (rm h t1) (setOf t1 - {rm h t1} Un setOf t2) = 
                    insert x (setOf t1 Un setOf t2) - eqs h e"</span></span></span><span>
</span><span>              </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>                </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>t1nTip</span><span> </span><span>s1</span><span> </span><span>rm_set</span><span>
</span><span>                </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"insert (rm h t1) (setOf t1 - {rm h t1} Un setOf t2) =
                          setOf t1 Un setOf t2"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>                </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"insert x (setOf t1 Un setOf t2) - eqs h e =
                          setOf t1 Un setOf t2"</span></span></span><span> 
</span><span>                </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>                  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>ex</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>xOk</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"x : eqs h e"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>eqs_def</span><span class="delimiter">)</span><span>                  
</span><span>                  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>t1Ok</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"(setOf t1) Int (eqs h e) = {}"</span></span></span><span>
</span><span>                  </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>rule</span><span> </span><span>disjCond</span><span class="delimiter">)</span><span>
</span><span>                    </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>y</span><span> </span><span class="delimiter">::</span><span> </span><span class="tfree">'a</span><span> 
</span><span>                    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>y_in_t1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"y : setOf t1"</span></span></span><span>
</span><span>                    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>y_in_eq</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"y : eqs h e"</span></span></span><span>
</span><span>                    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>y_in_t1</span><span> </span><span>s</span><span> </span><span>ex</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h y &lt; h e"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>                    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>y_in_eq</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"~ (h y &lt; h e)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>eqs_def</span><span class="delimiter">)</span><span>
</span><span>                    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>o1</span><span> </span><span>o2</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span>False</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>contradiction</span><span>
</span><span>                  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>                  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>xOk</span><span> </span><span>t1Ok</span><span> </span><span>t2Ok</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>                </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>                </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>o1</span><span> </span><span>o2</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>              </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>  
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>remove_sort</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t --&gt; 
                    sortedTree h (remove h e t)"</span></span></span><span> </span><span class="delimiter">(</span><span class="keyword2"><span class="keyword">is</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"?P t"</span></span></span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>induct</span><span> </span><span>t</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"?P Tip"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>t1</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a Tree"</span></span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>h1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"?P t1"</span></span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>t2</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a Tree"</span></span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>h2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"?P t2"</span></span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>x</span><span> </span><span class="delimiter">::</span><span> </span><span class="tfree">'a</span><span>
</span><span>  </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"?P (T t1 x t2)"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span> 
</span><span>    </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>s</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h (T t1 x t2)"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>s1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t1"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>s2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t2"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>h1</span><span> </span><span>s1</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>sr1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h (remove h e t1)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>h2</span><span> </span><span>s2</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>sr2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h (remove h e t2)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>   
</span><span>    </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h (remove h e (T t1 x t2))"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">"h e &lt; h x"</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>True</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>elx</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>elx</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"remove h e (T t1 x t2) = T (remove h e t1) x t2"</span></span></span><span> 
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span>
</span><span>      </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>s</span><span> </span><span>sr1</span><span> </span><span>s2</span><span> </span><span>elx</span><span> </span><span>res</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?C1</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">"∀l ∈ setOf (remove h e t1). h l &lt; h x"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?C2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">"∀r ∈ setOf t2. h x &lt; h r"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"?C1"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>          </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s1</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"setOf (remove h e t1) = setOf t1 - eqs h e"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>remove_set</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span>this</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>o1</span><span> </span><span>s</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"?C1 &amp; ?C2"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>      </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">next</span></span><span> </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>False</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>nelx</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>      </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> 
</span><span>      </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">"h x &lt; h e"</span></span></span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>True</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>xle</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>xle</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"remove h e (T t1 x t2) = T t1 x (remove h e t2)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span>
</span><span>        </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>s</span><span> </span><span>s1</span><span> </span><span>sr2</span><span> </span><span>xle</span><span> </span><span>nelx</span><span> </span><span>res</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?C1</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">"∀l ∈ setOf t1. h l &lt; h x"</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?C2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">"∀r ∈ setOf (remove h e t2). h x &lt; h r"</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"?C2"</span></span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>            </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s2</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"setOf (remove h e t2) = setOf t2 - eqs h e"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>remove_set</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span>this</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>          </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>          </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>o2</span><span> </span><span>s</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"?C1 &amp; ?C2"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>        </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">next</span></span><span> </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>False</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>nxle</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>nelx</span><span> </span><span>nxle</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>ex</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h e = h x"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> 
</span><span>        </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">"t1 = Tip"</span></span></span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>True</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>t1tip</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>          </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>ex</span><span> </span><span>t1tip</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"remove h e (T t1 x t2) = t2"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>          </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>res</span><span> </span><span>t1tip</span><span> </span><span>ex</span><span> </span><span>s2</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">next</span></span><span> </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>False</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>t1nTip</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>          </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>nelx</span><span> </span><span>nxle</span><span> </span><span>ex</span><span> </span><span>t1nTip</span><span>
</span><span>          </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"remove h e (T t1 x t2) =
                     T (wrm h t1) (rm h t1) t2"</span></span></span><span> 
</span><span>          </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>Let_def</span><span> </span><span>wrmrm_decomp</span><span class="delimiter">)</span><span>
</span><span>          </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>res</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span>
</span><span>          </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>simp</span><span>
</span><span>            </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?C1</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h (wrm h t1)"</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?C2</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">"∀l ∈ setOf (wrm h t1). h l &lt; h (rm h t1)"</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?C3</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">"∀r ∈ setOf t2. h (rm h t1) &lt; h r"</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?C4</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t2"</span></span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s1</span><span> </span><span>t1nTip</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="var">?C1</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>wrm_sort</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s1</span><span> </span><span>t1nTip</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o2</span><span class="delimiter">:</span><span> </span><span class="var">?C2</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>wrm_less_rm</span><span class="delimiter">)</span><span>
</span><span>            </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o3</span><span class="delimiter">:</span><span> </span><span class="var">?C3</span><span>
</span><span>            </span><span class="keyword1"><span class="command">proof</span></span><span>
</span><span>              </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>r</span><span> </span><span class="delimiter">::</span><span> </span><span class="tfree">'a</span><span> 
</span><span>              </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>rt2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"r : setOf t2"</span></span></span><span>
</span><span>              </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>s</span><span> </span><span>rm_set</span><span> </span><span>s1</span><span> </span><span>t1nTip</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h (rm h t1) &lt; h x"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>              </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>rt2</span><span> </span><span>s</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"h x &lt; h r"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>              </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>o1</span><span> </span><span>o2</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"h (rm h t1) &lt; h r"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>            </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>            </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>o1</span><span> </span><span>o2</span><span> </span><span>o3</span><span> </span><span>s2</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"?C1 &amp; ?C2 &amp; ?C3 &amp; ?C4"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>          </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>  
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹We summarize the specification of remove as follows.›</span></span></span><span>
</span><span class="keyword1"><span class="command">corollary</span></span><span> </span><span>remove_spec</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree h t --&gt; 
     sortedTree h (remove h e t) &amp;
     setOf (remove h e t) = setOf t - eqs h e"</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>remove_sort</span><span> </span><span>remove_set</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"test = tlookup id 4 (remove id 3 (binsert id 4 (binsert id 3 Tip)))"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">export_code</span></span><span> </span><span>test</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">in</span></span><span> </span><span>SML</span><span> </span><span class="keyword2"><span class="keyword">module_name</span></span><span> </span><span>BinaryTree_Code</span><span> </span><span class="keyword2"><span class="keyword">file</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹BinaryTree_Code.ML›</span></span></span><span>
</span><span>
</span><span class="keyword2"><span class="keyword">end</span></span><span>
</span></pre>
</div>
</div><div id="BinaryTree_Map">
<div class="head"><h1>Theory BinaryTree_Map</h1>
<span class="command">theory</span> <span class="name">BinaryTree_Map</span><br/>
<span class="keyword">imports</span> <a href="BinaryTree.html"><span class="name">BinaryTree</span></a><br/>
</div>
<div class="source">
<pre class="source"><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*  Title:       Binary Search Trees, Isar-Style
    Author:      Viktor Kuncak, MIT CSAIL, November 2003
    Maintainer:  Larry Paulson &lt;Larry.Paulson at cl.cam.ac.uk&gt;
    License:     LGPL
*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">section</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹Mostly Isar-style Reasoning for Binary Tree Operations›</span></span></span><span>
</span><span class="keyword1"><span class="command">theory</span></span><span> </span><span>BinaryTree_Map</span><span> </span><span class="keyword2"><span class="keyword">imports</span></span><span> </span><span>BinaryTree</span><span> </span><span class="keyword2"><span class="keyword">begin</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹We prove correctness of map operations
 implemented using binary search trees from BinaryTree.

 This document is LGPL.

 Author: Viktor Kuncak, MIT CSAIL, November 2003›</span></span></span><span>
</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*============================================================*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">section</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹Map implementation and an abstraction function›</span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*============================================================*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">type_synonym</span></span><span> 
</span><span>  </span><span class="tfree">'a</span><span> </span><span>tarray</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">"(index * 'a) Tree"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>valid_tmap</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a tarray =&gt; bool"</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">"valid_tmap t == sortedTree fst t"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">declare</span></span><span> </span><span>valid_tmap_def</span><span> </span><span class="delimiter">[</span><span>simp</span><span class="delimiter">]</span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>mapOf</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"'a tarray =&gt; index =&gt; 'a option"</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="comment">― ‹the abstraction function from trees to maps›</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">"mapOf t i == 
   (case (tlookup fst i t) of
     None =&gt; None
   | Some ia =&gt; Some (snd ia))"</span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*============================================================*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">section</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹Auxiliary Properties of our Implementation›</span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*============================================================*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mapOf_lookup1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"tlookup fst i t = None ==&gt; mapOf t i = None"</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mapOf_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mapOf_lookup2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"tlookup fst i t = Some (j,a) ==&gt; mapOf t i = Some a"</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mapOf_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>h</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"mapOf t i = None"</span></span></span><span>
</span><span>      </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span>mapOf_lookup3</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"tlookup fst i t = None"</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">"tlookup fst i t"</span></span></span><span class="delimiter">)</span><span>
</span><span class="keyword3"><span class="command">case</span></span><span> </span><span>None</span><span> </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>assumption</span><span>
</span><span class="keyword1"><span class="command">next</span></span><span> </span><span class="keyword3"><span class="command">case</span></span><span> </span><span class="delimiter">(</span><span>Some</span><span> </span><span>ia</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>tsome</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"tlookup fst i t = Some (fst ia, snd ia)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"mapOf t i = Some (snd ia)"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>insert</span><span> </span><span>mapOf_lookup2</span><span> </span><span class="delimiter">[</span><span>of</span><span> </span><span>i</span><span> </span><span>t</span><span> </span><span class="string"><span class="delete"><span class="delete">"fst ia"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"snd ia"</span></span></span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>o1</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"mapOf t i ~= None"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span>h</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span> </span><span class="comment">― ‹contradiction›</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>v</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"valid_tmap t"</span></span></span><span>
</span><span>      </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>h</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"mapOf t i = Some a"</span></span></span><span>
</span><span>      </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span>mapOf_lookup4</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"tlookup fst i t = Some (i,a)"</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">"tlookup fst i t"</span></span></span><span class="delimiter">)</span><span>
</span><span class="keyword3"><span class="command">case</span></span><span> </span><span>None</span><span> 
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span>mapOf_lookup1</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"mapOf t i = None"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span>h</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span> </span><span class="comment">― ‹contradiction›</span><span>
</span><span class="keyword1"><span class="command">next</span></span><span> </span><span class="keyword3"><span class="command">case</span></span><span> </span><span class="delimiter">(</span><span>Some</span><span> </span><span>ia</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>tsome</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>tlookup_some_inst</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree fst t &amp; (tlookup fst i t = Some ia) --&gt; 
        ia : setOf t &amp; fst ia = i"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>tlookup_some</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>tlookup_some_inst</span><span> </span><span>tsome</span><span> </span><span>v</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"ia : setOf t"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>tsome</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"mapOf t i = Some (snd ia)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mapOf_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span>h</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"snd ia = a"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>tlookup_some_inst</span><span> </span><span>tsome</span><span> </span><span>v</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o2</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"fst ia = i"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>o1</span><span> </span><span>o2</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"ia = (i,a)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span>tsome</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"tlookup fst i t = Some (i, a)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">subsection</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹Lemmas ‹mapset_none› and ‹mapset_some› establish 
              a relation between the set and map abstraction of the tree›</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>v</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"valid_tmap t"</span></span></span><span>
</span><span>      </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span>mapset_none</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"(mapOf t i = None) = (∀a. (i,a) ∉ setOf t)"</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>
</span><span>  </span><span class="comment">― ‹==&gt;›</span><span>
</span><span>  </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>mapNone</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"mapOf t i = None"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>v</span><span> </span><span>mapNone</span><span> </span><span>mapOf_lookup3</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>lnone</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"tlookup fst i t = None"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>  </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"∀a. (i,a) ∉ setOf t"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span>
</span><span>    </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>a</span><span>
</span><span>    </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"(i,a) ~: setOf t"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span>
</span><span>      </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>iain</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"(i,a) : setOf t"</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>tlookup_none_inst</span><span class="delimiter">:</span><span> 
</span><span>      </span><span class="string"><span class="delete"><span class="delete">"sortedTree fst t &amp; (tlookup fst i t = None) --&gt; (∀x ∈ setOf t. fst x ~= i)"</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>insert</span><span> </span><span>tlookup_none</span><span> </span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">"fst"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"t"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"i"</span></span></span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>assumption</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>v</span><span> </span><span>lnone</span><span> </span><span>tlookup_none_inst</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"∀x ∈ setOf t. fst x ~= i"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span>iain</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"fst (i,a) ~= i"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span>False</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>  </span><span class="comment">― ‹&lt;==›</span><span>
</span><span>  </span><span class="keyword1"><span class="command">next</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>h</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"∀a. (i,a) ∉ setOf t"</span></span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"mapOf t i = None"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">"mapOf t i"</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>None</span><span> </span><span class="keyword1"><span class="command">then</span></span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">.</span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">next</span></span><span> </span><span class="keyword3"><span class="command">case</span></span><span> </span><span class="delimiter">(</span><span>Some</span><span> </span><span>a</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>mapsome</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>v</span><span> </span><span>mapsome</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"tlookup fst i t = Some (i,a)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mapOf_lookup4</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* moving mapOf_lookup4 to assumption does not work, although it uses
       no == !! *)</span></span></span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>tlookup_some</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>tlookup_some_inst</span><span class="delimiter">:</span><span>
</span><span>    </span><span class="string"><span class="delete"><span class="delete">"sortedTree fst t &amp; tlookup fst i t = Some (i,a) --&gt; 
     (i,a) : setOf t &amp; fst (i,a) = i"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>insert</span><span> </span><span>tlookup_some</span><span> </span><span class="delimiter">[</span><span>of</span><span> </span><span>fst</span><span> </span><span>t</span><span> </span><span>i</span><span> </span><span class="string"><span class="delete"><span class="delete">"(i,a)"</span></span></span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>assumption</span><span class="delimiter">)</span><span>   
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>v</span><span> </span><span>o1</span><span> </span><span>this</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"(i,a) : setOf t"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span>h</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span> </span><span class="comment">― ‹contradiction›</span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>v</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"valid_tmap t"</span></span></span><span>
</span><span>      </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span>mapset_some</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"(mapOf t i = Some a) = ((i,a) : setOf t)"</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>
</span><span>  </span><span class="comment">― ‹==&gt;›</span><span>
</span><span>  </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>mapsome</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"mapOf t i = Some a"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>v</span><span> </span><span>mapsome</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>o1</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"tlookup fst i t = Some (i,a)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mapOf_lookup4</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>tlookup_some</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>tlookup_some_inst</span><span class="delimiter">:</span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">"sortedTree fst t &amp; tlookup fst i t = Some (i,a) --&gt; 
   (i,a) : setOf t &amp; fst (i,a) = i"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>insert</span><span> </span><span>tlookup_some</span><span> </span><span class="delimiter">[</span><span>of</span><span> </span><span>fst</span><span> </span><span>t</span><span> </span><span>i</span><span> </span><span class="string"><span class="delete"><span class="delete">"(i,a)"</span></span></span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>assumption</span><span class="delimiter">)</span><span>   
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>v</span><span> </span><span>o1</span><span> </span><span>this</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"(i,a) : setOf t"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="comment">― ‹&lt;==›</span><span>
</span><span>  </span><span class="keyword1"><span class="command">next</span></span><span> </span><span class="keyword3"><span class="command">assume</span></span><span> </span><span>iain</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"(i,a) : setOf t"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>v</span><span> </span><span>iain</span><span> </span><span>tlookup_finds</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"tlookup fst (fst (i,a)) t = Some (i,a)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"tlookup fst i t = Some (i,a)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"mapOf t i = Some a"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mapOf_def</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*============================================================*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">section</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹Empty Map›</span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*============================================================*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mnew_spec_valid</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"valid_tmap Tip"</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mapOf_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>mtip_spec_empty</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"mapOf Tip k = None"</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mapOf_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*============================================================*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">section</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹Map Update Operation›</span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*============================================================*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>mupdate</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"index =&gt; 'a =&gt; 'a tarray =&gt; 'a tarray"</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">"mupdate i a t == binsert fst (i,a) t"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>v</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"valid_tmap t"</span></span></span><span>
</span><span>      </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span>mupdate_map</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"mapOf (mupdate i a t) = (mapOf t)(i |-&gt; a)"</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>i2</span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?tr</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">"binsert fst (i,a) t"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>upres</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"mupdate i a t = ?tr"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mupdate_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>v</span><span> </span><span>binsert_set</span><span> 
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>setSpec</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"setOf ?tr = setOf t - eqs fst (i,a) Un {(i,a)}"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>v</span><span> </span><span>binsert_sorted</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>vr</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"valid_tmap ?tr"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"mapOf (mupdate i a t) i2 = ((mapOf t)(i |-&gt; a)) i2"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">"i = i2"</span></span></span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>True</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>i2ei</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>i2ei</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>rhs_res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"((mapOf t)(i |-&gt; a)) i2 = Some a"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>lhs_res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"mapOf (mupdate i a t) i = Some a"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>will_find</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"tlookup fst i ?tr = Some (i,a)"</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>setSpec</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>kvin</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"(i,a) : setOf ?tr"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>binsert_sorted_inst</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree fst t --&gt; 
                                 sortedTree fst ?tr"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>insert</span><span> </span><span>binsert_sorted</span><span> </span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">"fst"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"t"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"(i,a)"</span></span></span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>assumption</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>v</span><span> </span><span>binsert_sorted_inst</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>rs</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree fst ?tr"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>tlookup_finds_inst</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree fst ?tr &amp; (i,a) : setOf ?tr --&gt; 
                                  tlookup fst i ?tr = Some (i,a)"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>insert</span><span> </span><span>tlookup_finds</span><span> </span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">"fst"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"?tr"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"(i,a)"</span></span></span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>simp</span><span class="delimiter">)</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>rs</span><span> </span><span>kvin</span><span> </span><span>tlookup_finds_inst</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>upres</span><span> </span><span>will_find</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mapOf_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>lhs_res</span><span> </span><span>rhs_res</span><span> </span><span>i2ei</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">next</span></span><span> </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>False</span><span> </span><span class="keyword1"><span class="command">note</span></span><span> </span><span>i2nei</span><span> </span><span class="delimiter">=</span><span> </span><span>this</span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>i2nei</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>rhs_res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"((mapOf t)(i |-&gt; a)) i2 = mapOf t i2"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>auto</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>lhs_res</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"mapOf (mupdate i a t) i2 = mapOf t i2"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>cases</span><span> </span><span class="string"><span class="delete"><span class="delete">"mapOf t i2"</span></span></span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword3"><span class="command">case</span></span><span> </span><span>None</span><span> </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>mapNone</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"mapOf t i2 = None"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>v</span><span> </span><span>mapNone</span><span> </span><span>mapset_none</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>i2nin</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"∀a. (i2,a) ∉ setOf t"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>noneIn</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"∀b. (i2,b) ∉ setOf ?tr"</span></span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">proof</span></span><span> 
</span><span>        </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>b</span><span> 
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>v</span><span> </span><span>binsert_set</span><span> 
</span><span>        </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"setOf ?tr = setOf t - eqs fst (i,a) Un {(i,a)}"</span></span></span><span>
</span><span>        </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>        </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span>i2nei</span><span> </span><span>i2nin</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"(i2,b) ~: setOf ?tr"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>      </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>      </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>mapset_none_inst</span><span class="delimiter">:</span><span> 
</span><span>      </span><span class="string"><span class="delete"><span class="delete">"valid_tmap ?tr --&gt; (mapOf ?tr i2 = None) = (∀a. (i2, a) ∉ setOf ?tr)"</span></span></span><span> 
</span><span>      </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>insert</span><span> </span><span>mapset_none</span><span> </span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">"?tr"</span></span></span><span> </span><span>i2</span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>simp</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>vr</span><span> </span><span>noneIn</span><span> </span><span>mapset_none_inst</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"mapOf ?tr i2 = None"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span>upres</span><span> </span><span>mapNone</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">next</span></span><span> </span><span class="keyword3"><span class="command">case</span></span><span> </span><span class="delimiter">(</span><span>Some</span><span> </span><span>z</span><span class="delimiter">)</span><span> </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>mapSome</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"mapOf t i2 = Some z"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>v</span><span> </span><span>mapSome</span><span> </span><span>mapset_some</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"(i2,z) : setOf t"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span>setSpec</span><span> </span><span>i2nei</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"(i2,z) : setOf ?tr"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>eqs_def</span><span class="delimiter">)</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span>vr</span><span> </span><span>mapset_some</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"mapOf ?tr i2 = Some z"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span>upres</span><span> </span><span>mapSome</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>    </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>lhs_res</span><span> </span><span>rhs_res</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>v</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"valid_tmap t"</span></span></span><span>
</span><span>      </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span>mupdate_valid</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"valid_tmap (mupdate i a t)"</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?tr</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">"binsert fst (i,a) t"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>upres</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"mupdate i a t = ?tr"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mupdate_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>v</span><span> </span><span>binsert_sorted</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>vr</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"valid_tmap ?tr"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>vr</span><span> </span><span>upres</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="var">?thesis</span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*============================================================*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">section</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹Map Remove Operation›</span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*============================================================*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span>mremove</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"index =&gt; 'a tarray =&gt; 'a tarray"</span></span></span><span> </span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">"mremove i t == remove fst (i, undefined) t"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>v</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"valid_tmap t"</span></span></span><span>
</span><span>      </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span>mremove_valid</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"valid_tmap (mremove i t)"</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mremove_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>v</span><span> </span><span>remove_sort</span><span> 
</span><span>  </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"sortedTree fst (remove fst (i, undefined) t)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span class="keyword2"><span class="keyword">assumes</span></span><span> </span><span>v</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"valid_tmap t"</span></span></span><span>
</span><span>      </span><span class="keyword2"><span class="keyword">shows</span></span><span> </span><span>mremove_map</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"mapOf (mremove i t) i = None"</span></span></span><span>
</span><span class="keyword1"><span class="command">proof</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>mremove_def</span><span class="delimiter">)</span><span>
</span><span>  </span><span class="keyword1"><span class="command">let</span></span><span> </span><span class="var">?tr</span><span> </span><span class="delimiter">=</span><span> </span><span class="string"><span class="delete"><span class="delete">"remove fst (i, undefined) t"</span></span></span><span>
</span><span>  </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"mapOf ?tr i = None"</span></span></span><span>
</span><span>  </span><span class="keyword1"><span class="command">proof</span></span><span> </span><span>-</span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>v</span><span> </span><span>remove_spec</span><span> 
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>remSet</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"setOf ?tr = setOf t - eqs fst (i, undefined)"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>noneIn</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"∀a. (i,a) ∉ setOf ?tr"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">proof</span></span><span> 
</span><span>      </span><span class="keyword3"><span class="command">fix</span></span><span> </span><span>a</span><span>
</span><span>      </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>remSet</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"(i,a) ~: setOf ?tr"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>eqs_def</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>v</span><span> </span><span>remove_sort</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>vr</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"valid_tmap ?tr"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>    </span><span class="keyword1"><span class="command">have</span></span><span> </span><span>mapset_none_inst</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"valid_tmap ?tr ==&gt;
    (mapOf ?tr i = None) = (∀a. (i,a) ∉ setOf ?tr)"</span></span></span><span>
</span><span>    </span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>insert</span><span> </span><span>mapset_none</span><span> </span><span class="delimiter">[</span><span>of</span><span> </span><span class="string"><span class="delete"><span class="delete">"?tr"</span></span></span><span> </span><span class="string"><span class="delete"><span class="delete">"i"</span></span></span><span class="delimiter">]</span><span class="delimiter">,</span><span> </span><span>simp</span><span class="delimiter">)</span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>vr</span><span> </span><span>this</span><span> </span><span class="keyword1"><span class="command">have</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"(mapOf ?tr i = None) = (∀a. (i,a) ∉ setOf ?tr)"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>fastforce</span><span>
</span><span>    </span><span class="keyword1"><span class="command">from</span></span><span> </span><span>this</span><span> </span><span>noneIn</span><span> </span><span class="keyword3"><span class="command">show</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"mapOf ?tr i = None"</span></span></span><span> </span><span class="keyword1"><span class="command">by</span></span><span> </span><span>simp</span><span>    
</span><span>  </span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span class="keyword1"><span class="command">qed</span></span><span>
</span><span>
</span><span class="keyword2"><span class="keyword">end</span></span><span>
</span></pre>
</div>
</div><div id="BinaryTree_TacticStyle">
<div class="head"><h1>Theory BinaryTree_TacticStyle</h1>
<span class="command">theory</span> <span class="name">BinaryTree_TacticStyle</span><br/>
<span class="keyword">imports</span> <a href="../../HOL/HOL/Main.html"><span class="name">Main</span></a><br/>
</div>
<div class="source">
<pre class="source"><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*  Title:       Binary Search Trees, Tactic-Style
    Author:      Viktor Kuncak, MIT CSAIL, November 2003
    Maintainer:  Larry Paulson &lt;Larry.Paulson at cl.cam.ac.uk&gt;
    License:     LGPL
*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">section</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹Tactic-Style Reasoning for Binary Tree Operations›</span></span></span><span>
</span><span class="keyword1"><span class="command">theory</span></span><span> </span><span>BinaryTree_TacticStyle</span><span> </span><span class="keyword2"><span class="keyword">imports</span></span><span> </span><span>Main</span><span> </span><span class="keyword2"><span class="keyword">begin</span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹This example theory illustrates automated proofs of correctness
   for binary tree operations using tactic-style reasoning.
   The current proofs for remove operation are by Tobias Nipkow, 
   some modifications and the remaining tree operations are 
   by Viktor Kuncak.›</span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*============================================================*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">section</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹Definition of a sorted binary tree›</span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*============================================================*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">datatype</span></span><span> </span><span>tree</span><span> </span><span class="delimiter">=</span><span> </span><span>Tip</span><span> </span><span class="delimiter">|</span><span> </span><span>Nd</span><span> </span><span>tree</span><span> </span><span>nat</span><span> </span><span>tree</span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>set_of</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"tree =&gt; nat set"</span></span></span><span>
</span><span class="comment">― ‹The set of nodes stored in a tree.›</span><span>
</span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">"set_of Tip = {}"</span></span></span><span>
</span><span class="delimiter">|</span><span> </span><span class="string"><span class="delete"><span class="delete">"set_of(Nd l x r) = set_of l Un set_of r  Un {x}"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>sorted</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"tree =&gt; bool"</span></span></span><span>
</span><span class="comment">― ‹Tree is sorted›</span><span>
</span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">"sorted Tip = True"</span></span></span><span>
</span><span class="delimiter">|</span><span> </span><span class="string"><span class="delete"><span class="delete">"sorted(Nd l y r) =
    (sorted l &amp; sorted r &amp; (∀x ∈ set_of l. x &lt; y) &amp; (∀z ∈ set_of r. y &lt; z))"</span></span></span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*============================================================*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">section</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹Tree Membership›</span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*============================================================*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span>
</span><span>  </span><span>memb</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"nat =&gt; tree =&gt; bool"</span></span></span><span>
</span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">"memb e Tip = False"</span></span></span><span>
</span><span class="delimiter">|</span><span> </span><span class="string"><span class="delete"><span class="delete">"memb e (Nd t1 x t2) = 
   (if e &lt; x then memb e t1
    else if x &lt; e then memb e t2
    else True)"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>member_set</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sorted t --&gt; memb e t = (e : set_of t)"</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>induct</span><span> </span><span>t</span><span class="delimiter">)</span><span> </span><span>auto</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*============================================================*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">section</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹Insertion operation›</span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*============================================================*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>binsert</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"nat =&gt; tree =&gt; tree"</span></span></span><span>
</span><span class="comment">― ‹Insert a node into sorted tree.›</span><span>
</span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">"binsert x Tip = (Nd Tip x Tip)"</span></span></span><span>
</span><span class="delimiter">|</span><span> </span><span class="string"><span class="delete"><span class="delete">"binsert x (Nd t1 y t2) = (if x &lt; y then
                                 (Nd (binsert x t1) y t2)
                             else
                               (if y &lt; x then
                                 (Nd t1 y (binsert x t2))
                                else (Nd t1 y t2)))"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">theorem</span></span><span> </span><span>set_of_binsert</span><span> </span><span class="delimiter">[</span><span>simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"set_of (binsert x t) = set_of t Un {x}"</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>induct</span><span> </span><span>t</span><span class="delimiter">)</span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">theorem</span></span><span> </span><span>binsert_sorted</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sorted t --&gt; sorted (binsert x t)"</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>induct</span><span> </span><span>t</span><span class="delimiter">)</span><span> </span><span class="delimiter">(</span><span>auto</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>set_of_binsert</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">corollary</span></span><span> </span><span>binsert_spec</span><span class="delimiter">:</span><span>  </span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(* summary specification of binsert *)</span></span></span></span></span><span>
</span><span class="string"><span class="delete"><span class="delete">"sorted t ==&gt;
   sorted (binsert x t) &amp; 
   set_of (binsert x t) = set_of t Un {x}"</span></span></span><span> 
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>binsert_sorted</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*============================================================*)</span></span></span></span></span><span>
</span><span class="keyword1"><span class="command">section</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹Remove operation›</span></span></span><span>
</span><span class="comment"><span class="delete"><span class="delete"><span class="delete"><span class="delete">(*============================================================*)</span></span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span>
</span><span>  </span><span>rm</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"tree =&gt; nat"</span></span></span><span> </span><span class="comment">― ‹find the rightmost element in the tree›</span><span>
</span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">"rm(Nd l x r) = (if r = Tip then x else rm r)"</span></span></span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span>
</span><span>  </span><span>rem</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"tree =&gt; tree"</span></span></span><span> </span><span class="comment">― ‹find the tree without the rightmost element›</span><span>
</span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">"rem(Nd l x r) = (if r=Tip then l else Nd l x (rem r))"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span>
</span><span>  </span><span>remove</span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"nat =&gt; tree =&gt; tree"</span></span></span><span> </span><span class="comment">― ‹remove a node from sorted tree›</span><span>
</span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span>  </span><span class="string"><span class="delete"><span class="delete">"remove x Tip = Tip"</span></span></span><span>
</span><span class="delimiter">|</span><span> </span><span class="string"><span class="delete"><span class="delete">"remove x (Nd l y r) =
    (if x &lt; y then Nd (remove x l) y r else
     if y &lt; x then Nd l y (remove x r) else
     if l = Tip then r
     else Nd (rem l) (rm l) r)"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>rm_in_set_of</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"t ~= Tip ==&gt; rm t : set_of t"</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>induct</span><span> </span><span>t</span><span class="delimiter">)</span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>set_of_rem</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"t ~= Tip ==&gt; set_of t = set_of(rem t) Un {rm t}"</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>induct</span><span> </span><span>t</span><span class="delimiter">)</span><span> </span><span>auto</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span class="delimiter">[</span><span>simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"[| t ~= Tip; sorted t  |] ==&gt; sorted(rem t)"</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>induct</span><span> </span><span>t</span><span class="delimiter">)</span><span> </span><span class="delimiter">(</span><span>auto</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>set_of_rem</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span>sorted_rem</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"[| t ~= Tip; x ∈ set_of(rem t); sorted t |] ==&gt; x &lt; rm t"</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>induct</span><span> </span><span>t</span><span class="delimiter">)</span><span> </span><span class="delimiter">(</span><span>auto</span><span> </span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span>set_of_rem</span><span> </span><span>split</span><span class="delimiter">:</span><span>if_splits</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">theorem</span></span><span> </span><span>set_of_remove</span><span> </span><span class="delimiter">[</span><span>simp</span><span class="delimiter">]</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sorted t ==&gt; set_of(remove x t) = set_of t - {x}"</span></span></span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>induct</span><span> </span><span>t</span><span class="delimiter">)</span><span>
</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>simp</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>impI</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>rule</span><span> </span><span>conjI</span><span class="delimiter">)</span><span>
</span><span> </span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span> </span><span>fastforce</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="delimiter">(</span><span>fastforce</span><span> </span><span>simp</span><span class="delimiter">:</span><span>set_of_rem</span><span class="delimiter">)</span><span>
</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">theorem</span></span><span> </span><span>remove_sorted</span><span class="delimiter">:</span><span> </span><span class="string"><span class="delete"><span class="delete">"sorted t ==&gt; sorted(remove x t)"</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>induct</span><span> </span><span>t</span><span class="delimiter">)</span><span> </span><span class="delimiter">(</span><span>auto</span><span> </span><span>intro</span><span class="delimiter">:</span><span> </span><span>less_trans</span><span> </span><span>rm_in_set_of</span><span> </span><span>sorted_rem</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">corollary</span></span><span> </span><span>remove_spec</span><span class="delimiter">:</span><span> </span><span class="comment">― ‹summary specification of remove›</span><span>
</span><span class="string"><span class="delete"><span class="delete">"sorted t ==&gt;
   sorted (remove x t) &amp;
   set_of (remove x t) = set_of t - {x}"</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>simp</span><span> </span><span>add</span><span class="delimiter">:</span><span> </span><span>remove_sorted</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹Finally, note that rem and rm can be computed
        using a single tree traversal given by remrm.›</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">primrec</span></span><span> </span><span>remrm</span><span> </span><span class="delimiter">::</span><span> </span><span class="string"><span class="delete"><span class="delete">"tree =&gt; tree * nat"</span></span></span><span>
</span><span class="keyword2"><span class="keyword">where</span></span><span>
</span><span class="string"><span class="delete"><span class="delete">"remrm(Nd l x r) = (if r=Tip then (l,x) else
                    let (r',y) = remrm r in (Nd l x r',y))"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">lemma</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"t ~= Tip ==&gt; remrm t = (rem t, rm t)"</span></span></span><span>
</span><span class="keyword1"><span class="command">by</span></span><span> </span><span class="delimiter">(</span><span>induct</span><span> </span><span>t</span><span class="delimiter">)</span><span> </span><span class="delimiter">(</span><span>auto</span><span> </span><span>simp</span><span class="delimiter">:</span><span>Let_def</span><span class="delimiter">)</span><span>
</span><span>
</span><span class="keyword1"><span class="command">text</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹We can test this implementation by generating code.›</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">definition</span></span><span> </span><span class="string"><span class="delete"><span class="delete">"test = memb 4 (remove (3::nat) (binsert 4 (binsert 3 Tip)))"</span></span></span><span>
</span><span>
</span><span class="keyword1"><span class="command">export_code</span></span><span> </span><span>test</span><span>
</span><span>  </span><span class="keyword2"><span class="keyword">in</span></span><span> </span><span>SML</span><span> </span><span class="keyword2"><span class="keyword">module_name</span></span><span> </span><span>BinaryTree_TacticStyle_Code</span><span> </span><span class="keyword2"><span class="keyword">file</span></span><span> </span><span class="cartouche"><span class="delete"><span class="delete">‹BinaryTree_TacticStyle_Code.ML›</span></span></span><span>
</span><span>
</span><span class="keyword2"><span class="keyword">end</span></span><span>
</span></pre>
</div>
</div>