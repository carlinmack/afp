<div id="FJDefs">
<div class="head">
<h1>Theory FJDefs</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       A theory of Featherweight Java in Isabelle/HOL
    Author:      Nate Foster &lt;jnfoster at cis.upenn.edu&gt;, 
                 Dimitrios Vytiniotis &lt;dimitriv at cis.upenn.edu&gt;, 2006
    Maintainer:  Nate Foster &lt;jnfoster at cis.upenn.edu&gt;,
                 Dimitrios Vytiniotis &lt;dimitriv at cis.upenn.edu&gt;
    License:     LGPL
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹{\tt FJDefs}: Basic Definitions›</span></span>

<span class="keyword1"><span class="command">theory</span></span> FJDefs
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Syntax›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We use a named representation for terms: variables, method
names, and class names, are all represented as {\tt nat}s. We use the
finite maps defined in {\tt Map.thy} to represent typing contexts and
the static class table. This section defines the representations of
each syntactic category (expressions, methods, constructors, classes,
class tables) and defines several constants ({\tt Object} and {\tt this}).
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Type definitions›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> varName <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> methodName <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> className <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">record</span></span> varDef     <span class="main">=</span> 
  vdName <span class="main">::</span> <span class="quoted"><span class="quoted">"varName"</span></span>
  vdType <span class="main">::</span> <span class="quoted"><span class="quoted">"className"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> varCtx <span class="main">=</span> <span class="quoted"><span class="quoted">"varName <span class="main">⇀</span> className"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Constants›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">Object</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"className"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Object</span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">this</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"varName"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">this</span> <span class="main">==</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Expressions›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> exp <span class="main">=</span> 
    Var <span class="quoted"><span class="quoted">"varName"</span></span>
  <span class="main">|</span> FieldProj <span class="quoted"><span class="quoted">"exp"</span></span> <span class="quoted"><span class="quoted">"varName"</span></span>              
  <span class="main">|</span> MethodInvk <span class="quoted"><span class="quoted">"exp"</span></span> <span class="quoted"><span class="quoted">"methodName"</span></span> <span class="quoted"><span class="quoted">"exp list"</span></span>
  <span class="main">|</span> New <span class="quoted"><span class="quoted">"className"</span></span> <span class="quoted"><span class="quoted">"exp list"</span></span>
  <span class="main">|</span> Cast <span class="quoted"><span class="quoted">"className"</span></span> <span class="quoted"><span class="quoted">"exp"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Methods›</span></span>

<span class="keyword1"><span class="command">record</span></span> methodDef <span class="main">=</span> 
  mReturn <span class="main">::</span> <span class="quoted"><span class="quoted">"className"</span></span>
  mName <span class="main">::</span> <span class="quoted"><span class="quoted">"methodName"</span></span>
  mParams <span class="main">::</span> <span class="quoted"><span class="quoted">"varDef list"</span></span>
  mBody <span class="main">::</span> <span class="quoted"><span class="quoted">"exp"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Constructors›</span></span>

<span class="keyword1"><span class="command">record</span></span> constructorDef <span class="main">=</span> 
  kName <span class="main">::</span> <span class="quoted"><span class="quoted">"className"</span></span>
  kParams <span class="main">::</span> <span class="quoted"><span class="quoted">"varDef list"</span></span>
  kSuper <span class="main">::</span> <span class="quoted"><span class="quoted">"varName list"</span></span>
  kInits <span class="main">::</span> <span class="quoted"><span class="quoted">"varName list"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Classes›</span></span>

<span class="keyword1"><span class="command">record</span></span> classDef <span class="main">=</span> 
  cName <span class="main">::</span> <span class="quoted"><span class="quoted">"className"</span></span>
  cSuper <span class="main">::</span> <span class="quoted"><span class="quoted">"className"</span></span>
  cFields <span class="main">::</span> <span class="quoted"><span class="quoted">"varDef list"</span></span>
  cConstructor <span class="main">::</span> <span class="quoted"><span class="quoted">"constructorDef"</span></span>
  cMethods <span class="main">::</span> <span class="quoted"><span class="quoted">"methodDef list"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Class Tables›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> classTable <span class="main">=</span> <span class="quoted"><span class="quoted">"className <span class="main">⇀</span> classDef"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Sub-expression Relation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The sub-expression relation, written $t \in
\mathit{subexprs}(s)$, is defined as the reflexive and transitive
closure of the immediate subexpression relation.
›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span>
  <span class="entity">isubexprs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>exp <span class="main">*</span> exp<span class="main">)</span> set"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity"><span class="free">isubexprs'</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>exp<span class="main">,</span>exp<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">∈</span> <span class="keyword1">isubexprs'(</span>_<span class="keyword1">')</span>"</span> <span class="main">[</span>80<span class="main">,</span>80<span class="main">]</span> 80<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">∈</span></span> <span class="keyword1"><span class="free">isubexprs(</span></span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">)</span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">isubexprs</span>"</span></span>
<span class="main">|</span> se_field    <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">∈</span></span> <span class="keyword1"><span class="free">isubexprs(</span></span>FieldProj <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">fi</span></span></span><span class="main"><span class="free">)</span></span>"</span></span>
<span class="main">|</span> se_invkrecv <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">∈</span></span> <span class="keyword1"><span class="free">isubexprs(</span></span>MethodInvk <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main"><span class="free">)</span></span>"</span></span>
<span class="main">|</span> se_invkarg  <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">ei</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">ei</span></span></span> <span class="main"><span class="free">∈</span></span> <span class="keyword1"><span class="free">isubexprs(</span></span>MethodInvk <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main"><span class="free">)</span></span>"</span></span>
<span class="main">|</span> se_newarg   <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">ei</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">ei</span></span></span> <span class="main"><span class="free">∈</span></span> <span class="keyword1"><span class="free">isubexprs(</span></span>New <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main"><span class="free">)</span></span>"</span></span>
<span class="main">|</span> se_cast     <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">∈</span></span> <span class="keyword1"><span class="free">isubexprs(</span></span>Cast <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">)</span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">subexprs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>exp<span class="main">,</span>exp<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">∈</span> <span class="keyword1">subexprs'(</span>_<span class="keyword1">')</span>"</span> <span class="main">[</span>80<span class="main">,</span>80<span class="main">]</span> 80<span class="main">)</span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">∈</span></span> <span class="keyword1"><span class="free">subexprs(</span></span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main"><span class="free">)</span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">∈</span> isubexprs<span class="main">^*</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Values›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A {\em value} is an expression of the form $\mathtt{new}\
\mathtt{C}(\mathit{overline{vs}})$, where $\mathit{\overline{vs}}$ is a list
of values.›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">vals</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>exp list<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">vals'(</span>_<span class="keyword1">')</span>"</span> <span class="main">[</span>80<span class="main">]</span> 80<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">val</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>exp<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">val'(</span>_<span class="keyword1">')</span>"</span> <span class="main">[</span>80<span class="main">]</span> 80<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
   vals_nil <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">vals(</span></span><span class="main">[]</span><span class="main"><span class="free">)</span></span>"</span></span>
 <span class="main">|</span> vals_cons <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="keyword1"><span class="free">val(</span></span><span class="free"><span class="bound"><span class="entity">vh</span></span></span><span class="main"><span class="free">)</span></span><span class="main">;</span> <span class="keyword1"><span class="free">vals(</span></span><span class="free"><span class="bound"><span class="entity">vt</span></span></span><span class="main"><span class="free">)</span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">vals(</span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">vh</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">vt</span></span></span><span class="main">)</span><span class="main"><span class="free">)</span></span>"</span></span>
 <span class="main">|</span> val <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="keyword1"><span class="free">vals(</span></span><span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main"><span class="free">)</span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">val(</span></span>New <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main"><span class="free">)</span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Substitution›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The substitutions of a list of expressions $\mathit{ds}$ for a
list of variables $\mathit{xs}$ in another expression $e$ or a list of
expressions $\mathit{es}$ are defined in the obvious way, and written
$(\mathit{ds}/\mathit{xs})e$ and $[\mathit{ds}/\mathit{xs}]es$
respecitvely. 
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">substs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>varName <span class="main">⇀</span> exp<span class="main">)</span> <span class="main">⇒</span> exp <span class="main">⇒</span> exp"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">subst_list1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>varName <span class="main">⇀</span> exp<span class="main">)</span> <span class="main">⇒</span> exp list <span class="main">⇒</span> exp list"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">subst_list2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>varName <span class="main">⇀</span> exp<span class="main">)</span> <span class="main">⇒</span> exp list <span class="main">⇒</span> exp list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">substs</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span>             <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">substs</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>FieldProj <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span>     FieldProj <span class="main">(</span><span class="free">substs</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">substs</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>MethodInvk <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">=</span> MethodInvk <span class="main">(</span><span class="free">substs</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span><span class="free">subst_list1</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">substs</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>New <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main">=</span>          New <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span><span class="free">subst_list2</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">substs</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Cast <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span>          Cast <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span><span class="free">substs</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_list1</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_list1</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">substs</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">subst_list1</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_list2</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst_list2</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">substs</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="free">subst_list2</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">substs_syn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>exp list<span class="main">]</span> <span class="main">⇒</span> <span class="main">[</span>varName list<span class="main">]</span> <span class="main">⇒</span> <span class="main">[</span>exp<span class="main">]</span> <span class="main">⇒</span> exp"</span></span>
    <span class="main">(</span><span class="quoted">"<span class="keyword1">'(</span>_<span class="keyword1">'/</span>_<span class="keyword1">')</span>_"</span> <span class="main">[</span>80<span class="main">,</span>80<span class="main">,</span>80<span class="main">]</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">(</span></span><span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main"><span class="free">)</span></span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> substs <span class="main">(</span>map_upds Map.empty <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">subst_list_syn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>exp list<span class="main">]</span> <span class="main">⇒</span> <span class="main">[</span>varName list<span class="main">]</span> <span class="main">⇒</span> <span class="main">[</span>exp list<span class="main">]</span> <span class="main">⇒</span> exp list"</span></span>
    <span class="main">(</span><span class="quoted">"<span class="keyword1">'[</span>_<span class="keyword1">'/</span>_<span class="keyword1">']</span>_"</span> <span class="main">[</span>80<span class="main">,</span>80<span class="main">,</span>80<span class="main">]</span> 80<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main"><span class="free">/</span></span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main"><span class="free">]</span></span><span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">≡</span> map <span class="main">(</span>substs <span class="main">(</span>map_upds Map.empty <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lookup›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The fuction $\mathit{lookup}\ f\ l$ function returns an option
containing the first element of $l$ satisfying $f$, or $\mathtt{None}$
if no such element exists 
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">lookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lookup</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lookup</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="keyword1">else</span> <span class="free">lookup</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">lookup2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lookup2</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lookup2</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h1</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">h1</span></span></span> <span class="keyword1">then</span> Some<span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">lookup2</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Variable Definition Accessors›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This section contains several helper functions for reading off
the names and types of variable definitions (e.g., in field
 and method parameter declarations).›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">varDefs_names</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"varDef list <span class="main">⇒</span> varName list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">varDefs_names</span> <span class="main">=</span> map vdName"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">varDefs_types</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"varDef list <span class="main">⇒</span> className list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">varDefs_types</span> <span class="main">=</span> map vdType"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Subtyping Relation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The subtyping relation, written $\mathit{CT} \vdash C
\mathtt{\lt:} D$ is just the reflexive and transitive closure of the
immediate subclass relation. (For the sake of simplicity, we define
subtyping directly instead of using the reflexive and transitive
closure operator.) The subtyping relation is extended to lists of
classes, written $\mathit{CT} \vdash\mathtt{+} \mathit{Cs} \mathtt{\lt:}
\mathit{Ds}$.›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">subtyping</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>classTable<span class="main">,</span> className<span class="main">,</span> className<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">&lt;:</span> _"</span> <span class="main">[</span>80<span class="main">,</span>80<span class="main">,</span>80<span class="main">]</span> 80<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  s_refl  <span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main"><span class="free">&lt;:</span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span>
<span class="main">|</span> s_trans <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main"><span class="free">&lt;:</span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main"><span class="free">&lt;:</span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main"><span class="free">&lt;:</span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span>"</span></span>
<span class="main">|</span> s_super <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="free"><span class="bound"><span class="entity">CDef</span></span></span><span class="main">)</span><span class="main">;</span> cSuper <span class="free"><span class="bound"><span class="entity">CDef</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main"><span class="free">&lt;:</span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">neg_subtyping</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>classTable<span class="main">,</span> className<span class="main">,</span> className<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">¬&lt;:</span> _"</span> <span class="main">[</span>80<span class="main">,</span>80<span class="main">,</span>80<span class="main">]</span> 80<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main"><span class="free">¬&lt;:</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">≡</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">&lt;:</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">subtypings</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>classTable<span class="main">,</span> className list<span class="main">,</span> className list<span class="main">]</span> <span class="main">⇒</span> bool"</span></span>  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢+</span> _ <span class="keyword1">&lt;:</span> _"</span> <span class="main">[</span>80<span class="main">,</span>80<span class="main">,</span>80<span class="main">]</span> 80<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  ss_nil  <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢+</span></span> <span class="main">[]</span> <span class="main"><span class="free">&lt;:</span></span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> ss_cons <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C0</span></span></span> <span class="main">&lt;:</span> <span class="free"><span class="bound"><span class="entity">D0</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢+</span></span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="main"><span class="free">&lt;:</span></span> <span class="free"><span class="bound"><span class="entity">Ds</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢+</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C0</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span> <span class="main"><span class="free">&lt;:</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">D0</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Ds</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹{\tt fields} Relation›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The {\tt fields} relation, written
$\mathtt{fields}(\mathit{CT},C) = \mathit{Cf}$, relates $\mathit{Cf}$
to $C$ when $\mathit{Cf}$ is the list of fields declared directly or
indirectly (i.e., by a superclass) in $C$.›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">fields</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>classTable<span class="main">,</span> className<span class="main">,</span> varDef list<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">fields'(</span>_<span class="keyword1">,</span>_<span class="keyword1">')</span> <span class="keyword1">=</span> _"</span> <span class="main">[</span>80<span class="main">,</span>80<span class="main">,</span>80<span class="main">]</span> 80<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  f_obj<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">fields(</span></span><span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">,</span></span>Object<span class="main"><span class="free">)</span></span> <span class="main"><span class="free">=</span></span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> f_class<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="free"><span class="bound"><span class="entity">CDef</span></span></span><span class="main">)</span><span class="main">;</span> cSuper <span class="free"><span class="bound"><span class="entity">CDef</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">;</span> cFields <span class="free"><span class="bound"><span class="entity">CDef</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Cf</span></span></span><span class="main">;</span> <span class="keyword1"><span class="free">fields(</span></span><span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main"><span class="free">)</span></span> <span class="main"><span class="free">=</span></span> <span class="free"><span class="bound"><span class="entity">Dg</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">DgCf</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Dg</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">Cf</span></span></span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="keyword1"><span class="free">fields(</span></span><span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main"><span class="free">)</span></span> <span class="main"><span class="free">=</span></span> <span class="free"><span class="bound"><span class="entity">DgCf</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹{\tt mtype } Relation›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The {\tt mtype} relation, written
$\mathtt{mtype}(\mathit{CT},m,C) = \mathit{Cs} \rightarrow C_0$ relates
a class $C$, method name $m$, and the arrow type $\mathit{Cs}
\rightarrow C_0$. It either returns the type of the declaration of $m$
in $C$, if any such declaration exists, and otherwise returning the
type of $m$ from $C$'s superclass.
›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">mtype</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>classTable<span class="main">,</span> methodName<span class="main">,</span> className<span class="main">,</span> className list<span class="main">,</span> className<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">mtype'(</span>_<span class="keyword1">,</span>_<span class="keyword1">,</span>_<span class="keyword1">')</span> <span class="keyword1">=</span> _ <span class="keyword1">→</span> _"</span> <span class="main">[</span>80<span class="main">,</span>80<span class="main">,</span>80<span class="main">,</span>80<span class="main">]</span> 80<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  mt_class<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="free"><span class="bound"><span class="entity">CDef</span></span></span><span class="main">)</span><span class="main">;</span>
    lookup <span class="main">(</span>cMethods <span class="free"><span class="bound"><span class="entity">CDef</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">md</span><span class="main">.</span><span class="main">(</span>mName <span class="bound">md</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="free"><span class="bound"><span class="entity">mDef</span></span></span><span class="main">)</span><span class="main">;</span>
    varDefs_types <span class="main">(</span>mParams <span class="free"><span class="bound"><span class="entity">mDef</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Bs</span></span></span><span class="main">;</span>
    mReturn <span class="free"><span class="bound"><span class="entity">mDef</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="keyword1"><span class="free">mtype(</span></span><span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main"><span class="free">)</span></span> <span class="main"><span class="free">=</span></span> <span class="free"><span class="bound"><span class="entity">Bs</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>

<span class="main">|</span> mt_super<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">CDef</span></span></span><span class="main">)</span><span class="main">;</span>
    lookup <span class="main">(</span>cMethods <span class="free"><span class="bound"><span class="entity">CDef</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">md</span><span class="main">.</span><span class="main">(</span>mName <span class="bound">md</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> None<span class="main">;</span>
    cSuper <span class="free"><span class="bound"><span class="entity">CDef</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">;</span>
    <span class="keyword1"><span class="free">mtype(</span></span><span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main"><span class="free">)</span></span> <span class="main"><span class="free">=</span></span> <span class="free"><span class="bound"><span class="entity">Bs</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="keyword1"><span class="free">mtype(</span></span><span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main"><span class="free">)</span></span> <span class="main"><span class="free">=</span></span> <span class="free"><span class="bound"><span class="entity">Bs</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹{\tt mbody} Relation›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The {\tt mtype} relation, written
$\mathtt{mbody}(\mathit{CT},m,C) = \mathit{xs} . e_0$ relates a class
$C$, method name $m$, and the names of the parameters $\mathit{xs}$
and the body of the method $e_0$. It either returns the parameter
names and body of the declaration of $m$ in $C$, if any such
declaration exists, and otherwise the parameter names and body of $m$
from $C$'s superclass.  
›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">mbody</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>classTable<span class="main">,</span> methodName<span class="main">,</span> className<span class="main">,</span> varName list<span class="main">,</span> exp<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">mbody'(</span>_<span class="keyword1">,</span>_<span class="keyword1">,</span>_<span class="keyword1">')</span> <span class="keyword1">=</span> _ <span class="keyword1">.</span> _"</span> <span class="main">[</span>80<span class="main">,</span>80<span class="main">,</span>80<span class="main">,</span>80<span class="main">]</span> 80<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  mb_class<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="free"><span class="bound"><span class="entity">CDef</span></span></span><span class="main">)</span><span class="main">;</span>
     lookup <span class="main">(</span>cMethods <span class="free"><span class="bound"><span class="entity">CDef</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">md</span><span class="main">.</span><span class="main">(</span>mName <span class="bound">md</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="free"><span class="bound"><span class="entity">mDef</span></span></span><span class="main">)</span><span class="main">;</span>
     varDefs_names <span class="main">(</span>mParams <span class="free"><span class="bound"><span class="entity">mDef</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span>
     mBody <span class="free"><span class="bound"><span class="entity">mDef</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="keyword1"><span class="free">mbody(</span></span><span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main"><span class="free">)</span></span> <span class="main"><span class="free">=</span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main"><span class="free">.</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="main">|</span> mb_super<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="free"><span class="bound"><span class="entity">CDef</span></span></span><span class="main">)</span><span class="main">;</span>
     lookup <span class="main">(</span>cMethods <span class="free"><span class="bound"><span class="entity">CDef</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">md</span><span class="main">.</span><span class="main">(</span>mName <span class="bound">md</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> None<span class="main">;</span>
     cSuper <span class="free"><span class="bound"><span class="entity">CDef</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">;</span>
     <span class="keyword1"><span class="free">mbody(</span></span><span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main"><span class="free">)</span></span> <span class="main"><span class="free">=</span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main"><span class="free">.</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="keyword1"><span class="free">mbody(</span></span><span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main"><span class="free">)</span></span> <span class="main"><span class="free">=</span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main"><span class="free">.</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Typing Relation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The typing relation, written $\mathit{CT};\Gamma \vdash e : C$
relates an expression $e$ to its type $C$, under the typing context
$\Gamma$. The multi-typing relation, written $\mathit{CT};\Gamma
\vdash\mathtt{+} \mathit{es}:\mathit{Cs}$ relates lists of expressions
to lists of types. 
›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">typings</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>classTable<span class="main">,</span> varCtx<span class="main">,</span> exp list<span class="main">,</span> className list<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">;</span>_ <span class="keyword1">⊢+</span> _ <span class="keyword1">:</span> _"</span> <span class="main">[</span>80<span class="main">,</span>80<span class="main">,</span>80<span class="main">,</span>80<span class="main">]</span> 80<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">typing</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>classTable<span class="main">,</span> varCtx<span class="main">,</span> exp<span class="main">,</span> className<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">;</span>_ <span class="keyword1">⊢</span> _ <span class="keyword1">:</span> _"</span> <span class="main">[</span>80<span class="main">,</span>80<span class="main">,</span>80<span class="main">,</span>80<span class="main">]</span> 80<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  ts_nil <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">;</span></span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢+</span></span> <span class="main">[]</span> <span class="main"><span class="free">:</span></span> <span class="main">[]</span>"</span></span>

<span class="main">|</span> ts_cons  <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">;</span></span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e0</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">C0</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">;</span></span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢+</span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">;</span></span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢+</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e0</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main"><span class="free">:</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C0</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> t_var <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">;</span></span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span>

<span class="main">|</span> t_field <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">;</span></span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e0</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">C0</span></span></span><span class="main">;</span>
     <span class="keyword1">fields(</span><span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C0</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Cf</span></span></span><span class="main">;</span>
     lookup <span class="free"><span class="bound"><span class="entity">Cf</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">fd</span><span class="main">.</span><span class="main">(</span>vdName <span class="bound">fd</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">fi</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="free"><span class="bound"><span class="entity">fDef</span></span></span><span class="main">)</span><span class="main">;</span>
     vdType <span class="free"><span class="bound"><span class="entity">fDef</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ci</span></span></span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">;</span></span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> FieldProj <span class="free"><span class="bound"><span class="entity">e0</span></span></span> <span class="free"><span class="bound"><span class="entity">fi</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">Ci</span></span></span>"</span></span>

<span class="main">|</span> t_invk <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">;</span></span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e0</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">C0</span></span></span><span class="main">;</span>
     <span class="keyword1">mtype(</span><span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C0</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ds</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">;</span>
     <span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">;</span></span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢+</span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">;</span>
     <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main">⊢+</span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="main">&lt;:</span> <span class="free"><span class="bound"><span class="entity">Ds</span></span></span><span class="main">;</span>
     length <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">Ds</span></span></span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">;</span></span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> MethodInvk <span class="free"><span class="bound"><span class="entity">e0</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span>

<span class="main">|</span> t_new <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="keyword1">fields(</span><span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Df</span></span></span><span class="main">;</span>
     length <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">Df</span></span></span><span class="main">;</span>
     varDefs_types <span class="free"><span class="bound"><span class="entity">Df</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Ds</span></span></span><span class="main">;</span>
     <span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">;</span></span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢+</span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">;</span>
     <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main">⊢+</span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="main">&lt;:</span> <span class="free"><span class="bound"><span class="entity">Ds</span></span></span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">;</span></span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> New <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span>

<span class="main">|</span> t_ucast <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">;</span></span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e0</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">;</span> 
     <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">&lt;:</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">;</span></span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Cast <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">e0</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span>

<span class="main">|</span> t_dcast <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">;</span></span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e0</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">;</span> 
     <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">&lt;:</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">;</span></span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Cast <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">e0</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span>

<span class="main">|</span> t_scast <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">;</span></span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e0</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">;</span>
     <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">¬&lt;:</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">;</span>
     <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">¬&lt;:</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main"><span class="free">;</span></span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Cast <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">e0</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We occasionally find the following induction principle, which
only mentions the typing of a single expression, more useful than the
mutual induction principle generated by Isabelle, which mentions the
typings of single expressions and of lists of expressions. 
›</span></span>

<span class="keyword1" id="FJDefs-typing_induct"><span class="command">lemma</span></span> typing_induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">C</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span> <span class="bound">CT</span> <span class="bound">Γ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">Γ</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">C</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">CT</span> <span class="bound">Γ</span> <span class="main">(</span>Var <span class="bound">x</span><span class="main">)</span> <span class="bound">C</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C0</span> <span class="bound">CT</span> <span class="bound">Cf</span> <span class="bound">Ci</span> <span class="bound">Γ</span> <span class="bound">e0</span> <span class="bound">fDef</span> <span class="bound">fi</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">CT</span><span class="main">;</span><span class="bound">Γ</span> <span class="main">⊢</span> <span class="bound">e0</span> <span class="main">:</span> <span class="bound">C0</span><span class="main">;</span> <span class="free">P</span> <span class="bound">CT</span> <span class="bound">Γ</span> <span class="bound">e0</span> <span class="bound">C0</span><span class="main">;</span> <span class="keyword1">fields(</span><span class="bound">CT</span><span class="main">,</span><span class="bound">C0</span><span class="main">)</span> <span class="main">=</span> <span class="bound">Cf</span><span class="main">;</span> lookup <span class="bound">Cf</span> <span class="main">(</span><span class="main">λ</span><span class="bound">fd</span><span class="main">.</span> vdName <span class="bound">fd</span> <span class="main">=</span> <span class="bound">fi</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">fDef</span><span class="main">;</span> vdType <span class="bound">fDef</span> <span class="main">=</span> <span class="bound">Ci</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">CT</span> <span class="bound">Γ</span> <span class="main">(</span>FieldProj <span class="bound">e0</span> <span class="bound">fi</span><span class="main">)</span> <span class="bound">Ci</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span> <span class="bound">C0</span> <span class="bound">CT</span> <span class="bound">Cs</span> <span class="bound">Ds</span> <span class="bound">Γ</span> <span class="bound">e0</span> <span class="bound">es</span> <span class="bound">m</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">CT</span><span class="main">;</span><span class="bound">Γ</span> <span class="main">⊢</span> <span class="bound">e0</span> <span class="main">:</span> <span class="bound">C0</span><span class="main">;</span> <span class="free">P</span> <span class="bound">CT</span> <span class="bound">Γ</span> <span class="bound">e0</span> <span class="bound">C0</span><span class="main">;</span> <span class="keyword1">mtype(</span><span class="bound">CT</span><span class="main">,</span><span class="bound">m</span><span class="main">,</span><span class="bound">C0</span><span class="main">)</span> <span class="main">=</span> <span class="bound">Ds</span> <span class="main">→</span> <span class="bound">C</span><span class="main">;</span> <span class="bound">CT</span><span class="main">;</span><span class="bound">Γ</span> <span class="main">⊢+</span> <span class="bound">es</span> <span class="main">:</span> <span class="bound">Cs</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">i</span> <span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="bound">es</span> <span class="main">⟧</span> <span class="main">⟹</span>  <span class="free">P</span> <span class="bound">CT</span> <span class="bound">Γ</span> <span class="main">(</span><span class="bound">es</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="bound">Cs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">;</span> <span class="bound">CT</span> <span class="main">⊢+</span> <span class="bound">Cs</span> <span class="main">&lt;:</span> <span class="bound">Ds</span><span class="main">;</span> length <span class="bound">es</span> <span class="main">=</span> length <span class="bound">Ds</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">CT</span> <span class="bound">Γ</span> <span class="main">(</span>MethodInvk <span class="bound">e0</span> <span class="bound">m</span> <span class="bound">es</span><span class="main">)</span> <span class="bound">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span> <span class="bound">CT</span> <span class="bound">Cs</span> <span class="bound">Df</span> <span class="bound">Ds</span> <span class="bound">Γ</span> <span class="bound">es</span><span class="main">.</span> <span class="main">⟦</span><span class="keyword1">fields(</span><span class="bound">CT</span><span class="main">,</span><span class="bound">C</span><span class="main">)</span> <span class="main">=</span> <span class="bound">Df</span><span class="main">;</span> length <span class="bound">es</span> <span class="main">=</span> length <span class="bound">Df</span><span class="main">;</span> varDefs_types <span class="bound">Df</span> <span class="main">=</span> <span class="bound">Ds</span><span class="main">;</span> <span class="bound">CT</span><span class="main">;</span><span class="bound">Γ</span> <span class="main">⊢+</span> <span class="bound">es</span> <span class="main">:</span> <span class="bound">Cs</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="bound">es</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">CT</span> <span class="bound">Γ</span> <span class="main">(</span><span class="bound">es</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="bound">Cs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">;</span> <span class="bound">CT</span> <span class="main">⊢+</span> <span class="bound">Cs</span> <span class="main">&lt;:</span> <span class="bound">Ds</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">CT</span> <span class="bound">Γ</span> <span class="main">(</span>New <span class="bound">C</span> <span class="bound">es</span><span class="main">)</span> <span class="bound">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span> <span class="bound">CT</span> <span class="bound">D</span> <span class="bound">Γ</span> <span class="bound">e0</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">CT</span><span class="main">;</span><span class="bound">Γ</span> <span class="main">⊢</span> <span class="bound">e0</span> <span class="main">:</span> <span class="bound">D</span><span class="main">;</span> <span class="free">P</span> <span class="bound">CT</span> <span class="bound">Γ</span> <span class="bound">e0</span> <span class="bound">D</span><span class="main">;</span> <span class="bound">CT</span> <span class="main">⊢</span> <span class="bound">D</span> <span class="main">&lt;:</span> <span class="bound">C</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">CT</span> <span class="bound">Γ</span> <span class="main">(</span>Cast <span class="bound">C</span> <span class="bound">e0</span><span class="main">)</span> <span class="bound">C</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span> <span class="bound">CT</span> <span class="bound">D</span> <span class="bound">Γ</span> <span class="bound">e0</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">CT</span><span class="main">;</span><span class="bound">Γ</span> <span class="main">⊢</span> <span class="bound">e0</span> <span class="main">:</span> <span class="bound">D</span><span class="main">;</span> <span class="free">P</span> <span class="bound">CT</span> <span class="bound">Γ</span> <span class="bound">e0</span> <span class="bound">D</span><span class="main">;</span> <span class="bound">CT</span> <span class="main">⊢</span> <span class="bound">C</span> <span class="main">&lt;:</span> <span class="bound">D</span><span class="main">;</span> <span class="bound">C</span> <span class="main">≠</span> <span class="bound">D</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">CT</span> <span class="bound">Γ</span> <span class="main">(</span>Cast <span class="bound">C</span> <span class="bound">e0</span><span class="main">)</span> <span class="bound">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span> <span class="bound">CT</span> <span class="bound">D</span> <span class="bound">Γ</span> <span class="bound">e0</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">CT</span><span class="main">;</span><span class="bound">Γ</span> <span class="main">⊢</span> <span class="bound">e0</span> <span class="main">:</span> <span class="bound">D</span><span class="main">;</span> <span class="free">P</span> <span class="bound">CT</span> <span class="bound">Γ</span> <span class="bound">e0</span> <span class="bound">D</span><span class="main">;</span> <span class="bound">CT</span> <span class="main">⊢</span> <span class="bound">C</span> <span class="main">¬&lt;:</span> <span class="bound">D</span><span class="main">;</span> <span class="bound">CT</span> <span class="main">⊢</span> <span class="bound">D</span> <span class="main">¬&lt;:</span> <span class="bound">C</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">CT</span> <span class="bound">Γ</span> <span class="main">(</span>Cast <span class="bound">C</span> <span class="bound">e0</span><span class="main">)</span> <span class="bound">C</span>"</span></span> 
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">CT</span> <span class="free">Γ</span> <span class="free">e</span> <span class="free">C</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">es</span> <span class="skolem">Cs</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?IH</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="skolem">es</span> <span class="main">:</span> <span class="skolem">Cs</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">es</span><span class="main">.</span>  <span class="free">P</span> <span class="free">CT</span> <span class="free">Γ</span> <span class="main">(</span><span class="skolem">es</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Cs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?IH</span> <span class="main">∧</span> <span class="main">(</span><span class="var">?T</span> <span class="main">⟶</span> <span class="var">?P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>typings_typing.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ts_nil <span class="skolem">CT</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ts_cons <span class="skolem">CT</span> <span class="skolem">Γ</span> <span class="skolem">e0</span> <span class="skolem">C0</span> <span class="skolem">es</span> <span class="skolem">Cs</span><span class="main">)</span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">e0</span><span class="main">#</span><span class="skolem">es</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="skolem">CT</span> <span class="skolem">Γ</span> <span class="main">(</span><span class="main">(</span><span class="skolem">e0</span><span class="main">#</span><span class="skolem">es</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">C0</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ts_cons <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> t_var <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> t_field <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> t_invk <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> t_new <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> t_ucast <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> t_dcast <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> t_scast <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Method Typing Relation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A method definition $\mathit{md}$, declared in a class $C$, is
well-typed, written $\mathit{CT} \vdash \mathit{md} \texttt{OK IN}\ C$
if its body is well-typed and it has the same type (i.e., overrides)
any method with the same name declared in the superclass of $C$.›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">method_typing</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>classTable<span class="main">,</span> methodDef<span class="main">,</span> className<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">OK</span> <span class="keyword1">IN</span> _"</span> <span class="main">[</span>80<span class="main">,</span>80<span class="main">,</span>80<span class="main">]</span> 80<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
m_typing<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="free"><span class="bound"><span class="entity">CDef</span></span></span><span class="main">)</span><span class="main">;</span>
     cName <span class="free"><span class="bound"><span class="entity">CDef</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">;</span>
     cSuper <span class="free"><span class="bound"><span class="entity">CDef</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">;</span>
     mName <span class="free"><span class="bound"><span class="entity">mDef</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">;</span>
     lookup <span class="main">(</span>cMethods <span class="free"><span class="bound"><span class="entity">CDef</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">md</span><span class="main">.</span><span class="main">(</span>mName <span class="bound">md</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="free"><span class="bound"><span class="entity">mDef</span></span></span><span class="main">)</span><span class="main">;</span>
     mReturn <span class="free"><span class="bound"><span class="entity">mDef</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">C0</span></span></span><span class="main">;</span> mParams <span class="free"><span class="bound"><span class="entity">mDef</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Cxs</span></span></span><span class="main">;</span> mBody <span class="free"><span class="bound"><span class="entity">mDef</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e0</span></span></span><span class="main">;</span>
     varDefs_types <span class="free"><span class="bound"><span class="entity">Cxs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">;</span>
     varDefs_names <span class="free"><span class="bound"><span class="entity">Cxs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span>
     <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">=</span> <span class="main">(</span>map_upds Map.empty <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span><span class="main">(</span>this <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">;</span> 
     <span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main">;</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">e0</span></span></span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">E0</span></span></span><span class="main">;</span>
     <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">E0</span></span></span> <span class="main">&lt;:</span> <span class="free"><span class="bound"><span class="entity">C0</span></span></span><span class="main">;</span>
     <span class="main">∀</span><span class="bound">Ds</span> <span class="bound">D0</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">mtype(</span><span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="bound">Ds</span> <span class="main">→</span> <span class="bound">D0</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">=</span><span class="bound">Ds</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">C0</span></span></span><span class="main">=</span><span class="bound">D0</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">mDef</span></span></span> <span class="keyword1"><span class="free">OK</span></span> <span class="keyword1"><span class="free">IN</span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">method_typings</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>classTable<span class="main">,</span> methodDef list<span class="main">,</span> className<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢+</span> _ <span class="keyword1">OK</span> <span class="keyword1">IN</span> _"</span> <span class="main">[</span>80<span class="main">,</span>80<span class="main">,</span>80<span class="main">]</span> 80<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  ms_nil <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢+</span></span> <span class="main">[]</span> <span class="keyword1"><span class="free">OK</span></span> <span class="keyword1"><span class="free">IN</span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span>

<span class="main">|</span> ms_cons <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">OK</span> <span class="keyword1">IN</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">;</span> 
     <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢+</span></span> <span class="free"><span class="bound"><span class="entity">ms</span></span></span> <span class="keyword1"><span class="free">OK</span></span> <span class="keyword1"><span class="free">IN</span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢+</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ms</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">OK</span></span> <span class="keyword1"><span class="free">IN</span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Class Typing Relation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A class definition $\mathit{cd}$ is well-typed, written
$\mathit{CT}\vdash \mathit{cd} \texttt{OK}$ if its constructor
initializes each field, and all of its methods are well-typed.›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">class_typing</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>classTable<span class="main">,</span> classDef<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">OK</span>"</span> <span class="main">[</span>80<span class="main">,</span>80<span class="main">]</span> 80<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
t_class<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> cName <span class="free"><span class="bound"><span class="entity">CDef</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">;</span>            
            cSuper <span class="free"><span class="bound"><span class="entity">CDef</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">;</span>
            cConstructor <span class="free"><span class="bound"><span class="entity">CDef</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">KDef</span></span></span><span class="main">;</span>
            cMethods <span class="free"><span class="bound"><span class="entity">CDef</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span>
            kName <span class="free"><span class="bound"><span class="entity">KDef</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">;</span>
            kParams <span class="free"><span class="bound"><span class="entity">KDef</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Dg</span></span></span><span class="main">@</span><span class="free"><span class="bound"><span class="entity">Cf</span></span></span><span class="main">)</span><span class="main">;</span>
            kSuper <span class="free"><span class="bound"><span class="entity">KDef</span></span></span> <span class="main">=</span> varDefs_names <span class="free"><span class="bound"><span class="entity">Dg</span></span></span><span class="main">;</span>
            kInits <span class="free"><span class="bound"><span class="entity">KDef</span></span></span> <span class="main">=</span> varDefs_names <span class="free"><span class="bound"><span class="entity">Cf</span></span></span><span class="main">;</span>
            <span class="keyword1">fields(</span><span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Dg</span></span></span><span class="main">;</span>
            <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main">⊢+</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="keyword1">OK</span> <span class="keyword1">IN</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">CDef</span></span></span> <span class="keyword1"><span class="free">OK</span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Class Table Typing Relation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A class table is well-typed, written $\mathit{CT}\
\texttt{OK}$ if for every class name $C$, the class definition mapped
to by $\mathit{CT}$ is is well-typed and has name $C$.›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">ct_typing</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"classTable <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">OK</span>"</span> 80<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
ct_all_ok<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Object <span class="main">∉</span> dom<span class="main">(</span><span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main">)</span><span class="main">;</span> 
     <span class="main">∀</span><span class="bound">C</span> <span class="bound">CDef</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main">(</span><span class="bound">C</span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="bound">CDef</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main">⊢</span> <span class="bound">CDef</span> <span class="keyword1">OK</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>cName <span class="bound">CDef</span> <span class="main">=</span> <span class="bound">C</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="keyword1"><span class="free">OK</span></span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Evaluation Relation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The single-step and multi-step evaluation relations are
written $\mathit{CT} \vdash e \rightarrow e'$ and $\mathit{CT} \vdash
e \rightarrow^* e'$ respectively.›</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">reduction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>classTable<span class="main">,</span> exp<span class="main">,</span> exp<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">→</span> _"</span> <span class="main">[</span>80<span class="main">,</span>80<span class="main">,</span>80<span class="main">]</span> 80<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>

  r_field<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="keyword1">fields(</span><span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Cf</span></span></span><span class="main">;</span>                   
     lookup2 <span class="free"><span class="bound"><span class="entity">Cf</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">fd</span><span class="main">.</span><span class="main">(</span>vdName <span class="bound">fd</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">fi</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="free"><span class="bound"><span class="entity">ei</span></span></span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢</span></span> FieldProj <span class="main">(</span>New <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">fi</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">ei</span></span></span>"</span></span>

<span class="main">|</span> r_invk<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="keyword1">mbody(</span><span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">e0</span></span></span><span class="main">;</span>
     substs <span class="main">(</span><span class="main">(</span>map_upds Map.empty <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main">)</span><span class="main">(</span>this <span class="main">↦</span> <span class="main">(</span>New <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e0</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e0'</span></span></span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢</span></span> MethodInvk <span class="main">(</span>New <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">e0'</span></span></span>"</span></span>

<span class="main">|</span> r_cast<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">&lt;:</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢</span></span> Cast <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">(</span>New <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> New <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span>"</span></span>

<span class="main">|</span> rc_field<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e0</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">e0'</span></span></span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢</span></span> FieldProj <span class="free"><span class="bound"><span class="entity">e0</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">→</span></span> FieldProj <span class="free"><span class="bound"><span class="entity">e0'</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="main">|</span> rc_invk_recv<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e0</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">e0'</span></span></span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢</span></span> MethodInvk <span class="free"><span class="bound"><span class="entity">e0</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main"><span class="free">→</span></span> MethodInvk <span class="free"><span class="bound"><span class="entity">e0'</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span>"</span></span>

<span class="main">|</span> rc_invk_arg<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">ei</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">ei'</span></span></span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢</span></span> MethodInvk <span class="free"><span class="bound"><span class="entity">e0</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">el</span></span></span><span class="main">@</span><span class="free"><span class="bound"><span class="entity">ei</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">er</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> MethodInvk <span class="free"><span class="bound"><span class="entity">e0</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">el</span></span></span><span class="main">@</span><span class="free"><span class="bound"><span class="entity">ei'</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">er</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> rc_new_arg<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">ei</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">ei'</span></span></span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢</span></span> New <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">el</span></span></span><span class="main">@</span><span class="free"><span class="bound"><span class="entity">ei</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">er</span></span></span><span class="main">)</span> <span class="main"><span class="free">→</span></span> New <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">el</span></span></span><span class="main">@</span><span class="free"><span class="bound"><span class="entity">ei'</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">er</span></span></span><span class="main">)</span>"</span></span>

<span class="main">|</span> rc_cast<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e0</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">e0'</span></span></span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢</span></span> Cast <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">e0</span></span></span> <span class="main"><span class="free">→</span></span> Cast <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">e0'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">reductions</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>classTable<span class="main">,</span> exp<span class="main">,</span> exp<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">→*</span> _"</span> <span class="main">[</span>80<span class="main">,</span>80<span class="main">,</span>80<span class="main">]</span> 80<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  rs_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">→*</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span> 
<span class="main">|</span> rs_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">→*</span></span> <span class="free"><span class="bound"><span class="entity">e''</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span>  <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">→*</span></span> <span class="free"><span class="bound"><span class="entity">e''</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="FJAux">
<div class="head">
<h1>Theory FJAux</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       A theory of Featherweight Java in Isabelle/HOL
    Author:      Nate Foster &lt;jnfoster at cis.upenn.edu&gt;, 
                 Dimitrios Vytiniotis &lt;dimitriv at cis.upenn.edu&gt;, 2006
    Maintainer:  Nate Foster &lt;jnfoster at cis.upenn.edu&gt;,
                 Dimitrios Vytiniotis &lt;dimitriv at cis.upenn.edu&gt;
    License:     LGPL

  Auxiliary lemmas
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹{\tt FJAux}: Auxiliary Lemmas›</span></span>

<span class="keyword1"><span class="command">theory</span></span> FJAux <span class="keyword2"><span class="keyword">imports</span></span> <a href="FJDefs.html">FJDefs</a>
<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Non-FJ Lemmas›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Lists›</span></span>
<span class="keyword1" id="FJAux-mem_ith"><span class="command">lemma</span></span> mem_ith<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ei</span> <span class="main">∈</span> set <span class="free">es</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">el</span> <span class="bound">er</span><span class="main">.</span> <span class="free">es</span> <span class="main">=</span> <span class="bound">el</span><span class="main">@</span><span class="free">ei</span><span class="main">#</span><span class="bound">er</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">es</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">esh</span> <span class="skolem">est</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">esh</span> <span class="main">=</span> <span class="free">ei</span>"</span></span> 
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">esh</span> <span class="main">≠</span> <span class="free">ei</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ei</span> <span class="main">∈</span> set <span class="skolem">est</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">el</span></span> <span class="skolem"><span class="skolem">er</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">esh</span> <span class="main">#</span> <span class="skolem">est</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">esh</span><span class="main">#</span><span class="skolem">el</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">ei</span><span class="main">#</span><span class="skolem">er</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FJAux-ith_mem"><span class="command">lemma</span></span> ith_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">es</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">es</span><span class="main">!</span><span class="bound">i</span> <span class="main">∈</span> set <span class="free">es</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">es</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">h</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>   

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Maps›</span></span>

<span class="keyword1" id="FJAux-map_shuffle"><span class="command">lemma</span></span> map_shuffle<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">xs</span><span class="main">[↦]</span><span class="free">ys</span><span class="main">,</span><span class="free">x</span><span class="main">↦</span><span class="free">y</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">[↦]</span><span class="main">(</span><span class="free">ys</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>map_upds_append1<span class="main">)</span>

<span class="keyword1" id="FJAux-map_upds_index"><span class="command">lemma</span></span> map_upds_index<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">As</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">xs</span><span class="main">[↦]</span><span class="free">As</span><span class="main">]</span><span class="free">x</span> <span class="main">=</span> Some <span class="free">Ai</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span><span class="main">(</span><span class="free">As</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free">Ai</span><span class="main">)</span> 
         <span class="main">∧</span> <span class="main">(</span><span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">As</span><span class="main">)</span> 
         <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">Bs</span><span class="main">::</span><span class="tfree">'c</span> list<span class="main">)</span><span class="main">.</span><span class="main">(</span><span class="main">(</span>length <span class="bound">Bs</span> <span class="main">=</span> length <span class="free">As</span><span class="main">)</span> 
                            <span class="main">⟶</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span><span class="main">[↦]</span><span class="bound">Bs</span><span class="main">]</span> <span class="free">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">Bs</span> <span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">i</span> <span class="free">xs</span> <span class="free">As</span>"</span></span> 
   <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span><span class="main">(</span><span class="var">?P1</span> <span class="bound">i</span> <span class="free">As</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="var">?P2</span> <span class="bound">i</span> <span class="free">As</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">Bs</span><span class="main">::</span><span class="main">(</span><span class="tfree">'c</span> list<span class="main">)</span><span class="main">.</span><span class="main">(</span><span class="var">?P3</span> <span class="bound">i</span> <span class="free">xs</span> <span class="free">As</span> <span class="bound">Bs</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">As</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>list_induct2<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">[]</span><span class="main">[↦]</span><span class="main">[]</span><span class="main">]</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">Ai</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">[</span><span class="main">[]</span><span class="main">[↦]</span><span class="main">[]</span><span class="main">]</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">Ai</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">i</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span> 
  <span class="keyword3"><span class="command">assume</span></span> length_xs_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="skolem">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">xs</span> <span class="main">[↦]</span> <span class="skolem">ys</span><span class="main">]</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">Ai</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">i</span> <span class="skolem">xs</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> map_eq_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">xa</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">[↦]</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">]</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">Ai</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> map_decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">xa</span><span class="main">#</span><span class="skolem">xs</span> <span class="main">[↦]</span> <span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">xa</span><span class="main">↦</span><span class="skolem">y</span><span class="main">]</span> <span class="main">++</span> <span class="main">[</span><span class="skolem">xs</span><span class="main">[↦]</span><span class="skolem">ys</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">xa</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">xs</span><span class="main">[↦]</span><span class="skolem">ys</span><span class="main">]</span><span class="free">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span><span class="main">(</span>Some <span class="skolem">Ai'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="skolem">xa</span> <span class="main">↦</span><span class="skolem">y</span><span class="main">]</span> <span class="main">++</span> <span class="main">[</span><span class="skolem">xs</span><span class="main">[↦]</span><span class="skolem">ys</span><span class="main">]</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> Some <span class="skolem">Ai'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> map_add_find_right<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">xs</span><span class="main">[↦]</span><span class="skolem">ys</span><span class="main">]</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">Ai</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> map_eq_Some Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="operator">OF</span> P<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      R1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">Ai</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> R2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ys</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> pre_r3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">Bs</span><span class="main">::</span><span class="tfree">'c</span> list<span class="main">)</span><span class="main">.</span> <span class="var">?P3</span> <span class="skolem">i</span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="bound">Bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Bs</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'c</span> list"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> length_Bs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">Bs</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> length_Bs <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> Bs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Bs</span> <span class="main">=</span> <span class="skolem">b</span><span class="main">#</span><span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>length_Suc_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> length_Bs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ys</span> <span class="main">=</span> length <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> pre_r3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="skolem">xa</span><span class="main">↦</span><span class="skolem">b</span><span class="main">]</span> <span class="main">++</span> <span class="main">[</span><span class="skolem">xs</span><span class="main">[↦]</span><span class="skolem">bs</span><span class="main">]</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">bs</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>map_add_find_right<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> pre_r3 Bs_def length_Bs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P3</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xa</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span> <span class="skolem">Bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">with</span></span> R1 R2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xa</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">with</span></span> map_decomp map_eq_Some <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">xa</span><span class="main">↦</span><span class="skolem">y</span><span class="main">]</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">Ai</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>map_add_SomeD<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> ai_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">Ai</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x_eq_xa<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">=</span><span class="skolem">xa</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>map_upd_Some_unfold<span class="main">)</span>  
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Bs</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'c</span> list"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> length_Bs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">Bs</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> length_Bs <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> Bs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Bs</span> <span class="main">=</span> <span class="skolem">b</span><span class="main">#</span><span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>length_Suc_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> length_Bs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ys</span> <span class="main">=</span> length <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dom<span class="main">(</span><span class="main">[</span><span class="skolem">xs</span><span class="main">[↦]</span><span class="skolem">ys</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> dom<span class="main">(</span><span class="main">[</span><span class="skolem">xs</span><span class="main">[↦]</span><span class="skolem">bs</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> None <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">xs</span><span class="main">[↦]</span><span class="skolem">bs</span><span class="main">]</span> <span class="free">x</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>domIff<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> x_eq_xa <span class="keyword1"><span class="command">have</span></span> sing_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">xa</span><span class="main">↦</span><span class="skolem">b</span><span class="main">]</span> <span class="free">x</span> <span class="main">=</span> Some <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>map_upd_Some_unfold<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="skolem">xa</span><span class="main">↦</span><span class="skolem">b</span><span class="main">]</span> <span class="main">++</span> <span class="main">[</span><span class="skolem">xs</span><span class="main">[↦]</span><span class="skolem">bs</span><span class="main">]</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> Some <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>map_add_Some_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Bs_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P3</span> <span class="main">0</span> <span class="main">(</span><span class="skolem">xa</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span> <span class="skolem">Bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">with</span></span> ai_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">0</span> <span class="main">(</span><span class="skolem">xa</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹FJ Lemmas›</span></span> 

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Substitution›</span></span>

<span class="keyword1" id="FJAux-subst_list1_eq_map_substs"><span class="command">lemma</span></span> subst_list1_eq_map_substs <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> subst_list1 <span class="bound">σ</span> <span class="free">l</span> <span class="main">=</span> map <span class="main">(</span>substs <span class="bound">σ</span><span class="main">)</span> <span class="free">l</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="FJAux-subst_list2_eq_map_substs"><span class="command">lemma</span></span> subst_list2_eq_map_substs <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> subst_list2 <span class="bound">σ</span> <span class="free">l</span> <span class="main">=</span> map <span class="main">(</span>substs <span class="bound">σ</span><span class="main">)</span> <span class="free">l</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Lookup›</span></span>

<span class="keyword1" id="FJAux-lookup_functional"><span class="command">lemma</span></span> lookup_functional<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lookup <span class="free">l</span> <span class="free">f</span> <span class="main">=</span> <span class="free">o1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lookup <span class="free">l</span> <span class="free">f</span> <span class="main">=</span> <span class="free">o2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">o1</span> <span class="main">=</span> <span class="free">o2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="FJAux-lookup_true"><span class="command">lemma</span></span> lookup_true<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lookup <span class="free">l</span> <span class="free">f</span> <span class="main">=</span> Some <span class="free">r</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span><span class="main">(</span>Cons <span class="skolem">h</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">h</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>lookup.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FJAux-lookup_hd"><span class="command">lemma</span></span> lookup_hd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> length <span class="free">l</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">;</span> <span class="free">f</span> <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="main">0</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> lookup <span class="free">l</span> <span class="free">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">l</span><span class="main">!</span><span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="FJAux-lookup_split"><span class="command">lemma</span></span> lookup_split<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="free">l</span> <span class="free">f</span> <span class="main">=</span> None <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">h</span><span class="main">.</span> lookup <span class="free">l</span> <span class="free">f</span> <span class="main">=</span> Some <span class="bound">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="FJAux-lookup_index"><span class="command">lemma</span></span> lookup_index<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lookup <span class="free">l1</span> <span class="free">f</span> <span class="main">=</span> Some <span class="free">e</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">" <span class="main">⋀</span><span class="bound">l2</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="free">l1</span><span class="main">)</span><span class="main">.</span> <span class="free">e</span> <span class="main">=</span> <span class="free">l1</span><span class="main">!</span><span class="bound">i</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span>length <span class="free">l1</span> <span class="main">=</span> length <span class="bound">l2</span><span class="main">)</span> <span class="main">⟶</span> lookup2 <span class="free">l1</span> <span class="bound">l2</span> <span class="free">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">l2</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">h1</span> <span class="skolem">t1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">h1</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">&lt;</span>length <span class="main">(</span><span class="skolem">h1</span> <span class="main">#</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">∧</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">h1</span> <span class="main">#</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>lookup.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span> 
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">h1</span> <span class="main">#</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">l2</span>"</span></span>  
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l2</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="skolem">t1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h2</span></span> <span class="skolem"><span class="skolem">t2</span></span> <span class="keyword2"><span class="keyword">where</span></span> l2_def<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">l2</span> <span class="main">=</span> <span class="skolem">h2</span><span class="main">#</span><span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_Suc_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lookup2 <span class="main">(</span><span class="skolem">h1</span> <span class="main">#</span> <span class="skolem">t1</span><span class="main">)</span> <span class="skolem">l2</span> <span class="free">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">l2</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup2.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">h1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lookup <span class="skolem">t1</span> <span class="free">f</span> <span class="main">=</span> Some <span class="free">e</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>lookup.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span>length <span class="skolem">t1</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> <span class="skolem">t1</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span>  ih<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="skolem">t1</span> <span class="main">=</span> length <span class="main">(</span>tl <span class="skolem">l2</span><span class="main">)</span> <span class="main">⟶</span> lookup2 <span class="skolem">t1</span> <span class="main">(</span>tl <span class="skolem">l2</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span>tl <span class="skolem">l2</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">h1</span><span class="main">#</span><span class="skolem">t1</span><span class="main">)</span> <span class="main">∧</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">h1</span><span class="main">#</span><span class="skolem">t1</span><span class="main">)</span><span class="main">!</span><span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">h1</span> <span class="main">#</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">l2</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> lens<span class="main">:</span><span class="quoted"><span class="quoted">"length <span class="skolem">l2</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="skolem">t1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h2</span></span> <span class="skolem"><span class="skolem">t2</span></span> <span class="keyword2"><span class="keyword">where</span></span> l2_def<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">l2</span> <span class="main">=</span> <span class="skolem">h2</span><span class="main">#</span><span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_Suc_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lookup2 <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="free">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">t2</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ih l2_def lens <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lookup2 <span class="main">(</span><span class="skolem">h1</span> <span class="main">#</span> <span class="skolem">t1</span><span class="main">)</span> <span class="skolem">l2</span> <span class="free">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">l2</span><span class="main">!</span><span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> asm l2_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup2.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FJAux-lookup2_index"><span class="command">lemma</span></span> lookup2_index<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l2</span><span class="main">.</span> <span class="main">⟦</span> lookup2 <span class="free">l1</span> <span class="bound">l2</span> <span class="free">f</span> <span class="main">=</span> Some <span class="free">e</span><span class="main">;</span> 
  length <span class="free">l1</span> <span class="main">=</span> length <span class="bound">l2</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="bound">l2</span><span class="main">)</span><span class="main">.</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="bound">l2</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> lookup <span class="free">l1</span> <span class="free">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">l1</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">h1</span> <span class="skolem">t1</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l2</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="skolem">t1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h2</span></span> <span class="skolem"><span class="skolem">t2</span></span> <span class="keyword2"><span class="keyword">where</span></span> l2_def<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">l2</span> <span class="main">=</span> <span class="skolem">h2</span><span class="main">#</span><span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_Suc_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">h1</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> <span class="skolem">h2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons l2_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>lookup2.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">&lt;</span>length <span class="main">(</span><span class="skolem">h2</span><span class="main">#</span><span class="skolem">t2</span><span class="main">)</span> <span class="main">∧</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">h2</span><span class="main">#</span><span class="skolem">t2</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span> <span class="main">∧</span> lookup <span class="main">(</span><span class="skolem">h1</span> <span class="main">#</span> <span class="skolem">t1</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span><span class="skolem">h1</span> <span class="main">#</span> <span class="skolem">t1</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>lookup.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> l2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">h1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="skolem">t2</span><span class="main">.</span> <span class="free">e</span> <span class="main">=</span> <span class="skolem">t2</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> lookup <span class="skolem">t1</span> <span class="free">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">t1</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons l2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span>length <span class="skolem">t2</span> <span class="main">∧</span>  <span class="free">e</span> <span class="main">=</span> <span class="skolem">t2</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∧</span> lookup <span class="skolem">t1</span> <span class="free">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">t1</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">&lt;</span> length<span class="main">(</span><span class="skolem">h2</span><span class="main">#</span><span class="skolem">t2</span><span class="main">)</span> <span class="main">∧</span> <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">h2</span><span class="main">#</span><span class="skolem">t2</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> lookup <span class="main">(</span><span class="skolem">h1</span><span class="main">#</span><span class="skolem">t1</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span><span class="skolem">h1</span><span class="main">#</span><span class="skolem">t1</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> l2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FJAux-lookup_append"><span class="command">lemma</span></span> lookup_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lookup <span class="free">l</span> <span class="free">f</span> <span class="main">=</span> Some <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="free">l</span><span class="main">@</span><span class="free">l'</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> Some <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="FJAux-method_typings_lookup"><span class="command">lemma</span></span> method_typings_lookup<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lookup_eq_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="free">M</span> <span class="free">f</span> <span class="main">=</span> Some <span class="free">mDef</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> M_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢+</span> <span class="free">M</span> <span class="keyword1">OK</span> <span class="keyword1">IN</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢</span> <span class="free">mDef</span> <span class="keyword1">OK</span> <span class="keyword1">IN</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lookup_eq_Some M_ok 
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">h</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">h</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>method_typings.cases <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>lookup.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Functional›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹These lemmas prove that several relations are actually functions›</span></span>

<span class="keyword1" id="FJAux-mtype_functional"><span class="command">lemma</span></span> mtype_functional<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">mtype(</span><span class="free">CT</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">Cs</span> <span class="main">→</span> <span class="free">C0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="keyword1">mtype(</span><span class="free">CT</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">Ds</span> <span class="main">→</span> <span class="free">D0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ds</span><span class="main">=</span><span class="free">Cs</span> <span class="main">∧</span> <span class="free">D0</span><span class="main">=</span><span class="free">C0</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>mtype.cases<span class="main">)</span>

<span class="keyword1" id="FJAux-mbody_functional"><span class="command">lemma</span></span> mbody_functional<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mb1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">mbody(</span><span class="free">CT</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">.</span> <span class="free">e0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     mb2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">mbody(</span><span class="free">CT</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">.</span> <span class="free">d0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">∧</span> <span class="free">e0</span> <span class="main">=</span> <span class="free">d0</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>mbody.cases<span class="main">)</span>

<span class="keyword1" id="FJAux-fields_functional"><span class="command">lemma</span></span> fields_functional<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">fields(</span><span class="free">CT</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">Cf</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="keyword1">OK</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Cf'</span><span class="main">.</span> <span class="main">⟦</span> <span class="keyword1">fields(</span><span class="free">CT</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="bound">Cf'</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Cf</span> <span class="main">=</span> <span class="bound">Cf'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>f_obj <span class="skolem">CT</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">(</span>Object<span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ct_typing.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> f_obj <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> fields.cases<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>f_class <span class="skolem">CT</span> <span class="skolem">C</span> <span class="skolem">CDef</span> <span class="skolem">D</span> <span class="skolem">Cf</span> <span class="skolem">Dg</span> <span class="skolem">DgCf</span> <span class="skolem">DgCf'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> f_class_inv<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">CT</span> <span class="skolem">C</span> <span class="main">=</span> Some <span class="skolem">CDef</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>cSuper <span class="skolem">CDef</span> <span class="main">=</span> <span class="skolem">D</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>cFields <span class="skolem">CDef</span> <span class="main">=</span> <span class="skolem">Cf</span><span class="main">)</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="keyword1">OK</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> c_not_obj<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">≠</span> Object"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>ct_typing.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> f_class <span class="keyword1"><span class="command">have</span></span> flds<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="keyword1">fields(</span><span class="skolem">CT</span><span class="main">,</span><span class="skolem">C</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">DgCf'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Dg'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="keyword1">fields(</span><span class="skolem">CT</span><span class="main">,</span><span class="skolem">D</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Dg'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">DgCf'</span> <span class="main">=</span> <span class="skolem">Dg'</span> <span class="main">@</span> <span class="skolem">Cf</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> f_class_inv c_not_obj <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>fields.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Dg'</span> <span class="main">=</span> <span class="skolem">Dg</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_class <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">DgCf</span> <span class="main">=</span> <span class="skolem">Dg</span> <span class="main">@</span> <span class="skolem">Cf</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">DgCf'</span> <span class="main">=</span> <span class="skolem">Dg'</span> <span class="main">@</span> <span class="skolem">Cf</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Subtyping and Typing›</span></span>

<span class="keyword1" id="FJAux-typings_lengths"><span class="command">lemma</span></span> typings_lengths<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="free">es</span><span class="main">:</span><span class="free">Cs</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">es</span> <span class="main">=</span> length <span class="free">Cs</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">es</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Cs</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typings.cases<span class="main">)</span>

<span class="keyword1" id="FJAux-typings_index"><span class="command">lemma</span></span> typings_index<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="free">es</span><span class="main">:</span><span class="free">Cs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">es</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">es</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span><span class="free">Cs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">es</span> <span class="main">=</span> length <span class="free">Cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> typings_lengths<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">es</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">es</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span><span class="free">Cs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">es</span></span> <span class="quoted"><span class="free">Cs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>list_induct2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">esh</span> <span class="skolem">est</span> <span class="skolem">hCs</span> <span class="skolem">tCs</span> <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typings.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="FJAux-subtypings_index"><span class="command">lemma</span></span> subtypings_index<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢+</span> <span class="free">Cs</span> <span class="main">&lt;:</span> <span class="free">Ds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">Cs</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">CT</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">Cs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">&lt;:</span> <span class="main">(</span><span class="free">Ds</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
  <span class="keyword3"><span class="command">case</span></span> ss_nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ss_cons <span class="skolem">hCs</span> <span class="skolem">CT</span> <span class="skolem">tCs</span> <span class="skolem">hDs</span> <span class="skolem">tDs</span> <span class="skolem">i</span><span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FJAux-subtyping_append"><span class="command">lemma</span></span> subtyping_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢+</span> <span class="free">Cs</span> <span class="main">&lt;:</span> <span class="free">Ds</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">&lt;:</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢+</span> <span class="main">(</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">C</span><span class="main">]</span><span class="main">)</span> <span class="main">&lt;:</span> <span class="main">(</span><span class="free">Ds</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>subtypings.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>subtypings.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>subtypings.cases<span class="main">)</span>

<span class="keyword1" id="FJAux-typings_append"><span class="command">lemma</span></span> typings_append<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="free">es</span> <span class="main">:</span> <span class="free">Cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="main">(</span><span class="free">es</span><span class="main">@</span><span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">C</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">es</span> <span class="main">=</span> length <span class="free">Cs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>typings_lengths<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="main">(</span><span class="free">es</span><span class="main">@</span><span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">C</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">es</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Cs</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>list_induct2<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="main">[]</span><span class="main">:</span><span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>typings_typing.ts_nil<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="main">(</span><span class="main">[]</span><span class="main">@</span><span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span><span class="main">[]</span><span class="main">@</span><span class="main">[</span><span class="free">C</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>typings_typing.ts_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="skolem">ys</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="skolem">xs</span> <span class="main">:</span> <span class="skolem">ys</span><span class="main">;</span> <span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">C</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="free">C</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> x_xs_typs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> e_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> x_xs_typs <span class="keyword1"><span class="command">have</span></span> x_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="skolem">x</span> <span class="main">:</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="skolem">xs</span> <span class="main">:</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typings.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> IH e_typ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">@</span><span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span><span class="skolem">ys</span><span class="main">@</span><span class="main">[</span><span class="free">C</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> x_typ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">C</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>typings_typing.ts_cons<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">C</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>typings_typing.ts_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FJAux-ith_typing"><span class="command">lemma</span></span> ith_typing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Cs</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="main">(</span><span class="free">es</span><span class="main">@</span><span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> <span class="bound">Cs</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">h</span> <span class="main">:</span> <span class="main">(</span><span class="bound">Cs</span><span class="main">!</span><span class="main">(</span>length <span class="free">es</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">es</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typings.cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FJAux-ith_subtyping"><span class="command">lemma</span></span> ith_subtyping<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Ds</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">CT</span> <span class="main">⊢+</span> <span class="main">(</span><span class="free">Cs</span><span class="main">@</span><span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;:</span> <span class="bound">Ds</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">CT</span> <span class="main">⊢</span> <span class="free">h</span> <span class="main">&lt;:</span> <span class="main">(</span><span class="bound">Ds</span><span class="main">!</span><span class="main">(</span>length <span class="free">Cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">Cs</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>subtypings.cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FJAux-subtypings_refl"><span class="command">lemma</span></span> subtypings_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢+</span> <span class="free">Cs</span> <span class="main">&lt;:</span> <span class="free">Cs</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">Cs</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subtyping.s_refl subtypings.intros<span class="main">)</span>

<span class="keyword1" id="FJAux-subtypings_trans"><span class="command">lemma</span></span> subtypings_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Ds</span> <span class="bound">Es</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">CT</span> <span class="main">⊢+</span> <span class="free">Cs</span> <span class="main">&lt;:</span> <span class="bound">Ds</span><span class="main">;</span>  <span class="free">CT</span> <span class="main">⊢+</span> <span class="bound">Ds</span> <span class="main">&lt;:</span> <span class="bound">Es</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">CT</span> <span class="main">⊢+</span> <span class="free">Cs</span> <span class="main">&lt;:</span> <span class="bound">Es</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">Cs</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>subtypings.cases <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>subtypings.ss_nil<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">hCs</span> <span class="skolem">tCs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">hDs</span></span> <span class="skolem"><span class="skolem">tDs</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> h1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢</span> <span class="skolem">hCs</span> <span class="main">&lt;:</span> <span class="skolem">hDs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢+</span> <span class="skolem">tCs</span> <span class="main">&lt;:</span> <span class="skolem">tDs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ds</span> <span class="main">=</span> <span class="skolem">hDs</span><span class="main">#</span><span class="skolem">tDs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>subtypings.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">hEs</span></span> <span class="skolem"><span class="skolem">tEs</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> h2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢</span> <span class="skolem">hDs</span> <span class="main">&lt;:</span> <span class="skolem">hEs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢+</span> <span class="skolem">tDs</span> <span class="main">&lt;:</span> <span class="skolem">tEs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Es</span> <span class="main">=</span> <span class="skolem">hEs</span><span class="main">#</span><span class="skolem">tEs</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>subtypings.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> subtyping.s_trans<span class="main">[</span><span class="operator">OF</span> h1 h2<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢</span> <span class="skolem">hCs</span> <span class="main">&lt;:</span> <span class="skolem">hEs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> t1 t2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢+</span> <span class="skolem">tCs</span> <span class="main">&lt;:</span> <span class="skolem">tEs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>subtypings.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FJAux-ith_typing_sub"><span class="command">lemma</span></span> ith_typing_sub<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Cs</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="main">(</span><span class="free">es</span><span class="main">@</span><span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> <span class="bound">Cs</span><span class="main">;</span> 
     <span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">h'</span> <span class="main">:</span> <span class="free">Ci'</span><span class="main">;</span> 
     <span class="free">CT</span> <span class="main">⊢</span> <span class="free">Ci'</span> <span class="main">&lt;:</span> <span class="main">(</span><span class="bound">Cs</span><span class="main">!</span><span class="main">(</span>length <span class="free">es</span><span class="main">)</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="main">∃</span><span class="bound">Cs'</span><span class="main">.</span> <span class="main">(</span><span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="main">(</span><span class="free">es</span><span class="main">@</span><span class="main">(</span><span class="free">h'</span><span class="main">#</span><span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> <span class="bound">Cs'</span> <span class="main">∧</span> <span class="free">CT</span> <span class="main">⊢+</span> <span class="bound">Cs'</span> <span class="main">&lt;:</span> <span class="bound">Cs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">es</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> Nil
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">hCs</span></span> <span class="skolem"><span class="skolem">tCs</span></span> 
   <span class="keyword2"><span class="keyword">where</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="free">t</span> <span class="main">:</span> <span class="skolem">tCs</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> Cs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Cs</span> <span class="main">=</span> <span class="skolem">hCs</span> <span class="main">#</span> <span class="skolem">tCs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typings.cases<span class="main">)</span>
 <span class="keyword1"><span class="command">from</span></span> Cs_def Nil <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢</span> <span class="free">Ci'</span> <span class="main">&lt;:</span> <span class="skolem">hCs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">with</span></span> Cs_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢+</span> <span class="main">(</span><span class="free">Ci'</span><span class="main">#</span><span class="skolem">tCs</span><span class="main">)</span> <span class="main">&lt;:</span> <span class="skolem">Cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>subtypings.ss_cons subtypings_refl<span class="main">)</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ts Nil <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="main">(</span><span class="free">h'</span><span class="main">#</span><span class="free">t</span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span><span class="free">Ci'</span><span class="main">#</span><span class="skolem">tCs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>typings_typing.ts_cons<span class="main">)</span>
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">eh</span> <span class="skolem">et</span><span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">hCs</span></span> <span class="skolem"><span class="skolem">tCs</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="skolem">eh</span> <span class="main">:</span> <span class="skolem">hCs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="main">(</span><span class="skolem">et</span><span class="main">@</span><span class="main">(</span><span class="free">h</span><span class="main">#</span><span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">tCs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Cs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Cs</span> <span class="main">=</span> <span class="skolem">hCs</span> <span class="main">#</span> <span class="skolem">tCs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typings.cases<span class="main">)</span>
<span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> Cons <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tCs'</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="main">(</span><span class="skolem">et</span><span class="main">@</span><span class="main">(</span><span class="free">h'</span><span class="main">#</span><span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">tCs'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢+</span> <span class="skolem">tCs'</span> <span class="main">&lt;:</span> <span class="skolem">tCs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="main">(</span><span class="skolem">eh</span><span class="main">#</span><span class="main">(</span><span class="skolem">et</span><span class="main">@</span><span class="main">(</span><span class="free">h'</span><span class="main">#</span><span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span><span class="skolem">hCs</span><span class="main">#</span><span class="skolem">tCs'</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢+</span> <span class="main">(</span><span class="skolem">hCs</span><span class="main">#</span><span class="skolem">tCs'</span><span class="main">)</span> <span class="main">&lt;:</span> <span class="skolem">Cs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>typings_typing.ts_cons subtypings.ss_cons subtyping.s_refl<span class="main">)</span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
   
<span class="keyword1" id="FJAux-mem_typings"><span class="command">lemma</span></span> mem_typings<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Cs</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="free">es</span><span class="main">:</span><span class="bound">Cs</span><span class="main">;</span> <span class="free">ei</span> <span class="main">∈</span> set <span class="free">es</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">Ci</span><span class="main">.</span> <span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">ei</span><span class="main">:</span><span class="bound">Ci</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">es</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">eh</span> <span class="skolem">et</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ei</span><span class="main">=</span><span class="skolem">eh</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typings.cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FJAux-typings_proj"><span class="command">lemma</span></span> typings_proj<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="free">ds</span> <span class="main">:</span> <span class="free">As</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢+</span> <span class="free">As</span> <span class="main">&lt;:</span> <span class="free">Bs</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ds</span> <span class="main">=</span> length <span class="free">As</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ds</span> <span class="main">=</span> length <span class="free">Bs</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ds</span>"</span></span> 
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">ds</span><span class="main">!</span><span class="free">i</span> <span class="main">:</span> <span class="free">As</span><span class="main">!</span><span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢</span> <span class="free">As</span><span class="main">!</span><span class="free">i</span> <span class="main">&lt;:</span> <span class="free">Bs</span><span class="main">!</span><span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>typings_index subtypings_index<span class="main">)</span>

<span class="keyword1" id="FJAux-subtypings_length"><span class="command">lemma</span></span> subtypings_length<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢+</span> <span class="free">As</span> <span class="main">&lt;:</span> <span class="free">Bs</span> <span class="main">⟹</span> length <span class="free">As</span> <span class="main">=</span> length <span class="free">Bs</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>subtypings.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="FJAux-not_subtypes_aux"><span class="command">lemma</span></span> not_subtypes_aux<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">&lt;:</span> <span class="free">Da</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="free">Da</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="free">C</span> <span class="main">=</span> Some <span class="free">CDef</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cSuper <span class="free">CDef</span> <span class="main">=</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢</span> <span class="free">D</span> <span class="main">&lt;:</span> <span class="free">Da</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>subtyping.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>subtyping.intros<span class="main">)</span> 

<span class="keyword1" id="FJAux-not_subtypes"><span class="command">lemma</span></span> not_subtypes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢</span> <span class="free">A</span> <span class="main">&lt;:</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">D</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">CT</span> <span class="main">⊢</span> <span class="bound">D</span> <span class="main">¬&lt;:</span> <span class="free">C</span><span class="main">;</span>  <span class="free">CT</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">¬&lt;:</span> <span class="bound">D</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">CT</span> <span class="main">⊢</span> <span class="free">A</span> <span class="main">¬&lt;:</span> <span class="bound">D</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>subtyping.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> s_refl <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_trans <span class="skolem">CT</span> <span class="skolem">C</span> <span class="skolem">D</span> <span class="skolem">E</span> <span class="skolem">Da</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> da_nsub_d<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">Da</span> <span class="main">¬&lt;:</span> <span class="skolem">D</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">Da</span> <span class="main">¬&lt;:</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> da_sub_d<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">Da</span> <span class="main">&lt;:</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> d_sub_e<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">D</span> <span class="main">&lt;:</span> <span class="skolem">E</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> s_trans <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>subtyping.s_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> da_sub_d d_sub_e<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">have</span></span> d_nsub_da<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">D</span> <span class="main">¬&lt;:</span> <span class="skolem">Da</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> da_nsub_d d_nsub_da s_trans <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">¬&lt;:</span> <span class="skolem">Da</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_super <span class="skolem">CT</span> <span class="skolem">C</span> <span class="skolem">CDef</span> <span class="skolem">D</span> <span class="skolem">Da</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">≠</span> <span class="skolem">Da</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">C</span> <span class="main">≠</span> <span class="skolem">Da</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="skolem">Da</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">Da</span> <span class="main">&lt;:</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s_super <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subtyping.s_super<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> s_super <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> s_super <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_subtypes_aux<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Sub-Expressions›</span></span>

<span class="keyword1" id="FJAux-isubexpr_typing"><span class="command">lemma</span></span> isubexpr_typing<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">∈</span> <span class="keyword1">isubexprs(</span><span class="free">e0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">CT</span><span class="main">;</span>Map.empty <span class="main">⊢</span> <span class="free">e0</span> <span class="main">:</span> <span class="bound">C</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">D</span><span class="main">.</span> <span class="free">CT</span><span class="main">;</span>Map.empty <span class="main">⊢</span> <span class="free">e1</span> <span class="main">:</span> <span class="bound">D</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>isubexprs.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typing.cases <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>mem_typings<span class="main">)</span>

<span class="keyword1" id="FJAux-subexpr_typing"><span class="command">lemma</span></span> subexpr_typing<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="free">e0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">CT</span><span class="main">;</span>Map.empty <span class="main">⊢</span> <span class="free">e0</span> <span class="main">:</span> <span class="bound">C</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">D</span><span class="main">.</span> <span class="free">CT</span><span class="main">;</span>Map.empty <span class="main">⊢</span> <span class="free">e1</span> <span class="main">:</span> <span class="bound">D</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>rtrancl.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>isubexpr_typing<span class="main">)</span>

<span class="keyword1" id="FJAux-isubexpr_reduct"><span class="command">lemma</span></span> isubexpr_reduct<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d1</span> <span class="main">∈</span> <span class="keyword1">isubexprs(</span><span class="free">e1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">d2</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">CT</span> <span class="main">⊢</span> <span class="free">d1</span> <span class="main">→</span> <span class="bound">d2</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">e2</span><span class="main">.</span> <span class="free">CT</span> <span class="main">⊢</span> <span class="free">e1</span> <span class="main">→</span> <span class="bound">e2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms mem_ith
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>isubexprs.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>reduction.intros<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>reduction.intros<span class="main"><span class="keyword3">,</span></span> 
      <span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>reduction.intros<span class="main">)</span>

<span class="keyword1" id="FJAux-subexpr_reduct"><span class="command">lemma</span></span> subexpr_reduct<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d1</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="free">e1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">d2</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">CT</span> <span class="main">⊢</span> <span class="free">d1</span> <span class="main">→</span> <span class="bound">d2</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">e2</span><span class="main">.</span> <span class="free">CT</span> <span class="main">⊢</span> <span class="free">e1</span> <span class="main">→</span> <span class="bound">e2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>rtrancl.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isubexpr_reduct<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> 
</pre>
</div><div id="FJSound">
<div class="head">
<h1>Theory FJSound</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       A theory of Featherweight Java in Isabelle/HOL
    Author:      Nate Foster &lt;jnfoster at cis.upenn.edu&gt;, 
                 Dimitrios Vytiniotis &lt;dimitriv at cis.upenn.edu&gt;, 2006
    Maintainer:  Nate Foster &lt;jnfoster at cis.upenn.edu&gt;,
                 Dimitrios Vytiniotis &lt;dimitriv at cis.upenn.edu&gt;
    License:     LGPL
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹{\tt FJSound}: Type Soundness›</span></span>

<span class="keyword1"><span class="command">theory</span></span> FJSound <span class="keyword2"><span class="keyword">imports</span></span> <a href="FJAux.html">FJAux</a>
<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Type soundness is proved using the standard technique of
progress and subject reduction. The numbered lemmas and theorems in
this section correspond to the same results in the ACM TOPLAS paper.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Method Type and Body Connection›</span></span>

<span class="keyword1" id="FJSound-mtype_mbody"><span class="command">lemma</span></span> mtype_mbody<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Cs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">mtype(</span><span class="free">CT</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">Cs</span> <span class="main">→</span> <span class="free">C0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span> <span class="bound">e</span><span class="main">.</span> <span class="keyword1">mbody(</span><span class="free">CT</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">.</span> <span class="bound">e</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">=</span> length <span class="free">Cs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>mtype.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span><span class="main">(</span>mt_class <span class="skolem">C0</span> <span class="skolem">Cs</span> <span class="skolem">C</span> <span class="skolem">CDef</span> <span class="skolem">CT</span> <span class="skolem">m</span> <span class="skolem">mDef</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>varDefs_types_def varDefs_names_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>mtype.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mbody.mb_class<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span><span class="main">(</span>mt_super <span class="skolem">CT</span> <span class="skolem">C0</span> <span class="skolem">CDef</span> <span class="skolem">m</span> <span class="skolem">D</span> <span class="skolem">Cs</span> <span class="skolem">C</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">mbody(</span><span class="skolem">CT</span><span class="main">,</span><span class="skolem">m</span><span class="main">,</span><span class="skolem">D</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">.</span> <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="skolem">Cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> mt_super <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mbody.mb_super<span class="main">)</span>    
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FJSound-mtype_mbody_length"><span class="command">lemma</span></span> mtype_mbody_length<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> mt<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="keyword1">mtype(</span><span class="free">CT</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">Cs</span> <span class="main">→</span> <span class="free">C0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> mb<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="keyword1">mbody(</span><span class="free">CT</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">.</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">Cs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> mtype_mbody<span class="main">[</span><span class="operator">OF</span> mt<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs'</span></span> <span class="skolem"><span class="skolem">e'</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> mb2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">mbody(</span><span class="free">CT</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs'</span> <span class="main">.</span> <span class="skolem">e'</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"length <span class="skolem">xs'</span> <span class="main">=</span> length <span class="free">Cs</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> mbody_functional<span class="main">[</span><span class="operator">OF</span> mb mb2<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Method Types and Field Declarations of Subtypes›</span></span>

<span class="keyword1" id="FJSound-A_1_1"><span class="command">lemma</span></span> A_1_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">&lt;:</span> <span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="keyword1">OK</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">mtype(</span><span class="free">CT</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">D</span><span class="main">)</span> <span class="main">=</span> <span class="free">Cs</span> <span class="main">→</span> <span class="free">C0</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">mtype(</span><span class="free">CT</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">Cs</span> <span class="main">→</span> <span class="free">C0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>subtyping.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_refl <span class="skolem">C</span> <span class="skolem">CT</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_trans <span class="skolem">C</span> <span class="skolem">CT</span> <span class="skolem">D</span> <span class="skolem">E</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_super <span class="skolem">CT</span> <span class="skolem">C</span> <span class="skolem">CDef</span> <span class="skolem">D</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">CDef</span> <span class="keyword1">OK</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cName <span class="skolem">CDef</span> <span class="main">=</span> <span class="skolem">C</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>ct_typing.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> s_super <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢+</span> <span class="skolem">M</span> <span class="keyword1">OK</span> <span class="keyword1">IN</span> <span class="skolem">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cMethods<span class="main">:</span> <span class="quoted"><span class="quoted">"cMethods <span class="skolem">CDef</span> <span class="main">=</span> <span class="skolem">M</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>class_typing.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lookup_m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lookup <span class="skolem">M</span> <span class="main">(</span><span class="main">λ</span><span class="bound">md</span><span class="main">.</span> <span class="main">(</span>mName <span class="bound">md</span> <span class="main">=</span><span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">mDef</span><span class="main">.</span> <span class="var">?lookup_m</span> <span class="main">=</span> Some <span class="bound">mDef</span>"</span></span><span class="main">)</span> 
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mDef</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lookup_m</span> <span class="main">=</span> Some <span class="skolem">mDef</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> exE<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> mDef_name<span class="main">:</span> <span class="quoted"><span class="quoted">"mName <span class="skolem">mDef</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lookup_true<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">mDef</span> <span class="keyword1">OK</span> <span class="keyword1">IN</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> M m <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>method_typings_lookup<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">CDef'</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="skolem"><span class="skolem">Cs'</span></span> <span class="skolem"><span class="skolem">C0'</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> CT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="skolem">C</span> <span class="main">=</span> Some <span class="skolem">CDef'</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cSuper <span class="skolem">CDef'</span> <span class="main">=</span> <span class="skolem">D'</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mName <span class="skolem">mDef</span> <span class="main">=</span> <span class="skolem">m'</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> mReturn<span class="main">:</span> <span class="quoted"><span class="quoted">"mReturn <span class="skolem">mDef</span> <span class="main">=</span> <span class="skolem">C0'</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> varDefs_types<span class="main">:</span> <span class="quoted"><span class="quoted">"varDefs_types <span class="main">(</span>mParams <span class="skolem">mDef</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Cs'</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Ds</span> <span class="bound">D0</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">mtype(</span><span class="skolem">CT</span><span class="main">,</span><span class="skolem">m'</span><span class="main">,</span><span class="skolem">D'</span><span class="main">)</span> <span class="main">=</span> <span class="bound">Ds</span> <span class="main">→</span> <span class="bound">D0</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">Cs'</span><span class="main">=</span><span class="bound">Ds</span> <span class="main">∧</span> <span class="skolem">C0'</span><span class="main">=</span><span class="bound">D0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> method_typing.cases<span class="main">)</span> 
    <span class="keyword1"><span class="command">with</span></span> s_super mDef_name <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CDef</span><span class="main">=</span><span class="skolem">CDef'</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">=</span><span class="skolem">D'</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">=</span><span class="skolem">m'</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Ds</span> <span class="bound">D0</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">mtype(</span><span class="skolem">CT</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="skolem">D</span><span class="main">)</span> <span class="main">=</span> <span class="bound">Ds</span> <span class="main">→</span> <span class="bound">D0</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">Cs'</span><span class="main">=</span><span class="bound">Ds</span> <span class="main">∧</span> <span class="skolem">C0'</span> <span class="main">=</span> <span class="bound">D0</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> s_super cMethods m CT mReturn varDefs_types <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mtype.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span> 
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lookup_m</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_split<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> s_super cMethods <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>mtype.intros<span class="main">)</span>  
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="FJSound-sub_fields"><span class="command">lemma</span></span> sub_fields<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">&lt;:</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Dg</span><span class="main">.</span> <span class="keyword1">fields(</span><span class="free">CT</span><span class="main">,</span><span class="free">D</span><span class="main">)</span> <span class="main">=</span> <span class="bound">Dg</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">Cf</span><span class="main">.</span> <span class="keyword1">fields(</span><span class="free">CT</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">Dg</span><span class="main">@</span><span class="bound">Cf</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_refl <span class="skolem">CT</span> <span class="skolem">C</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">fields(</span><span class="skolem">CT</span><span class="main">,</span><span class="skolem">C</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Dg</span><span class="main">@</span><span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_trans <span class="skolem">CT</span> <span class="skolem">C</span> <span class="skolem">D</span> <span class="skolem">E</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Df</span></span> <span class="skolem"><span class="skolem">Cf</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">fields(</span><span class="skolem">CT</span><span class="main">,</span><span class="skolem">C</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">Dg</span><span class="main">@</span><span class="skolem">Df</span><span class="main">)</span><span class="main">@</span><span class="skolem">Cf</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>s_super <span class="skolem">CT</span> <span class="skolem">C</span> <span class="skolem">CDef</span> <span class="skolem">D</span> <span class="skolem">Dg</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Cf</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"cFields <span class="skolem">CDef</span> <span class="main">=</span> <span class="skolem">Cf</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">with</span></span> s_super <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">fields(</span><span class="skolem">CT</span><span class="main">,</span><span class="skolem">C</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Dg</span><span class="main">@</span><span class="skolem">Cf</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>f_class<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Substitution Lemma›</span></span>
 
<span class="keyword1" id="FJSound-A_1_2"><span class="command">lemma</span></span> A_1_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="keyword1">OK</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> <span class="free">Γ1</span> <span class="main">++</span> <span class="free">Γ2</span>"</span></span>                            
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ2</span> <span class="main">=</span> <span class="main">[</span><span class="free">xs</span> <span class="main">[↦]</span> <span class="free">Bs</span><span class="main">]</span>"</span></span>                         
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ds</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">Bs</span> <span class="main">=</span> length <span class="free">ds</span>"</span></span>                      
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">As</span><span class="main">.</span> <span class="free">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢+</span> <span class="free">ds</span> <span class="main">:</span> <span class="bound">As</span> <span class="main">∧</span> <span class="free">CT</span> <span class="main">⊢+</span> <span class="bound">As</span> <span class="main">&lt;:</span> <span class="free">Bs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="free">es</span><span class="main">:</span><span class="free">Ds</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">Cs</span><span class="main">.</span> <span class="main">(</span><span class="free">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢+</span> <span class="main">(</span><span class="main">[</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">]</span><span class="free">es</span><span class="main">)</span><span class="main">:</span><span class="bound">Cs</span> <span class="main">∧</span> <span class="free">CT</span> <span class="main">⊢+</span> <span class="bound">Cs</span> <span class="main">&lt;:</span> <span class="free">Ds</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?TYPINGS</span> <span class="main">⟹</span> <span class="var">?P1</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span><span class="main">:</span><span class="free">D</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">C</span><span class="main">.</span> <span class="main">(</span><span class="free">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span><span class="free">e</span><span class="main">)</span><span class="main">:</span><span class="bound">C</span> <span class="main">∧</span> <span class="free">CT</span> <span class="main">⊢</span> <span class="bound">C</span> <span class="main">&lt;:</span> <span class="free">D</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?TYPING</span> <span class="main">⟹</span> <span class="var">?P2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?COMMON_ASMS</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">CT</span> <span class="keyword1">OK</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">=</span> <span class="free">Γ1</span> <span class="main">++</span> <span class="free">Γ2</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">Γ2</span> <span class="main">=</span> <span class="main">[</span><span class="free">xs</span> <span class="main">[↦]</span> <span class="free">Bs</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>length <span class="free">Bs</span> <span class="main">=</span> length <span class="free">ds</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">As</span><span class="main">.</span> <span class="free">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢+</span> <span class="free">ds</span> <span class="main">:</span> <span class="bound">As</span> <span class="main">∧</span> <span class="free">CT</span> <span class="main">⊢+</span> <span class="bound">As</span> <span class="main">&lt;:</span> <span class="free">Bs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> RESULT<span class="main">:</span><span class="quoted"><span class="quoted">"  <span class="main">(</span><span class="var">?TYPINGS</span> <span class="main">⟶</span> <span class="var">?COMMON_ASMS</span> <span class="main">⟶</span> <span class="var">?P1</span><span class="main">)</span>
               <span class="main">∧</span> <span class="main">(</span><span class="var">?TYPING</span> <span class="main">⟶</span> <span class="var">?COMMON_ASMS</span> <span class="main">⟶</span> <span class="var">?P2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>typings_typing.induct<span class="main">)</span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ts_nil <span class="skolem">CT</span> <span class="skolem">Γ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢+</span> <span class="main">(</span><span class="main">[</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">]</span><span class="main">[]</span><span class="main">)</span><span class="main">:</span><span class="main">[]</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">CT</span> <span class="main">⊢+</span> <span class="main">[]</span> <span class="main">&lt;:</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> typings_typing.intros subtypings.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Cs</span><span class="main">.</span><span class="main">(</span><span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢+</span> <span class="main">(</span><span class="main">[</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">]</span><span class="main">[]</span><span class="main">)</span><span class="main">:</span><span class="bound">Cs</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">CT</span> <span class="main">⊢+</span> <span class="bound">Cs</span> <span class="main">&lt;:</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span><span class="main">(</span>ts_cons <span class="skolem">CT</span> <span class="skolem">Γ</span> <span class="skolem">e0</span> <span class="skolem">C0</span> <span class="skolem">es</span> <span class="skolem">Cs'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> asms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">CT</span> <span class="keyword1">OK</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">=</span> <span class="free">Γ1</span> <span class="main">++</span> <span class="free">Γ2</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">Γ2</span> <span class="main">=</span> <span class="main">[</span><span class="free">xs</span> <span class="main">[↦]</span> <span class="free">Bs</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>length <span class="free">Bs</span> <span class="main">=</span> length <span class="free">ds</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">As</span><span class="main">.</span> <span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢+</span> <span class="free">ds</span> <span class="main">:</span> <span class="bound">As</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢+</span> <span class="bound">As</span> <span class="main">&lt;:</span> <span class="free">Bs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> ts_cons <span class="keyword1"><span class="command">have</span></span> e0_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">e0</span> <span class="main">:</span> <span class="skolem">C0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">with</span></span> ts_cons asms <span class="keyword1"><span class="command">have</span></span> 
          <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">C</span><span class="main">.</span><span class="main">(</span><span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span> <span class="skolem">e0</span> <span class="main">:</span> <span class="bound">C</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">CT</span> <span class="main">⊢</span> <span class="bound">C</span> <span class="main">&lt;:</span> <span class="skolem">C0</span><span class="main">)</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Cs</span><span class="main">.</span><span class="main">(</span><span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢+</span> <span class="main">[</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">]</span><span class="skolem">es</span> <span class="main">:</span> <span class="bound">Cs</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">CT</span> <span class="main">⊢+</span> <span class="bound">Cs</span> <span class="main">&lt;:</span> <span class="skolem">Cs'</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="skolem"><span class="skolem">Cs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span> <span class="skolem">e0</span> <span class="main">:</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">&lt;:</span> <span class="skolem">C0</span><span class="main">)</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢+</span> <span class="main">[</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">]</span><span class="skolem">es</span> <span class="main">:</span> <span class="skolem">Cs</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">CT</span> <span class="main">⊢+</span> <span class="skolem">Cs</span> <span class="main">&lt;:</span> <span class="skolem">Cs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢+</span> <span class="main">[</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">]</span><span class="main">(</span><span class="skolem">e0</span><span class="main">#</span><span class="skolem">es</span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span><span class="skolem">C</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢+</span> <span class="main">(</span><span class="skolem">C</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">)</span> <span class="main">&lt;:</span> <span class="main">(</span><span class="skolem">C0</span><span class="main">#</span><span class="skolem">Cs'</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> typings_typing.intros subtypings.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Cs</span><span class="main">.</span> <span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢+</span> map <span class="main">(</span>substs <span class="main">[</span><span class="free">xs</span> <span class="main">[↦]</span> <span class="free">ds</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">e0</span> <span class="main">#</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">:</span> <span class="bound">Cs</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢+</span> <span class="bound">Cs</span> <span class="main">&lt;:</span> <span class="main">(</span><span class="skolem">C0</span> <span class="main">#</span> <span class="skolem">Cs'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>t_var <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">C'</span> <span class="skolem">CT</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> asms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">CT</span> <span class="keyword1">OK</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">=</span> <span class="free">Γ1</span> <span class="main">++</span> <span class="free">Γ2</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">Γ2</span> <span class="main">=</span> <span class="main">[</span><span class="free">xs</span> <span class="main">[↦]</span> <span class="free">Bs</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>length <span class="free">Bs</span> <span class="main">=</span> length <span class="free">ds</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">As</span><span class="main">.</span> <span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢+</span> <span class="free">ds</span> <span class="main">:</span> <span class="bound">As</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢+</span> <span class="bound">As</span> <span class="main">&lt;:</span> <span class="free">Bs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> 
        lengths<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">ds</span> <span class="main">=</span> length <span class="free">Bs</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> G_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">=</span> <span class="free">Γ1</span> <span class="main">++</span> <span class="free">Γ2</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> G2_def <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ2</span> <span class="main">=</span> <span class="main">[</span><span class="free">xs</span><span class="main">[↦]</span><span class="free">Bs</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> lengths G2_def <span class="keyword1"><span class="command">have</span></span> same_doms<span class="main">:</span> <span class="quoted"><span class="quoted">"dom<span class="main">(</span><span class="main">[</span><span class="free">xs</span><span class="main">[↦]</span><span class="free">ds</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> dom<span class="main">(</span><span class="free">Γ2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> asms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">C</span><span class="main">.</span> <span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> substs <span class="main">[</span><span class="free">xs</span> <span class="main">[↦]</span> <span class="free">ds</span><span class="main">]</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span> <span class="main">:</span> <span class="bound">C</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢</span> <span class="bound">C</span> <span class="main">&lt;:</span> <span class="skolem">C'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">Γ2</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> None
        <span class="keyword1"><span class="command">with</span></span> G_def t_var <span class="keyword1"><span class="command">have</span></span> G1_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ1</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">C'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>map_add_Some_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> None same_doms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> dom<span class="main">(</span><span class="main">[</span><span class="free">xs</span><span class="main">[↦]</span><span class="free">ds</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>domIff<span class="main">)</span>      
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">xs</span><span class="main">[↦]</span><span class="free">ds</span><span class="main">]</span><span class="skolem">x</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>map_add_Some_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span><span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> G1_x <span class="keyword1"><span class="command">have</span></span> 
          <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span><span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">C'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C'</span> <span class="main">&lt;:</span> <span class="skolem">C'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>typings_typing.intros subtyping.intros<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">Bi</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> G_def t_var <span class="keyword1"><span class="command">have</span></span> c'_eq_bi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C'</span> <span class="main">=</span> <span class="skolem">Bi</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_add_SomeD<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ds</span>›</span></span> asms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">Bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> Some G2_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span><span class="main">(</span><span class="free">Bs</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="skolem">Bi</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">Bs</span><span class="main">)</span> <span class="main">∧</span>
            <span class="main">(</span><span class="main">∀</span><span class="bound">l</span><span class="main">.</span><span class="main">(</span><span class="main">(</span>length <span class="bound">l</span> <span class="main">=</span> length <span class="free">Bs</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span><span class="main">[↦]</span><span class="bound">l</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">l</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_upds_index<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> bs_i_proj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Bs</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="skolem">Bi</span><span class="main">)</span>"</span></span> 
          <span class="keyword2"><span class="keyword">and</span></span> i_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">Bs</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="main">(</span><span class="bound">l</span><span class="main">::</span>exp list<span class="main">)</span><span class="main">.</span><span class="main">(</span><span class="main">(</span>length <span class="bound">l</span> <span class="main">=</span> length <span class="free">Bs</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">[</span><span class="free">xs</span><span class="main">[↦]</span><span class="bound">l</span><span class="main">]</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">l</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">from</span></span> lengths P <span class="keyword1"><span class="command">have</span></span> subst_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="free">xs</span><span class="main">[↦]</span><span class="free">ds</span><span class="main">]</span><span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ds</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> asms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">As</span></span> <span class="keyword2"><span class="keyword">where</span></span> as_ex<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢+</span> <span class="free">ds</span> <span class="main">:</span> <span class="skolem">As</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢+</span> <span class="skolem">As</span> <span class="main">&lt;:</span> <span class="free">Bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">As</span> <span class="main">=</span> length <span class="free">Bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subtypings_length<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> proj_i<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> <span class="free">ds</span><span class="main">!</span><span class="skolem">i</span> <span class="main">:</span> <span class="skolem">As</span><span class="main">!</span><span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">As</span><span class="main">!</span><span class="skolem">i</span> <span class="main">&lt;:</span> <span class="free">Bs</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> i_len lengths as_ex <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> typings_proj<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span><span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">As</span><span class="main">!</span><span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">As</span><span class="main">!</span><span class="skolem">i</span> <span class="main">&lt;:</span> <span class="skolem">C'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> c'_eq_bi bs_i_proj subst_x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span><span class="main">(</span>t_field <span class="skolem">CT</span> <span class="skolem">Γ</span> <span class="skolem">e0</span> <span class="skolem">C0</span> <span class="skolem">Cf</span> <span class="skolem">fi</span> <span class="skolem">fDef</span> <span class="skolem">Ci</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> asms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">CT</span> <span class="keyword1">OK</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">=</span> <span class="free">Γ1</span> <span class="main">++</span> <span class="free">Γ2</span><span class="main">)</span> <span class="main">∧</span>
        <span class="main">(</span><span class="free">Γ2</span> <span class="main">=</span> <span class="main">[</span><span class="free">xs</span> <span class="main">[↦]</span> <span class="free">Bs</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>length <span class="free">Bs</span> <span class="main">=</span> length <span class="free">ds</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">As</span><span class="main">.</span> <span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢+</span> <span class="free">ds</span> <span class="main">:</span> <span class="bound">As</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢+</span> <span class="bound">As</span> <span class="main">&lt;:</span> <span class="free">Bs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> t_field <span class="keyword1"><span class="command">have</span></span> flds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fields(</span><span class="skolem">CT</span><span class="main">,</span><span class="skolem">C0</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Cf</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">from</span></span> t_field asms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> e0_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span><span class="skolem">e0</span> <span class="main">:</span> <span class="skolem">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">&lt;:</span> <span class="skolem">C0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> sub_fields<span class="main">[</span><span class="operator">OF</span> sub flds<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Dg</span></span> <span class="keyword2"><span class="keyword">where</span></span> flds_C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fields(</span><span class="skolem">CT</span><span class="main">,</span><span class="skolem">C</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Cf</span><span class="main">@</span><span class="skolem">Dg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">from</span></span> t_field <span class="keyword1"><span class="command">have</span></span> lookup_CfDg<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="skolem">Cf</span><span class="main">@</span><span class="skolem">Dg</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">fd</span><span class="main">.</span> vdName <span class="bound">fd</span> <span class="main">=</span> <span class="skolem">fi</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">fDef</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>lookup_append<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> e0_typ flds_C lookup_CfDg t_field <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span><span class="main">(</span>FieldProj <span class="skolem">e0</span> <span class="skolem">fi</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">Ci</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>typings_typing.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">Ci</span> <span class="main">&lt;:</span> <span class="skolem">Ci</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>subtyping.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">C</span><span class="main">.</span> <span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span><span class="main">(</span>FieldProj <span class="skolem">e0</span> <span class="skolem">fi</span><span class="main">)</span> <span class="main">:</span> <span class="bound">C</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢</span> <span class="bound">C</span> <span class="main">&lt;:</span> <span class="skolem">Ci</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span><span class="main">(</span>t_invk <span class="skolem">CT</span> <span class="skolem">Γ</span> <span class="skolem">e0</span> <span class="skolem">C0</span> <span class="skolem">m</span> <span class="skolem">Ds</span> <span class="skolem">C</span> <span class="skolem">es</span> <span class="skolem">Cs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> asms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">CT</span> <span class="keyword1">OK</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">=</span> <span class="free">Γ1</span> <span class="main">++</span> <span class="free">Γ2</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">Γ2</span> <span class="main">=</span> <span class="main">[</span><span class="free">xs</span> <span class="main">[↦]</span> <span class="free">Bs</span><span class="main">]</span><span class="main">)</span>
          <span class="main">∧</span> <span class="main">(</span>length <span class="free">Bs</span> <span class="main">=</span> length <span class="free">ds</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">As</span><span class="main">.</span> <span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢+</span> <span class="free">ds</span> <span class="main">:</span> <span class="bound">As</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢+</span> <span class="bound">As</span> <span class="main">&lt;:</span> <span class="free">Bs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> ct_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="keyword1">OK</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">from</span></span> t_invk <span class="keyword1"><span class="command">have</span></span> mtyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">mtype(</span><span class="skolem">CT</span><span class="main">,</span><span class="skolem">m</span><span class="main">,</span><span class="skolem">C0</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Ds</span> <span class="main">→</span> <span class="skolem">C</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> subs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢+</span> <span class="skolem">Cs</span> <span class="main">&lt;:</span> <span class="skolem">Ds</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> lens<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">es</span> <span class="main">=</span> length <span class="skolem">Ds</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> t_invk asms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          e0_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span><span class="skolem">e0</span> <span class="main">:</span> <span class="skolem">C'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sub'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C'</span> <span class="main">&lt;:</span> <span class="skolem">C0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> t_invk asms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Cs'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          es_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢+</span> <span class="main">[</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">]</span><span class="skolem">es</span> <span class="main">:</span> <span class="skolem">Cs'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> subs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢+</span> <span class="skolem">Cs'</span> <span class="main">&lt;:</span> <span class="skolem">Cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> subst_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span><span class="main">(</span>MethodInvk <span class="skolem">e0</span> <span class="skolem">m</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">=</span> MethodInvk <span class="main">(</span><span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span><span class="skolem">e0</span><span class="main">)</span> <span class="skolem">m</span> <span class="main">(</span><span class="main">[</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">]</span><span class="skolem">es</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_list1_eq_map_substs<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> 
        e0_typ
        A_1_1<span class="main">[</span><span class="operator">OF</span> sub' ct_ok mtyp<span class="main">]</span> 
        es_typ
        subtypings_trans<span class="main">[</span><span class="operator">OF</span> subs' subs<span class="main">]</span> 
        lens 
        subst_e
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span><span class="main">(</span>MethodInvk <span class="skolem">e0</span> <span class="skolem">m</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>typings_typing.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">&lt;:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>subtyping.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">C'</span><span class="main">.</span> <span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span><span class="main">(</span>MethodInvk <span class="skolem">e0</span> <span class="skolem">m</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">:</span> <span class="bound">C'</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢</span> <span class="bound">C'</span> <span class="main">&lt;:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span><span class="main">(</span>t_new <span class="skolem">CT</span> <span class="skolem">C</span> <span class="skolem">Df</span> <span class="skolem">es</span> <span class="skolem">Ds</span> <span class="skolem">Γ</span> <span class="skolem">Cs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> asms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">CT</span> <span class="keyword1">OK</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">=</span> <span class="free">Γ1</span> <span class="main">++</span> <span class="free">Γ2</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">Γ2</span> <span class="main">=</span> <span class="main">[</span><span class="free">xs</span> <span class="main">[↦]</span> <span class="free">Bs</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>length <span class="free">Bs</span> <span class="main">=</span> length <span class="free">ds</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">As</span><span class="main">.</span> <span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢+</span> <span class="free">ds</span> <span class="main">:</span> <span class="bound">As</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢+</span> <span class="bound">As</span> <span class="main">&lt;:</span> <span class="free">Bs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> ct_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="keyword1">OK</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">from</span></span> t_new <span class="keyword1"><span class="command">have</span></span>
        subs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢+</span> <span class="skolem">Cs</span> <span class="main">&lt;:</span> <span class="skolem">Ds</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> flds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fields(</span><span class="skolem">CT</span><span class="main">,</span><span class="skolem">C</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Df</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">es</span> <span class="main">=</span> length <span class="skolem">Df</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> vdts<span class="main">:</span> <span class="quoted"><span class="quoted">"varDefs_types <span class="skolem">Df</span> <span class="main">=</span> <span class="skolem">Ds</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> t_new asms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Cs'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        es_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢+</span> <span class="main">[</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">]</span><span class="skolem">es</span> <span class="main">:</span> <span class="skolem">Cs'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> subs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢+</span> <span class="skolem">Cs'</span> <span class="main">&lt;:</span> <span class="skolem">Cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> subst_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span><span class="main">(</span>New <span class="skolem">C</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">=</span> New <span class="skolem">C</span> <span class="main">(</span><span class="main">[</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">]</span><span class="skolem">es</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_list2_eq_map_substs<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> es_typ subtypings_trans<span class="main">[</span><span class="operator">OF</span> subs' subs<span class="main">]</span> flds subst_e len vdts
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span><span class="main">(</span>New <span class="skolem">C</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>typings_typing.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">&lt;:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>subtyping.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">C'</span><span class="main">.</span> <span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span><span class="main">(</span>New <span class="skolem">C</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">:</span> <span class="bound">C'</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢</span> <span class="bound">C'</span> <span class="main">&lt;:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span><span class="main">(</span>t_ucast <span class="skolem">CT</span> <span class="skolem">Γ</span> <span class="skolem">e0</span> <span class="skolem">D</span> <span class="skolem">C</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> asms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">CT</span> <span class="keyword1">OK</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">=</span> <span class="free">Γ1</span> <span class="main">++</span> <span class="free">Γ2</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">Γ2</span> <span class="main">=</span> <span class="main">[</span><span class="free">xs</span> <span class="main">[↦]</span> <span class="free">Bs</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>length <span class="free">Bs</span> <span class="main">=</span> length <span class="free">ds</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">As</span><span class="main">.</span> <span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢+</span> <span class="free">ds</span> <span class="main">:</span> <span class="bound">As</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢+</span> <span class="bound">As</span> <span class="main">&lt;:</span> <span class="free">Bs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> t_ucast asms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C'</span></span> <span class="keyword2"><span class="keyword">where</span></span> e0_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span><span class="skolem">e0</span> <span class="main">:</span> <span class="skolem">C'</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span>  sub1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C'</span> <span class="main">&lt;:</span> <span class="skolem">D</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span>  sub2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">D</span> <span class="main">&lt;:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> sub1 sub2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C'</span> <span class="main">&lt;:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> s_trans<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> e0_typ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span><span class="main">(</span>Cast <span class="skolem">C</span> <span class="skolem">e0</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> typings_typing.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">&lt;:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> s_refl<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">C'</span><span class="main">.</span> <span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span><span class="main">(</span>Cast <span class="skolem">C</span> <span class="skolem">e0</span><span class="main">)</span> <span class="main">:</span> <span class="bound">C'</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢</span> <span class="bound">C'</span> <span class="main">&lt;:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span><span class="main">(</span>t_dcast <span class="skolem">CT</span> <span class="skolem">Γ</span> <span class="skolem">e0</span> <span class="skolem">D</span> <span class="skolem">C</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> asms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">CT</span> <span class="keyword1">OK</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">=</span> <span class="free">Γ1</span> <span class="main">++</span> <span class="free">Γ2</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">Γ2</span> <span class="main">=</span> <span class="main">[</span><span class="free">xs</span> <span class="main">[↦]</span> <span class="free">Bs</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>length <span class="free">Bs</span> <span class="main">=</span> length <span class="free">ds</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">As</span><span class="main">.</span> <span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢+</span> <span class="free">ds</span> <span class="main">:</span> <span class="bound">As</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢+</span> <span class="bound">As</span> <span class="main">&lt;:</span> <span class="free">Bs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> t_dcast asms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C'</span></span> <span class="keyword2"><span class="keyword">where</span></span> e0_typ<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span><span class="skolem">e0</span> <span class="main">:</span> <span class="skolem">C'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C'</span> <span class="main">&lt;:</span> <span class="skolem">C</span><span class="main">)</span>  <span class="main">∨</span> 
        <span class="main">(</span><span class="skolem">C</span> <span class="main">≠</span> <span class="skolem">C'</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">&lt;:</span> <span class="skolem">C'</span><span class="main">)</span> <span class="main">∨</span> 
        <span class="main">(</span><span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">¬&lt;:</span> <span class="skolem">C'</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C'</span> <span class="main">¬&lt;:</span> <span class="skolem">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> 
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C'</span> <span class="main">&lt;:</span> <span class="skolem">C</span>"</span></span> 
        <span class="keyword1"><span class="command">with</span></span> e0_typ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Cast <span class="skolem">C</span> <span class="skolem">e0</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> typings_typing.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> 
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C</span> <span class="main">≠</span> <span class="skolem">C'</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">&lt;:</span> <span class="skolem">C'</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">with</span></span> e0_typ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Cast <span class="skolem">C</span> <span class="skolem">e0</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> typings_typing.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> 
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">¬&lt;:</span> <span class="skolem">C'</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C'</span> <span class="main">¬&lt;:</span> <span class="skolem">C</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">with</span></span> e0_typ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Cast <span class="skolem">C</span> <span class="skolem">e0</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> typings_typing.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Cast <span class="skolem">C</span> <span class="skolem">e0</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">&lt;:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> s_refl<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">C'</span><span class="main">.</span> <span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span><span class="main">(</span>Cast <span class="skolem">C</span> <span class="skolem">e0</span><span class="main">)</span> <span class="main">:</span> <span class="bound">C'</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢</span> <span class="bound">C'</span> <span class="main">&lt;:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span><span class="main">(</span>t_scast <span class="skolem">CT</span> <span class="skolem">Γ</span> <span class="skolem">e0</span> <span class="skolem">D</span> <span class="skolem">C</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> asms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">CT</span> <span class="keyword1">OK</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">Γ</span> <span class="main">=</span> <span class="free">Γ1</span> <span class="main">++</span> <span class="free">Γ2</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">Γ2</span> <span class="main">=</span> <span class="main">[</span><span class="free">xs</span> <span class="main">[↦]</span> <span class="free">Bs</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>length <span class="free">Bs</span> <span class="main">=</span> length <span class="free">ds</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">As</span><span class="main">.</span> <span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢+</span> <span class="free">ds</span> <span class="main">:</span> <span class="bound">As</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢+</span> <span class="bound">As</span> <span class="main">&lt;:</span> <span class="free">Bs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> t_scast asms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C'</span></span> <span class="keyword2"><span class="keyword">where</span></span> e0_typ<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span><span class="skolem">e0</span> <span class="main">:</span> <span class="skolem">C'</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> sub1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C'</span> <span class="main">&lt;:</span> <span class="skolem">D</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> nsub1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">¬&lt;:</span> <span class="skolem">D</span>"</span></span>  
        <span class="keyword2"><span class="keyword">and</span></span> nsub2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">D</span> <span class="main">¬&lt;:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> not_subtypes<span class="main">[</span><span class="operator">OF</span> sub1 nsub1 nsub2<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C'</span> <span class="main">¬&lt;:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">¬&lt;:</span> <span class="skolem">C'</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">¬&lt;:</span> <span class="skolem">C'</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">&lt;:</span> <span class="skolem">C'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">&lt;:</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sub1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> s_trans<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> nsub1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Cast <span class="skolem">C</span> <span class="skolem">e0</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> e0_typ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> typings_typing.intros<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">C'</span><span class="main">.</span> <span class="skolem">CT</span><span class="main">;</span><span class="free">Γ1</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">ds</span><span class="main">/</span><span class="free">xs</span><span class="main">)</span><span class="main">(</span>Cast <span class="skolem">C</span> <span class="skolem">e0</span><span class="main">)</span> <span class="main">:</span> <span class="bound">C'</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢</span> <span class="bound">C'</span> <span class="main">&lt;:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s_refl<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?TYPINGS</span> <span class="main">⟹</span> <span class="var">?P1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?TYPING</span> <span class="main">⟹</span> <span class="var">?P2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
    

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Weakening Lemma›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This lemma is not in the same form as in TOPLAS, but rather as
we need it in subject reduction›</span></span>

<span class="keyword1" id="FJSound-A_1_3"><span class="command">lemma</span></span> A_1_3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">CT</span><span class="main">;</span><span class="free">Γ2</span> <span class="main">⊢+</span> <span class="free">es</span> <span class="main">:</span> <span class="free">Cs</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">CT</span><span class="main">;</span><span class="free">Γ1</span><span class="main">++</span><span class="free">Γ2</span> <span class="main">⊢+</span> <span class="free">es</span> <span class="main">:</span> <span class="free">Cs</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P1</span> <span class="main">⟹</span> <span class="var">?P2</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ2</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">CT</span><span class="main">;</span><span class="free">Γ1</span><span class="main">++</span><span class="free">Γ2</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">C</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q1</span> <span class="main">⟹</span> <span class="var">?Q2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?P1</span> <span class="main">⟶</span> <span class="var">?P2</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="var">?Q1</span> <span class="main">⟶</span> <span class="var">?Q2</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>typings_typing.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_add_find_right typings_typing.intros<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P1</span> <span class="main">⟹</span> <span class="var">?P2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q1</span> <span class="main">⟹</span> <span class="var">?Q2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Method Body Typing Lemma›</span></span>

<span class="keyword1" id="FJSound-A_1_4"><span class="command">lemma</span></span> A_1_4<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> ct_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="keyword1">OK</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> mb<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="keyword1">mbody(</span><span class="free">CT</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">.</span> <span class="free">e</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> mt<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="keyword1">mtype(</span><span class="free">CT</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">Ds</span> <span class="main">→</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D0</span> <span class="bound">C0</span><span class="main">.</span> <span class="main">(</span><span class="free">CT</span> <span class="main">⊢</span> <span class="free">C</span> <span class="main">&lt;:</span> <span class="bound">D0</span><span class="main">)</span> <span class="main">∧</span> 
                <span class="main">(</span><span class="free">CT</span> <span class="main">⊢</span> <span class="bound">C0</span> <span class="main">&lt;:</span> <span class="free">D</span><span class="main">)</span> <span class="main">∧</span> 
                <span class="main">(</span><span class="free">CT</span><span class="main">;</span><span class="main">[</span><span class="free">xs</span><span class="main">[↦]</span><span class="free">Ds</span><span class="main">]</span><span class="main">(</span>this <span class="main">↦</span> <span class="bound">D0</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="bound">C0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mb ct_ok mt <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mbody.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mb_class <span class="skolem">CT</span> <span class="skolem">C</span> <span class="skolem">CDef</span> <span class="skolem">m</span> <span class="skolem">mDef</span> <span class="skolem">xs</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span>
    m_param<span class="main">:</span><span class="quoted"><span class="quoted">"varDefs_types <span class="main">(</span>mParams <span class="skolem">mDef</span><span class="main">)</span> <span class="main">=</span> <span class="free">Ds</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> m_ret<span class="main">:</span><span class="quoted"><span class="quoted">"mReturn <span class="skolem">mDef</span> <span class="main">=</span> <span class="free">D</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">CDef</span> <span class="keyword1">OK</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cName <span class="skolem">CDef</span> <span class="main">=</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>mtype.cases ct_typing.cases<span class="main">)</span>  
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢+</span> <span class="main">(</span>cMethods <span class="skolem">CDef</span><span class="main">)</span> <span class="keyword1">OK</span> <span class="keyword1">IN</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>class_typing.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">mDef</span> <span class="keyword1">OK</span> <span class="keyword1">IN</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mb_class <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>method_typings_lookup<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">E0</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="skolem">CT</span><span class="main">;</span><span class="main">[</span><span class="skolem">xs</span><span class="main">[↦]</span><span class="free">Ds</span><span class="main">,</span>this<span class="main">↦</span><span class="skolem">C</span><span class="main">]</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> <span class="bound">E0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">CT</span> <span class="main">⊢</span> <span class="bound">E0</span> <span class="main">&lt;:</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mb_class m_param m_ret <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>method_typing.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E0</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="main">[</span><span class="skolem">xs</span><span class="main">[↦]</span><span class="free">Ds</span><span class="main">,</span>this<span class="main">↦</span><span class="skolem">C</span><span class="main">]</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> <span class="skolem">E0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">E0</span> <span class="main">&lt;:</span> <span class="free">D</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">&lt;:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s_refl<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mb_super <span class="skolem">CT</span> <span class="skolem">C</span> <span class="skolem">CDef</span> <span class="skolem">m</span> <span class="skolem">Da</span> <span class="skolem">xs</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> ct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="keyword1">OK</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="skolem">CT</span> <span class="keyword1">OK</span><span class="main">;</span> <span class="keyword1">mtype(</span><span class="skolem">CT</span><span class="main">,</span><span class="skolem">m</span><span class="main">,</span><span class="skolem">Da</span><span class="main">)</span> <span class="main">=</span> <span class="free">Ds</span> <span class="main">→</span> <span class="free">D</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">∃</span><span class="bound">D0</span> <span class="bound">C0</span><span class="main">.</span> <span class="main">(</span><span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">Da</span> <span class="main">&lt;:</span> <span class="bound">D0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">CT</span> <span class="main">⊢</span> <span class="bound">C0</span> <span class="main">&lt;:</span> <span class="free">D</span><span class="main">)</span> 
              <span class="main">∧</span> <span class="main">(</span><span class="skolem">CT</span><span class="main">;</span><span class="main">[</span><span class="skolem">xs</span> <span class="main">[↦]</span> <span class="free">Ds</span><span class="main">,</span> this <span class="main">↦</span> <span class="bound">D0</span><span class="main">]</span> <span class="main">⊢</span> <span class="skolem">e</span><span class="main">:</span><span class="bound">C0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> mb_super <span class="keyword1"><span class="command">have</span></span> c_sub_da<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">&lt;:</span> <span class="skolem">Da</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>s_super<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> mb_super <span class="keyword1"><span class="command">have</span></span> mt<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="keyword1">mtype(</span><span class="skolem">CT</span><span class="main">,</span><span class="skolem">m</span><span class="main">,</span><span class="skolem">Da</span><span class="main">)</span> <span class="main">=</span> <span class="free">Ds</span> <span class="main">→</span> <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mtype.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="operator">OF</span> ct mt<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D0</span></span> <span class="skolem"><span class="skolem">C0</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">Da</span> <span class="main">&lt;:</span> <span class="skolem">D0</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C0</span> <span class="main">&lt;:</span> <span class="free">D</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="main">[</span><span class="skolem">xs</span> <span class="main">[↦]</span> <span class="free">Ds</span><span class="main">,</span> this <span class="main">↦</span> <span class="skolem">D0</span><span class="main">]</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> <span class="skolem">C0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> s_trans<span class="main">[</span><span class="operator">OF</span> c_sub_da s1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Subject Reduction Theorem›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Thm_2_4_1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">→</span> <span class="free">e'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="keyword1">OK</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="bound">C</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> <span class="main">∃</span><span class="bound">C'</span><span class="main">.</span> <span class="main">(</span><span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e'</span> <span class="main">:</span> <span class="bound">C'</span> <span class="main">∧</span> <span class="free">CT</span> <span class="main">⊢</span> <span class="bound">C'</span> <span class="main">&lt;:</span> <span class="bound">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reduction.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>r_field <span class="skolem">CT</span> <span class="skolem">Ca</span> <span class="skolem">Cf</span> <span class="skolem">es</span> <span class="skolem">fi</span> <span class="skolem">e'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> FieldProj <span class="main">(</span>New <span class="skolem">Ca</span> <span class="skolem">es</span><span class="main">)</span> <span class="skolem">fi</span> <span class="main">:</span> <span class="skolem">C</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> ct_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="keyword1">OK</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> flds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fields(</span><span class="skolem">CT</span><span class="main">,</span><span class="skolem">Ca</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Cf</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> lkup2<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup2 <span class="skolem">Cf</span> <span class="skolem">es</span> <span class="main">(</span><span class="main">λ</span><span class="bound">fd</span><span class="main">.</span> vdName <span class="bound">fd</span> <span class="main">=</span> <span class="skolem">fi</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">e'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ca'</span></span> <span class="skolem"><span class="skolem">Cf'</span></span> <span class="skolem"><span class="skolem">fDef</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> new_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> New <span class="skolem">Ca</span> <span class="skolem">es</span> <span class="main">:</span> <span class="skolem">Ca'</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> flds'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="keyword1">fields(</span><span class="skolem">CT</span><span class="main">,</span><span class="skolem">Ca'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Cf'</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> lkup<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="skolem">Cf'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">fd</span><span class="main">.</span> vdName <span class="bound">fd</span> <span class="main">=</span> <span class="skolem">fi</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">fDef</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> C_def<span class="main">:</span> <span class="quoted"><span class="quoted">"vdType <span class="skolem">fDef</span> <span class="main">=</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> typing.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> Ca_Ca'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ca</span> <span class="main">=</span> <span class="skolem">Ca'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typing.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> flds' <span class="keyword1"><span class="command">have</span></span> Cf_Cf'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Cf</span> <span class="main">=</span> <span class="skolem">Cf'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>fields_functional<span class="main"><span class="main">[</span></span><span class="operator">OF</span> flds ct_ok<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> new_typ <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Cs</span></span> <span class="skolem"><span class="skolem">Ds</span></span> <span class="skolem"><span class="skolem">Cf''</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">fields(</span><span class="skolem">CT</span><span class="main">,</span><span class="skolem">Ca'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Cf''</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> es_typs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="skolem">es</span><span class="main">:</span><span class="skolem">Cs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Ds_def<span class="main">:</span> <span class="quoted"><span class="quoted">"varDefs_types <span class="skolem">Cf''</span> <span class="main">=</span> <span class="skolem">Ds</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> length_Cf_es<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">Cf''</span> <span class="main">=</span> length <span class="skolem">es</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> subs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢+</span> <span class="skolem">Cs</span> <span class="main">&lt;:</span> <span class="skolem">Ds</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typing.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Ca_Ca' <span class="keyword1"><span class="command">have</span></span>  Cf_Cf''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Cf</span> <span class="main">=</span> <span class="skolem">Cf''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>fields_functional<span class="main"><span class="main">[</span></span><span class="operator">OF</span> flds ct_ok<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> length_Cf_es Cf_Cf'' lookup2_index<span class="main">[</span><span class="operator">OF</span> lkup2<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    i_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">es</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e'</span> <span class="main">=</span> <span class="skolem">es</span><span class="main">!</span><span class="skolem">i</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lookup <span class="skolem">Cf</span> <span class="main">(</span><span class="main">λ</span><span class="bound">fd</span><span class="main">.</span> vdName <span class="bound">fd</span> <span class="main">=</span> <span class="skolem">fi</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">Cf</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> C_def Ds_def lkup lkup2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ds</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Ca_Ca' Cf_Cf' Cf_Cf'' i_bound length_Cf_es flds'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>nth_map varDefs_types_def fields_functional<span class="main"><span class="main">[</span></span><span class="operator">OF</span> flds ct_ok<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> subs es_typs <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">es</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">:</span><span class="main">(</span><span class="skolem">Cs</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">Cs</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span> <span class="main">&lt;:</span> <span class="main">(</span><span class="skolem">Ds</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> i_bound
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>typings_index subtypings_index typings_lengths<span class="main">)</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span><span class="main">(</span>r_invk <span class="skolem">CT</span> <span class="skolem">m</span> <span class="skolem">Ca</span> <span class="skolem">xs</span> <span class="skolem">e</span> <span class="skolem">ds</span> <span class="skolem">es</span> <span class="skolem">e'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> r_invk <span class="keyword1"><span class="command">have</span></span> mb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">mbody(</span><span class="skolem">CT</span><span class="main">,</span><span class="skolem">m</span><span class="main">,</span><span class="skolem">Ca</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">.</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> r_invk <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ca'</span></span> <span class="skolem"><span class="skolem">Ds</span></span> <span class="skolem"><span class="skolem">Cs</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> New <span class="skolem">Ca</span> <span class="skolem">es</span> <span class="main">:</span> <span class="skolem">Ca'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">mtype(</span><span class="skolem">CT</span><span class="main">,</span><span class="skolem">m</span><span class="main">,</span><span class="skolem">Ca'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Cs</span> <span class="main">→</span> <span class="skolem">C</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> ds_typs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="skolem">ds</span> <span class="main">:</span> <span class="skolem">Ds</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> Ds_subs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢+</span> <span class="skolem">Ds</span> <span class="main">&lt;:</span> <span class="skolem">Cs</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> l1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ds</span> <span class="main">=</span> length <span class="skolem">Cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typing.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> new_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> New <span class="skolem">Ca</span> <span class="skolem">es</span> <span class="main">:</span> <span class="skolem">Ca</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> mt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">mtype(</span><span class="skolem">CT</span><span class="main">,</span><span class="skolem">m</span><span class="main">,</span><span class="skolem">Ca</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Cs</span> <span class="main">→</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typing.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ds_typs new_typ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="main">(</span><span class="skolem">ds</span> <span class="main">@</span><span class="main">[</span>New <span class="skolem">Ca</span> <span class="skolem">es</span><span class="main">]</span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span><span class="skolem">Ds</span> <span class="main">@</span><span class="main">[</span><span class="skolem">Ca</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>typings_append<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> A_1_4<span class="main">[</span><span class="operator">OF</span> _ mb mt<span class="main">]</span> r_invk <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Da</span></span> <span class="skolem"><span class="skolem">E</span></span>  
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">Ca</span> <span class="main">&lt;:</span> <span class="skolem">Da</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> E_sub_C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">E</span> <span class="main">&lt;:</span> <span class="skolem">C</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> e0_typ1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="main">[</span><span class="skolem">xs</span><span class="main">[↦]</span><span class="skolem">Cs</span><span class="main">,</span>this<span class="main">↦</span><span class="skolem">Da</span><span class="main">]</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> <span class="skolem">E</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> Ds_subs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢+</span> <span class="main">(</span><span class="skolem">Ds</span><span class="main">@</span><span class="main">[</span><span class="skolem">Ca</span><span class="main">]</span><span class="main">)</span> <span class="main">&lt;:</span> <span class="main">(</span><span class="skolem">Cs</span><span class="main">@</span><span class="main">[</span><span class="skolem">Da</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>subtyping_append<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">As</span><span class="main">.</span> <span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="main">(</span><span class="skolem">ds</span> <span class="main">@</span><span class="main">[</span>New <span class="skolem">Ca</span> <span class="skolem">es</span><span class="main">]</span><span class="main">)</span> <span class="main">:</span> <span class="bound">As</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢+</span> <span class="bound">As</span> <span class="main">&lt;:</span> <span class="main">(</span><span class="skolem">Cs</span><span class="main">@</span><span class="main">[</span><span class="skolem">Da</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> e0_typ1 <span class="keyword1"><span class="command">have</span></span> e0_typ2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="main">(</span><span class="free">Γ</span> <span class="main">++</span> <span class="main">[</span><span class="skolem">xs</span><span class="main">[↦]</span><span class="skolem">Cs</span><span class="main">,</span>this<span class="main">↦</span><span class="skolem">Da</span><span class="main">]</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> <span class="skolem">E</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>A_1_3<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> e0_typ2 mtype_mbody_length<span class="main">[</span><span class="operator">OF</span> mt mb<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> e0_typ3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="main">(</span><span class="free">Γ</span> <span class="main">++</span> <span class="main">[</span><span class="main">(</span><span class="skolem">xs</span><span class="main">@</span><span class="main">[</span>this<span class="main">]</span><span class="main">)</span><span class="main">[↦]</span><span class="main">(</span><span class="skolem">Cs</span><span class="main">@</span><span class="main">[</span><span class="skolem">Da</span><span class="main">]</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> <span class="skolem">E</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>map_shuffle<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Γ1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?Γ2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="skolem">xs</span><span class="main">@</span><span class="main">[</span>this<span class="main">]</span><span class="main">)</span><span class="main">[↦]</span><span class="main">(</span><span class="skolem">Cs</span><span class="main">@</span><span class="main">[</span><span class="skolem">Da</span><span class="main">]</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> g_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?Γ1</span> <span class="main">++</span> <span class="var">?Γ2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?Γ1</span> <span class="main">++</span> <span class="var">?Γ2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> g2_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Γ2</span> <span class="main">=</span> <span class="var">?Γ2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> A_1_2<span class="main">[</span><span class="operator">OF</span> _ g_def g2_def _ _ ex<span class="main">]</span> e0_typ3 r_invk l1 mtype_mbody_length<span class="main">[</span><span class="operator">OF</span> mt mb<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E'</span></span> <span class="keyword2"><span class="keyword">where</span></span> e'_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> substs <span class="main">[</span><span class="main">(</span><span class="skolem">xs</span><span class="main">@</span><span class="main">[</span>this<span class="main">]</span><span class="main">)</span><span class="main">[↦]</span><span class="main">(</span><span class="skolem">ds</span><span class="main">@</span><span class="main">[</span>New <span class="skolem">Ca</span> <span class="skolem">es</span><span class="main">]</span><span class="main">)</span><span class="main">]</span> <span class="skolem">e</span> <span class="main">:</span> <span class="skolem">E'</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> E'_sub_E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">E'</span> <span class="main">&lt;:</span> <span class="skolem">E</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> e'_typ l1 mtype_mbody_length<span class="main">[</span><span class="operator">OF</span> mt mb<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> substs <span class="main">[</span><span class="skolem">xs</span><span class="main">[↦]</span><span class="skolem">ds</span><span class="main">,</span>this<span class="main">↦</span><span class="main">(</span>New <span class="skolem">Ca</span> <span class="skolem">es</span><span class="main">)</span><span class="main">]</span> <span class="skolem">e</span> <span class="main">:</span> <span class="skolem">E'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>map_shuffle<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> E'_sub_E E_sub_C <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">E'</span> <span class="main">&lt;:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subtyping.s_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> r_invk <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>r_cast <span class="skolem">CT</span> <span class="skolem">Ca</span> <span class="skolem">D</span> <span class="skolem">es</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ca'</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="skolem">D</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> New <span class="skolem">Ca</span> <span class="skolem">es</span> <span class="main">:</span> <span class="skolem">Ca'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> typing.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> r_cast <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> typing.cases<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rc_field <span class="skolem">CT</span> <span class="skolem">e0</span> <span class="skolem">e0'</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">Cf</span></span> <span class="skolem"><span class="skolem">fd</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="skolem">e0</span> <span class="main">:</span> <span class="skolem">C0</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> Cf_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fields(</span><span class="skolem">CT</span><span class="main">,</span><span class="skolem">C0</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Cf</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> fd_def<span class="main">:</span><span class="quoted"><span class="quoted">"lookup <span class="skolem">Cf</span> <span class="main">(</span><span class="main">λ</span><span class="bound">fd</span><span class="main">.</span> <span class="main">(</span>vdName <span class="bound">fd</span> <span class="main">=</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span>  <span class="main">=</span> Some <span class="skolem">fd</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"vdType <span class="skolem">fd</span> <span class="main">=</span> <span class="skolem">C</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typing.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> rc_field <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C'</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="skolem">e0'</span> <span class="main">:</span> <span class="skolem">C'</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C'</span> <span class="main">&lt;:</span> <span class="skolem">C0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sub_fields<span class="main">[</span><span class="operator">OF</span> _ Cf_def<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Cf'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">fields(</span><span class="skolem">CT</span><span class="main">,</span><span class="skolem">C'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Cf</span><span class="main">@</span><span class="skolem">Cf'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C'</span> <span class="main">&lt;:</span> <span class="skolem">C0</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> fd_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="skolem">Cf</span><span class="main">@</span><span class="skolem">Cf'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">fd</span><span class="main">.</span> <span class="main">(</span>vdName <span class="bound">fd</span> <span class="main">=</span> <span class="skolem">f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">fd</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>lookup_append<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> FieldProj <span class="skolem">e0'</span> <span class="skolem">f</span> <span class="main">:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>typings_typing.t_field<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>subtyping.s_refl<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rc_invk_recv <span class="skolem">CT</span> <span class="skolem">e0</span> <span class="skolem">e0'</span> <span class="skolem">m</span> <span class="skolem">es</span> <span class="skolem">C</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">Ds</span></span> <span class="skolem"><span class="skolem">Cs</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> ct_ok<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="keyword1">OK</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="skolem">e0</span> <span class="main">:</span> <span class="skolem">C0</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> mt<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="keyword1">mtype(</span><span class="skolem">CT</span><span class="main">,</span><span class="skolem">m</span><span class="main">,</span><span class="skolem">C0</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Ds</span> <span class="main">→</span> <span class="skolem">C</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="skolem">es</span> <span class="main">:</span> <span class="skolem">Cs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">es</span> <span class="main">=</span> length <span class="skolem">Ds</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢+</span> <span class="skolem">Cs</span> <span class="main">&lt;:</span> <span class="skolem">Ds</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typing.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> rc_invk_recv <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0'</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="skolem">e0'</span> <span class="main">:</span> <span class="skolem">C0'</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C0'</span> <span class="main">&lt;:</span> <span class="skolem">C0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> A_1_1<span class="main">[</span><span class="operator">OF</span> _ ct_ok mt<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">mtype(</span><span class="skolem">CT</span><span class="main">,</span><span class="skolem">m</span><span class="main">,</span><span class="skolem">C0'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Ds</span> <span class="main">→</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> MethodInvk <span class="skolem">e0'</span> <span class="skolem">m</span> <span class="skolem">es</span> <span class="main">:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>typings_typing.t_invk<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>subtyping.s_refl<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rc_invk_arg <span class="skolem">CT</span> <span class="skolem">ei</span> <span class="skolem">ei'</span> <span class="skolem">e0</span> <span class="skolem">m</span> <span class="skolem">el</span> <span class="skolem">er</span> <span class="skolem">C</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Cs</span></span> <span class="skolem"><span class="skolem">Ds</span></span> <span class="skolem"><span class="skolem">C0</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> typs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="main">(</span><span class="skolem">el</span><span class="main">@</span><span class="main">(</span><span class="skolem">ei</span><span class="main">#</span><span class="skolem">er</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">Cs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> e0_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="skolem">e0</span> <span class="main">:</span> <span class="skolem">C0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">mtype(</span><span class="skolem">CT</span><span class="main">,</span><span class="skolem">m</span><span class="main">,</span><span class="skolem">C0</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Ds</span> <span class="main">→</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Cs_sub_Ds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢+</span> <span class="skolem">Cs</span> <span class="main">&lt;:</span> <span class="skolem">Ds</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">el</span><span class="main">@</span><span class="main">(</span><span class="skolem">ei</span><span class="main">#</span><span class="skolem">er</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">Ds</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typing.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="skolem">ei</span><span class="main">:</span><span class="main">(</span><span class="skolem">Cs</span><span class="main">!</span><span class="main">(</span>length <span class="skolem">el</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>ith_typing<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> rc_invk_arg <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ci'</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> ei_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="skolem">ei'</span><span class="main">:</span><span class="skolem">Ci'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Ci_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">Ci'</span> <span class="main">&lt;:</span> <span class="main">(</span><span class="skolem">Cs</span><span class="main">!</span><span class="main">(</span>length <span class="skolem">el</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> ith_typing_sub<span class="main">[</span><span class="operator">OF</span> typs ei_typ Ci_sub<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Cs'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> es'_typs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="main">(</span><span class="skolem">el</span><span class="main">@</span><span class="main">(</span><span class="skolem">ei'</span><span class="main">#</span><span class="skolem">er</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">Cs'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Cs'_sub_Cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢+</span> <span class="skolem">Cs'</span> <span class="main">&lt;:</span> <span class="skolem">Cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> len <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">el</span><span class="main">@</span><span class="main">(</span><span class="skolem">ei'</span><span class="main">#</span><span class="skolem">er</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">Ds</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> es'_typs subtypings_trans<span class="main">[</span><span class="operator">OF</span> Cs'_sub_Cs Cs_sub_Ds<span class="main">]</span>  e0_typ mt <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> MethodInvk <span class="skolem">e0</span> <span class="skolem">m</span> <span class="main">(</span><span class="skolem">el</span><span class="main">@</span><span class="main">(</span><span class="skolem">ei'</span><span class="main">#</span><span class="skolem">er</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">C</span>"</span></span>      
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>typings_typing.t_invk<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>subtyping.s_refl<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rc_new_arg <span class="skolem">CT</span> <span class="skolem">ei</span> <span class="skolem">ei'</span> <span class="skolem">Ca</span> <span class="skolem">el</span> <span class="skolem">er</span> <span class="skolem">C</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Cs</span></span> <span class="skolem"><span class="skolem">Df</span></span> <span class="skolem"><span class="skolem">Ds</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> typs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="main">(</span><span class="skolem">el</span><span class="main">@</span><span class="main">(</span><span class="skolem">ei</span><span class="main">#</span><span class="skolem">er</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">Cs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> flds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fields(</span><span class="skolem">CT</span><span class="main">,</span><span class="skolem">C</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Df</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">el</span><span class="main">@</span><span class="main">(</span><span class="skolem">ei</span><span class="main">#</span><span class="skolem">er</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">Df</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Ds_def<span class="main">:</span> <span class="quoted"><span class="quoted">"varDefs_types <span class="skolem">Df</span> <span class="main">=</span> <span class="skolem">Ds</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Cs_sub_Ds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢+</span> <span class="skolem">Cs</span> <span class="main">&lt;:</span> <span class="skolem">Ds</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> C_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ca</span> <span class="main">=</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typing.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="skolem">ei</span><span class="main">:</span><span class="main">(</span><span class="skolem">Cs</span><span class="main">!</span><span class="main">(</span>length <span class="skolem">el</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>ith_typing<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> rc_new_arg <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ci'</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> ei_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="skolem">ei'</span><span class="main">:</span><span class="skolem">Ci'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Ci_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">Ci'</span> <span class="main">&lt;:</span> <span class="main">(</span><span class="skolem">Cs</span><span class="main">!</span><span class="main">(</span>length <span class="skolem">el</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> ith_typing_sub<span class="main">[</span><span class="operator">OF</span> typs ei_typ Ci_sub<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Cs'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> es'_typs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢+</span> <span class="main">(</span><span class="skolem">el</span><span class="main">@</span><span class="main">(</span><span class="skolem">ei'</span><span class="main">#</span><span class="skolem">er</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">Cs'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Cs'_sub_Cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢+</span> <span class="skolem">Cs'</span> <span class="main">&lt;:</span> <span class="skolem">Cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> len <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">el</span><span class="main">@</span><span class="main">(</span><span class="skolem">ei'</span><span class="main">#</span><span class="skolem">er</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">Df</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> es'_typs subtypings_trans<span class="main">[</span><span class="operator">OF</span> Cs'_sub_Cs Cs_sub_Ds<span class="main">]</span> flds Ds_def C_def  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> New <span class="skolem">Ca</span> <span class="main">(</span><span class="skolem">el</span><span class="main">@</span><span class="main">(</span><span class="skolem">ei'</span><span class="main">#</span><span class="skolem">er</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">C</span>"</span></span>      
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>typings_typing.t_new<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>subtyping.s_refl<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rc_cast <span class="skolem">CT</span> <span class="skolem">e0</span> <span class="skolem">e0'</span> <span class="skolem">C</span> <span class="skolem">Ca</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="skolem">e0</span> <span class="main">:</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Ca_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Ca</span> <span class="main">=</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typing.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> rc_cast <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D'</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> e0'_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="skolem">e0'</span><span class="main">:</span><span class="skolem">D'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">D'</span> <span class="main">&lt;:</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">D'</span> <span class="main">&lt;:</span> <span class="skolem">C</span><span class="main">)</span>  <span class="main">∨</span> 
    <span class="main">(</span><span class="skolem">C</span> <span class="main">≠</span> <span class="skolem">D'</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">&lt;:</span> <span class="skolem">D'</span><span class="main">)</span> <span class="main">∨</span> 
    <span class="main">(</span><span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">¬&lt;:</span> <span class="skolem">D'</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">D'</span> <span class="main">¬&lt;:</span> <span class="skolem">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">D'</span> <span class="main">&lt;:</span> <span class="skolem">C</span>"</span></span> 
    <span class="keyword1"><span class="command">with</span></span> e0'_typ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> Cast <span class="skolem">C</span> <span class="skolem">e0'</span> <span class="main">:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> typings_typing.t_ucast<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C</span> <span class="main">≠</span> <span class="skolem">D'</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">&lt;:</span> <span class="skolem">D'</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">with</span></span> e0'_typ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> Cast <span class="skolem">C</span> <span class="skolem">e0'</span> <span class="main">:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> typings_typing.t_dcast<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">C</span> <span class="main">¬&lt;:</span> <span class="skolem">D'</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">D'</span> <span class="main">¬&lt;:</span> <span class="skolem">C</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">with</span></span> e0'_typ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> Cast <span class="skolem">C</span> <span class="skolem">e0'</span> <span class="main">:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> typings_typing.t_scast<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> Cast <span class="skolem">C</span> <span class="skolem">e0'</span> <span class="main">:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Ca_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>subtyping.s_refl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Multi-Step Subject Reduction Theorem›</span></span>

<span class="keyword1"><span class="command">corollary</span></span> Cor_2_4_1_multi<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">→*</span> <span class="free">e'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="keyword1">OK</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="bound">C</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">C'</span><span class="main">.</span> <span class="main">(</span><span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e'</span> <span class="main">:</span> <span class="bound">C'</span> <span class="main">∧</span> <span class="free">CT</span> <span class="main">⊢</span> <span class="bound">C'</span> <span class="main">&lt;:</span> <span class="bound">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induct</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rs_refl <span class="skolem">CT</span> <span class="skolem">e</span> <span class="skolem">C</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>subtyping.s_refl<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span><span class="main">(</span>rs_trans <span class="skolem">CT</span> <span class="skolem">e</span> <span class="skolem">e'</span> <span class="skolem">e''</span> <span class="skolem">C</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> e_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">:</span> <span class="skolem">C</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> e_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">→</span> <span class="skolem">e'</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> ct_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="keyword1">OK</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">D</span><span class="main">.</span> <span class="main">⟦</span><span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="skolem">e'</span> <span class="main">:</span> <span class="bound">D</span><span class="main">;</span> <span class="skolem">CT</span> <span class="keyword1">OK</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">E</span><span class="main">.</span> <span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="skolem">e''</span> <span class="main">:</span> <span class="bound">E</span> <span class="main">∧</span> <span class="skolem">CT</span> <span class="main">⊢</span> <span class="bound">E</span> <span class="main">&lt;:</span> <span class="bound">D</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Thm_2_4_1<span class="main">[</span><span class="operator">OF</span> e_step ct_ok e_typ<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> e'_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="skolem">e'</span> <span class="main">:</span> <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> D_sub_C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">D</span> <span class="main">&lt;:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> IH<span class="main">[</span><span class="operator">OF</span> e'_typ ct_ok<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="skolem">e''</span><span class="main">:</span> <span class="skolem">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> E_sub_D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">E</span> <span class="main">&lt;:</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> s_trans<span class="main">[</span><span class="operator">OF</span> E_sub_D D_sub_C<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span> <span class="main">⊢</span> <span class="skolem">E</span> <span class="main">&lt;:</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> 


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Progress›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The two "progress lemmas" proved in the TOPLAS paper alone are
not quite enough to prove type soundness. We prove an additional lemma
showing that every well-typed expression is either a value or contains
a potential redex as a sub-expression.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Thm_2_4_2_1<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span>Map.empty <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"FieldProj <span class="main">(</span>New <span class="free">C0</span> <span class="free">es</span><span class="main">)</span> <span class="free">fi</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Cf</span> <span class="bound">fDef</span><span class="main">.</span> <span class="keyword1">fields(</span><span class="free">CT</span><span class="main">,</span> <span class="free">C0</span><span class="main">)</span> <span class="main">=</span> <span class="bound">Cf</span> <span class="main">∧</span> lookup <span class="bound">Cf</span> <span class="main">(</span><span class="main">λ</span><span class="bound">fd</span><span class="main">.</span> <span class="main">(</span>vdName <span class="bound">fd</span> <span class="main">=</span> <span class="free">fi</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">fDef</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ci</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span>Map.empty <span class="main">⊢</span> <span class="main">(</span>FieldProj <span class="main">(</span>New <span class="free">C0</span> <span class="free">es</span><span class="main">)</span> <span class="free">fi</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">Ci</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>subexpr_typing<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Cf</span></span> <span class="skolem"><span class="skolem">fDef</span></span> <span class="skolem"><span class="skolem">C0'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span>Map.empty <span class="main">⊢</span> <span class="main">(</span>New <span class="free">C0</span> <span class="free">es</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">C0'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">fields(</span><span class="free">CT</span><span class="main">,</span><span class="skolem">C0'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Cf</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lookup <span class="skolem">Cf</span> <span class="main">(</span><span class="main">λ</span><span class="bound">fd</span><span class="main">.</span> <span class="main">(</span>vdName <span class="bound">fd</span> <span class="main">=</span> <span class="free">fi</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">fDef</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typing.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typing.cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="FJSound-Thm_2_4_2_2"><span class="command">lemma</span></span> Thm_2_4_2_2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">es</span> <span class="free">ds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span>Map.empty <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">C</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"MethodInvk <span class="main">(</span>New <span class="free">C0</span> <span class="free">es</span><span class="main">)</span> <span class="free">m</span> <span class="free">ds</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span> <span class="bound">e0</span><span class="main">.</span> <span class="keyword1">mbody(</span><span class="free">CT</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">C0</span><span class="main">)</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">.</span> <span class="bound">e0</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">=</span> length <span class="free">ds</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span>Map.empty <span class="main">⊢</span> MethodInvk <span class="main">(</span>New <span class="free">C0</span> <span class="free">es</span><span class="main">)</span> <span class="free">m</span> <span class="free">ds</span> <span class="main">:</span> <span class="skolem">D</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>subexpr_typing<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0'</span></span> <span class="skolem"><span class="skolem">Cs</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span>Map.empty <span class="main">⊢</span> <span class="main">(</span>New <span class="free">C0</span> <span class="free">es</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">C0'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mt<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="keyword1">mtype(</span><span class="free">CT</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="skolem">C0'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Cs</span> <span class="main">→</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ds</span> <span class="main">=</span> length <span class="skolem">Cs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typing.cases<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> mtype_mbody<span class="main">[</span><span class="operator">OF</span> mt<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typing.cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
     
<span class="keyword1" id="FJSound-closed_subterm_split"><span class="command">lemma</span></span> closed_subterm_split<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">=</span> Map.empty"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"
  <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">C0</span> <span class="bound">es</span> <span class="bound">fi</span><span class="main">.</span> <span class="main">(</span>FieldProj <span class="main">(</span>New <span class="bound">C0</span> <span class="bound">es</span><span class="main">)</span> <span class="bound">fi</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="free">e</span><span class="main">)</span><span class="main">)</span>  
  <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">C0</span> <span class="bound">es</span> <span class="bound">m</span> <span class="bound">ds</span><span class="main">.</span> <span class="main">(</span>MethodInvk <span class="main">(</span>New <span class="bound">C0</span> <span class="bound">es</span><span class="main">)</span> <span class="bound">m</span> <span class="bound">ds</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="free">e</span><span class="main">)</span><span class="main">)</span>
  <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">C0</span> <span class="bound">D</span> <span class="bound">es</span><span class="main">.</span> <span class="main">(</span>Cast <span class="bound">D</span> <span class="main">(</span>New <span class="bound">C0</span> <span class="bound">es</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="free">e</span><span class="main">)</span><span class="main">)</span>
  <span class="main">∨</span> <span class="keyword1">val(</span><span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="free">e</span> <span class="main">∨</span> <span class="var">?M</span> <span class="free">e</span> <span class="main">∨</span> <span class="var">?C</span> <span class="free">e</span> <span class="main">∨</span> <span class="var">?V</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?IH</span> <span class="free">e</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">CT</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>typing_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">C</span> <span class="skolem">CT</span> <span class="skolem">Γ</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">C0</span> <span class="skolem">Ct</span> <span class="skolem">Cf</span> <span class="skolem">Ci</span> <span class="skolem">Γ</span> <span class="skolem">e0</span> <span class="skolem">fDef</span> <span class="skolem">fi</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e0</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span>FieldProj <span class="skolem">e0</span> <span class="skolem">fi</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>isubexprs.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?IH</span> <span class="skolem">e0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="skolem">e0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="skolem"><span class="skolem">fi'</span></span> <span class="keyword2"><span class="keyword">where</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"FieldProj <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es</span><span class="main">)</span> <span class="skolem">fi'</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="skolem">e0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> rtrancl_trans<span class="main">[</span><span class="operator">OF</span> s2 s1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="skolem">e0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"MethodInvk <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es</span><span class="main">)</span> <span class="skolem">m</span> <span class="skolem">ds</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="skolem">e0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> rtrancl_trans<span class="main">[</span><span class="operator">OF</span> s2 s1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="skolem">e0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="keyword2"><span class="keyword">where</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"Cast <span class="skolem">D</span> <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="skolem">e0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> rtrancl_trans<span class="main">[</span><span class="operator">OF</span> s2 s1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?V</span> <span class="skolem">e0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e0</span> <span class="main">=</span> <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">vals(</span><span class="skolem">es</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>val.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>isubexprs.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">C</span> <span class="skolem">C0</span> <span class="skolem">CT</span> <span class="skolem">Cs</span> <span class="skolem">Ds</span> <span class="skolem">Γ</span> <span class="skolem">e0</span> <span class="skolem">es</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e0</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span>MethodInvk <span class="skolem">e0</span> <span class="skolem">m</span> <span class="skolem">es</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>isubexprs.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?IH</span> <span class="skolem">e0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="skolem">e0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="skolem"><span class="skolem">fi</span></span> <span class="keyword2"><span class="keyword">where</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"FieldProj <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es</span><span class="main">)</span> <span class="skolem">fi</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="skolem">e0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> rtrancl_trans<span class="main">[</span><span class="operator">OF</span> s2 s1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="skolem">e0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">es'</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"MethodInvk <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es'</span><span class="main">)</span> <span class="skolem">m'</span> <span class="skolem">ds</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="skolem">e0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> rtrancl_trans<span class="main">[</span><span class="operator">OF</span> s2 s1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="skolem">e0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="keyword2"><span class="keyword">where</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"Cast <span class="skolem">D</span> <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="skolem">e0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> rtrancl_trans<span class="main">[</span><span class="operator">OF</span> s2 s1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?V</span> <span class="skolem">e0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">es'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e0</span> <span class="main">=</span> <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">vals(</span><span class="skolem">es'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>val.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>isubexprs.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">C</span> <span class="skolem">CT</span> <span class="skolem">Cs</span> <span class="skolem">Df</span> <span class="skolem">Ds</span> <span class="skolem">Γ</span> <span class="skolem">es</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> 
    <span class="quoted"><span class="quoted">"length <span class="skolem">es</span> <span class="main">=</span> length <span class="skolem">Cs</span>"</span></span>    
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">es</span><span class="main">;</span> <span class="skolem">CT</span><span class="main">;</span><span class="skolem">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">es</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span><span class="skolem">Cs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">;</span> <span class="skolem">Γ</span> <span class="main">=</span> Map.empty<span class="main">⟧</span> <span class="main">⟹</span> <span class="var">?IH</span> <span class="main">(</span><span class="skolem">es</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="skolem">Γ</span> <span class="main">⊢+</span> <span class="skolem">es</span> <span class="main">:</span> <span class="skolem">Cs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>typings_lengths<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">es</span><span class="main">.</span> <span class="main">(</span><span class="var">?F</span> <span class="main">(</span><span class="skolem">es</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?M</span> <span class="main">(</span><span class="skolem">es</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?C</span> <span class="main">(</span><span class="skolem">es</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="keyword1">vals(</span><span class="skolem">es</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="skolem">es</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="skolem">es</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cs</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>list_induct2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>vals_val.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">h</span> <span class="skolem">t</span> <span class="skolem">Ch</span> <span class="skolem">Ct</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> 5 <span class="keyword1"><span class="command">have</span></span> h_t_typs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="skolem">Γ</span> <span class="main">⊢+</span> <span class="main">(</span><span class="skolem">h</span><span class="main">#</span><span class="skolem">t</span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span><span class="skolem">Ch</span><span class="main">#</span><span class="skolem">Ct</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> OIH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">h</span><span class="main">#</span><span class="skolem">t</span><span class="main">)</span><span class="main">;</span> <span class="skolem">CT</span><span class="main">;</span><span class="skolem">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="skolem">h</span><span class="main">#</span><span class="skolem">t</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span><span class="main">(</span><span class="skolem">Ch</span><span class="main">#</span><span class="skolem">Ct</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">;</span> <span class="skolem">Γ</span> <span class="main">=</span> Map.empty<span class="main">⟧</span> <span class="main">⟹</span> <span class="var">?IH</span> <span class="main">(</span><span class="main">(</span><span class="skolem">h</span><span class="main">#</span><span class="skolem">t</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> G_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">=</span> Map.empty"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> h_t_typs <span class="keyword1"><span class="command">have</span></span> 
        h_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="skolem">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">h</span><span class="main">#</span><span class="skolem">t</span><span class="main">)</span><span class="main">!</span><span class="main">0</span> <span class="main">:</span> <span class="main">(</span><span class="skolem">Ch</span><span class="main">#</span><span class="skolem">Ct</span><span class="main">)</span><span class="main">!</span><span class="main">0</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> t_typs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">CT</span><span class="main">;</span><span class="skolem">Γ</span> <span class="main">⊢+</span> <span class="skolem">t</span> <span class="main">:</span> <span class="skolem">Ct</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typings.cases<span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> s_i<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">h</span><span class="main">#</span><span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> OIH<span class="main">[</span><span class="operator">OF</span> s_i<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">t</span><span class="main">;</span> <span class="skolem">CT</span><span class="main">;</span><span class="skolem">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">t</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span><span class="skolem">Ct</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">;</span> <span class="skolem">Γ</span> <span class="main">=</span> Map.empty<span class="main">⟧</span> <span class="main">⟹</span> <span class="var">?IH</span> <span class="main">(</span><span class="skolem">t</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">with</span></span> t_typs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span> 
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">t</span><span class="main">.</span> <span class="main">(</span><span class="var">?F</span> <span class="main">(</span><span class="skolem">t</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?M</span> <span class="main">(</span><span class="skolem">t</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?C</span> <span class="main">(</span><span class="skolem">t</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> 
          <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">t</span>"</span></span> 
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="main">(</span><span class="skolem">t</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?M</span> <span class="main">(</span><span class="skolem">t</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?C</span> <span class="main">(</span><span class="skolem">t</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">h</span><span class="main">#</span><span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="var">?F</span> <span class="main">(</span><span class="main">(</span><span class="skolem">h</span><span class="main">#</span><span class="skolem">t</span><span class="main">)</span><span class="main">!</span><span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?M</span> <span class="main">(</span><span class="main">(</span><span class="skolem">h</span><span class="main">#</span><span class="skolem">t</span><span class="main">)</span><span class="main">!</span><span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?C</span> <span class="main">(</span><span class="main">(</span><span class="skolem">h</span><span class="main">#</span><span class="skolem">t</span><span class="main">)</span><span class="main">!</span><span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">h</span><span class="main">#</span><span class="skolem">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="var">?F</span> <span class="main">(</span><span class="main">(</span><span class="skolem">h</span><span class="main">#</span><span class="skolem">t</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?M</span> <span class="main">(</span><span class="main">(</span><span class="skolem">h</span><span class="main">#</span><span class="skolem">t</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?C</span> <span class="main">(</span><span class="main">(</span><span class="skolem">h</span><span class="main">#</span><span class="skolem">t</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">h</span><span class="main">#</span><span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> v_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">vals(</span><span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> OIH<span class="main">[</span><span class="operator">OF</span> _ h_typ G_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?IH</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="skolem">h</span> <span class="main">∨</span> <span class="var">?M</span> <span class="skolem">h</span> <span class="main">∨</span> <span class="var">?C</span> <span class="skolem">h</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="main">(</span><span class="main">(</span><span class="skolem">h</span><span class="main">#</span><span class="skolem">t</span><span class="main">)</span><span class="main">!</span><span class="main">0</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?M</span> <span class="main">(</span><span class="main">(</span><span class="skolem">h</span><span class="main">#</span><span class="skolem">t</span><span class="main">)</span><span class="main">!</span><span class="main">0</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?C</span> <span class="main">(</span><span class="main">(</span><span class="skolem">h</span><span class="main">#</span><span class="skolem">t</span><span class="main">)</span><span class="main">!</span><span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">h</span><span class="main">#</span><span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?V</span> <span class="skolem">h</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> v_t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">vals(</span><span class="main">(</span><span class="skolem">h</span><span class="main">#</span><span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>vals_val.intros<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span><span class="main">(</span><span class="skolem">h</span><span class="main">#</span><span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span><span class="main">(</span><span class="skolem">h</span><span class="main">#</span><span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span><span class="main">(</span><span class="skolem">h</span><span class="main">#</span><span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="skolem">es</span><span class="main">.</span> <span class="var">?F</span> <span class="main">(</span><span class="skolem">es</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?M</span> <span class="main">(</span><span class="skolem">es</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?C</span><span class="main">(</span><span class="skolem">es</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">es</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="main">(</span><span class="skolem">es</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?M</span> <span class="main">(</span><span class="skolem">es</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?C</span><span class="main">(</span><span class="skolem">es</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">from</span></span> ith_mem<span class="main">[</span><span class="operator">OF</span> i_len<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">es</span><span class="main">!</span><span class="skolem">i</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span>New <span class="skolem">C</span> <span class="skolem">es</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>isubexprs.se_newarg<span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="main">(</span><span class="skolem">es</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">es'</span></span> <span class="skolem"><span class="skolem">fi</span></span> <span class="keyword2"><span class="keyword">where</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"FieldProj <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es'</span><span class="main">)</span> <span class="skolem">fi</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="skolem">es</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> rtrancl_trans<span class="main">[</span><span class="operator">OF</span> s2 s1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span><span class="main">(</span>New <span class="skolem">C</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?M</span><span class="main">(</span>New <span class="skolem">C</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?C</span><span class="main">(</span>New <span class="skolem">C</span> <span class="skolem">es</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">(</span><span class="skolem">es</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">es'</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"MethodInvk <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es'</span><span class="main">)</span> <span class="skolem">m'</span> <span class="skolem">ds</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="skolem">es</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">from</span></span> rtrancl_trans<span class="main">[</span><span class="operator">OF</span> s2 s1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span><span class="main">(</span>New <span class="skolem">C</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?M</span><span class="main">(</span>New <span class="skolem">C</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?C</span><span class="main">(</span>New <span class="skolem">C</span> <span class="skolem">es</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="main">(</span><span class="skolem">es</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">es'</span></span> <span class="keyword2"><span class="keyword">where</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"Cast <span class="skolem">D</span> <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es'</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="skolem">es</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> rtrancl_trans<span class="main">[</span><span class="operator">OF</span> s2 s1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span><span class="main">(</span>New <span class="skolem">C</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?M</span><span class="main">(</span>New <span class="skolem">C</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?C</span><span class="main">(</span>New <span class="skolem">C</span> <span class="skolem">es</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span><span class="main">(</span>New <span class="skolem">C</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?M</span><span class="main">(</span>New <span class="skolem">C</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?C</span><span class="main">(</span>New <span class="skolem">C</span> <span class="skolem">es</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">vals(</span><span class="skolem">es</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>vals_val.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">C</span> <span class="skolem">CT</span> <span class="skolem">D</span> <span class="skolem">Γ</span> <span class="skolem">e0</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e0</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span>Cast <span class="skolem">C</span> <span class="skolem">e0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>isubexprs.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 6 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?IH</span> <span class="skolem">e0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="skolem">e0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="skolem"><span class="skolem">fi</span></span> <span class="keyword2"><span class="keyword">where</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"FieldProj <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es</span><span class="main">)</span> <span class="skolem">fi</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="skolem">e0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> rtrancl_trans<span class="main">[</span><span class="operator">OF</span> s2 s1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="skolem">e0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"MethodInvk <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es</span><span class="main">)</span> <span class="skolem">m</span> <span class="skolem">ds</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="skolem">e0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> rtrancl_trans<span class="main">[</span><span class="operator">OF</span> s2 s1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="skolem">e0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="keyword2"><span class="keyword">where</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"Cast <span class="skolem">D'</span> <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="skolem">e0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> rtrancl_trans<span class="main">[</span><span class="operator">OF</span> s2 s1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?V</span> <span class="skolem">e0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">es'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e0</span> <span class="main">=</span> <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">vals(</span><span class="skolem">es'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>val.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>isubexprs.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">C</span> <span class="skolem">CT</span> <span class="skolem">D</span> <span class="skolem">Γ</span> <span class="skolem">e0</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e0</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span>Cast <span class="skolem">C</span> <span class="skolem">e0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>isubexprs.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 7 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?IH</span> <span class="skolem">e0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="skolem">e0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="skolem"><span class="skolem">fi</span></span> <span class="keyword2"><span class="keyword">where</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"FieldProj <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es</span><span class="main">)</span> <span class="skolem">fi</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="skolem">e0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> rtrancl_trans<span class="main">[</span><span class="operator">OF</span> s2 s1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="skolem">e0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"MethodInvk <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es</span><span class="main">)</span> <span class="skolem">m</span> <span class="skolem">ds</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="skolem">e0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> rtrancl_trans<span class="main">[</span><span class="operator">OF</span> s2 s1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="skolem">e0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="keyword2"><span class="keyword">where</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"Cast <span class="skolem">D'</span> <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="skolem">e0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> rtrancl_trans<span class="main">[</span><span class="operator">OF</span> s2 s1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?V</span> <span class="skolem">e0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">es'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e0</span> <span class="main">=</span> <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">vals(</span><span class="skolem">es'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>val.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>isubexprs.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>8 <span class="skolem">C</span> <span class="skolem">CT</span> <span class="skolem">D</span> <span class="skolem">Γ</span> <span class="skolem">e0</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e0</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span>Cast <span class="skolem">C</span> <span class="skolem">e0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>isubexprs.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 8 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?IH</span> <span class="skolem">e0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="skolem">e0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="skolem"><span class="skolem">fi</span></span> <span class="keyword2"><span class="keyword">where</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"FieldProj <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es</span><span class="main">)</span> <span class="skolem">fi</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="skolem">e0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> rtrancl_trans<span class="main">[</span><span class="operator">OF</span> s2 s1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="skolem">e0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"MethodInvk <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es</span><span class="main">)</span> <span class="skolem">m</span> <span class="skolem">ds</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="skolem">e0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> rtrancl_trans<span class="main">[</span><span class="operator">OF</span> s2 s1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="skolem">e0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="keyword2"><span class="keyword">where</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"Cast <span class="skolem">D'</span> <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="skolem">e0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> rtrancl_trans<span class="main">[</span><span class="operator">OF</span> s2 s1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?V</span> <span class="skolem">e0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">es'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e0</span> <span class="main">=</span> <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">vals(</span><span class="skolem">es'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>val.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>isubexprs.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Type Soundness Theorem›</span></span>     

<span class="keyword1"><span class="command">theorem</span></span> Thm_2_4_3<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> e_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span>Map.empty <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ct_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="keyword1">OK</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> multisteps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">→*</span> <span class="free">e1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> no_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">e2</span><span class="main">.</span> <span class="free">CT</span> <span class="main">⊢</span> <span class="free">e1</span> <span class="main">→</span> <span class="bound">e2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">val(</span><span class="free">e1</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">D</span><span class="main">.</span> <span class="free">CT</span><span class="main">;</span>Map.empty <span class="main">⊢</span> <span class="free">e1</span> <span class="main">:</span> <span class="bound">D</span> <span class="main">∧</span> <span class="free">CT</span> <span class="main">⊢</span> <span class="bound">D</span> <span class="main">&lt;:</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span>
      <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">D</span> <span class="bound">C</span> <span class="bound">es</span><span class="main">.</span> <span class="main">(</span>Cast <span class="bound">D</span> <span class="main">(</span>New <span class="bound">C</span> <span class="bound">es</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="free">e1</span><span class="main">)</span> <span class="main">∧</span> <span class="free">CT</span> <span class="main">⊢</span> <span class="bound">C</span> <span class="main">¬&lt;:</span> <span class="bound">D</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>  
  <span class="keyword1"><span class="command">from</span></span> assms Cor_2_4_1_multi<span class="main">[</span><span class="operator">OF</span> multisteps ct_ok e_typ<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C1</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> e1_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span>Map.empty <span class="main">⊢</span> <span class="free">e1</span> <span class="main">:</span> <span class="skolem">C1</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> C1_sub_C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢</span> <span class="skolem">C1</span> <span class="main">&lt;:</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> e1_typ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">C0</span> <span class="bound">es</span> <span class="bound">fi</span><span class="main">.</span> <span class="main">(</span>FieldProj <span class="main">(</span>New <span class="bound">C0</span> <span class="bound">es</span><span class="main">)</span> <span class="bound">fi</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="free">e1</span><span class="main">)</span><span class="main">)</span>  
    <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">C0</span> <span class="bound">es</span> <span class="bound">m</span> <span class="bound">ds</span><span class="main">.</span> <span class="main">(</span>MethodInvk <span class="main">(</span>New <span class="bound">C0</span> <span class="bound">es</span><span class="main">)</span> <span class="bound">m</span> <span class="bound">ds</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="free">e1</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">C0</span> <span class="bound">D</span> <span class="bound">es</span><span class="main">.</span> <span class="main">(</span>Cast <span class="bound">D</span> <span class="main">(</span>New <span class="bound">C0</span> <span class="bound">es</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="free">e1</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∨</span> <span class="keyword1">val(</span><span class="free">e1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="free">e1</span> <span class="main">∨</span> <span class="var">?M</span> <span class="free">e1</span> <span class="main">∨</span> <span class="var">?C</span> <span class="free">e1</span> <span class="main">∨</span> <span class="var">?V</span> <span class="free">e1</span>"</span></span><span class="main">)</span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed_subterm_split<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> 
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="free">e1</span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="skolem"><span class="skolem">fi</span></span> <span class="keyword2"><span class="keyword">where</span></span> fp<span class="main">:</span> <span class="quoted"><span class="quoted">"FieldProj <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es</span><span class="main">)</span> <span class="skolem">fi</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="free">e1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ci</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span>Map.empty <span class="main">⊢</span> FieldProj <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es</span><span class="main">)</span> <span class="skolem">fi</span> <span class="main">:</span> <span class="skolem">Ci</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> e1_typ <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>subexpr_typing<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0'</span></span> <span class="keyword2"><span class="keyword">where</span></span> new_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span>Map.empty <span class="main">⊢</span> New <span class="skolem">C0</span> <span class="skolem">es</span> <span class="main">:</span> <span class="skolem">C0'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> typing.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C0</span> <span class="main">=</span> <span class="skolem">C0'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typing.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> new_typ <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Df</span></span> <span class="keyword2"><span class="keyword">where</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fields(</span><span class="free">CT</span><span class="main">,</span><span class="skolem">C0</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Df</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> lens<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">es</span> <span class="main">=</span> length <span class="skolem">Df</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typing.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Thm_2_4_2_1<span class="main">[</span><span class="operator">OF</span> e1_typ fp<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Cf</span></span> <span class="skolem"><span class="skolem">fDef</span></span> 
      <span class="keyword2"><span class="keyword">where</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">fields(</span><span class="free">CT</span><span class="main">,</span><span class="skolem">C0</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Cf</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> lkup<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="skolem">Cf</span> <span class="main">(</span><span class="main">λ</span><span class="bound">fd</span><span class="main">.</span> vdName <span class="bound">fd</span> <span class="main">=</span> <span class="skolem">fi</span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="skolem">fDef</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> fields_functional<span class="main">[</span><span class="operator">OF</span> f1 ct_ok f2<span class="main">]</span> lens <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">es</span> <span class="main">=</span> length <span class="skolem">Cf</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> lookup_index<span class="main">[</span><span class="operator">OF</span> lkup<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span>length <span class="skolem">Cf</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fDef</span> <span class="main">=</span> <span class="skolem">Cf</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="skolem">Cf</span> <span class="main">=</span> length <span class="skolem">es</span><span class="main">)</span> <span class="main">⟶</span> lookup2 <span class="skolem">Cf</span> <span class="skolem">es</span> <span class="main">(</span><span class="main">λ</span><span class="bound">fd</span><span class="main">.</span> vdName <span class="bound">fd</span> <span class="main">=</span> <span class="skolem">fi</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">es</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lookup2 <span class="skolem">Cf</span> <span class="skolem">es</span> <span class="main">(</span><span class="main">λ</span><span class="bound">fd</span><span class="main">.</span> vdName <span class="bound">fd</span> <span class="main">=</span> <span class="skolem">fi</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">es</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> f2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢</span> FieldProj<span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es</span><span class="main">)</span> <span class="skolem">fi</span> <span class="main">→</span> <span class="main">(</span><span class="skolem">es</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>reduction.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> fp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">e2</span><span class="main">.</span> <span class="free">CT</span> <span class="main">⊢</span> <span class="free">e1</span> <span class="main">→</span> <span class="bound">e2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>subexpr_reduct<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> no_step <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="free">e1</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> mi<span class="main">:</span><span class="quoted"><span class="quoted">"MethodInvk <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es</span><span class="main">)</span> <span class="skolem">m</span> <span class="skolem">ds</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="free">e1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span>Map.empty <span class="main">⊢</span> MethodInvk <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es</span><span class="main">)</span> <span class="skolem">m</span> <span class="skolem">ds</span> <span class="main">:</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> e1_typ <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>subexpr_typing<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0'</span></span> <span class="skolem"><span class="skolem">Es</span></span> <span class="skolem"><span class="skolem">E</span></span> 
      <span class="keyword2"><span class="keyword">where</span></span> m_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span>Map.empty <span class="main">⊢</span> New <span class="skolem">C0</span> <span class="skolem">es</span> <span class="main">:</span> <span class="skolem">C0'</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">mtype(</span><span class="free">CT</span><span class="main">,</span><span class="skolem">m</span><span class="main">,</span><span class="skolem">C0'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Es</span> <span class="main">→</span> <span class="skolem">E</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ds</span> <span class="main">=</span> length <span class="skolem">Es</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typing.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Thm_2_4_2_2<span class="main">[</span><span class="operator">OF</span> e1_typ mi<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">e0</span></span> <span class="keyword2"><span class="keyword">where</span></span> mb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">mbody(</span><span class="free">CT</span><span class="main">,</span> <span class="skolem">m</span><span class="main">,</span> <span class="skolem">C0</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">.</span> <span class="skolem">e0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="skolem">ds</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢</span> <span class="main">(</span>MethodInvk <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es</span><span class="main">)</span> <span class="skolem">m</span> <span class="skolem">ds</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span>substs<span class="main">[</span><span class="skolem">xs</span><span class="main">[↦]</span><span class="skolem">ds</span><span class="main">,</span>this<span class="main">↦</span><span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es</span><span class="main">)</span><span class="main">]</span><span class="skolem">e0</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>reduction.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> mi <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">e2</span><span class="main">.</span> <span class="free">CT</span> <span class="main">⊢</span> <span class="free">e1</span> <span class="main">→</span> <span class="bound">e2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>subexpr_reduct<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> no_step <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span> <span class="free">e1</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="keyword2"><span class="keyword">where</span></span> c_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Cast <span class="skolem">D</span> <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">subexprs(</span><span class="free">e1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span>Map.empty <span class="main">⊢</span> Cast <span class="skolem">D</span> <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">D'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> e1_typ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>subexpr_typing<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C0'</span></span> <span class="keyword2"><span class="keyword">where</span></span> new_typ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CT</span><span class="main">;</span>Map.empty <span class="main">⊢</span> New <span class="skolem">C0</span> <span class="skolem">es</span> <span class="main">:</span> <span class="skolem">C0'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> D_eq_D'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="skolem">D'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typing.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> C0_eq_C0'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C0</span> <span class="main">=</span> <span class="skolem">C0'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>typing.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢</span> <span class="skolem">C0</span> <span class="main">&lt;:</span> <span class="skolem">D</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢</span> Cast <span class="skolem">D</span> <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span>New <span class="skolem">C0</span> <span class="skolem">es</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>reduction.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> c_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">e2</span><span class="main">.</span> <span class="free">CT</span> <span class="main">⊢</span> <span class="free">e1</span> <span class="main">→</span> <span class="bound">e2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>subexpr_reduct<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> no_step <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> c_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?V</span> <span class="free">e1</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Cor_2_4_1_multi<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> 
</pre>
</div><div id="Execute">
<div class="head">
<h1>Theory Execute</h1>
</div>
<pre class="source"><span class="comment1">(*  Author:      Lukas Bulwahn, TU Muenchen, 2009  *)</span>

<span class="keyword1"><span class="command">theory</span></span> Execute
<span class="keyword2"><span class="keyword">imports</span></span> <a href="FJSound.html">FJSound</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Executing FeatherweightJava programs›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We execute FeatherweightJava programs using the predicate compiler.›</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i <span class="main">=&gt;</span> i <span class="main">=&gt;</span> i <span class="main">=&gt;</span> bool<span class="main">,</span>
  i <span class="main">=&gt;</span> i <span class="main">=&gt;</span> o <span class="main">=&gt;</span> bool as supertypes_of<span class="main">)</span> <span class="quoted"><span class="quoted">subtyping</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">thm</span></span> subtyping.equation

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The reduction relation requires that we inverse the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">List.append</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> function.
Therefore, we define a new predicate append and derive introduction rules.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">append</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">append</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">zs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code_pred_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"append <span class="main">[]</span> <span class="free">xs</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> append_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code_pred_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"append <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span> <span class="main">⟹</span> append <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="free">ys</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">zs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> append_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹With this at hand, we derive new introduction rules for the reduction relation:›</span></span>

<span class="keyword1" id="Execute-rc_invk_arg'"><span class="command">lemma</span></span> rc_invk_arg'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢</span> <span class="free">ei</span> <span class="main">→</span> <span class="free">ei'</span> <span class="main">⟹</span> append <span class="free">el</span> <span class="main">(</span><span class="free">ei</span> <span class="main">#</span> <span class="free">er</span><span class="main">)</span> <span class="free">e'</span> <span class="main">⟹</span> append <span class="free">el</span> <span class="main">(</span><span class="free">ei'</span> <span class="main">#</span> <span class="free">er</span><span class="main">)</span> <span class="free">e''</span> <span class="main">⟹</span>
<span class="free">CT</span> <span class="main">⊢</span> MethodInvk <span class="free">e</span> <span class="free">m</span> <span class="free">e'</span> <span class="main">→</span> MethodInvk <span class="free">e</span> <span class="free">m</span> <span class="free">e''</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> append_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">rule</span> reduction.intros<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Execute-rc_new_arg'"><span class="command">lemma</span></span> rc_new_arg'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">CT</span> <span class="main">⊢</span> <span class="free">ei</span> <span class="main">→</span> <span class="free">ei'</span> <span class="main">⟹</span> append <span class="free">el</span> <span class="main">(</span><span class="free">ei</span> <span class="main">#</span> <span class="free">er</span><span class="main">)</span> <span class="free">e</span> <span class="main">⟹</span> append <span class="free">el</span> <span class="main">(</span><span class="free">ei'</span> <span class="main">#</span> <span class="free">er</span><span class="main">)</span> <span class="free">e'</span>
   <span class="main">==&gt;</span> <span class="free">CT</span> <span class="main">⊢</span> New <span class="free">C</span> <span class="free">e</span> <span class="main">→</span> New <span class="free">C</span> <span class="free">e'</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> append_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">rule</span> reduction.intros<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code_pred_intro</span><span class="main">]</span> <span class="main">=</span> reduction.intros<span class="main">(</span>1-5<span class="main">)</span>
  rc_invk_arg' rc_new_arg' reduction.intros<span class="main">(</span>8<span class="main">)</span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i <span class="main">=&gt;</span> i <span class="main">=&gt;</span> i <span class="main">=&gt;</span> bool<span class="main">,</span> i <span class="main">=&gt;</span> i <span class="main">=&gt;</span> o <span class="main">=&gt;</span> bool as reduce<span class="main">)</span> <span class="quoted"><span class="quoted">reduction</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">case</span></span> append
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> append_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xa</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> reduction
  <span class="keyword1"><span class="command">from</span></span> reduction.prems <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reduction.cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> r_field
    <span class="keyword1"><span class="command">with</span></span> reduction<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> r_invk
    <span class="keyword1"><span class="command">with</span></span> reduction<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> r_cast
    <span class="keyword1"><span class="command">with</span></span> reduction<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> rc_field
    <span class="keyword1"><span class="command">with</span></span> reduction<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> rc_invk_recv
    <span class="keyword1"><span class="command">with</span></span> reduction<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> rc_invk_arg
    <span class="keyword1"><span class="command">with</span></span> reduction<span class="main">(</span>6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> append_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> rc_new_arg
    <span class="keyword1"><span class="command">with</span></span> reduction<span class="main">(</span>7<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> append_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> rc_cast
    <span class="keyword1"><span class="command">with</span></span> reduction<span class="main">(</span>8<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">thm</span></span> reduction.equation

<span class="keyword1"><span class="command">code_pred</span></span> <span class="quoted"><span class="quoted">reductions</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">thm</span></span> reductions.equation

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We also make the class typing executable: this requires that
  we derive rules for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"method_typing"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">method_typing_aux</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">method_typing_aux</span> <span class="free"><span class="bound"><span class="entity">CT</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="bound">Ds</span> <span class="bound">D0</span><span class="main">.</span> <span class="keyword1">mtype(</span><span class="free"><span class="bound"><span class="entity">CT</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="bound">Ds</span> <span class="main">→</span> <span class="bound">D0</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">Cs</span></span></span> <span class="main">=</span> <span class="bound">Ds</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span> <span class="bound">D0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Execute-method_typing_aux"><span class="command">lemma</span></span> method_typing_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">Ds</span> <span class="bound">D0</span><span class="main">.</span> <span class="keyword1">mtype(</span><span class="free">CT</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">D</span><span class="main">)</span> <span class="main">=</span> <span class="bound">Ds</span> <span class="main">→</span> <span class="bound">D0</span> <span class="main">⟶</span> <span class="free">Cs</span> <span class="main">=</span> <span class="bound">Ds</span> <span class="main">∧</span> <span class="free">C</span> <span class="main">=</span> <span class="bound">D0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> method_typing_aux <span class="free">CT</span> <span class="free">m</span> <span class="free">D</span> <span class="free">Cs</span> <span class="free">C</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> method_typing_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code_pred_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">mtype(</span><span class="free">CT</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">D</span><span class="main">)</span> <span class="main">=</span> <span class="free">Ds</span> <span class="main">→</span> <span class="free">D0</span> <span class="main">⟹</span> <span class="free">Cs</span> <span class="main">≠</span> <span class="free">Ds</span> <span class="main">⟹</span> method_typing_aux <span class="free">CT</span> <span class="free">m</span> <span class="free">D</span> <span class="free">Cs</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> method_typing_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code_pred_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">mtype(</span><span class="free">CT</span><span class="main">,</span><span class="free">m</span><span class="main">,</span><span class="free">D</span><span class="main">)</span> <span class="main">=</span> <span class="free">Ds</span> <span class="main">→</span> <span class="free">D0</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">≠</span> <span class="free">D0</span> <span class="main">⟹</span> method_typing_aux <span class="free">CT</span> <span class="free">m</span> <span class="free">D</span> <span class="free">Cs</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> method_typing_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> method_typing.intros<span class="main">[</span><span class="operator">unfolded</span> method_typing_aux<span class="main">,</span> <span class="operator">code_pred_intro</span><span class="main">]</span>

<span class="keyword1"><span class="command">declare</span></span> class_typing.intros<span class="main">[</span><span class="operator">unfolded</span> append_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">code_pred_intro</span><span class="main">]</span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i <span class="main">=&gt;</span> i <span class="main">=&gt;</span> bool<span class="main">)</span> <span class="quoted"><span class="quoted">class_typing</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">case</span></span> class_typing
  <span class="keyword1"><span class="command">from</span></span> class_typing.cases<span class="main">[</span><span class="operator">OF</span> class_typing.prems<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">thesis</span></span><span class="main">]</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> append_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> method_typing
  <span class="keyword1"><span class="command">from</span></span> method_typing.cases<span class="main">[</span><span class="operator">OF</span> method_typing.prems<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">thesis</span></span><span class="main">]</span> this<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> append_def method_typing_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> method_typing_aux
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> method_typing_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A simple example›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now execute a simple FJ example program:›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">A</span> <span class="main">::</span> <span class="quoted">className</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">==</span> Suc <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">B</span> <span class="main">::</span> <span class="quoted">className</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">==</span> <span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cPair</span> <span class="main">::</span> <span class="quoted">className</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">cPair</span> <span class="main">==</span> <span class="numeral">3</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">classA_Def</span> <span class="main">::</span> <span class="quoted">classDef</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">classA_Def</span> <span class="main">=</span> <span class="main">⦇</span> cName <span class="main">=</span> A<span class="main">,</span> cSuper <span class="main">=</span> Object<span class="main">,</span> cFields <span class="main">=</span> <span class="main">[]</span><span class="main">,</span> cConstructor <span class="main">=</span> <span class="main">⦇</span>kName <span class="main">=</span> A<span class="main">,</span> kParams <span class="main">=</span> <span class="main">[]</span><span class="main">,</span> kSuper <span class="main">=</span> <span class="main">[]</span><span class="main">,</span> kInits <span class="main">=</span> <span class="main">[]</span><span class="main">⦈</span><span class="main">,</span> cMethods <span class="main">=</span> <span class="main">[]</span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">classB_Def</span> <span class="main">=</span> <span class="main">⦇</span> cName <span class="main">=</span> B<span class="main">,</span> cSuper <span class="main">=</span> Object<span class="main">,</span> cFields <span class="main">=</span> <span class="main">[]</span><span class="main">,</span> cConstructor <span class="main">=</span> <span class="main">⦇</span>kName <span class="main">=</span> B<span class="main">,</span> kParams <span class="main">=</span> <span class="main">[]</span><span class="main">,</span> kSuper <span class="main">=</span> <span class="main">[]</span><span class="main">,</span> kInits <span class="main">=</span> <span class="main">[]</span><span class="main">⦈</span><span class="main">,</span> cMethods <span class="main">=</span> <span class="main">[]</span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ffst</span> <span class="main">::</span> <span class="quoted">varName</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ffst</span> <span class="main">==</span> <span class="numeral">4</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fsnd</span> <span class="main">::</span> <span class="quoted">varName</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fsnd</span> <span class="main">==</span> <span class="numeral">5</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">setfst</span> <span class="main">::</span> <span class="quoted">methodName</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">setfst</span> <span class="main">==</span> <span class="numeral">6</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">newfst</span> <span class="main">::</span> <span class="quoted">varName</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">newfst</span> <span class="main">==</span> <span class="numeral">7</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">classPair_Def</span> <span class="main">::</span> <span class="quoted">classDef</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">classPair_Def</span> <span class="main">=</span> <span class="main">⦇</span> cName <span class="main">=</span> cPair<span class="main">,</span> cSuper <span class="main">=</span> Object<span class="main">,</span>
    cFields <span class="main">=</span> <span class="main">[</span><span class="main">⦇</span> vdName <span class="main">=</span> ffst<span class="main">,</span> vdType <span class="main">=</span> Object <span class="main">⦈</span><span class="main">,</span> <span class="main">⦇</span> vdName <span class="main">=</span> fsnd<span class="main">,</span> vdType <span class="main">=</span> Object <span class="main">⦈</span><span class="main">]</span><span class="main">,</span>
    cConstructor <span class="main">=</span> <span class="main">⦇</span> kName <span class="main">=</span> cPair<span class="main">,</span> kParams <span class="main">=</span> <span class="main">[</span><span class="main">⦇</span> vdName <span class="main">=</span> ffst<span class="main">,</span> vdType <span class="main">=</span> Object <span class="main">⦈</span><span class="main">,</span> <span class="main">⦇</span> vdName <span class="main">=</span> fsnd<span class="main">,</span> vdType <span class="main">=</span> Object <span class="main">⦈</span><span class="main">]</span><span class="main">,</span> kSuper <span class="main">=</span> <span class="main">[]</span><span class="main">,</span> kInits <span class="main">=</span> <span class="main">[</span>ffst<span class="main">,</span> fsnd<span class="main">]</span><span class="main">⦈</span> <span class="main">,</span>
    cMethods <span class="main">=</span> <span class="main">[</span><span class="main">⦇</span> mReturn <span class="main">=</span> cPair<span class="main">,</span> mName <span class="main">=</span> setfst<span class="main">,</span> mParams <span class="main">=</span> <span class="main">[</span><span class="main">⦇</span>vdName <span class="main">=</span> newfst<span class="main">,</span> vdType <span class="main">=</span> Object <span class="main">⦈</span><span class="main">]</span><span class="main">,</span>
      mBody <span class="main">=</span> New cPair <span class="main">[</span>Var newfst<span class="main">,</span> FieldProj <span class="main">(</span>Var this<span class="main">)</span> fsnd<span class="main">]</span>  <span class="main">⦈</span><span class="main">]</span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">exampleProg</span> <span class="main">::</span> <span class="quoted">classTable</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">exampleProg</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">%</span><span class="bound">x</span><span class="main">.</span> None<span class="main">)</span><span class="main">(</span>A <span class="main">:=</span> Some classA_Def<span class="main">)</span><span class="main">)</span><span class="main">(</span>B <span class="main">:=</span> Some classB_Def<span class="main">)</span><span class="main">)</span><span class="main">(</span>cPair <span class="main">:=</span> Some classPair_Def<span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"exampleProg <span class="main">⊢</span> classA_Def <span class="keyword1">OK</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"exampleProg <span class="main">⊢</span> classB_Def <span class="keyword1">OK</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"exampleProg <span class="main">⊢</span> classPair_Def <span class="keyword1">OK</span>"</span></span>


<span class="keyword1"><span class="command">values</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> exampleProg <span class="main">⊢</span> MethodInvk <span class="main">(</span>New cPair <span class="main">[</span>New A <span class="main">[]</span><span class="main">,</span> New B <span class="main">[]</span><span class="main">]</span><span class="main">)</span> setfst <span class="main">[</span>New B <span class="main">[]</span><span class="main">]</span> <span class="main">→*</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">values</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> exampleProg <span class="main">⊢</span> FieldProj <span class="main">(</span>FieldProj <span class="main">(</span>New cPair <span class="main">[</span>New cPair <span class="main">[</span>New A <span class="main">[]</span><span class="main">,</span> New B <span class="main">[]</span><span class="main">]</span><span class="main">,</span> New A <span class="main">[]</span><span class="main">]</span><span class="main">)</span> ffst<span class="main">)</span> fsnd <span class="main">→*</span> <span class="bound">x</span><span class="main">}</span>"</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Featherweight_Java">
<div class="head">
<h1>Theory Featherweight_Java</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Featherweight_Java
<span class="keyword2"><span class="keyword">imports</span></span> <a href="FJSound.html">FJSound</a> <a href="Execute.html">Execute</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>