<div id="Time_Monad">
<div class="head">
<h1>Theory Time_Monad</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Time Monad›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Time_Monad
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Monad_Syntax.html">HOL-Library.Monad_Syntax</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> tm <span class="main">=</span> TM <span class="main">(</span><span class="free"><span class="entity">val</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">)</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">val</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tm <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">val</span> <span class="main">(</span>TM <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">time</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tm <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">time</span> <span class="main">(</span>TM <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bind_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tm <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> tm<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bind_tm</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span> TM <span class="bound">u</span> <span class="bound">m</span> <span class="main">⇒</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">u</span> <span class="keyword1">of</span> TM <span class="bound">v</span> <span class="bound">n</span> <span class="main">⇒</span> TM <span class="bound">v</span> <span class="main">(</span><span class="bound">m</span><span class="main">+</span><span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">adhoc_overloading</span></span> Monad_Syntax.bind <span class="quoted">bind_tm</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">tick</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> TM <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">return</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> TM <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">eqtick</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tm <span class="main">⇒</span> <span class="tfree">'a</span> tm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">=1</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">eqtick</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⤜</span> tick<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(* warning: bind_tm is not a constant on purpose, does not work if it is: *)</span>
<span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="keyword1">CONST</span> eqtick <span class="free">l</span> <span class="free">r</span>"</span> <span class="main">&lt;=</span> <span class="quoted">"<span class="main">(</span><span class="free">l</span> <span class="main">=</span> <span class="main">(</span><span class="free">bind_tm</span> <span class="free">r</span> <span class="keyword1">CONST</span> tick<span class="main">)</span><span class="main">)</span>"</span>

<span class="keyword1"><span class="command">lemmas</span></span> tm_simps <span class="main">=</span> bind_tm_def return_def tick_def

<span class="keyword1"><span class="command">lemma</span></span> time_return<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>return <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> return_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> surj_TM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> val <span class="free">tm</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> time <span class="free">tm</span> <span class="main">⟹</span> <span class="free">tm</span> <span class="main">=</span> TM <span class="free">v</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> time.simps tm.exhaust val.simps<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The following lemmas push <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> val<span class="antiquote"><span class="antiquote">}</span></span></span></span> into a monadic term:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> val_return<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"val <span class="main">(</span>return <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> return_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> val_bind_tm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"val <span class="main">(</span>bind_tm <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> val <span class="free">m</span> <span class="keyword1">in</span> val<span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_tm_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tm.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> val_tick<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"val <span class="main">(</span>tick <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tick_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> val_let<span class="main">:</span> <span class="quoted"><span class="quoted">"val <span class="main">(</span><span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">t</span> <span class="keyword1">in</span> <span class="free">f</span><span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">t</span> <span class="keyword1">in</span> val<span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> let_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">t</span> <span class="keyword1">in</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> val_simps <span class="main">=</span>
  val_return
  val_bind_tm
  val_tick
  val_let
  let_id
  if_distrib<span class="main">[</span><span class="operator">of</span> <span class="quoted">val</span><span class="main">]</span>
  prod.case_distrib<span class="main">[</span><span class="operator">of</span> <span class="quoted">val</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> val_cong <span class="main">=</span> arg_cong<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted">val</span><span class="main">]</span>

<span class="keyword1"><span class="command">hide_const</span></span> TM

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Root_Balanced_Tree">
<div class="head">
<h1>Theory Root_Balanced_Tree</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Root Balanced Tree"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Root_Balanced_Tree
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Amortized_Complexity/Amortized_Framework0.html">Amortized_Complexity.Amortized_Framework0</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Tree_Multiset.html">HOL-Library.Tree_Multiset</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Data_Structures/Tree_Set.html">HOL-Data_Structures.Tree_Set</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Data_Structures/Balance.html">HOL-Data_Structures.Balance</a>"</span>
  <a href="Time_Monad.html">Time_Monad</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> Let_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Time Prelude›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Redefinition of some auxiliary functions, but now with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>tm›</span></span></span></span> monad:›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> size_tree<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">size_tree_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> nat tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">size_tree_tm</span> <span class="main">⟨⟩</span> <span class="main">=1</span> return <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">size_tree_tm</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⟩</span> <span class="main">=1</span>
  <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">m</span> <span class="main">←</span> <span class="free">size_tree_tm</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">;</span>
       <span class="bound">n</span> <span class="main">←</span> <span class="free">size_tree_tm</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span>
       return <span class="main">(</span><span class="bound">m</span><span class="main">+</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">size_tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">size_tree</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> val<span class="main">(</span>size_tree_tm <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> size_tree_Leaf<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size_tree <span class="main">⟨⟩</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> val_cong<span class="main">[</span><span class="operator">OF</span> size_tree_tm.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> size_tree_def val_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> size_tree_Node<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"size_tree <span class="main">⟨</span><span class="free">l</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="free">r</span><span class="main">⟩</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">m</span> <span class="main">=</span> size_tree <span class="free">l</span><span class="main">;</span>
       <span class="bound">n</span> <span class="main">=</span> size_tree <span class="free">r</span>
   <span class="keyword1">in</span> <span class="bound">m</span><span class="main">+</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> val_cong<span class="main">[</span><span class="operator">OF</span> size_tree_tm.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> size_tree_def val_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> size_tree<span class="main">:</span> <span class="quoted"><span class="quoted">"size_tree <span class="free">t</span> <span class="main">=</span> size <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> size_tree_tm.induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">T_size_tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_size_tree</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> time<span class="main">(</span>size_tree_tm <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> T_size_tree_Leaf<span class="main">:</span> <span class="quoted"><span class="quoted">"T_size_tree <span class="main">⟨⟩</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_size_tree_def tm_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> T_size_tree_Node<span class="main">:</span>
  <span class="quoted"><span class="quoted">"T_size_tree <span class="main">⟨</span><span class="free">l</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="free">r</span><span class="main">⟩</span> <span class="main">=</span> T_size_tree <span class="free">l</span> <span class="main">+</span> T_size_tree <span class="free">r</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_size_tree_def size_tree_def tm_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tm.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> T_size_tree<span class="main">:</span> <span class="quoted"><span class="quoted">"T_size_tree <span class="free">t</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> size <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> T_size_tree_Leaf T_size_tree_Node<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> inorder<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">inorder2_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">inorder2_tm</span> <span class="main">⟨⟩</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=1</span> return <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">inorder2_tm</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">⟩</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=1</span>
  <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">rs</span> <span class="main">←</span> <span class="free">inorder2_tm</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span> <span class="free">inorder2_tm</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="bound">rs</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inorder2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">inorder2</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> val<span class="main">(</span>inorder2_tm <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inorder2_Leaf<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inorder2 <span class="main">⟨⟩</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> val_cong<span class="main">[</span><span class="operator">OF</span> inorder2_tm.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> inorder2_def val_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inorder2_Node<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inorder2 <span class="main">⟨</span><span class="free">l</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="free">r</span><span class="main">⟩</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">rs</span> <span class="main">=</span> inorder2 <span class="free">r</span> <span class="free">xs</span> <span class="keyword1">in</span> inorder2 <span class="free">l</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="bound">rs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> val_cong<span class="main">[</span><span class="operator">OF</span> inorder2_tm.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">l</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> inorder2_def val_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inorder2<span class="main">:</span> <span class="quoted"><span class="quoted">"inorder2 <span class="free">t</span> <span class="free">xs</span> <span class="main">=</span> Tree.inorder2 <span class="free">t</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inorder2_tm.induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">T_inorder2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_inorder2</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> time<span class="main">(</span>inorder2_tm <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> T_inorder2_Leaf<span class="main">:</span> <span class="quoted"><span class="quoted">"T_inorder2 <span class="main">⟨⟩</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_inorder2_def tm_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> T_inorder2_Node<span class="main">:</span>
  <span class="quoted"><span class="quoted">"T_inorder2 <span class="main">⟨</span><span class="free">l</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="free">r</span><span class="main">⟩</span> <span class="free">xs</span> <span class="main">=</span> T_inorder2 <span class="free">r</span> <span class="free">xs</span> <span class="main">+</span> T_inorder2 <span class="free">l</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> inorder2 <span class="free">r</span> <span class="free">xs</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_inorder2_def inorder2_def tm_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tm.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> T_inorder2<span class="main">:</span> <span class="quoted"><span class="quoted">"T_inorder2 <span class="free">t</span> <span class="free">xs</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span>size <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> T_inorder2_Leaf T_inorder2_Node<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> split_min<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">split_min_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">*</span> <span class="tfree">'a</span> tree<span class="main">)</span> tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">split_min_tm</span> Leaf <span class="main">=1</span> return undefined"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">split_min_tm</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=1</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> Leaf <span class="keyword1">then</span> return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
   <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">l'</span><span class="main">)</span> <span class="main">←</span> <span class="free">split_min_tm</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">;</span> return <span class="main">(</span><span class="bound">y</span><span class="main">,</span> Node <span class="bound">l'</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">split_min</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">*</span> <span class="tfree">'a</span> tree<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">split_min</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> val <span class="main">(</span>split_min_tm <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> split_min_Node<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"split_min <span class="main">(</span>Node <span class="free">l</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free">l</span> <span class="main">=</span> Leaf <span class="keyword1">then</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>
   <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">l'</span><span class="main">)</span> <span class="main">=</span> split_min <span class="free">l</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> Node <span class="bound">l'</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> val_cong<span class="main">[</span><span class="operator">OF</span> split_min_tm.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> split_min_def val_simps<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">T_split_min</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_split_min</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> time <span class="main">(</span>split_min_tm <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> T_split_min_Node<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"T_split_min <span class="main">(</span>Node <span class="free">l</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">l</span> <span class="main">=</span> Leaf <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> T_split_min <span class="free">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> val_cong<span class="main">[</span><span class="operator">OF</span> split_min_tm.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_split_min_def tm_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tm.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> split_minD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"split_min <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">t'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> <span class="free">x</span> <span class="main">#</span> inorder <span class="free">t'</span> <span class="main">=</span> inorder <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> split_min.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_lems <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits if_splits<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Balancing›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bal_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> tree <span class="main">*</span> <span class="tfree">'a</span> list<span class="main">)</span> tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bal_tm</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=1</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">=</span><span class="main">0</span> <span class="keyword1">then</span> return <span class="main">(</span>Leaf<span class="main">,</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="keyword1">else</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">m</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span>
   <span class="keyword1">in</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">←</span> <span class="free">bal_tm</span> <span class="bound">m</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span>
           <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">←</span> <span class="free">bal_tm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">-</span><span class="bound">m</span><span class="main">)</span> <span class="main">(</span>tl <span class="bound">ys</span><span class="main">)</span><span class="main">;</span>
           return <span class="main">(</span>Node <span class="bound">l</span> <span class="main">(</span>hd <span class="bound">ys</span><span class="main">)</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> bal_tm.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> bal_tm_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bal_tm <span class="main">0</span> <span class="free">xs</span> <span class="main">=1</span> return<span class="main">(</span>Leaf<span class="main">,</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span>
   bal_tm <span class="free">n</span> <span class="free">xs</span> <span class="main">=1</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">m</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>
   <span class="keyword1">in</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">←</span> bal_tm <span class="bound">m</span> <span class="free">xs</span><span class="main">;</span>
           <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">←</span> bal_tm <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">-</span><span class="bound">m</span><span class="main">)</span> <span class="main">(</span>tl <span class="bound">ys</span><span class="main">)</span><span class="main">;</span>
           return <span class="main">(</span>Node <span class="bound">l</span> <span class="main">(</span>hd <span class="bound">ys</span><span class="main">)</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bal_tm.simps<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> tree <span class="main">*</span> <span class="tfree">'a</span> list<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bal</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> val <span class="main">(</span>bal_tm <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bal_def2<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
<span class="quoted"><span class="quoted">"bal <span class="free">n</span> <span class="free">xs</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span><span class="main">=</span><span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span>Leaf<span class="main">,</span><span class="free">xs</span><span class="main">)</span> <span class="keyword1">else</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">m</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">;</span>
       <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">=</span> bal <span class="bound">m</span> <span class="free">xs</span><span class="main">;</span>
       <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">=</span> bal <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">-</span><span class="bound">m</span><span class="main">)</span> <span class="main">(</span>tl <span class="bound">ys</span><span class="main">)</span>
   <span class="keyword1">in</span> <span class="main">(</span>Node <span class="bound">l</span> <span class="main">(</span>hd <span class="bound">ys</span><span class="main">)</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> val_cong<span class="main">[</span><span class="operator">OF</span> bal_tm.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> bal_def val_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bal_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bal <span class="main">0</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span>Leaf<span class="main">,</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span>
   bal <span class="free">n</span> <span class="free">xs</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">m</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">=</span> bal <span class="bound">m</span> <span class="free">xs</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">=</span> bal <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">-</span><span class="bound">m</span><span class="main">)</span> <span class="main">(</span>tl <span class="bound">ys</span><span class="main">)</span>
  <span class="keyword1">in</span> <span class="main">(</span>Node <span class="bound">l</span> <span class="main">(</span>hd <span class="bound">ys</span><span class="main">)</span> <span class="bound">r</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bal_def2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bal_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"bal <span class="free">n</span> <span class="free">xs</span> <span class="main">=</span> Balance.bal <span class="free">n</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bal.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">n</span><span class="main">=</span><span class="main">0</span>"</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bal_simps Balance.bal_simps<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bal_simps Balance.bal_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">T_bal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_bal</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> time <span class="main">(</span>bal_tm <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> T_bal<span class="main">:</span> <span class="quoted"><span class="quoted">"T_bal <span class="free">n</span> <span class="free">xs</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="free">n</span><span class="main">+</span><span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> T_bal_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bal_tm.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">n</span><span class="main">=</span><span class="main">0</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bal_tm_simps<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bal_tm_simps tm_simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subst_all <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tm.split<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> p <span class="keyword2"><span class="keyword">for</span></span> n xs t1 xs1
  <span class="keyword1"><span class="command">using</span></span> p<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> refl<span class="main">,</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs1</span></span><span class="main">]</span> p<span class="main">(</span>3-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bal_list_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> tree tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bal_list_tm</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">←</span> bal_tm <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span> return <span class="bound">t</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bal_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bal_list</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> val <span class="main">(</span>bal_list_tm <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bal_list_def2<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bal_list <span class="free">n</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">ys</span><span class="main">)</span> <span class="main">=</span> bal <span class="free">n</span> <span class="free">xs</span> <span class="keyword1">in</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> val_cong<span class="main">[</span><span class="operator">OF</span> bal_list_tm_def<span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> bal_list_def bal_def val_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bal_list<span class="main">:</span> <span class="quoted"><span class="quoted">"bal_list <span class="free">n</span> <span class="free">xs</span> <span class="main">=</span> Balance.bal_list <span class="free">n</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bal_list_def2 Balance.bal_list_def bal_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bal_tree_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bal_tree_tm</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=1</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">xs</span> <span class="main">←</span> inorder2_tm <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">[]</span><span class="main">;</span> bal_list_tm <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">xs</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bal_tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bal_tree</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> val <span class="main">(</span>bal_tree_tm <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bal_tree_def2<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bal_tree <span class="free">n</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">xs</span> <span class="main">=</span> inorder2 <span class="free">t</span> <span class="main">[]</span> <span class="keyword1">in</span> bal_list <span class="free">n</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> val_cong<span class="main">[</span><span class="operator">OF</span> bal_tree_tm_def<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> bal_tree_def bal_list_def inorder2_def val_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bal_tree<span class="main">:</span> <span class="quoted"><span class="quoted">"bal_tree <span class="free">n</span> <span class="free">t</span> <span class="main">=</span> Balance.bal_tree <span class="free">n</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bal_tree_def2 Balance.bal_tree_def bal_list inorder2 inorder2_inorder<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">T_bal_tree</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_bal_tree</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> time <span class="main">(</span>bal_tree_tm <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> T_bal_tree<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> size <span class="free">xs</span> <span class="main">⟹</span> T_bal_tree <span class="free">n</span> <span class="free">xs</span> <span class="main">=</span> <span class="numeral">4</span><span class="main">*</span><span class="free">n</span><span class="main">+</span><span class="numeral">3</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_bal_tree_def bal_tree_tm_def tm_simps bal_list_tm_def
    surj_TM<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inorder2_def T_inorder2_def<span class="main"><span class="main">]</span></span> T_inorder2
    surj_TM<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bal_def T_bal_def<span class="main"><span class="main">]</span></span> T_bal size1_size
    <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tm.split prod.split<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Naive implementation (insert only)"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">node</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">node</span> <span class="free"><span class="bound"><span class="entity">twist</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">twist</span></span></span> <span class="keyword1">then</span> Node <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">else</span> Node <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> up <span class="main">=</span> Same <span class="main">|</span> Bal <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree"</span></span> <span class="main">|</span> Unbal <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree"</span></span>

<span class="keyword1"><span class="command">locale</span></span> RBTi1 <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">bal_i</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> bal_i_balance<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="main">(</span>size <span class="free">t</span><span class="main">)</span> <span class="main">(</span>height <span class="main">(</span>balance_tree <span class="main">(</span><span class="free">t</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>linorder tree<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> mono_bal_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">bal_i</span> <span class="free">n</span> <span class="free">h</span><span class="main">;</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">n'</span><span class="main">;</span> <span class="free">h'</span> <span class="main">≤</span> <span class="free">h</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">bal_i</span> <span class="free">n'</span> <span class="free">h'</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Functions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">up</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'a</span> up <span class="main">⇒</span> <span class="tfree">'a</span> up"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">up</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">sib</span></span></span> <span class="free"><span class="bound"><span class="entity">twist</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">of</span> Same <span class="main">⇒</span> Same <span class="main">|</span>
   Bal <span class="bound">t</span> <span class="main">⇒</span> Bal<span class="main">(</span>node <span class="free"><span class="bound"><span class="entity">twist</span></span></span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">sib</span></span></span><span class="main">)</span> <span class="main">|</span>
   Unbal <span class="bound">t</span> <span class="main">⇒</span> <span class="keyword1">let</span> <span class="bound">t'</span> <span class="main">=</span> node <span class="free"><span class="bound"><span class="entity">twist</span></span></span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">sib</span></span></span><span class="main">;</span> <span class="bound">h'</span> <span class="main">=</span> height <span class="bound">t'</span><span class="main">;</span> <span class="bound">n'</span> <span class="main">=</span> size <span class="bound">t'</span>
              <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="free">bal_i</span> <span class="bound">n'</span> <span class="bound">h'</span> <span class="keyword1">then</span> Unbal <span class="bound">t'</span>
                 <span class="keyword1">else</span> Bal<span class="main">(</span>balance_tree <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> up_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ins</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> up"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ins</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> Leaf <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free">bal_i</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">then</span> Bal <span class="main">(</span>Node Leaf <span class="free"><span class="bound"><span class="entity">x</span></span></span> Leaf<span class="main">)</span> <span class="keyword1">else</span> Unbal <span class="main">(</span>Node Leaf <span class="free"><span class="bound"><span class="entity">x</span></span></span> Leaf<span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">ins</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> cmp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">of</span>
     LT <span class="main">⇒</span> up <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> False <span class="main">(</span><span class="free">ins</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">|</span>
     EQ <span class="main">⇒</span> Same <span class="main">|</span>
     GT <span class="main">⇒</span> up  <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> True <span class="main">(</span><span class="free">ins</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> ins <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
    Same <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">|</span>
    Bal <span class="bound">t'</span> <span class="main">⇒</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
    <span class="comment1">(* Unbal unreachable *)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Functional Correctness and Invariants›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> height_balance<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">¬</span> <span class="free">bal_i</span> <span class="main">(</span>size <span class="free">t</span><span class="main">)</span> <span class="free">h</span> <span class="main">⟧</span>
  <span class="main">⟹</span> height <span class="main">(</span>balance_tree <span class="main">(</span><span class="free">t</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>linorder tree<span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bal_i_balance leI le_refl mono_bal_i<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_bal_i'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> ASSUMPTION<span class="main">(</span><span class="free">bal_i</span> <span class="free">n</span> <span class="free">h</span><span class="main">)</span><span class="main">;</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">n'</span><span class="main">;</span> <span class="free">h'</span> <span class="main">≤</span> <span class="free">h</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">bal_i</span> <span class="free">n'</span> <span class="free">h'</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> ASSUMPTION_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> mono_bal_i<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inorder_ins<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted<span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span>ins <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Same <span class="main">⟶</span> ins_list <span class="free">x</span> <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">=</span> inorder <span class="free">t</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span>ins <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Bal <span class="free">t'</span> <span class="main">⟶</span> ins_list <span class="free">x</span> <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">=</span> inorder <span class="free">t'</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span>ins <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Unbal <span class="free">t'</span> <span class="main">⟶</span> ins_list <span class="free">x</span> <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">=</span> inorder <span class="free">t'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ins_list_simps bal.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span>"</span></span><span class="main"><span class="main">]</span></span> bal.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_splits prod.splits up.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ins_size<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Bal <span class="free">t'</span> <span class="main">⟹</span> size <span class="free">t'</span> <span class="main">=</span> size <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Unbal <span class="free">t'</span> <span class="main">⟹</span> size <span class="free">t'</span> <span class="main">=</span> size <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits up.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ins_height<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Bal <span class="free">t'</span> <span class="main">⟹</span> height <span class="free">t'</span> <span class="main">≤</span> height <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Unbal <span class="free">t'</span> <span class="main">⟹</span> height <span class="free">t</span> <span class="main">≤</span> height <span class="free">t'</span> <span class="main">∧</span> height <span class="free">t'</span> <span class="main">≤</span> height <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Leaf
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">l</span> <span class="skolem">y</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>ls<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span> <span class="main">|</span> <span class="main">(</span>eq<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="main">|</span> <span class="main">(</span>gr<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> less_linear<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">case</span></span> ls
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">l</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Same <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 ls <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> Bal
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> 1 ls <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Node<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Unbal <span class="skolem">l'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">l'</span> <span class="skolem">y</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"height <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"size <span class="var">?t</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">bal_i</span> <span class="var">?n</span> <span class="var">?h</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 ls Unbal <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> 1 ls Unbal Node.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Unbal<span class="main">]</span>
            height_balance<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="quoted"><span class="quoted">"height <span class="var">?t</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> eq
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> gr
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Same
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 gr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> Bal
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> 1 gr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Node<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Unbal <span class="skolem">r'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">l</span> <span class="skolem">y</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"height <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"size <span class="var">?t</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">bal_i</span> <span class="var">?n</span> <span class="var">?h</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 gr Unbal <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> 1 gr Unbal Node.IH<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Unbal<span class="main">]</span>
            height_balance<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="quoted"><span class="quoted">"height <span class="var">?t</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Node <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits up.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bal_i0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="main">0</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> bal_i_balance<span class="main">[</span><span class="operator">of</span> <span class="quoted">Leaf</span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Balance.bal_tree_def balance_tree_def Balance.bal_list_def Balance.bal_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bal_i1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="main">1</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> bal_i_balance<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Node Leaf undefined Leaf"</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> balance_tree_def Balance.bal_tree_def Balance.bal_list_def Balance.bal_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bal_i_ins_Unbal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Unbal <span class="free">t'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="main">(</span>size <span class="free">t'</span><span class="main">)</span> <span class="main">(</span>height <span class="free">t'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms bal_i1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Node <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits up.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> unbal_ins_Unbal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Unbal <span class="free">t'</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">bal_i</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>height <span class="free">t'</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Node <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mono_bal_i' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits up.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> height_Unbal_l<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="main">(</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="free">l</span> <span class="main">=</span> Unbal <span class="free">l'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="free">n</span> <span class="main">(</span>height <span class="main">⟨</span><span class="free">l</span><span class="main">,</span> <span class="free">y</span><span class="main">,</span> <span class="free">r</span><span class="main">⟩</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"height <span class="free">r</span> <span class="main">&lt;</span> height <span class="free">l'</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?P</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> unbal_ins_Unbal<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mono_bal_i'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">lemma</span></span> height_Unbal_r<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="main">(</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="free">r</span> <span class="main">=</span> Unbal <span class="free">r'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="free">n</span> <span class="main">(</span>height <span class="main">⟨</span><span class="free">l</span><span class="main">,</span> <span class="free">y</span><span class="main">,</span> <span class="free">r</span><span class="main">⟩</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"height <span class="free">l</span> <span class="main">&lt;</span> height <span class="free">r'</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?P</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> unbal_ins_Unbal<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mono_bal_i' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> ins_bal_i_Bal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> ins <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Bal <span class="free">t'</span><span class="main">;</span> <span class="free">bal_i</span> <span class="free">n</span> <span class="main">(</span>height <span class="free">t</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">bal_i</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>height <span class="free">t'</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Leaf
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">l</span> <span class="skolem">y</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>ls<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span> <span class="main">|</span> <span class="main">(</span>eq<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="main">|</span> <span class="main">(</span>gr<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> less_linear<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> ls
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="free">n</span> <span class="main">(</span>height <span class="skolem">l</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_bal_i'<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">l</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Same
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Node.prems ls <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Bal
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Node.prems ls ins_height<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Bal<span class="main">]</span> Node.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Bal 2<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_def mono_bal_i'<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Unbal <span class="skolem">l'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">l'</span> <span class="skolem">y</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"height <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"size <span class="var">?t</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">bal_i</span> <span class="var">?n</span> <span class="var">?h</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Node.prems ls Unbal <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Node.prems ls Unbal height_balance<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="quoted"><span class="quoted">"height <span class="var">?t</span>"</span></span><span class="main">]</span>
          ins_height<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Unbal<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mono_bal_i'<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> eq
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.prems <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gr
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="free">n</span> <span class="main">(</span>height <span class="skolem">r</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_bal_i'<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Same
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Node.prems gr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Bal
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Node.prems gr ins_height<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Bal<span class="main">]</span> Node.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Bal 2<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_def mono_bal_i'<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Unbal <span class="skolem">r'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">l</span> <span class="skolem">y</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"height <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"size <span class="var">?t</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">bal_i</span> <span class="var">?n</span> <span class="var">?h</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Node.prems gr Unbal <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Node.prems gr Unbal
          height_balance<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="quoted"><span class="quoted">"height <span class="var">?t</span>"</span></span><span class="main">]</span> ins_height<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Unbal<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mono_bal_i'<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ins0_neq_Unbal<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> size <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="main">0</span> <span class="free">a</span> <span class="free">t</span> <span class="main">≠</span> Unbal <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> bal_i1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> numeral_eq_Suc mono_bal_i'<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Node
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> unbal_ins_Unbal<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">n</span>"</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ins_size mono_bal_i' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> up.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inorder_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted<span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span>
  <span class="main">⟹</span> inorder <span class="main">(</span>insert <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> ins_list <span class="free">x</span> <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> ins0_neq_Unbal
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_def inorder_ins <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split up.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bal_i_insert<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="main">(</span>size <span class="free">t</span><span class="main">)</span> <span class="main">(</span>height <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="main">(</span>size<span class="main">(</span>insert <span class="free">x</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>height<span class="main">(</span>insert <span class="free">x</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ins <span class="main">(</span>size <span class="free">t</span><span class="main">)</span> <span class="main">0</span> <span class="free">x</span> <span class="free">t</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Same
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Bal
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ins_bal_i_Bal<span class="main">[</span><span class="operator">OF</span> Bal<span class="main">]</span> assms ins_size <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size1_size<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Unbal <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> ins0_neq_Unbal <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* RBTi1 *)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is just a test that (a simplified version of) the intended
interpretation works (so far):›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Test<span class="main">:</span> RBTi1 <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span> <span class="bound">h</span><span class="main">.</span> <span class="bound">h</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>real<span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> real<span class="main">(</span>size <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> height_balance_tree<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">n</span> <span class="skolem">h</span> <span class="skolem">n'</span> <span class="skolem">h'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="skolem">h'</span> <span class="main">≤</span> real <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> 2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span><span class="skolem">n'</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2"</span><span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Efficient Implementation (insert only)"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">imbal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">imbal</span> Leaf <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">imbal</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> nat<span class="main">(</span>abs<span class="main">(</span>int<span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">-</span> int<span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> imbal.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> imbal0_if_wbalanced<span class="main">:</span> <span class="quoted"><span class="quoted">"wbalanced <span class="free">t</span> <span class="main">⟹</span> imbal <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> imbal.simps<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The degree of imbalance allowed:
how far from the perfect balance may the tree degenerate.›</span></span>

<span class="keyword1"><span class="command">axiomatization</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">where</span></span>
c1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bal_log</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bal_log</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span>height <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≤</span> ceiling<span class="main">(</span>c <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">hchild</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">hchild</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> height <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≤</span> height <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> size1_imbal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> bal_log <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bal_log <span class="main">(</span>hchild <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Leaf"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"imbal <span class="free">t</span> <span class="main">&gt;</span> <span class="main">(</span><span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">/</span>c<span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> size1 <span class="main">(</span><span class="free">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Node <span class="skolem">l</span> <span class="skolem">x</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">≠</span> Leaf›</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> neq_Leaf_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sh</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"hchild <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"c <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="var">?sh</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_le_mult_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> size1_ge0<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?sh</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">/</span>c<span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> size1 <span class="free">t</span> <span class="main">-</span> <span class="main">1</span>
    <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">/</span>c<span class="main">)</span> <span class="main">*</span> size1 <span class="free">t</span> <span class="main">-</span> size1 <span class="free">t</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">/</span>c<span class="main">)</span> <span class="main">*</span> size1 <span class="free">t</span><span class="main">)</span> <span class="main">-</span> size1 <span class="free">t</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_minus powr_add<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">/</span>c<span class="main">)</span> <span class="main">*</span> size1 <span class="free">t</span> <span class="main">&lt;</span> size1 <span class="var">?sh</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ceiling<span class="main">(</span>c <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> ceiling <span class="main">(</span>c <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="var">?sh</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ceiling<span class="main">(</span>c <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> height <span class="free">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bal_log_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> height<span class="main">(</span><span class="var">?sh</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t max_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> bal_log_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"c <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span> <span class="main">&lt;</span> c <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="var">?sh</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">/</span>c <span class="main">&lt;</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="var">?sh</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> powr_less_mono<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_diff powr_minus <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> real<span class="main">(</span>size1 <span class="var">?sh</span><span class="main">)</span> <span class="main">-</span> size1 <span class="free">t</span> <span class="main">-</span> <span class="main">1</span>
           <span class="main">=</span> real<span class="main">(</span>size1 <span class="var">?sh</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>real<span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span> <span class="main">-</span> size1 <span class="var">?sh</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> imbal <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> imbal.simps size1_size<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The following key lemma shows that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>imbal›</span></span></span></span> is a suitable potential because
it can pay for the linear-time cost of restructuring a tree
that is not balanced but whose higher son is.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> size1_imbal2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> bal_log <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"bal_log <span class="main">(</span>hchild <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Leaf"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size1 <span class="main">(</span><span class="free">t</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span>c<span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">-</span> <span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span>c<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>imbal <span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> c<span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> log_less_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> c<span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> size1 <span class="free">t</span> <span class="main">&lt;</span> imbal <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> size1_imbal<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size1 <span class="free">t</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> c<span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>imbal <span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> c<span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span>c<span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">-</span> <span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span>c<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">1</span> <span class="main">/</span> c<span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">/</span> <span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span>c<span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_diff<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span>c<span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">-</span> <span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span>c<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> up2 <span class="main">=</span> Same2 <span class="main">|</span> Bal2 <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree"</span></span> <span class="main">|</span> Unbal2 <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree"</span></span> <span class="quoted">nat</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> rbt1 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">*</span> nat"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An implementation where size and height are computed incrementally:›</span></span>

<span class="keyword1"><span class="command">locale</span></span> RBTi2 <span class="main">=</span> RBTi1 <span class="main">+</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span> <span class="main">::</span> <span class="quoted">real</span>
<span class="keyword2"><span class="keyword">assumes</span></span> e0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> imbal_size<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">¬</span> <span class="free">bal_i</span> <span class="main">(</span>size <span class="free">t</span><span class="main">)</span> <span class="main">(</span>height <span class="free">t</span><span class="main">)</span><span class="main">;</span>
     <span class="free">bal_i</span> <span class="main">(</span>size<span class="main">(</span>hchild <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>height<span class="main">(</span>hchild <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
     <span class="free">t</span> <span class="main">≠</span> Leaf <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">e</span> <span class="main">*</span> <span class="main">(</span>imbal <span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">≥</span> size1 <span class="main">(</span><span class="free">t</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>linorder tree<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Functions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">up2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'a</span> up2 <span class="main">⇒</span> <span class="tfree">'a</span> up2"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">up2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">sib</span></span></span> <span class="free"><span class="bound"><span class="entity">twist</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">of</span> Same2 <span class="main">⇒</span> Same2 <span class="main">|</span>
   Bal2 <span class="bound">t</span> <span class="main">⇒</span> Bal2<span class="main">(</span>node <span class="free"><span class="bound"><span class="entity">twist</span></span></span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">sib</span></span></span><span class="main">)</span> <span class="main">|</span>
   Unbal2 <span class="bound">t</span> <span class="bound">n1</span> <span class="bound">h1</span> <span class="main">⇒</span>
     <span class="keyword1">let</span> <span class="bound">n2</span> <span class="main">=</span> size <span class="free"><span class="bound"><span class="entity">sib</span></span></span><span class="main">;</span> <span class="bound">h2</span> <span class="main">=</span> height <span class="free"><span class="bound"><span class="entity">sib</span></span></span><span class="main">;</span>
         <span class="bound">t'</span> <span class="main">=</span> node <span class="free"><span class="bound"><span class="entity">twist</span></span></span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">sib</span></span></span><span class="main">;</span>
         <span class="bound">n'</span> <span class="main">=</span> <span class="bound">n1</span><span class="main">+</span><span class="bound">n2</span><span class="main">+</span><span class="main">1</span><span class="main">;</span> <span class="bound">h'</span> <span class="main">=</span> max <span class="bound">h1</span> <span class="bound">h2</span> <span class="main">+</span> <span class="main">1</span>
     <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="free">bal_i</span> <span class="bound">n'</span> <span class="bound">h'</span> <span class="keyword1">then</span> Unbal2 <span class="bound">t'</span> <span class="bound">n'</span> <span class="bound">h'</span>
        <span class="keyword1">else</span> Bal2<span class="main">(</span>bal_tree <span class="bound">n'</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> up2_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> up2<span class="antiquote"><span class="antiquote">}</span></span></span></span> traverses <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>sib›</span></span></span></span> twice; unnecessarily, as it turns out: ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">up3_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'a</span> up2 <span class="main">⇒</span> <span class="tfree">'a</span> up2 tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">up3_tm</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">sib</span></span></span> <span class="free"><span class="bound"><span class="entity">twist</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=1</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">of</span>
   Same2 <span class="main">⇒</span> return Same2 <span class="main">|</span>
   Bal2 <span class="bound">t</span> <span class="main">⇒</span> return <span class="main">(</span>Bal2<span class="main">(</span>node <span class="free"><span class="bound"><span class="entity">twist</span></span></span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">sib</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">|</span>
   Unbal2 <span class="bound">t</span> <span class="bound">n1</span> <span class="bound">h1</span> <span class="main">⇒</span>
     <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">n2</span> <span class="main">←</span> size_tree_tm <span class="free"><span class="bound"><span class="entity">sib</span></span></span><span class="main">;</span>
          <span class="keyword1">let</span> <span class="bound">t'</span> <span class="main">=</span> node <span class="free"><span class="bound"><span class="entity">twist</span></span></span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">sib</span></span></span><span class="main">;</span>
              <span class="bound">n'</span> <span class="main">=</span> <span class="bound">n1</span><span class="main">+</span><span class="bound">n2</span><span class="main">+</span><span class="main">1</span><span class="main">;</span>
              <span class="bound">h'</span> <span class="main">=</span> <span class="bound">h1</span> <span class="main">+</span> <span class="main">1</span>
          <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="free">bal_i</span> <span class="bound">n'</span> <span class="bound">h'</span> <span class="keyword1">then</span> return <span class="main">(</span>Unbal2 <span class="bound">t'</span> <span class="bound">n'</span> <span class="bound">h'</span><span class="main">)</span>
             <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">t''</span> <span class="main">←</span> bal_tree_tm <span class="bound">n'</span> <span class="bound">t'</span><span class="main">;</span>
                       return <span class="main">(</span>Bal2 <span class="bound">t''</span><span class="main">)</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">up3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'a</span> up2 <span class="main">⇒</span> <span class="tfree">'a</span> up2"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">up3</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">sib</span></span></span> <span class="free"><span class="bound"><span class="entity">twist</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> val <span class="main">(</span>up3_tm <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">sib</span></span></span> <span class="free"><span class="bound"><span class="entity">twist</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> up3_def2<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"up3 <span class="free">x</span> <span class="free">sib</span> <span class="free">twist</span> <span class="free">u</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">u</span> <span class="keyword1">of</span>
  Same2 <span class="main">⇒</span> Same2 <span class="main">|</span>
  Bal2 <span class="bound">t</span> <span class="main">⇒</span> Bal2 <span class="main">(</span>node <span class="free">twist</span> <span class="bound">t</span> <span class="free">x</span> <span class="free">sib</span><span class="main">)</span> <span class="main">|</span>
  Unbal2 <span class="bound">t</span> <span class="bound">n1</span> <span class="bound">h1</span> <span class="main">⇒</span>
     <span class="keyword1">let</span> <span class="bound">n2</span> <span class="main">=</span> size_tree <span class="free">sib</span><span class="main">;</span> <span class="bound">t'</span> <span class="main">=</span> node <span class="free">twist</span> <span class="bound">t</span> <span class="free">x</span> <span class="free">sib</span><span class="main">;</span> <span class="bound">n'</span> <span class="main">=</span> <span class="bound">n1</span> <span class="main">+</span> <span class="bound">n2</span> <span class="main">+</span> <span class="main">1</span><span class="main">;</span> <span class="bound">h'</span> <span class="main">=</span> <span class="bound">h1</span> <span class="main">+</span> <span class="main">1</span>
     <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="free">bal_i</span> <span class="bound">n'</span> <span class="bound">h'</span> <span class="keyword1">then</span> Unbal2 <span class="bound">t'</span> <span class="bound">n'</span> <span class="bound">h'</span>
        <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="bound">t''</span> <span class="main">=</span> bal_tree <span class="bound">n'</span> <span class="bound">t'</span> <span class="keyword1">in</span> Bal2 <span class="bound">t''</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> val_cong<span class="main">[</span><span class="operator">OF</span> up3_tm_def<span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> up3_def size_tree_def bal_tree_def val_simps up2.case_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">val</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">T_up3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'a</span> up2 <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_up3</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">sib</span></span></span> <span class="free"><span class="bound"><span class="entity">twist</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> time <span class="main">(</span>up3_tm <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">sib</span></span></span> <span class="free"><span class="bound"><span class="entity">twist</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> T_up3_def2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"T_up3 <span class="free">x</span> <span class="free">sib</span> <span class="free">twist</span> <span class="free">u</span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">case</span> <span class="free">u</span> <span class="keyword1">of</span> Same2 <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span>
   Bal2 <span class="bound">t</span> <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span>
   Unbal2 <span class="bound">t</span> <span class="bound">n1</span> <span class="bound">h1</span> <span class="main">⇒</span>
     <span class="keyword1">let</span> <span class="bound">n2</span> <span class="main">=</span> size <span class="free">sib</span><span class="main">;</span> <span class="bound">t'</span> <span class="main">=</span> node <span class="free">twist</span> <span class="bound">t</span> <span class="free">x</span> <span class="free">sib</span><span class="main">;</span> <span class="bound">h'</span> <span class="main">=</span> <span class="bound">h1</span> <span class="main">+</span> <span class="main">1</span><span class="main">;</span> <span class="bound">n'</span> <span class="main">=</span> <span class="bound">n1</span><span class="main">+</span><span class="bound">n2</span><span class="main">+</span><span class="main">1</span>
     <span class="keyword1">in</span> <span class="numeral">2</span> <span class="main">*</span> size <span class="free">sib</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">bal_i</span> <span class="bound">n'</span> <span class="bound">h'</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> T_bal_tree <span class="bound">n'</span> <span class="bound">t'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_up3_def up3_tm_def surj_TM<span class="main"><span class="main">[</span></span><span class="operator">OF</span> size_tree_def T_size_tree_def<span class="main"><span class="main">]</span></span>
    size_tree T_size_tree T_bal_tree_def tm_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tm.split up2.split<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ins2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> up2"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ins2</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> Leaf <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free">bal_i</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">then</span> Bal2 <span class="main">(</span>Node Leaf <span class="free"><span class="bound"><span class="entity">x</span></span></span> Leaf<span class="main">)</span> <span class="keyword1">else</span> Unbal2 <span class="main">(</span>Node Leaf <span class="free"><span class="bound"><span class="entity">x</span></span></span> Leaf<span class="main">)</span> <span class="main">1</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">ins2</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> cmp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">of</span>
     LT <span class="main">⇒</span> up2 <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> False <span class="main">(</span><span class="free">ins2</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">|</span>
     EQ <span class="main">⇒</span> Same2 <span class="main">|</span>
     GT <span class="main">⇒</span> up2 <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> True <span class="main">(</span><span class="free">ins2</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Definition of timed final insertion function:›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ins3_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> up2 tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ins3_tm</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> Leaf <span class="main">=1</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="free">bal_i</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">then</span> return<span class="main">(</span>Bal2 <span class="main">(</span>Node Leaf <span class="free"><span class="bound"><span class="entity">x</span></span></span> Leaf<span class="main">)</span><span class="main">)</span>
   <span class="keyword1">else</span> return<span class="main">(</span>Unbal2 <span class="main">(</span>Node Leaf <span class="free"><span class="bound"><span class="entity">x</span></span></span> Leaf<span class="main">)</span> <span class="main">1</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">ins3_tm</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=1</span>
  <span class="main">(</span><span class="keyword1">case</span> cmp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">of</span>
     LT <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">l'</span> <span class="main">←</span> <span class="free">ins3_tm</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">;</span> up3_tm <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> False <span class="bound">l'</span><span class="main">}</span> <span class="main">|</span>
     EQ <span class="main">⇒</span> return Same2 <span class="main">|</span>
     GT <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span><span class="bound">r'</span> <span class="main">←</span> <span class="free">ins3_tm</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span> up3_tm <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> True <span class="bound">r'</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ins3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> up2"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ins3</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> val<span class="main">(</span>ins3_tm <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ins3_Leaf<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ins3 <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> Leaf <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free">bal_i</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">then</span> Bal2 <span class="main">(</span>Node Leaf <span class="free">x</span> Leaf<span class="main">)</span> <span class="keyword1">else</span> Unbal2 <span class="main">(</span>Node Leaf <span class="free">x</span> Leaf<span class="main">)</span> <span class="main">1</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> val_cong<span class="main">[</span><span class="operator">OF</span> ins3_tm.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ins3_def val_simps cmp_val.case_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">val</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ins3_Node<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ins3 <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="main">(</span>Node <span class="free">l</span> <span class="free">y</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> cmp <span class="free">x</span> <span class="free">y</span> <span class="keyword1">of</span>
     LT <span class="main">⇒</span> <span class="keyword1">let</span> <span class="bound">l'</span> <span class="main">=</span> ins3 <span class="free">n</span> <span class="main">(</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="free">l</span> <span class="keyword1">in</span> up3 <span class="free">y</span> <span class="free">r</span> False <span class="bound">l'</span> <span class="main">|</span>
     EQ <span class="main">⇒</span> Same2 <span class="main">|</span>
     GT <span class="main">⇒</span> <span class="keyword1">let</span> <span class="bound">r'</span> <span class="main">=</span> ins3 <span class="free">n</span> <span class="main">(</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="free">r</span> <span class="keyword1">in</span> up3 <span class="free">y</span> <span class="free">l</span> True <span class="bound">r'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> val_cong<span class="main">[</span><span class="operator">OF</span> ins3_tm.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ins3_def up3_def val_simps cmp_val.case_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">val</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">T_ins3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_ins3</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> time<span class="main">(</span>ins3_tm <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> T_ins3_Leaf<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"T_ins3 <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> Leaf <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tm_simps T_ins3_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> T_ins3_Node<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"T_ins3 <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="main">(</span>Node <span class="free">l</span> <span class="free">y</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> cmp <span class="free">x</span> <span class="free">y</span> <span class="keyword1">of</span>
     LT <span class="main">⇒</span> T_ins3 <span class="free">n</span> <span class="main">(</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="free">l</span> <span class="main">+</span> T_up3 <span class="free">y</span> <span class="free">r</span> False <span class="main">(</span>ins3 <span class="free">n</span> <span class="main">(</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="free">l</span><span class="main">)</span> <span class="main">|</span>
     EQ <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span>
     GT <span class="main">⇒</span> T_ins3 <span class="free">n</span> <span class="main">(</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="free">r</span> <span class="main">+</span> T_up3 <span class="free">y</span> <span class="free">l</span> True <span class="main">(</span>ins3 <span class="free">n</span> <span class="main">(</span><span class="free">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> T_ins3_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> ins3_tm.simps<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tm_simps surj_TM<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ins3_def T_ins3_def<span class="main"><span class="main">]</span></span> surj_TM<span class="main"><span class="main">[</span></span><span class="operator">OF</span> up3_def T_up3_def<span class="main"><span class="main">]</span></span>
           <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> T_up3_def2 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tm.splits up2.split<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="comment1">(*FIXME simp del: T_up3_def2 T_ins3_Node[simp] *)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insert2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> rbt1 <span class="main">⇒</span> <span class="tfree">'a</span> rbt1"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">insert2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> ins2 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
     Same2 <span class="main">⇒</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">|</span>
     Bal2 <span class="bound">t'</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">t'</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="comment1">(* Unbal unreachable *)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insert3_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> rbt1 <span class="main">⇒</span> <span class="tfree">'a</span> rbt1 tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">insert3_tm</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=1</span>
  <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span> <span class="bound">u</span> <span class="main">←</span> ins3_tm <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span>
        <span class="keyword1">case</span> <span class="bound">u</span> <span class="keyword1">of</span>
          Same2 <span class="main">⇒</span> return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">|</span>
          Bal2 <span class="bound">t'</span> <span class="main">⇒</span> return <span class="main">(</span><span class="bound">t'</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">|</span>
          Unbal2 <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> return undefined <span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="comment1">(* Unbal unreachable *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">insert3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> rbt1 <span class="main">⇒</span> <span class="tfree">'a</span> rbt1"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">insert3</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> val <span class="main">(</span>insert3_tm <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert3_def2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"insert3 <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">t'</span> <span class="main">=</span> ins3 <span class="free">n</span> <span class="main">0</span> <span class="free">x</span> <span class="free">t</span> <span class="keyword1">in</span>
   <span class="keyword1">case</span> <span class="bound">t'</span> <span class="keyword1">of</span>
     Same2 <span class="main">⇒</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">|</span>
     Bal2 <span class="bound">t'</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">t'</span><span class="main">,</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> val_cong<span class="main">[</span><span class="operator">OF</span> insert3_tm.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> insert3_def ins3_def val_simps up2.case_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">val</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">T_insert3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> rbt1 <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_insert3</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> time <span class="main">(</span>insert3_tm <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> T_insert3_def2<span class="main">:</span> <span class="quoted"><span class="quoted">"T_insert3 <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> T_ins3 <span class="free">n</span> <span class="main">0</span> <span class="free">x</span> <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_insert3_def ins3_def T_ins3_def tm_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tm.split up2.split<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Equivalence Proofs"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ins_ins2<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ins2 <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Same2 <span class="main">⟹</span> ins <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Same"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ins2 <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Bal2 <span class="free">t'</span> <span class="main">⟹</span> ins <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Bal <span class="free">t'</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ins2 <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Unbal2 <span class="free">t'</span> <span class="free">n'</span> <span class="free">h'</span>
  <span class="main">⟹</span> ins <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Unbal <span class="free">t'</span> <span class="main">∧</span> <span class="free">n'</span> <span class="main">=</span> size <span class="free">t'</span> <span class="main">∧</span> <span class="free">h'</span> <span class="main">=</span> height <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quoted"><span class="free">n'</span></span> <span class="quoted"><span class="free">h'</span></span><span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> size_height add.commute max.commute balance_tree_def bal_tree
    <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits up2.splits prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ins2_ins<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Same <span class="main">⟹</span> ins2 <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Same2"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Bal <span class="free">t'</span> <span class="main">⟹</span> ins2 <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Bal2 <span class="free">t'</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Unbal <span class="free">t'</span>
  <span class="main">⟹</span> ins2 <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Unbal2 <span class="free">t'</span> <span class="main">(</span>size <span class="free">t'</span><span class="main">)</span> <span class="main">(</span>height <span class="free">t'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> size_height add.commute max.commute balance_tree_def bal_tree
    <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits up.splits prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> ins2_iff_ins<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ins2 <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Same2 <span class="main">⟷</span> ins <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Same"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ins2 <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Bal2 <span class="free">t'</span> <span class="main">⟷</span> ins <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Bal <span class="free">t'</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ins2 <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Unbal2 <span class="free">t'</span> <span class="free">n'</span> <span class="free">h'</span> <span class="main">⟷</span>
  ins <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Unbal <span class="free">t'</span> <span class="main">∧</span> <span class="free">n'</span> <span class="main">=</span> size <span class="free">t'</span> <span class="main">∧</span> <span class="free">h'</span> <span class="main">=</span> height <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ins2_ins<span class="main">(</span>1<span class="main">)</span> ins_ins2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
 <span class="keyword1"><span class="command">using</span></span> ins2_ins<span class="main">(</span>2<span class="main">)</span> ins_ins2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">using</span></span> ins2_ins<span class="main">(</span>3<span class="main">)</span> ins_ins2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> ins3_ins2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="free">n</span> <span class="main">(</span>height <span class="free">t</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span> <span class="main">⟹</span> ins3 <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> ins2 <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">d</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Leaf
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">l</span> <span class="skolem">y</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>ls<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span> <span class="main">|</span> <span class="main">(</span>eq<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="main">|</span> <span class="main">(</span>gr<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> less_linear<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> ls
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="free">n</span> <span class="main">(</span>height <span class="skolem">l</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_bal_i'<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> Node.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ins2 <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">l</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Same2
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> IH ls <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Bal2
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> IH ls <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Unbal2 <span class="skolem">l'</span> <span class="skolem">nl'</span> <span class="skolem">hl'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">l'</span> <span class="skolem">y</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"height <span class="var">?t'</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"size <span class="var">?t'</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> ins<span class="main">:</span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">l</span> <span class="main">=</span> Unbal <span class="skolem">l'</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nl'</span> <span class="main">=</span> size <span class="skolem">l'</span> <span class="main">∧</span> <span class="skolem">hl'</span> <span class="main">=</span> height <span class="skolem">l'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ins2_iff_ins<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">,</span> <span class="operator">OF</span> Unbal2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> ls IH Unbal2 height_Unbal_l<span class="main">[</span><span class="operator">OF</span> ins Node.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_height mono_bal_i size_tree<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> eq
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.prems <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gr
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="free">n</span> <span class="main">(</span>height <span class="skolem">r</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_bal_i'<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> Node.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ins2 <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Same2
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> IH gr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Bal2
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> IH gr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Unbal2 <span class="skolem">r'</span> <span class="skolem">nr'</span> <span class="skolem">hr'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">r'</span> <span class="skolem">y</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"height <span class="var">?t'</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"size <span class="var">?t'</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> ins<span class="main">:</span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">r</span> <span class="main">=</span> Unbal <span class="skolem">r'</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nr'</span> <span class="main">=</span> size <span class="skolem">r'</span> <span class="main">∧</span> <span class="skolem">hr'</span> <span class="main">=</span> height <span class="skolem">r'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ins2_iff_ins<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">,</span> <span class="operator">OF</span> Unbal2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> gr IH Unbal2 height_Unbal_r<span class="main">[</span><span class="operator">OF</span> ins Node.prems<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_height mono_bal_i size_tree<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert2_insert<span class="main">:</span>
  <span class="quoted"><span class="quoted">"insert2 <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span>size <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">t'</span><span class="main">,</span><span class="free">n'</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">t'</span> <span class="main">=</span> insert <span class="free">x</span> <span class="free">t</span> <span class="main">∧</span> <span class="free">n'</span> <span class="main">=</span> size <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> ins0_neq_Unbal
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ins2_iff_ins ins_size <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> up2.split up.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert3_insert2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="free">n</span> <span class="main">(</span>height <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> insert3 <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> insert2 <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins3_ins2 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> up2.split<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Amortized Complexity›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Φ</span> Leaf <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">Φ</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="numeral">6</span> <span class="main">*</span> <span class="free">e</span> <span class="main">*</span> imbal <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="free">Φ</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> <span class="free">Φ</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Φ_nn<span class="main">:</span> <span class="quoted"><span class="quoted">"Φ <span class="free">t</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> e0 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Φ_sum_mset<span class="main">:</span> <span class="quoted"><span class="quoted">"Φ <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">s</span> <span class="main">∈#</span> subtrees_mset <span class="free">t</span><span class="main">.</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span>imbal <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> imbal.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Node <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Φ_wbalanced<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wbalanced <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Φ <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ <span class="free">t</span> <span class="main">=</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈#</span>subtrees_mset <span class="free">t</span><span class="main">.</span> real <span class="main">(</span>imbal <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Φ_sum_mset sum_mset_distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">)</span> <span class="main">*</span> real<span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">∈#</span>subtrees_mset <span class="free">t</span><span class="main">.</span> imbal <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> e0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> multiset.map_comp o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> e0 assms
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> imbal0_if_wbalanced wbalanced_subtrees <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> of_nat_sum_mset<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> imbal_ins_Bal<span class="main">:</span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Bal <span class="free">t'</span> <span class="main">⟹</span>
 real<span class="main">(</span>imbal <span class="main">(</span>node <span class="free">tw</span> <span class="free">t'</span> <span class="free">y</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> imbal <span class="main">(</span>node <span class="free">tw</span> <span class="free">t</span> <span class="free">y</span> <span class="free">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> ins_size<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size1_size imbal.simps<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> imbal_ins_Unbal<span class="main">:</span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Unbal <span class="free">t'</span> <span class="main">⟹</span>
 real<span class="main">(</span>imbal <span class="main">(</span>node <span class="free">tw</span> <span class="free">t'</span> <span class="free">y</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> imbal <span class="main">(</span>node <span class="free">tw</span> <span class="free">t</span> <span class="free">y</span> <span class="free">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> ins_size<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size1_size imbal.simps<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> T_ins3_Same<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ins3 <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Same2 <span class="main">⟹</span> T_ins3 <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> height <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">d</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> up2.splits if_splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> T_ins3_Unbal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> ins3 <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Unbal2 <span class="free">t'</span> <span class="free">n'</span> <span class="free">h'</span><span class="main">;</span>  <span class="free">bal_i</span> <span class="free">n</span> <span class="main">(</span>height <span class="free">t</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
  T_ins3 <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> size <span class="free">t</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> height <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quoted"><span class="free">n'</span></span> <span class="quoted"><span class="free">h'</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ins3_ins2 ins2_iff_ins ins_height size_tree size1_size max_def mono_bal_i'
         <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> unbal_ins_Unbal <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> up2.splits if_splits<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mono_bal_i'<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> Phi_diff_Unbal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> ins3 <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Unbal2 <span class="free">t'</span> <span class="free">n'</span> <span class="free">h'</span><span class="main">;</span>  <span class="free">bal_i</span> <span class="free">n</span> <span class="main">(</span>height <span class="free">t</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
  Φ <span class="free">t'</span> <span class="main">-</span> Φ <span class="free">t</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> height <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quoted"><span class="free">n'</span></span> <span class="quoted"><span class="free">h'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> imbal.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">l</span> <span class="skolem">y</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ins<span class="main">:</span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="skolem">d</span> <span class="free">x</span> <span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">y</span><span class="main">,</span> <span class="skolem">r</span><span class="main">⟩</span> <span class="main">=</span> Unbal <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Node.prems<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ins2_iff_ins<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> ins3_ins2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Node.prems<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>ls<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span> <span class="main">|</span> <span class="main">(</span>eq<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="main">|</span> <span class="main">(</span>gr<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> less_linear<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> ls
    <span class="keyword1"><span class="command">with</span></span> Node.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="skolem"><span class="skolem">nl'</span></span> <span class="skolem"><span class="skolem">nh'</span></span> <span class="keyword2"><span class="keyword">where</span></span> rec<span class="main">:</span> <span class="quoted"><span class="quoted">"ins3 <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">l</span> <span class="main">=</span> Unbal2 <span class="skolem">l'</span> <span class="skolem">nl'</span> <span class="skolem">nh'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Node <span class="skolem">l'</span> <span class="skolem">y</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> up2.splits if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> bal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="free">n</span> <span class="main">(</span>height <span class="skolem">l</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_bal_i' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> rec'<span class="main">:</span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">l</span> <span class="main">=</span> Unbal <span class="skolem">l'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rec ins_ins2<span class="main">(</span>3<span class="main">)</span> ins3_ins2<span class="main">[</span><span class="operator">OF</span> bal<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ <span class="skolem">t'</span> <span class="main">-</span> Φ <span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">r</span><span class="main">⟩</span> <span class="main">=</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span>imbal<span class="main">⟨</span><span class="skolem">l'</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">r</span><span class="main">⟩</span> <span class="main">-</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span>imbal<span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">r</span><span class="main">⟩</span> <span class="main">+</span> Φ <span class="skolem">l'</span> <span class="main">-</span> Φ <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> <span class="main">(</span>real<span class="main">(</span>imbal<span class="main">⟨</span><span class="skolem">l'</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">r</span><span class="main">⟩</span><span class="main">)</span> <span class="main">-</span> imbal<span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">r</span><span class="main">⟩</span><span class="main">)</span> <span class="main">+</span> Φ <span class="skolem">l'</span> <span class="main">-</span> Φ <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> Φ <span class="skolem">l'</span> <span class="main">-</span> Φ <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> imbal_ins_Unbal<span class="main">[</span><span class="operator">OF</span> rec'<span class="main">,</span> <span class="operator">of</span> <span class="quoted">False</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> e0 t' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> <span class="main">(</span>height <span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> rec bal<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> height <span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">y</span><span class="main">,</span> <span class="skolem">r</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> e0 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> times_divide_eq_left<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> eq
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Node.prems <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gr
    <span class="keyword1"><span class="command">with</span></span> Node.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="skolem"><span class="skolem">rn'</span></span> <span class="skolem"><span class="skolem">rh'</span></span> <span class="keyword2"><span class="keyword">where</span></span> rec<span class="main">:</span> <span class="quoted"><span class="quoted">"ins3 <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">r</span> <span class="main">=</span> Unbal2 <span class="skolem">r'</span> <span class="skolem">rn'</span> <span class="skolem">rh'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Node <span class="skolem">l</span> <span class="skolem">y</span> <span class="skolem">r'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> up2.splits if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> bal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="free">n</span> <span class="main">(</span>height <span class="skolem">r</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_bal_i' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> rec'<span class="main">:</span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">r</span> <span class="main">=</span> Unbal <span class="skolem">r'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rec ins_ins2<span class="main">(</span>3<span class="main">)</span> ins3_ins2<span class="main">[</span><span class="operator">OF</span> bal<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Φ <span class="skolem">t'</span> <span class="main">-</span> Φ <span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">r</span><span class="main">⟩</span> <span class="main">=</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span>imbal<span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">r'</span><span class="main">⟩</span> <span class="main">-</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span>imbal<span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">r</span><span class="main">⟩</span> <span class="main">+</span> Φ <span class="skolem">r'</span> <span class="main">-</span> Φ <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> <span class="main">(</span>real<span class="main">(</span>imbal<span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">r'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">-</span> imbal<span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">r</span><span class="main">⟩</span><span class="main">)</span> <span class="main">+</span> Φ <span class="skolem">r'</span> <span class="main">-</span> Φ <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> Φ <span class="skolem">r'</span> <span class="main">-</span> Φ <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> imbal_ins_Unbal<span class="main">[</span><span class="operator">OF</span> rec'<span class="main">,</span> <span class="operator">of</span> <span class="quoted">True</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> e0 t'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> <span class="main">(</span>height <span class="skolem">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> rec bal<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> height <span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">y</span><span class="main">,</span> <span class="skolem">r</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> e0 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> times_divide_eq_left<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> amor_Unbal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> ins3 <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Unbal2 <span class="free">t'</span> <span class="free">n'</span> <span class="free">h'</span><span class="main">;</span>  <span class="free">bal_i</span> <span class="free">n</span> <span class="main">(</span>height <span class="free">t</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> 
  T_ins3 <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">+</span> Φ <span class="free">t'</span> <span class="main">-</span> Φ <span class="free">t</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">*</span>size1 <span class="free">t</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> height <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> T_ins3_Unbal<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Phi_diff_Unbal<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs size1_size<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> T_ins3_Bal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> ins3 <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Bal2 <span class="free">t'</span><span class="main">;</span> <span class="free">bal_i</span> <span class="free">n</span> <span class="main">(</span>height <span class="free">t</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> T_ins3 <span class="free">n</span> <span class="free">d</span> <span class="free">x</span> <span class="free">t</span> <span class="main">+</span> Φ <span class="free">t'</span> <span class="main">-</span> Φ <span class="free">t</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>height <span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Leaf
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> e0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> imbal.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">l</span> <span class="skolem">y</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> Bal<span class="main">:</span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="skolem">d</span> <span class="free">x</span> <span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">y</span><span class="main">,</span> <span class="skolem">r</span><span class="main">⟩</span> <span class="main">=</span> Bal <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Node.prems ins3_ins2 ins_ins2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>ls<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span> <span class="main">|</span> <span class="main">(</span>eq<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="main">|</span> <span class="main">(</span>gr<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> less_linear<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> ls
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="free">n</span> <span class="main">(</span>height <span class="skolem">l</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_bal_i'<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ins3 <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">l</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Same2
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Node ls <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bal2 <span class="skolem">l'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> Bal<span class="main">:</span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">l</span> <span class="main">=</span> Bal <span class="skolem">l'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span> Bal2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ins3_ins2 ins2_iff_ins<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">l</span> <span class="skolem">y</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">l'</span> <span class="skolem">y</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> Bal2 <span class="keyword1"><span class="command">have</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="var">?t'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Node.prems ls <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"T_ins3 <span class="free">n</span> <span class="skolem">d</span> <span class="free">x</span> <span class="var">?t</span> <span class="main">+</span> Φ <span class="skolem">t'</span> <span class="main">-</span> Φ <span class="var">?t</span> <span class="main">=</span> T_ins3 <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">+</span> Φ <span class="skolem">t'</span> <span class="main">-</span> Φ <span class="var">?t</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> ls Bal2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span>
        <span class="main">=</span> T_ins3 <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span>imbal <span class="var">?t'</span> <span class="main">+</span> Φ <span class="skolem">l'</span> <span class="main">-</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span>imbal <span class="var">?t</span> <span class="main">-</span> Φ <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> t' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span>
        <span class="main">≤</span> T_ins3 <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">l</span> <span class="main">+</span> Φ <span class="skolem">l'</span> <span class="main">-</span> Φ <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span>imbal <span class="var">?t'</span> <span class="main">-</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span>imbal <span class="var">?t</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> height <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span>imbal <span class="var">?t'</span> <span class="main">-</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span>imbal <span class="var">?t</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="numeral">4</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Node.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Bal2 *<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> height <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span><span class="main">(</span>real<span class="main">(</span>imbal <span class="var">?t'</span><span class="main">)</span> <span class="main">-</span> imbal <span class="var">?t</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="numeral">4</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> height <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="numeral">4</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> imbal_ins_Bal<span class="main">[</span><span class="operator">OF</span> Bal<span class="main">,</span> <span class="operator">of</span> <span class="quoted">False</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> e0
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> times_divide_eq_left<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>height <span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>max <span class="main">(</span>height <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span>height <span class="skolem">r</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> e0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_left_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>height <span class="var">?t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> e0 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Unbal2 <span class="skolem">l'</span> <span class="skolem">nl'</span> <span class="skolem">hl'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> Unbal<span class="main">:</span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">l</span> <span class="main">=</span> Unbal <span class="skolem">l'</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nl'</span> <span class="main">=</span> size <span class="skolem">l'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hl'</span> <span class="main">=</span> height <span class="skolem">l'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span>  Unbal2 ins3_ins2<span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins2_iff_ins<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> bal_l'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="main">(</span>size <span class="skolem">l'</span><span class="main">)</span> <span class="main">(</span>height <span class="skolem">l'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fact</span> bal_i_ins_Unbal<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Unbal<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">l</span> <span class="skolem">y</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"height <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"size <span class="var">?t</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">l'</span> <span class="skolem">y</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"height <span class="var">?t'</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"size <span class="var">?t'</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> bal_t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">bal_i</span> <span class="var">?n'</span> <span class="var">?h'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ls Unbal Bal <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> balance_tree <span class="var">?t'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ls Unbal Bal <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> hl'<span class="main">:</span> <span class="quoted"><span class="quoted">"height <span class="skolem">r</span> <span class="main">&lt;</span> height <span class="skolem">l'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fact</span> height_Unbal_l<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Unbal Node.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"T_ins3 <span class="free">n</span> <span class="skolem">d</span> <span class="free">x</span> <span class="var">?t</span> <span class="main">+</span> Φ <span class="skolem">t'</span> <span class="main">-</span> Φ <span class="var">?t</span> <span class="main">=</span> T_ins3 <span class="free">n</span> <span class="skolem">d</span> <span class="free">x</span> <span class="var">?t</span> <span class="main">-</span> Φ <span class="var">?t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t' Φ_wbalanced wbalanced_balance_tree<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  T_ins3 <span class="free">n</span> <span class="skolem">d</span> <span class="free">x</span> <span class="var">?t</span> <span class="main">-</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> imbal <span class="var">?t</span> <span class="main">-</span> Φ <span class="skolem">l</span> <span class="main">-</span> Φ <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> T_ins3 <span class="free">n</span> <span class="skolem">d</span> <span class="free">x</span> <span class="var">?t</span> <span class="main">-</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> imbal <span class="var">?t</span> <span class="main">-</span> Φ <span class="skolem">l</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Φ_nn<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> T_ins3 <span class="free">n</span> <span class="skolem">d</span> <span class="free">x</span> <span class="var">?t</span> <span class="main">-</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> imbal <span class="var">?t'</span> <span class="main">-</span> Φ <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> mult_left_mono<span class="main">[</span><span class="operator">OF</span> imbal_ins_Unbal<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Unbal<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted">False</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span><span class="main">*</span><span class="free">e</span>"</span></span><span class="main">]</span> e0
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> node.simps if_False ring_distribs<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> real<span class="main">(</span>T_ins3 <span class="free">n</span> <span class="skolem">d</span> <span class="free">x</span> <span class="var">?t</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">6</span><span class="main">*</span><span class="main">(</span>size1 <span class="var">?t'</span> <span class="main">-</span> <span class="free">e</span><span class="main">)</span> <span class="main">-</span> Φ <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> imbal_size<span class="main">[</span><span class="operator">OF</span> bal_t'<span class="main">]</span> hl' bal_l' <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> real<span class="main">(</span>T_ins3 <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">*</span>size1 <span class="skolem">l'</span> <span class="main">+</span> <span class="numeral">4</span><span class="main">*</span>size1 <span class="skolem">r</span> <span class="main">-</span> <span class="numeral">4</span><span class="main">*</span>size1 <span class="var">?t'</span> <span class="main">-</span> Φ <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ls Unbal2 inv bal_t' hl' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_bal_tree max_def size1_size<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> real<span class="main">(</span>T_ins3 <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">*</span>size1 <span class="skolem">l'</span> <span class="main">-</span> Φ <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> height <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> amor_Unbal<span class="main">[</span><span class="operator">OF</span> Unbal2 *<span class="main">]</span> ins_size<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Unbal<span class="main">]</span> Φ_nn<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l'</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs size1_size<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>height <span class="skolem">l</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>height <span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">y</span><span class="main">,</span> <span class="skolem">r</span><span class="main">⟩</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> e0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_mono <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> times_divide_eq_left<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> eq <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Node.prems <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gr
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="free">n</span> <span class="main">(</span>height <span class="skolem">r</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_bal_i'<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ins3 <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Same2
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Node gr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bal2 <span class="skolem">r'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> Bal<span class="main">:</span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">r</span> <span class="main">=</span> Bal <span class="skolem">r'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span> Bal2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ins3_ins2 ins2_iff_ins<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">l</span> <span class="skolem">y</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">l</span> <span class="skolem">y</span> <span class="skolem">r'</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> Bal2 <span class="keyword1"><span class="command">have</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="var">?t'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Node.prems gr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"T_ins3 <span class="free">n</span> <span class="skolem">d</span> <span class="free">x</span> <span class="var">?t</span> <span class="main">+</span> Φ <span class="skolem">t'</span> <span class="main">-</span> Φ <span class="var">?t</span> <span class="main">=</span> T_ins3 <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">r</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">+</span> Φ <span class="skolem">t'</span> <span class="main">-</span> Φ <span class="var">?t</span>"</span></span>
         <span class="keyword1"><span class="command">using</span></span> gr Bal2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span>
        <span class="main">=</span> T_ins3 <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">r</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span>imbal <span class="var">?t'</span> <span class="main">+</span> Φ <span class="skolem">r'</span> <span class="main">-</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span>imbal <span class="var">?t</span> <span class="main">-</span> Φ <span class="skolem">r</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> t' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span>
        <span class="main">≤</span> T_ins3 <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">r</span> <span class="main">+</span> Φ <span class="skolem">r'</span> <span class="main">-</span> Φ <span class="skolem">r</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span>imbal <span class="var">?t'</span> <span class="main">-</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span>imbal <span class="var">?t</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> height <span class="skolem">r</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span>imbal <span class="var">?t'</span> <span class="main">-</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span>imbal <span class="var">?t</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="numeral">4</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Node.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Bal2 *<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> height <span class="skolem">r</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span><span class="main">(</span>real<span class="main">(</span>imbal <span class="var">?t'</span><span class="main">)</span> <span class="main">-</span> imbal <span class="var">?t</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="numeral">4</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> height <span class="skolem">r</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="numeral">4</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> imbal_ins_Bal<span class="main">[</span><span class="operator">OF</span> Bal<span class="main">,</span> <span class="operator">of</span> <span class="quoted">True</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> e0
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> times_divide_eq_left<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>height <span class="skolem">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>max <span class="main">(</span>height <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span>height <span class="skolem">r</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> e0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_left_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>height <span class="var">?t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> e0 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Unbal2 <span class="skolem">r'</span> <span class="skolem">nr'</span> <span class="skolem">hr'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> Unbal<span class="main">:</span> <span class="quoted"><span class="quoted">"ins <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">r</span> <span class="main">=</span> Unbal <span class="skolem">r'</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nr'</span> <span class="main">=</span> size <span class="skolem">r'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hr'</span> <span class="main">=</span> height <span class="skolem">r'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span>  Unbal2 ins3_ins2<span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins2_iff_ins<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> bal_r'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="main">(</span>size <span class="skolem">r'</span><span class="main">)</span> <span class="main">(</span>height <span class="skolem">r'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fact</span> bal_i_ins_Unbal<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Unbal<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">l</span> <span class="skolem">y</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"height <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"size <span class="var">?t</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Node <span class="skolem">l</span> <span class="skolem">y</span> <span class="skolem">r'</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"height <span class="var">?t'</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"size <span class="var">?t'</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> bal_t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">bal_i</span> <span class="var">?n'</span> <span class="var">?h'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gr Unbal Bal <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> balance_tree <span class="var">?t'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gr Unbal Bal <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> hr'<span class="main">:</span> <span class="quoted"><span class="quoted">"height <span class="skolem">l</span> <span class="main">&lt;</span> height <span class="skolem">r'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fact</span> height_Unbal_r<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Unbal Node.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"T_ins3 <span class="free">n</span> <span class="skolem">d</span> <span class="free">x</span> <span class="var">?t</span> <span class="main">+</span> Φ <span class="skolem">t'</span> <span class="main">-</span> Φ <span class="var">?t</span> <span class="main">=</span> T_ins3 <span class="free">n</span> <span class="skolem">d</span> <span class="free">x</span> <span class="var">?t</span> <span class="main">-</span> Φ <span class="var">?t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t' Φ_wbalanced wbalanced_balance_tree<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  T_ins3 <span class="free">n</span> <span class="skolem">d</span> <span class="free">x</span> <span class="var">?t</span> <span class="main">-</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> imbal <span class="var">?t</span> <span class="main">-</span> Φ <span class="skolem">r</span> <span class="main">-</span> Φ <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> T_ins3 <span class="free">n</span> <span class="skolem">d</span> <span class="free">x</span> <span class="var">?t</span> <span class="main">-</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> imbal <span class="var">?t</span> <span class="main">-</span> Φ <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Φ_nn<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> T_ins3 <span class="free">n</span> <span class="skolem">d</span> <span class="free">x</span> <span class="var">?t</span> <span class="main">-</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> imbal <span class="var">?t'</span> <span class="main">-</span> Φ <span class="skolem">r</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> mult_left_mono<span class="main">[</span><span class="operator">OF</span> imbal_ins_Unbal<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Unbal<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted">True</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">l</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span><span class="main">*</span><span class="free">e</span>"</span></span><span class="main">]</span> e0
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> node.simps if_True ring_distribs<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> real<span class="main">(</span>T_ins3 <span class="free">n</span> <span class="skolem">d</span> <span class="free">x</span> <span class="var">?t</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">6</span><span class="main">*</span><span class="main">(</span>size1 <span class="var">?t'</span> <span class="main">-</span> <span class="free">e</span><span class="main">)</span> <span class="main">-</span> Φ <span class="skolem">r</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> imbal_size<span class="main">[</span><span class="operator">OF</span> bal_t'<span class="main">]</span> hr' bal_r' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> real<span class="main">(</span>T_ins3 <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">*</span>size1 <span class="skolem">r'</span> <span class="main">+</span> <span class="numeral">4</span><span class="main">*</span>size1 <span class="skolem">l</span> <span class="main">-</span> <span class="numeral">4</span><span class="main">*</span>size1 <span class="var">?t'</span> <span class="main">-</span> Φ <span class="skolem">r</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gr Unbal2 inv bal_t' hr' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_bal_tree max_def size1_size add_ac<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> real<span class="main">(</span>T_ins3 <span class="free">n</span> <span class="main">(</span><span class="skolem">d</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">x</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">*</span>size1 <span class="skolem">r'</span> <span class="main">-</span> Φ <span class="skolem">r</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> height <span class="skolem">r</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> amor_Unbal<span class="main">[</span><span class="operator">OF</span> Unbal2 *<span class="main">]</span> ins_size<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Unbal<span class="main">]</span> Φ_nn<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r'</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs size1_size<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>height <span class="skolem">r</span> <span class="main">+</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>height <span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">y</span><span class="main">,</span> <span class="skolem">r</span><span class="main">⟩</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> e0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_mono <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> times_divide_eq_left<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> T_insert3_amor<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> size <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="main">(</span>size <span class="free">t</span><span class="main">)</span> <span class="main">(</span>height <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"insert3 <span class="free">a</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">t'</span><span class="main">,</span><span class="free">n'</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"T_insert3 <span class="free">a</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">+</span> Φ <span class="free">t'</span> <span class="main">-</span> Φ <span class="free">t</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>height <span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ins3 <span class="main">(</span>size <span class="free">t</span><span class="main">)</span> <span class="main">0</span> <span class="free">a</span> <span class="free">t</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Same2
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">5</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> real <span class="main">(</span>height <span class="free">t'</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> e0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Same2 assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> e0 T_ins3_Same<span class="main">[</span><span class="operator">OF</span> Same2<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs T_insert3_def2<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bal2 <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> T_ins3_Bal<span class="main">[</span><span class="operator">OF</span> Bal2<span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins_size T_insert3_def2<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Unbal2
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> ins0_neq_Unbal
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> ins3_ins2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ins2_iff_ins<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* RBTi2 *)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The insert-only version is shown to have the desired logarithmic
amortized complexity. First it is shown to be linear in the height of the tree.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> RBTi2_Amor <span class="main">=</span> RBTi2
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nxt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> rbt1 <span class="main">⇒</span> <span class="tfree">'a</span> rbt1"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">nxt</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">tn</span></span></span> <span class="main">=</span> insert3 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">tn</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">t<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> rbt1 <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">t<span class="hidden">⇩</span><sub>s</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">tn</span></span></span> <span class="main">=</span> T_insert3 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">tn</span></span></span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> I_RBTi2_Amor<span class="main">:</span> Amortized
<span class="keyword2"><span class="keyword">where</span></span> init <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Leaf<span class="main">,</span><span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> nxt <span class="main">=</span> <span class="quoted">nxt</span>
<span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">=</span> size <span class="bound">t</span> <span class="main">∧</span> <span class="free">bal_i</span> <span class="main">(</span>size <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>height <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> T <span class="main">=</span> <span class="quoted">t<span class="hidden">⇩</span><sub>s</sub></span> <span class="keyword2"><span class="keyword">and</span></span> Φ <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> Φ <span class="bound">t</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> U <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>height <span class="bound">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> bal_i0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> insert2_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">s</span>"</span></span><span class="main">]</span> bal_i_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">s</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> insert2.simps insert3_def2 insert.simps
             <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert3_insert2 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Φ_nn<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">s</span>"</span></span> <span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> T_insert3_amor<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> insert3_def2 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Now it is shown that a certain instantiation of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>bal_i›</span></span></span></span> that guarantees
logarithmic height satisfies the assumptions of locale <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">locale</span></span> RBTi2<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> I_RBTi2<span class="main">:</span> RBTi2
<span class="keyword2"><span class="keyword">where</span></span> bal_i <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span> <span class="bound">h</span><span class="main">.</span> <span class="bound">h</span> <span class="main">≤</span> ceiling<span class="main">(</span>c <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> e <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span>c<span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">-</span> <span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span>c<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> real <span class="main">(</span>size <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> real <span class="main">(</span>size <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> c <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> real <span class="main">(</span>size <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c1 <span class="quoted">"0"</span> less_eq_real_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> height_balance_tree add_ac ceiling_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">n</span> <span class="skolem">h</span> <span class="skolem">n'</span> <span class="skolem">h'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="skolem">h'</span> <span class="main">≤</span> int <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> ceiling<span class="main">(</span>c <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> 2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> ceiling<span class="main">(</span>c <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>real <span class="skolem">n'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c1 <span class="quoted">"2"</span><span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ceiling_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span>c<span class="main">)</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> powr_less_cancel_iff<span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">-</span> <span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> c<span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">t</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> size1_imbal2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bal_log_def size1_size add_ac ring_distribs<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Naive implementation (with delete)"</span></span>

<span class="keyword1"><span class="command">axiomatization</span></span> <span class="free">cd</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">where</span></span>
cd0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cd</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bal_d</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bal_d</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">dl</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">dl</span></span></span> <span class="main">&lt;</span> cd<span class="main">*</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bal_d0<span class="main">:</span> <span class="quoted"><span class="quoted">"bal_d <span class="free">n</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> cd0 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bal_d_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_bal_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bal_d <span class="free">n</span> <span class="free">dl</span><span class="main">;</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">n'</span> <span class="main">⟧</span> <span class="main">⟹</span> bal_d <span class="free">n'</span> <span class="free">dl</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span>  bal_d_def
<span class="keyword1"><span class="command">using</span></span> cd0 mult_left_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"real <span class="free">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"real <span class="free">n'</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted">cd</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>

<span class="keyword1"><span class="command">locale</span></span> RBTid1 <span class="main">=</span> RBTi1
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Functions›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insert_d</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> rbt1 <span class="main">⇒</span> <span class="tfree">'a</span> rbt1"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">insert_d</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">dl</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> ins <span class="main">(</span>size <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">dl</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
    Same <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">|</span>
    Bal <span class="bound">t'</span> <span class="main">⇒</span> <span class="bound">t'</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">dl</span></span></span><span class="main">)</span>"</span></span>
    <span class="comment1">(* Unbal unreachable *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">up_d</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'a</span> tree option <span class="main">⇒</span> <span class="tfree">'a</span> tree option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">up_d</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">sib</span></span></span> <span class="free"><span class="bound"><span class="entity">twist</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">of</span>
     None <span class="main">⇒</span> None <span class="main">|</span>
     Some <span class="bound">t</span> <span class="main">⇒</span> Some<span class="main">(</span>node <span class="free"><span class="bound"><span class="entity">twist</span></span></span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">sib</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> up_d_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="comment1">(* FIXME tdel ≤ height
fun T_split_min :: "'a tree ⇒ nat" where
"T_split_min t = height t"
*)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">del_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree option tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">del_tm</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> Leaf <span class="main">=1</span> return None"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">del_tm</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=1</span>
  <span class="main">(</span><span class="keyword1">case</span> cmp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">of</span>
     LT <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">l'</span> <span class="main">←</span> <span class="free">del_tm</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">;</span> return <span class="main">(</span>up_d <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> False <span class="bound">l'</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span>
     EQ <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Leaf <span class="keyword1">then</span> return <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>
           <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span> <span class="main">←</span> split_min_tm <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span>
                     return <span class="main">(</span>Some<span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">a'</span> <span class="bound">r'</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span>
     GT <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">r'</span> <span class="main">←</span> <span class="free">del_tm</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span> return <span class="main">(</span>up_d <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> True <span class="bound">r'</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">del</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">del</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> val<span class="main">(</span>del_tm <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> del_Leaf<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"del <span class="free">x</span> Leaf <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">using</span></span> val_cong<span class="main">[</span><span class="operator">OF</span> del_tm.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> del_def val_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> del_Node<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"del <span class="free">x</span> <span class="main">(</span>Node <span class="free">l</span> <span class="free">y</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> cmp <span class="free">x</span> <span class="free">y</span> <span class="keyword1">of</span>
     LT <span class="main">⇒</span> <span class="keyword1">let</span> <span class="bound">l'</span> <span class="main">=</span> del <span class="free">x</span> <span class="free">l</span> <span class="keyword1">in</span> up_d <span class="free">y</span> <span class="free">r</span> False <span class="bound">l'</span> <span class="main">|</span>
     EQ <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free">r</span> <span class="main">=</span> Leaf <span class="keyword1">then</span> Some <span class="free">l</span>
           <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="bound">r'</span><span class="main">)</span> <span class="main">=</span> split_min <span class="free">r</span> <span class="keyword1">in</span> Some<span class="main">(</span>Node <span class="free">l</span> <span class="bound">a'</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">|</span>
     GT <span class="main">⇒</span> <span class="keyword1">let</span> <span class="bound">r'</span> <span class="main">=</span> del <span class="free">x</span> <span class="free">r</span> <span class="keyword1">in</span> up_d <span class="free">y</span> <span class="free">l</span> True <span class="bound">r'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> val_cong<span class="main">[</span><span class="operator">OF</span> del_tm.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> del_def split_min_def val_simps cmp_val.case_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">val</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">T_del</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_del</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> time<span class="main">(</span>del_tm <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> T_del_Leaf<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"T_del <span class="free">x</span> Leaf <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_del_def tm_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> T_del_Node<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"T_del <span class="free">x</span> <span class="main">(</span>Node <span class="free">l</span> <span class="free">y</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> cmp <span class="free">x</span> <span class="free">y</span> <span class="keyword1">of</span>
     LT <span class="main">⇒</span> T_del <span class="free">x</span> <span class="free">l</span> <span class="main">+</span> <span class="main">1</span> <span class="main">|</span>
     EQ <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free">r</span> <span class="main">=</span> Leaf <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> T_split_min <span class="free">r</span> <span class="main">+</span> <span class="main">1</span> <span class="main">|</span>
     GT <span class="main">⇒</span> T_del <span class="free">x</span> <span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_del_def T_split_min_def tm_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tm.split prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">delete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> rbt1 <span class="main">⇒</span> <span class="tfree">'a</span> rbt1"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">dl</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> del <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">dl</span></span></span><span class="main">)</span> <span class="main">|</span>
    Some <span class="bound">t'</span> <span class="main">⇒</span>
      <span class="keyword1">if</span> bal_d <span class="main">(</span>size <span class="bound">t'</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">dl</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">t'</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">dl</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>balance_tree <span class="bound">t'</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> delete.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Functional Correctness›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> size_insert_d<span class="main">:</span> <span class="quoted"><span class="quoted">"insert_d <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">dl</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">t'</span><span class="main">,</span><span class="free">dl'</span><span class="main">)</span> <span class="main">⟹</span> size <span class="free">t</span> <span class="main">≤</span> size <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ins_size ins0_neq_Unbal <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits up.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inorder_insert_d<span class="main">:</span> <span class="quoted"><span class="quoted">"insert_d <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">dl</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">t'</span><span class="main">,</span><span class="free">dl'</span><span class="main">)</span> <span class="main">⟹</span> sorted<span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span>
  <span class="main">⟹</span> inorder <span class="free">t'</span> <span class="main">=</span> ins_list <span class="free">x</span> <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins0_neq_Unbal insert_def inorder_ins <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split up.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bal_i_insert_d<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"insert_d <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">dl</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">t'</span><span class="main">,</span><span class="free">dl'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="main">(</span>size <span class="free">t</span> <span class="main">+</span> <span class="free">dl</span><span class="main">)</span> <span class="main">(</span>height <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="main">(</span>size <span class="free">t'</span> <span class="main">+</span> <span class="free">dl</span><span class="main">)</span> <span class="main">(</span>height <span class="free">t'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ins <span class="main">(</span>size <span class="free">t</span> <span class="main">+</span> <span class="free">dl</span><span class="main">)</span> <span class="main">0</span> <span class="free">x</span> <span class="free">t</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Same
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Bal
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ins_bal_i_Bal<span class="main">[</span><span class="operator">OF</span> Bal<span class="main">]</span> assms ins_size <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size1_size<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Unbal <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins0_neq_Unbal<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inorder_del<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted<span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
  inorder<span class="main">(</span><span class="keyword1">case</span> del <span class="free">x</span> <span class="free">t</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free">t</span> <span class="main">|</span> Some <span class="bound">t'</span> <span class="main">⇒</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">=</span> del_list <span class="free">x</span> <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> del_list_simps split_minD <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inorder_delete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> delete <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">dl</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">t'</span><span class="main">,</span><span class="free">dl'</span><span class="main">)</span><span class="main">;</span> sorted<span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
  inorder <span class="free">t'</span> <span class="main">=</span> del_list <span class="free">x</span> <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> inorder_del<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delete.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> size_split_min<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> split_min <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">t'</span><span class="main">)</span><span class="main">;</span> <span class="free">t</span> <span class="main">≠</span> Leaf <span class="main">⟧</span> <span class="main">⟹</span> size <span class="free">t'</span> <span class="main">=</span> size <span class="free">t</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_less_iff_neq_zero <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> height_split_min<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> split_min <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">t'</span><span class="main">)</span><span class="main">;</span> <span class="free">t</span> <span class="main">≠</span> Leaf <span class="main">⟧</span> <span class="main">⟹</span> height <span class="free">t'</span> <span class="main">≤</span> height <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> size_del<span class="main">:</span> <span class="quoted"><span class="quoted">"del <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">t'</span> <span class="main">⟹</span> size <span class="free">t'</span> <span class="main">=</span> size <span class="free">t</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> del_tm.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">l</span> <span class="skolem">y</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>ls<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span> <span class="main">|</span> <span class="main">(</span>eq<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="main">|</span> <span class="main">(</span>gr<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> less_linear<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> ls
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"2.prems"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> l'<span class="main">:</span> <span class="quoted"><span class="quoted">"del <span class="skolem">x</span> <span class="skolem">l</span> <span class="main">=</span> Some <span class="skolem">l'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="skolem">l</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ls 2 l' <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> eq
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> Leaf"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="quoted">"2.prems"</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> eq <span class="quoted">"2.prems"</span> eq_size_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_split_min <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> eq_size_0 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gr
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"2.prems"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> r'<span class="main">:</span> <span class="quoted"><span class="quoted">"del <span class="skolem">x</span> <span class="skolem">r</span> <span class="main">=</span> Some <span class="skolem">r'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="skolem">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> gr 2 r' <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> height_del<span class="main">:</span> <span class="quoted"><span class="quoted">"del <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">t'</span> <span class="main">⟹</span> height <span class="free">t'</span> <span class="main">≤</span> height <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> del_tm.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">l</span> <span class="skolem">y</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>ls<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span> <span class="main">|</span> <span class="main">(</span>eq<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="main">|</span> <span class="main">(</span>gr<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> less_linear<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> ls
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> eq
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2.prems"</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> height_split_min <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gr
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bal_i_delete<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="main">(</span>size <span class="free">t</span> <span class="main">+</span> <span class="free">dl</span><span class="main">)</span> <span class="main">(</span>height <span class="free">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"delete <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">dl</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">t'</span><span class="main">,</span><span class="free">dl'</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="main">(</span>size <span class="free">t'</span> <span class="main">+</span> <span class="free">dl'</span><span class="main">)</span> <span class="main">(</span>height <span class="free">t'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"del <span class="free">x</span> <span class="free">t</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> None
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delete.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Some
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size <span class="free">t</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Some assms size_del height_del<span class="main">[</span><span class="operator">OF</span> Some<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delete.simps bal_i_balance mono_bal_i' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bal_d_delete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bal_d <span class="main">(</span>size <span class="free">t</span><span class="main">)</span> <span class="free">dl</span><span class="main">;</span> delete <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">dl</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">t'</span><span class="main">,</span><span class="free">dl'</span><span class="main">)</span> <span class="main">⟧</span>
   <span class="main">⟹</span> bal_d <span class="main">(</span>size <span class="free">t'</span><span class="main">)</span> <span class="free">dl'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delete.simps bal_d0 size_del <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Full functional correctness of the naive implementation:›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Set_by_Ordered
<span class="keyword2"><span class="keyword">where</span></span> empty <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Leaf<span class="main">,</span><span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> isin <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> isin <span class="bound">t</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> insert <span class="main">=</span> <span class="quoted">insert_d</span> <span class="keyword2"><span class="keyword">and</span></span> delete <span class="main">=</span> <span class="quoted">delete</span>
<span class="keyword2"><span class="keyword">and</span></span> inorder <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> inorder <span class="bound">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isin_set <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">t</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> insert_d.simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inorder_insert_d <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">tn</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tn</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inorder_delete <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> TrueI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* RBTid1 *)</span>

<span class="keyword1"><span class="command">interpretation</span></span> I_RBTid1<span class="main">:</span> RBTid1
<span class="keyword2"><span class="keyword">where</span></span> bal_i <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span> <span class="bound">h</span><span class="main">.</span> <span class="bound">h</span> <span class="main">≤</span> log <span class="numeral">2</span> <span class="main">(</span>real<span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Efficient Implementation (with delete)"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> rbt2 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">*</span> nat <span class="main">*</span> nat"</span></span>

<span class="keyword1"><span class="command">locale</span></span> RBTid2 <span class="main">=</span> RBTi2 <span class="main">+</span> RBTid1
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Functions›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insert2_d</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> rbt2 <span class="main">⇒</span> <span class="tfree">'a</span> rbt2"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">insert2_d</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">dl</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> ins2 <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">dl</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
     Same2 <span class="main">⇒</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">dl</span></span></span><span class="main">)</span> <span class="main">|</span>
     Bal2 <span class="bound">t'</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">t'</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">dl</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="comment1">(* Unbal unreachable *)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insert3_d_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> rbt2 <span class="main">⇒</span> <span class="tfree">'a</span> rbt2 tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">insert3_d_tm</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">dl</span></span></span><span class="main">)</span> <span class="main">=1</span>
  <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">t'</span> <span class="main">←</span> ins3_tm <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">dl</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span>
       <span class="keyword1">case</span> <span class="bound">t'</span> <span class="keyword1">of</span>
         Same2 <span class="main">⇒</span> return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">dl</span></span></span><span class="main">)</span> <span class="main">|</span>
         Bal2 <span class="bound">t'</span> <span class="main">⇒</span> return <span class="main">(</span><span class="bound">t'</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">dl</span></span></span><span class="main">)</span> <span class="main">|</span>
         Unbal2 <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> return undefined<span class="main">}</span>"</span></span>
  <span class="comment1">(* Unbal unreachable *)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">insert3_d</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> rbt2 <span class="main">⇒</span> <span class="tfree">'a</span> rbt2"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">insert3_d</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> val <span class="main">(</span>insert3_d_tm <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert3_d_def2<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"insert3_d <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">n</span><span class="main">,</span><span class="free">dl</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">t'</span> <span class="main">=</span> ins3 <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="free">dl</span><span class="main">)</span> <span class="main">0</span> <span class="free">x</span> <span class="free">t</span> <span class="keyword1">in</span>
   <span class="keyword1">case</span> <span class="bound">t'</span> <span class="keyword1">of</span>
     Same2 <span class="main">⇒</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">n</span><span class="main">,</span><span class="free">dl</span><span class="main">)</span> <span class="main">|</span>
     Bal2 <span class="bound">t'</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">t'</span><span class="main">,</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">,</span><span class="free">dl</span><span class="main">)</span> <span class="main">|</span>
     Unbal2 <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> undefined<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> val_cong<span class="main">[</span><span class="operator">OF</span> insert3_d_tm.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> insert3_d_def ins3_def val_simps up2.case_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">val</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">T_insert3_d</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> rbt2 <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_insert3_d</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> time<span class="main">(</span>insert3_d_tm <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> T_insert3_d_def2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"T_insert3_d <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">n</span><span class="main">,</span><span class="free">dl</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>T_ins3 <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="free">dl</span><span class="main">)</span> <span class="main">0</span> <span class="free">x</span> <span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_insert3_d_def T_ins3_def tm_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tm.split up2.split<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">delete2_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> rbt2 <span class="main">⇒</span> <span class="tfree">'a</span> rbt2 tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">delete2_tm</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">dl</span></span></span><span class="main">)</span> <span class="main">=1</span>
  <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">t'</span> <span class="main">←</span> del_tm <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span>
       <span class="keyword1">case</span> <span class="bound">t'</span> <span class="keyword1">of</span>
         None <span class="main">⇒</span> return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">dl</span></span></span><span class="main">)</span> <span class="main">|</span>
         Some <span class="bound">t'</span> <span class="main">⇒</span>
           <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">;</span> <span class="bound">dl'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">dl</span></span></span> <span class="main">+</span> <span class="main">1</span>
            <span class="keyword1">in</span> <span class="keyword1">if</span> bal_d <span class="bound">n'</span> <span class="bound">dl'</span> <span class="keyword1">then</span> return <span class="main">(</span><span class="bound">t'</span><span class="main">,</span><span class="bound">n'</span><span class="main">,</span><span class="bound">dl'</span><span class="main">)</span>
               <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">t''</span> <span class="main">←</span> bal_tree_tm <span class="bound">n'</span> <span class="bound">t'</span><span class="main">;</span>
                         return <span class="main">(</span><span class="bound">t''</span><span class="main">,</span> <span class="bound">n'</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">delete2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> rbt2 <span class="main">⇒</span> <span class="tfree">'a</span> rbt2"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">delete2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> val<span class="main">(</span>delete2_tm <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> delete2_def2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"delete2 <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">n</span><span class="main">,</span><span class="free">dl</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">t'</span> <span class="main">=</span> del <span class="free">x</span> <span class="free">t</span> <span class="keyword1">in</span>
   <span class="keyword1">case</span> <span class="bound">t'</span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">n</span><span class="main">,</span><span class="free">dl</span><span class="main">)</span> <span class="main">|</span>
    Some <span class="bound">t'</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n'</span> <span class="main">=</span> <span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">;</span> <span class="bound">dl'</span> <span class="main">=</span> <span class="free">dl</span> <span class="main">+</span> <span class="main">1</span>
      <span class="keyword1">in</span> <span class="keyword1">if</span> bal_d <span class="bound">n'</span> <span class="bound">dl'</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">t'</span><span class="main">,</span><span class="bound">n'</span><span class="main">,</span><span class="bound">dl'</span><span class="main">)</span>
         <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="bound">t''</span> <span class="main">=</span> bal_tree <span class="bound">n'</span> <span class="bound">t'</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">t''</span><span class="main">,</span> <span class="bound">n'</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> val_cong<span class="main">[</span><span class="operator">OF</span> delete2_tm.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> delete2_def ins3_def del_def bal_tree_def val_simps option.case_distrib<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">val</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">T_delete2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span> rbt2 <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">T_delete2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> time<span class="main">(</span>delete2_tm <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> T_delete2_def2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"T_delete2 <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">n</span><span class="main">,</span><span class="free">dl</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>T_del <span class="free">x</span> <span class="free">t</span> <span class="main">+</span>
  <span class="main">(</span><span class="keyword1">case</span> del <span class="free">x</span> <span class="free">t</span> <span class="keyword1">of</span>
     None <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span>
     Some <span class="bound">t'</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n'</span> <span class="main">=</span> <span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">;</span> <span class="bound">dl'</span> <span class="main">=</span> <span class="free">dl</span> <span class="main">+</span> <span class="main">1</span>
       <span class="keyword1">in</span> <span class="keyword1">if</span> bal_d <span class="bound">n'</span> <span class="bound">dl'</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> T_bal_tree <span class="bound">n'</span> <span class="bound">t'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_delete2_def tm_simps T_del_def del_def T_bal_tree_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tm.split option.split<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Equivalence proofs›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> insert2_insert_d<span class="main">:</span>
  <span class="quoted"><span class="quoted">"insert2_d <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span>size <span class="free">t</span><span class="main">,</span><span class="free">dl</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">t'</span><span class="main">,</span><span class="free">n'</span><span class="main">,</span><span class="free">dl'</span><span class="main">)</span> <span class="main">⟷</span>
   <span class="main">(</span><span class="free">t'</span><span class="main">,</span><span class="free">dl'</span><span class="main">)</span> <span class="main">=</span> insert_d <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">dl</span><span class="main">)</span> <span class="main">∧</span> <span class="free">n'</span> <span class="main">=</span> size <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ins2_iff_ins ins_size ins0_neq_Unbal <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> up2.split up.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insert3_insert2_d<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="free">dl</span><span class="main">)</span> <span class="main">(</span>height <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> insert3_d <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">n</span><span class="main">,</span><span class="free">dl</span><span class="main">)</span> <span class="main">=</span> insert2_d <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">n</span><span class="main">,</span><span class="free">dl</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins3_ins2 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> up2.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> delete2_delete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"delete2 <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span>size <span class="free">t</span><span class="main">,</span><span class="free">dl</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">t'</span><span class="main">,</span><span class="free">n'</span><span class="main">,</span><span class="free">dl'</span><span class="main">)</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="free">t'</span><span class="main">,</span><span class="free">dl'</span><span class="main">)</span> <span class="main">=</span> delete <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">dl</span><span class="main">)</span> <span class="main">∧</span> <span class="free">n'</span> <span class="main">=</span> size <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> delete2_def2 delete.simps size_del balance_tree_def bal_tree
    <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Amortized complexity›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Φ<span class="hidden">⇩</span><sub>d</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rbt2 <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Φ<span class="hidden">⇩</span><sub>d</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">dl</span></span></span><span class="main">)</span> <span class="main">=</span> Φ <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> <span class="numeral">4</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">dl</span></span></span><span class="main">/</span>cd"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Φ<span class="hidden">⇩</span><sub>d</sub>_case<span class="main">:</span> <span class="quoted"><span class="quoted">"Φ<span class="hidden">⇩</span><sub>d</sub> <span class="free">tndl</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">tndl</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">n</span><span class="main">,</span><span class="bound">dl</span><span class="main">)</span> <span class="main">⇒</span> Φ <span class="bound">t</span> <span class="main">+</span> <span class="numeral">4</span><span class="main">*</span><span class="bound">dl</span><span class="main">/</span>cd<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> imbal_diff_decr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"size <span class="free">r'</span> <span class="main">=</span> size <span class="free">r</span> <span class="main">-</span> <span class="main">1</span> <span class="main">⟹</span>
   real<span class="main">(</span>imbal <span class="main">(</span>Node <span class="free">l</span> <span class="free">x'</span> <span class="free">r'</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> imbal <span class="main">(</span>Node <span class="free">l</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> imbal.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tinsert_d_amor<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> size <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"insert_d <span class="free">a</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">dl</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">t'</span><span class="main">,</span><span class="free">dl'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="main">(</span>size <span class="free">t</span> <span class="main">+</span> <span class="free">dl</span><span class="main">)</span> <span class="main">(</span>height <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"T_insert3_d <span class="free">a</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">n</span><span class="main">,</span><span class="free">dl</span><span class="main">)</span> <span class="main">+</span> Φ <span class="free">t'</span> <span class="main">-</span> Φ <span class="free">t</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>height <span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"ins <span class="main">(</span>size <span class="free">t</span> <span class="main">+</span> <span class="free">dl</span><span class="main">)</span> <span class="main">0</span> <span class="free">a</span> <span class="free">t</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Same
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">5</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> real <span class="main">(</span>height <span class="free">t</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> e0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> T_ins3_Same<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"size <span class="free">t</span> <span class="main">+</span> <span class="free">dl</span>"</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> Same assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs ins3_ins2 ins2_ins<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> * e0
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Bal <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> T_ins3_Bal<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"size <span class="free">t</span> <span class="main">+</span> <span class="free">dl</span>"</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="skolem">t'</span></span><span class="main">]</span> Bal assms
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins_size ins3_ins2 ins2_ins<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Unbal
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins0_neq_Unbal<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> T_split_min_ub<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> T_split_min <span class="free">t</span> <span class="main">≤</span> height <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> T_del_ub<span class="main">:</span>
  <span class="quoted"><span class="quoted">"T_del <span class="free">x</span> <span class="free">t</span> <span class="main">≤</span> height <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> T_split_min_ub<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> imbal_split_min<span class="main">:</span>
  <span class="quoted"><span class="quoted">"split_min <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">t'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> real<span class="main">(</span>imbal <span class="free">t'</span><span class="main">)</span> <span class="main">-</span> imbal <span class="free">t</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">l</span> <span class="skolem">y</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> size_split_min<span class="main">[</span><span class="operator">OF</span> Node.prems<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> imbal.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t'</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> imbal.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> imbal.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> imbal_del_Some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"del <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">t'</span> <span class="main">⟹</span> real<span class="main">(</span>imbal <span class="free">t'</span><span class="main">)</span> <span class="main">-</span> imbal <span class="free">t</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Leaf
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> imbal.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">t1</span> <span class="skolem">x2</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> size_del<span class="main">[</span><span class="operator">OF</span> Node.prems<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> imbal.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t'</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> imbal.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> imbal.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Phi_diff_split_min<span class="main">:</span>
  <span class="quoted"><span class="quoted">"split_min <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">t'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> Φ <span class="free">t'</span> <span class="main">-</span> Φ <span class="free">t</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span>height <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">l</span> <span class="skolem">y</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">arith</span><span class="main">]</span> <span class="main">=</span> e0
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> Leaf"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">b</span> <span class="main">⟷</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">a</span><span class="main">+</span><span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Node.prems
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> imbal.simps *<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> Node.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> rec<span class="main">:</span> <span class="quoted"><span class="quoted">"split_min <span class="skolem">l</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="skolem">l'</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Node <span class="skolem">l'</span> <span class="skolem">y</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Φ <span class="skolem">t'</span> <span class="main">-</span> Φ <span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">r</span><span class="main">⟩</span> <span class="main">=</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span>imbal<span class="main">⟨</span><span class="skolem">l'</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">r</span><span class="main">⟩</span> <span class="main">-</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span>imbal<span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">r</span><span class="main">⟩</span> <span class="main">+</span> Φ <span class="skolem">l'</span> <span class="main">-</span> Φ <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> <span class="main">(</span>real<span class="main">(</span>imbal<span class="main">⟨</span><span class="skolem">l'</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">r</span><span class="main">⟩</span><span class="main">)</span> <span class="main">-</span> imbal<span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">r</span><span class="main">⟩</span><span class="main">)</span> <span class="main">+</span> Φ <span class="skolem">l'</span> <span class="main">-</span> Φ <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> Φ <span class="skolem">l'</span> <span class="main">-</span> Φ <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> imbal_split_min<span class="main">[</span><span class="operator">OF</span> Node.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> t'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> <span class="main">(</span>height <span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> rec False<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> height <span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">y</span><span class="main">,</span> <span class="skolem">r</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> times_divide_eq_left<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Phi_diff_del_Some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"del <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">t'</span> <span class="main">⟹</span> Φ <span class="free">t'</span> <span class="main">-</span> Φ <span class="free">t</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> height <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Leaf <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> imbal.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">l</span> <span class="skolem">y</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">arith</span><span class="main">]</span> <span class="main">=</span> e0
  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>ls<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span> <span class="main">|</span> <span class="main">(</span>eq<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="main">|</span> <span class="main">(</span>gr<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> less_linear<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> ls
    <span class="keyword1"><span class="command">with</span></span> Node.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> rec<span class="main">:</span> <span class="quoted"><span class="quoted">"del <span class="free">x</span> <span class="skolem">l</span> <span class="main">=</span> Some <span class="skolem">l'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Node <span class="skolem">l'</span> <span class="skolem">y</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Φ <span class="skolem">t'</span> <span class="main">-</span> Φ <span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">r</span><span class="main">⟩</span> <span class="main">=</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span>imbal<span class="main">⟨</span><span class="skolem">l'</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">r</span><span class="main">⟩</span> <span class="main">-</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span>imbal<span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">r</span><span class="main">⟩</span> <span class="main">+</span> Φ <span class="skolem">l'</span> <span class="main">-</span> Φ <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> <span class="main">(</span>real<span class="main">(</span>imbal<span class="main">⟨</span><span class="skolem">l'</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">r</span><span class="main">⟩</span><span class="main">)</span> <span class="main">-</span> imbal<span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">r</span><span class="main">⟩</span><span class="main">)</span> <span class="main">+</span> Φ <span class="skolem">l'</span> <span class="main">-</span> Φ <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> Φ <span class="skolem">l'</span> <span class="main">-</span> Φ <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> imbal_del_Some<span class="main">[</span><span class="operator">OF</span> Node.prems<span class="main">]</span> t'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> <span class="main">(</span>height <span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> rec<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> height <span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">y</span><span class="main">,</span> <span class="skolem">r</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> times_divide_eq_left<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> eq
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> Leaf"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"size <span class="skolem">t'</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> Node.prems <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> imbal.simps of_nat_diff<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> False
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Node.prems <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> imbal.simps of_nat_diff <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"split_min <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">r'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Node.prems
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span>  mult_left_mono<span class="main">[</span><span class="operator">OF</span> imbal_diff_decr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> size_split_min<span class="main"><span class="main">[</span></span><span class="operator">OF</span> this False<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">5</span><span class="main">*</span><span class="free">e</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span>real <span class="main">(</span>imbal <span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span>real <span class="main">(</span>imbal <span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">y</span><span class="main">,</span> <span class="skolem">r</span><span class="main">⟩</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Node.prems * False Phi_diff_split_min<span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_def ring_distribs<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> mult_less_cancel_left_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">6</span><span class="main">*</span><span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"height <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"height <span class="skolem">l</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gr
    <span class="keyword1"><span class="command">with</span></span> Node.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> rec<span class="main">:</span> <span class="quoted"><span class="quoted">"del <span class="free">x</span> <span class="skolem">r</span> <span class="main">=</span> Some <span class="skolem">r'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Node <span class="skolem">l</span> <span class="skolem">y</span> <span class="skolem">r'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Φ <span class="skolem">t'</span> <span class="main">-</span> Φ <span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">r</span><span class="main">⟩</span> <span class="main">=</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span>imbal<span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">r'</span><span class="main">⟩</span> <span class="main">-</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">*</span>imbal<span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">r</span><span class="main">⟩</span> <span class="main">+</span> Φ <span class="skolem">r'</span> <span class="main">-</span> Φ <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> <span class="main">(</span>real<span class="main">(</span>imbal<span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">r'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">-</span> imbal<span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">r</span><span class="main">⟩</span><span class="main">)</span> <span class="main">+</span> Φ <span class="skolem">r'</span> <span class="main">-</span> Φ <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> Φ <span class="skolem">r'</span> <span class="main">-</span> Φ <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> imbal_del_Some<span class="main">[</span><span class="operator">OF</span> Node.prems<span class="main">]</span> t'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> <span class="main">(</span>height <span class="skolem">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Node.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> rec<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> height <span class="main">⟨</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">y</span><span class="main">,</span> <span class="skolem">r</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> times_divide_eq_left<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> amor_del_Some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"del <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">t'</span> <span class="main">⟹</span>
  T_del <span class="free">x</span> <span class="free">t</span> <span class="main">+</span> Φ <span class="free">t'</span> <span class="main">-</span> Φ <span class="free">t</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> height <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> Phi_diff_del_Some<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> T_del_ub<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span>cd <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cd0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> T_delete_amor<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> size <span class="free">t</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"T_delete2 <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">n</span><span class="main">,</span><span class="free">dl</span><span class="main">)</span> <span class="main">+</span> Φ<span class="hidden">⇩</span><sub>d</sub> <span class="main">(</span>delete2 <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">n</span><span class="main">,</span><span class="free">dl</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> Φ<span class="hidden">⇩</span><sub>d</sub> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">n</span><span class="main">,</span><span class="free">dl</span><span class="main">)</span>
       <span class="main">≤</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> height <span class="free">t</span> <span class="main">+</span> <span class="numeral">4</span><span class="main">/</span>cd <span class="main">+</span> <span class="numeral">4</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"del <span class="free">x</span> <span class="free">t</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> None
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">6</span><span class="main">*</span><span class="free">e</span> <span class="main">*</span> real <span class="main">(</span>height <span class="free">t</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> e0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> None
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delete2_def2 T_delete2_def2 ring_distribs<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> * T_del_ub<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> cd1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">t'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"bal_d <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">dl</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms Some amor_del_Some<span class="main">[</span><span class="operator">OF</span> Some<span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_del delete2_def2 T_delete2_def2 <span class="dynamic"><span class="dynamic">algebra_simps</span></span> add_divide_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> Some <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">arith</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="free">t</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"T_delete2 <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">n</span><span class="main">,</span> <span class="free">dl</span><span class="main">)</span> <span class="main">+</span> Φ<span class="hidden">⇩</span><sub>d</sub> <span class="main">(</span>delete2 <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">n</span><span class="main">,</span><span class="free">dl</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> Φ<span class="hidden">⇩</span><sub>d</sub> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">n</span><span class="main">,</span><span class="free">dl</span><span class="main">)</span> <span class="main">=</span>
      T_delete2 <span class="free">x</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">n</span><span class="main">,</span> <span class="free">dl</span><span class="main">)</span> <span class="main">-</span> Φ <span class="free">t</span> <span class="main">-</span> <span class="numeral">4</span><span class="main">*</span><span class="free">dl</span><span class="main">/</span>cd"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False Some
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delete2_def2 T_delete2_def2 Φ_wbalanced bal_tree assms size_del<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> T_del <span class="free">x</span> <span class="free">t</span> <span class="main">+</span> <span class="numeral">4</span> <span class="main">*</span> size <span class="free">t</span> <span class="main">-</span> Φ <span class="free">t</span> <span class="main">-</span> <span class="numeral">4</span><span class="main">*</span><span class="free">dl</span><span class="main">/</span>cd"</span></span>       
      <span class="keyword1"><span class="command">using</span></span> False assms Some <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_delete2_def2 T_bal_tree size_del size1_size<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">*</span>height <span class="free">t</span> <span class="main">+</span> <span class="numeral">4</span><span class="main">*</span><span class="main">(</span>size <span class="free">t</span> <span class="main">-</span> <span class="free">dl</span><span class="main">/</span>cd <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> amor_del_Some<span class="main">[</span><span class="operator">OF</span> Some<span class="main">]</span> Φ_nn<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> Φ_nn<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t'</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="free">t</span> <span class="main">-</span> <span class="free">dl</span><span class="main">/</span>cd <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="main">1</span><span class="main">/</span>cd <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms False cd0 <span class="keyword1"><span class="command">unfolding</span></span> bal_d_def
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> of_nat_diff<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ring_distribs<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="quasi_keyword">plugins</span> <span class="quasi_keyword">del</span><span class="main">:</span> lifting<span class="main">)</span> <span class="tfree">'b</span> ops <span class="main">=</span> Insert <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span> <span class="main">|</span> Delete <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nxt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ops <span class="main">⇒</span> <span class="tfree">'a</span> rbt2 <span class="main">⇒</span> <span class="tfree">'a</span> rbt2"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">nxt</span> <span class="main">(</span>Insert <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> insert3_d <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">nxt</span> <span class="main">(</span>Delete <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> delete2 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">t<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ops <span class="main">⇒</span> <span class="tfree">'a</span> rbt2 <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">t<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span>Insert <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> T_insert3_d <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">t<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">(</span>Delete <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> T_delete2 <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> RBTid2_Amor<span class="main">:</span> Amortized
<span class="keyword2"><span class="keyword">where</span></span> init <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Leaf<span class="main">,</span><span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> nxt <span class="main">=</span> <span class="quoted">nxt</span>
<span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">n</span><span class="main">,</span><span class="bound">dl</span><span class="main">)</span><span class="main">.</span> <span class="bound">n</span> <span class="main">=</span> size <span class="bound">t</span> <span class="main">∧</span>
  <span class="free">bal_i</span> <span class="main">(</span>size <span class="bound">t</span><span class="main">+</span><span class="bound">dl</span><span class="main">)</span> <span class="main">(</span>height <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> bal_d <span class="main">(</span>size <span class="bound">t</span><span class="main">)</span> <span class="bound">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> T <span class="main">=</span> <span class="quoted">t<span class="hidden">⇩</span><sub>s</sub></span> <span class="keyword2"><span class="keyword">and</span></span> Φ <span class="main">=</span> <span class="quoted">Φ<span class="hidden">⇩</span><sub>d</sub></span>
<span class="keyword2"><span class="keyword">and</span></span> U <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">f</span> <span class="keyword1">of</span>
  Insert <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">+</span><span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>height <span class="bound">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">|</span>
  Delete <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span><span class="numeral">6</span><span class="main">*</span><span class="free">e</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">*</span> height <span class="bound">t</span> <span class="main">+</span> <span class="numeral">4</span><span class="main">/</span>cd <span class="main">+</span> <span class="numeral">4</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> bal_i0 bal_d0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">dl</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">n</span><span class="main">,</span><span class="skolem">dl</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod_cases3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Insert <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 insert2_insert_d<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">dl</span></span><span class="main">]</span> bal_i_insert_d<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">dl</span></span><span class="main">]</span>
        mono_bal_d<span class="main">[</span><span class="operator">OF</span> _ size_insert_d<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> insert2_d.simps insert3_d_def2 insert_d.simps
               <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert3_insert2_d <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
         <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Delete <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 bal_i_delete<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">dl</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> bal_d_delete<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">dl</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> delete2_delete<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Φ_nn<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">s</span>"</span></span> <span class="main">]</span> cd0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">s</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">dl</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">n</span><span class="main">,</span><span class="skolem">dl</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod_cases3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Insert <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 5 insert2_insert_d<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">dl</span></span><span class="main">]</span> tinsert_d_amor<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">dl</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> insert2_d.simps insert3_d_def2 insert.simps
               <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert3_insert2_d Φ<span class="hidden">⇩</span><sub>d</sub>_case <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Delete <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 5 delete2_delete<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">dl</span></span><span class="main">]</span> T_delete_amor<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">dl</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* RBTid2 *)</span>

<span class="keyword1"><span class="command">axiomatization</span></span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">where</span></span>
b0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">axiomatization</span></span> <span class="keyword2"><span class="keyword">where</span></span>
cd_le_log<span class="main">:</span> <span class="quoted"><span class="quoted">"cd <span class="main">≤</span> <span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span>b<span class="main">/</span>c<span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹This axiom is only used to prove that the height remains logarithmic
in the size.›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> I_RBTid2<span class="main">:</span> RBTid2
<span class="keyword2"><span class="keyword">where</span></span> bal_i <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span> <span class="bound">h</span><span class="main">.</span> <span class="bound">h</span> <span class="main">≤</span> ceiling<span class="main">(</span>c <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> e <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span>c<span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">-</span> <span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span>c<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">..</span></span>
<span class="comment1">(* For code generation:
defines insert_id2 = I_RBTid2.insert3_d
and ins3_id2 = I_RBTid2.ins3
and up3_id2 = I_RBTid2.up3
*)</span>

<span class="comment1">(* Code Generation *)</span>
<span class="comment1">(*
(* FIXME why not done in Code_Float? *)
lemmas [code del] = real_less_code real_less_eq_code real_floor_code

lemma [code]: "bal_i n h = (h ≤ ceiling(c * log (real_of_integer 2) (n+1)))"
  by (simp add: bal_i_def real_of_integer_def)

lemma myc[code_unfold]: "c = real_of_integer 3 / real_of_integer 2"
sorry

definition "floor_integer (x::real) = integer_of_int (floor x)"

code_printing
  constant "floor_integer :: real ⇒ integer" ⇀
    (SML) "Real.floor"

lemma [code]: "(floor::real ⇒ int) = (λx. int_of_integer (floor_integer x))"
  by (auto simp: floor_integer_def)

definition "ceiling_integer (x::real) = integer_of_int (ceiling x)"

code_printing
  constant "ceiling_integer :: real ⇒ integer" ⇀
    (SML) "Real.ceil"

code_printing
  constant "0 :: real" ⇀ (SML) "0.0"
code_printing
  constant "1 :: real" ⇀ (SML) "1.0"

lemma [code_unfold del]: "0 ≡ real_of_rat 0"
  by simp
lemma [code_unfold del]: "1 ≡ real_of_rat 1"
  by simp

lemma [code_abbrev]: "real_of_integer (integer_of_nat x) = real x"
  sorry

lemma [code_abbrev]: "(λx. int_of_integer (ceiling_integer x)) = (ceiling::real ⇒ int)"
  by (auto simp: ceiling_integer_def)

print_codeproc

export_code insert_id2 in SML
module_name Root_Balanced
*)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Finally we show that under the above interpretation of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>bal_i›</span></span></span></span>
the height is logarithmic:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bal_i</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bal_i</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">≤</span> ceiling<span class="main">(</span>c <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bal_i <span class="main">(</span>size <span class="free">t</span> <span class="main">+</span> <span class="free">dl</span><span class="main">)</span> <span class="main">(</span>height <span class="free">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"bal_d <span class="main">(</span>size <span class="free">t</span><span class="main">)</span> <span class="free">dl</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"height <span class="free">t</span> <span class="main">≤</span> ceiling<span class="main">(</span>c <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span> <span class="main">+</span> b<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> real <span class="main">(</span>size <span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> cd <span class="main">*</span> real <span class="main">(</span>size <span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cd0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_pos_pos<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span>b <span class="main">/</span> c<span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> b0 c1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_powr_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> real <span class="main">(</span>size <span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span>b <span class="main">/</span> c<span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> real <span class="main">(</span>size <span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_pos_pos<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"height <span class="free">t</span> <span class="main">≤</span> ceiling<span class="main">(</span>c <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">t</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="free">dl</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bal_i_def add_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> ceiling<span class="main">(</span>c <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">t</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> cd <span class="main">*</span> <span class="main">(</span>size <span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c1 cd0 assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ceiling_mono add_pos_nonneg bal_d_def add_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> ceiling<span class="main">(</span>c <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size <span class="free">t</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span>b<span class="main">/</span>c<span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>size <span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * ** cd_le_log c1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ceiling_mono mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ceiling<span class="main">(</span>c <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span><span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span>b<span class="main">/</span>c<span class="main">)</span> <span class="main">*</span> <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">algebra_simps</span></span> size1_size<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ceiling<span class="main">(</span>c <span class="main">*</span> <span class="main">(</span>b<span class="main">/</span>c <span class="main">+</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> log_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ceiling<span class="main">(</span>c <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>size1 <span class="free">t</span><span class="main">)</span> <span class="main">+</span> b<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Root_Balanced_Tree_Tab">
<div class="head">
<h1>Theory Root_Balanced_Tree_Tab</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Tabulating the Balanced Predicate"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Root_Balanced_Tree_Tab
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Root_Balanced_Tree.html">Root_Balanced_Tree</a>
  <span class="quoted">"<a href="../../HOL/HOL-Decision_Procs/Approximation.html">HOL-Decision_Procs.Approximation</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/IArray.html">HOL-Library.IArray</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> Min_tab <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">tab</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> mono_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">n'</span> <span class="main">⟹</span> <span class="free">p</span> <span class="free">n</span> <span class="free">h</span> <span class="main">⟹</span> <span class="free">p</span> <span class="free">n'</span> <span class="free">h</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">p</span> <span class="bound">n</span> <span class="free">h</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> tab_LEAST<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">&lt;</span> length <span class="free">tab</span> <span class="main">⟹</span> <span class="free">tab</span><span class="main">!</span><span class="free">h</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="free">p</span> <span class="bound">n</span> <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tab_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">&lt;</span> length <span class="free">tab</span> <span class="main">⟹</span> <span class="free">p</span> <span class="free">n</span> <span class="free">h</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span> <span class="main">≥</span> <span class="free">tab</span> <span class="main">!</span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">using</span></span> not_le_imp_less not_less_Least tab_LEAST <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeastI mono_p p tab_LEAST<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bal_tab</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bal_tab</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="numeral">2</span><span class="main">,</span> <span class="numeral">4</span><span class="main">,</span> <span class="numeral">6</span><span class="main">,</span> <span class="numeral">10</span><span class="main">,</span> <span class="numeral">16</span><span class="main">,</span> <span class="numeral">25</span><span class="main">,</span> <span class="numeral">40</span><span class="main">,</span> <span class="numeral">64</span><span class="main">,</span> <span class="numeral">101</span><span class="main">,</span> <span class="numeral">161</span><span class="main">,</span> <span class="numeral">256</span><span class="main">,</span> <span class="numeral">406</span><span class="main">,</span> <span class="numeral">645</span><span class="main">,</span> <span class="numeral">1024</span><span class="main">,</span>
  <span class="numeral">1625</span><span class="main">,</span> <span class="numeral">2580</span><span class="main">,</span> <span class="numeral">4096</span><span class="main">,</span> <span class="numeral">6501</span><span class="main">,</span> <span class="numeral">10321</span><span class="main">,</span> <span class="numeral">16384</span><span class="main">,</span> <span class="numeral">26007</span><span class="main">,</span> <span class="numeral">41285</span><span class="main">,</span> <span class="numeral">65536</span><span class="main">,</span> <span class="numeral">104031</span><span class="main">,</span> <span class="numeral">165140</span><span class="main">,</span>
  <span class="numeral">262144</span><span class="main">,</span> <span class="numeral">416127</span><span class="main">,</span> <span class="numeral">660561</span><span class="main">,</span> <span class="numeral">1048576</span><span class="main">,</span> <span class="numeral">1664510</span><span class="main">,</span> <span class="numeral">2642245</span><span class="main">,</span> <span class="numeral">4194304</span><span class="main">,</span> <span class="numeral">6658042</span><span class="main">,</span> <span class="numeral">10568983</span><span class="main">,</span>
  <span class="numeral">16777216</span><span class="main">,</span> <span class="numeral">26632170</span><span class="main">,</span> <span class="numeral">42275935</span><span class="main">,</span> <span class="numeral">67108864</span><span class="main">,</span> <span class="numeral">106528681</span><span class="main">,</span> <span class="numeral">169103740</span><span class="main">,</span> <span class="numeral">268435456</span><span class="main">,</span>
  <span class="numeral">426114725</span><span class="main">,</span> <span class="numeral">676414963</span><span class="main">,</span> <span class="numeral">1073741824</span><span class="main">,</span> <span class="numeral">1704458900</span><span class="main">,</span> <span class="numeral">2705659852</span><span class="main">,</span> <span class="numeral">4294967296</span><span class="comment1">⌦‹,
  6817835603›</span><span class="main">]</span>"</span></span>
<span class="comment1">(*ML‹floor (Math.pow(2.0,5.0/1.5))›*)</span>

<span class="keyword1"><span class="command">axiomatization</span></span> <span class="keyword2"><span class="keyword">where</span></span> c_def<span class="main">:</span> <span class="quoted"><span class="quoted">"c <span class="main">=</span> <span class="numeral">3</span><span class="main">/</span><span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_floor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">is_floor</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">m</span> <span class="main">=</span> floor<span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">::</span>real<span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">(</span>real<span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">/</span>c<span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≤</span> <span class="bound">m</span> <span class="main">∧</span> <span class="bound">m</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Note that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">n</span></span> <span class="main"><span class="main">≤</span></span> <span class="free"><span class="free">m</span></span> <span class="main"><span class="main">∧</span></span> <span class="free"><span class="free">m</span></span> <span class="main"><span class="main">≤</span></span> <span class="free"><span class="free">n</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> avoids the technical restriction of the
<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>approximation›</span></span></span></span> method which does not support <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>=›</span></span></span></span>, even on integers.›</span></span>


<span class="keyword1"><span class="command">lemma</span></span> bal_tab_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length bal_tab<span class="main">.</span> is_floor <span class="main">(</span>bal_tab<span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="bound">i</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bal_tab_def c_def All_less_Suc<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">approximation</span> 50<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* FIXME mv *)</span>
<span class="keyword1"><span class="command">lemma</span></span> ceiling_least_real<span class="main">:</span> <span class="quoted"><span class="quoted">"ceiling<span class="main">(</span><span class="free">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="free">r</span> <span class="main">≤</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Least_equality ceiling_le le_of_int_ceiling<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> floor_greatest_real<span class="main">:</span> <span class="quoted"><span class="quoted">"floor<span class="main">(</span><span class="free">r</span><span class="main">::</span>real<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Greatest_equality le_floor_iff of_int_floor_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LEAST_eq_floor<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> int <span class="free">h</span> <span class="main">≤</span> <span class="main">⌈</span>c <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>real <span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> floor<span class="main">(</span><span class="main">(</span><span class="numeral">2</span><span class="main">::</span>real<span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">(</span>real<span class="main">(</span><span class="free">h</span><span class="main">)</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">/</span>c<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="free">h</span> <span class="main">≤</span> <span class="main">⌈</span>c <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">⌉</span>
      <span class="main">⟷</span> <span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">(</span>real<span class="main">(</span><span class="free">h</span><span class="main">)</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">/</span>c<span class="main">)</span> <span class="main">&lt;</span> real<span class="main">(</span><span class="skolem">n</span><span class="main">)</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="free">h</span> <span class="main">&lt;</span> c <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span>real <span class="free">h</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">/</span>c <span class="main">&lt;</span> log <span class="numeral">2</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">(</span>real <span class="free">h</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">/</span>c<span class="main">)</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span>log <span class="numeral">2</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> powr_log_cancel<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">::</span>nat<span class="main">.</span> <span class="skolem">r</span> <span class="main">&lt;</span> <span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> nat<span class="main">(</span>floor <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">r</span> <span class="main">::</span> <span class="quoted">real</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> Least_equality<span class="main">)</span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Min_tab
<span class="keyword2"><span class="keyword">where</span></span> p <span class="main">=</span> <span class="quoted">bal_i</span> <span class="keyword2"><span class="keyword">and</span></span> tab <span class="main">=</span> <span class="quoted">bal_tab</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold</span> bal_i_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span> <span class="skolem">n'</span> <span class="skolem">h</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="skolem">h</span> <span class="main">≤</span> ceiling<span class="main">(</span>c <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>real <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> 1<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> bal_i_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> ceiling<span class="main">(</span>c <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>real <span class="skolem">n'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> c1 <span class="quoted">"1"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ceiling_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">h</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"int <span class="skolem">h</span> <span class="main">≤</span> <span class="main">⌈</span>c <span class="main">*</span> log <span class="numeral">2</span> <span class="main">(</span>real <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="skolem">h</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">⌉</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> of_nat_diff log_nat_power<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> c1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ceiling_mono ceiling_of_nat order.order_iff_strict mult.left_neutral mult_eq_0_iff of_nat_0_le_iff mult_le_cancel_iff1<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> bal_tab_correct LEAST_eq_floor
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> nat_int<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Now we replace the list by an immutable array:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bal_array</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat iarray"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bal_array</span> <span class="main">=</span> IArray bal_tab"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A trick for code generation: how to get rid of the precondition:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bal_i_code<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bal_i <span class="free">n</span> <span class="free">h</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free">h</span> <span class="main">&lt;</span> IArray.length bal_array <span class="keyword1">then</span> IArray.sub bal_array <span class="free">h</span> <span class="main">≤</span> <span class="free">n</span> <span class="keyword1">else</span> bal_i <span class="free">n</span> <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bal_array_def tab_correct<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>