<div id="Efficient_Discrete_Sqrt">
<div class="head">
<h1>Theory Efficient_Discrete_Sqrt</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:    Efficient_Discrete_Sqrt.thy
  Author:  Markus Großer, Manuel Eberl

  A reasonably efficient algorithm to compute the square root of a natural number (rounded down)
  and to test if a natural number is a perfect square.
*)</span>
<span class="keyword1"><span class="command">theory</span></span> Efficient_Discrete_Sqrt
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a>
  <span class="quoted">"<a href="../../HOL/HOL-Computational_Algebra/Computational_Algebra.html">HOL-Computational_Algebra.Computational_Algebra</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Discrete.html">HOL-Library.Discrete</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Tree.html">HOL-Library.Tree</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/IArray.html">HOL-Library.IArray</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Efficient Algorithms for the Square Root on <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ℕ›</span></span></span></span>›</span></span>

<span class="comment1">(*
  TODO: This could perhaps be moved somewhere else. Thre is also probably some overlap
  with Sqrt_Babylonian
*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A Discrete Variant of Heron's Algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  An algorithm for calculating the discrete square root, taken from 
  Cohen~\cite{cohen2010algebraic}. This algorithm is essentially a discretised variant of
  Heron's method or Newton's method specialised to the square root function.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sqrt_eq_floor_sqrt<span class="main">:</span> <span class="quoted"><span class="quoted">"Discrete.sqrt <span class="free">n</span> <span class="main">=</span> nat <span class="main">⌊</span>sqrt <span class="free">n</span><span class="main">⌋</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="main">(</span>nat <span class="main">⌊</span>sqrt <span class="free">n</span><span class="main">⌋</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>real <span class="main">(</span>nat <span class="main">⌊</span>sqrt <span class="free">n</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> sqrt <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> real <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⌊</span>sqrt <span class="free">n</span><span class="main">⌋</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> of_nat_le_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="main">(</span>Suc <span class="main">(</span>nat <span class="main">⌊</span>sqrt <span class="free">n</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">⌊</span>sqrt <span class="free">n</span><span class="main">⌋</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">&gt;</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> floor_correct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"sqrt <span class="free">n</span>"</span></span><span class="main">]</span> real_le_rsqrt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="main">⌊</span>sqrt <span class="free">n</span><span class="main">⌋</span>"</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
        of_int_less_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">⌊</span>sqrt <span class="free">n</span><span class="main">⌋</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span><span class="main">]</span> not_le
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> le_nat_floor<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>nat <span class="main">⌊</span>sqrt <span class="free">n</span><span class="main">⌋</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sqrt <span class="free">n</span>"</span></span><span class="main">]</span>
        of_nat_le_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="main">(</span>nat <span class="main">⌊</span>sqrt <span class="free">n</span><span class="main">⌋</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> real_le_rsqrt<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> not_le
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sqrt_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">newton_sqrt_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">newton_sqrt_aux</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">div</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>
      <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="free">newton_sqrt_aux</span> <span class="bound">y</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> newton_sqrt_aux.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> newton_sqrt_aux_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="main">⟹</span> newton_sqrt_aux <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> newton_sqrt_aux <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">≥</span> <span class="free">x</span> <span class="main">⟹</span> newton_sqrt_aux <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> newton_sqrt_aux.simps<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> heron_step_real<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">t</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">;</span> <span class="free">n</span> <span class="main">≥</span> <span class="main">0</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="free">n</span><span class="main">/</span><span class="free">t</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">≥</span> sqrt <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> arith_geo_mean_sqrt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">/</span><span class="free">t</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> heron_step_div_eq_floored<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="main">(</span><span class="free">n</span><span class="main">::</span>nat<span class="main">)</span> <span class="keyword1">div</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">=</span> nat <span class="main">⌊</span><span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="free">n</span><span class="main">/</span><span class="free">t</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌋</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌊</span><span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="free">n</span><span class="main">/</span><span class="free">t</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌋</span> <span class="main">=</span> <span class="main">⌊</span><span class="main">(</span><span class="free">t</span><span class="main">*</span><span class="free">t</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">t</span><span class="main">)</span><span class="main">⌋</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_divide_mult_cancel_right<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">+</span> <span class="free">n</span><span class="main">/</span><span class="free">t</span>"</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
        <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span><span class="main">*</span><span class="free">t</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> floor_divide_of_nat_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span><span class="main">*</span><span class="free">t</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">div</span> <span class="free">t</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Divides.div_mult2_eq mult.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">t</span>›</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> heron_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">≥</span> Discrete.sqrt <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Discrete.sqrt <span class="free">n</span> <span class="main">=</span> nat <span class="main">⌊</span>sqrt <span class="free">n</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sqrt_eq_floor_sqrt<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> nat <span class="main">⌊</span><span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="free">n</span><span class="main">/</span><span class="free">t</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌋</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> heron_step_real<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> heron_step_div_eq_floored<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> newton_sqrt_aux_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> Discrete.sqrt <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"newton_sqrt_aux <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> Discrete.sqrt <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> newton_sqrt_aux.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Discrete.sqrt <span class="skolem">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> div_le_mono<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">≥</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> newton_sqrt_aux_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"1.prems"</span> <span class="keyword1"><span class="command">have</span></span> x_gt_sqrt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> Discrete.sqrt <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Discrete.le_sqrt_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">x</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mult_div_mod_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="skolem">x</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Discrete.le_sqrt_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> x_gt_sqrt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> mult_less_cancel1<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step_decreasing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">&lt;</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">with</span></span> x_gt_sqrt <span class="keyword1"><span class="command">have</span></span> step_ge_sqrt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">≥</span> Discrete.sqrt <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> heron_step<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> step_decreasing <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"newton_sqrt_aux <span class="skolem">x</span> <span class="skolem">n</span> <span class="main">=</span> newton_sqrt_aux <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> newton_sqrt_aux_simps<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Discrete.sqrt <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="quoted">"1.IH"</span> step_decreasing step_ge_sqrt<span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">newton_sqrt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">newton_sqrt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> newton_sqrt_aux <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> Discrete.sqrt_code <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">theorem</span></span> Discrete_sqrt_eq_newton_sqrt <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Discrete.sqrt <span class="free">n</span> <span class="main">=</span> newton_sqrt <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> newton_sqrt_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> newton_sqrt_aux_correct Discrete.sqrt_le<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Square Testing›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Next, we implement an algorithm to determine whether a given natural number is a perfect square,
  as described by Cohen~\cite{cohen2010algebraic}. Essentially, the number first determines whether
  the number is a square. Essentially
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">q11</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">q11</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="numeral">3</span><span class="main">,</span> <span class="numeral">4</span><span class="main">,</span> <span class="numeral">5</span><span class="main">,</span> <span class="numeral">9</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">q63</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">q63</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="numeral">4</span><span class="main">,</span> <span class="numeral">7</span><span class="main">,</span> <span class="numeral">9</span><span class="main">,</span> <span class="numeral">16</span><span class="main">,</span> <span class="numeral">28</span><span class="main">,</span> <span class="numeral">18</span><span class="main">,</span> <span class="numeral">22</span><span class="main">,</span> <span class="numeral">25</span><span class="main">,</span> <span class="numeral">36</span><span class="main">,</span> <span class="numeral">58</span><span class="main">,</span> <span class="numeral">46</span><span class="main">,</span> <span class="numeral">49</span><span class="main">,</span> <span class="numeral">37</span><span class="main">,</span> <span class="numeral">43</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">q64</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">q64</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="numeral">4</span><span class="main">,</span> <span class="numeral">9</span><span class="main">,</span> <span class="numeral">16</span><span class="main">,</span> <span class="numeral">17</span><span class="main">,</span> <span class="numeral">25</span><span class="main">,</span> <span class="numeral">36</span><span class="main">,</span> <span class="numeral">33</span><span class="main">,</span> <span class="numeral">49</span><span class="main">,</span> <span class="numeral">41</span><span class="main">,</span> <span class="numeral">57</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">q65</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">q65</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="numeral">4</span><span class="main">,</span> <span class="numeral">10</span><span class="main">,</span> <span class="numeral">14</span><span class="main">,</span> <span class="numeral">9</span><span class="main">,</span> <span class="numeral">16</span><span class="main">,</span> <span class="numeral">26</span><span class="main">,</span> <span class="numeral">30</span><span class="main">,</span> <span class="numeral">25</span><span class="main">,</span> <span class="numeral">29</span><span class="main">,</span> <span class="numeral">40</span><span class="main">,</span> <span class="numeral">56</span><span class="main">,</span> <span class="numeral">36</span><span class="main">,</span> <span class="numeral">49</span><span class="main">,</span> <span class="numeral">61</span><span class="main">,</span> <span class="numeral">35</span><span class="main">,</span> <span class="numeral">51</span><span class="main">,</span> <span class="numeral">39</span><span class="main">,</span> <span class="numeral">55</span><span class="main">,</span> <span class="numeral">64</span><span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">q11_array</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">q11_array</span> <span class="main">=</span> IArray <span class="main">[</span>True<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>True<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>False<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">q63_array</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">q63_array</span> <span class="main">=</span> IArray <span class="main">[</span>True<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>
     False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>
     False<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>
     False<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>
     False<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">q64_array</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">q64_array</span> <span class="main">=</span> IArray <span class="main">[</span>True<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>
     False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>
     False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>
     False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>
     False<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span> False<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">q65_array</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">q65_array</span> <span class="main">=</span> IArray <span class="main">[</span>True<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>
     False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>True<span class="main">,</span>
     False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>
     False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>True
     <span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>False<span class="main">,</span>False<span class="main">,</span>True<span class="main">,</span>False<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sub_q11_array<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="numeral">11</span><span class="main">}</span> <span class="main">⟹</span> IArray.sub q11_array <span class="free">i</span> <span class="main">⟷</span> <span class="free">i</span> <span class="main">∈</span> q11"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lessThan_nat_numeral lessThan_Suc q11_def q11_array_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> disjE<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_q63_array<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="numeral">63</span><span class="main">}</span> <span class="main">⟹</span> IArray.sub q63_array <span class="free">i</span> <span class="main">⟷</span> <span class="free">i</span> <span class="main">∈</span> q63"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lessThan_nat_numeral lessThan_Suc q63_def q63_array_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> disjE<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_q64_array<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="numeral">64</span><span class="main">}</span> <span class="main">⟹</span> IArray.sub q64_array <span class="free">i</span> <span class="main">⟷</span> <span class="free">i</span> <span class="main">∈</span> q64"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lessThan_nat_numeral lessThan_Suc q64_def q64_array_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> disjE<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sub_q65_array<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="numeral">65</span><span class="main">}</span> <span class="main">⟹</span> IArray.sub q65_array <span class="free">i</span> <span class="main">⟷</span> <span class="free">i</span> <span class="main">∈</span> q65"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lessThan_nat_numeral lessThan_Suc q65_def q65_array_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> disjE<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> in_q11_code<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">mod</span> <span class="numeral">11</span> <span class="main">∈</span> q11 <span class="main">⟷</span> IArray.sub q11_array <span class="main">(</span><span class="free">x</span> <span class="keyword1">mod</span> <span class="numeral">11</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sub_q11_array<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> in_q63_code<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">mod</span> <span class="numeral">63</span> <span class="main">∈</span> q63 <span class="main">⟷</span> IArray.sub q63_array <span class="main">(</span><span class="free">x</span> <span class="keyword1">mod</span> <span class="numeral">63</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sub_q63_array<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> in_q64_code<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">mod</span> <span class="numeral">64</span> <span class="main">∈</span> q64 <span class="main">⟷</span> IArray.sub q64_array <span class="main">(</span><span class="free">x</span> <span class="keyword1">mod</span> <span class="numeral">64</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sub_q64_array<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> in_q65_code<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">mod</span> <span class="numeral">65</span> <span class="main">∈</span> q65 <span class="main">⟷</span> IArray.sub q65_array <span class="main">(</span><span class="free">x</span> <span class="keyword1">mod</span> <span class="numeral">65</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sub_q65_array<span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">square_test</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">square_test</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">mod</span> <span class="numeral">64</span> <span class="main">∈</span> q64 <span class="main">∧</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">r</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">mod</span> <span class="numeral">45045</span> <span class="keyword1">in</span>
      <span class="bound">r</span> <span class="keyword1">mod</span> <span class="numeral">63</span> <span class="main">∈</span> q63 <span class="main">∧</span> <span class="bound">r</span> <span class="keyword1">mod</span> <span class="numeral">65</span> <span class="main">∈</span> q65 <span class="main">∧</span> <span class="bound">r</span> <span class="keyword1">mod</span> <span class="numeral">11</span> <span class="main">∈</span> q11 <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span>Discrete.sqrt <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> square_test_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"square_test <span class="free">n</span> <span class="main">=</span>
    <span class="main">(</span>IArray.sub q64_array <span class="main">(</span><span class="free">n</span> <span class="keyword1">mod</span> <span class="numeral">64</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">r</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="numeral">45045</span> <span class="keyword1">in</span>
           IArray.sub q63_array <span class="main">(</span><span class="bound">r</span> <span class="keyword1">mod</span> <span class="numeral">63</span><span class="main">)</span> <span class="main">∧</span> 
           IArray.sub q65_array <span class="main">(</span><span class="bound">r</span> <span class="keyword1">mod</span> <span class="numeral">65</span><span class="main">)</span> <span class="main">∧</span>
           IArray.sub q11_array <span class="main">(</span><span class="bound">r</span> <span class="keyword1">mod</span> <span class="numeral">11</span><span class="main">)</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span>Discrete.sqrt <span class="free">n</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_q11_code <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> in_q63_code <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 
          in_q64_code <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> in_q65_code <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def square_test_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> square_mod_lower<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">q</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">::</span> nat<span class="main">)</span> <span class="keyword1">mod</span> <span class="free">m</span> <span class="main">=</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound"><span class="bound">q'</span></span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">.</span> <span class="bound">q'</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="free">m</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mod_less_divisor mod_mod_trivial power_mod <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> q11_upto_def<span class="main">:</span> <span class="quoted"><span class="quoted">"q11 <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="numeral">11</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="numeral">11</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> q11_def lessThan_nat_numeral lessThan_Suc insert_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> q11_infinite_def<span class="main">:</span> <span class="quoted"><span class="quoted">"q11 <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="numeral">11</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> q11_upto_def image_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xa</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> square_mod_lower<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">11</span></span> <span class="quoted"><span class="skolem">xa</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="numeral">11</span>"</span></span><span class="main">]</span>
      ex_nat_less_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">11</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">xa</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="numeral">11</span> <span class="main">=</span> <span class="bound">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="numeral">11</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> q63_upto_def<span class="main">:</span> <span class="quoted"><span class="quoted">"q63 <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="numeral">63</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="numeral">63</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> q63_def lessThan_nat_numeral lessThan_Suc insert_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> q63_infinite_def<span class="main">:</span> <span class="quoted"><span class="quoted">"q63 <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="numeral">63</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> q63_upto_def image_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xa</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> square_mod_lower<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">63</span></span> <span class="quoted"><span class="skolem">xa</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="numeral">63</span>"</span></span><span class="main">]</span>
      ex_nat_less_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">63</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">xa</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="numeral">63</span> <span class="main">=</span> <span class="bound">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="numeral">63</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> q64_upto_def<span class="main">:</span> <span class="quoted"><span class="quoted">"q64 <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="numeral">64</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="numeral">64</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> q64_def lessThan_nat_numeral lessThan_Suc insert_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> q64_infinite_def<span class="main">:</span> <span class="quoted"><span class="quoted">"q64 <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="numeral">64</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> q64_upto_def image_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xa</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> square_mod_lower<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">64</span></span> <span class="quoted"><span class="skolem">xa</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="numeral">64</span>"</span></span><span class="main">]</span>
      ex_nat_less_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">64</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">xa</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="numeral">64</span> <span class="main">=</span> <span class="bound">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="numeral">64</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> q65_upto_def<span class="main">:</span> <span class="quoted"><span class="quoted">"q65 <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="numeral">65</span><span class="main">)</span> <span class="main">`</span> <span class="main">{..&lt;</span><span class="numeral">65</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> q65_def lessThan_nat_numeral lessThan_Suc insert_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> q65_infinite_def<span class="main">:</span> <span class="quoted"><span class="quoted">"q65 <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="numeral">65</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> q65_upto_def image_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xa</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> square_mod_lower<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">65</span></span> <span class="quoted"><span class="skolem">xa</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="numeral">65</span>"</span></span><span class="main">]</span>
      ex_nat_less_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">65</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">xa</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="numeral">65</span> <span class="main">=</span> <span class="bound">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="numeral">65</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> square_mod_existence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="free">k</span> <span class="main">=</span> <span class="bound">q</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">mod</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> square_test_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"square_test <span class="free">n</span> <span class="main">⟷</span> is_square <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"is_square <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span>  rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> is_nth_powerE<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> sq_mod <span class="main">=</span> square_mod_existence<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> q64_member<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">mod</span> <span class="numeral">64</span> <span class="main">∈</span> q64"</span></span> <span class="keyword1"><span class="command">using</span></span> sq_mod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">64</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> q64_infinite_def image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">mod</span> <span class="numeral">45045</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">11</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">45045</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">63</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">45045</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">65</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="numeral">45045</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mod_45045<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="keyword1">mod</span> <span class="numeral">11</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="numeral">11</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="keyword1">mod</span> <span class="numeral">63</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="numeral">63</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="keyword1">mod</span> <span class="numeral">65</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="numeral">65</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mod_mod_cancel<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="numeral">45045</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="keyword1">mod</span> <span class="numeral">11</span> <span class="main">∈</span> q11"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="keyword1">mod</span> <span class="numeral">63</span> <span class="main">∈</span> q63"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="keyword1">mod</span> <span class="numeral">65</span> <span class="main">∈</span> q65"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sq_mod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">11</span></span><span class="main">]</span> sq_mod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">63</span></span><span class="main">]</span> sq_mod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">65</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> q11_infinite_def q63_infinite_def q65_infinite_def image_def mod_45045
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> square_test_def Let_def <span class="keyword1"><span class="command">using</span></span> q64_member rhs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> not_rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_square <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Discrete.sqrt <span class="free">n</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≠</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> square_test_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_nth_power_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_nat_sqrt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat option"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">get_nat_sqrt</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> is_square <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> Some <span class="main">(</span>Discrete.sqrt <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> get_nat_sqrt_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"get_nat_sqrt <span class="free">n</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">if</span> IArray.sub q64_array <span class="main">(</span><span class="free">n</span> <span class="keyword1">mod</span> <span class="numeral">64</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">r</span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="numeral">45045</span> <span class="keyword1">in</span>
           IArray.sub q63_array <span class="main">(</span><span class="bound">r</span> <span class="keyword1">mod</span> <span class="numeral">63</span><span class="main">)</span> <span class="main">∧</span> 
           IArray.sub q65_array <span class="main">(</span><span class="bound">r</span> <span class="keyword1">mod</span> <span class="numeral">65</span><span class="main">)</span> <span class="main">∧</span>
           IArray.sub q11_array <span class="main">(</span><span class="bound">r</span> <span class="keyword1">mod</span> <span class="numeral">11</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
       <span class="main">(</span><span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> Discrete.sqrt <span class="free">n</span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="free">n</span> <span class="keyword1">then</span> Some <span class="bound">x</span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> get_nat_sqrt_def square_test_correct <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> square_test_def
  <span class="keyword1"><span class="command">using</span></span> in_q11_code <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> in_q63_code <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 
        in_q64_code <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> in_q65_code <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Pell">
<div class="head">
<h1>Theory Pell</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Pell.thy
  Author:   Manuel Eberl, TU München

  Basic facts about the solutions of Pell's equation
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Pell's equation›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Pell
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a>
  <span class="quoted">"<a href="../../HOL/HOL-Computational_Algebra/Computational_Algebra.html">HOL-Computational_Algebra.Computational_Algebra</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Pell's equation has the general form $x^2 = 1 + D y^2$ where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>D ∈ ℕ›</span></span></span></span> is a parameter
  and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>y›</span></span></span></span> are <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ℤ›</span></span></span></span>-valued variables. As we will see, that case where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>D›</span></span></span></span> is a
  perfect square is trivial and therefore uninteresting; we will therefore assume that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>D›</span></span></span></span> is
  not a perfect square for the most part.

  Furthermore, it is obvious that the solutions to Pell's equation are symmetric around the
  origin in the sense that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(x, y)›</span></span></span></span> is a solution iff <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(±x, ±y)›</span></span></span></span> is a solution. We will
  therefore mostly look at solutions <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(x, y)›</span></span></span></span> where both <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>y›</span></span></span></span> are non-negative, since
  the remaining solutions are a trivial consequence of these.

  Information on the material treated in this formalisation can be found in many textbooks and
   lecture notes, e.\,g.\ \cite{jacobson2008solving, auckland_pell}.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminary facts›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gcd_int_nonpos_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"gcd <span class="free">x</span> <span class="main">(</span><span class="free">y</span> <span class="main">::</span> int<span class="main">)</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"gcd <span class="free">x</span> <span class="free">y</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> gcd_ge_0_int<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> minus_in_Ints_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">x</span> <span class="main">∈</span> <span class="main">ℤ</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">ℤ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Ints_minus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> Ints_minus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">x</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A (positive) square root of a natural number is either a natural number or irrational.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> nonneg_sqrt_nat_or_irrat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span> real <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">ℕ</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∉</span> <span class="main">ℚ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="main">ℕ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">ℚ</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> Rats_abs_nat_div_natE<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> q_nz <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"abs <span class="free">x</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">/</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> coprime<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">p</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">/</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="skolem">q</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> real <span class="free">a</span> <span class="main">=</span> real <span class="main">(</span><span class="skolem">p</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="skolem">q</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> real <span class="free">a</span> <span class="main">=</span> real <span class="main">(</span><span class="skolem">q</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span> <span class="skolem">q</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> of_nat_eq_iff<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">^</span> <span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="skolem">p</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> coprime <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> x <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∉</span> <span class="main">ℕ</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A square root of a natural number is either an integer or irrational.
›</span></span>
<span class="keyword1"><span class="command">corollary</span></span> sqrt_nat_or_irrat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span> real <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">ℤ</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">∉</span> <span class="main">ℚ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> nonneg_sqrt_nat_or_irrat<span class="main">[</span><span class="operator">OF</span> assms this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Nats_altdef2<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="free">x</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span> real <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">x</span> <span class="main">∈</span> <span class="main">ℕ</span> <span class="main">∨</span> <span class="main">-</span><span class="free">x</span> <span class="main">∉</span> <span class="main">ℚ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nonneg_sqrt_nat_or_irrat<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Nats_altdef2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> sqrt_nat_or_irrat'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sqrt <span class="main">(</span>real <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> <span class="main">ℕ</span> <span class="main">∨</span> sqrt <span class="main">(</span>real <span class="free">a</span><span class="main">)</span> <span class="main">∉</span> <span class="main">ℚ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nonneg_sqrt_nat_or_irrat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"sqrt <span class="free">a</span>"</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The square root of a natural number <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n›</span></span></span></span> is again a natural number iff <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>n is a perfect square.›</span></span></span></span>
›</span></span>
<span class="keyword1"><span class="command">corollary</span></span> sqrt_nat_iff_is_square<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sqrt <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> <span class="main">ℕ</span> <span class="main">⟷</span> is_square <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sqrt <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> <span class="main">ℕ</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"sqrt <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">=</span> real <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Nats_cases<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sqrt <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span> real <span class="main">(</span><span class="skolem">k</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> of_nat_power<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sqrt <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span> real <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> of_nat_eq_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_square <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_nth_powerE<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> irrat_sqrt_nonsquare<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_square <span class="free">n</span> <span class="main">⟹</span> sqrt <span class="main">(</span>real <span class="free">n</span><span class="main">)</span> <span class="main">∉</span> <span class="main">ℚ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sqrt_nat_or_irrat'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sqrt_nat_iff_is_square<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The case of a perfect square›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  As we have noted, the case where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>D›</span></span></span></span> is a perfect square is trivial: In fact, we will
  show that the only solutions in this case are the trivial solutions <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(x, y) = (±1, 0)›</span></span></span></span> if
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>D›</span></span></span></span> is a non-zero perfect square, or <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(±1, y)›</span></span></span></span> for arbitrary <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>y ∈ ℤ›</span></span></span></span> if <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>D = 0›</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">D</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> square_D<span class="main">:</span> <span class="quoted"><span class="quoted">"is_square <span class="free">D</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pell_square_solution_nat_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">D</span> <span class="main">*</span> <span class="free">y</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> x_nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Nat.gr0I<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> square_D <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> <span class="skolem">d</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> is_nth_powerE<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="free">x</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span> int <span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">D</span> <span class="main">*</span> <span class="free">y</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> int <span class="free">D</span> <span class="main">*</span> int <span class="free">y</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>int <span class="free">x</span> <span class="main">+</span> int <span class="skolem">d</span> <span class="main">*</span> int <span class="free">y</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>int <span class="free">x</span> <span class="main">-</span> int <span class="skolem">d</span> <span class="main">*</span> int <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"int <span class="free">x</span> <span class="main">+</span> int <span class="skolem">d</span> <span class="main">*</span> int <span class="free">y</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> int <span class="free">x</span> <span class="main">-</span> int <span class="skolem">d</span> <span class="main">*</span> int <span class="free">y</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x_nz <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> pos_zmult_eq_1_iff<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_pos_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> * <span class="keyword2"><span class="keyword">and</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pell_square_solution_int_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">D</span> <span class="main">*</span> <span class="free">y</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> nat <span class="main">¦</span><span class="free">x</span><span class="main">¦</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">=</span> nat <span class="main">¦</span><span class="free">y</span><span class="main">¦</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> sgn <span class="free">x</span> <span class="main">*</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> sgn <span class="free">y</span> <span class="main">*</span> <span class="skolem">y'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sgn_if x'_def y'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> zero_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="skolem">x'</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="skolem">y'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> x'_def y'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span> int <span class="main">(</span><span class="skolem">x'</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> x<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sgn_if zero_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">D</span> <span class="main">*</span> <span class="free">y</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span> int <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">D</span> <span class="main">*</span> <span class="skolem">y'</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> y<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sgn_if zero_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> of_nat_eq_iff
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">D</span> <span class="main">*</span> <span class="skolem">y'</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">D</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pell_square_solution_nat_aux<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> x'_def y'_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pell_square_solution_nat_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">D</span> <span class="main">*</span> <span class="free">y</span> <span class="main">^</span> <span class="numeral">2</span>  <span class="main">⟷</span>  <span class="free">x</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">(</span><span class="free">D</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pell_square_solution_nat_aux<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_square_solution_int_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">D</span> <span class="main">*</span> <span class="free">y</span> <span class="main">^</span> <span class="numeral">2</span>  <span class="main">⟷</span>  <span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span> <span class="main">∧</span> <span class="main">(</span><span class="free">D</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pell_square_solution_int_aux<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power2_eq_1_iff<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Existence of a non-trivial solution›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Let us now turn to the case where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>D›</span></span></span></span> is not a perfect square.

  We first show that Pell's equation always has at least one non-trivial solution (apart
  from the trivial solution <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(1, 0)›</span></span></span></span>). For this, we first need a lemma about the existence
  of rational approximations of real numbers.

  The following lemma states that for any positive integer <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s›</span></span></span></span> and real number <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span>, we can find a
  rational approximation <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t / u›</span></span></span></span> to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> with an error of most <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>1 / (u * s)›</span></span></span></span> where the denominator
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u›</span></span></span></span> is at most <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s›</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> pell_approximation_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span><span class="main">::</span>nat<span class="main">.</span> <span class="main">∃</span><span class="bound">t</span><span class="main">::</span>int<span class="main">.</span> <span class="bound">u</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> coprime <span class="bound">u</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">1</span> <span class="main">/</span> <span class="free">s</span> <span class="main">∈</span> <span class="main">{</span><span class="main">¦</span><span class="bound">t</span> <span class="main">-</span> <span class="bound">u</span> <span class="main">*</span> <span class="free">x</span><span class="main">¦</span><span class="main">&lt;..</span><span class="main">1</span> <span class="main">/</span> <span class="bound">u</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> <span class="main">⌈</span><span class="bound">u</span> <span class="main">*</span> <span class="free">x</span><span class="main">⌉</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> <span class="main">⌊</span>frac <span class="main">(</span><span class="bound">u</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> <span class="free">s</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword3"><span class="command">assume</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"frac <span class="main">(</span><span class="skolem">u</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> real <span class="free">s</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">*</span> real <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_strict_right_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> frac_lt_1<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">u</span> <span class="main">&lt;</span> int <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> floor_less_iff g_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">`</span> <span class="main">{..</span><span class="free">s</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">s</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g_def floor_less_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">g</span> <span class="main">`</span> <span class="main">{..</span><span class="free">s</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>int <span class="free">s</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> card_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> card <span class="main">{..</span><span class="free">s</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>inj_on <span class="skolem">g</span> <span class="main">{..</span><span class="free">s</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pigeonhole<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≤</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≤</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">g</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">u1</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">u2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u1</span> <span class="main">=</span> max <span class="skolem">a</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u2</span> <span class="main">=</span> min <span class="skolem">a</span> <span class="skolem">b</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> u12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u1</span> <span class="main">≤</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u2</span> <span class="main">≤</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u2</span> <span class="main">&lt;</span> <span class="skolem">u1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">u1</span> <span class="main">=</span> <span class="skolem">g</span> <span class="skolem">u2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ab <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> u1_def u2_def<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="skolem">u1</span> <span class="main">-</span> <span class="skolem">u2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="main">⌊</span><span class="skolem">u1</span> <span class="main">*</span> <span class="free">x</span><span class="main">⌋</span> <span class="main">-</span> <span class="main">⌊</span><span class="skolem">u2</span> <span class="main">*</span> <span class="free">x</span><span class="main">⌋</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="skolem">u</span><span class="main">¦</span> <span class="main">≤</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> u12 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> u_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">g</span> <span class="skolem">u1</span> <span class="main">=</span> <span class="skolem">g</span> <span class="skolem">u2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>frac <span class="main">(</span><span class="skolem">u2</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> <span class="free">s</span> <span class="main">-</span> frac <span class="main">(</span><span class="skolem">u1</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> <span class="free">s</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>frac <span class="main">(</span><span class="skolem">u2</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> <span class="free">s</span> <span class="main">-</span> frac <span class="main">(</span><span class="skolem">u1</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> <span class="free">s</span><span class="main">¦</span> <span class="main">=</span>
               <span class="main">¦</span>real <span class="free">s</span><span class="main">¦</span> <span class="main">*</span> <span class="main">¦</span>frac <span class="main">(</span><span class="skolem">u2</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span> <span class="main">-</span> frac <span class="main">(</span><span class="skolem">u1</span> <span class="main">*</span> <span class="free">x</span><span class="main">)</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> abs_mult <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="skolem">t</span> <span class="main">-</span> <span class="skolem">u</span> <span class="main">*</span> <span class="free">x</span><span class="main">¦</span> <span class="main">*</span> <span class="free">s</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u1</span> <span class="main">&gt;</span> <span class="skolem">u2</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_def u_def t_def frac_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> of_nat_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="skolem">t</span> <span class="main">-</span> <span class="skolem">u</span> <span class="main">*</span> <span class="free">x</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">/</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> gcd <span class="main">(</span>nat <span class="main">¦</span><span class="skolem">t</span><span class="main">¦</span><span class="main">)</span> <span class="skolem">u</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span><span class="main">=</span> <span class="skolem">t</span> <span class="keyword1">div</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">=</span> <span class="skolem">u</span> <span class="keyword1">div</span> <span class="skolem">d</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> u <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="main">(</span>gcd <span class="main">(</span>nat <span class="main">¦</span><span class="skolem">t</span><span class="main">¦</span><span class="main">)</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">=</span> gcd <span class="main">¦</span><span class="skolem">t</span><span class="main">¦</span> <span class="main">(</span>int <span class="skolem">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> t'_u'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t'</span> <span class="main">*</span> <span class="skolem">d</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="skolem">u'</span> <span class="main">*</span> <span class="skolem">d</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t'_def u'_def d_def nat_dvd_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="skolem">t'</span> <span class="main">-</span> <span class="skolem">u'</span> <span class="main">*</span> <span class="free">x</span><span class="main">¦</span> <span class="main">*</span> <span class="main">1</span> <span class="main">≤</span> <span class="main">¦</span><span class="skolem">t'</span> <span class="main">-</span> <span class="skolem">u'</span> <span class="main">*</span> <span class="free">x</span><span class="main">¦</span> <span class="main">*</span> <span class="main">¦</span>real <span class="skolem">d</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_left_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">¦</span><span class="skolem">t</span> <span class="main">-</span> <span class="skolem">u</span> <span class="main">*</span> <span class="free">x</span><span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> abs_mult <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> t'_u'<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> less
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="skolem">t'</span> <span class="main">-</span> <span class="skolem">u'</span> <span class="main">*</span> <span class="free">x</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">/</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> u <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="free">s</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span> u_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="skolem">u'</span> <span class="main">/</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t'_u' <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> <span class="skolem">u'</span> <span class="main">/</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">d</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> divide_left_mono<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="free">s</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> <span class="skolem">u'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="free">s</span> <span class="main">∈</span> <span class="main">{</span><span class="main">¦</span><span class="skolem">t'</span> <span class="main">-</span> <span class="skolem">u'</span> <span class="main">*</span> <span class="free">x</span><span class="main">¦</span><span class="main">&lt;..</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">u'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t'_u'<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="skolem">u</span> <span class="skolem">t</span> <span class="main">=</span> gcd <span class="skolem">t'</span> <span class="skolem">u'</span> <span class="main">*</span> int <span class="skolem">d</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t'_u' gcd_mult_right gcd.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="skolem">d</span> <span class="main">=</span> gcd <span class="skolem">u</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d_def gcd.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="skolem">u'</span> <span class="skolem">t'</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> u <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gcd.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  As a simple corollary of this, we can show that for irrational <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span>, there is an infinite
  number of rational approximations <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t / u›</span></span></span></span> to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> whose error is less that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>1 / u<span class="hidden">⇧</span><sup>2</sup>›</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">corollary</span></span> pell_approximation_corollary<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="main">ℚ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="main">(</span><span class="bound">t</span> <span class="main">::</span> int<span class="main">,</span> <span class="bound">u</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">.</span> <span class="bound">u</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> coprime <span class="bound">u</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">¦</span><span class="bound">t</span> <span class="main">-</span> <span class="bound">u</span> <span class="main">*</span> <span class="free">x</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">u</span><span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"infinite <span class="var">?A</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="var">?A</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">t</span> <span class="main">::</span> int<span class="main">,</span> <span class="bound">u</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">.</span> <span class="main">¦</span><span class="bound">t</span> <span class="main">-</span> <span class="bound">u</span> <span class="main">*</span> <span class="free">x</span><span class="main">¦</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword1"><span class="command">have</span></span> fin'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>insert <span class="main">1</span> <span class="main">(</span><span class="var">?f</span> <span class="main">`</span> <span class="var">?A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span>insert <span class="main">1</span> <span class="main">(</span><span class="var">?f</span> <span class="main">`</span> <span class="var">?A</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> Min_gr_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted">int</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">b</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">/</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∉</span> <span class="main">ℚ</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Rats_eq_int_div_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>insert <span class="main">1</span> <span class="main">(</span><span class="var">?f</span> <span class="main">`</span> <span class="var">?A</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> fin'<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> real_arch_inverse
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"inverse <span class="skolem">M</span> <span class="main">&lt;</span> Min <span class="main">(</span>insert <span class="main">1</span> <span class="main">(</span><span class="var">?f</span> <span class="main">`</span> <span class="var">?A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> pell_approximation_lemma<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="main">::</span> <span class="quoted">int</span>
    <span class="keyword2"><span class="keyword">where</span></span> ut<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">u</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> real <span class="skolem">M</span> <span class="main">∈</span> <span class="main">{</span><span class="var">?f</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span><span class="main">&lt;..</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">u</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> ut <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">/</span> real <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> M <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span>  <span class="main">&lt;</span> Min <span class="main">(</span>insert <span class="main">1</span> <span class="main">(</span><span class="var">?f</span> <span class="main">`</span> <span class="var">?A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> ut <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span>insert <span class="main">1</span> <span class="main">(</span><span class="var">?f</span> <span class="main">`</span> <span class="var">?A</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?f</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Min.coboundedI fin'<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">locale</span></span> pell <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">D</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonsquare_D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_square <span class="free">D</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> D_gt_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> nonsquare_D <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Nat.gr0I<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> D_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nonsquare_D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Nat.gr0I<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  With the above corollary, we can show the existence of a non-trivial solution. We restrict our
  attention to solutions <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(x, y)›</span></span></span></span> where both <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>y›</span></span></span></span> are non-negative.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> pell_solution_exists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">(</span><span class="bound">y</span><span class="main">::</span>nat<span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">D</span> <span class="main">*</span> <span class="bound">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">t</span> <span class="main">::</span> int<span class="main">,</span> <span class="bound">u</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">.</span> <span class="bound">u</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> coprime <span class="bound">u</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">¦</span><span class="bound">t</span> <span class="main">-</span> <span class="bound">u</span> <span class="main">*</span> sqrt <span class="free">D</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">/</span> <span class="bound">u</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">t</span> <span class="main">::</span> int<span class="main">,</span> <span class="bound">u</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">.</span> <span class="bound">t</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="bound">u</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">D</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="main">⌊</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> sqrt <span class="free">D</span><span class="main">⌋</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> infinite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>finite <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pell_approximation_corollary irrat_sqrt_nonsquare nonsquare_D<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">`</span> <span class="skolem">S</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">-</span><span class="skolem">M</span><span class="main">..</span><span class="skolem">M</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted">int</span>
    <span class="keyword3"><span class="command">assume</span></span> tu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> tu <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="skolem">t</span> <span class="main">+</span> <span class="skolem">u</span> <span class="main">*</span> sqrt <span class="free">D</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span><span class="skolem">t</span> <span class="main">-</span> <span class="skolem">u</span> <span class="main">*</span> sqrt <span class="free">D</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">u</span> <span class="main">*</span> sqrt <span class="free">D</span><span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">¦</span><span class="skolem">t</span> <span class="main">-</span> <span class="skolem">u</span> <span class="main">*</span> sqrt <span class="free">D</span><span class="main">¦</span> <span class="main">+</span> <span class="main">¦</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">u</span> <span class="main">*</span> sqrt <span class="free">D</span><span class="main">¦</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> abs_triangle_ineq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">u</span> <span class="main">*</span> sqrt <span class="free">D</span><span class="main">¦</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">u</span> <span class="main">*</span> sqrt <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="skolem">t</span> <span class="main">-</span> <span class="skolem">u</span> <span class="main">*</span> sqrt <span class="free">D</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tu <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="skolem">t</span> <span class="main">+</span> <span class="skolem">u</span> <span class="main">*</span> sqrt <span class="free">D</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> <span class="skolem">u</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">u</span> <span class="main">*</span> sqrt <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="skolem">t</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="skolem">u</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">D</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span><span class="skolem">t</span> <span class="main">-</span> <span class="skolem">u</span> <span class="main">*</span> sqrt <span class="free">D</span><span class="main">¦</span> <span class="main">*</span> <span class="main">¦</span><span class="skolem">t</span> <span class="main">+</span> <span class="skolem">u</span> <span class="main">*</span> sqrt <span class="free">D</span><span class="main">¦</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> abs_mult <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> power2_eq_square<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> <span class="skolem">u</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="skolem">u</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">u</span> <span class="main">*</span> sqrt <span class="free">D</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tu <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_mono le<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> real <span class="skolem">u</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> sqrt <span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> power2_eq_square<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="skolem">u</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> real <span class="skolem">u</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> <span class="main">1</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> divide_left_mono power_mono<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="skolem">t</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="skolem">u</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">D</span><span class="main">¦</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> sqrt <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="skolem">u</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">D</span> <span class="main">≥</span> <span class="main">-</span><span class="skolem">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="skolem">u</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">D</span> <span class="main">≤</span> <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> M_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="skolem">u</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">D</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="skolem">M</span><span class="main">..</span><span class="skolem">M</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?f</span> <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> pigeonhole_infinite<span class="main">[</span><span class="operator">OF</span> infinite fin<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound"><span class="bound">z'</span></span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">z'</span> <span class="main">=</span> <span class="var">?f</span> <span class="skolem">z</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="var">?f</span> <span class="skolem">z</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> subset <span class="keyword2"><span class="keyword">and</span></span> z <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="skolem">M</span><span class="main">..</span><span class="skolem">M</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">z</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> k_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> k_nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> k<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">z</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">z</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span> int <span class="skolem">u</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">*</span> int <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"int <span class="skolem">u</span> <span class="main">^</span> <span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="skolem">t</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"int <span class="skolem">u</span> <span class="keyword1">dvd</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> int <span class="skolem">u</span> <span class="main">*</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> dvdE<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> * <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">S</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span> int <span class="free">D</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power_mult_distrib S_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span> int <span class="main">(</span>nat <span class="main">¦</span><span class="skolem">k</span><span class="main">¦</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> nat <span class="main">¦</span><span class="skolem">k</span><span class="main">¦</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> of_nat_eq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_square <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> nonsquare_D <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">z</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">t</span> <span class="main">::</span> int<span class="main">,</span> <span class="bound">u</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span> <span class="keyword1">mod</span> <span class="main">(</span>abs <span class="skolem">k</span><span class="main">)</span><span class="main">,</span> <span class="bound">u</span> <span class="keyword1">mod</span> <span class="main">(</span>abs <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">z</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>abs <span class="skolem">k</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span> abs <span class="skolem">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> k_nz <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?h</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">z</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> pigeonhole_infinite<span class="main">[</span><span class="operator">OF</span> k<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> z'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z'</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">z'</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound"><span class="bound">z''</span></span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">z</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">}</span><span class="main">.</span> <span class="var">?h</span> <span class="bound">z''</span> <span class="main">=</span> <span class="var">?h</span> <span class="skolem">z'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">l1</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">l2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l1</span> <span class="main">=</span> fst <span class="main">(</span><span class="var">?h</span> <span class="skolem">z'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l2</span> <span class="main">=</span> snd <span class="main">(</span><span class="var">?h</span> <span class="skolem">z'</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S'</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound"><span class="bound">t</span></span><span class="main">,</span><span class="bound"><span class="bound">u</span></span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">.</span> <span class="var">?f</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">∧</span> <span class="bound">t</span> <span class="keyword1">mod</span> abs <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">l1</span> <span class="main">∧</span> <span class="bound">u</span> <span class="keyword1">mod</span> abs <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">l2</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> z'<span class="main">(</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">z''</span></span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">z</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">}</span><span class="main">.</span> <span class="var">?h</span> <span class="bound">z''</span> <span class="main">=</span> <span class="var">?h</span> <span class="skolem">z'</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">S'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> l1_def l2_def case_prod_unfold S'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> infinite<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="skolem">S'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">from</span></span> z'<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> k_nz <span class="keyword1"><span class="command">have</span></span> l12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l1</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>abs <span class="skolem">k</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l2</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>abs <span class="skolem">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> l1_def l2_def case_prod_unfold<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> infinite_arbitrarily_large<span class="main">[</span><span class="operator">OF</span> infinite<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">X</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="skolem">S'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> finite_distinct_list<span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> X <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> distinct_card<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z1</span></span> <span class="skolem"><span class="skolem">z2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">z1</span><span class="main">,</span> <span class="skolem">z2</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_Suc_conv eval_nat_numeral<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> X xs <span class="keyword1"><span class="command">have</span></span> S'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z1</span> <span class="main">∈</span> <span class="skolem">S'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z2</span> <span class="main">∈</span> <span class="skolem">S'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z1</span> <span class="main">≠</span> <span class="skolem">z2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t1</span></span> <span class="skolem"><span class="skolem">u1</span></span> <span class="skolem"><span class="skolem">t2</span></span> <span class="skolem"><span class="skolem">u2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">=</span> fst <span class="skolem">z1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u1</span> <span class="main">=</span> snd <span class="skolem">z1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">=</span> fst <span class="skolem">z2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u2</span> <span class="main">=</span> snd <span class="skolem">z2</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span> <span class="skolem">u1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z2</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t2</span><span class="main">,</span> <span class="skolem">u2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t1_def u1_def t2_def u2_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> S' <span class="keyword1"><span class="command">have</span></span> * <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="keyword1">mod</span> abs <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">l1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="keyword1">mod</span> abs <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">l1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u1</span> <span class="keyword1">mod</span> abs <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">l2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u2</span> <span class="keyword1">mod</span> abs <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">l2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S'_def<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t1</span> <span class="main">*</span> <span class="skolem">t2</span> <span class="main">-</span> <span class="free">D</span> <span class="main">*</span> <span class="skolem">u1</span> <span class="main">*</span> <span class="skolem">u2</span><span class="main">)</span> <span class="keyword1">div</span> <span class="skolem">k</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t1</span> <span class="main">*</span> <span class="skolem">u2</span> <span class="main">-</span> <span class="skolem">t2</span> <span class="main">*</span> <span class="skolem">u1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="skolem">k</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> S' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t1</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="skolem">u1</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">D</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t2</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="skolem">u2</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">D</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t1</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="skolem">u1</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">D</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">t2</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="skolem">u2</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">D</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> power2_eq_square <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t1</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="skolem">u1</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">D</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">t2</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="skolem">u2</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">D</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="skolem">t1</span> <span class="main">*</span> <span class="skolem">t2</span> <span class="main">-</span> <span class="free">D</span> <span class="main">*</span> <span class="skolem">u1</span> <span class="main">*</span> <span class="skolem">u2</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">-</span> <span class="free">D</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">t1</span> <span class="main">*</span> <span class="skolem">u2</span> <span class="main">-</span> <span class="skolem">t2</span> <span class="main">*</span> <span class="skolem">u1</span><span class="main">)</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t1</span> <span class="main">*</span> <span class="skolem">t2</span> <span class="main">-</span> <span class="free">D</span> <span class="main">*</span> <span class="skolem">u1</span> <span class="main">*</span> <span class="skolem">u2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="free">D</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">t1</span> <span class="main">*</span> <span class="skolem">u2</span> <span class="main">-</span> <span class="skolem">t2</span> <span class="main">*</span> <span class="skolem">u1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="skolem">k</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t1</span> <span class="main">*</span> <span class="skolem">u2</span> <span class="main">-</span> <span class="skolem">t2</span> <span class="main">*</span> <span class="skolem">u1</span><span class="main">)</span> <span class="keyword1">mod</span> abs <span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l1</span> <span class="main">*</span> <span class="skolem">l2</span> <span class="main">-</span> <span class="skolem">l1</span> <span class="main">*</span> <span class="skolem">l2</span><span class="main">)</span> <span class="keyword1">mod</span> abs <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> l12 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mod_diff_cong mod_mult_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mod_pos_pos_trivial<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> dvd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="keyword1">dvd</span> <span class="skolem">t1</span> <span class="main">*</span> <span class="skolem">u2</span> <span class="main">-</span> <span class="skolem">t2</span> <span class="main">*</span> <span class="skolem">u1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_eq_0_iff_dvd<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">dvd</span> <span class="skolem">k</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="free">D</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">t1</span> <span class="main">*</span> <span class="skolem">u2</span> <span class="main">-</span> <span class="skolem">t2</span> <span class="main">*</span> <span class="skolem">u1</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dvd1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> dvd_add<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t1</span> <span class="main">*</span> <span class="skolem">t2</span> <span class="main">-</span> <span class="free">D</span> <span class="main">*</span> <span class="skolem">u1</span> <span class="main">*</span> <span class="skolem">u2</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> dvd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="keyword1">dvd</span> <span class="skolem">t1</span> <span class="main">*</span> <span class="skolem">t2</span> <span class="main">-</span> <span class="free">D</span> <span class="main">*</span> <span class="skolem">u1</span> <span class="main">*</span> <span class="skolem">u2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">note</span></span> eq
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> dvd2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">*</span> <span class="skolem">t2</span> <span class="main">-</span> <span class="free">D</span> <span class="main">*</span> <span class="skolem">u1</span> <span class="main">*</span> <span class="skolem">u2</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">*</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> dvd1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">*</span> <span class="skolem">u2</span> <span class="main">-</span> <span class="skolem">t2</span> <span class="main">*</span> <span class="skolem">u1</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">*</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> y_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="free">D</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">*</span> <span class="skolem">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="skolem">k</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span><span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="free">D</span> <span class="main">*</span> <span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mult_distrib <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="free">D</span> <span class="main">*</span> <span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> k_nz <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">D</span> <span class="main">*</span> <span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> int <span class="main">(</span>nat <span class="main">¦</span><span class="skolem">x</span><span class="main">¦</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">D</span> <span class="main">*</span> <span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> int <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">D</span> <span class="main">*</span> nat <span class="main">¦</span><span class="skolem">y</span><span class="main">¦</span> <span class="main">^</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> of_nat_eq_iff
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> eq''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">¦</span><span class="skolem">x</span><span class="main">¦</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">D</span> <span class="main">*</span> <span class="main">(</span>nat <span class="main">¦</span><span class="skolem">y</span><span class="main">¦</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">*</span> <span class="skolem">u2</span> <span class="main">≠</span> <span class="skolem">t2</span> <span class="main">*</span> <span class="skolem">u1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">*</span> <span class="skolem">u2</span> <span class="main">=</span> <span class="skolem">t2</span> <span class="main">*</span> <span class="skolem">u1</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="skolem">t1</span><span class="main">¦</span> <span class="main">*</span> <span class="main">¦</span><span class="skolem">u2</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span><span class="skolem">t2</span><span class="main">¦</span> <span class="main">*</span> <span class="main">¦</span><span class="skolem">u1</span><span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> abs_mult <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> S' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">u1</span> <span class="skolem">t1</span>"</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">u2</span> <span class="skolem">t2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S'_def S_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="skolem">t1</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span><span class="skolem">t2</span><span class="main">¦</span> <span class="main">∧</span> <span class="skolem">u1</span> <span class="main">=</span> <span class="skolem">u2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> coprime_crossproduct_int<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S'_def S_def gcd.commute coprime_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> S' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u2</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S'_def S_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">=</span> <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword2"><span class="keyword">and</span></span> neq <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> dvd1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> y_def dvd_div_eq_0_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">¦</span><span class="skolem">y</span><span class="main">¦</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> eq'' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">D</span> <span class="main">*</span> <span class="bound">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of solutions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We define some abbreviations for the concepts of a solution and a non-trivial solution.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">solution</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">::</span> comm_semiring_1<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">solution</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> of_nat <span class="free">D</span> <span class="main">*</span> <span class="bound">b</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nontriv_solution</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> <span class="main">::</span> comm_semiring_1<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nontriv_solution</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">a</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> of_nat <span class="free">D</span> <span class="main">*</span> <span class="bound">b</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nontriv_solution_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"nontriv_solution <span class="free">z</span> <span class="main">⟷</span> solution <span class="free">z</span> <span class="main">∧</span> <span class="free">z</span> <span class="main">≠</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> solution_def nontriv_solution_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> solution_trivial_nat <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"solution <span class="main">(</span>Suc <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> solution_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> solution_trivial <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"solution <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> solution_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> solution_uminus_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"solution <span class="main">(</span><span class="main">-</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> comm_ring_1<span class="main">)</span> <span class="main">⟷</span> solution <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> solution_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> solution_uminus_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"solution <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="main">-</span><span class="free">y</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> comm_ring_1<span class="main">)</span> <span class="main">⟷</span> solution <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> solution_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> solution_0_snd_nat_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"solution <span class="main">(</span><span class="free">a</span> <span class="main">::</span> nat<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> solution_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> solution_0_snd_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"solution <span class="main">(</span><span class="free">a</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> idom<span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="main">-</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> solution_def power2_eq_1_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> no_solution_0_fst_nat <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>solution <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="free">b</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> solution_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> no_solution_0_fst_int <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>solution <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="free">b</span> <span class="main">::</span> int<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> int <span class="free">D</span> <span class="main">*</span> <span class="free">b</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_pos_nonneg<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> solution_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> solution_of_nat_of_nat <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"solution <span class="main">(</span>of_nat <span class="free">a</span><span class="main">,</span> of_nat <span class="free">b</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>comm_ring_1<span class="main">,</span> ring_char_0<span class="main">}</span><span class="main">)</span> <span class="main">⟷</span> solution <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> solution_def prod.case of_nat_power <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
                 of_nat_1 <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tvar">?'a</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main"><span class="main">]</span></span> of_nat_add <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
                 of_nat_mult <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> of_nat_eq_iff of_nat_id<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> solution_of_nat_of_nat' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"solution <span class="main">(</span><span class="keyword1">case</span> <span class="free">z</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>of_nat <span class="bound">a</span><span class="main">,</span> of_nat <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>comm_ring_1<span class="main">,</span> ring_char_0<span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
     solution <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> solution_nat_abs_nat_abs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"solution <span class="main">(</span>nat <span class="main">¦</span><span class="free">x</span><span class="main">¦</span><span class="main">,</span> nat <span class="main">¦</span><span class="free">y</span><span class="main">¦</span><span class="main">)</span> <span class="main">⟷</span> solution <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> nat <span class="main">¦</span><span class="free">x</span><span class="main">¦</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">=</span> nat <span class="main">¦</span><span class="free">y</span><span class="main">¦</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> sgn <span class="free">x</span> <span class="main">*</span> <span class="skolem">x'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> sgn <span class="free">y</span> <span class="main">*</span> <span class="skolem">y'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> x'_def y'_def sgn_if<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="skolem">x'</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="skolem">y'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> x'_def y'_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"solution <span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> <span class="skolem">y'</span><span class="main">)</span> <span class="main">⟷</span> solution <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> x<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> y<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sgn_if<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nontriv_solution_of_nat_of_nat <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nontriv_solution <span class="main">(</span>of_nat <span class="free">a</span><span class="main">,</span> of_nat <span class="free">b</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>comm_ring_1<span class="main">,</span> ring_char_0<span class="main">}</span><span class="main">)</span> <span class="main">⟷</span> nontriv_solution <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nontriv_solution_altdef<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nontriv_solution_of_nat_of_nat' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nontriv_solution <span class="main">(</span><span class="keyword1">case</span> <span class="free">z</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>of_nat <span class="bound">a</span><span class="main">,</span> of_nat <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>comm_ring_1<span class="main">,</span> ring_char_0<span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
     nontriv_solution <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nontriv_solution_imp_solution <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nontriv_solution <span class="free">z</span> <span class="main">⟹</span> solution <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nontriv_solution_altdef<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Pell valuation function›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Solutions <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(x,y)›</span></span></span></span> have an interesting correspondence to the ring $\mathbb{Z}[\sqrt{D}]$ via
  the map $(x,y) \mapsto x + y \sqrt{D}$. We call this map the <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹Pell valuation function›</span></span>.
  It is obvious that this map is injective, since $\sqrt{D}$ is irrational.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pell_valuation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">×</span> int <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pell_valuation</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span> <span class="main">+</span> <span class="bound">b</span> <span class="main">*</span> sqrt <span class="free">D</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pell_valuation_nonneg <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="free">z</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> snd <span class="free">z</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> pell_valuation <span class="free">z</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pell_valuation_def case_prod_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_valuation_uminus_uminus <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span><span class="main">-</span><span class="free">x</span><span class="main">,</span> <span class="main">-</span><span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span>pell_valuation <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pell_valuation_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_valuation_eq_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pell_valuation <span class="free">z1</span> <span class="main">=</span> pell_valuation <span class="free">z2</span> <span class="main">⟷</span> <span class="free">z1</span> <span class="main">=</span> <span class="free">z2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"pell_valuation <span class="free">z1</span> <span class="main">=</span> pell_valuation <span class="free">z2</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">z1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z2</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">z2</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≠</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sqrt <span class="free">D</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">-</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">-</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> pell_valuation_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∈</span> <span class="main">ℚ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> irrat_sqrt_nonsquare nonsquare_D <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pell_valuation_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">z1</span> <span class="main">=</span> <span class="free">z2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Linear ordering of solutions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Next, we show that solutions are linearly ordered w.\,r.\,t.\ the pointwise order on products.
  This means thatfor two different solutions <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(a, b)›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(x, y)›</span></span></span></span>, we always either have
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a &lt; x›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>b &lt; y›</span></span></span></span> or <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a &gt; x›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>b &gt; y›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> solutions_linorder<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"solution <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"solution <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">∨</span> <span class="free">a</span> <span class="main">≥</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">≥</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"solution <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"solution <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">x</span> <span class="main">^</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> power_mono<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> that <span class="keyword2"><span class="keyword">and</span></span> D_gt_1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> solution_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_nat_le_eq_le<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">x</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> solutions_linorder_strict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"solution <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"solution <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∨</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">y</span> <span class="main">∨</span> <span class="free">a</span> <span class="main">&gt;</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">&gt;</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that assms <span class="keyword2"><span class="keyword">and</span></span> D_gt_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> solution_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> that <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">D</span> <span class="main">*</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> solution_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> that <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> solution_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> solutions_linorder<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> solutions_le_iff_pell_valuation_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"solution <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"solution <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟷</span> pell_valuation <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">≤</span> pell_valuation <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">≤</span> pell_valuation <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pell_valuation_def prod.case <span class="keyword1"><span class="command">using</span></span> D_gt_1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_mono mult_right_mono<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">≤</span> pell_valuation <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> solutions_linorder<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">≥</span> pell_valuation <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pell_valuation_def prod.case <span class="keyword1"><span class="command">using</span></span> D_gt_1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_mono mult_right_mono<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> pell_valuation <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> solutions_less_iff_pell_valuation_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"solution <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"solution <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">y</span> <span class="main">⟷</span> pell_valuation <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">&lt;</span> pell_valuation <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">y</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">&lt;</span> pell_valuation <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pell_valuation_def prod.case <span class="keyword1"><span class="command">using</span></span> D_gt_1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_strict_mono mult_strict_right_mono<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">&lt;</span> pell_valuation <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∨</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">y</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> solutions_linorder_strict<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">&gt;</span> pell_valuation <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pell_valuation_def prod.case <span class="keyword1"><span class="command">using</span></span> D_gt_1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_strict_mono mult_strict_right_mono<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> *<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The fundamental solution›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹fundamental solution›</span></span> is the non-trivial solution <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(x, y)›</span></span></span></span> with non-negative <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>y›</span></span></span></span>
  for which the Pell valuation $x + y\sqrt{D}$ is minimal, or, equivalently, for which <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>y›</span></span></span></span>
  are minimal.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fund_sol</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fund_sol</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">z</span><span class="main">::</span>nat<span class="main">×</span>nat<span class="main">.</span> is_arg_min <span class="main">(</span>pell_valuation <span class="main">::</span> nat <span class="main">×</span> nat <span class="main">⇒</span> real<span class="main">)</span> nontriv_solution <span class="bound">z</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The well-definedness of this follows from the injectivity of the Pell valuation and the fact
  that smaller Pell valuation of a solution is smaller than that of another iff the components
  are both smaller.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> fund_sol_is_arg_min<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_arg_min <span class="main">(</span>pell_valuation <span class="main">::</span> nat <span class="main">×</span> nat <span class="main">⇒</span> real<span class="main">)</span> nontriv_solution fund_sol"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fund_sol_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> theI'<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">z</span><span class="main">::</span>nat<span class="main">×</span>nat<span class="main">.</span> is_arg_min <span class="main">(</span>pell_valuation <span class="main">::</span> nat <span class="main">×</span> nat <span class="main">⇒</span> real<span class="main">)</span> nontriv_solution <span class="bound">z</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ex_ex1I<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z1</span> <span class="skolem">z2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> nat"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"is_arg_min <span class="main">(</span>pell_valuation <span class="main">::</span> nat <span class="main">×</span> nat <span class="main">⇒</span> real<span class="main">)</span> nontriv_solution <span class="skolem">z1</span>"</span></span>
           <span class="quoted"><span class="quoted">"is_arg_min <span class="main">(</span>pell_valuation <span class="main">::</span> nat <span class="main">×</span> nat <span class="main">⇒</span> real<span class="main">)</span> nontriv_solution <span class="skolem">z2</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"pell_valuation <span class="skolem">z1</span> <span class="main">=</span> pell_valuation <span class="skolem">z2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">z2</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> antisym<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_arg_min_def not_less<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z1</span> <span class="main">=</span> <span class="skolem">z2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> is_square <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">D</span> <span class="main">*</span> <span class="bound">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">y</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> is_square <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">D</span> <span class="main">*</span> <span class="bound">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pell_solution_exists <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> is_square <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">D</span> <span class="main">*</span> <span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> y_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> LeastI_ex<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> y_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">y'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"is_square <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">D</span> <span class="main">*</span> <span class="skolem">y'</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y'</span>
      <span class="keyword1"><span class="command">unfolding</span></span> y_def <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Least_le<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> y <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">D</span> <span class="main">*</span> <span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> is_nth_powerE<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> y <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nontriv_solution <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nontriv_solution_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_arg_min <span class="main">(</span>pell_valuation <span class="main">::</span> nat <span class="main">×</span> nat <span class="main">⇒</span> real<span class="main">)</span> nontriv_solution <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_arg_min_linorder
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">::</span> <span class="quoted">nat</span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"nontriv_solution <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="free">D</span> <span class="main">*</span> <span class="skolem">b</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nontriv_solution_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Nat.gr0I<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_square <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">D</span> <span class="main">*</span> <span class="skolem">b</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nontriv_solution_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> y_le<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹nontriv_solution <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">a</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> solutions_linorder_strict<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nontriv_solution_altdef<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">b</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span>int <span class="skolem">x</span><span class="main">,</span> int <span class="skolem">y</span><span class="main">)</span> <span class="main">≤</span> pell_valuation <span class="main">(</span>int <span class="skolem">a</span><span class="main">,</span> int <span class="skolem">b</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> pell_valuation_def prod.case <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_mono mult_right_mono<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z</span><span class="main">.</span> is_arg_min <span class="main">(</span>pell_valuation <span class="main">::</span> nat <span class="main">×</span> nat <span class="main">⇒</span> real<span class="main">)</span> nontriv_solution <span class="bound">z</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span>
      fund_sol_is_nontriv_solution<span class="main">:</span> <span class="quoted"><span class="quoted">"nontriv_solution fund_sol"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fund_sol_minimal<span class="main">:</span>
        <span class="quoted"><span class="quoted">"nontriv_solution <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟹</span> pell_valuation fund_sol <span class="main">≤</span> pell_valuation <span class="main">(</span>int <span class="free">a</span><span class="main">,</span> int <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fund_sol_minimal'<span class="main">:</span>
        <span class="quoted"><span class="quoted">"nontriv_solution <span class="main">(</span><span class="free">z</span> <span class="main">::</span> nat <span class="main">×</span> nat<span class="main">)</span> <span class="main">⟹</span> pell_valuation fund_sol <span class="main">≤</span> pell_valuation <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fund_sol_is_arg_min <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_arg_min_linorder case_prod_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fund_sol_minimal''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nontriv_solution <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fst fund_sol <span class="main">≤</span> fst <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"snd fund_sol <span class="main">≤</span> snd <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span>fst fund_sol<span class="main">,</span> snd fund_sol<span class="main">)</span> <span class="main">≤</span> pell_valuation <span class="main">(</span>fst <span class="free">z</span><span class="main">,</span> snd <span class="free">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fund_sol_minimal'<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst fund_sol <span class="main">≤</span> fst <span class="free">z</span> <span class="main">∧</span> snd fund_sol <span class="main">≤</span> snd <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms fund_sol_is_nontriv_solution
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> solutions_le_iff_pell_valuation_le<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fst fund_sol <span class="main">≤</span> fst <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"snd fund_sol <span class="main">≤</span> snd <span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Group structure on solutions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  As was mentioned already, the Pell valuation function provides an injective map from
  solutions of Pell's equation into the ring $\mathbb{Z}[\sqrt{D}]$. We shall see now that
  the solutions are actually a subgroup of the multiplicative group of $\mathbb{Z}[\sqrt{D}]$ via
  the valuation function as a homomorphism:

    <span class="antiquoted"><span class="antiquoted">▪</span></span> The trivial solution <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(1, 0)›</span></span></span></span> has valuation <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>1›</span></span></span></span>, which is the neutral element of
      $\mathbb{Z}[\sqrt{D}]^*$

    <span class="antiquoted"><span class="antiquoted">▪</span></span> Multiplication of two solutions $a + b \sqrt D$ and
      $x + y \sqrt D$ leads to $\bar x + \bar y\sqrt D$
      with $\bar x = xa + ybD$ and $\bar y = xb + ya$, which is again a solution.

    <span class="antiquoted"><span class="antiquoted">▪</span></span> The conjugate <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(x, -y)›</span></span></span></span> of a solution <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(x, y)›</span></span></span></span> is an inverse element to this
      multiplication operation, since $(x + y \sqrt D) (x - y \sqrt D) = 1$.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pell_mul</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> comm_semiring_1 <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pell_mul</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">*</span> <span class="bound">a</span> <span class="main">+</span> <span class="bound">y</span> <span class="main">*</span> <span class="bound">b</span> <span class="main">*</span> of_nat <span class="free">D</span><span class="main">,</span> <span class="bound">x</span> <span class="main">*</span> <span class="bound">b</span> <span class="main">+</span> <span class="bound">y</span> <span class="main">*</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pell_cnj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> comm_ring_1 <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pell_cnj</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">-</span><span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pell_cnj_snd_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="free">z</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> pell_cnj <span class="free">z</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">z</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pell_cnj_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_mul_commutes<span class="main">:</span> <span class="quoted"><span class="quoted">"pell_mul <span class="free">z1</span> <span class="free">z2</span> <span class="main">=</span> pell_mul <span class="free">z2</span> <span class="free">z1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pell_mul_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> case_prod_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_mul_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"pell_mul <span class="free">z1</span> <span class="main">(</span>pell_mul <span class="free">z2</span> <span class="free">z3</span><span class="main">)</span> <span class="main">=</span> pell_mul <span class="main">(</span>pell_mul <span class="free">z1</span> <span class="free">z2</span><span class="main">)</span> <span class="free">z3</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pell_mul_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> case_prod_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_mul_trivial_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pell_mul <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pell_mul_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> case_prod_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_mul_trivial_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pell_mul <span class="free">z</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pell_mul_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> case_prod_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_mul_trivial_left_nat <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pell_mul <span class="main">(</span>Suc <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pell_mul_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> case_prod_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_mul_trivial_right_nat <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pell_mul <span class="free">z</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pell_mul_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> case_prod_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pell_power</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> comm_semiring_1 <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pell_power</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">z'</span><span class="main">.</span> pell_mul <span class="bound">z'</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span> <span class="main">^^</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pell_power_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pell_power <span class="free">z</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pell_power_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_power_one <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pell_power <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pell_power_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_power_one_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pell_power <span class="free">z</span> <span class="main">1</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pell_power_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_power_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"pell_power <span class="free">z</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> pell_mul <span class="free">z</span> <span class="main">(</span>pell_power <span class="free">z</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pell_power_def pell_mul_commutes<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_power_add<span class="main">:</span> <span class="quoted"><span class="quoted">"pell_power <span class="free">z</span> <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> pell_mul <span class="main">(</span>pell_power <span class="free">z</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span>pell_power <span class="free">z</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">z</span></span> <span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funpow_add o_def pell_power_Suc pell_mul_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_valuation_mult <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span>pell_mul <span class="free">z1</span> <span class="free">z2</span><span class="main">)</span> <span class="main">=</span> pell_valuation <span class="free">z1</span> <span class="main">*</span> pell_valuation <span class="free">z2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pell_valuation_def pell_mul_def case_prod_unfold <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_valuation_mult_nat <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span><span class="keyword1">case</span> pell_mul <span class="free">z1</span> <span class="free">z2</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>int <span class="bound">a</span><span class="main">,</span> int <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     pell_valuation <span class="free">z1</span> <span class="main">*</span> pell_valuation <span class="free">z2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pell_valuation_def pell_mul_def case_prod_unfold <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_valuation_trivial <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pell_valuation_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_valuation_trivial_nat <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span>Suc <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pell_valuation_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_valuation_cnj<span class="main">:</span> <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span>pell_cnj <span class="free">z</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">z</span> <span class="main">-</span> snd <span class="free">z</span> <span class="main">*</span> sqrt <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pell_valuation_def pell_cnj_def case_prod_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_valuation_snd_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> of_int <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pell_valuation_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_valuation_0_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pell_valuation <span class="free">z</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">z</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"pell_valuation <span class="free">z</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">z</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">z</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sqrt <span class="free">D</span> <span class="main">=</span> <span class="main">-</span>fst <span class="free">z</span> <span class="main">/</span> snd <span class="free">z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pell_valuation_def case_prod_unfold <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">∈</span> <span class="main">ℚ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> nonsquare_D irrat_sqrt_nonsquare <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">z</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pell_valuation_def case_prod_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹snd <span class="free">z</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">z</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pell_valuation_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_valuation_solution_pos_nat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"solution <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pell_valuation <span class="free">z</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">≠</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"pell_valuation <span class="free">z</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pell_valuation <span class="free">z</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pell_valuation_nonneg<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"solution <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   pell_mul_cnj_right<span class="main">:</span> <span class="quoted"><span class="quoted">"pell_mul <span class="free">z</span> <span class="main">(</span>pell_cnj <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   pell_mul_cnj_left<span class="main">:</span> <span class="quoted"><span class="quoted">"pell_mul <span class="main">(</span>pell_cnj <span class="free">z</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pell_mul_def pell_cnj_def solution_def power2_eq_square<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_valuation_cnj_solution<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"solution <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span>pell_cnj <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> pell_valuation <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span>pell_cnj <span class="free">z</span><span class="main">)</span> <span class="main">*</span> pell_valuation <span class="free">z</span> <span class="main">=</span> pell_valuation <span class="main">(</span>pell_mul <span class="main">(</span>pell_cnj <span class="free">z</span><span class="main">)</span> <span class="free">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pell_mul <span class="main">(</span>pell_cnj <span class="free">z</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pell_mul_cnj_left<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> pell_valuation_solution_pos_nat<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pell_valuation_power <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span>pell_power <span class="free">z</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> pell_valuation <span class="free">z</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pell_power_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_valuation_power_nat <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span><span class="keyword1">case</span> pell_power <span class="free">z</span> <span class="free">n</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>int <span class="bound">a</span><span class="main">,</span> int <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> pell_valuation <span class="free">z</span> <span class="main">^</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pell_power_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_valuation_fund_sol_ge_2<span class="main">:</span> <span class="quoted"><span class="quoted">"pell_valuation fund_sol <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fund_sol <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted">fund_sol</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> fund_sol_is_nontriv_solution <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">D</span> <span class="main">*</span> <span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nontriv_solution_def<span class="main">)</span>

  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fund_sol_is_nontriv_solution <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nontriv_solution_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">*</span> <span class="main">1</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> <span class="free">D</span> <span class="main">*</span> <span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D_pos <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_mono mult_mono<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">&gt;</span> <span class="main">1</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> power2_less_imp_less<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">*</span> sqrt <span class="free">D</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span> <span class="main">*</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D_pos <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_mono mult_mono<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pell_valuation_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pell_valuation_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> solution_pell_mul <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"solution <span class="free">z1</span>"</span></span> <span class="quoted"><span class="quoted">"solution <span class="free">z2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"solution <span class="main">(</span>pell_mul <span class="free">z1</span> <span class="free">z2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">z1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z2</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">z2</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> solution_def pell_mul_def case_prod_unfold power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> solution_pell_cnj <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"solution <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"solution <span class="main">(</span>pell_cnj <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> solution_def pell_cnj_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> solution_pell_power <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"solution <span class="free">z</span> <span class="main">⟹</span> solution <span class="main">(</span>pell_power <span class="free">z</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pell_power_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_mul_eq_trivial_nat_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pell_mul <span class="free">z1</span> <span class="free">z2</span> <span class="main">=</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">z1</span> <span class="main">=</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="free">z2</span> <span class="main">=</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> D_gt_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">z1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">z2</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pell_mul_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nontriv_solution_pell_nat_mul1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"solution <span class="main">(</span><span class="free">z1</span> <span class="main">::</span> nat <span class="main">×</span> nat<span class="main">)</span> <span class="main">⟹</span> nontriv_solution <span class="free">z2</span> <span class="main">⟹</span> nontriv_solution <span class="main">(</span>pell_mul <span class="free">z1</span> <span class="free">z2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nontriv_solution_altdef pell_mul_eq_trivial_nat_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nontriv_solution_pell_nat_mul2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nontriv_solution <span class="main">(</span><span class="free">z1</span> <span class="main">::</span> nat <span class="main">×</span> nat<span class="main">)</span> <span class="main">⟹</span> solution <span class="free">z2</span> <span class="main">⟹</span> nontriv_solution <span class="main">(</span>pell_mul <span class="free">z1</span> <span class="free">z2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nontriv_solution_altdef pell_mul_eq_trivial_nat_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nontriv_solution_power_nat <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nontriv_solution <span class="main">(</span><span class="free">z</span> <span class="main">::</span> nat <span class="main">×</span> nat<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"nontriv_solution <span class="main">(</span>pell_power <span class="free">z</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nontriv_solution <span class="main">(</span>pell_power <span class="free">z</span> <span class="free">n</span><span class="main">)</span> <span class="main">∨</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nontriv_solution_pell_nat_mul1 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pell_power_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The different regions of the valuation function›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Next, we shall explore what happens to the valuation function for solutions <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(x, y)›</span></span></span></span> for
  different signs of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>y›</span></span></span></span>:

    <span class="antiquoted"><span class="antiquoted">▪</span></span> If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x &gt; 0›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>y &gt; 0›</span></span></span></span>, we have  $x + y \sqrt D &gt; 1$.

    <span class="antiquoted"><span class="antiquoted">▪</span></span> If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x &gt; 0›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>y &lt; 0›</span></span></span></span>, we have $0 &lt; x + y \sqrt D &lt; 1$.

    <span class="antiquoted"><span class="antiquoted">▪</span></span> If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x &lt; 0›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>y &gt; 0›</span></span></span></span>, we have $-1 &lt; x + y \sqrt D &lt; 0$.

    <span class="antiquoted"><span class="antiquoted">▪</span></span> If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x &lt; 0›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>y &lt; 0›</span></span></span></span>, we have $x + y \sqrt D &lt; -1$.

  In particular, this means that we can deduce the sign of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>x›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>y›</span></span></span></span> if we know in
  which of these four regions the valuation lies.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"solution <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   pell_valuation_pos_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   pell_valuation_pos_neg_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="main">-</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> D_gt_1 assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">*</span> sqrt <span class="free">D</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">*</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_mono mult_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> gt_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">*</span> sqrt <span class="free">D</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pell_valuation_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> <span class="free">x</span><span class="main">^</span><span class="numeral">2</span> <span class="main">-</span> <span class="free">D</span> <span class="main">*</span> <span class="free">y</span><span class="main">^</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> solution_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int <span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span> <span class="main">*</span> sqrt <span class="free">D</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">*</span> sqrt <span class="free">D</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span> <span class="main">*</span> sqrt <span class="free">D</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">*</span> sqrt <span class="free">D</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gt_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> eq
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> gt_1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">*</span> sqrt <span class="free">D</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">/</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> divide_strict_left_mono<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">-</span> <span class="free">y</span> <span class="main">*</span> sqrt <span class="free">D</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">note</span></span> eq
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> gt_1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">*</span> sqrt <span class="free">D</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> divide_pos_pos<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">-</span> <span class="free">y</span> <span class="main">*</span> sqrt <span class="free">D</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">-</span> <span class="free">y</span> <span class="main">*</span> sqrt <span class="free">D</span> <span class="main">&lt;</span> <span class="main">1</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="main">-</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pell_valuation_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pell_valuation_pos_neg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"solution <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pell_valuation_pos_neg_aux<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">y</span>"</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_valuation_neg_neg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"solution <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">-</span><span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pell_valuation_pos_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">y</span>"</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_valuation_neg_pos<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"solution <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">-</span><span class="main">1</span><span class="main">&lt;..&lt;</span><span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pell_valuation_pos_neg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">y</span>"</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> pell_valuation_solution_gt1D<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"solution <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"pell_valuation <span class="free">z</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fst <span class="free">z</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> snd <span class="free">z</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pell_valuation_pos_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">z</span>"</span></span><span class="main">]</span> pell_valuation_pos_neg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">z</span>"</span></span><span class="main">]</span>
        pell_valuation_neg_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">z</span>"</span></span><span class="main">]</span> pell_valuation_neg_neg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">z</span>"</span></span><span class="main">]</span>
        assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">::</span> int"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main"><span class="keyword3">;</span></span>
      <span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">::</span> int"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main"><span class="keyword3">;</span></span>
      <span class="operator">cases</span> <span class="quoted"><span class="free">z</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Generating property of the fundamental solution›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now show that the fundamental solution generates the set of the (non-negative) solutions
  in the sense that each solution is a power of the fundamental solution. Combined with the
  symmetry property that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(x,y)›</span></span></span></span> is a solution iff <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(±x, ±y)›</span></span></span></span> is a solution, this gives us
  a complete characterisation of all solutions of Pell's equation.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nth_solution</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">×</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nth_solution</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> pell_power fund_sol <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pell_valuation_nth_solution <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span>nth_solution <span class="free">n</span><span class="main">)</span> <span class="main">=</span> pell_valuation fund_sol <span class="main">^</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_solution_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> nth_solution_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj nth_solution"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"nth_solution <span class="skolem">m</span> <span class="main">=</span> nth_solution <span class="skolem">n</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span>nth_solution <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> pell_valuation <span class="main">(</span>nth_solution <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span>nth_solution <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> pell_valuation fund_sol <span class="main">^</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span>nth_solution <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> pell_valuation fund_sol <span class="main">^</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pell_valuation_fund_sol_ge_2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> power_inject_exp<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> nth_solution_sound <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"solution <span class="main">(</span>nth_solution <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fund_sol_is_nontriv_solution <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_solution_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> nth_solution_sound' <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> nontriv_solution <span class="main">(</span>nth_solution <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fund_sol_is_nontriv_solution <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_solution_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> nth_solution_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"solution <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> range nth_solution"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> nth_solution <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_solution_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nontriv_solution <span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nontriv_solution_altdef<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"pell_power fund_sol <span class="skolem">n</span> <span class="main">≠</span> <span class="free">z</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="keyword1"><span class="command">unfolding</span></span> nth_solution_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> pell_valuation fund_sol"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> pell_valuation <span class="free">z</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> nat <span class="main">⌊</span>log <span class="skolem">u</span> <span class="skolem">v</span><span class="main">⌋</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> u_ge_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pell_valuation_fund_sol_ge_2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> u_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> v_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> v_def <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pell_valuation_solution_pos_nat<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> u_le_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≤</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> u_def v_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fund_sol_minimal'<span class="main">)</span> <span class="operator">fact</span>

    <span class="keyword1"><span class="command">have</span></span> u_power_neq_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">≠</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">=</span> pell_valuation <span class="main">(</span>pell_power fund_sol <span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> u_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">⟷</span> pell_power fund_sol <span class="skolem">k</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> v_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pell_valuation_eq_iff<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">from</span></span> u_le_v v_pos u_ge_2 <span class="keyword1"><span class="command">have</span></span> log_ge_1<span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="skolem">u</span> <span class="skolem">v</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> one_le_log_cancel_iff<span class="main">)</span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">z'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z'</span> <span class="main">=</span> pell_mul <span class="free">z</span> <span class="main">(</span>pell_power <span class="main">(</span>pell_cnj fund_sol<span class="main">)</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> nat <span class="main">¦</span>fst <span class="skolem">z'</span><span class="main">¦</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> nat <span class="main">¦</span>snd <span class="skolem">z'</span><span class="main">¦</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"solution <span class="skolem">z'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms fund_sol_is_nontriv_solution <span class="keyword1"><span class="command">unfolding</span></span> z'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> solution_pell_mul solution_pell_power solution_pell_cnj<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> case_prod_unfold<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> u_ge_2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">u</span> <span class="keyword1">powr</span> real <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> powr_realpow<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="skolem">u</span> <span class="keyword1">powr</span> log <span class="skolem">u</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> u_ge_2 log_ge_1
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> powr_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> u_ge_2 v_pos <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> powr_log_cancel<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">with</span></span> u_power_neq_v<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">&lt;</span> <span class="skolem">u</span> <span class="main">^</span> Suc <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="skolem">u</span> <span class="keyword1">powr</span> log <span class="skolem">u</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> u_ge_2 v_pos <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> powr_log_cancel<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="skolem">u</span> <span class="skolem">v</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> real_of_int <span class="main">⌊</span>log <span class="skolem">u</span> <span class="skolem">v</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="keyword1">powr</span> log <span class="skolem">u</span> <span class="skolem">v</span> <span class="main">≤</span> <span class="skolem">u</span> <span class="keyword1">powr</span> real <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> u_ge_2 log_ge_1
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> powr_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">u</span> <span class="main">^</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> u_ge_2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> powr_realpow<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">^</span> Suc <span class="skolem">n</span> <span class="main">≥</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">with</span></span> u_power_neq_v<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">/</span> <span class="skolem">u</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">&lt;..&lt;</span><span class="skolem">u</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> u_ge_2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">/</span> <span class="skolem">u</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">=</span> pell_valuation <span class="skolem">z'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fund_sol_is_nontriv_solution
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> z'_def u_def v_def pell_valuation_cnj_solution <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> val<span class="main">:</span> <span class="quoted"><span class="quoted">"pell_valuation <span class="skolem">z'</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">&lt;..&lt;</span><span class="skolem">u</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword1"><span class="command">from</span></span> val <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹solution <span class="skolem">z'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nontriv_solution <span class="skolem">z'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nontriv_solution_altdef<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹solution <span class="skolem">z'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> val <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">z'</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> snd <span class="skolem">z'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pell_valuation_solution_gt1D<span class="main">)</span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z'</span> <span class="main">=</span> <span class="main">(</span>int <span class="skolem">x</span><span class="main">,</span> int <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> x_def y_def<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹nontriv_solution <span class="skolem">z'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pell_valuation <span class="main">(</span>int <span class="skolem">x</span><span class="main">,</span> int <span class="skolem">y</span><span class="main">)</span> <span class="main">≥</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> u_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fund_sol_minimal<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> val <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> solution_iff_nth_solution<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"solution <span class="free">z</span> <span class="main">⟷</span> <span class="free">z</span> <span class="main">∈</span> range nth_solution"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nth_solution_sound nth_solution_complete <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> solution_iff_nth_solution'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">×</span> int"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"solution <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>nat <span class="main">¦</span><span class="free">a</span><span class="main">¦</span><span class="main">,</span> nat <span class="main">¦</span><span class="free">b</span><span class="main">¦</span><span class="main">)</span> <span class="main">∈</span> range nth_solution"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"solution <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟷</span> solution <span class="main">(</span>nat <span class="main">¦</span><span class="free">a</span><span class="main">¦</span><span class="main">,</span> nat <span class="main">¦</span><span class="free">b</span><span class="main">¦</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span>nat <span class="main">¦</span><span class="free">a</span><span class="main">¦</span><span class="main">,</span> nat <span class="main">¦</span><span class="free">b</span><span class="main">¦</span><span class="main">)</span> <span class="main">∈</span> range nth_solution"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> solution_iff_nth_solution<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> infinite_solutions<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">z</span> <span class="main">::</span> nat <span class="main">×</span> nat<span class="main">.</span> solution <span class="bound">z</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>range nth_solution<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> range_inj_infinite nth_solution_inj<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"range nth_solution <span class="main">=</span> <span class="main">{</span><span class="bound">z</span> <span class="main">::</span> nat <span class="main">×</span> nat<span class="main">.</span> solution <span class="bound">z</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> solution_iff_nth_solution<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> infinite_solutions'<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">z</span> <span class="main">::</span> int <span class="main">×</span> int<span class="main">.</span> solution <span class="bound">z</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">z</span> <span class="main">::</span> int <span class="main">×</span> int<span class="main">.</span> solution <span class="bound">z</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>map_prod <span class="main">(</span>nat <span class="main">∘</span> abs<span class="main">)</span> <span class="main">(</span>nat <span class="main">∘</span> abs<span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">z</span> <span class="main">::</span> int <span class="main">×</span> int<span class="main">.</span> solution <span class="bound">z</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_imageI<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map_prod <span class="main">(</span>nat <span class="main">∘</span> abs<span class="main">)</span> <span class="main">(</span>nat <span class="main">∘</span> abs<span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">z</span> <span class="main">::</span> int <span class="main">×</span> int<span class="main">.</span> solution <span class="bound">z</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">{</span><span class="bound">z</span> <span class="main">::</span> nat <span class="main">×</span> nat<span class="main">.</span> solution <span class="bound">z</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_prod_def image_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"int <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">x</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> infinite_solutions <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> strict_mono_pell_valuation_nth_solution<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_mono <span class="main">(</span>pell_valuation <span class="main">∘</span> nth_solution<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pell_valuation_fund_sol_ge_2
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strict_mono_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> power_strict_increasing<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> strict_mono_nth_solution<span class="main">:</span>
  <span class="quoted"><span class="quoted">"strict_mono <span class="main">(</span>fst <span class="main">∘</span> nth_solution<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="main">(</span>snd <span class="main">∘</span> nth_solution<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted">nth_solution</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?g</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">&lt;</span> fst <span class="main">(</span><span class="var">?g</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∧</span> snd <span class="main">(</span><span class="var">?g</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">&lt;</span> snd <span class="main">(</span><span class="var">?g</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> pell_valuation_fund_sol_ge_2 that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> solutions_less_iff_pell_valuation_less<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="main">(</span>fst <span class="main">∘</span> nth_solution<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"strict_mono <span class="main">(</span>snd <span class="main">∘</span> nth_solution<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strict_mono_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The case of an ``almost square'' parameter›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>D›</span></span></span></span> is equal to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a<span class="hidden">⇧</span><sup>2</sup> - 1›</span></span></span></span> for some <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>a &gt; 1›</span></span></span></span>, we have a particularly simple case
  where the fundamental solution is simply <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(1, a)›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pell_square_minus1<span class="main">:</span> <span class="quoted"><span class="quoted">"pell <span class="main">(</span><span class="free">a</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_square <span class="main">(</span><span class="free">a</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"is_square <span class="main">(</span><span class="free">a</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="free">a</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> is_nth_powerE<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> Suc <span class="main">(</span><span class="skolem">k</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pell_square_solution_nat_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">1</span>"</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> a <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> pell <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pell_square_minus1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fund_sol_square_minus1<span class="main">:</span> <span class="quoted"><span class="quoted">"fund_sol <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> a <span class="keyword1"><span class="command">have</span></span> sol<span class="main">:</span> <span class="quoted"><span class="quoted">"nontriv_solution <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nontriv_solution_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> sol <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd fund_sol <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fund_sol_minimal''<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">a</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">1</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> solutions_linorder_strict<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"fst fund_sol"</span></span> <span class="quoted"><span class="quoted">"snd fund_sol"</span></span><span class="main">]</span>
       fund_sol_is_nontriv_solution sol
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fund_sol <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted">fund_sol</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nontriv_solution_altdef<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Alternative presentation of the main results›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> pell_solutions<span class="main">:</span>
 <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">D</span> <span class="main">::</span> <span class="quoted">nat</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">k</span><span class="main">.</span> <span class="free">D</span> <span class="main">=</span> <span class="bound">k</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
 <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted">nat</span>
 <span class="keyword2"><span class="keyword">where</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span>int<span class="main">)</span> <span class="main">(</span><span class="bound">y</span><span class="main">::</span>int<span class="main">)</span><span class="main">.</span>
            <span class="bound">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="free">D</span> <span class="main">*</span> <span class="bound">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟷</span>
            <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">.</span> nat <span class="main">¦</span><span class="bound">x</span><span class="main">¦</span> <span class="main">+</span> sqrt <span class="free">D</span> <span class="main">*</span> nat <span class="main">¦</span><span class="bound">y</span><span class="main">¦</span> <span class="main">=</span> <span class="main">(</span><span class="free">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">+</span> sqrt <span class="free">D</span> <span class="main">*</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">interpret</span></span> pell
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_nth_power_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"fst fund_sol"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"snd fund_sol"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> int <span class="free">D</span> <span class="main">*</span> <span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟷</span> solution <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> solution_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>nat <span class="main">¦</span><span class="skolem">x</span><span class="main">¦</span><span class="main">,</span> nat <span class="main">¦</span><span class="skolem">y</span><span class="main">¦</span><span class="main">)</span> <span class="main">=</span> nth_solution <span class="bound">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> solution_iff_nth_solution'<span class="main">)</span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>nat <span class="main">¦</span><span class="skolem">x</span><span class="main">¦</span><span class="main">,</span> nat <span class="main">¦</span><span class="skolem">y</span><span class="main">¦</span><span class="main">)</span> <span class="main">=</span> nth_solution <span class="bound">n</span><span class="main">)</span> <span class="main">=</span>
                 <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> pell_valuation <span class="main">(</span>nat <span class="main">¦</span><span class="skolem">x</span><span class="main">¦</span><span class="main">,</span> nat <span class="main">¦</span><span class="skolem">y</span><span class="main">¦</span><span class="main">)</span> <span class="main">=</span> pell_valuation <span class="main">(</span>nth_solution <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pell_valuation_eq_iff<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold prod_eq_iff fun_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> nat <span class="main">¦</span><span class="skolem">x</span><span class="main">¦</span> <span class="main">+</span> sqrt <span class="free">D</span> <span class="main">*</span> nat <span class="main">¦</span><span class="skolem">y</span><span class="main">¦</span> <span class="main">=</span> <span class="main">(</span>fst fund_sol <span class="main">+</span> sqrt <span class="free">D</span> <span class="main">*</span> snd fund_sol<span class="main">)</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> pell_valuation_nth_solution<span class="main">)</span>
         <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pell_valuation_def case_prod_unfold mult_ac<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> pell_solutions_infinite<span class="main">:</span>
 <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">D</span> <span class="main">::</span> <span class="quoted">nat</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">k</span><span class="main">.</span> <span class="free">D</span> <span class="main">=</span> <span class="bound">k</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="main">(</span><span class="bound">x</span> <span class="main">::</span> int<span class="main">,</span> <span class="bound">y</span> <span class="main">::</span> int<span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="free">D</span> <span class="main">*</span> <span class="bound">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">interpret</span></span> pell
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_nth_power_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span> <span class="main">::</span> int<span class="main">,</span> <span class="bound">y</span> <span class="main">::</span> int<span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="free">D</span> <span class="main">*</span> <span class="bound">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">z</span><span class="main">.</span> solution <span class="bound">z</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> solution_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> infinite_solutions'<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Pell_Algorithm">
<div class="head">
<h1>Theory Pell_Algorithm</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:    Pell_Algorithm.thy
  Author:  Manuel Eberl, TU München

  Some executable but not too efficient algorithms for computing solutions to Pell's equation.
*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Executable code›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Pell_Algorithm
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Pell.html">Pell</a>
  <a href="Efficient_Discrete_Sqrt.html">Efficient_Discrete_Sqrt</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Discrete.html">HOL-Library.Discrete</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/While_Combinator.html">HOL-Library.While_Combinator</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Stream.html">HOL-Library.Stream</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Efficient computation of powers by squaring›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following is a tail-recursive implementation of exponentiation by squaring.
  It works for any binary operation <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span> that fulfils <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f x (f x z) = f (f x x) z›</span></span></span></span>, i.\,e.\ 
  some weak form of associativity.
›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">efficient_power</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">efficient_power</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">efficient_power</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> even <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span> <span class="free">efficient_power</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free">efficient_power</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span><span class="free">f</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≠</span> <span class="main">1</span> <span class="main">⟹</span> odd <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span> <span class="free">efficient_power</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free">efficient_power</span> <span class="main">(</span><span class="free">f</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span>snd <span class="main">∘</span> snd<span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> oddE<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> efficient_power_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"efficient_power <span class="free">y</span> <span class="free">x</span> <span class="free">n</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">y</span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="free">x</span> <span class="free">y</span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> even <span class="free">n</span> <span class="keyword1">then</span> efficient_power <span class="free">y</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>
      <span class="keyword1">else</span> efficient_power <span class="main">(</span><span class="free">f</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> efficient_power.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> efficient_power_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">z</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"efficient_power <span class="free">y</span> <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">^^</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_nat_numeral o_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> efficient_power.induct<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> evenE oddE <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> funpow_mult <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> funpow_Suc_right assms
             <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> funpow.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Multiplication and powers of solutions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We define versions of Pell solution multiplication and exponentiation specialised
  to natural numbers, both for efficiency reasons and to circumvent the problem of
  generating code for definitions made inside locales.
›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pell_mul_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">×</span> nat <span class="main">⇒</span> <span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pell_mul_nat</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pell<span class="main">)</span> pell_mul_nat_correct <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pell_mul_nat <span class="free">D</span> <span class="main">=</span> pell.pell_mul <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pell_mul_def fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">efficient_pell_power</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">×</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">×</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">efficient_pell_power</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> efficient_power <span class="main">(</span>pell_mul_nat <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> efficient_pell_power_correct <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"efficient_pell_power <span class="free">D</span> <span class="free">z</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span>pell_mul_nat <span class="free">D</span> <span class="free">z</span> <span class="main">^^</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> efficient_pell_power_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> efficient_power_correct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Finding the fundamental solution›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In the following, we set up a very simple algorithm for computing the fundamental
  solution <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(x, y)›</span></span></span></span>. We try inreasing values for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>y›</span></span></span></span> until $1 + Dy^2$ is a perfect 
  square, which we check using an efficient square-detection algorithm. This is efficient
  enough to work on some interesting small examples.

  Much better algorithms (typically based on the continued fraction expansion of $\sqrt{D}$) 
  are available, but they are also considerably more complicated.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Discrete_sqrt_square_is_square<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_square <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"Discrete.sqrt <span class="free">n</span> <span class="main">^</span> <span class="numeral">2</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_nth_power_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">find_fund_sol_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">×</span> nat <span class="main">+</span> nat <span class="main">×</span> nat <span class="main">⇒</span> <span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_fund_sol_step</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span>Inl <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">y'</span><span class="main">)</span> <span class="main">⇒</span>
     <span class="main">(</span><span class="keyword1">case</span> get_nat_sqrt <span class="bound">y'</span> <span class="keyword1">of</span> 
        Some <span class="bound">x</span> <span class="main">⇒</span> Inr <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span>
      <span class="main">|</span> None <span class="main">⇒</span> Inl <span class="main">(</span><span class="bound">y</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="bound">y'</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="bound">y</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">find_fund_sol</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_fund_sol</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> square_test <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="keyword1">then</span>
        <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>
      <span class="keyword1">else</span>
        sum.projr <span class="main">(</span>while sum.isl <span class="main">(</span>find_fund_sol_step <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">(</span>Inl <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fund_sol_code<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_square <span class="main">(</span><span class="free">D</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pell.fund_sol <span class="free">D</span> <span class="main">=</span> sum.projr <span class="main">(</span>while isl <span class="main">(</span>find_fund_sol_step <span class="free">D</span><span class="main">)</span> <span class="main">(</span>Inl <span class="main">(</span>Suc <span class="main">0</span><span class="main">,</span> Suc <span class="free">D</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">interpret</span></span> pell <span class="quoted"><span class="free">D</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> find_fund_sol_step_def
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> find_fund_sol_step <span class="free">D</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> is_square <span class="main">(</span><span class="bound">y</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">D</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">y</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y'</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="bound">y</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span><span class="skolem">P</span> <span class="bound">y'</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">=</span> Discrete.sqrt <span class="main">(</span><span class="bound">y</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">D</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> nat <span class="main">+</span> nat <span class="main">×</span> nat <span class="main">⇒</span> bool"</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">s</span> <span class="keyword1">of</span>
                      Inl <span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">m</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">m'</span> <span class="main">=</span> <span class="bound">m</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">D</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="bound">m</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span>is_square <span class="main">(</span><span class="bound">y</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">D</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">|</span> Inr <span class="bound">x</span> <span class="main">⇒</span> <span class="skolem">Q</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rel</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>nat <span class="main">×</span> nat <span class="main">+</span> nat <span class="main">×</span> nat<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>nat <span class="main">×</span> nat <span class="main">+</span> nat <span class="main">×</span> nat<span class="main">)</span><span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rel</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span><span class="bound">B</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span> <span class="keyword1">of</span>
                           <span class="main">(</span>Inl <span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span> Inl <span class="main">(</span><span class="bound">m'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">m'</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">m</span> <span class="main">&gt;</span> <span class="bound">m'</span> <span class="main">∧</span> <span class="bound">m</span> <span class="main">≤</span> snd fund_sol
                         <span class="main">|</span> <span class="main">(</span>Inr <span class="main"><span class="bound">_</span></span><span class="main">,</span> Inl <span class="main">(</span><span class="bound">m'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">m'</span> <span class="main">≤</span> snd fund_sol
                         <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span> <span class="main">∧</span> <span class="bound">A</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">B</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"sum.projr <span class="main">(</span>while isl <span class="skolem">f</span> <span class="main">(</span>Inl <span class="main">(</span>Suc <span class="main">0</span><span class="main">,</span> Suc <span class="free">D</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"sum.projr <span class="main">(</span>while isl <span class="skolem">f</span> <span class="main">(</span>Inl <span class="main">(</span>Suc <span class="main">0</span><span class="main">,</span> Suc <span class="free">D</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> neq_fund_solI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> snd fund_sol"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_square <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> snd fund_sol"</span></span>
    <span class="keyword1"><span class="command">with</span></span> fund_sol_is_nontriv_solution <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">D</span><span class="main">)</span> <span class="main">=</span> fst fund_sol <span class="main">^</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nontriv_solution_def case_prod_unfold<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"is_square <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"case_sum <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span> <span class="skolem">Q</span> <span class="main">(</span>while sum.isl <span class="skolem">f</span> <span class="main">(</span>Inl <span class="main">(</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">m</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">D</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="skolem">m</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span>is_square <span class="main">(</span><span class="bound">y</span><span class="main">^</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">D</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> while_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">sum.isl</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">(</span>Inl <span class="main">(</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">m</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">D</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"isl <span class="skolem">s</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_less_less_Suc_eq Q_def P_def R_def f_def get_nat_sqrt_def
                     power2_eq_square <span class="dynamic"><span class="dynamic">algebra_simps</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>isl <span class="skolem">s</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">s</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False <span class="main">|</span> Inr <span class="bound">x</span> <span class="main">⇒</span> <span class="skolem">Q</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"isl <span class="skolem">s</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span> <span class="skolem">s</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">rel</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Inl <span class="skolem">s'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> s <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> Suc <span class="main">(</span><span class="skolem">a</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">D</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="skolem">a</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">¬</span> is_square <span class="main">(</span>Suc <span class="main">(</span><span class="bound">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> R_def<span class="main">)</span>
     
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> snd fund_sol"</span></span> <span class="keyword2"><span class="keyword">if</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_square <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">a</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> neq_fund_solI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">≠</span> snd fund_sol"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span>Suc <span class="skolem">a</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y'</span>
          <span class="keyword1"><span class="command">using</span></span> * ** that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd fund_sol <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fund_sol_is_nontriv_solution
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted">fund_sol</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nontriv_solution_altdef<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">y'</span></span><span class="main">≤</span><span class="skolem">a</span><span class="main">.</span> <span class="bound">y'</span> <span class="main">≠</span> snd fund_sol"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_Suc_eq_le<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"snd fund_sol <span class="main">&gt;</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> snd fund_sol"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_less<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≤</span> snd fund_sol"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y'</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="skolem">a</span><span class="main">}</span><span class="main">.</span> <span class="bound">y'</span> <span class="main">≠</span> snd fund_sol"</span></span> <span class="keyword1"><span class="command">using</span></span> neq_fund_solI *
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_Suc_eq_le<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd fund_sol <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fund_sol_is_nontriv_solution
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted">fund_sol</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nontriv_solution_altdef<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">y'</span></span><span class="main">&lt;</span><span class="skolem">a</span><span class="main">.</span> <span class="bound">y'</span> <span class="main">≠</span> snd fund_sol"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_Suc_eq_le<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"snd fund_sol <span class="main">≥</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≤</span> snd fund_sol"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_less<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> *
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def get_nat_sqrt_def rel_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> s<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rel'</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rel'</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> Inl <span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">m</span> <span class="main">≤</span> snd fund_sol <span class="main">|</span> Inr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf <span class="skolem">rel'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rel'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_if_measure<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">z</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">case</span></span></span> <span class="bound"><span class="bound"><span class="bound">z</span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1">of</span></span></span> Inl <span class="main"><span class="main"><span class="main">(</span></span></span><span class="bound"><span class="bound"><span class="bound">m</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">⇒</span></span></span> Suc <span class="main"><span class="main"><span class="main">(</span></span></span>snd fund_sol<span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="bound"><span class="bound"><span class="bound">m</span></span></span> <span class="main"><span class="main"><span class="main">|</span></span></span> <span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span></span></span> <span class="main"><span class="main"><span class="main">⇒</span></span></span> <span class="main"><span class="main"><span class="main">0</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits sum.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def get_nat_sqrt_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rel</span> <span class="main">⊆</span> <span class="skolem">rel'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">rel</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">rel'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_def rel'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf <span class="skolem">rel</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> xy <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_square <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q_def P_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">=</span> Suc <span class="main">(</span><span class="skolem">y</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">D</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Q_def P_def Discrete_sqrt_square_is_square<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nontriv_solution <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nontriv_solution_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd fund_sol <span class="main">≤</span> snd <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fund_sol_minimal''<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd fund_sol <span class="main">≥</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">y'</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="skolem">y</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span> is_square <span class="main">(</span>Suc <span class="main">(</span><span class="bound">y'</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q_def P_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> neq_fund_solI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">y'</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="skolem">y</span><span class="main">}</span><span class="main">.</span> <span class="bound">y'</span> <span class="main">≠</span> snd fund_sol<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd fund_sol <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fund_sol_is_nontriv_solution
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted">fund_sol</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Nat.gr0I <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nontriv_solution_altdef<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">y'</span></span><span class="main">&lt;</span><span class="skolem">y</span><span class="main">.</span> <span class="bound">y'</span> <span class="main">≠</span> snd fund_sol<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"snd fund_sol <span class="main">≥</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd fund_sol <span class="main">≥</span> <span class="skolem">y</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_less<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd fund_sol <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> solutions_linorder_strict<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="quoted">"fst fund_sol"</span></span> <span class="quoted"><span class="quoted">"snd fund_sol"</span></span><span class="main">]</span>
       fund_sol_is_nontriv_solution <span class="quoted"><span class="quoted">‹nontriv_solution <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst fund_sol <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted">fund_sol</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nontriv_solution_altdef<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹snd fund_sol <span class="main">=</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fund_sol <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted">fund_sol</span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> xy <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> find_fund_sol_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"find_fund_sol <span class="free">D</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> is_square <span class="free">D</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">else</span> pell.fund_sol <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_fund_sol_def fund_sol_code square_test_correct<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The infinite list of all solutions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pell_solutions</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> stream"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pell_solutions</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">z</span> <span class="main">=</span> find_fund_sol <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="keyword1">in</span> siterate <span class="main">(</span>pell_mul_nat <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">z</span><span class="main">)</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pell<span class="main">)</span> <span class="quoted"><span class="quoted">"snth <span class="main">(</span>pell_solutions <span class="free">D</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> nth_solution <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pell_solutions_def Let_def find_fund_sol_correct nonsquare_D nth_solution_def
                pell_power_def pell_mul_commutes<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted">fund_sol</span><span class="main"><span class="main">]</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Computing the $n$-th solution›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">find_nth_solution</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">×</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_nth_solution</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> is_square <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">else</span>
        <span class="keyword1">let</span> <span class="bound">z</span> <span class="main">=</span> sum.projr <span class="main">(</span>while isl <span class="main">(</span>find_fund_sol_step <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">(</span>Inl <span class="main">(</span>Suc <span class="main">0</span><span class="main">,</span> Suc <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1">in</span>  efficient_pell_power <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="bound">z</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pell<span class="main">)</span> find_nth_solution_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"find_nth_solution <span class="free">D</span> <span class="free">n</span> <span class="main">=</span> nth_solution <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_nth_solution_def nonsquare_D nth_solution_def fund_sol_code 
                pell_power_def pell_mul_commutes<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"projr <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Pell_Algorithm_Test">
<div class="head">
<h1>Theory Pell_Algorithm_Test</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:    Pell_Algorithm_Test.thy
  Author:  Manuel Eberl, TU München

  Tests for the executable algorithms for Pell's equation.
*)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Tests›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Pell_Algorithm_Test
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Pell_Algorithm.html">Pell_Algorithm</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Code_Target_Numeral.html">HOL-Library.Code_Target_Numeral</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Code_Lazy.html">HOL-Library.Code_Lazy</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">code_lazy_type</span></span> stream

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"find_fund_sol <span class="numeral">73</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"find_fund_sol <span class="numeral">106</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"stake <span class="numeral">100</span> <span class="main">(</span>pell_solutions <span class="numeral">73</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"snth <span class="main">(</span>pell_solutions <span class="numeral">73</span><span class="main">)</span> <span class="numeral">600</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"find_nth_solution <span class="numeral">73</span> <span class="numeral">600</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"find_nth_solution <span class="numeral">106</span> <span class="numeral">10</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>