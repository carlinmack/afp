<div id="Source_Coding_Theorem">
<div class="head">
<h1>Theory Source_Coding_Theorem</h1>
</div>
<pre class="source"><span class="comment1">(* Title:       One Part of Shannon's Source Coding Theorem
   Author:      Quentin Hibon &lt;qh225@cl.cam.ac.uk&gt;, Lawrence Paulson &lt;lp15@cam.ac.uk&gt;, 2014
   Maintainer:  Quentin Hibon &lt;qh225@cl.cam.ac.uk&gt;
*)</span>

<span class="keyword1"><span class="command">theory</span></span> Source_Coding_Theorem
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Probability/Information.html">HOL-Probability.Information</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Basic types›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> bit <span class="main">=</span> <span class="quoted">bool</span>
<span class="keyword1"><span class="command">type_synonym</span></span> bword <span class="main">=</span> <span class="quoted"><span class="quoted">"bit list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> letter <span class="main">=</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'b</span> word <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> list"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'b</span> encoder <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> word <span class="main">⇒</span> bword"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'b</span> decoder <span class="main">=</span> <span class="quoted"><span class="quoted">"bword <span class="main">⇒</span> <span class="tfree">'b</span> word option"</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Locale for the source coding theorem›</span></span>
<span class="keyword1"><span class="command">locale</span></span> source_code <span class="main">=</span> information_space <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">fi</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>

  <span class="keyword2"><span class="keyword">assumes</span></span> distr_i<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_distributed <span class="free">M</span> <span class="free">X</span> <span class="free">fi</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> b_val<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>

  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">enc</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> encoder"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">dec</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> decoder"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> real_code<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">dec</span> <span class="main">(</span><span class="free">enc</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enc</span> <span class="free">w</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">w</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="free">enc</span> <span class="free">x</span> <span class="main">=</span> <span class="free">enc</span> <span class="main">[</span>hd <span class="free">x</span><span class="main">]</span> <span class="main">@</span> <span class="free">enc</span> <span class="main">(</span>tl <span class="free">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">section</span></span><span class="quoted"><span class="plain_text">‹Source coding theorem, direct: the entropy is a lower bound of the code rate›</span></span>
<span class="keyword1"><span class="command">context</span></span> source_code
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹The letter set›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">L</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≡</span> <span class="free">X</span> <span class="main">`</span> space <span class="free">M</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fin_L<span class="main">:</span> <span class="quoted"><span class="quoted">"finite L"</span></span>
    <span class="keyword1"><span class="command">using</span></span> L_def distr_i
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> emp_L<span class="main">:</span> <span class="quoted"><span class="quoted">"L <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> L_def subprob_not_empty
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Codes and words›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">real_word</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> word <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">real_word</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">⊆</span> L<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">k_words</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> word<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">k_words</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">w</span><span class="main">.</span> length <span class="bound">w</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∧</span> real_word <span class="bound">w</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rw_tail<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"real_word <span class="free">w</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> real_word <span class="main">(</span>tl <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms list.set_sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">code_word_length</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'e</span> encoder <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">code_word_length</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> length <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cw_len</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cw_len</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> code_word_length <span class="free">enc</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">code_rate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'e</span> encoder <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'e</span><span class="main">)</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">code_rate</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">Xo</span></span></span> <span class="main">=</span> expectation <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span>code_word_length <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Xo</span></span></span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fi_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">∈</span> L <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">fi</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> simple_distributed_nonneg<span class="main">[</span><span class="operator">OF</span> distr_i<span class="main">]</span> L_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> prob_space<span class="main">)</span> simp_exp_composed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"simple_distributed <span class="free">M</span> <span class="free">X</span> <span class="free">Px</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"expectation <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">X</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">`</span>space <span class="free">M</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">Px</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> distributed_integral<span class="main">[</span><span class="operator">OF</span> simple_distributed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> X<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
    simple_distributed_nonneg<span class="main">[</span><span class="operator">OF</span> X<span class="main">]</span>
    lebesgue_integral_count_space_finite<span class="main">[</span><span class="operator">OF</span> simple_distributed_finite<span class="main"><span class="main">[</span></span><span class="operator">OF</span> X<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">Px</span> <span class="bound">x</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cr_rw<span class="main">:</span>
  <span class="quoted"><span class="quoted">"code_rate <span class="free">enc</span> <span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">`</span> space <span class="free">M</span><span class="main">.</span> <span class="free">fi</span> <span class="bound">i</span> <span class="main">*</span> cw_len <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> simp_exp_composed<span class="main">[</span><span class="operator">OF</span> distr_i<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"cw_len"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.commute code_rate_def<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">cw_len_concat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> word <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cw_len_concat</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> foldr <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span>cw_len <span class="bound">x</span><span class="main">)</span> <span class="main">+</span> <span class="bound">s</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cw_len_length<span class="main">:</span> <span class="quoted"><span class="quoted">"cw_len_concat <span class="free">w</span> <span class="main">=</span> length <span class="main">(</span><span class="free">enc</span> <span class="free">w</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> real_code <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">w</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cw_len_concat <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> cw_len <span class="skolem">a</span> <span class="main">+</span> cw_len_concat <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> code_word_length_def real_code Cons
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_append list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> maj_fold<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span><span class="main">∈</span>L <span class="main">⟹</span> <span class="free">f</span> <span class="bound">l</span> <span class="main">≤</span> <span class="free">bound</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"real_word <span class="free">w</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"foldr <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">s</span><span class="main">)</span> <span class="free">w</span> <span class="main">0</span> <span class="main">≤</span> length <span class="free">w</span> <span class="main">*</span> <span class="free">bound</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_len</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_len</span> <span class="main">=</span> Max <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> cw_len <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> L<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> max_cw<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> L <span class="main">⟹</span> cw_len <span class="free">l</span> <span class="main">≤</span> max_len"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_len_def fin_L<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Related to the Kraft theorem›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">𝒦</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">𝒦</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>L<span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="free">b</span> <span class="main">^</span> <span class="main">(</span>cw_len <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pos_cw_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">/</span> <span class="free">b</span> <span class="main">^</span> cw_len <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b_gt_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒦_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> 𝒦"</span></span>
    <span class="keyword1"><span class="command">using</span></span> emp_L fin_L pos_cw_len sum_pos 𝒦_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒦_pow<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒦 <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>L<span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="free">b</span> <span class="keyword1">powr</span> cw_len <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> powr_realpow b_gt_1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝒦_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> k_words_rel<span class="main">:</span>
  <span class="quoted"><span class="quoted">"k_words <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">w</span><span class="main">.</span> <span class="main">(</span>hd <span class="bound">w</span> <span class="main">∈</span> L <span class="main">∧</span> tl <span class="bound">w</span> <span class="main">∈</span> k_words <span class="free">k</span> <span class="main">∧</span> <span class="bound">w</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"k_words <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">w</span><span class="main">.</span> <span class="main">(</span>hd <span class="bound">w</span> <span class="main">∈</span> L <span class="main">∧</span> tl <span class="bound">w</span> <span class="main">∈</span> k_words <span class="skolem">k</span> <span class="main">∧</span> <span class="bound">w</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⊆</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
      <span class="keyword3"><span class="command">assume</span></span> w_kw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> k_words <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"real_word <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">w</span> <span class="main">∈</span> L"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> w_kw hd_in_set list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> mem_Collect_eq nat.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> subset_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">w</span> <span class="main">=</span> Suc <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> w_kw <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real_word <span class="main">(</span>tl <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹real_word <span class="skolem">w</span>›</span></span> calculation<span class="main">(</span>3<span class="main">)</span> rw_tail <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> w_kw <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"k_words <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="main">⊇</span> <span class="main">{</span><span class="bound">w</span><span class="main">.</span> <span class="main">(</span>hd <span class="bound">w</span> <span class="main">∈</span> L <span class="main">∧</span> tl <span class="bound">w</span> <span class="main">∈</span> k_words <span class="skolem">k</span> <span class="main">∧</span> <span class="bound">w</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
      <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">w</span><span class="main">.</span> hd <span class="bound">w</span> <span class="main">∈</span> L <span class="main">∧</span> tl <span class="bound">w</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">w</span><span class="main">.</span> length <span class="bound">w</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">∧</span> real_word <span class="bound">w</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">w</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">w</span> <span class="main">∈</span> L <span class="main">∧</span> length <span class="main">(</span>tl <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">∧</span> real_word <span class="main">(</span>tl <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"real_word <span class="skolem">w</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_iff insert_subset list.collapse list.set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subsetI<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">w</span> <span class="main">=</span> Suc <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> k_words <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bij_k_words<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">λ</span><span class="bound">wi</span><span class="main">.</span> Cons <span class="main">(</span>fst <span class="bound">wi</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">wi</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>L <span class="main">×</span> k_words <span class="free">k</span><span class="main">)</span> <span class="main">(</span>k_words <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def
<span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">wi</span><span class="main">.</span> Cons <span class="main">(</span>fst <span class="bound">wi</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">wi</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"L <span class="main">×</span> <span class="main">(</span>k_words <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"k_words <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="var">?f</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span><span class="main">`</span><span class="var">?S</span> <span class="main">=</span> <span class="var">?T</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">`</span> <span class="var">?S</span> <span class="main">≠</span> <span class="var">?T</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span><span class="main">∈</span> <span class="var">?T</span> <span class="main">∧</span> <span class="bound">w</span> <span class="main">∉</span> <span class="var">?f</span><span class="main">`</span><span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span> <span class="var">?T</span> <span class="main">∧</span> <span class="skolem">w</span> <span class="main">∉</span> <span class="var">?f</span><span class="main">`</span><span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="var">?f</span> <span class="main">(</span>hd <span class="skolem">w</span><span class="main">,</span>tl <span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_words_rel <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>hd <span class="skolem">w</span><span class="main">,</span>tl <span class="skolem">w</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_words_rel asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="var">?f</span><span class="main">`</span><span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_k_words<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>k_words <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> bij_k_words bij_betw_finite fin_L <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cartesian_product<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> real<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> <span class="main">⇒</span> real<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">b</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="free">g</span> <span class="bound">b</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ab</span><span class="main">∈</span><span class="free">A</span><span class="main">×</span><span class="free">B</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>fst <span class="bound">ab</span><span class="main">)</span> <span class="main">*</span> <span class="free">g</span> <span class="main">(</span>snd <span class="bound">ab</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bilinear_times bilinear_sum<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> g<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">g</span>"</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> sum.cong split_beta' Groups.ab_semigroup_mult_class.mult.commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒦_power<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"𝒦<span class="main">^</span><span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">w</span> <span class="main">∈</span> <span class="main">(</span>k_words <span class="free">k</span><span class="main">)</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="free">b</span><span class="main">^</span><span class="main">(</span>cw_len_concat <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"k_words <span class="main">0</span> <span class="main">=</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" 𝒦 <span class="main">^</span>Suc <span class="skolem">n</span> <span class="main">=</span> 𝒦 <span class="main">^</span><span class="skolem">n</span> <span class="main">*</span> 𝒦 "</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">w</span> <span class="main">∈</span> k_words <span class="skolem">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="free">b</span><span class="main">^</span>cw_len_concat <span class="bound">w</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>L<span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="free">b</span><span class="main">^</span>cw_len <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.hyps 𝒦_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">wi</span> <span class="main">∈</span> L <span class="main">×</span> k_words <span class="skolem">n</span><span class="main">.</span> <span class="main">1</span><span class="main">/</span><span class="free">b</span><span class="main">^</span>cw_len <span class="main">(</span>fst <span class="bound">wi</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">b</span><span class="main">^</span>cw_len_concat <span class="main">(</span>snd <span class="bound">wi</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fin_L finite_k_words cartesian_product
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">wi</span> <span class="main">∈</span> L <span class="main">×</span> k_words <span class="skolem">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="free">b</span><span class="main">^</span><span class="main">(</span>cw_len_concat <span class="main">(</span>snd <span class="bound">wi</span><span class="main">)</span> <span class="main">+</span> cw_len <span class="main">(</span>fst <span class="bound">wi</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> power_add add.commute power_one_over<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">wi</span> <span class="main">∈</span> L <span class="main">×</span> k_words <span class="skolem">n</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="free">b</span><span class="main">^</span>cw_len_concat <span class="main">(</span>fst <span class="bound">wi</span> <span class="main">#</span> snd <span class="bound">wi</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add.commute comp_apply foldr.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">w</span> <span class="main">∈</span> <span class="main">(</span>k_words <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="free">b</span><span class="main">^</span><span class="main">(</span>cw_len_concat <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bij_k_words sum.reindex_bij_betw <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bound_len_concat<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> k_words <span class="free">k</span> <span class="main">⟹</span> cw_len_concat <span class="free">w</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">*</span> max_len"</span></span>
    <span class="keyword1"><span class="command">using</span></span> max_cw maj_fold <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Inequality of the kraft sum (source coding theorem, direct)›</span></span>
<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Sum manipulation lemmas and McMillan theorem›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_vimage_proof<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span><span class="main">.</span> <span class="free">f</span> <span class="bound">w</span> <span class="main">&lt;</span> <span class="free">bd</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">w</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span><span class="free">f</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">m</span><span class="main">=</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">bd</span><span class="main">.</span> <span class="main">(</span>card <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">-`</span><span class="main">{</span><span class="bound">m</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span> <span class="main">)</span><span class="main">*</span> <span class="free">g</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">m</span><span class="main">=</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">bd</span><span class="main">.</span> <span class="var">?ff</span> <span class="bound">m</span> <span class="free">S</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> empty
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">bd</span><span class="main">.</span> <span class="var">?ff</span> <span class="bound">m</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">bd</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">h</span><span class="main">::</span><span class="main">(</span>nat <span class="main">⇒</span> real<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">=</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">bd</span><span class="main">.</span> <span class="bound">h</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">bd</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">f</span> <span class="skolem">x</span><span class="main">}</span><span class="main">)</span><span class="main">.</span><span class="bound">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">+</span> <span class="bound">h</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_add_cancel finite_atLeastLessThan sum_diff1<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">bd</span><span class="main">.</span> <span class="var">?ff</span> <span class="bound">m</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">bd</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">f</span> <span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="var">?ff</span> <span class="bound">m</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="free">f</span> <span class="skolem">x</span><span class="main">}</span> <span class="main">∩</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">*</span> <span class="free">g</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> <span class="free">g</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">bd</span><span class="main">.</span> <span class="var">?ff</span> <span class="bound">m</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">bd</span><span class="main">}</span><span class="main">.</span> <span class="var">?ff</span> <span class="bound">m</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">+</span> <span class="free">g</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_vimage<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">w</span> <span class="main">&lt;</span> <span class="free">bd</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">bd</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">w</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span><span class="free">f</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">m</span><span class="main">=</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">bd</span><span class="main">.</span> <span class="main">(</span>card <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">-`</span><span class="main">{</span><span class="bound">m</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span> <span class="main">)</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
<span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s1</span> <span class="main">=</span> <span class="var">?s2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ff</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ss1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">w</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span><span class="var">?ff</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ss2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">m</span><span class="main">=</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">bd</span><span class="main">.</span> <span class="main">(</span>card <span class="main">(</span><span class="main">(</span><span class="var">?ff</span><span class="main">-`</span><span class="main">{</span><span class="bound">m</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="free">S</span><span class="main">)</span> <span class="main">)</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s1</span> <span class="main">=</span><span class="var">?ss1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="var">?ff</span> <span class="main">-`</span><span class="main">{</span><span class="bound">m</span><span class="main">}</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> <span class="free">f</span><span class="main">-`</span><span class="main">{</span><span class="bound">m</span><span class="main">}</span> <span class="main">∩</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?s2</span> <span class="main">=</span> <span class="var">?ss2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span> <span class="main">.</span> <span class="var">?ff</span> <span class="bound">w</span> <span class="main">&lt;</span> <span class="free">bd</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?ss1</span> <span class="main">=</span> <span class="var">?ss2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum_vimage_proof<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?ff</span>"</span></span><span class="main">]</span> finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s1</span> <span class="main">=</span> <span class="var">?s2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒦_rw<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">w</span> <span class="main">∈</span> <span class="main">(</span>k_words <span class="free">k</span><span class="main">)</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="free">b</span><span class="main">^</span><span class="main">(</span>cw_len_concat <span class="bound">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">=</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span><span class="free">k</span><span class="main">*</span>max_len<span class="main">)</span><span class="main">.</span> card <span class="main">(</span>k_words <span class="free">k</span> <span class="main">∩</span>
<span class="main">(</span><span class="main">(</span>cw_len_concat<span class="main">)</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">m</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">b</span><span class="main">^</span><span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">∈</span> k_words <span class="free">k</span> <span class="main">⟹</span> cw_len_concat <span class="bound">w</span> <span class="main">&lt;</span> Suc <span class="main">(</span> <span class="free">k</span> <span class="main">*</span> max_len<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bound_len_concat le_imp_less_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span><span class="free">k</span> <span class="main">*</span> max_len<span class="main">)</span><span class="main">.</span>
  <span class="main">(</span>card <span class="main">(</span>cw_len_concat <span class="main">-`</span> <span class="main">{</span><span class="bound">m</span><span class="main">}</span> <span class="main">∩</span> k_words <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">b</span> <span class="main">^</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> Suc <span class="main">(</span><span class="free">k</span><span class="main">*</span>max_len<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_k_words
    sum_vimage<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"cw_len_concat"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> g <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">1</span><span class="main">/</span> <span class="main">(</span><span class="free">b</span><span class="main">^</span><span class="bound">i</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">set_of_k_words_length_m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'b</span> word set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">set_of_k_words_length_m</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">xk</span><span class="main">.</span> <span class="bound">xk</span> <span class="main">∈</span> k_words <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">}</span> <span class="main">∩</span> <span class="main">(</span>cw_len_concat<span class="main">)</span><span class="main">-`</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> am_inj_code<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">enc</span> <span class="main">(</span><span class="main">(</span>cw_len_concat<span class="main">)</span><span class="main">-`</span><span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">_</span> <span class="var">?s</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> inj_on_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">enc</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s</span>"</span></span><span class="main">]</span> real_code
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.inject<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> img_inc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">enc</span><span class="main">`</span>cw_len_concat<span class="main">-`</span><span class="main">{</span><span class="free">m</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">bl</span><span class="main">.</span> length <span class="bound">bl</span> <span class="main">=</span> <span class="free">m</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cw_len_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> bool_lists_card<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">bl</span><span class="main">::</span>bool list<span class="main">.</span> length <span class="bound">bl</span> <span class="main">=</span> <span class="free">m</span><span class="main">}</span> <span class="main">=</span> <span class="free">b</span><span class="main">^</span><span class="free">m</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> card_lists_length_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"UNIV<span class="main">::</span>bool set"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> b_val<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bool_list_fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">bl</span><span class="main">::</span>bool list<span class="main">.</span> length <span class="bound">bl</span> <span class="main">=</span> <span class="free">m</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_lists_length_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"UNIV<span class="main">::</span>bool set"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> b_val<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_of_k_words_bound<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set_of_k_words_length_m <span class="free">k</span> <span class="free">m</span><span class="main">)</span> <span class="main">≤</span> <span class="free">b</span><span class="main">^</span><span class="free">m</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">≤</span> <span class="var">?b</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> card_w_len_m_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>cw_len_concat<span class="main">-`</span><span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> <span class="free">b</span><span class="main">^</span><span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> am_inj_code bool_list_fin bool_lists_card card_image card_mono
    img_inc of_nat_le_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_of_k_words_length_m <span class="free">k</span> <span class="free">m</span> <span class="main">⊆</span> <span class="main">(</span>cw_len_concat<span class="main">)</span><span class="main">-`</span><span class="main">{</span><span class="free">m</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_of_k_words_length_m_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set_of_k_words_length_m <span class="free">k</span> <span class="free">m</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">(</span>cw_len_concat<span class="main">)</span><span class="main">-`</span><span class="main">{</span><span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> am_inj_code bool_list_fin card.infinite card_0_eq
    card_image card_mono empty_iff finite_subset img_inc inf_img_fin_dom<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> card_w_len_m_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> empty_set_k_words<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_of_k_words_length_m <span class="free">k</span> <span class="main">0</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> set_of_k_words_length_m <span class="free">k</span> <span class="main">0</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set_of_k_words_length_m <span class="free">k</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_of_k_words_length_m <span class="free">k</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_of_k_words_length_m_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cw_len_concat <span class="main">(</span>hd <span class="skolem">x</span><span class="main">#</span>tl <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> cw_len_concat <span class="main">(</span>tl <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> cw_len <span class="main">(</span>hd <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute comp_apply foldr.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">enc</span> <span class="main">[</span><span class="main">(</span>hd <span class="skolem">x</span><span class="main">)</span><span class="main">]</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms real_code <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> cw_len <span class="main">(</span>hd <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> code_word_length_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set_of_k_words_length_m <span class="free">k</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>set_of_k_words_length_m_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> x_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒦_rw2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">=</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="main">(</span><span class="free">k</span> <span class="main">*</span> max_len<span class="main">)</span><span class="main">.</span> card <span class="main">(</span>set_of_k_words_length_m <span class="free">k</span> <span class="bound">m</span><span class="main">)</span><span class="main">/</span> <span class="free">b</span><span class="main">^</span><span class="bound">m</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">k</span> <span class="main">*</span> max_len<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">=</span><span class="main">1</span><span class="main">..&lt;</span>Suc <span class="main">(</span><span class="free">k</span> <span class="main">*</span> max_len<span class="main">)</span><span class="main">.</span> card <span class="main">(</span>set_of_k_words_length_m <span class="free">k</span> <span class="bound">m</span><span class="main">)</span> <span class="main">/</span> <span class="free">b</span><span class="main">^</span><span class="bound">m</span><span class="main">)</span>
    <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">=</span><span class="main">1</span><span class="main">..&lt;</span>Suc<span class="main">(</span><span class="free">k</span> <span class="main">*</span> max_len<span class="main">)</span><span class="main">.</span> <span class="free">b</span><span class="main">^</span><span class="bound">m</span> <span class="main">/</span> <span class="free">b</span><span class="main">^</span><span class="bound">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> set_of_k_words_bound b_val
    Groups_Big.sum_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span><span class="main">..&lt;</span>Suc<span class="main">(</span><span class="free">k</span> <span class="main">*</span> max_len<span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span>card <span class="main">(</span>set_of_k_words_length_m <span class="free">k</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">/</span><span class="free">b</span><span class="main">^</span><span class="bound">m</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="free">b</span><span class="main">^</span><span class="bound">m</span> <span class="main">/</span><span class="free">b</span><span class="main">^</span><span class="bound">m</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">=</span><span class="main">1</span><span class="main">..&lt;</span>Suc<span class="main">(</span><span class="free">k</span> <span class="main">*</span> max_len<span class="main">)</span><span class="main">.</span> <span class="free">b</span><span class="main">^</span><span class="bound">m</span> <span class="main">/</span> <span class="free">b</span><span class="main">^</span><span class="bound">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">=</span><span class="main">1</span><span class="main">..&lt;</span>Suc<span class="main">(</span><span class="free">k</span> <span class="main">*</span>max_len<span class="main">)</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> b_gt_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span><span class="main">=</span><span class="main">1</span><span class="main">..&lt;</span>Suc<span class="main">(</span><span class="free">k</span> <span class="main">*</span> max_len<span class="main">)</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">k</span> <span class="main">*</span> max_len<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">..&lt;</span>Suc <span class="main">(</span><span class="free">k</span> <span class="main">*</span> max_len<span class="main">)</span><span class="main">.</span> card <span class="main">(</span>set_of_k_words_length_m <span class="free">k</span> <span class="bound">m</span><span class="main">)</span> <span class="main">/</span> <span class="free">b</span> <span class="main">^</span> <span class="bound">m</span><span class="main">)</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">*</span> max_len"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def card_atLeastLessThan card_eq_sum diff_Suc_Suc real_of_card<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> empty_set_k_words assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_shift_lb_Suc0_0_upt <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> 𝒦_power_bound <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">" 𝒦<span class="main">^</span><span class="free">k</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">*</span> max_len"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms 𝒦_power 𝒦_rw 𝒦_rw2
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_of_k_words_length_m_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> McMillan <span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"𝒦 <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> ineq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">⟹</span> 𝒦 <span class="main">≤</span> root <span class="bound">k</span> <span class="bound">k</span> <span class="main">*</span> root <span class="bound">k</span> max_len"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 𝒦_pos 𝒦_power_bound
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> not_less of_nat_0_le_iff of_nat_mult power_strict_mono real_root_mult real_root_pos_pos_le real_root_pos_unique real_root_power<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> max_len <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> root <span class="bound">k</span> <span class="bound">k</span> <span class="main">*</span> root <span class="bound">k</span> max_len<span class="main">)</span> <span class="main">⇢</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">tendsto_eq_intros</span></span> LIMSEQ_root LIMSEQ_root_const<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="main">1</span><span class="main">.</span> 𝒦 <span class="main">≤</span> root <span class="bound">n</span> <span class="bound">n</span> <span class="main">*</span> root <span class="bound">n</span> max_len"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ineq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"max_len <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> 𝒦 <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ineq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" 𝒦 <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LIMSEQ_le_const <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> entropy_rw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℋ(</span><span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> L<span class="main">.</span> <span class="free">fi</span> <span class="bound">i</span> <span class="main">*</span> log <span class="free">b</span> <span class="main">(</span><span class="free">fi</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> entropy_simple_distributed<span class="main">[</span><span class="operator">OF</span> distr_i<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹Technical lemmas about the logarithm›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> log_mult_ext3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">*</span> log <span class="free">b</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span><span class="main">*</span><span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> log <span class="free">b</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span><span class="main">)</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> log <span class="free">b</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">=</span><span class="main">0</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> log_mult_eq abs_of_pos distrib_left less_eq_real_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> log_mult_ext2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">*</span> log <span class="free">b</span> <span class="main">(</span><span class="free">x</span><span class="main">*</span><span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> log <span class="free">b</span> <span class="free">x</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> log <span class="free">b</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> log_mult_ext3<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹KL divergence and properties›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">KL_div</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">KL_div</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">i</span> <span class="main">*</span> log <span class="free">b</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">i</span> <span class="main">/</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> KL_div_mul<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">d</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">a</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">e</span> <span class="bound">i</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"KL_div <span class="free">S</span> <span class="free">a</span> <span class="free">e</span> <span class="main">≥</span> KL_div <span class="free">S</span> <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">e</span> <span class="bound">i</span> <span class="main">/</span> <span class="free">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> KL_div_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">∈</span><span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="skolem">i</span> <span class="main">/</span> <span class="main">(</span><span class="free">e</span> <span class="skolem">i</span> <span class="main">/</span> <span class="free">d</span><span class="main">)</span> <span class="main">≤</span> <span class="free">a</span> <span class="skolem">i</span> <span class="main">/</span> <span class="free">e</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> div_by_1 frac_le less_imp_triv not_less<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"log <span class="free">b</span> <span class="main">(</span><span class="free">a</span> <span class="skolem">i</span> <span class="main">/</span> <span class="main">(</span><span class="free">e</span> <span class="skolem">i</span> <span class="main">/</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> log <span class="free">b</span> <span class="main">(</span><span class="free">a</span> <span class="skolem">i</span> <span class="main">/</span> <span class="free">e</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> b_gt_1 divide_divide_eq_left inverse_divide le_less_linear log_le
    log_neg_const order_refl times_divide_eq_right zero_less_mult_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> log <span class="free">b</span> <span class="main">(</span><span class="free">a</span> <span class="bound">i</span> <span class="main">/</span> <span class="main">(</span><span class="free">e</span> <span class="bound">i</span> <span class="main">/</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> log <span class="free">b</span> <span class="main">(</span><span class="free">a</span> <span class="bound">i</span> <span class="main">/</span> <span class="free">e</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> mult_left_mono assms sum_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> KL_div_pos<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">e</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nemp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> non_null<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">e</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sum_a_one<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sum_c_one<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">e</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> KL_div <span class="free">S</span> <span class="free">a</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> KL_div_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">e</span> <span class="bound">i</span> <span class="main">/</span> <span class="free">a</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> f_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="var">?f</span> <span class="bound">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> non_null
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> a_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">a</span> <span class="bound">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> non_null
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order.strict_implies_order<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> log <span class="free">b</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">e</span> <span class="bound">i</span> <span class="main">/</span> <span class="free">a</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">-</span> log <span class="free">b</span> <span class="main">(</span><span class="free">e</span> <span class="bound">i</span> <span class="main">/</span> <span class="free">a</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> convex_on_sum<span class="main">[</span><span class="operator">OF</span> fin nemp  minus_log_convex<span class="main"><span class="main">[</span></span><span class="operator">OF</span> b_gt_1<span class="main"><span class="main">]</span></span> convex_real_interval<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
                             sum_a_one a_pos<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">e</span> <span class="bound">i</span> <span class="main">/</span> <span class="free">a</span> <span class="bound">i</span>"</span></span><span class="main">]</span> f_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span>log <span class="free">b</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">e</span> <span class="bound">i</span> <span class="main">/</span> <span class="free">a</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span>log <span class="free">b</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">e</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> non_null<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">e</span> <span class="bound">i</span> <span class="main">/</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">e</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">-</span> log <span class="free">b</span> <span class="main">(</span><span class="free">e</span> <span class="bound">i</span> <span class="main">/</span> <span class="free">a</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_c_one<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> log <span class="free">b</span> <span class="main">(</span><span class="free">a</span> <span class="bound">i</span> <span class="main">/</span> <span class="free">e</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> b_gt_1 log_divide non_null
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> KL_div_pos_emp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> KL_div <span class="main">{}</span> <span class="free">a</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> KL_div_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> KL_div_pos_gen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">d</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> non_null<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">d</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sum_a_one<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sum_d_one<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">d</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> KL_div <span class="free">S</span> <span class="free">a</span> <span class="free">d</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> KL_div_pos KL_div_pos_emp assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">theorem</span></span> KL_div_pos2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">d</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> non_null<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">a</span> <span class="bound">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">d</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sum_a_one<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sum_c_one<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">d</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> KL_div <span class="free">S</span> <span class="free">a</span> <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">=</span> <span class="free">a</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> non_null<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">=</span> <span class="free">a</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    eq<span class="main">:</span> <span class="quoted"><span class="quoted">"KL_div <span class="free">S</span> <span class="free">a</span> <span class="free">d</span> <span class="main">=</span> KL_div <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span> <span class="free">a</span> <span class="free">d</span> <span class="main">+</span> KL_div <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">=</span> <span class="free">a</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span> <span class="free">a</span> <span class="free">d</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> KL_div_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> fin finite_Un sum.union_disjoint<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"KL_div <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">=</span> <span class="free">a</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span> <span class="free">a</span> <span class="free">d</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> KL_div_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"KL_div <span class="free">S</span> <span class="free">a</span> <span class="free">d</span> <span class="main">=</span> KL_div <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span> <span class="free">a</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> KL_div <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span> <span class="free">a</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> KL_div_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">d</span> <span class="bound">i</span> <span class="main">/</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span> <span class="main">∈</span><span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="free">d</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">i</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">i</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="var">?c</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False IntD1 divide_pos_pos fin finite_Int non_null<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sum_pos<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span> <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sum.cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">S</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">i</span><span class="main">}</span> <span class="keyword1">then</span> <span class="free">a</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span>
      sum.inter_restrict<span class="main">[</span><span class="operator">OF</span> fin<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> non_null<span class="main">(</span>1<span class="main">)</span> sum_a_one
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">j</span><span class="main">}</span><span class="main">.</span> <span class="var">?c</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">j</span><span class="main">}</span><span class="main">.</span> <span class="free">d</span> <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">j</span><span class="main">}</span><span class="main">.</span> <span class="free">d</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sum_divide_distrib<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">j</span><span class="main">}</span><span class="main">.</span> <span class="var">?c</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 False <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> KL_div <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">j</span><span class="main">}</span><span class="main">)</span> <span class="free">a</span> <span class="var">?c</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> KL_div_pos_gen<span class="main">[</span>
      <span class="operator">OF</span> finite_Int<span class="main"><span class="main">[</span></span><span class="operator">OF</span> disjI1<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">S</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">j</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span>
      <span class="main">]</span> 1 2 3
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fin<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> fstdb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">i</span><span class="main">}</span><span class="main">.</span> <span class="free">d</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> non_null<span class="main">(</span>2<span class="main">)</span> False
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_Collect fin finite_Int sum_pos<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> KL_div <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span> <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">d</span> <span class="bound">i</span> <span class="main">/</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="free">d</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 2 3 5
        KL_div_pos_gen<span class="main">[</span>
      <span class="operator">OF</span> finite_Int<span class="main"><span class="main">[</span></span><span class="operator">OF</span> disjI1<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> fin<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">i</span><span class="main">}</span>"</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">a</span>"</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?c</span>"</span></span>
      <span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span>
      <span class="quoted"><span class="quoted">"KL_div <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">j</span><span class="main">}</span><span class="main">)</span> <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">d</span> <span class="bound">i</span> <span class="main">/</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="free">d</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> KL_div <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">j</span><span class="main">}</span><span class="main">)</span> <span class="free">a</span> <span class="free">d</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> non_null sum.inter_restrict<span class="main">[</span><span class="operator">OF</span> fin<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">d</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">i</span><span class="main">}</span>"</span></span><span class="main">]</span>
        sum_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">i</span><span class="main">}</span> <span class="keyword1">then</span> <span class="free">d</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">d</span></span><span class="main">]</span> non_null<span class="main">(</span>2<span class="main">)</span> sum_c_one
        non_null<span class="main">(</span>2<span class="main">)</span> fstdb KL_div_mul
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> KL_div <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">j</span><span class="main">}</span><span class="main">)</span> <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">d</span> <span class="bound">i</span> <span class="main">/</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="free">d</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> KL_div_pos_gen<span class="main">[</span> <span class="operator">OF</span> finite_Int<span class="main"><span class="main">[</span></span><span class="operator">OF</span> disjI1<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> fin<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> 2 3 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> KL_div <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">a</span> <span class="bound">j</span><span class="main">}</span><span class="main">)</span> <span class="free">a</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_div_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">::</span>field"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">/</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> assms right_inverse_eq sum_divide_distrib<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> rate_lower_bound<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℋ(</span><span class="free">X</span><span class="main">)</span> <span class="main">≤</span> code_rate <span class="free">enc</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cr</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"code_rate <span class="free">enc</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="main">(</span><span class="free">b</span> <span class="keyword1">powr</span> cw_len <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> 𝒦<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> pos_pi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> L <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">fi</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fi_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> L"</span></span>
    <span class="keyword1"><span class="command">hence</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">fi</span> <span class="skolem">i</span> <span class="main">*</span> <span class="main">(</span>log <span class="free">b</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">b</span> <span class="keyword1">powr</span> <span class="main">(</span>cw_len <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> log <span class="free">b</span> <span class="main">(</span><span class="free">fi</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> <span class="free">fi</span> <span class="skolem">i</span> <span class="main">*</span> log <span class="free">b</span> <span class="main">(</span><span class="free">fi</span> <span class="skolem">i</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">b</span> <span class="keyword1">powr</span> <span class="main">(</span>cw_len <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> log_mult_ext2 <span class="main">[</span><span class="operator">OF</span> pos_pi<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> b_gt_1
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">hence</span></span> eqpi<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span> L <span class="main">⟹</span> <span class="free">fi</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span>log <span class="free">b</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">b</span> <span class="keyword1">powr</span> <span class="main">(</span>cw_len <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> log <span class="free">b</span> <span class="main">(</span><span class="free">fi</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>
    <span class="main">=</span> <span class="free">fi</span> <span class="bound">i</span> <span class="main">*</span> log <span class="free">b</span> <span class="main">(</span><span class="free">fi</span> <span class="bound">i</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">b</span> <span class="keyword1">powr</span> <span class="main">(</span>cw_len <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> sum_one_L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">∈</span> L<span class="main">.</span> <span class="free">fi</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> simple_distributed_sum_space<span class="main">[</span><span class="operator">OF</span> distr_i<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L_def<span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> L"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> h1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">fi</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pos_pi <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> h2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> 𝒦 <span class="main">/</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="free">b</span> <span class="keyword1">powr</span> cw_len <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b_gt_1 𝒦_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> h3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">/</span> 𝒦"</span></span> <span class="keyword1"><span class="command">using</span></span> 𝒦_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">fi</span> <span class="skolem">i</span> <span class="main">*</span> log <span class="free">b</span> <span class="main">(</span><span class="free">fi</span> <span class="skolem">i</span> <span class="main">*</span> 𝒦 <span class="main">/</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="free">b</span> <span class="keyword1">powr</span> cw_len <span class="skolem">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span> 𝒦<span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="free">fi</span> <span class="skolem">i</span> <span class="main">*</span> log <span class="free">b</span> <span class="main">(</span><span class="free">fi</span> <span class="skolem">i</span> <span class="main">*</span> 𝒦 <span class="main">/</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="free">b</span> <span class="keyword1">powr</span> cw_len <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">fi</span> <span class="skolem">i</span> <span class="main">*</span> log <span class="free">b</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span> 𝒦<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> log_mult_ext3<span class="main">[</span><span class="operator">OF</span> h1 h2 h3<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> times_divide_eq_right<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">hence</span></span> big_eq<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> L <span class="main">⟹</span> <span class="free">fi</span> <span class="bound">i</span> <span class="main">*</span> log <span class="free">b</span> <span class="main">(</span><span class="free">fi</span> <span class="bound">i</span> <span class="main">*</span> 𝒦 <span class="main">/</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="free">b</span> <span class="keyword1">powr</span> cw_len <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> 𝒦<span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="free">fi</span> <span class="bound">i</span> <span class="main">*</span> log <span class="free">b</span> <span class="main">(</span><span class="free">fi</span> <span class="bound">i</span> <span class="main">*</span> 𝒦 <span class="main">/</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="free">b</span> <span class="keyword1">powr</span> cw_len <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">fi</span> <span class="bound">i</span> <span class="main">*</span> log <span class="free">b</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> 𝒦<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inverse_eq_divide<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?cr</span> <span class="main">-</span> <span class="keyword1">ℋ(</span><span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> L<span class="main">.</span> <span class="free">fi</span> <span class="bound">i</span> <span class="main">*</span> cw_len <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> L<span class="main">.</span> <span class="free">fi</span> <span class="bound">i</span> <span class="main">*</span> log <span class="free">b</span> <span class="main">(</span><span class="free">fi</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 𝒦_def entropy_rw cr_rw L_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>L<span class="main">.</span> <span class="free">fi</span> <span class="bound">i</span> <span class="main">*</span> cw_len <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> L<span class="main">.</span> <span class="free">fi</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span>log <span class="free">b</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="main">(</span><span class="free">b</span> <span class="keyword1">powr</span> <span class="main">(</span>cw_len <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> b_gt_1 log_divide <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> L<span class="main">.</span> <span class="free">fi</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span>log <span class="free">b</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="main">(</span><span class="free">b</span> <span class="keyword1">powr</span> <span class="main">(</span>cw_len <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sum_distrib_left<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">fi</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span> <span class="main">1</span> <span class="main">*</span> log <span class="free">b</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">b</span> <span class="keyword1">powr</span> <span class="main">(</span>cw_len <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted">L</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="var">?cr</span> <span class="main">-</span> <span class="keyword1">ℋ(</span><span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> L<span class="main">.</span> <span class="free">fi</span> <span class="bound">i</span> <span class="main">*</span> log <span class="free">b</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="free">b</span> <span class="keyword1">powr</span> cw_len <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> L<span class="main">.</span> <span class="free">fi</span> <span class="bound">i</span> <span class="main">*</span> log <span class="free">b</span> <span class="main">(</span><span class="free">fi</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?cr</span> <span class="main">-</span> <span class="keyword1">ℋ(</span><span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> L<span class="main">.</span> <span class="free">fi</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>log <span class="free">b</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="main">(</span><span class="free">b</span> <span class="keyword1">powr</span> <span class="main">(</span>cw_len <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> log <span class="free">b</span> <span class="main">(</span><span class="free">fi</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> b_gt_1 1
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left sum.distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> L<span class="main">.</span> <span class="free">fi</span> <span class="bound">i</span> <span class="main">*</span><span class="main">(</span><span class="main">(</span>log <span class="free">b</span> <span class="main">(</span><span class="free">fi</span> <span class="bound">i</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="main">(</span><span class="free">b</span> <span class="keyword1">powr</span> <span class="main">(</span>cw_len <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Finite_Cartesian_Product.sum_cong_aux<span class="main">[</span><span class="operator">OF</span> eqpi<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> big_eq <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>L<span class="main">.</span> <span class="free">fi</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span>log <span class="free">b</span> <span class="main">(</span><span class="free">fi</span> <span class="bound">i</span> <span class="main">*</span> 𝒦 <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">b</span> <span class="keyword1">powr</span> <span class="main">(</span>cw_len <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">∈</span> L<span class="main">.</span> <span class="free">fi</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> log <span class="free">b</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span> 𝒦<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 𝒦_pos
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_right sum.distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>L<span class="main">.</span> <span class="free">fi</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span>log <span class="free">b</span> <span class="main">(</span><span class="free">fi</span> <span class="bound">i</span> <span class="main">*</span> 𝒦 <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">b</span> <span class="keyword1">powr</span> <span class="main">(</span>cw_len <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> log <span class="free">b</span> <span class="main">(</span>𝒦<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 𝒦_pos
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> log_inverse_eq divide_inverse sum_one_L<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">i</span> <span class="main">∈</span> L<span class="main">.</span> <span class="free">fi</span> <span class="bound">i</span> <span class="main">*</span> log <span class="free">b</span> <span class="main">(</span><span class="free">fi</span> <span class="bound">i</span> <span class="main">/</span> <span class="var">?r</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> log <span class="free">b</span> <span class="main">(</span>𝒦<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> divide_divide_eq_left divide_divide_eq_right<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> KL_div L <span class="free">fi</span> <span class="var">?r</span> <span class="main">-</span> log <span class="free">b</span> <span class="main">(</span> 𝒦<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> b_gt_1 𝒦_pos log_inverse KL_div_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> KL_div L <span class="free">fi</span> <span class="var">?r</span> <span class="main">+</span> log <span class="free">b</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> 𝒦<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> log_inverse b_val 𝒦_pos
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inverse_eq_divide<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> code_ent_kl_log<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?cr</span> <span class="main">-</span> <span class="keyword1">ℋ(</span><span class="free">X</span><span class="main">)</span> <span class="main">=</span> KL_div L <span class="free">fi</span> <span class="var">?r</span> <span class="main">+</span> log <span class="free">b</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> 𝒦<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>L<span class="main">.</span> <span class="var">?r</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sum_div_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">1</span> <span class="main">/</span> <span class="main">(</span><span class="free">b</span> <span class="keyword1">powr</span> <span class="main">(</span>cw_len <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span> 𝒦_pos 𝒦_pow
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="var">?r</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b_gt_1 𝒦_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span>L<span class="main">.</span> <span class="free">fi</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum_one_L <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> KL_div L <span class="free">fi</span> <span class="var">?r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> KL_div_pos2<span class="main">[</span><span class="operator">OF</span> fin_L fi_pos<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"log <span class="free">b</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> 𝒦<span class="main">)</span> <span class="main">≤</span> <span class="var">?cr</span> <span class="main">-</span> <span class="keyword1">ℋ(</span><span class="free">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> code_ent_kl_log <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> McMillan <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> log <span class="free">b</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> 𝒦<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 𝒦_pos
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> b_gt_1<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>