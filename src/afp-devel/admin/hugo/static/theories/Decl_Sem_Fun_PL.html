<div id="Lambda">
<div class="head">
<h1>Theory Lambda</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Syntax of the lambda calculus"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lambda
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">type_synonym</span></span> name <span class="main">=</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">datatype</span></span> exp <span class="main">=</span> EVar <span class="quoted">name</span> <span class="main">|</span> ENat <span class="quoted">nat</span> <span class="main">|</span> ELam <span class="quoted">name</span> <span class="quoted">exp</span> <span class="main">|</span> EApp <span class="quoted">exp</span> <span class="quoted">exp</span>
  <span class="main">|</span> EPrim <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="quoted">exp</span> <span class="quoted">exp</span> <span class="main">|</span> EIf <span class="quoted">exp</span> <span class="quoted">exp</span> <span class="quoted">exp</span>
      
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lookup</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> None"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">lookup</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">else</span> <span class="free">lookup</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">FV</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">FV</span> <span class="main">(</span>EVar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">FV</span> <span class="main">(</span>ENat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">FV</span> <span class="main">(</span>ELam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">FV</span> <span class="main">(</span>EApp <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">∪</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">FV</span> <span class="main">(</span>EPrim <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">∪</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">FV</span> <span class="main">(</span>EIf <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">∪</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">∪</span> <span class="free">FV</span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">BV</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">BV</span> <span class="main">(</span>EVar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">BV</span> <span class="main">(</span>ENat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">BV</span> <span class="main">(</span>ELam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">BV</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">BV</span> <span class="main">(</span>EApp <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">BV</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">∪</span> <span class="free">BV</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">BV</span> <span class="main">(</span>EPrim <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">BV</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">∪</span> <span class="free">BV</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">BV</span> <span class="main">(</span>EIf <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">BV</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">∪</span> <span class="free">BV</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">∪</span> <span class="free">BV</span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SmallStepLam">
<div class="head">
<h1>Theory SmallStepLam</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Small-step semantics of CBV lambda calculus›</span></span>

<span class="keyword1"><span class="command">theory</span></span> SmallStepLam
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Lambda.html">Lambda</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  The following substitution function is not capture avoiding, so it has a precondition
  that $v$ is closed. With hindsight, we should have used DeBruijn indices instead
  because we also use substitution in the optimizing compiler.
›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name <span class="main">⇒</span> exp <span class="main">⇒</span> exp <span class="main">⇒</span> exp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>EVar <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">else</span> EVar <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>ENat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> ENat <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>ELam <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> ELam <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">else</span> ELam <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span><span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>EApp <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> EApp <span class="main">(</span><span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>EPrim <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> EPrim <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>EIf <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span><span class="main">)</span> <span class="main">=</span> EIf <span class="main">(</span><span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">isval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  valnat<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">isval</span> <span class="main">(</span>ENat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  vallam<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">isval</span> <span class="main">(</span>ELam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span>
  isval_var_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"isval <span class="main">(</span>EVar <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  isval_app_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"isval <span class="main">(</span>EApp <span class="free">e1</span> <span class="free">e2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  isval_prim_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"isval <span class="main">(</span>EPrim <span class="free">f</span> <span class="free">e1</span> <span class="free">e2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  isval_if_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"isval <span class="main">(</span>EIf <span class="free">e1</span> <span class="free">e2</span> <span class="free">e3</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_val</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_val</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> isval <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∧</span> FV <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> is_val_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">reduce</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> exp <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⟶</span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  beta<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> is_val <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> EApp <span class="main">(</span>ELam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="main">(</span>subst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  app_left<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">e1'</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> EApp <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⟶</span></span> EApp <span class="free"><span class="bound"><span class="entity">e1'</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span> <span class="main">|</span>
  app_right<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">e2'</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> EApp <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⟶</span></span> EApp <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2'</span></span></span>"</span></span> <span class="main">|</span>
  delta<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"EPrim <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>ENat <span class="free"><span class="bound"><span class="entity">n1</span></span></span><span class="main">)</span> <span class="main">(</span>ENat <span class="free"><span class="bound"><span class="entity">n2</span></span></span><span class="main">)</span> <span class="main"><span class="free">⟶</span></span> ENat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  prim_left<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">e1'</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> EPrim <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⟶</span></span> EPrim <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e1'</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span> <span class="main">|</span>
  prim_right<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">e2'</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> EPrim <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⟶</span></span> EPrim <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2'</span></span></span>"</span></span> <span class="main">|</span>
  if_zero<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"EIf <span class="main">(</span>ENat <span class="main">0</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">thn</span></span></span> <span class="free"><span class="bound"><span class="entity">els</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">els</span></span></span>"</span></span> <span class="main">|</span>
  if_nz<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> EIf <span class="main">(</span>ENat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">thn</span></span></span> <span class="free"><span class="bound"><span class="entity">els</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">thn</span></span></span>"</span></span> <span class="main">|</span>
  if_cond<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="main"><span class="free">⟶</span></span> <span class="free"><span class="bound"><span class="entity">cond'</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> 
    EIf <span class="free"><span class="bound"><span class="entity">cond</span></span></span> <span class="free"><span class="bound"><span class="entity">thn</span></span></span> <span class="free"><span class="bound"><span class="entity">els</span></span></span> <span class="main"><span class="free">⟶</span></span> EIf <span class="free"><span class="bound"><span class="entity">cond'</span></span></span> <span class="free"><span class="bound"><span class="entity">thn</span></span></span> <span class="free"><span class="bound"><span class="entity">els</span></span></span>"</span></span> 

<span class="keyword1"><span class="command">inductive_cases</span></span>
  red_var_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"EVar <span class="free">x</span> <span class="main">⟶</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  red_int_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ENat <span class="free">n</span> <span class="main">⟶</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  red_lam_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ELam <span class="free">x</span> <span class="free">e</span> <span class="main">⟶</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  red_app_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"EApp <span class="free">e1</span> <span class="free">e2</span> <span class="main">⟶</span> <span class="free">e'</span>"</span></span>
  
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">multi_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> exp <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⟶*</span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  ms_nil<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⟶*</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span> <span class="main">|</span>
  ms_cons<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⟶*</span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">⟶*</span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">diverge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">diverge</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">e'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⟶*</span> <span class="bound">e'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">e''</span><span class="main">.</span> <span class="bound">e'</span> <span class="main">⟶</span> <span class="bound">e''</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">stuck</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">stuck</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">e'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⟶</span> <span class="bound">e'</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">declare</span></span> stuck_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">goes_wrong</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">goes_wrong</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> <span class="main">∃</span> <span class="bound">e'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⟶*</span> <span class="bound">e'</span> <span class="main">∧</span> stuck <span class="bound">e'</span> <span class="main">∧</span> <span class="main">¬</span> isval <span class="bound">e'</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> goes_wrong_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">datatype</span></span> obs <span class="main">=</span> ONat <span class="quoted">nat</span> <span class="main">|</span> OFun <span class="main">|</span> OBad

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">observe</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> obs <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">observe</span> <span class="main">(</span>ENat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>ONat <span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">observe</span> <span class="main">(</span>ELam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> OFun <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">observe</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ob</span></span></span> <span class="main">=</span> False"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">run</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> obs <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⇓</span>"</span> 52<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">run</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ob</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⟶*</span> <span class="bound">v</span> <span class="main">∧</span> observe <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">ob</span></span></span><span class="main">)</span>
              <span class="main">∨</span> <span class="main">(</span><span class="main">(</span>diverge <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∨</span> goes_wrong <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">ob</span></span></span> <span class="main">=</span> OBad<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="SmallStepLam-val_stuck"><span class="command">lemma</span></span> val_stuck<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span><span class="main">::</span><span class="quoted">exp</span> <span class="keyword2"><span class="keyword">assumes</span></span> val_e<span class="main">:</span> <span class="quoted"><span class="quoted">"isval <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stuck <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> stuck <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="keyword2"><span class="keyword">where</span></span> red<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⟶</span> <span class="skolem">e'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> val_e red <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SmallStepLam-subst_fv_aux"><span class="command">lemma</span></span> subst_fv_aux<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> fvv<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="free">v</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FV <span class="main">(</span>subst <span class="free">x</span> <span class="free">v</span> <span class="free">e</span><span class="main">)</span> <span class="main">⊆</span> FV <span class="free">e</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fvv
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exp.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>EVar <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ENat <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ELam <span class="skolem">y</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    
<span class="keyword1" id="SmallStepLam-subst_fv"><span class="command">lemma</span></span> subst_fv<span class="main">:</span>  <span class="keyword2"><span class="keyword">assumes</span></span> fv_e<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="free">e</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fv_v<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="free">v</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FV <span class="main">(</span>subst <span class="free">x</span> <span class="free">v</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fv_e fv_v subst_fv_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
<span class="keyword1" id="SmallStepLam-red_pres_fv"><span class="command">lemma</span></span> red_pres_fv<span class="main">:</span>  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span><span class="main">::</span><span class="quoted">exp</span> <span class="keyword2"><span class="keyword">assumes</span></span> red<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⟶</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fv<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="free">e</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FV <span class="free">e'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> red fv
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reduce.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">v</span> <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_fv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    
<span class="keyword1" id="SmallStepLam-reduction_pres_fv"><span class="command">lemma</span></span> reduction_pres_fv<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span><span class="main">::</span><span class="quoted">exp</span> <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⟶*</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fv<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="free">e</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"FV <span class="free">e'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r fv
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ms_nil <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ms_cons <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e3</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> red_pres_fv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="BigStepLam">
<div class="head">
<h1>Theory BigStepLam</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Big-step semantics of CBV lambda calculus"</span></span>

<span class="keyword1"><span class="command">theory</span></span> BigStepLam
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Lambda.html">Lambda</a> <a href="SmallStepLam.html">SmallStepLam</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> bval
  <span class="main">=</span> BNat <span class="quoted">nat</span>
  <span class="main">|</span> BClos <span class="quoted">name</span> <span class="quoted">exp</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> bval<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> benv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> bval<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">eval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"benv <span class="main">⇒</span> exp <span class="main">⇒</span> bval <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">⇓</span> _"</span> <span class="main">[</span>50<span class="main">,</span>50<span class="main">,</span>50<span class="main">]</span> 51<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  eval_nat<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> ENat <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">⇓</span></span> BNat <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> <span class="main">|</span>
  eval_var<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> EVar <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">⇓</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span> <span class="main">|</span>
  eval_lam<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> ELam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇓</span></span> BClos <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span>"</span></span> <span class="main">|</span>
  eval_app<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">⇓</span></span> BClos <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ'</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⇓</span></span> <span class="free"><span class="bound"><span class="entity">arg</span></span></span><span class="main">;</span>
                       <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">arg</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ρ'</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇓</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> 
                      <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> EApp <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⇓</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span> <span class="main">|</span>
  eval_prim<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">⇓</span></span> BNat <span class="free"><span class="bound"><span class="entity">n1</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⇓</span></span> BNat <span class="free"><span class="bound"><span class="entity">n2</span></span></span> <span class="main">;</span> <span class="free"><span class="bound"><span class="entity">n3</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span><span class="main">⟧</span> <span class="main">⟹</span>
                       <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> EPrim <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⇓</span></span> BNat <span class="free"><span class="bound"><span class="entity">n3</span></span></span>"</span></span> <span class="main">|</span>
  eval_if0<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">⇓</span></span> BNat <span class="main">0</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span> <span class="main"><span class="free">⇓</span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> 
                      <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> EIf <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span> <span class="main"><span class="free">⇓</span></span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span>"</span></span> <span class="main">|</span>
  eval_if1<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">⇓</span></span> BNat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≠</span> <span class="main">0</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⇓</span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span>
                      <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> EIf <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span> <span class="main"><span class="free">⇓</span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> 
  eval_nat_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">⊢</span> ENat <span class="free">n</span> <span class="main">⇓</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  eval_var_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">⊢</span> EVar <span class="free">x</span> <span class="main">⇓</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  eval_lam_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">⊢</span> ELam <span class="free">x</span> <span class="free">e</span> <span class="main">⇓</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  eval_app_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">⊢</span> EApp <span class="free">e1</span> <span class="free">e2</span> <span class="main">⇓</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  eval_prim_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">⊢</span> EPrim <span class="free">f</span> <span class="free">e1</span> <span class="free">e2</span> <span class="main">⇓</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  eval_if_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">⊢</span> EIf <span class="free">e1</span> <span class="free">e2</span> <span class="free">e3</span> <span class="main">⇓</span> <span class="free">v</span>"</span></span> 

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Big-step semantics is sound wrt. small-step semantics"</span></span>
  
<span class="keyword1"><span class="command">type_synonym</span></span> env <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> exp<span class="main">)</span> list"</span></span>   
  
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">psubst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"env <span class="main">⇒</span> exp <span class="main">⇒</span> exp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">psubst</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">(</span>ENat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> ENat <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">psubst</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">(</span>EVar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> 
     <span class="main">(</span><span class="keyword1">case</span> lookup <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span>
       None <span class="main">⇒</span> EVar <span class="free"><span class="bound"><span class="entity">x</span></span></span>
     <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="bound">v</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">psubst</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">(</span>ELam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> ELam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">psubst</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span>EVar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">psubst</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">(</span>EApp <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> EApp <span class="main">(</span><span class="free">psubst</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">psubst</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">psubst</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">(</span>EPrim <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">=</span> EPrim <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free">psubst</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">psubst</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">psubst</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">(</span>EIf <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span><span class="main">)</span> <span class="main">=</span> EIf <span class="main">(</span><span class="free">psubst</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">psubst</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">psubst</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span><span class="main">)</span>"</span></span> 


<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">bs_val</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bval <span class="main">⇒</span> exp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  <span class="entity">bs_env</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"benv <span class="main">⇒</span> env <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  bs_nat<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bs_val</span> <span class="main">(</span>BNat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>ENat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  bs_clos<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">bs_env</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ'</span></span></span><span class="main">;</span> FV <span class="main">(</span>ELam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>psubst <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span>EVar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ρ'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span> 
                    <span class="free">bs_val</span> <span class="main">(</span>BClos <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span> <span class="main">(</span>ELam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>psubst <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span>EVar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ρ'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>  
  bs_nil<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bs_env</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  bs_cons<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">bs_val</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">;</span> <span class="free">bs_env</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ'</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">bs_env</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ρ'</span></span></span><span class="main">)</span>"</span></span> 
  
<span class="keyword1"><span class="command">inductive_cases</span></span> bs_env_inv1<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bs_env <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">w</span><span class="main">)</span> <span class="main">#</span> <span class="free">ρ</span><span class="main">)</span> <span class="free">ρ'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  bs_clos_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bs_val <span class="main">(</span>BClos <span class="free">x</span> <span class="free">e</span> <span class="free">ρ''</span><span class="main">)</span> <span class="free">v1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  bs_nat_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bs_val <span class="main">(</span>BNat <span class="free">n</span><span class="main">)</span> <span class="free">v</span>"</span></span>
  
<span class="keyword1" id="BigStepLam-bs_val_is_val"><span class="command">lemma</span></span> bs_val_is_val<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bs_val <span class="free">w</span> <span class="free">v</span> <span class="main">⟹</span> is_val <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="operator">auto</span>
  
<span class="keyword1" id="BigStepLam-lookup_bs_env"><span class="command">lemma</span></span> lookup_bs_env<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bs_env <span class="free">ρ</span> <span class="free">ρ'</span><span class="main">;</span> lookup <span class="free">ρ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">w</span> <span class="main">⟧</span> <span class="main">⟹</span> 
  <span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> lookup <span class="free">ρ'</span> <span class="free">x</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">∧</span> bs_val <span class="free">w</span> <span class="bound">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ρ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ρ'</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="operator">auto</span> 

<span class="keyword1" id="BigStepLam-app_red_cong1"><span class="command">lemma</span></span> app_red_cong1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">⟶*</span> <span class="free">e1'</span> <span class="main">⟹</span> EApp <span class="free">e1</span> <span class="free">e2</span> <span class="main">⟶*</span> EApp <span class="free">e1'</span> <span class="free">e2</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> multi_step.induct<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>  

<span class="keyword1" id="BigStepLam-app_red_cong2"><span class="command">lemma</span></span> app_red_cong2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e2</span> <span class="main">⟶*</span> <span class="free">e2'</span> <span class="main">⟹</span> EApp <span class="free">e1</span> <span class="free">e2</span> <span class="main">⟶*</span> EApp <span class="free">e1</span> <span class="free">e2'</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> multi_step.induct<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span> 
    
<span class="keyword1" id="BigStepLam-prim_red_cong1"><span class="command">lemma</span></span> prim_red_cong1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">⟶*</span> <span class="free">e1'</span> <span class="main">⟹</span> EPrim <span class="free">f</span> <span class="free">e1</span> <span class="free">e2</span> <span class="main">⟶*</span> EPrim <span class="free">f</span> <span class="free">e1'</span> <span class="free">e2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> multi_step.induct<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    
<span class="keyword1" id="BigStepLam-prim_red_cong2"><span class="command">lemma</span></span> prim_red_cong2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e2</span> <span class="main">⟶*</span> <span class="free">e2'</span> <span class="main">⟹</span> EPrim <span class="free">f</span> <span class="free">e1</span> <span class="free">e2</span> <span class="main">⟶*</span> EPrim <span class="free">f</span> <span class="free">e1</span> <span class="free">e2'</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> multi_step.induct<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span> 

<span class="keyword1" id="BigStepLam-if_red_cong1"><span class="command">lemma</span></span> if_red_cong1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">⟶*</span> <span class="free">e1'</span> <span class="main">⟹</span> EIf <span class="free">e1</span> <span class="free">e2</span> <span class="free">e3</span> <span class="main">⟶*</span> EIf <span class="free">e1'</span> <span class="free">e2</span> <span class="free">e3</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> multi_step.induct<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="BigStepLam-multi_step_trans"><span class="command">lemma</span></span> multi_step_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">e1</span> <span class="main">⟶*</span> <span class="free">e2</span><span class="main">;</span> <span class="free">e2</span> <span class="main">⟶*</span> <span class="free">e3</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">e1</span> <span class="main">⟶*</span> <span class="free">e3</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">e3</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> multi_step.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ms_cons <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e3</span> <span class="skolem">e3'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e2</span> <span class="main">⟶*</span> <span class="skolem">e3'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> ms_cons<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">blast</span>
    
<span class="keyword1" id="BigStepLam-subst_id_fv"><span class="command">lemma</span></span> subst_id_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> FV <span class="free">e</span> <span class="main">⟹</span> subst <span class="free">x</span> <span class="free">v</span> <span class="free">e</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sdom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"env <span class="main">⇒</span> name set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sdom</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> lookup <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">≠</span> EVar <span class="bound">x</span> <span class="main">}</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">closed_env</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"env <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closed_env</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> sdom <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">⟶</span> lookup <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟶</span> FV <span class="bound">v</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">equiv_env</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"env <span class="main">⇒</span> env <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">equiv_env</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ'</span></span></span> <span class="main">≡</span> <span class="main">(</span>sdom <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> sdom <span class="free"><span class="bound"><span class="entity">ρ'</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> sdom <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">⟶</span> lookup <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="bound">x</span> <span class="main">=</span> lookup <span class="free"><span class="bound"><span class="entity">ρ'</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="BigStepLam-sdom_cons_xx"><span class="command">lemma</span></span> sdom_cons_xx<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sdom <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span>EVar <span class="free">x</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span> <span class="main">=</span> sdom <span class="free">ρ</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> sdom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BigStepLam-sdom_cons_v"><span class="command">lemma</span></span> sdom_cons_v<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="free">v</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> sdom <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">x</span> <span class="main">(</span>sdom <span class="free">ρ</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> sdom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BigStepLam-lookup_some_in_dom"><span class="command">lemma</span></span> lookup_some_in_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> lookup <span class="free">ρ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">;</span> <span class="free">v</span> <span class="main">≠</span> EVar <span class="free">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> sdom <span class="free">ρ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ρ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">ρ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">y</span> <span class="skolem">v'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sdom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="BigStepLam-lookup_none_notin_dom"><span class="command">lemma</span></span> lookup_none_notin_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="free">ρ</span> <span class="free">x</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> sdom <span class="free">ρ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ρ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">ρ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">y</span> <span class="skolem">v</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sdom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sdom_def<span class="main">)</span>
  
<span class="keyword1" id="BigStepLam-psubst_change"><span class="command">lemma</span></span> psubst_change<span class="main">:</span> <span class="quoted"><span class="quoted">"equiv_env <span class="free">ρ</span> <span class="free">ρ'</span> <span class="main">⟹</span> psubst <span class="free">ρ</span> <span class="free">e</span> <span class="main">=</span> psubst <span class="free">ρ'</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ρ</span></span> <span class="quoted"><span class="free">ρ'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>EVar <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lookup <span class="skolem">ρ</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None <span class="keyword1"><span class="command">from</span></span> None <span class="keyword1"><span class="command">have</span></span> lx<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="skolem">ρ</span> <span class="skolem">x</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lookup <span class="skolem">ρ'</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">with</span></span> EVar lx <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">v</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> EVar lx Some <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> sdom <span class="skolem">ρ'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> equiv_env_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> lx Some <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sdom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">v</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> Some <span class="keyword1"><span class="command">have</span></span> lx<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="skolem">ρ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lookup <span class="skolem">ρ'</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">from</span></span> EVar lx None <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> sdom <span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> equiv_env_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> None Some <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sdom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">v'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> EVar Some lx <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> equiv_env_def sdom_def<span class="main">)</span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ELam <span class="skolem">x'</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ELam<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equiv_env <span class="main">(</span><span class="main">(</span><span class="skolem">x'</span><span class="main">,</span>EVar <span class="skolem">x'</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x'</span><span class="main">,</span>EVar <span class="skolem">x'</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> equiv_env_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ELam <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> equiv_env_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="BigStepLam-subst_psubst"><span class="command">lemma</span></span> subst_psubst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> closed_env <span class="free">ρ</span><span class="main">;</span> FV <span class="free">v</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span> 
    subst <span class="free">x</span> <span class="free">v</span> <span class="main">(</span>psubst <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> EVar <span class="free">x</span><span class="main">)</span> <span class="main">#</span> <span class="free">ρ</span><span class="main">)</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> psubst <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="free">ρ</span><span class="main">)</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">ρ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>EVar <span class="skolem">x</span> <span class="skolem">x'</span> <span class="skolem">v</span> <span class="skolem">ρ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> xxp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">x'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lookup <span class="skolem">ρ</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">v'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> EVar <span class="skolem">x</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> Some <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">from</span></span> False Some <span class="keyword1"><span class="command">have</span></span> xdom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> sdom <span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lookup_some_in_dom <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> this EVar Some <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FV <span class="skolem">v'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> closed_env_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> this Some <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_id_fv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ELam <span class="skolem">x'</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> psubst_change<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> equiv_env_def sdom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> x_xp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">x'</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x'</span><span class="main">,</span>EVar <span class="skolem">x'</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> ELam <span class="keyword1"><span class="command">have</span></span> IHprem<span class="main">:</span> <span class="quoted"><span class="quoted">"closed_env <span class="main">(</span><span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> EVar <span class="skolem">x'</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> closed_env_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>          
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"psubst <span class="main">(</span><span class="main">(</span><span class="skolem">x'</span><span class="main">,</span>EVar <span class="skolem">x'</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> EVar <span class="skolem">x</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">e</span> <span class="main">=</span> psubst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span>EVar <span class="skolem">x</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="skolem">x'</span><span class="main">,</span>EVar <span class="skolem">x'</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> psubst_change<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> x_xp equiv_env_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst <span class="skolem">x</span> <span class="skolem">v</span> <span class="main">(</span>psubst <span class="main">(</span><span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> EVar <span class="skolem">x'</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> EVar <span class="skolem">x</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span>
                       <span class="main">=</span> subst <span class="skolem">x</span> <span class="skolem">v</span> <span class="main">(</span>psubst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span>EVar <span class="skolem">x</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="skolem">x'</span><span class="main">,</span>EVar <span class="skolem">x'</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>         
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> ELam IHprem <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> psubst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="skolem">x'</span><span class="main">,</span>EVar <span class="skolem">x'</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ELam<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x'</span><span class="main">,</span>EVar <span class="skolem">x'</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span>"</span></span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> psubst <span class="main">(</span><span class="main">(</span><span class="skolem">x'</span><span class="main">,</span>EVar <span class="skolem">x'</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> psubst_change<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> x_xp equiv_env_def sdom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subst <span class="skolem">x</span> <span class="skolem">v</span> <span class="main">(</span>psubst <span class="main">(</span><span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> EVar <span class="skolem">x'</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> EVar <span class="skolem">x</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span>
                    <span class="main">=</span> psubst <span class="main">(</span><span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> EVar <span class="skolem">x'</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> bsenv_nil<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bs_env <span class="main">[]</span> <span class="free">ρ'</span>"</span></span> 
 
<span class="keyword1" id="BigStepLam-bs_env_dom"><span class="command">lemma</span></span> bs_env_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"bs_env <span class="free">ρ</span> <span class="free">ρ'</span> <span class="main">⟹</span> set <span class="main">(</span>map fst <span class="free">ρ</span><span class="main">)</span> <span class="main">=</span> sdom <span class="free">ρ'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ρ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ρ'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sdom_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">ρ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">x</span> <span class="skolem">v'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v'</span></span><span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> 
    
<span class="keyword1" id="BigStepLam-closed_env_cons"><span class="command">lemma</span></span> closed_env_cons<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="free">v</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> closed_env <span class="free">ρ''</span> <span class="main">⟹</span> closed_env <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">#</span> <span class="free">ρ''</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed_env_def sdom_def<span class="main">)</span>   

<span class="keyword1" id="BigStepLam-bs_env_closed"><span class="command">lemma</span></span> bs_env_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"bs_env <span class="free">ρ</span> <span class="free">ρ'</span> <span class="main">⟹</span> closed_env <span class="free">ρ'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ρ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ρ'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_env_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">ρ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="skolem"><span class="skolem">ρ''</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">v'</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> vvp<span class="main">:</span> <span class="quoted"><span class="quoted">"bs_val <span class="skolem">v</span> <span class="skolem">v'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r_rpp<span class="main">:</span> <span class="quoted"><span class="quoted">"bs_env <span class="skolem">ρ</span> <span class="skolem">ρ''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> vvp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_val <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> fv_vp<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="skolem">v'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Cons r_rpp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="skolem">ρ''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> this rp fv_vp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="BigStepLam-psubst_fv"><span class="command">lemma</span></span> psubst_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"closed_env <span class="free">ρ</span> <span class="main">⟹</span> FV <span class="main">(</span>psubst <span class="free">ρ</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> FV <span class="free">e</span> <span class="main">-</span> sdom <span class="free">ρ</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ρ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>EVar <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed_env_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> sdom <span class="skolem">ρ</span>"</span></span><span class="main">)</span>  
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sdom_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>  
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sdom_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lookup <span class="skolem">ρ</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ELam <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ELam <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> EVar <span class="skolem">x</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed_env_def sdom_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this ELam <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    
<span class="keyword1" id="BigStepLam-big_small_step"><span class="command">lemma</span></span> big_small_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">⇓</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r_rp<span class="main">:</span> <span class="quoted"><span class="quoted">"bs_env <span class="free">ρ</span> <span class="free">ρ'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fv_e<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="free">e</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="free">ρ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> psubst <span class="free">ρ'</span> <span class="free">e</span> <span class="main">⟶*</span> <span class="bound">v</span> <span class="main">∧</span> is_val <span class="bound">v</span> <span class="main">∧</span> bs_val <span class="free">w</span> <span class="bound">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ev r_rp fv_e
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ρ'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eval.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eval_nat <span class="skolem">ρ</span> <span class="skolem">n</span> <span class="skolem">ρ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ENat <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eval_var <span class="skolem">ρ</span> <span class="skolem">x</span> <span class="skolem">w</span> <span class="skolem">ρ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> eval_var <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> lx<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="skolem">ρ'</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    vv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_val <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> w_v<span class="main">:</span> <span class="quoted"><span class="quoted">"bs_val <span class="skolem">w</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lookup_bs_env <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> lx vv w_v <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eval_lam <span class="skolem">ρ</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> eval_lam<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> dom_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="skolem">ρ</span><span class="main">)</span> <span class="main">=</span> sdom <span class="skolem">ρ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bs_env_dom <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> eval_lam<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span>EVar <span class="skolem">x</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bs_env_closed closed_env_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this psubst_fv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FV <span class="main">(</span>psubst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span>EVar <span class="skolem">x</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ'</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> FV <span class="skolem">e</span> <span class="main">-</span> sdom <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span>EVar <span class="skolem">x</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> this eval_lam<span class="main">(</span>2<span class="main">)</span> dom_eq
  <span class="keyword1"><span class="command">have</span></span> fv_lam<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="main">(</span>ELam <span class="skolem">x</span> <span class="main">(</span>psubst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span>EVar <span class="skolem">x</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ'</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> fv_lam eval_lam <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"bs_val <span class="main">(</span>BClos <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="main">(</span>ELam <span class="skolem">x</span> <span class="main">(</span>psubst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> EVar <span class="skolem">x</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ'</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>   
  <span class="keyword1"><span class="command">from</span></span> this eval_lam fv_lam <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ELam <span class="skolem">x</span> <span class="main">(</span>psubst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span>EVar <span class="skolem">x</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ'</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eval_app <span class="skolem">ρ</span> <span class="skolem">e1</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ'</span> <span class="skolem">e2</span> <span class="skolem">arg</span> <span class="skolem">v</span>  <span class="skolem">ρ''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> eval_app<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FV <span class="skolem">e1</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this eval_app<span class="main">(</span>7<span class="main">)</span> eval_app<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ρ''</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v1</span></span> <span class="keyword2"><span class="keyword">where</span></span> e1_v1<span class="main">:</span> <span class="quoted"><span class="quoted">"psubst <span class="skolem">ρ''</span> <span class="skolem">e1</span> <span class="main">⟶*</span> <span class="skolem">v1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    vv1<span class="main">:</span> <span class="quoted"><span class="quoted">"is_val <span class="skolem">v1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> clos_v1<span class="main">:</span> <span class="quoted"><span class="quoted">"bs_val <span class="main">(</span>BClos <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ'</span><span class="main">)</span> <span class="skolem">v1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> eval_app<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FV <span class="skolem">e2</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this eval_app<span class="main">(</span>5<span class="main">)</span> eval_app<span class="main">(</span>7<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v2</span></span> <span class="keyword2"><span class="keyword">where</span></span> e2_v2<span class="main">:</span> <span class="quoted"><span class="quoted">"psubst <span class="skolem">ρ''</span> <span class="skolem">e2</span> <span class="main">⟶*</span> <span class="skolem">v2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    vv2<span class="main">:</span> <span class="quoted"><span class="quoted">"is_val <span class="skolem">v2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> arg_v2<span class="main">:</span> <span class="quoted"><span class="quoted">"bs_val <span class="skolem">arg</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> vv2 <span class="keyword1"><span class="command">have</span></span> fv_v2<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="skolem">v2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> clos_v1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ρ2</span></span> <span class="keyword2"><span class="keyword">where</span></span> rpp_r2<span class="main">:</span> <span class="quoted"><span class="quoted">"bs_env <span class="skolem">ρ'</span> <span class="skolem">ρ2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fv_v1<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="skolem">v1</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    v1_lam<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">=</span> ELam <span class="skolem">x</span> <span class="main">(</span>psubst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span>EVar <span class="skolem">x</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ2</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">v2</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> rpp_r2 <span class="keyword1"><span class="command">have</span></span> cr2<span class="main">:</span> <span class="quoted"><span class="quoted">"closed_env <span class="skolem">ρ2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bs_env_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span>EVar <span class="skolem">x</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ2</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span>  closed_env_def sdom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> fve<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="main">(</span>psubst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span>EVar <span class="skolem">x</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ2</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> FV <span class="skolem">e</span> <span class="main">-</span> sdom <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span>EVar <span class="skolem">x</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ2</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> psubst_fv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span>EVar <span class="skolem">x</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ2</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">arg</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> rpp_r2 arg_v2 vv2 <span class="keyword1"><span class="command">have</span></span> rr<span class="main">:</span> <span class="quoted"><span class="quoted">"bs_env <span class="var">?r2</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> rr bs_env_dom <span class="keyword1"><span class="command">have</span></span> dr2_dr<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map fst <span class="var">?r2</span><span class="main">)</span> <span class="main">=</span> sdom <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> fve dr2_dr fv_v1 v1_lam fv_v2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FV <span class="skolem">e</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">arg</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> this rr eval_app<span class="main">(</span>6<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v3</span></span> <span class="keyword2"><span class="keyword">where</span></span> e_v3<span class="main">:</span> <span class="quoted"><span class="quoted">"psubst <span class="var">?r</span> <span class="skolem">e</span> <span class="main">⟶*</span> <span class="skolem">v3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    vv3<span class="main">:</span> <span class="quoted"><span class="quoted">"isval <span class="skolem">v3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v_v3<span class="main">:</span> <span class="quoted"><span class="quoted">"bs_val <span class="skolem">v</span> <span class="skolem">v3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>      
  <span class="keyword1"><span class="command">from</span></span> e1_v1 <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"EApp <span class="main">(</span>psubst <span class="skolem">ρ''</span> <span class="skolem">e1</span><span class="main">)</span> <span class="main">(</span>psubst <span class="skolem">ρ''</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">⟶*</span> EApp <span class="skolem">v1</span> <span class="main">(</span>psubst <span class="skolem">ρ''</span> <span class="skolem">e2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> app_red_cong1<span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> e2_v2 <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"EApp <span class="skolem">v1</span> <span class="main">(</span>psubst <span class="skolem">ρ''</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">⟶*</span> EApp <span class="skolem">v1</span> <span class="skolem">v2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> app_red_cong2<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> vv2 fv_v2 <span class="keyword1"><span class="command">have</span></span> vv2b<span class="main">:</span> <span class="quoted"><span class="quoted">"is_val <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?body</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"psubst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span>EVar <span class="skolem">x</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ2</span><span class="main">)</span> <span class="skolem">e</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> v1_lam vv2b <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"EApp <span class="main">(</span>ELam <span class="skolem">x</span> <span class="var">?body</span><span class="main">)</span> <span class="skolem">v2</span> <span class="main">⟶</span>
      subst <span class="skolem">x</span> <span class="skolem">v2</span> <span class="main">(</span>psubst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span>EVar <span class="skolem">x</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ2</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> beta<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v2</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"<span class="var">?body</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"subst <span class="skolem">x</span> <span class="skolem">v2</span> <span class="main">(</span>psubst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span>EVar <span class="skolem">x</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ2</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> psubst <span class="var">?r</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_psubst<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> fv_v2 cr2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"subst <span class="skolem">x</span> <span class="skolem">v2</span> <span class="main">(</span>psubst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span>EVar <span class="skolem">x</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ2</span><span class="main">)</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> psubst <span class="var">?r</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_psubst<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> fv_v2 cr2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"psubst <span class="skolem">ρ''</span> <span class="main">(</span>EApp <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">⟶*</span> EApp <span class="skolem">v1</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> multi_step_trans<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 5 3 4 v1_lam <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"psubst <span class="skolem">ρ''</span> <span class="main">(</span>EApp <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">⟶*</span> psubst <span class="var">?r</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> multi_step_trans<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> 6 e_v3 <span class="keyword1"><span class="command">have</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"psubst <span class="skolem">ρ''</span> <span class="main">(</span>EApp <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">⟶*</span> <span class="skolem">v3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> multi_step_trans<span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> 7 vv3 v_v3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eval_prim <span class="skolem">ρ</span> <span class="skolem">e1</span> <span class="skolem">n1</span> <span class="skolem">e2</span> <span class="skolem">n2</span> <span class="skolem">n3</span> <span class="skolem">f</span> <span class="skolem">ρ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> eval_prim<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FV <span class="skolem">e1</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this eval_prim <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v1</span></span> <span class="keyword2"><span class="keyword">where</span></span> e1_v1<span class="main">:</span> <span class="quoted"><span class="quoted">"psubst <span class="skolem">ρ'</span> <span class="skolem">e1</span> <span class="main">⟶*</span> <span class="skolem">v1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    n1_v1<span class="main">:</span> <span class="quoted"><span class="quoted">"bs_val <span class="main">(</span>BNat <span class="skolem">n1</span><span class="main">)</span> <span class="skolem">v1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> n1_v1 <span class="keyword1"><span class="command">have</span></span> v1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">=</span> ENat <span class="skolem">n1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 

  <span class="keyword1"><span class="command">from</span></span> eval_prim<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FV <span class="skolem">e2</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this eval_prim <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v2</span></span> <span class="keyword2"><span class="keyword">where</span></span> e2_v2<span class="main">:</span> <span class="quoted"><span class="quoted">"psubst <span class="skolem">ρ'</span> <span class="skolem">e2</span> <span class="main">⟶*</span> <span class="skolem">v2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    n2_v2<span class="main">:</span> <span class="quoted"><span class="quoted">"bs_val <span class="main">(</span>BNat <span class="skolem">n2</span><span class="main">)</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> n2_v2 <span class="keyword1"><span class="command">have</span></span> v2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">=</span> ENat <span class="skolem">n2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  
  <span class="keyword1"><span class="command">from</span></span> e1_v1 <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"EPrim <span class="skolem">f</span> <span class="main">(</span>psubst <span class="skolem">ρ'</span> <span class="skolem">e1</span><span class="main">)</span> <span class="main">(</span>psubst <span class="skolem">ρ'</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">⟶*</span> EPrim <span class="skolem">f</span> <span class="skolem">v1</span> <span class="main">(</span>psubst <span class="skolem">ρ'</span> <span class="skolem">e2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prim_red_cong1<span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> e2_v2 <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"EPrim <span class="skolem">f</span> <span class="skolem">v1</span> <span class="main">(</span>psubst <span class="skolem">ρ'</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">⟶*</span> EPrim <span class="skolem">f</span> <span class="skolem">v1</span> <span class="skolem">v2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prim_red_cong2<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> v1 v2 <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"EPrim <span class="skolem">f</span> <span class="skolem">v1</span> <span class="skolem">v2</span> <span class="main">⟶</span> ENat <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n1</span> <span class="skolem">n2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"psubst <span class="skolem">ρ'</span> <span class="main">(</span>EPrim <span class="skolem">f</span> <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">⟶*</span> EPrim <span class="skolem">f</span> <span class="skolem">v1</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> multi_step_trans<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> 5 3  <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"psubst <span class="skolem">ρ'</span> <span class="main">(</span>EPrim <span class="skolem">f</span> <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">⟶*</span> ENat <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n1</span> <span class="skolem">n2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> multi_step_trans<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> this eval_prim<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ENat <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n1</span> <span class="skolem">n2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eval_if0 <span class="skolem">ρ</span> <span class="skolem">e1</span> <span class="skolem">e3</span> <span class="skolem">v3</span> <span class="skolem">e2</span> <span class="skolem">ρ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> eval_if0<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FV <span class="skolem">e1</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this eval_if0 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v1</span></span> <span class="keyword2"><span class="keyword">where</span></span> e1_v1<span class="main">:</span> <span class="quoted"><span class="quoted">"psubst <span class="skolem">ρ'</span> <span class="skolem">e1</span> <span class="main">⟶*</span> <span class="skolem">v1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    n1_v1<span class="main">:</span> <span class="quoted"><span class="quoted">"bs_val <span class="main">(</span>BNat <span class="main">0</span><span class="main">)</span> <span class="skolem">v1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> n1_v1 <span class="keyword1"><span class="command">have</span></span> v1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">=</span> ENat <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> eval_if0<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FV <span class="skolem">e3</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this eval_if0 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v3'</span></span> <span class="keyword2"><span class="keyword">where</span></span> e3_v3<span class="main">:</span> <span class="quoted"><span class="quoted">"psubst <span class="skolem">ρ'</span> <span class="skolem">e3</span> <span class="main">⟶*</span> <span class="skolem">v3'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    v3_v3<span class="main">:</span> <span class="quoted"><span class="quoted">"bs_val <span class="skolem">v3</span> <span class="skolem">v3'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      
  <span class="keyword1"><span class="command">from</span></span> e1_v1 <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"EIf <span class="main">(</span>psubst <span class="skolem">ρ'</span> <span class="skolem">e1</span><span class="main">)</span> <span class="main">(</span>psubst <span class="skolem">ρ'</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">(</span>psubst <span class="skolem">ρ'</span> <span class="skolem">e3</span><span class="main">)</span> 
    <span class="main">⟶*</span> EIf <span class="skolem">v1</span> <span class="main">(</span>psubst <span class="skolem">ρ'</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">(</span>psubst <span class="skolem">ρ'</span> <span class="skolem">e3</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> if_red_cong1<span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> v1 <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"EIf <span class="skolem">v1</span> <span class="main">(</span>psubst <span class="skolem">ρ'</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">(</span>psubst <span class="skolem">ρ'</span> <span class="skolem">e3</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>psubst <span class="skolem">ρ'</span> <span class="skolem">e3</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> 1 3 <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"psubst <span class="skolem">ρ'</span> <span class="main">(</span>EIf <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e3</span><span class="main">)</span> <span class="main">⟶*</span> psubst <span class="skolem">ρ'</span> <span class="skolem">e3</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> multi_step_trans<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> 5 e3_v3 <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"psubst <span class="skolem">ρ'</span> <span class="main">(</span>EIf <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e3</span><span class="main">)</span> <span class="main">⟶*</span> <span class="skolem">v3'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> multi_step_trans<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> 6 v3_v3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eval_if1 <span class="skolem">ρ</span> <span class="skolem">e1</span> <span class="skolem">n</span> <span class="skolem">e2</span> <span class="skolem">v2</span> <span class="skolem">e3</span> <span class="skolem">ρ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> eval_if1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FV <span class="skolem">e1</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this eval_if1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v1</span></span> <span class="keyword2"><span class="keyword">where</span></span> e1_v1<span class="main">:</span> <span class="quoted"><span class="quoted">"psubst <span class="skolem">ρ'</span> <span class="skolem">e1</span> <span class="main">⟶*</span> <span class="skolem">v1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    n1_v1<span class="main">:</span> <span class="quoted"><span class="quoted">"bs_val <span class="main">(</span>BNat <span class="skolem">n</span><span class="main">)</span> <span class="skolem">v1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> n1_v1 <span class="keyword1"><span class="command">have</span></span> v1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">=</span> ENat <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> eval_if1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FV <span class="skolem">e2</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this eval_if1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> e2_v2<span class="main">:</span> <span class="quoted"><span class="quoted">"psubst <span class="skolem">ρ'</span> <span class="skolem">e2</span> <span class="main">⟶*</span> <span class="skolem">v2'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    v2_v2<span class="main">:</span> <span class="quoted"><span class="quoted">"bs_val <span class="skolem">v2</span> <span class="skolem">v2'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> e1_v1 <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"EIf <span class="main">(</span>psubst <span class="skolem">ρ'</span> <span class="skolem">e1</span><span class="main">)</span> <span class="main">(</span>psubst <span class="skolem">ρ'</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">(</span>psubst <span class="skolem">ρ'</span> <span class="skolem">e3</span><span class="main">)</span> 
    <span class="main">⟶*</span> EIf <span class="skolem">v1</span> <span class="main">(</span>psubst <span class="skolem">ρ'</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">(</span>psubst <span class="skolem">ρ'</span> <span class="skolem">e3</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> if_red_cong1<span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> v1 nz <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"EIf <span class="skolem">v1</span> <span class="main">(</span>psubst <span class="skolem">ρ'</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">(</span>psubst <span class="skolem">ρ'</span> <span class="skolem">e3</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>psubst <span class="skolem">ρ'</span> <span class="skolem">e2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> 1 3 <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"psubst <span class="skolem">ρ'</span> <span class="main">(</span>EIf <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e3</span><span class="main">)</span> <span class="main">⟶*</span> psubst <span class="skolem">ρ'</span> <span class="skolem">e2</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> multi_step_trans<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> 5 e2_v2 <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"psubst <span class="skolem">ρ'</span> <span class="main">(</span>EIf <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e3</span><span class="main">)</span> <span class="main">⟶*</span> <span class="skolem">v2'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> multi_step_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 6 v2_v2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="BigStepLam-psubst_id"><span class="command">lemma</span></span> psubst_id<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="free">e</span> <span class="main">∩</span> sdom <span class="free">ρ</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> psubst <span class="free">ρ</span> <span class="free">e</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ρ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>EVar <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"lookup <span class="skolem">ρ</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sdom_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ENat <span class="skolem">x</span> <span class="skolem">ρ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ENat <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sdom <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span>EVar <span class="skolem">x</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">=</span> sdom <span class="skolem">ρ</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> ENat <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ELam <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ELam <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"FV <span class="skolem">e</span> <span class="main">∩</span> sdom <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span>EVar <span class="skolem">x</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> ELam <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
 
    
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bs_observe</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bval <span class="main">⇒</span> obs <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bs_observe</span> <span class="main">(</span>BNat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>ONat <span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bs_observe</span> <span class="main">(</span>BClos <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span> OFun <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">bs_observe</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ob</span></span></span> <span class="main">=</span> False"</span></span> 

<span class="keyword1"><span class="command">theorem</span></span> sound_wrt_small_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> e_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">⇓</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fv_e<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="free">e</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v'</span> <span class="bound">ob</span><span class="main">.</span> <span class="free">e</span> <span class="main">⟶*</span> <span class="bound">v'</span> <span class="main">∧</span> isval <span class="bound">v'</span> <span class="main">∧</span> observe <span class="bound">v'</span> <span class="bound">ob</span>
    <span class="main">∧</span> bs_observe <span class="free">v</span> <span class="bound">ob</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"bs_env <span class="main">[]</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> fv_e <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="free">e</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> e_v 1 2 big_small_step <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"psubst <span class="main">[]</span> <span class="free">e</span> <span class="main">⟶*</span> <span class="skolem">v'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"is_val <span class="skolem">v'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    5<span class="main">:</span> <span class="quoted"><span class="quoted">"bs_val <span class="free">v</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"psubst <span class="main">[]</span> <span class="free">e</span> <span class="main">=</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> psubst_id sdom_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> this 3 4 5 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> n<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"ONat <span class="improper">n</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted">OFun</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Big-step semantics is deterministic"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> big_step_fun<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">⇓</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> evp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">⇓</span> <span class="free">v'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">v'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ev evp 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eval_app <span class="skolem">ρ</span> <span class="skolem">e1</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ'</span> <span class="skolem">e2</span> <span class="skolem">arg</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> eval_app<span class="main">(</span>7<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="skolem"><span class="skolem">ρ''</span></span> <span class="skolem"><span class="skolem">arg'</span></span> <span class="keyword2"><span class="keyword">where</span></span> e1_cl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">⊢</span> <span class="skolem">e1</span> <span class="main">⇓</span> BClos <span class="skolem">x'</span> <span class="skolem">e'</span> <span class="skolem">ρ''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    e2_argp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">⊢</span> <span class="skolem">e2</span> <span class="main">⇓</span> <span class="skolem">arg'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> e_vp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> <span class="skolem">arg'</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ''</span> <span class="main">⊢</span> <span class="skolem">e'</span> <span class="main">⇓</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> eval_app<span class="main">(</span>4<span class="main">)</span> e1_cl <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"BClos <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ'</span> <span class="main">=</span> BClos <span class="skolem">x'</span> <span class="skolem">e'</span> <span class="skolem">ρ''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> eval_app<span class="main">(</span>5<span class="main">)</span> e2_argp <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">arg</span> <span class="main">=</span> <span class="skolem">arg'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> eval_app<span class="main">(</span>6<span class="main">)</span> e_vp 1 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eval_if0 <span class="skolem">ρ</span> <span class="skolem">e1</span> <span class="skolem">e3</span> <span class="skolem">v3</span> <span class="skolem">e2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> eval_if0<span class="main">(</span>5<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eval_if_inv<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">⊢</span> <span class="skolem">e3</span> <span class="main">⇓</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> eval_if0<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">⊢</span> <span class="skolem">e1</span> <span class="main">⇓</span> BNat <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> eval_if0<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eval_if1 <span class="skolem">ρ</span> <span class="skolem">e1</span> <span class="skolem">n</span> <span class="skolem">e2</span> <span class="skolem">v2</span> <span class="skolem">e3</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ValuesFSet">
<div class="head">
<h1>Theory ValuesFSet</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> ValuesFSet
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="Lambda.html">Lambda</a> <span class="quoted">"<a href="../../HOL/HOL-Library/FSet.html">HOL-Library.FSet</a>"</span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> val <span class="main">=</span> VNat <span class="quoted">nat</span> <span class="main">|</span> VFun <span class="quoted"><span class="quoted">"<span class="main">(</span>val <span class="main">×</span> val<span class="main">)</span> fset"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> func <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>val <span class="main">×</span> val<span class="main">)</span> fset"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">val_le</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> val <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊑</span>"</span> 52<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  vnat_le<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>VNat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊑</span></span> <span class="main">(</span>VNat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  vfun_le<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fset <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">⊆</span> fset <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">⟹</span> <span class="main">(</span>VFun <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊑</span></span> <span class="main">(</span>VFun <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> env <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>name <span class="main">×</span> val<span class="main">)</span> list<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">env_le</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"env <span class="main">⇒</span> env <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊑</span>"</span> 52<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊑</span></span> <span class="free"><span class="bound"><span class="entity">ρ'</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">x</span> <span class="bound">v</span><span class="main">.</span> lookup <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v'</span><span class="main">.</span> lookup <span class="free"><span class="bound"><span class="entity">ρ'</span></span></span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">v'</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">⊑</span> <span class="bound">v'</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">env_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"env <span class="main">⇒</span> env <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≈</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">≈</span></span> <span class="free"><span class="bound"><span class="entity">ρ'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> lookup <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="bound">x</span> <span class="main">=</span> lookup <span class="free"><span class="bound"><span class="entity">ρ'</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">vadd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>val <span class="main">×</span> nat<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>val <span class="main">×</span> nat<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vadd</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
  
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">vsize</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">vsize</span> <span class="main">(</span>VNat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">vsize</span> <span class="main">(</span>VFun <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> ffold vadd <span class="main">0</span>
                            <span class="main">(</span>fimage <span class="main">(</span>map_prod <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="free">vsize</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="free">vsize</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">vprod_size</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">×</span> val <span class="main">⇒</span> <span class="main">(</span>val <span class="main">×</span> nat<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>val <span class="main">×</span> nat<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vprod_size</span> <span class="main">≡</span> map_prod <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span>vsize <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span>vsize <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fsize</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"func <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fsize</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">1</span> <span class="main">+</span> ffold vadd <span class="main">0</span> <span class="main">(</span>fimage vprod_size <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> vadd_vprod<span class="main">:</span> comp_fun_commute <span class="quoted"><span class="quoted">"vadd <span class="main">∘</span> vprod_size"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> comp_fun_commute_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  

<span class="keyword1" id="ValuesFSet-vprod_size_inj"><span class="command">lemma</span></span> vprod_size_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on vprod_size <span class="main">(</span>fset <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1" id="ValuesFSet-fsize_def2"><span class="command">lemma</span></span> fsize_def2<span class="main">:</span> <span class="quoted"><span class="quoted">"fsize <span class="free">t</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> ffold <span class="main">(</span>vadd <span class="main">∘</span> vprod_size<span class="main">)</span> <span class="main">0</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> vprod_size_inj<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> ffold_fimage<span class="main">[</span><span class="operator">of</span> <span class="quoted">vprod_size</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted">vadd</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="ValuesFSet-fsize_finsert_in"><span class="command">lemma</span></span> fsize_finsert_in<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> v12_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v1</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="main">|∈|</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fsize <span class="main">(</span>finsert <span class="main">(</span><span class="free">v1</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> fsize <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> v12_t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finsert <span class="main">(</span><span class="free">v1</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1" id="ValuesFSet-fsize_finsert_notin"><span class="command">lemma</span></span> fsize_finsert_notin<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> v12_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v1</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="main">|∉|</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fsize <span class="main">(</span>finsert <span class="main">(</span><span class="free">v1</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> vsize <span class="free">v1</span> <span class="main">+</span> vsize <span class="free">v2</span> <span class="main">+</span> fsize <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"vadd <span class="main">∘</span> vprod_size"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fsize <span class="main">(</span>finsert <span class="main">(</span><span class="free">v1</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> ffold <span class="var">?f</span> <span class="main">0</span> <span class="main">(</span>finsert <span class="main">(</span><span class="free">v1</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fsize_def2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"finsert <span class="main">(</span><span class="free">v1</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="free">t</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> v12_t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="var">?f</span> <span class="main">(</span><span class="free">v1</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="main">(</span>ffold <span class="var">?f</span> <span class="main">0</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fsize <span class="main">(</span>finsert <span class="main">(</span><span class="free">v1</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="var">?f</span> <span class="main">(</span><span class="free">v1</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="main">(</span>ffold <span class="var">?f</span> <span class="main">0</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> fsize_def2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword2"><span class="keyword">end</span></span>
  
</pre>
</div><div id="ValuesFSetProps">
<div class="head">
<h1>Theory ValuesFSetProps</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> ValuesFSetProps
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="ValuesFSet.html">ValuesFSet</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> 
  vfun_le_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="free">t1</span> <span class="main">⊑</span> VFun <span class="free">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  le_fun_nat_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="free">t2</span> <span class="main">⊑</span> VNat <span class="free">x1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  le_any_nat_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⊑</span> VNat <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  le_nat_any_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="free">n</span> <span class="main">⊑</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  le_fun_any_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="free">t</span> <span class="main">⊑</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  le_any_fun_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⊑</span> VFun <span class="free">t</span>"</span></span> 

<span class="keyword1"><span class="command">proposition</span></span> val_le_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span><span class="main">::</span><span class="quoted">val</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⊑</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">proposition</span></span> val_le_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v2</span><span class="main">::</span><span class="quoted">val</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v1</span> <span class="main">⊑</span> <span class="free">v2</span><span class="main">;</span> <span class="free">v2</span> <span class="main">⊑</span> <span class="free">v3</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">v1</span> <span class="main">⊑</span> <span class="free">v3</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">v2</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v1</span></span> <span class="quoted"><span class="free">v3</span></span><span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="ValuesFSetProps-fsubset"><span class="command">lemma</span></span> fsubset<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fset <span class="free">A</span> <span class="main">⊆</span> fset <span class="free">B</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">|⊆|</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fsubsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"fset <span class="free">A</span> <span class="main">⊆</span> fset <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">|∈|</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> xa <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> fset <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fmember.rep_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> this ab <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> fset <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">|∈|</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fmember.rep_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">proposition</span></span> val_le_antisymm<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v1</span><span class="main">::</span><span class="quoted">val</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v1</span> <span class="main">⊑</span> <span class="free">v2</span><span class="main">;</span> <span class="free">v2</span> <span class="main">⊑</span> <span class="free">v1</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">v1</span> <span class="main">=</span> <span class="free">v2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">v1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v2</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="ValuesFSetProps-le_nat_any"><span class="command">lemma</span></span> le_nat_any<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="free">n</span> <span class="main">⊑</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">=</span> VNat <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="ValuesFSetProps-le_any_nat"><span class="command">lemma</span></span> le_any_nat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⊑</span> VNat <span class="free">n</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">=</span> VNat <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="ValuesFSetProps-le_nat_nat"><span class="command">lemma</span></span> le_nat_nat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="free">n</span> <span class="main">⊑</span> VNat <span class="free">n'</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">=</span> <span class="free">n'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
  
</pre>
</div><div id="RelationalSemFSet">
<div class="head">
<h1>Theory RelationalSemFSet</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Declarative semantics as a relational semantics"</span></span>

<span class="keyword1"><span class="command">theory</span></span> RelationalSemFSet
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Lambda.html">Lambda</a> <a href="ValuesFSet.html">ValuesFSet</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">rel_sem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"env <span class="main">⇒</span> exp <span class="main">⇒</span> val <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">⇒</span> _"</span> <span class="main">[</span>52<span class="main">,</span>52<span class="main">,</span>52<span class="main">]</span> 51<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  rnat<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> ENat <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">⇒</span></span> VNat <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> <span class="main">|</span>
  rprim<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">⇒</span></span> VNat <span class="free"><span class="bound"><span class="entity">n1</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⇒</span></span> VNat <span class="free"><span class="bound"><span class="entity">n2</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> EPrim <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⇒</span></span> VNat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  rvar<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> lookup <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> EVar <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span> <span class="main">|</span>
  rlam<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">∀</span> <span class="bound">v</span> <span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">v'</span><span class="main">)</span> <span class="main">∈</span> fset <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="bound">v'</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> ELam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">⇒</span></span> VFun <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
  rapp<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">⇒</span></span> VFun <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v3</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v3'</span></span></span><span class="main">)</span> <span class="main">∈</span> fset <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">v3</span></span></span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">v3'</span></span></span><span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> EApp <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span> <span class="main">|</span>
  rifnz<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">⇒</span></span> VNat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≠</span> <span class="main">0</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> EIf <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span> <span class="main">|</span>
  rifz<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">⇒</span></span> VNat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊢</span></span> EIf <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span> <span class="main"><span class="free">⇒</span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
  
<span class="keyword2"><span class="keyword">end</span></span>
  
</pre>
</div><div id="DeclSemAsDenotFSet">
<div class="head">
<h1>Theory DeclSemAsDenotFSet</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> DeclSemAsDenotFSet
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Lambda.html">Lambda</a> <a href="ValuesFSet.html">ValuesFSet</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Declarative semantics as a denotational semantics"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">E</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> env <span class="main">⇒</span> val set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  Enat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>ENat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">=</span> VNat <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">}</span>"</span></span> <span class="main">|</span>
  Evar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>EVar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">v</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">v'</span><span class="main">.</span> lookup <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Some <span class="bound">v'</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">⊑</span> <span class="bound">v'</span> <span class="main">}</span>"</span></span> <span class="main">|</span>
  Elam<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>ELam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">v</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">v</span> <span class="main">=</span> VFun <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v1</span> <span class="bound">v2</span><span class="main">.</span> <span class="main">(</span><span class="bound">v1</span><span class="main">,</span> <span class="bound">v2</span><span class="main">)</span> <span class="main">∈</span> fset <span class="bound">f</span> 
    <span class="main">⟶</span> <span class="bound">v2</span> <span class="main">∈</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="bound">v1</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">}</span>"</span></span> <span class="main">|</span>
  Eapp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>EApp <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">v3</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">f</span> <span class="bound">v2</span> <span class="bound">v2'</span> <span class="bound">v3'</span><span class="main">.</span> 
      VFun <span class="bound">f</span> <span class="main">∈</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">∧</span> <span class="bound">v2</span> <span class="main">∈</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">v2'</span><span class="main">,</span> <span class="bound">v3'</span><span class="main">)</span> <span class="main">∈</span> fset <span class="bound">f</span> <span class="main">∧</span> <span class="bound">v2'</span> <span class="main">⊑</span> <span class="bound">v2</span> <span class="main">∧</span> <span class="bound">v3</span> <span class="main">⊑</span> <span class="bound">v3'</span> <span class="main">}</span>"</span></span> <span class="main">|</span>
  Eprim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>EPrim <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">v</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">n1</span> <span class="bound">n2</span><span class="main">.</span> VNat <span class="bound">n1</span> <span class="main">∈</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> 
          <span class="main">∧</span> VNat <span class="bound">n2</span> <span class="main">∈</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">=</span> VNat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">n1</span> <span class="bound">n2</span><span class="main">)</span> <span class="main">}</span>"</span></span> <span class="main">|</span>
  Eif<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>EIf <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">v</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> VNat <span class="bound">n</span> <span class="main">∈</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span>
         <span class="main">∧</span> <span class="main">(</span><span class="bound">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
  
  
</pre>
</div><div id="EquivRelationalDenotFSet">
<div class="head">
<h1>Theory EquivRelationalDenotFSet</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Relational and denotational views are equivalent"</span></span>

<span class="keyword1"><span class="command">theory</span></span> EquivRelationalDenotFSet
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="RelationalSemFSet.html">RelationalSemFSet</a> <a href="DeclSemAsDenotFSet.html">DeclSemAsDenotFSet</a>
<span class="keyword2"><span class="keyword">begin</span></span>
    
<span class="keyword1" id="EquivRelationalDenotFSet-denot_implies_rel"><span class="command">lemma</span></span> denot_implies_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ρ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">⇒</span> <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">ρ</span></span><span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>EIf <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e3</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> n<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">n</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rifnz<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="EquivRelationalDenotFSet-rel_implies_denot"><span class="command">lemma</span></span> rel_implies_denot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">⇒</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ρ</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rel_sem.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> equivalence_relational_denotational<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ρ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">⇒</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> denot_implies_rel rel_implies_denot <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
<span class="keyword2"><span class="keyword">end</span></span>
  
</pre>
</div><div id="ChangeEnv">
<div class="head">
<h1>Theory ChangeEnv</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Subsumption and change of environment"</span></span>

<span class="keyword1"><span class="command">theory</span></span> ChangeEnv
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="Lambda.html">Lambda</a> <a href="DeclSemAsDenotFSet.html">DeclSemAsDenotFSet</a> <a href="ValuesFSetProps.html">ValuesFSetProps</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="ChangeEnv-e_prim_intro"><span class="command">lemma</span></span> e_prim_intro<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> VNat <span class="free">n1</span> <span class="main">∈</span> E <span class="free">e1</span> <span class="free">ρ</span><span class="main">;</span> VNat <span class="free">n2</span> <span class="main">∈</span> E <span class="free">e2</span> <span class="free">ρ</span><span class="main">;</span> <span class="free">v</span> <span class="main">=</span> VNat <span class="main">(</span><span class="free">f</span> <span class="free">n1</span> <span class="free">n2</span><span class="main">)</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> E <span class="main">(</span>EPrim <span class="free">f</span> <span class="free">e1</span> <span class="free">e2</span><span class="main">)</span> <span class="free">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="ChangeEnv-e_prim_elim"><span class="command">lemma</span></span> e_prim_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v</span> <span class="main">∈</span> E <span class="main">(</span>EPrim <span class="free">f</span> <span class="free">e1</span> <span class="free">e2</span><span class="main">)</span> <span class="free">ρ</span><span class="main">;</span>
   <span class="main">⋀</span> <span class="bound">n1</span> <span class="bound">n2</span><span class="main">.</span> <span class="main">⟦</span> VNat <span class="bound">n1</span> <span class="main">∈</span> E <span class="free">e1</span> <span class="free">ρ</span><span class="main">;</span> VNat <span class="bound">n2</span> <span class="main">∈</span> E <span class="free">e2</span> <span class="free">ρ</span><span class="main">;</span> <span class="free">v</span> <span class="main">=</span> VNat <span class="main">(</span><span class="free">f</span> <span class="bound">n1</span> <span class="bound">n2</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
 
<span class="keyword1" id="ChangeEnv-e_app_elim"><span class="command">lemma</span></span> e_app_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v3</span> <span class="main">∈</span> E <span class="main">(</span>EApp <span class="free">e1</span> <span class="free">e2</span><span class="main">)</span> <span class="free">ρ</span><span class="main">;</span>
  <span class="main">⋀</span> <span class="bound">f</span> <span class="bound">v2</span> <span class="bound">v2'</span> <span class="bound">v3'</span><span class="main">.</span> <span class="main">⟦</span> VFun <span class="bound">f</span> <span class="main">∈</span> E <span class="free">e1</span> <span class="free">ρ</span><span class="main">;</span> <span class="bound">v2</span> <span class="main">∈</span> E <span class="free">e2</span> <span class="free">ρ</span><span class="main">;</span> <span class="main">(</span><span class="bound">v2'</span><span class="main">,</span><span class="bound">v3'</span><span class="main">)</span> <span class="main">∈</span> fset <span class="bound">f</span><span class="main">;</span> <span class="bound">v2'</span> <span class="main">⊑</span> <span class="bound">v2</span><span class="main">;</span> <span class="free">v3</span> <span class="main">⊑</span> <span class="bound">v3'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>
 <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="ChangeEnv-e_app_intro"><span class="command">lemma</span></span> e_app_intro<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> VFun <span class="free">f</span> <span class="main">∈</span> E <span class="free">e1</span> <span class="free">ρ</span><span class="main">;</span> <span class="free">v2</span> <span class="main">∈</span> E <span class="free">e2</span> <span class="free">ρ</span><span class="main">;</span> <span class="main">(</span><span class="free">v2'</span><span class="main">,</span><span class="free">v3'</span><span class="main">)</span> <span class="main">∈</span> fset <span class="free">f</span><span class="main">;</span> <span class="free">v2'</span> <span class="main">⊑</span> <span class="free">v2</span><span class="main">;</span> <span class="free">v3</span> <span class="main">⊑</span> <span class="free">v3'</span><span class="main">⟧</span>
     <span class="main">⟹</span> <span class="free">v3</span> <span class="main">∈</span> E <span class="main">(</span>EApp <span class="free">e1</span> <span class="free">e2</span><span class="main">)</span> <span class="free">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="ChangeEnv-e_lam_intro"><span class="command">lemma</span></span> e_lam_intro<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v</span> <span class="main">=</span> VFun <span class="free">f</span><span class="main">;</span>
      <span class="main">∀</span> <span class="bound">v1</span> <span class="bound">v2</span><span class="main">.</span> <span class="main">(</span><span class="bound">v1</span><span class="main">,</span><span class="bound">v2</span><span class="main">)</span> <span class="main">∈</span> fset <span class="free">f</span> <span class="main">⟶</span> <span class="bound">v2</span> <span class="main">∈</span> E <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">v1</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> E <span class="main">(</span>ELam <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="ChangeEnv-e_lam_intro2"><span class="command">lemma</span></span> e_lam_intro2<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> VFun <span class="free">f</span> <span class="main">∈</span> E <span class="main">(</span>ELam <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="free">ρ</span><span class="main">;</span> <span class="free">v2</span> <span class="main">∈</span> E <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">v1</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> VFun <span class="main">(</span>finsert <span class="main">(</span><span class="free">v1</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span> <span class="main">∈</span> E <span class="main">(</span>ELam <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="free">ρ</span>"</span></span>    
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="ChangeEnv-e_lam_intro3"><span class="command">lemma</span></span> e_lam_intro3<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="main">{||}</span> <span class="main">∈</span> E <span class="main">(</span>ELam <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="ChangeEnv-e_if_intro"><span class="command">lemma</span></span> e_if_intro<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> VNat <span class="free">n</span> <span class="main">∈</span> E <span class="free">e1</span> <span class="free">ρ</span><span class="main">;</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free">v</span> <span class="main">∈</span> E <span class="free">e3</span> <span class="free">ρ</span><span class="main">;</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free">v</span> <span class="main">∈</span> E <span class="free">e2</span> <span class="free">ρ</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> E <span class="main">(</span>EIf <span class="free">e1</span> <span class="free">e2</span> <span class="free">e3</span><span class="main">)</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="ChangeEnv-e_var_intro"><span class="command">lemma</span></span> e_var_intro<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> lookup <span class="free">ρ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">v'</span><span class="main">;</span> <span class="free">v</span> <span class="main">⊑</span> <span class="free">v'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> E <span class="main">(</span>EVar <span class="free">x</span><span class="main">)</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="ChangeEnv-e_var_elim"><span class="command">lemma</span></span> e_var_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v</span> <span class="main">∈</span> E <span class="main">(</span>EVar <span class="free">x</span><span class="main">)</span> <span class="free">ρ</span><span class="main">;</span>
   <span class="main">⋀</span> <span class="bound">v'</span><span class="main">.</span> <span class="main">⟦</span> lookup <span class="free">ρ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="bound">v'</span><span class="main">;</span> <span class="free">v</span> <span class="main">⊑</span> <span class="bound">v'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="ChangeEnv-e_lam_elim"><span class="command">lemma</span></span> e_lam_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v</span> <span class="main">∈</span> E <span class="main">(</span>ELam <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="free">ρ</span><span class="main">;</span>
   <span class="main">⋀</span> <span class="bound">f</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">v</span> <span class="main">=</span> VFun <span class="bound">f</span><span class="main">;</span> <span class="main">∀</span> <span class="bound">v1</span> <span class="bound">v2</span><span class="main">.</span> <span class="main">(</span><span class="bound">v1</span><span class="main">,</span><span class="bound">v2</span><span class="main">)</span> <span class="main">∈</span> fset <span class="bound">f</span> <span class="main">⟶</span> <span class="bound">v2</span> <span class="main">∈</span> E <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">v1</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="ChangeEnv-e_lam_elim2"><span class="command">lemma</span></span> e_lam_elim2<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> VFun <span class="main">(</span>finsert <span class="main">(</span><span class="free">v1</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span> <span class="main">∈</span> E <span class="main">(</span>ELam <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="free">ρ</span><span class="main">;</span>
   <span class="main">⟦</span> <span class="free">v2</span> <span class="main">∈</span> E <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">v1</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="ChangeEnv-e_if_elim"><span class="command">lemma</span></span> e_if_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v</span> <span class="main">∈</span> E <span class="main">(</span>EIf <span class="free">e1</span> <span class="free">e2</span> <span class="free">e3</span><span class="main">)</span> <span class="free">ρ</span><span class="main">;</span>
   <span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="main">⟦</span> VNat <span class="bound">n</span> <span class="main">∈</span> E <span class="free">e1</span> <span class="free">ρ</span><span class="main">;</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free">v</span> <span class="main">∈</span> E <span class="free">e3</span> <span class="free">ρ</span><span class="main">;</span> <span class="bound">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free">v</span> <span class="main">∈</span> E <span class="free">e2</span> <span class="free">ρ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">xenv_le</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name set <span class="main">⇒</span> env <span class="main">⇒</span> env <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">⊑</span> _"</span> <span class="main">[</span>51<span class="main">,</span>51<span class="main">,</span>51<span class="main">]</span> 52<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊑</span></span> <span class="free"><span class="bound"><span class="entity">ρ'</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">x</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∧</span> lookup <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v'</span><span class="main">.</span> lookup <span class="free"><span class="bound"><span class="entity">ρ'</span></span></span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">v'</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">⊑</span> <span class="bound">v'</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">declare</span></span> xenv_le_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
    
<span class="keyword1"><span class="command">proposition</span></span> change_env_le<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span><span class="main">::</span><span class="quoted">val</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ρ</span><span class="main">::</span><span class="quoted">env</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> de<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vp_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v'</span> <span class="main">⊑</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rr<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="free">e</span> <span class="main">⊢</span> <span class="free">ρ</span> <span class="main">⊑</span> <span class="free">ρ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v'</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> de rr vp_v
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">v'</span></span> <span class="quoted"><span class="free">ρ</span></span> <span class="quoted"><span class="free">ρ'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exp.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>EVar <span class="skolem">x</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="skolem">ρ</span> <span class="skolem">ρ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> EVar <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v2</span></span> <span class="keyword2"><span class="keyword">where</span></span> lx<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="skolem">ρ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">v2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v_v2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">⊑</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> lx EVar <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v3</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    lx2<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="skolem">ρ'</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">v3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v2_v3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">⊑</span> <span class="skolem">v3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> v_v2 v2_v3 <span class="keyword1"><span class="command">have</span></span> v_v3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">⊑</span> <span class="skolem">v3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> val_le_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> EVar v_v3 <span class="keyword1"><span class="command">have</span></span> vp_v3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">⊑</span> <span class="skolem">v3</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> val_le_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> lx2 vp_v3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> e_var_intro<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ENat <span class="skolem">n</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ELam <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ELam<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> VFun <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    body<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v1</span> <span class="bound">v2</span><span class="main">.</span> <span class="main">(</span><span class="bound">v1</span><span class="main">,</span><span class="bound">v2</span><span class="main">)</span> <span class="main">∈</span> fset <span class="skolem">f</span> <span class="main">⟶</span> <span class="bound">v2</span> <span class="main">∈</span> E <span class="skolem">e</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="bound">v1</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> v ELam<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> vp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> VFun <span class="skolem">f'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fp_f<span class="main">:</span> <span class="quoted"><span class="quoted">"fset <span class="skolem">f'</span> <span class="main">⊆</span> fset <span class="skolem">f</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">v'</span></span><span class="main">)</span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> vp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v1</span> <span class="skolem">v2</span> <span class="keyword3"><span class="command">assume</span></span> v12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v1</span><span class="main">,</span><span class="skolem">v2</span><span class="main">)</span><span class="main">∈</span> fset <span class="skolem">f'</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> v12 fp_f <span class="keyword1"><span class="command">have</span></span> v34<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v1</span><span class="main">,</span><span class="skolem">v2</span><span class="main">)</span> <span class="main">∈</span> fset <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> v34 body <span class="keyword1"><span class="command">have</span></span> v4_E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> E <span class="skolem">e</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">v1</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> ELam<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> rr2<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="skolem">e</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">v1</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">v1</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> ELam<span class="main">(</span>1<span class="main">)</span> v4_E rr2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> E <span class="skolem">e</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">v1</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>EApp <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> EApp<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">v2</span></span><span class="main">::</span><span class="quoted">val</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">v2'</span></span> <span class="skolem"><span class="skolem">v3'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    f_e1<span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="skolem">f</span> <span class="main">∈</span> E <span class="skolem">e1</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v2_e2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> E <span class="skolem">e2</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    v23p_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v2'</span><span class="main">,</span><span class="skolem">v3'</span><span class="main">)</span> <span class="main">∈</span> fset <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v2p_v2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2'</span> <span class="main">⊑</span> <span class="skolem">v2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v_v3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">⊑</span> <span class="skolem">v3'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> EApp<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="skolem">e1</span> <span class="main">⊢</span> <span class="skolem">ρ</span> <span class="main">⊑</span> <span class="skolem">ρ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> f_f<span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="skolem">f</span> <span class="main">⊑</span> VFun <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> EApp<span class="main">(</span>1<span class="main">)</span> f_e1 1 f_f <span class="keyword1"><span class="command">have</span></span> f_e1b<span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="skolem">f</span> <span class="main">∈</span> E <span class="skolem">e1</span> <span class="skolem">ρ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> EApp<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="skolem">e2</span> <span class="main">⊢</span> <span class="skolem">ρ</span> <span class="main">⊑</span> <span class="skolem">ρ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> EApp<span class="main">(</span>2<span class="main">)</span> v2_e2 2 <span class="keyword1"><span class="command">have</span></span> v2_e2b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> E <span class="skolem">e2</span> <span class="skolem">ρ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> EApp<span class="main">(</span>5<span class="main">)</span> v_v3 <span class="keyword1"><span class="command">have</span></span> vp_v3p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">⊑</span> <span class="skolem">v3'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> val_le_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> f_e1b v2_e2b v23p_f v2p_v2 vp_v3p
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>EPrim <span class="skolem">f</span> <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> EPrim<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n1</span></span> <span class="skolem"><span class="skolem">n2</span></span> <span class="keyword2"><span class="keyword">where</span></span> n1_e1<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n1</span> <span class="main">∈</span> E <span class="skolem">e1</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    n2_e2<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n2</span> <span class="main">∈</span> E <span class="skolem">e2</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> VNat <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n1</span> <span class="skolem">n2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> EPrim<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="skolem">e1</span> <span class="main">⊢</span> <span class="skolem">ρ</span> <span class="main">⊑</span> <span class="skolem">ρ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> EPrim<span class="main">(</span>1<span class="main">)</span> n1_e1 1 <span class="keyword1"><span class="command">have</span></span> n1_e1b<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n1</span> <span class="main">∈</span> E <span class="skolem">e1</span> <span class="skolem">ρ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> EPrim<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="skolem">e2</span> <span class="main">⊢</span> <span class="skolem">ρ</span> <span class="main">⊑</span> <span class="skolem">ρ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> EPrim<span class="main">(</span>2<span class="main">)</span> n2_e2 2 <span class="keyword1"><span class="command">have</span></span> n2_e2b<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n2</span> <span class="main">∈</span> E <span class="skolem">e2</span> <span class="skolem">ρ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> v EPrim<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> vp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> VNat <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n1</span> <span class="skolem">n2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> n1_e1b n2_e2b vp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>EIf <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e3</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="comment1">― ‹Subsumption is admissible›</span> 
<span class="keyword1"><span class="command">proposition</span></span> e_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ</span><span class="main">;</span> <span class="free">v'</span> <span class="main">⊑</span> <span class="free">v</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">v'</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"FV <span class="free">e</span> <span class="main">⊢</span> <span class="free">ρ</span> <span class="main">⊑</span> <span class="free">ρ</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> change_env_le <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ChangeEnv-env_le_ext"><span class="command">lemma</span></span> env_le_ext<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ρ</span><span class="main">::</span><span class="quoted">env</span> <span class="keyword2"><span class="keyword">assumes</span></span> rr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">⊑</span> <span class="free">ρ'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">ρ'</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">using</span></span> rr <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_le_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ChangeEnv-change_env"><span class="command">lemma</span></span> change_env<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ρ</span><span class="main">::</span><span class="quoted">env</span> <span class="keyword2"><span class="keyword">assumes</span></span> de<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rr<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="free">e</span> <span class="main">⊢</span> <span class="free">ρ</span> <span class="main">⊑</span> <span class="free">ρ'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> vv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⊑</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> de rr vv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> change_env_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="ChangeEnv-raise_env"><span class="command">lemma</span></span> raise_env<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ρ</span><span class="main">::</span><span class="quoted">env</span> <span class="keyword2"><span class="keyword">assumes</span></span> de<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">⊑</span> <span class="free">ρ'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> de rr change_env env_le_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="ChangeEnv-env_eq_refl"><span class="command">lemma</span></span> env_eq_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ρ</span><span class="main">::</span><span class="quoted">env</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">≈</span> <span class="free">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_eq_def<span class="main">)</span> 

<span class="keyword1" id="ChangeEnv-env_eq_ext"><span class="command">lemma</span></span> env_eq_ext<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ρ</span><span class="main">::</span><span class="quoted">env</span> <span class="keyword2"><span class="keyword">assumes</span></span> rr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">≈</span> <span class="free">ρ'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">ρ'</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">using</span></span> rr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_eq_def<span class="main">)</span> 

<span class="keyword1" id="ChangeEnv-eq_implies_le"><span class="command">lemma</span></span> eq_implies_le<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ρ</span><span class="main">::</span><span class="quoted">env</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">≈</span> <span class="free">ρ'</span> <span class="main">⟹</span> <span class="free">ρ</span> <span class="main">⊑</span> <span class="free">ρ'</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_le_def env_eq_def<span class="main">)</span> 

<span class="keyword1" id="ChangeEnv-env_swap"><span class="command">lemma</span></span> env_swap<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ρ</span><span class="main">::</span><span class="quoted">env</span> <span class="keyword2"><span class="keyword">assumes</span></span> rr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">≈</span> <span class="free">ρ'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ve<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rr ve <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">⊑</span> <span class="free">ρ'</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eq_implies_le<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> raise_env<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ChangeEnv-env_strengthen"><span class="command">lemma</span></span> env_strengthen<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ</span><span class="main">;</span> <span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> FV <span class="free">e</span> <span class="main">⟶</span> lookup <span class="free">ρ'</span> <span class="bound">x</span> <span class="main">=</span> lookup <span class="free">ρ</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> change_env <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DeclSemAsNDInterpFSet">
<div class="head">
<h1>Theory DeclSemAsNDInterpFSet</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Declarative semantics as a non-deterministic interpreter"</span></span>
  
<span class="keyword1"><span class="command">theory</span></span> DeclSemAsNDInterpFSet
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Lambda.html">Lambda</a> <a href="ValuesFSet.html">ValuesFSet</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Non-determinism monad"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> M <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">set_bind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> M <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> M<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> M"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">set_bind</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="bound">v</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">v'</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">v'</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> set_bind_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_set_bind"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>pttrns<span class="main">,</span><span class="tfree">'a</span> M<span class="main">,</span><span class="tfree">'b</span><span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_ <span class="keyword1">←</span> _<span class="keyword1">;</span><span class="keyword3">//</span>_<span class="keyword3">)</span>"</span> 0<span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="free">P</span> <span class="main">←</span> <span class="free">E</span><span class="main">;</span> <span class="free">F</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> set_bind <span class="free">E</span> <span class="main">(</span><span class="main">λ</span><span class="free">P</span><span class="main">.</span> <span class="free">F</span><span class="main">)</span>"</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">return</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> M"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">return</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> return_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">zero</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> M"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">zero</span> <span class="main">≡</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> zero_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">no_notation</span></span> <span class="quoted">"binomial"</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">choose</span>"</span> 65<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">choose</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> M"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">choose</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> choose_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
 
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">down</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> val M"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">down</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="bound">v'</span> <span class="main">←</span> UNIV<span class="main">;</span> <span class="keyword1">if</span> <span class="bound">v'</span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">then</span> return <span class="bound">v'</span> <span class="keyword1">else</span> zero<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> down_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mapM</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fset <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> M<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> fset<span class="main">)</span> M"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mapM</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> ffold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span><span class="main">;</span> <span class="bound">bs</span> <span class="main">←</span> <span class="bound">r</span><span class="main">;</span> return <span class="main">(</span>finsert <span class="bound">b</span> <span class="bound">bs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>return <span class="main">(</span><span class="main">{||}</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span>"</span></span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Non-deterministic interpreter"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">apply_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val M <span class="main">⇒</span> val M <span class="main">⇒</span> val M"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">apply_fun</span> <span class="free"><span class="bound"><span class="entity">V1</span></span></span> <span class="free"><span class="bound"><span class="entity">V2</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="bound">v1</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">V1</span></span></span><span class="main">;</span> <span class="bound">v2</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">V2</span></span></span><span class="main">;</span>
                       <span class="keyword1">case</span> <span class="bound">v1</span> <span class="keyword1">of</span> VFun <span class="bound">f</span> <span class="main">⇒</span> 
                          <span class="main">(</span><span class="bound">v2'</span><span class="main">,</span><span class="bound">v3'</span><span class="main">)</span> <span class="main">←</span> choose <span class="main">(</span>fset <span class="bound">f</span><span class="main">)</span><span class="main">;</span>
                          <span class="keyword1">if</span> <span class="bound">v2'</span> <span class="main">⊑</span> <span class="bound">v2</span> <span class="keyword1">then</span> return <span class="bound">v3'</span> <span class="keyword1">else</span> zero
                       <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> zero<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">E</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> env <span class="main">⇒</span> val set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  Enat2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>ENat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> return <span class="main">(</span>VNat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  Evar2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>EVar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> lookup <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> zero <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> down <span class="bound">v</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  Elam2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>ELam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="bound">vs</span> <span class="main">←</span> choose UNIV<span class="main">;</span> 
                           <span class="bound">t</span> <span class="main">←</span> mapM <span class="bound">vs</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">v'</span> <span class="main">←</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span><span class="main">;</span> return <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                           return <span class="main">(</span>VFun <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  Eapp2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>EApp <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> apply_fun <span class="main">(</span><span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  Eprim2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>EPrim <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">←</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">;</span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">←</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">;</span>
                                 <span class="keyword1">case</span> <span class="main">(</span><span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span><span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="keyword1">of</span>
                                   <span class="main">(</span>VNat <span class="bound">n<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> VNat <span class="bound">n<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⇒</span> return <span class="main">(</span>VNat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">n<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">n<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>
                                <span class="main">|</span> <span class="main">(</span>VNat <span class="bound">n<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> VFun <span class="bound">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⇒</span> zero
                                <span class="main">|</span> <span class="main">(</span>VFun <span class="bound">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⇒</span> zero<span class="main">)</span>"</span></span> <span class="main">|</span>
  Eif2<span class="main">[</span><span class="operator">eta_contract</span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span></span></span></span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">false</span></span></span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>EIf <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">←</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">;</span>
                              <span class="keyword1">case</span> <span class="bound">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">of</span>
                                <span class="main">(</span>VNat <span class="bound">n</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="keyword1">else</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span>
                              <span class="main">|</span> <span class="main">(</span>VFun <span class="bound">t</span><span class="main">)</span> <span class="main">⇒</span> zero<span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
  
</pre>
</div><div id="InterTypeSystem">
<div class="head">
<h1>Theory InterTypeSystem</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Declarative semantics as a type system"</span></span>

<span class="keyword1"><span class="command">theory</span></span> InterTypeSystem
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Lambda.html">Lambda</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> ty <span class="main">=</span> TNat <span class="quoted">nat</span> <span class="main">|</span> TFun <span class="quoted">funty</span>
    <span class="keyword2"><span class="keyword">and</span></span> funty <span class="main">=</span> TArrow <span class="quoted">ty</span> <span class="quoted">ty</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">→</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 55<span class="main">)</span> <span class="main">|</span> TInt <span class="quoted">funty</span> <span class="quoted">funty</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⊓</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 56<span class="main">)</span> <span class="main">|</span> TTop <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⊤</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">subtype</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ty <span class="main">⇒</span> ty <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&lt;:</span>"</span> 52<span class="main">)</span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">fsubtype</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"funty <span class="main">⇒</span> funty <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">&lt;::</span>"</span> 52<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  sub_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">&lt;:</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span> <span class="main">|</span>
  sub_funty<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="main"><span class="free">&lt;::</span></span> <span class="free"><span class="bound"><span class="entity">f2</span></span></span> <span class="main">⟹</span> TFun <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="main"><span class="free">&lt;:</span></span> TFun <span class="free"><span class="bound"><span class="entity">f2</span></span></span>"</span></span> <span class="main">|</span> 
  sub_fun<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">T1</span></span></span> <span class="main"><span class="free">&lt;:</span></span> <span class="free"><span class="bound"><span class="entity">T1'</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">T1'</span></span></span> <span class="main"><span class="free">&lt;:</span></span> <span class="free"><span class="bound"><span class="entity">T1</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">T2</span></span></span> <span class="main"><span class="free">&lt;:</span></span> <span class="free"><span class="bound"><span class="entity">T2'</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">T2'</span></span></span> <span class="main"><span class="free">&lt;:</span></span> <span class="free"><span class="bound"><span class="entity">T2</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T1</span></span></span><span class="main">→</span><span class="free"><span class="bound"><span class="entity">T2</span></span></span><span class="main">)</span> <span class="main"><span class="free">&lt;::</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T1'</span></span></span><span class="main">→</span><span class="free"><span class="bound"><span class="entity">T2'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  sub_inter_l1<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">T1</span></span></span> <span class="main">⊓</span> <span class="free"><span class="bound"><span class="entity">T2</span></span></span> <span class="main"><span class="free">&lt;::</span></span> <span class="free"><span class="bound"><span class="entity">T1</span></span></span>"</span></span> <span class="main">|</span>
  sub_inter_l2<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">T1</span></span></span> <span class="main">⊓</span> <span class="free"><span class="bound"><span class="entity">T2</span></span></span> <span class="main"><span class="free">&lt;::</span></span> <span class="free"><span class="bound"><span class="entity">T2</span></span></span>"</span></span> <span class="main">|</span>
  sub_inter_r<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">T3</span></span></span> <span class="main"><span class="free">&lt;::</span></span> <span class="free"><span class="bound"><span class="entity">T1</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">T3</span></span></span> <span class="main"><span class="free">&lt;::</span></span> <span class="free"><span class="bound"><span class="entity">T2</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">T3</span></span></span> <span class="main"><span class="free">&lt;::</span></span> <span class="free"><span class="bound"><span class="entity">T1</span></span></span> <span class="main">⊓</span> <span class="free"><span class="bound"><span class="entity">T2</span></span></span>"</span></span> <span class="main">|</span>
  sub_fun_top<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">T1</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">T2</span></span></span> <span class="main"><span class="free">&lt;::</span></span> <span class="main">⊤</span>"</span></span> <span class="main">|</span>
  sub_top_top<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊤</span> <span class="main"><span class="free">&lt;::</span></span> <span class="main">⊤</span>"</span></span> <span class="main">|</span>
  fsub_refl<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main"><span class="free">&lt;::</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span> <span class="main">|</span>
  sub_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">T1</span></span></span> <span class="main"><span class="free">&lt;::</span></span> <span class="free"><span class="bound"><span class="entity">T2</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">T2</span></span></span> <span class="main"><span class="free">&lt;::</span></span> <span class="free"><span class="bound"><span class="entity">T3</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">T1</span></span></span> <span class="main"><span class="free">&lt;::</span></span> <span class="free"><span class="bound"><span class="entity">T3</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ty_eq</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"ty <span class="main">⇒</span> ty <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≈</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">≈</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">&lt;:</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">&lt;:</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fty_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"funty <span class="main">⇒</span> funty <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≃</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">F1</span></span></span> <span class="main"><span class="free">≃</span></span> <span class="free"><span class="bound"><span class="entity">F2</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">F1</span></span></span> <span class="main">&lt;::</span> <span class="free"><span class="bound"><span class="entity">F2</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">F2</span></span></span> <span class="main">&lt;::</span> <span class="free"><span class="bound"><span class="entity">F1</span></span></span>"</span></span>
  
<span class="keyword1"><span class="command">type_synonym</span></span> tyenv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> ty<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">wt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tyenv <span class="main">⇒</span> exp <span class="main">⇒</span> ty <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">:</span> _"</span> <span class="main">[</span>51<span class="main">,</span>51<span class="main">,</span>51<span class="main">]</span> 51<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  wt_var<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> EVar <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span>"</span></span> <span class="main">|</span>
  wt_nat<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> ENat <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">:</span></span> TNat <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> <span class="main">|</span>
  wt_lam<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> ELam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> TFun <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  wt_app<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">:</span></span> TFun <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> EApp <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span> <span class="main">|</span>
  wt_top<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> ELam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> TFun <span class="main">⊤</span>"</span></span> <span class="main">|</span>
  wt_inter<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> ELam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> TFun <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> ELam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> TFun <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟧</span> 
       <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> ELam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> TFun <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⊓</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  wt_sub<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">&lt;:</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span> <span class="main">|</span>
  wt_prim<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">:</span></span> TNat <span class="free"><span class="bound"><span class="entity">n1</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">:</span></span> TNat <span class="free"><span class="bound"><span class="entity">n2</span></span></span> <span class="main">⟧</span>
       <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> EPrim <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">:</span></span> TNat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  wt_ifz<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">:</span></span> TNat <span class="main">0</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟧</span> 
       <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> EIf <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span> <span class="main">|</span>
  wt_ifnz<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main"><span class="free">:</span></span> TNat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≠</span> <span class="main">0</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟧</span>
     <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> EIf <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
  
  
</pre>
</div><div id="Values">
<div class="head">
<h1>Theory Values</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Declarative semantics with tables as lists"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  The semantics that represents function tables as lists is largely obsolete,
  being replaced by the finite set representation. However, the proof
  of equivalence to the intersection type system still uses the version
  based on lists.
›</span></span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Definition of values for declarative semantics"</span></span> 

<span class="keyword1"><span class="command">theory</span></span> Values
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="Lambda.html">Lambda</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">datatype</span></span> val <span class="main">=</span> VNat <span class="quoted">nat</span> <span class="main">|</span> VFun <span class="quoted"><span class="quoted">"<span class="main">(</span>val <span class="main">×</span> val<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> func <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>val <span class="main">×</span> val<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">val_le</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> val <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊑</span>"</span> 52<span class="main">)</span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">fun_le</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"func <span class="main">⇒</span> func <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≲</span>"</span> 52<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  vnat_le<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>VNat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊑</span></span> <span class="main">(</span>VNat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  vfun_le<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main"><span class="free">≲</span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">⟹</span> <span class="main">(</span>VFun <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊑</span></span> <span class="main">(</span>VFun <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  fun_le<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">v1</span> <span class="bound">v2</span><span class="main">.</span> <span class="main">(</span><span class="bound">v1</span><span class="main">,</span><span class="bound">v2</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">⟶</span> 
                       <span class="main">(</span><span class="main">∃</span> <span class="bound">v3</span> <span class="bound">v4</span><span class="main">.</span> <span class="main">(</span><span class="bound">v3</span><span class="main">,</span><span class="bound">v4</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">t2</span></span></span> 
                        <span class="main">∧</span> <span class="bound">v1</span> <span class="main"><span class="free">⊑</span></span> <span class="bound">v3</span> <span class="main">∧</span> <span class="bound">v3</span> <span class="main"><span class="free">⊑</span></span> <span class="bound">v1</span> <span class="main">∧</span> <span class="bound">v2</span> <span class="main"><span class="free">⊑</span></span> <span class="bound">v4</span> <span class="main">∧</span> <span class="bound">v4</span> <span class="main"><span class="free">⊑</span></span> <span class="bound">v2</span><span class="main">)</span><span class="main">)</span>
                   <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main"><span class="free">≲</span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> env <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>name <span class="main">×</span> val<span class="main">)</span> list<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">env_le</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"env <span class="main">⇒</span> env <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊑</span>"</span> 52<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊑</span></span> <span class="free"><span class="bound"><span class="entity">ρ'</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">x</span> <span class="bound">v</span><span class="main">.</span> lookup <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v'</span><span class="main">.</span> lookup <span class="free"><span class="bound"><span class="entity">ρ'</span></span></span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">v'</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">⊑</span> <span class="bound">v'</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">env_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"env <span class="main">⇒</span> env <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≈</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">≈</span></span> <span class="free"><span class="bound"><span class="entity">ρ'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> lookup <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="bound">x</span> <span class="main">=</span> lookup <span class="free"><span class="bound"><span class="entity">ρ'</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
  
</pre>
</div><div id="ValueProps">
<div class="head">
<h1>Theory ValueProps</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Properties about values"</span></span>

<span class="keyword1"><span class="command">theory</span></span> ValueProps
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Values.html">Values</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> fun_le_inv<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">≲</span> <span class="free">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  vfun_le_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="free">t1</span> <span class="main">⊑</span> VFun <span class="free">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  le_fun_nat_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="free">t2</span> <span class="main">⊑</span> VNat <span class="free">x1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  le_fun_cons_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v1</span><span class="main">,</span> <span class="free">v2</span><span class="main">)</span> <span class="main">#</span> <span class="free">t1</span> <span class="main">≲</span> <span class="free">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  le_any_nat_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⊑</span> VNat <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  le_nat_any_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="free">n</span> <span class="main">⊑</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  le_fun_any_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="free">t</span> <span class="main">⊑</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  le_any_fun_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⊑</span> VFun <span class="free">t</span>"</span></span>

<span class="keyword1" id="ValueProps-fun_le_cons"><span class="command">lemma</span></span> fun_le_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">t1</span><span class="main">)</span> <span class="main">≲</span> <span class="free">t2</span> <span class="main">⟹</span> <span class="free">t1</span> <span class="main">≲</span> <span class="free">t2</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">val_size</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">fun_size</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"func <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">val_size</span> <span class="main">(</span>VNat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">val_size</span> <span class="main">(</span>VFun <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">fun_size</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">fun_size</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">fun_size</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">val_size</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">+</span> <span class="free">val_size</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">+</span> <span class="free">fun_size</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">val_size</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">size_change</span>

<span class="keyword1" id="ValueProps-val_size_mem"><span class="command">lemma</span></span> val_size_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">t</span> <span class="main">⟹</span> val_size <span class="free">a</span> <span class="main">+</span> val_size <span class="free">b</span> <span class="main">&lt;</span> fun_size <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="ValueProps-val_size_mem_l"><span class="command">lemma</span></span> val_size_mem_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">t</span> <span class="main">⟹</span> val_size <span class="free">a</span> <span class="main">&lt;</span> fun_size <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1" id="ValueProps-val_size_mem_r"><span class="command">lemma</span></span> val_size_mem_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">t</span> <span class="main">⟹</span> val_size <span class="free">b</span> <span class="main">&lt;</span> fun_size <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>
        
<span class="keyword1" id="ValueProps-val_fun_le_refl"><span class="command">lemma</span></span> val_fun_le_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="bound">t</span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> val_size <span class="bound">v</span> <span class="main">+</span> fun_size <span class="bound">t</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">⊑</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">≲</span> <span class="bound">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span><span class="main">::</span><span class="quoted">val</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t</span><span class="main">::</span><span class="quoted">func</span> <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> val_size <span class="skolem">v</span> <span class="main">+</span> fun_size <span class="skolem">t</span>"</span></span>     
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">⊑</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>VNat <span class="skolem">x1</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>VFun <span class="skolem">t'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"val_size <span class="main">(</span>VNat <span class="main">0</span><span class="main">)</span> <span class="main">+</span> fun_size <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> 1 n VFun <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">≲</span> <span class="skolem">t'</span>"</span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?m</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"VNat <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">from</span></span> this VFun <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span><span class="main">::</span><span class="quoted">val</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t</span><span class="main">::</span><span class="quoted">func</span> <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> val_size <span class="skolem">v</span> <span class="main">+</span> fun_size <span class="skolem">t</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≲</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fun_le<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v1</span> <span class="skolem">v2</span> <span class="keyword3"><span class="command">assume</span></span> v12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v1</span><span class="main">,</span><span class="skolem">v2</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> 1 v12 <span class="keyword1"><span class="command">have</span></span> v11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">⊑</span> <span class="skolem">v1</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"val_size <span class="skolem">v1</span> <span class="main">+</span> fun_size <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> val_size_mem<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">v1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">from</span></span> 1 v12 <span class="keyword1"><span class="command">have</span></span> v22<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">⊑</span> <span class="skolem">v2</span>"</span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"val_size <span class="skolem">v2</span> <span class="main">+</span> fun_size <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> val_size_mem<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">v2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">from</span></span> v12 v11 v22
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v3</span> <span class="bound">v4</span><span class="main">.</span> <span class="main">(</span><span class="bound">v3</span><span class="main">,</span><span class="bound">v4</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">t</span> <span class="main">∧</span> <span class="skolem">v1</span> <span class="main">⊑</span> <span class="bound">v3</span> <span class="main">∧</span> <span class="bound">v3</span> <span class="main">⊑</span> <span class="skolem">v1</span> <span class="main">∧</span> <span class="skolem">v2</span> <span class="main">⊑</span> <span class="bound">v4</span> <span class="main">∧</span> <span class="bound">v4</span> <span class="main">⊑</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> val_le_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span><span class="main">::</span><span class="quoted">val</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⊑</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> val_fun_le_refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
<span class="keyword1" id="ValueProps-fun_le_refl"><span class="command">lemma</span></span> fun_le_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span><span class="main">::</span><span class="quoted">func</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≲</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> val_fun_le_refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">val_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> val <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">∼</span>"</span> 52<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">val_eq</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fun_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"func <span class="main">⇒</span> func <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">∼</span>"</span> 52<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fun_eq</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">≲</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">≲</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1" id="ValueProps-vfun_eq"><span class="command">lemma</span></span> vfun_eq<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∼</span> <span class="free">t'</span> <span class="main">⟹</span> VFun <span class="free">t</span> <span class="main">∼</span> VFun <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> val_eq_def fun_eq_def<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfun_le<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> vfun_le<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
 
<span class="keyword1" id="ValueProps-val_eq_refl"><span class="command">lemma</span></span> val_eq_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span><span class="main">::</span><span class="quoted">val</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∼</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> val_eq_def<span class="main">)</span> 

<span class="keyword1" id="ValueProps-val_eq_symm"><span class="command">lemma</span></span> val_eq_symm<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v1</span><span class="main">::</span><span class="quoted">val</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">v2</span><span class="main">::</span><span class="quoted">val</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">∼</span> <span class="free">v2</span> <span class="main">⟹</span> <span class="free">v2</span> <span class="main">∼</span> <span class="free">v1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> val_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    
<span class="keyword1" id="ValueProps-val_le_fun_le_trans"><span class="command">lemma</span></span> val_le_fun_le_trans<span class="main">:</span> 
   <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v2</span> <span class="bound">t2</span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> val_size <span class="bound">v2</span> <span class="main">+</span> fun_size <span class="bound">t2</span> <span class="main">⟶</span> 
    <span class="main">(</span><span class="main">∀</span> <span class="bound">v1</span> <span class="bound">v3</span><span class="main">.</span> <span class="bound">v1</span> <span class="main">⊑</span> <span class="bound">v2</span> <span class="main">⟶</span> <span class="bound">v2</span> <span class="main">⊑</span> <span class="bound">v3</span> <span class="main">⟶</span> <span class="bound">v1</span> <span class="main">⊑</span> <span class="bound">v3</span><span class="main">)</span> 
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">t1</span> <span class="bound">t3</span><span class="main">.</span> <span class="bound">t1</span> <span class="main">≲</span> <span class="bound">t2</span> <span class="main">⟶</span> <span class="bound">t2</span> <span class="main">≲</span> <span class="bound">t3</span> <span class="main">⟶</span> <span class="bound">t1</span> <span class="main">≲</span> <span class="bound">t3</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v2</span> <span class="skolem">t2</span> <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> val_size <span class="skolem">v2</span> <span class="main">+</span> fun_size <span class="skolem">t2</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v1</span> <span class="bound">v3</span><span class="main">.</span> <span class="bound">v1</span> <span class="main">⊑</span> <span class="skolem">v2</span> <span class="main">⟶</span> <span class="skolem">v2</span> <span class="main">⊑</span> <span class="bound">v3</span> <span class="main">⟶</span> <span class="bound">v1</span> <span class="main">⊑</span> <span class="bound">v3</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v1</span> <span class="skolem">v3</span> <span class="keyword3"><span class="command">assume</span></span> v12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">⊑</span> <span class="skolem">v2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v23<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">⊑</span> <span class="skolem">v3</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">⊑</span> <span class="skolem">v3</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v2</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>VNat <span class="skolem">n</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> VNat v12 <span class="keyword1"><span class="command">have</span></span> v1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">=</span> VNat <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">from</span></span> VNat v23 <span class="keyword1"><span class="command">have</span></span> v3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v3</span> <span class="main">=</span> VNat <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">from</span></span> v1 v3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>VFun <span class="skolem">t2'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> v12 VFun <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t1</span></span> <span class="keyword2"><span class="keyword">where</span></span> t12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">≲</span> <span class="skolem">t2'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">=</span> VFun <span class="skolem">t1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> v23 VFun <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t3</span></span> <span class="keyword2"><span class="keyword">where</span></span> t23<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t2'</span> <span class="main">≲</span> <span class="skolem">t3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v3</span> <span class="main">=</span> VFun <span class="skolem">t3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"val_size <span class="main">(</span>VNat <span class="main">0</span><span class="main">)</span> <span class="main">+</span> fun_size <span class="skolem">t2'</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> 1 n VFun <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t1</span> <span class="bound">t3</span><span class="main">.</span> <span class="bound">t1</span> <span class="main">≲</span> <span class="skolem">t2'</span> <span class="main">⟶</span> <span class="skolem">t2'</span> <span class="main">≲</span> <span class="bound">t3</span> <span class="main">⟶</span> <span class="bound">t1</span> <span class="main">≲</span> <span class="bound">t3</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?m</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"VNat <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">t2'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span> 
        <span class="keyword1"><span class="command">from</span></span> t12 t23 IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">≲</span> <span class="skolem">t3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">from</span></span> this v1 v3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v5</span> <span class="skolem">t2</span> <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> val_size <span class="skolem">v5</span> <span class="main">+</span> fun_size <span class="skolem">t2</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t1</span> <span class="bound">t3</span><span class="main">.</span> <span class="bound">t1</span> <span class="main">≲</span> <span class="skolem">t2</span> <span class="main">⟶</span> <span class="skolem">t2</span> <span class="main">≲</span> <span class="bound">t3</span> <span class="main">⟶</span> <span class="bound">t1</span> <span class="main">≲</span> <span class="bound">t3</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t1</span> <span class="skolem">t3</span> <span class="skolem">v1</span> <span class="skolem">v2</span> <span class="keyword3"><span class="command">assume</span></span> t12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">≲</span> <span class="skolem">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t23<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">≲</span> <span class="skolem">t3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v1</span><span class="main">,</span><span class="skolem">v2</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">t1</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> v12 t12 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v1'</span></span> <span class="skolem"><span class="skolem">v2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> v12p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v1'</span><span class="main">,</span><span class="skolem">v2'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
          v1_v1p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">⊑</span> <span class="skolem">v1'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v11p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1'</span> <span class="main">⊑</span> <span class="skolem">v1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v22p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">⊑</span> <span class="skolem">v2'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v2p_v2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2'</span> <span class="main">⊑</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">from</span></span> v12p t23 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v1''</span></span> <span class="skolem"><span class="skolem">v2''</span></span> <span class="keyword2"><span class="keyword">where</span></span> v12pp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v1''</span><span class="main">,</span><span class="skolem">v2''</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">t3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         v1p_v1pp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1'</span> <span class="main">⊑</span> <span class="skolem">v1''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v11pp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1''</span> <span class="main">⊑</span> <span class="skolem">v1'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
         v22pp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2'</span> <span class="main">⊑</span> <span class="skolem">v2''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v2pp_v2p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2''</span> <span class="main">⊑</span> <span class="skolem">v2'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          
      <span class="keyword1"><span class="command">from</span></span> v12p <span class="keyword1"><span class="command">have</span></span> sv1p<span class="main">:</span> <span class="quoted"><span class="quoted">"val_size <span class="skolem">v1'</span> <span class="main">&lt;</span> fun_size <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> val_size_mem_l <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">from</span></span> v12 1 v11p v11pp n sv1p <span class="keyword1"><span class="command">have</span></span> v1pp_v1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1''</span> <span class="main">⊑</span> <span class="skolem">v1</span>"</span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"val_size <span class="skolem">v1'</span> <span class="main">+</span> fun_size <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">v1'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      
      <span class="keyword1"><span class="command">from</span></span> v12p <span class="keyword1"><span class="command">have</span></span> sv2p<span class="main">:</span> <span class="quoted"><span class="quoted">"val_size <span class="skolem">v2'</span> <span class="main">&lt;</span> fun_size <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> val_size_mem_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">from</span></span> v12 1 v22p v22pp n sv2p <span class="keyword1"><span class="command">have</span></span> v2_v2pp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">⊑</span> <span class="skolem">v2''</span>"</span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"val_size <span class="skolem">v2'</span> <span class="main">+</span> fun_size <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">v2'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

      <span class="keyword1"><span class="command">from</span></span> v12 1 v1_v1p v1p_v1pp n sv1p <span class="keyword1"><span class="command">have</span></span> v1_v1pp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">⊑</span> <span class="skolem">v1''</span>"</span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"val_size <span class="skolem">v1'</span> <span class="main">+</span> fun_size <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">v1'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      
      <span class="keyword1"><span class="command">from</span></span> v12 1 v2pp_v2p v2p_v2 n sv2p <span class="keyword1"><span class="command">have</span></span> v2pp_v2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2''</span> <span class="main">⊑</span> <span class="skolem">v2</span>"</span></span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"val_size <span class="skolem">v2'</span> <span class="main">+</span> fun_size <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">v2'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        
      <span class="keyword1"><span class="command">from</span></span> v12pp v1pp_v1 v2_v2pp v1_v1pp v2pp_v2
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">∃</span><span class="bound">v3</span> <span class="bound">v4</span><span class="main">.</span> <span class="main">(</span><span class="bound">v3</span><span class="main">,</span> <span class="bound">v4</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">t3</span> <span class="main">∧</span> <span class="skolem">v1</span> <span class="main">⊑</span> <span class="bound">v3</span> <span class="main">∧</span> <span class="bound">v3</span> <span class="main">⊑</span> <span class="skolem">v1</span> <span class="main">∧</span> <span class="skolem">v2</span> <span class="main">⊑</span> <span class="bound">v4</span> <span class="main">∧</span> <span class="bound">v4</span> <span class="main">⊑</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> val_le_trans<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v2</span><span class="main">::</span><span class="quoted">val</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v1</span> <span class="main">⊑</span> <span class="free">v2</span><span class="main">;</span> <span class="free">v2</span> <span class="main">⊑</span> <span class="free">v3</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">v1</span> <span class="main">⊑</span> <span class="free">v3</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> val_le_fun_le_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="ValueProps-fun_le_trans"><span class="command">lemma</span></span> fun_le_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">t1</span> <span class="main">≲</span> <span class="free">t2</span><span class="main">;</span> <span class="free">t2</span> <span class="main">≲</span> <span class="free">t3</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t1</span> <span class="main">≲</span> <span class="free">t3</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> val_le_fun_le_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
<span class="keyword1" id="ValueProps-val_eq_trans"><span class="command">lemma</span></span> val_eq_trans<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v1</span><span class="main">::</span><span class="quoted">val</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">v2</span><span class="main">::</span><span class="quoted">val</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">v3</span><span class="main">::</span><span class="quoted">val</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> v12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">∼</span> <span class="free">v2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v23<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v2</span> <span class="main">∼</span> <span class="free">v3</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">∼</span> <span class="free">v3</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> v12 v23 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> val_eq_def<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> val_le_trans <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
<span class="keyword1" id="ValueProps-fun_eq_refl"><span class="command">lemma</span></span> fun_eq_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span><span class="main">::</span><span class="quoted">func</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∼</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_def<span class="main">)</span> 

<span class="keyword1" id="ValueProps-fun_eq_trans"><span class="command">lemma</span></span> fun_eq_trans<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t1</span><span class="main">::</span><span class="quoted">func</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">t2</span><span class="main">::</span><span class="quoted">func</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">t3</span><span class="main">::</span><span class="quoted">func</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> t12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">∼</span> <span class="free">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t23<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t2</span> <span class="main">∼</span> <span class="free">t3</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">∼</span> <span class="free">t3</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> t12 t23 <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fun_le_trans<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fun_le_trans<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
<span class="keyword1" id="ValueProps-append_fun_le"><span class="command">lemma</span></span> append_fun_le<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">t1'</span> <span class="main">≲</span> <span class="free">t1</span><span class="main">;</span> <span class="free">t2'</span> <span class="main">≲</span> <span class="free">t2</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t1'</span> <span class="main">@</span> <span class="free">t2'</span> <span class="main">≲</span> <span class="free">t1</span> <span class="main">@</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fun_le<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> fun_le_inv<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ValueProps-append_fun_equiv"><span class="command">lemma</span></span> append_fun_equiv<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">t1'</span> <span class="main">∼</span> <span class="free">t1</span><span class="main">;</span> <span class="free">t2'</span> <span class="main">∼</span> <span class="free">t2</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t1'</span> <span class="main">@</span> <span class="free">t2'</span> <span class="main">∼</span> <span class="free">t1</span> <span class="main">@</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> val_eq_def fun_eq_def<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> append_fun_le <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ValueProps-append_leq_symm"><span class="command">lemma</span></span> append_leq_symm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t2</span> <span class="main">@</span> <span class="free">t1</span> <span class="main">≲</span> <span class="free">t1</span> <span class="main">@</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fun_le<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
<span class="keyword1" id="ValueProps-append_eq_symm"><span class="command">lemma</span></span> append_eq_symm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t2</span> <span class="main">@</span> <span class="free">t1</span> <span class="main">∼</span> <span class="free">t1</span> <span class="main">@</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_def val_eq_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> append_leq_symm<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> append_leq_symm<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="ValueProps-le_nat_any"><span class="command">lemma</span></span> le_nat_any<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="free">n</span> <span class="main">⊑</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">=</span> VNat <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="operator">auto</span> 

<span class="keyword1" id="ValueProps-le_any_nat"><span class="command">lemma</span></span> le_any_nat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⊑</span> VNat <span class="free">n</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">=</span> VNat <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="ValueProps-le_nat_nat"><span class="command">lemma</span></span> le_nat_nat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="free">n</span> <span class="main">⊑</span> VNat <span class="free">n'</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">=</span> <span class="free">n'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  
<span class="keyword2"><span class="keyword">end</span></span>
  
</pre>
</div><div id="DeclSemAsDenot">
<div class="head">
<h1>Theory DeclSemAsDenot</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Declarative semantics as a denotational semantics"</span></span>    

<span class="keyword1"><span class="command">theory</span></span> DeclSemAsDenot
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Lambda.html">Lambda</a> <a href="Values.html">Values</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">E</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> env <span class="main">⇒</span> val set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  Enat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>ENat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">=</span> VNat <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">}</span>"</span></span> <span class="main">|</span>
  Evar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>EVar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">v</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">v'</span><span class="main">.</span> lookup <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Some <span class="bound">v'</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">⊑</span> <span class="bound">v'</span> <span class="main">}</span>"</span></span> <span class="main">|</span>
  Elam<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>ELam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">v</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">v</span> <span class="main">=</span> VFun <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v1</span> <span class="bound">v2</span><span class="main">.</span> <span class="main">(</span><span class="bound">v1</span><span class="main">,</span> <span class="bound">v2</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">f</span> 
    <span class="main">⟶</span> <span class="bound">v2</span> <span class="main">∈</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="bound">v1</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">}</span>"</span></span> <span class="main">|</span>
  Eapp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>EApp <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">v3</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">f</span> <span class="bound">v2</span> <span class="bound">v2'</span> <span class="bound">v3'</span><span class="main">.</span> 
      VFun <span class="bound">f</span> <span class="main">∈</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">∧</span> <span class="bound">v2</span> <span class="main">∈</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">v2'</span><span class="main">,</span> <span class="bound">v3'</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">f</span> <span class="main">∧</span> <span class="bound">v2'</span> <span class="main">⊑</span> <span class="bound">v2</span> <span class="main">∧</span> <span class="bound">v3</span> <span class="main">⊑</span> <span class="bound">v3'</span> <span class="main">}</span>"</span></span> <span class="main">|</span>
  Eprim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>EPrim <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">v</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">n1</span> <span class="bound">n2</span><span class="main">.</span> VNat <span class="bound">n1</span> <span class="main">∈</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> 
          <span class="main">∧</span> VNat <span class="bound">n2</span> <span class="main">∈</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">=</span> VNat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">n1</span> <span class="bound">n2</span><span class="main">)</span> <span class="main">}</span>"</span></span> <span class="main">|</span>
  Eif<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>EIf <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">v</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> VNat <span class="bound">n</span> <span class="main">∈</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span>
         <span class="main">∧</span> <span class="main">(</span><span class="bound">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
  
  
</pre>
</div><div id="DenotLam5">
<div class="head">
<h1>Theory DenotLam5</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Subsumption and change of environment"</span></span>

<span class="keyword1"><span class="command">theory</span></span> DenotLam5
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="Lambda.html">Lambda</a> <a href="DeclSemAsDenot.html">DeclSemAsDenot</a> <a href="ValueProps.html">ValueProps</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="DenotLam5-e_prim_intro"><span class="command">lemma</span></span> e_prim_intro<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> VNat <span class="free">n1</span> <span class="main">∈</span> E <span class="free">e1</span> <span class="free">ρ</span><span class="main">;</span> VNat <span class="free">n2</span> <span class="main">∈</span> E <span class="free">e2</span> <span class="free">ρ</span><span class="main">;</span> <span class="free">v</span> <span class="main">=</span> VNat <span class="main">(</span><span class="free">f</span> <span class="free">n1</span> <span class="free">n2</span><span class="main">)</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> E <span class="main">(</span>EPrim <span class="free">f</span> <span class="free">e1</span> <span class="free">e2</span><span class="main">)</span> <span class="free">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="DenotLam5-e_prim_elim"><span class="command">lemma</span></span> e_prim_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v</span> <span class="main">∈</span> E <span class="main">(</span>EPrim <span class="free">f</span> <span class="free">e1</span> <span class="free">e2</span><span class="main">)</span> <span class="free">ρ</span><span class="main">;</span>
   <span class="main">⋀</span> <span class="bound">n1</span> <span class="bound">n2</span><span class="main">.</span> <span class="main">⟦</span> VNat <span class="bound">n1</span> <span class="main">∈</span> E <span class="free">e1</span> <span class="free">ρ</span><span class="main">;</span> VNat <span class="bound">n2</span> <span class="main">∈</span> E <span class="free">e2</span> <span class="free">ρ</span><span class="main">;</span> <span class="free">v</span> <span class="main">=</span> VNat <span class="main">(</span><span class="free">f</span> <span class="bound">n1</span> <span class="bound">n2</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
 
<span class="keyword1" id="DenotLam5-e_app_elim"><span class="command">lemma</span></span> e_app_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v3</span> <span class="main">∈</span> E <span class="main">(</span>EApp <span class="free">e1</span> <span class="free">e2</span><span class="main">)</span> <span class="free">ρ</span><span class="main">;</span>
  <span class="main">⋀</span> <span class="bound">f</span> <span class="bound">v2</span> <span class="bound">v2'</span> <span class="bound">v3'</span><span class="main">.</span> <span class="main">⟦</span> VFun <span class="bound">f</span> <span class="main">∈</span> E <span class="free">e1</span> <span class="free">ρ</span><span class="main">;</span> <span class="bound">v2</span> <span class="main">∈</span> E <span class="free">e2</span> <span class="free">ρ</span><span class="main">;</span> <span class="main">(</span><span class="bound">v2'</span><span class="main">,</span><span class="bound">v3'</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">f</span><span class="main">;</span> <span class="bound">v2'</span> <span class="main">⊑</span> <span class="bound">v2</span><span class="main">;</span> <span class="free">v3</span> <span class="main">⊑</span> <span class="bound">v3'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>
 <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="DenotLam5-e_app_intro"><span class="command">lemma</span></span> e_app_intro<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> VFun <span class="free">f</span> <span class="main">∈</span> E <span class="free">e1</span> <span class="free">ρ</span><span class="main">;</span> <span class="free">v2</span> <span class="main">∈</span> E <span class="free">e2</span> <span class="free">ρ</span><span class="main">;</span> <span class="main">(</span><span class="free">v2'</span><span class="main">,</span><span class="free">v3'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">f</span><span class="main">;</span> <span class="free">v2'</span> <span class="main">⊑</span> <span class="free">v2</span><span class="main">;</span> <span class="free">v3</span> <span class="main">⊑</span> <span class="free">v3'</span><span class="main">⟧</span>
     <span class="main">⟹</span> <span class="free">v3</span> <span class="main">∈</span> E <span class="main">(</span>EApp <span class="free">e1</span> <span class="free">e2</span><span class="main">)</span> <span class="free">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="DenotLam5-e_lam_intro"><span class="command">lemma</span></span> e_lam_intro<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v</span> <span class="main">=</span> VFun <span class="free">f</span><span class="main">;</span>
      <span class="main">∀</span> <span class="bound">v1</span> <span class="bound">v2</span><span class="main">.</span> <span class="main">(</span><span class="bound">v1</span><span class="main">,</span><span class="bound">v2</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">f</span> <span class="main">⟶</span> <span class="bound">v2</span> <span class="main">∈</span> E <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">v1</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> E <span class="main">(</span>ELam <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  

<span class="keyword1" id="DenotLam5-e_lam_intro2"><span class="command">lemma</span></span> e_lam_intro2<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> VFun <span class="free">f</span> <span class="main">∈</span> E <span class="main">(</span>ELam <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="free">ρ</span><span class="main">;</span> <span class="free">v2</span> <span class="main">∈</span> E <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">v1</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> VFun <span class="main">(</span><span class="main">(</span><span class="free">v1</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span><span class="main">#</span><span class="free">f</span><span class="main">)</span> <span class="main">∈</span> E <span class="main">(</span>ELam <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="free">ρ</span>"</span></span>    
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="DenotLam5-e_lam_intro3"><span class="command">lemma</span></span> e_lam_intro3<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="main">[]</span> <span class="main">∈</span> E <span class="main">(</span>ELam <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="DenotLam5-e_if_intro"><span class="command">lemma</span></span> e_if_intro<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> VNat <span class="free">n</span> <span class="main">∈</span> E <span class="free">e1</span> <span class="free">ρ</span><span class="main">;</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free">v</span> <span class="main">∈</span> E <span class="free">e3</span> <span class="free">ρ</span><span class="main">;</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free">v</span> <span class="main">∈</span> E <span class="free">e2</span> <span class="free">ρ</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> E <span class="main">(</span>EIf <span class="free">e1</span> <span class="free">e2</span> <span class="free">e3</span><span class="main">)</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="DenotLam5-e_var_intro"><span class="command">lemma</span></span> e_var_intro<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> lookup <span class="free">ρ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">v'</span><span class="main">;</span> <span class="free">v</span> <span class="main">⊑</span> <span class="free">v'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> E <span class="main">(</span>EVar <span class="free">x</span><span class="main">)</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="DenotLam5-e_var_elim"><span class="command">lemma</span></span> e_var_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v</span> <span class="main">∈</span> E <span class="main">(</span>EVar <span class="free">x</span><span class="main">)</span> <span class="free">ρ</span><span class="main">;</span>
   <span class="main">⋀</span> <span class="bound">v'</span><span class="main">.</span> <span class="main">⟦</span> lookup <span class="free">ρ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="bound">v'</span><span class="main">;</span> <span class="free">v</span> <span class="main">⊑</span> <span class="bound">v'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="DenotLam5-e_lam_elim"><span class="command">lemma</span></span> e_lam_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v</span> <span class="main">∈</span> E <span class="main">(</span>ELam <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="free">ρ</span><span class="main">;</span>
   <span class="main">⋀</span> <span class="bound">f</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">v</span> <span class="main">=</span> VFun <span class="bound">f</span><span class="main">;</span> <span class="main">∀</span> <span class="bound">v1</span> <span class="bound">v2</span><span class="main">.</span> <span class="main">(</span><span class="bound">v1</span><span class="main">,</span><span class="bound">v2</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">f</span> <span class="main">⟶</span> <span class="bound">v2</span> <span class="main">∈</span> E <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">v1</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="DenotLam5-e_lam_elim2"><span class="command">lemma</span></span> e_lam_elim2<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> VFun <span class="main">(</span><span class="main">(</span><span class="free">v1</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span><span class="main">#</span><span class="free">f</span><span class="main">)</span> <span class="main">∈</span> E <span class="main">(</span>ELam <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="free">ρ</span><span class="main">;</span>
   <span class="main">⟦</span> <span class="free">v2</span> <span class="main">∈</span> E <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">v1</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="DenotLam5-e_if_elim"><span class="command">lemma</span></span> e_if_elim<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v</span> <span class="main">∈</span> E <span class="main">(</span>EIf <span class="free">e1</span> <span class="free">e2</span> <span class="free">e3</span><span class="main">)</span> <span class="free">ρ</span><span class="main">;</span>
   <span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="main">⟦</span> VNat <span class="bound">n</span> <span class="main">∈</span> E <span class="free">e1</span> <span class="free">ρ</span><span class="main">;</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free">v</span> <span class="main">∈</span> E <span class="free">e3</span> <span class="free">ρ</span><span class="main">;</span> <span class="bound">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free">v</span> <span class="main">∈</span> E <span class="free">e2</span> <span class="free">ρ</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">xenv_le</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name set <span class="main">⇒</span> env <span class="main">⇒</span> env <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">⊑</span> _"</span> <span class="main">[</span>51<span class="main">,</span>51<span class="main">,</span>51<span class="main">]</span> 52<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main"><span class="free">⊑</span></span> <span class="free"><span class="bound"><span class="entity">ρ'</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">x</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∧</span> lookup <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v'</span><span class="main">.</span> lookup <span class="free"><span class="bound"><span class="entity">ρ'</span></span></span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">v'</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">⊑</span> <span class="bound">v'</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">declare</span></span> xenv_le_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
    
<span class="keyword1"><span class="command">proposition</span></span> change_env_le<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span><span class="main">::</span><span class="quoted">val</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ρ</span><span class="main">::</span><span class="quoted">env</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> de<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vp_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v'</span> <span class="main">⊑</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rr<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="free">e</span> <span class="main">⊢</span> <span class="free">ρ</span> <span class="main">⊑</span> <span class="free">ρ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v'</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> de rr vp_v
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">v'</span></span> <span class="quoted"><span class="free">ρ</span></span> <span class="quoted"><span class="free">ρ'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exp.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>EVar <span class="skolem">x</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="skolem">ρ</span> <span class="skolem">ρ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> EVar <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v2</span></span> <span class="keyword2"><span class="keyword">where</span></span> lx<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="skolem">ρ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">v2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v_v2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">⊑</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> lx EVar <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v3</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    lx2<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="skolem">ρ'</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">v3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v2_v3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">⊑</span> <span class="skolem">v3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> v_v2 v2_v3 <span class="keyword1"><span class="command">have</span></span> v_v3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">⊑</span> <span class="skolem">v3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> val_le_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> EVar v_v3 <span class="keyword1"><span class="command">have</span></span> vp_v3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">⊑</span> <span class="skolem">v3</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> val_le_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> lx2 vp_v3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> e_var_intro<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ENat <span class="skolem">n</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ELam <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ELam<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> VFun <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    body<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v1</span> <span class="bound">v2</span><span class="main">.</span> <span class="main">(</span><span class="bound">v1</span><span class="main">,</span><span class="bound">v2</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">f</span> <span class="main">⟶</span> <span class="bound">v2</span> <span class="main">∈</span> E <span class="skolem">e</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="bound">v1</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> v ELam<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> vp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> VFun <span class="skolem">f'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fp_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="main">≲</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">v'</span></span><span class="main">)</span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> vp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v1</span> <span class="skolem">v2</span> <span class="keyword3"><span class="command">assume</span></span> v12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v1</span><span class="main">,</span><span class="skolem">v2</span><span class="main">)</span><span class="main">∈</span> set <span class="skolem">f'</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> v12 fp_f <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v3</span></span> <span class="skolem"><span class="skolem">v4</span></span> <span class="keyword2"><span class="keyword">where</span></span> v34<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v3</span><span class="main">,</span><span class="skolem">v4</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
      v31<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v3</span> <span class="main">⊑</span> <span class="skolem">v1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v24<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">⊑</span> <span class="skolem">v4</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> v34 body <span class="keyword1"><span class="command">have</span></span> v4_E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v4</span> <span class="main">∈</span> E <span class="skolem">e</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">v3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> ELam<span class="main">(</span>3<span class="main">)</span> v31 <span class="keyword1"><span class="command">have</span></span> rr2<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="skolem">e</span> <span class="main">⊢</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">v3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">v1</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> ELam<span class="main">(</span>1<span class="main">)</span> v24 v4_E rr2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> E <span class="skolem">e</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">v1</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>EApp <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> EApp<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">v2</span></span><span class="main">::</span><span class="quoted">val</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">v2'</span></span> <span class="skolem"><span class="skolem">v3'</span></span> <span class="keyword2"><span class="keyword">where</span></span> f_e1<span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="skolem">f</span> <span class="main">∈</span> E <span class="skolem">e1</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    v2_e2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> E <span class="skolem">e2</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v23p_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v2'</span><span class="main">,</span><span class="skolem">v3'</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v2p_v2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2'</span> <span class="main">⊑</span> <span class="skolem">v2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    v_v3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">⊑</span> <span class="skolem">v3'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> EApp<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="skolem">e1</span> <span class="main">⊢</span> <span class="skolem">ρ</span> <span class="main">⊑</span> <span class="skolem">ρ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> f_f<span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="skolem">f</span> <span class="main">⊑</span> VFun <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> EApp<span class="main">(</span>1<span class="main">)</span> f_e1 1 f_f <span class="keyword1"><span class="command">have</span></span> f_e1b<span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="skolem">f</span> <span class="main">∈</span> E <span class="skolem">e1</span> <span class="skolem">ρ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> EApp<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="skolem">e2</span> <span class="main">⊢</span> <span class="skolem">ρ</span> <span class="main">⊑</span> <span class="skolem">ρ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> EApp<span class="main">(</span>2<span class="main">)</span> v2_e2 2 <span class="keyword1"><span class="command">have</span></span> v2_e2b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> E <span class="skolem">e2</span> <span class="skolem">ρ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> EApp<span class="main">(</span>5<span class="main">)</span> v_v3 <span class="keyword1"><span class="command">have</span></span> vp_v3p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">⊑</span> <span class="skolem">v3'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> val_le_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> f_e1b v2_e2b v23p_f v2p_v2 vp_v3p
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>EPrim <span class="skolem">f</span> <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> EPrim<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n1</span></span> <span class="skolem"><span class="skolem">n2</span></span> <span class="keyword2"><span class="keyword">where</span></span> n1_e1<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n1</span> <span class="main">∈</span> E <span class="skolem">e1</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n2_e2<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n2</span> <span class="main">∈</span> E <span class="skolem">e2</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> VNat <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n1</span> <span class="skolem">n2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> EPrim<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="skolem">e1</span> <span class="main">⊢</span> <span class="skolem">ρ</span> <span class="main">⊑</span> <span class="skolem">ρ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> EPrim<span class="main">(</span>1<span class="main">)</span> n1_e1 1 <span class="keyword1"><span class="command">have</span></span> n1_e1b<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n1</span> <span class="main">∈</span> E <span class="skolem">e1</span> <span class="skolem">ρ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> EPrim<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="skolem">e2</span> <span class="main">⊢</span> <span class="skolem">ρ</span> <span class="main">⊑</span> <span class="skolem">ρ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> EPrim<span class="main">(</span>2<span class="main">)</span> n2_e2 2 <span class="keyword1"><span class="command">have</span></span> n2_e2b<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n2</span> <span class="main">∈</span> E <span class="skolem">e2</span> <span class="skolem">ρ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> v EPrim<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> vp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> VNat <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n1</span> <span class="skolem">n2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> n1_e1b n2_e2b vp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>EIf <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e3</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> n<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="comment1">― ‹Subsumption is admissible›</span> 
<span class="keyword1"><span class="command">proposition</span></span> e_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ</span><span class="main">;</span> <span class="free">v'</span> <span class="main">⊑</span> <span class="free">v</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">v'</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"FV <span class="free">e</span> <span class="main">⊢</span> <span class="free">ρ</span> <span class="main">⊑</span> <span class="free">ρ</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> change_env_le <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="DenotLam5-env_le_ext"><span class="command">lemma</span></span> env_le_ext<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ρ</span><span class="main">::</span><span class="quoted">env</span> <span class="keyword2"><span class="keyword">assumes</span></span> rr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">⊑</span> <span class="free">ρ'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">ρ'</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">using</span></span> rr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_le_def<span class="main">)</span>
 
<span class="keyword1" id="DenotLam5-change_env"><span class="command">lemma</span></span> change_env<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ρ</span><span class="main">::</span><span class="quoted">env</span> <span class="keyword2"><span class="keyword">assumes</span></span> de<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rr<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="free">e</span> <span class="main">⊢</span> <span class="free">ρ</span> <span class="main">⊑</span> <span class="free">ρ'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> vv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⊑</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> de rr vv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> change_env_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DenotLam5-raise_env"><span class="command">lemma</span></span> raise_env<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ρ</span><span class="main">::</span><span class="quoted">env</span> <span class="keyword2"><span class="keyword">assumes</span></span> de<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">⊑</span> <span class="free">ρ'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> de rr change_env env_le_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="DenotLam5-env_eq_refl"><span class="command">lemma</span></span> env_eq_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ρ</span><span class="main">::</span><span class="quoted">env</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">≈</span> <span class="free">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_eq_def<span class="main">)</span> 

<span class="keyword1" id="DenotLam5-env_eq_ext"><span class="command">lemma</span></span> env_eq_ext<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ρ</span><span class="main">::</span><span class="quoted">env</span> <span class="keyword2"><span class="keyword">assumes</span></span> rr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">≈</span> <span class="free">ρ'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">ρ'</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">using</span></span> rr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_eq_def<span class="main">)</span> 

<span class="keyword1" id="DenotLam5-eq_implies_le"><span class="command">lemma</span></span> eq_implies_le<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ρ</span><span class="main">::</span><span class="quoted">env</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">≈</span> <span class="free">ρ'</span> <span class="main">⟹</span> <span class="free">ρ</span> <span class="main">⊑</span> <span class="free">ρ'</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_le_def env_eq_def<span class="main">)</span> 

<span class="keyword1" id="DenotLam5-env_swap"><span class="command">lemma</span></span> env_swap<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ρ</span><span class="main">::</span><span class="quoted">env</span> <span class="keyword2"><span class="keyword">assumes</span></span> rr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">≈</span> <span class="free">ρ'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ve<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rr ve <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">⊑</span> <span class="free">ρ'</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eq_implies_le<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> raise_env<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="DenotLam5-env_strengthen"><span class="command">lemma</span></span> env_strengthen<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ</span><span class="main">;</span> <span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> FV <span class="free">e</span> <span class="main">⟶</span> lookup <span class="free">ρ'</span> <span class="bound">x</span> <span class="main">=</span> lookup <span class="free">ρ</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> change_env <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>    

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="EquivDenotInterTypes">
<div class="head">
<h1>Theory EquivDenotInterTypes</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Equivalence of denotational and type system views"</span></span>

<span class="keyword1"><span class="command">theory</span></span> EquivDenotInterTypes
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="InterTypeSystem.html">InterTypeSystem</a> <a href="DeclSemAsDenot.html">DeclSemAsDenot</a> <a href="DenotLam5.html">DenotLam5</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">V</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ty <span class="main">⇒</span> val"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">Vf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"funty <span class="main">⇒</span> <span class="main">(</span>val <span class="main">×</span> val<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">(</span>TNat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> VNat <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">(</span>TFun <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> VFun <span class="main">(</span><span class="free">Vf</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">Vf</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">V</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free">V</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">Vf</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⊓</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">Vf</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">@</span> <span class="free">Vf</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">Vf</span> <span class="main">⊤</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Venv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tyenv <span class="main">⇒</span> env"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Venv</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">Venv</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span>V <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">#</span><span class="free">Venv</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">T</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> ty"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">Tf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>val <span class="main">×</span> val<span class="main">)</span> list <span class="main">⇒</span> funty"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">(</span>VNat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> TNat <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">(</span>VFun <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> TFun <span class="main">(</span><span class="free">Tf</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">Tf</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">⊤</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">Tf</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">T</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">→</span> <span class="free">T</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="main">⊓</span> <span class="free">Tf</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">T</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">size_change</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Tenv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"env <span class="main">⇒</span> tyenv"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Tenv</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">Tenv</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span>T <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">#</span><span class="free">Tenv</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span>"</span></span> 
    
<span class="keyword1" id="EquivDenotInterTypes-sub_inter_left1"><span class="command">lemma</span></span> sub_inter_left1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&lt;::</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">⊓</span> <span class="free">B</span> <span class="main">&lt;::</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊓</span> <span class="free">B</span> <span class="main">&lt;::</span> <span class="free">A</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_trans<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
<span class="keyword1" id="EquivDenotInterTypes-sub_inter_left2"><span class="command">lemma</span></span> sub_inter_left2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">&lt;::</span> <span class="free">C</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">⊓</span> <span class="free">B</span> <span class="main">&lt;::</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊓</span> <span class="free">B</span> <span class="main">&lt;::</span> <span class="free">B</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_trans<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="EquivDenotInterTypes-vf_nil"><span class="command">lemma</span></span> vf_nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Vf <span class="main">(</span>Tf <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
<span class="keyword1" id="EquivDenotInterTypes-vf_cons"><span class="command">lemma</span></span> vf_cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Vf <span class="main">(</span>Tf <span class="main">(</span><span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">v'</span><span class="main">)</span><span class="main">#</span><span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>V <span class="main">(</span>T <span class="free">v</span><span class="main">)</span><span class="main">,</span> V <span class="main">(</span>T <span class="free">v'</span><span class="main">)</span><span class="main">)</span><span class="main">#</span><span class="main">(</span>Vf <span class="main">(</span>Tf <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
<span class="keyword1"><span class="command">proposition</span></span> vt_id<span class="main">:</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"V <span class="main">(</span>T <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Vf <span class="main">(</span>Tf <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> T_Tf.induct<span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span> 

<span class="keyword1" id="EquivDenotInterTypes-lookup_tenv"><span class="command">lemma</span></span> lookup_tenv<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"lookup <span class="free">ρ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> lookup <span class="main">(</span>Tenv <span class="free">ρ</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> Some <span class="main">(</span>T <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ρ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">proposition</span></span> table_mem_sub<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">t</span> <span class="main">⟹</span> Tf <span class="free">t</span> <span class="main">&lt;::</span> <span class="main">(</span>T <span class="free">v</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span>T <span class="free">v'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">v'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">p</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">v1</span> <span class="skolem">v2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span> 
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Tf <span class="skolem">t</span> <span class="main">&lt;::</span> T <span class="skolem">v</span> <span class="main">→</span> T <span class="skolem">v'</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_inter_left2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EquivDenotInterTypes-Tf_top"><span class="command">lemma</span></span> Tf_top<span class="main">:</span> <span class="quoted"><span class="quoted">"Tf <span class="free">t</span> <span class="main">&lt;::</span> <span class="main">⊤</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">p</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> sub_inter_left2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1" id="EquivDenotInterTypes-le_sub_flip_aux"><span class="command">lemma</span></span> le_sub_flip_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="bound">v'</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> val_size <span class="bound">v</span> <span class="main">+</span> val_size <span class="bound">v'</span> <span class="main">+</span> fun_size <span class="bound">t</span> <span class="main">+</span> fun_size <span class="bound">t'</span> <span class="main">⟶</span>
   <span class="main">(</span><span class="bound">v</span> <span class="main">⊑</span> <span class="bound">v'</span> <span class="main">⟶</span> T <span class="bound">v'</span> <span class="main">&lt;:</span> T <span class="bound">v</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">t</span> <span class="main">≲</span> <span class="bound">t'</span> <span class="main">⟶</span> Tf <span class="bound">t'</span> <span class="main">&lt;::</span> Tf <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span><span class="main">::</span><span class="quoted">val</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">v'</span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> val_size <span class="skolem">v</span> <span class="main">+</span> val_size <span class="skolem">v'</span> <span class="main">+</span> fun_size <span class="skolem">t</span> <span class="main">+</span> fun_size <span class="skolem">t'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> v_vp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">⊑</span> <span class="skolem">v'</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"T <span class="skolem">v'</span> <span class="main">&lt;:</span> T <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>VNat <span class="skolem">n1</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> VNat v_vp <span class="keyword1"><span class="command">have</span></span> vp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> VNat <span class="skolem">n1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">from</span></span> VNat vp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">using</span></span> sub_refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>VFun <span class="skolem">t1</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> VFun v_vp <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t2</span></span> <span class="keyword2"><span class="keyword">where</span></span> vp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> VFun <span class="skolem">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t1_t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">≲</span> <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"val_size <span class="main">(</span>VNat <span class="main">0</span><span class="main">)</span> <span class="main">+</span> val_size <span class="main">(</span>VNat <span class="main">0</span><span class="main">)</span> <span class="main">+</span> fun_size <span class="skolem">t1</span> <span class="main">+</span> fun_size <span class="skolem">t2</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> 1 t1_t2 n VFun vp <span class="keyword1"><span class="command">have</span></span> t2_t1<span class="main">:</span> <span class="quoted"><span class="quoted">"Tf <span class="skolem">t2</span> <span class="main">&lt;::</span> Tf <span class="skolem">t1</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?m</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"VNat <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"VNat <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">t1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">t2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">from</span></span> t2_t1 VFun vp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">qed</span></span>      
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> val_size <span class="skolem">v</span> <span class="main">+</span> val_size <span class="skolem">v'</span> <span class="main">+</span> fun_size <span class="skolem">t</span> <span class="main">+</span> fun_size <span class="skolem">t'</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> t_tp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≲</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Tf <span class="skolem">t'</span> <span class="main">&lt;::</span> Tf <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">from</span></span> Nil <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Tf <span class="skolem">t</span> <span class="main">=</span> <span class="main">⊤</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Tf_top <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">t1</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">v1</span> <span class="skolem">v2</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> Cons Pair <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword1"><span class="command">from</span></span> Cons Pair <span class="keyword1"><span class="command">have</span></span> v12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v1</span><span class="main">,</span><span class="skolem">v2</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> t_tp v12 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v3</span></span> <span class="skolem"><span class="skolem">v4</span></span> <span class="keyword2"><span class="keyword">where</span></span> v34<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v3</span><span class="main">,</span><span class="skolem">v4</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            v13<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">⊑</span> <span class="skolem">v3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v31<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v3</span> <span class="main">⊑</span> <span class="skolem">v1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v24<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">⊑</span> <span class="skolem">v4</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v42<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v4</span> <span class="main">⊑</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">have</span></span> Tv3_Tv1<span class="main">:</span> <span class="quoted"><span class="quoted">"T <span class="skolem">v3</span> <span class="main">≈</span> T <span class="skolem">v1</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"val_size <span class="skolem">v1</span> <span class="main">+</span> val_size <span class="skolem">v3</span>"</span></span>
            <span class="keyword1"><span class="command">from</span></span> v12 <span class="keyword1"><span class="command">have</span></span> sv1<span class="main">:</span> <span class="quoted"><span class="quoted">"val_size <span class="skolem">v1</span> <span class="main">&lt;</span> fun_size <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> val_size_mem_l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
            <span class="keyword1"><span class="command">from</span></span> v34 <span class="keyword1"><span class="command">have</span></span> sv3<span class="main">:</span> <span class="quoted"><span class="quoted">"val_size <span class="skolem">v3</span> <span class="main">&lt;</span> fun_size <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> val_size_mem_l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
            <span class="keyword1"><span class="command">from</span></span> 1 v13 n sv1 sv3 <span class="keyword1"><span class="command">have</span></span> Tv31<span class="main">:</span> <span class="quoted"><span class="quoted">"T <span class="skolem">v3</span> <span class="main">&lt;:</span> T <span class="skolem">v1</span>"</span></span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?m</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">v1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">v3</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span><span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command">from</span></span> 1 v31 n sv1 sv3 <span class="keyword1"><span class="command">have</span></span> Tv13<span class="main">:</span> <span class="quoted"><span class="quoted">"T <span class="skolem">v1</span> <span class="main">&lt;:</span> T <span class="skolem">v3</span>"</span></span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?m</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">v3</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">v1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command">from</span></span> Tv13 Tv31 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ty_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">have</span></span> Tv4_Tv2<span class="main">:</span> <span class="quoted"><span class="quoted">"T <span class="skolem">v4</span> <span class="main">≈</span> T <span class="skolem">v2</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"val_size <span class="skolem">v2</span> <span class="main">+</span> val_size <span class="skolem">v4</span>"</span></span>
            <span class="keyword1"><span class="command">from</span></span> v12 <span class="keyword1"><span class="command">have</span></span> sv2<span class="main">:</span> <span class="quoted"><span class="quoted">"val_size <span class="skolem">v2</span> <span class="main">&lt;</span> fun_size <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> val_size_mem_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
            <span class="keyword1"><span class="command">from</span></span> v34 <span class="keyword1"><span class="command">have</span></span> sv4<span class="main">:</span> <span class="quoted"><span class="quoted">"val_size <span class="skolem">v4</span> <span class="main">&lt;</span> fun_size <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> val_size_mem_r <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
            <span class="keyword1"><span class="command">from</span></span> 1 v42 n sv2 sv4 <span class="keyword1"><span class="command">have</span></span> Tv2_v4<span class="main">:</span> <span class="quoted"><span class="quoted">"T <span class="skolem">v2</span> <span class="main">&lt;:</span> T <span class="skolem">v4</span>"</span></span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?m</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">v4</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">v2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command">from</span></span> 1 v24 n sv2 sv4 <span class="keyword1"><span class="command">have</span></span> Tv4_v2<span class="main">:</span> <span class="quoted"><span class="quoted">"T <span class="skolem">v4</span> <span class="main">&lt;:</span> T <span class="skolem">v2</span>"</span></span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?m</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> 
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">v2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">v4</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
            <span class="keyword1"><span class="command">from</span></span> Tv2_v4 Tv4_v2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ty_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">from</span></span> Tv3_Tv1 Tv4_Tv2 <span class="keyword1"><span class="command">have</span></span> T34_T12<span class="main">:</span> <span class="quoted"><span class="quoted">"T <span class="skolem">v3</span> <span class="main">→</span> T <span class="skolem">v4</span> <span class="main">&lt;::</span> T <span class="skolem">v1</span> <span class="main">→</span> T <span class="skolem">v2</span>"</span></span> 
            <span class="keyword1"><span class="command">unfolding</span></span> ty_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">from</span></span> v34 <span class="keyword1"><span class="command">have</span></span> tp_T34<span class="main">:</span> <span class="quoted"><span class="quoted">"Tf <span class="skolem">t'</span> <span class="main">&lt;::</span> T <span class="skolem">v3</span> <span class="main">→</span> T <span class="skolem">v4</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> table_mem_sub <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">from</span></span> tp_T34 T34_T12 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Tf <span class="skolem">t'</span> <span class="main">&lt;::</span> T <span class="skolem">v1</span> <span class="main">→</span> T <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sub_trans<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fun_size <span class="skolem">t'</span> <span class="main">+</span> fun_size <span class="skolem">t1</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> Cons Pair t_tp <span class="keyword1"><span class="command">have</span></span> t1_tp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span> <span class="main">≲</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
          <span class="keyword1"><span class="command">from</span></span> 1 n t1_tp Cons Pair
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Tf <span class="skolem">t'</span> <span class="main">&lt;::</span> Tf <span class="skolem">t1</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?m</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"VNat <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"VNat <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">t1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1"><span class="command">proposition</span></span> le_sub_flip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⊑</span> <span class="free">v'</span> <span class="main">⟹</span> T <span class="free">v'</span> <span class="main">&lt;:</span> T <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> le_sub_flip_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
   
<span class="keyword1" id="EquivDenotInterTypes-le_sub_fun_flip"><span class="command">lemma</span></span> le_sub_fun_flip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≲</span> <span class="free">t'</span> <span class="main">⟹</span> Tf <span class="free">t'</span> <span class="main">&lt;::</span> Tf <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> le_sub_flip_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="EquivDenotInterTypes-Tf_append"><span class="command">lemma</span></span> Tf_append<span class="main">:</span> <span class="quoted"><span class="quoted">"Tf <span class="main">(</span><span class="free">t1</span> <span class="main">@</span> <span class="free">t2</span><span class="main">)</span> <span class="main">&lt;::</span> Tf <span class="free">t1</span> <span class="main">⊓</span> Tf <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_inter_r<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> Tf_top <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fsub_refl<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">t1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_inter_r<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_inter_r<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_inter_left1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fsub_refl<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_inter_left2<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Tf <span class="skolem">t1</span> <span class="main">⊓</span> Tf <span class="free">t2</span> <span class="main">&lt;::</span> Tf <span class="skolem">t1</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_inter_left1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fsub_refl<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_trans<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_inter_left2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Tf <span class="skolem">t1</span> <span class="main">⊓</span> Tf <span class="free">t2</span> <span class="main">&lt;::</span> Tf <span class="free">t2</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_inter_left2<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fsub_refl<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_trans<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="EquivDenotInterTypes-append_Tf"><span class="command">lemma</span></span> append_Tf<span class="main">:</span> <span class="quoted"><span class="quoted">"Tf <span class="free">t1</span> <span class="main">⊓</span> Tf <span class="free">t2</span> <span class="main">&lt;::</span> Tf <span class="main">(</span><span class="free">t1</span> <span class="main">@</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_inter_left2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fsub_refl<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">p</span> <span class="skolem">t1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_inter_r<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_inter_left1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_inter_left1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fsub_refl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> v1 v2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>T <span class="improper">v1</span> <span class="main">→</span> T <span class="improper">v2</span><span class="main">)</span> <span class="main">⊓</span> Tf <span class="skolem">t1</span><span class="main">)</span> <span class="main">⊓</span> Tf <span class="free">t2</span> <span class="main">&lt;::</span> Tf <span class="skolem">t1</span> <span class="main">⊓</span> Tf <span class="free">t2</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_inter_r<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_inter_left1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_inter_left2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fsub_refl<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_inter_left2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fsub_refl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_trans<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1"><span class="command">proposition</span></span> tv_id<span class="main">:</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"T <span class="main">(</span>V <span class="free">A</span><span class="main">)</span> <span class="main">≈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Tf <span class="main">(</span>Vf <span class="free">F</span><span class="main">)</span> <span class="main">≃</span> <span class="free">F</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> V_Vf.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ty_eq_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_refl<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ty_eq_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_funty<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> le_sub_flip fty_eq_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_funty<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> le_sub_flip fty_eq_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fty_eq_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_inter_left1<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> ty_eq_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_inter_r<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> ty_eq_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> fty_eq_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_inter_r<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Tf <span class="main">(</span>Vf <span class="skolem">A</span> <span class="main">@</span> Vf <span class="skolem">B</span><span class="main">)</span> <span class="main">&lt;::</span> Tf <span class="main">(</span>Vf <span class="skolem">A</span><span class="main">)</span> <span class="main">⊓</span> Tf <span class="main">(</span>Vf <span class="skolem">B</span><span class="main">)</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command">using</span></span> Tf_append <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Tf <span class="main">(</span>Vf <span class="skolem">A</span><span class="main">)</span> <span class="main">⊓</span> Tf <span class="main">(</span>Vf <span class="skolem">B</span><span class="main">)</span> <span class="main">&lt;::</span> <span class="skolem">A</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_trans<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_inter_left1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Tf <span class="main">(</span>Vf <span class="skolem">A</span> <span class="main">@</span> Vf <span class="skolem">B</span><span class="main">)</span> <span class="main">&lt;::</span> Tf <span class="main">(</span>Vf <span class="skolem">A</span><span class="main">)</span> <span class="main">⊓</span> Tf <span class="main">(</span>Vf <span class="skolem">B</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command">using</span></span> Tf_append <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Tf <span class="main">(</span>Vf <span class="skolem">A</span><span class="main">)</span> <span class="main">⊓</span> Tf <span class="main">(</span>Vf <span class="skolem">B</span><span class="main">)</span> <span class="main">&lt;::</span> <span class="skolem">B</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_trans<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>  
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_inter_left2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Tf <span class="main">(</span>Vf <span class="skolem">A</span><span class="main">)</span> <span class="main">⊓</span> Tf <span class="main">(</span>Vf <span class="skolem">B</span><span class="main">)</span> <span class="main">&lt;::</span> Tf <span class="main">(</span>Vf <span class="skolem">A</span> <span class="main">@</span> Vf <span class="skolem">B</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> append_Tf<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊓</span> <span class="skolem">B</span> <span class="main">&lt;::</span> Tf <span class="main">(</span>Vf <span class="skolem">A</span><span class="main">)</span> <span class="main">⊓</span> Tf <span class="main">(</span>Vf <span class="skolem">B</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_trans<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_inter_r<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_inter_left1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_inter_left2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 5
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>  <span class="keyword1"><span class="command">using</span></span> fty_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="EquivDenotInterTypes-denot_lam_implies_ts"><span class="command">lemma</span></span> denot_lam_implies_ts<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> et<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span> <span class="bound">ρ</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="bound">ρ</span> <span class="main">⟶</span> Tenv <span class="bound">ρ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> T <span class="bound">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       fe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v1</span> <span class="bound">v2</span><span class="main">.</span> <span class="main">(</span><span class="bound">v1</span><span class="main">,</span> <span class="bound">v2</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">f</span> <span class="main">⟶</span> <span class="bound">v2</span> <span class="main">∈</span> E <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">v1</span><span class="main">)</span> <span class="main">#</span> <span class="free">ρ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Tenv <span class="free">ρ</span> <span class="main">⊢</span> ELam <span class="free">x</span> <span class="free">e</span> <span class="main">:</span> TFun <span class="main">(</span>Tf <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> et fe
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">v</span> <span class="skolem">v'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"Tenv <span class="free">ρ</span> <span class="main">⊢</span> ELam <span class="free">x</span> <span class="free">e</span> <span class="main">:</span> TFun <span class="main">(</span>Tf <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="bound">ρ</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="bound">ρ</span> <span class="main">⟶</span> Tenv <span class="bound">ρ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> T <span class="bound">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v1</span> <span class="bound">v2</span><span class="main">.</span>
          <span class="main">(</span><span class="bound">v1</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">∧</span> <span class="bound">v2</span> <span class="main">=</span> <span class="skolem">v'</span> <span class="main">⟶</span> <span class="skolem">v'</span> <span class="main">∈</span> E <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">#</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
          <span class="main">(</span><span class="main">(</span><span class="bound">v1</span><span class="main">,</span> <span class="bound">v2</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">f</span> <span class="main">⟶</span> <span class="bound">v2</span> <span class="main">∈</span> E <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">v1</span><span class="main">)</span> <span class="main">#</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> E <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> 2 4 <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"Tenv <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> T <span class="skolem">v'</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">from</span></span> 5 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> T <span class="skolem">v</span><span class="main">)</span> <span class="main">#</span> Tenv <span class="free">ρ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> T <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">from</span></span> Cons Pair this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wt_inter<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wt_lam<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> denot_implies_ts<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> ve<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Tenv <span class="free">ρ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> T <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ve
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">ρ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>EVar <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span>  
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span>Tenv <span class="skolem">ρ</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span>T <span class="improper">v'</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lookup_tenv<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wt_sub<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> le_sub_flip<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ENat <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ELam <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> denot_lam_implies_ts<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>EApp <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Tenv <span class="skolem">ρ</span> <span class="main">⊢</span> <span class="skolem">e1</span> <span class="main">:</span> T <span class="main">(</span>VFun <span class="improper">f</span><span class="main">)</span>"</span></span><span class="main">)</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Tf <span class="improper">f</span> <span class="main">&lt;::</span> T <span class="improper">v2'</span> <span class="main">→</span> T <span class="improper">v3'</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> table_mem_sub<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>  
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Tenv <span class="skolem">ρ</span> <span class="main">⊢</span> EApp <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="main">:</span> T <span class="improper">v3'</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wt_sub<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> le_sub_flip<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Tenv <span class="skolem">ρ</span> <span class="main">⊢</span> <span class="skolem">e1</span> <span class="main">:</span> TFun <span class="main">(</span>T <span class="improper">v2'</span> <span class="main">→</span> T <span class="improper">v3'</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wt_sub<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sub_funty<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wt_app<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>   
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Tenv <span class="skolem">ρ</span> <span class="main">⊢</span> <span class="skolem">e2</span> <span class="main">:</span> T <span class="improper">v2</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wt_sub<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> le_sub_flip<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>EPrim <span class="skolem">f</span> <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Tenv <span class="skolem">ρ</span> <span class="main">⊢</span> <span class="skolem">e1</span> <span class="main">:</span> T <span class="main">(</span>VNat <span class="improper">n1</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Tenv <span class="skolem">ρ</span> <span class="main">⊢</span> <span class="skolem">e2</span> <span class="main">:</span> T <span class="main">(</span>VNat <span class="improper">n2</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>EIf <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e3</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Tenv <span class="skolem">ρ</span> <span class="main">⊢</span> <span class="skolem">e1</span> <span class="main">:</span> T <span class="main">(</span>VNat <span class="improper">n</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">n</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Tenv <span class="skolem">ρ</span> <span class="main">⊢</span> <span class="skolem">e3</span> <span class="main">:</span> T <span class="skolem">v</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"Tenv <span class="skolem">ρ</span> <span class="main">⊢</span> <span class="skolem">e2</span> <span class="main">:</span> T <span class="skolem">v</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> wt_ifnz<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1" id="EquivDenotInterTypes-venv_lookup"><span class="command">lemma</span></span> venv_lookup<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> lx<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span>Venv <span class="free">Γ</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> Some <span class="main">(</span>V <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lx
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">Γ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x'</span><span class="main">,</span><span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">x'</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="EquivDenotInterTypes-append_fun_equiv"><span class="command">lemma</span></span> append_fun_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">t1'</span> <span class="main">∼</span> <span class="free">t1</span><span class="main">;</span> <span class="free">t2'</span> <span class="main">∼</span> <span class="free">t2</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t1'</span> <span class="main">@</span> <span class="free">t2'</span> <span class="main">∼</span> <span class="free">t1</span> <span class="main">@</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> val_eq_def fun_eq_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> append_fun_le <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
<span class="keyword1" id="EquivDenotInterTypes-append_eq_symm"><span class="command">lemma</span></span> append_eq_symm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t2</span> <span class="main">@</span> <span class="free">t1</span> <span class="main">∼</span> <span class="free">t1</span> <span class="main">@</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_def val_eq_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> append_leq_symm<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> append_leq_symm<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
<span class="keyword1" id="EquivDenotInterTypes-sub_le_flip"><span class="command">lemma</span></span> sub_le_flip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">&lt;:</span> <span class="free">B</span> <span class="main">⟶</span> V <span class="free">B</span> <span class="main">⊑</span> V <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">f1</span> <span class="main">&lt;::</span> <span class="free">f2</span> <span class="main">⟶</span> <span class="main">(</span>Vf <span class="free">f2</span><span class="main">)</span> <span class="main">≲</span> <span class="main">(</span>Vf <span class="free">f1</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subtype_fsubtype.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sub_trans <span class="skolem">T1</span> <span class="skolem">T2</span> <span class="skolem">T3</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fun_le_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
    
<span class="keyword1"><span class="command">theorem</span></span> ts_implies_denot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wte<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"V <span class="free">A</span> <span class="main">∈</span> E <span class="free">e</span> <span class="main">(</span>Venv <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wte
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wt.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wt_var <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span>Venv <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span>V <span class="skolem">T</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> venv_lookup<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"V <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wt_sub <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"V <span class="skolem">B</span> <span class="main">⊑</span> V <span class="skolem">A</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command">using</span></span> sub_le_flip <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> e_sub<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  
<span class="keyword2"><span class="keyword">end</span></span>
  
</pre>
</div><div id="DenotSoundFSet">
<div class="head">
<h1>Theory DenotSoundFSet</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Soundness of the declarative semantics wrt. operational"</span></span>

<span class="keyword1"><span class="command">theory</span></span> DenotSoundFSet
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="SmallStepLam.html">SmallStepLam</a> <a href="BigStepLam.html">BigStepLam</a> <a href="ChangeEnv.html">ChangeEnv</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Substitution preserves denotation"</span></span>
  
<span class="keyword1" id="DenotSoundFSet-subst_app"><span class="command">lemma</span></span> subst_app<span class="main">:</span> <span class="quoted"><span class="quoted">"subst <span class="free">x</span> <span class="free">v</span> <span class="main">(</span>EApp <span class="free">e1</span> <span class="free">e2</span><span class="main">)</span> <span class="main">=</span> EApp <span class="main">(</span>subst <span class="free">x</span> <span class="free">v</span> <span class="free">e1</span><span class="main">)</span> <span class="main">(</span>subst <span class="free">x</span> <span class="free">v</span> <span class="free">e2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    
<span class="keyword1" id="DenotSoundFSet-subst_prim"><span class="command">lemma</span></span> subst_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"subst <span class="free">x</span> <span class="free">v</span> <span class="main">(</span>EPrim <span class="free">f</span> <span class="free">e1</span> <span class="free">e2</span><span class="main">)</span> <span class="main">=</span> EPrim <span class="free">f</span> <span class="main">(</span>subst <span class="free">x</span> <span class="free">v</span> <span class="free">e1</span><span class="main">)</span> <span class="main">(</span>subst <span class="free">x</span> <span class="free">v</span> <span class="free">e2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="DenotSoundFSet-subst_lam_eq"><span class="command">lemma</span></span> subst_lam_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"subst <span class="free">x</span> <span class="free">v</span> <span class="main">(</span>ELam <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> ELam <span class="free">x</span> <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="DenotSoundFSet-subst_lam_neq"><span class="command">lemma</span></span> subst_lam_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">⟹</span> subst <span class="free">x</span> <span class="free">v</span> <span class="main">(</span>ELam <span class="free">y</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> ELam <span class="free">y</span> <span class="main">(</span>subst <span class="free">x</span> <span class="free">v</span> <span class="free">e</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 

<span class="keyword1" id="DenotSoundFSet-subst_if"><span class="command">lemma</span></span> subst_if<span class="main">:</span> <span class="quoted"><span class="quoted">"subst <span class="free">x</span> <span class="free">v</span> <span class="main">(</span>EIf <span class="free">e1</span> <span class="free">e2</span> <span class="free">e3</span><span class="main">)</span> <span class="main">=</span> EIf <span class="main">(</span>subst <span class="free">x</span> <span class="free">v</span> <span class="free">e1</span><span class="main">)</span> <span class="main">(</span>subst <span class="free">x</span> <span class="free">v</span> <span class="free">e2</span><span class="main">)</span> <span class="main">(</span>subst <span class="free">x</span> <span class="free">v</span> <span class="free">e3</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1" id="DenotSoundFSet-substitution"><span class="command">lemma</span></span> substitution<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Γ</span><span class="main">::</span><span class="quoted">env</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted">val</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> wte<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">Γ'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wtv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> E <span class="free">v</span> <span class="main">[]</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> gp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ'</span> <span class="main">≈</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">A</span><span class="main">)</span><span class="main">#</span><span class="free">Γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"is_val <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> E <span class="main">(</span>subst <span class="free">x</span> <span class="free">v</span> <span class="free">e</span><span class="main">)</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wte wtv gp v
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> E.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span> <span class="skolem">ρ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">ρ</span> <span class="skolem">v</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Γ</span> <span class="skolem">x'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> env_eq_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x'</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> env_strengthen<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> e_sub<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ</span> <span class="skolem">v</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Γ</span> <span class="skolem">x'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> subst_lam_eq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> env_strengthen<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_eq_def<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> subst_lam_neq<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> e_lam_elim<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> e_lam_intro<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">v1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">v2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="improper">v1</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span> <span class="main">≈</span> <span class="main">(</span><span class="skolem">x'</span><span class="main">,</span><span class="skolem">A</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="improper">v1</span><span class="main">)</span><span class="main">#</span><span class="skolem">Γ</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_eq_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">ρ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> subst_app<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> e_app_elim<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> e_app_intro<span class="main">)</span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">f</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">ρ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> subst_prim<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> e_prim_elim<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">n1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">n2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e3</span> <span class="skolem">ρ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> subst_if<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> e_if_elim<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> n<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Reduction preserves denotation"</span></span>
  
<span class="keyword1" id="DenotSoundFSet-subject_reduction"><span class="command">lemma</span></span> subject_reduction<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span><span class="main">::</span><span class="quoted">exp</span> <span class="keyword2"><span class="keyword">assumes</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⟶</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> E <span class="free">e'</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r v 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">ρ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reduce.induct<span class="main">)</span>
   <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">v</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">v'</span> <span class="skolem">ρ</span><span class="main">)</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> is_val_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> e_app_elim<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> e_lam_elim<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> f v2 v2' v3' f'<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">v2'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">v3'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">v3'</span> <span class="main">∈</span> E <span class="main">(</span>subst <span class="skolem">x</span> <span class="skolem">v</span> <span class="skolem">e</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> substitution<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">v3'</span> <span class="main">∈</span> E <span class="skolem">e</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="improper">v2</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> raise_env<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_le_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> env_strengthen<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="improper">v2</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span> <span class="main">≈</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="improper">v2</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_eq_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> e_sub<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> val_le_trans<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>  
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">theorem</span></span> preservation<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⟶*</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> E <span class="free">e'</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rr v subject_reduction <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ρ</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="operator">auto</span> 

<span class="keyword1" id="DenotSoundFSet-canonical_nat"><span class="command">lemma</span></span> canonical_nat<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="free">n</span> <span class="main">∈</span> E <span class="free">v</span> <span class="free">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vv<span class="main">:</span> <span class="quoted"><span class="quoted">"isval <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> ENat <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> v vv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="DenotSoundFSet-canonical_fun"><span class="command">lemma</span></span> canonical_fun<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="free">f</span> <span class="main">∈</span> E <span class="free">v</span> <span class="free">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vv<span class="main">:</span> <span class="quoted"><span class="quoted">"isval <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x</span> <span class="bound">e</span><span class="main">.</span> <span class="free">v</span> <span class="main">=</span> ELam <span class="bound">x</span> <span class="bound">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> v vv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Progress"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> progress<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fve<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="free">e</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_val <span class="free">e</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">e'</span><span class="main">.</span> <span class="free">e</span> <span class="main">⟶</span> <span class="bound">e'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> v r fve
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> E.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">ρ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> e_app_elim<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> 4<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_val <span class="skolem">e1</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_val <span class="skolem">e2</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> canonical_fun<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x e<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"subst <span class="improper">x</span> <span class="skolem">e2</span> <span class="improper">e</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> beta<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">f</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">ρ</span><span class="main">)</span>
   <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> e_prim_elim<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> 5<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
     <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"isval <span class="skolem">e1</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"isval <span class="skolem">e2</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> <span class="main">=</span> ENat <span class="improper">n1</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command">using</span></span> canonical_nat <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">e2</span> <span class="main">=</span> ENat <span class="improper">n2</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command">using</span></span> canonical_nat <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e3</span> <span class="skolem">ρ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> e_if_elim<span class="main">)</span> 
    <span class="keyword1"><span class="command">using</span></span> 6<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"isval <span class="skolem">e1</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> n<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> <span class="main">=</span> ENat <span class="improper">n</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> canonical_nat<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> 6 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">e1'</span><span class="main">.</span> <span class="skolem">e1</span> <span class="main">⟶</span> <span class="bound">e1'</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> e1'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"EIf <span class="improper">e1'</span> <span class="skolem">e2</span> <span class="skolem">e3</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> if_cond<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

    
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Logical relation between values and big-step values"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">good_entry</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name <span class="main">⇒</span> exp <span class="main">⇒</span> benv <span class="main">⇒</span> <span class="main">(</span>val <span class="main">×</span> bval set<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>val <span class="main">×</span> bval set<span class="main">)</span> <span class="main">⇒</span> bool <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">good_entry</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">g1</span></span></span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">g1</span></span></span><span class="main">.</span> <span class="main">∃</span> <span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">⊢</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">⇓</span> <span class="bound">v'</span> <span class="main">∧</span> <span class="bound">v'</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
 
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">good</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> bval set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  Gnat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">good</span> <span class="main">(</span>VNat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span> BNat <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">}</span>"</span></span> <span class="main">|</span>
  Gfun<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">good</span> <span class="main">(</span>VFun <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span> <span class="bound">vc</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">x</span> <span class="bound">e</span> <span class="bound">ρ</span><span class="main">.</span> <span class="bound">vc</span> <span class="main">=</span> BClos <span class="bound">x</span> <span class="bound">e</span> <span class="bound">ρ</span> 
          <span class="main">∧</span> <span class="main">(</span>ffold <span class="main">(</span>good_entry <span class="bound">x</span> <span class="bound">e</span> <span class="bound">ρ</span><span class="main">)</span> True <span class="main">(</span>fimage <span class="main">(</span>map_prod <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="free">good</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="free">good</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">good_env</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"benv <span class="main">⇒</span> env <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  genv_nil<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">good_env</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  genv_cons<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∈</span> good <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">;</span> <span class="free">good_env</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ'</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">good_env</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ρ'</span></span></span><span class="main">)</span>"</span></span> 
  
<span class="keyword1"><span class="command">inductive_cases</span></span> 
  genv_any_nil_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"good_env <span class="free">ρ</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  genv_any_cons_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"good_env <span class="free">ρ</span> <span class="main">(</span><span class="free">b</span><span class="main">#</span><span class="free">ρ'</span><span class="main">)</span>"</span></span> 

<span class="keyword1" id="DenotSoundFSet-lookup_good"><span class="command">lemma</span></span> lookup_good<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="free">ρ'</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> EE<span class="main">:</span> <span class="quoted"><span class="quoted">"good_env <span class="free">ρ</span> <span class="free">ρ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> lookup <span class="free">ρ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> good <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> l EE
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ρ'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">ρ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> genv_any_nil_inv<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> Nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">ρ'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> genv_any_cons_inv<span class="main">)</span> 
     <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x'<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="improper">x'</span>"</span></span><span class="main">)</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">good_prod</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">×</span> val <span class="main">⇒</span> <span class="main">(</span>val <span class="main">×</span> bval set<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>val <span class="main">×</span> bval set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">good_prod</span> <span class="main">≡</span> map_prod <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span>good <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span>good <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    
<span class="keyword1" id="DenotSoundFSet-good_prod_inj"><span class="command">lemma</span></span> good_prod_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on good_prod <span class="main">(</span>fset <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">good_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"func <span class="main">⇒</span> name <span class="main">⇒</span> exp <span class="main">⇒</span> benv <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">good_fun</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">≡</span> <span class="main">(</span>ffold <span class="main">(</span>good_entry <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span> True <span class="main">(</span>fimage good_prod <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="DenotSoundFSet-good_fun_def2"><span class="command">lemma</span></span> good_fun_def2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"good_fun <span class="free">f</span> <span class="free">x</span> <span class="free">e</span> <span class="free">ρ</span> <span class="main">=</span> ffold <span class="main">(</span>good_entry <span class="free">x</span> <span class="free">e</span> <span class="free">ρ</span> <span class="main">∘</span> good_prod<span class="main">)</span> True <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> ge<span class="main">:</span> comp_fun_commute <span class="quoted"><span class="quoted">"<span class="main">(</span>good_entry <span class="free">x</span> <span class="free">e</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">∘</span> good_prod"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> comp_fun_commute_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"good_fun <span class="free">f</span> <span class="free">x</span> <span class="free">e</span> <span class="free">ρ</span>
         <span class="main">=</span> ffold <span class="main">(</span><span class="main">(</span>good_entry <span class="free">x</span> <span class="free">e</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">∘</span> good_prod<span class="main">)</span> True <span class="free">f</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> good_prod_inj<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span>"</span></span><span class="main">]</span> good_fun_def
        ffold_fimage<span class="main">[</span><span class="operator">of</span> <span class="quoted">good_prod</span> <span class="quoted"><span class="quoted">"<span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"good_entry <span class="free">x</span> <span class="free">e</span> <span class="free">ρ</span>"</span></span> <span class="quoted">True</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DenotSoundFSet-gfun_elim"><span class="command">lemma</span></span> gfun_elim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> good <span class="main">(</span>VFun <span class="free">f</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">x</span> <span class="bound">e</span> <span class="bound">ρ</span><span class="main">.</span> <span class="free">w</span> <span class="main">=</span> BClos <span class="bound">x</span> <span class="bound">e</span> <span class="bound">ρ</span> <span class="main">∧</span> good_fun <span class="free">f</span> <span class="bound">x</span> <span class="bound">e</span> <span class="bound">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> good_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1" id="DenotSoundFSet-gfun_mem_iff"><span class="command">lemma</span></span> gfun_mem_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"good_fun <span class="free">f</span> <span class="free">x</span> <span class="free">e</span> <span class="free">ρ</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v1</span> <span class="bound">v2</span><span class="main">.</span> <span class="main">(</span><span class="bound">v1</span><span class="main">,</span><span class="bound">v2</span><span class="main">)</span> <span class="main">∈</span> fset <span class="free">f</span> <span class="main">⟶</span> 
    <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span> <span class="main">∈</span> good <span class="bound">v1</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">⇓</span> <span class="bound">v'</span> <span class="main">∧</span> <span class="bound">v'</span> <span class="main">∈</span> good <span class="bound">v2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">ρ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">interpret</span></span> ge<span class="main">:</span> comp_fun_commute <span class="quoted"><span class="quoted">"<span class="main">(</span>good_entry <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> comp_fun_commute_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> empty <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> good_fun_def2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">p</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> ge<span class="main">:</span> comp_fun_commute <span class="quoted"><span class="quoted">"<span class="main">(</span>good_entry <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="main">∘</span> good_prod"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> comp_fun_commute_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"good_fun <span class="main">(</span>finsert <span class="skolem">p</span> <span class="skolem">f</span><span class="main">)</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ</span>
         <span class="main">=</span> ffold <span class="main">(</span><span class="main">(</span>good_entry <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="main">∘</span> good_prod<span class="main">)</span> True <span class="main">(</span>finsert <span class="skolem">p</span> <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> good_fun_def2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> insert<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>good_entry <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="main">∘</span> good_prod<span class="main">)</span> <span class="skolem">p</span> 
                  <span class="main">(</span>ffold <span class="main">(</span><span class="main">(</span>good_entry <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="main">∘</span> good_prod<span class="main">)</span> True <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"good_fun <span class="main">(</span>finsert <span class="skolem">p</span> <span class="skolem">f</span><span class="main">)</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ</span>
      <span class="main">=</span> <span class="main">(</span><span class="main">(</span>good_entry <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="main">∘</span> good_prod<span class="main">)</span> <span class="skolem">p</span> <span class="main">(</span>ffold <span class="main">(</span><span class="main">(</span>good_entry <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="main">∘</span> good_prod<span class="main">)</span> True <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"good_fun <span class="main">(</span>finsert <span class="skolem">p</span> <span class="skolem">f</span><span class="main">)</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v1</span> <span class="bound">v2</span><span class="main">.</span> <span class="main">(</span><span class="bound">v1</span><span class="main">,</span> <span class="bound">v2</span><span class="main">)</span> <span class="main">∈</span> fset <span class="main">(</span>finsert <span class="skolem">p</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">∈</span>good <span class="bound">v1</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">⇓</span> <span class="bound">v'</span> <span class="main">∧</span> <span class="bound">v'</span> <span class="main">∈</span> good <span class="bound">v2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v1</span> <span class="skolem">v2</span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v1</span><span class="main">,</span> <span class="skolem">v2</span><span class="main">)</span> <span class="main">∈</span> fset <span class="main">(</span>finsert <span class="skolem">p</span> <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> good <span class="skolem">v1</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v1</span><span class="main">,</span><span class="skolem">v2</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">v1</span><span class="main">,</span><span class="skolem">v2</span><span class="main">)</span> <span class="main">∈</span> fset <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">⇓</span> <span class="bound">v'</span> <span class="main">∧</span> <span class="bound">v'</span> <span class="main">∈</span> good <span class="skolem">v2</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> 
        <span class="keyword3"><span class="command">assume</span></span> v12_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v1</span><span class="main">,</span><span class="skolem">v2</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> 1 v12_p<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span> 2 4 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> v12_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v1</span><span class="main">,</span><span class="skolem">v2</span><span class="main">)</span> <span class="main">∈</span> fset <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"good_fun <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>good_prod <span class="skolem">p</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_fun_def2<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> v12_f 5 4 insert<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">e</span></span> <span class="quoted"><span class="skolem">ρ</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v1</span> <span class="bound">v2</span><span class="main">.</span> <span class="main">(</span><span class="bound">v1</span><span class="main">,</span> <span class="bound">v2</span><span class="main">)</span> <span class="main">∈</span> fset <span class="main">(</span>finsert <span class="skolem">p</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">∈</span>good <span class="bound">v1</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">⇓</span> <span class="bound">v'</span> <span class="main">∧</span> <span class="bound">v'</span> <span class="main">∈</span> good <span class="bound">v2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"good_entry <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ</span> <span class="main">(</span>good_prod <span class="skolem">p</span><span class="main">)</span> True"</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v1</span> <span class="skolem">v2</span> <span class="skolem">v</span>
      <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v1</span><span class="main">,</span><span class="skolem">v2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v_v1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> good <span class="skolem">v1</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v1</span><span class="main">,</span><span class="skolem">v2</span><span class="main">)</span> <span class="main">∈</span> fset <span class="main">(</span>finsert <span class="skolem">p</span> <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> this 2 v_v1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">⇓</span> <span class="bound">v'</span> <span class="main">∧</span> <span class="bound">v'</span> <span class="main">∈</span> good <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>        
    <span class="keyword1"><span class="command">from</span></span> insert<span class="main">(</span>2<span class="main">)</span> 2 <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"good_fun <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>good_entry <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ</span> <span class="main">∘</span> good_prod<span class="main">)</span> <span class="skolem">p</span>
     <span class="main">(</span>ffold <span class="main">(</span>good_entry <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ</span> <span class="main">∘</span> good_prod<span class="main">)</span> True <span class="skolem">f</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"good_prod <span class="skolem">p</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> a b c<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">a</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command">using</span></span> 4 good_fun_def2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">from</span></span> this 1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"good_fun <span class="main">(</span>finsert <span class="skolem">p</span> <span class="skolem">f</span><span class="main">)</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ</span>"</span></span>
       <span class="keyword1"><span class="command">unfolding</span></span> good_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="DenotSoundFSet-gfun_mem"><span class="command">lemma</span></span> gfun_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free">v1</span><span class="main">,</span><span class="free">v2</span><span class="main">)</span> <span class="main">∈</span> fset <span class="free">f</span><span class="main">;</span> good_fun <span class="free">f</span> <span class="free">x</span> <span class="free">e</span> <span class="free">ρ</span> <span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="main">∀</span> <span class="bound">v</span> <span class="main">∈</span> good <span class="free">v1</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">⇓</span> <span class="bound">v'</span> <span class="main">∧</span> <span class="bound">v'</span> <span class="main">∈</span> good <span class="free">v2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gfun_mem_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  
<span class="keyword1" id="DenotSoundFSet-gfun_intro"><span class="command">lemma</span></span> gfun_intro<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span> <span class="bound">v1</span> <span class="bound">v2</span><span class="main">.</span><span class="main">(</span><span class="bound">v1</span><span class="main">,</span><span class="bound">v2</span><span class="main">)</span><span class="main">∈</span>fset <span class="free">f</span><span class="main">⟶</span><span class="main">(</span><span class="main">∀</span><span class="bound">v</span><span class="main">∈</span>good <span class="bound">v1</span><span class="main">.</span><span class="main">∃</span> <span class="bound">v'</span><span class="main">.</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">⇓</span> <span class="bound">v'</span><span class="main">∧</span><span class="bound">v'</span><span class="main">∈</span>good <span class="bound">v2</span><span class="main">)</span><span class="main">)</span>
  <span class="main">⟹</span> good_fun <span class="free">f</span> <span class="free">x</span> <span class="free">e</span> <span class="free">ρ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> gfun_mem_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">ρ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
<span class="keyword1" id="DenotSoundFSet-sub_good"><span class="command">lemma</span></span> sub_good<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span><span class="main">::</span><span class="quoted">val</span> <span class="keyword2"><span class="keyword">assumes</span></span> wv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> good <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vp_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v'</span> <span class="main">⊑</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> good <span class="free">v'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>VNat <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this wv vp_v <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>VFun <span class="skolem">t1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> vp_v VFun <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t2</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v'</span> <span class="main">=</span> VFun <span class="skolem">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t2_t1<span class="main">:</span> <span class="quoted"><span class="quoted">"fset <span class="skolem">t2</span> <span class="main">⊆</span> fset <span class="skolem">t1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> wv VFun <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="skolem"><span class="skolem">ρ</span></span> <span class="keyword2"><span class="keyword">where</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> BClos <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> w wv VFun <span class="keyword1"><span class="command">have</span></span> gt1<span class="main">:</span> <span class="quoted"><span class="quoted">"good_fun <span class="skolem">t1</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> good_fun_def<span class="main">)</span>          
  <span class="keyword1"><span class="command">have</span></span> gt2<span class="main">:</span> <span class="quoted"><span class="quoted">"good_fun <span class="skolem">t2</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> gfun_intro<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v1</span> <span class="skolem">v2</span> <span class="skolem">w1</span>
    <span class="keyword3"><span class="command">assume</span></span> v12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v1</span><span class="main">,</span><span class="skolem">v2</span><span class="main">)</span> <span class="main">∈</span> fset <span class="skolem">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> w1_v1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span> <span class="main">∈</span> good <span class="skolem">v1</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> v12 t2_t1 <span class="keyword1"><span class="command">have</span></span> v12_t1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v1</span><span class="main">,</span><span class="skolem">v2</span><span class="main">)</span> <span class="main">∈</span> fset <span class="skolem">t1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> gt1 v12_t1 w1_v1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">w1</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">⇓</span> <span class="bound">v'</span> <span class="main">∧</span> <span class="bound">v'</span> <span class="main">∈</span> good <span class="skolem">v2</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gfun_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> gt2 b w <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> good_fun_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Denotational semantics sound wrt. big-step"</span></span>
    
<span class="keyword1" id="DenotSoundFSet-denot_terminates"><span class="command">lemma</span></span> denot_terminates<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> vp_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v'</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"good_env <span class="free">ρ</span> <span class="free">ρ'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="free">ρ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">⇓</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> good <span class="free">v'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> vp_e ge 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v'</span></span> <span class="quoted"><span class="free">ρ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> E.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="comment1">― ‹ENat›</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span> <span class="comment1">― ‹EVar›</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">ρ</span> <span class="skolem">v'</span> <span class="skolem">ρ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v1</span></span> <span class="keyword2"><span class="keyword">where</span></span> lx_vpp<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="skolem">ρ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">v1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vp_v1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">⊑</span> <span class="skolem">v1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> lx_vpp 2<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v2</span></span> <span class="keyword2"><span class="keyword">where</span></span> lx<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="skolem">ρ'</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">v2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v2_v1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> good <span class="skolem">v1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lookup_good<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ρ</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">v1</span></span> <span class="quoted"><span class="skolem">ρ'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> lx <span class="keyword1"><span class="command">have</span></span> x_v2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ'</span> <span class="main">⊢</span> EVar <span class="skolem">x</span> <span class="main">⇓</span> <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> v2_v1 vp_v1 <span class="keyword1"><span class="command">have</span></span> v2_vp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> good <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sub_good <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> x_v2 v2_vp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span> <span class="comment1">― ‹ELam›</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ</span> <span class="skolem">v'</span> <span class="skolem">ρ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ'</span> <span class="main">⊢</span> ELam <span class="skolem">x</span> <span class="skolem">e</span> <span class="main">⇓</span> BClos <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"BClos <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ'</span> <span class="main">∈</span> good <span class="skolem">v'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> vp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> VFun <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
      body<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v1</span> <span class="bound">v2</span><span class="main">.</span> <span class="main">(</span><span class="bound">v1</span><span class="main">,</span> <span class="bound">v2</span><span class="main">)</span> <span class="main">∈</span> fset <span class="skolem">t</span> <span class="main">⟶</span> <span class="bound">v2</span> <span class="main">∈</span> E <span class="skolem">e</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="bound">v1</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> gt<span class="main">:</span> <span class="quoted"><span class="quoted">"good_fun <span class="skolem">t</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ'</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> gfun_intro<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v1</span> <span class="skolem">v2</span> <span class="skolem">w1</span> <span class="keyword3"><span class="command">assume</span></span> v12_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v1</span><span class="main">,</span><span class="skolem">v2</span><span class="main">)</span> <span class="main">∈</span> fset <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> w1_v1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span> <span class="main">∈</span> good <span class="skolem">v1</span>"</span></span> 
      <span class="keyword1"><span class="command">from</span></span> v12_t body <span class="keyword1"><span class="command">have</span></span> v2_Ee<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> E <span class="skolem">e</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">v1</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>3<span class="main">)</span> w1_v1 <span class="keyword1"><span class="command">have</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"good_env <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">w1</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ'</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">v1</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> v12_t v2_Ee ge 3<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v1</span></span> <span class="quoted"><span class="skolem">v2</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">v2</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">w1</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ'</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">⇓</span> <span class="bound">v'</span> <span class="main">∧</span> <span class="bound">v'</span> <span class="main">∈</span> good <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> vp gt <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> good_fun_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>         
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span> <span class="comment1">― ‹EApp›</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">ρ</span> <span class="skolem">v'</span> <span class="skolem">ρ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 4<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">v2</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">v2'</span><span class="main">::</span><span class="quoted">val</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">v3'</span> <span class="keyword3"><span class="command">assume</span></span> t_Ee1<span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="skolem">t</span> <span class="main">∈</span> E <span class="skolem">e1</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v2_Ee2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> E <span class="skolem">e2</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      v23_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v2'</span><span class="main">,</span><span class="skolem">v3'</span><span class="main">)</span> <span class="main">∈</span> fset <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v2p_v2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2'</span> <span class="main">⊑</span> <span class="skolem">v2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vp_v3p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">⊑</span> <span class="skolem">v3'</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 4<span class="main">(</span>1<span class="main">)</span> t_Ee1 4<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w1</span></span> <span class="keyword2"><span class="keyword">where</span></span> e1_w1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ'</span> <span class="main">⊢</span> <span class="skolem">e1</span> <span class="main">⇓</span> <span class="skolem">w1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      w1_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span> <span class="main">∈</span> good <span class="main">(</span>VFun <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> 4<span class="main">(</span>2<span class="main">)</span> v2_Ee2 4<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w2</span></span> <span class="keyword2"><span class="keyword">where</span></span> e2_w2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ'</span> <span class="main">⊢</span> <span class="skolem">e2</span> <span class="main">⇓</span> <span class="skolem">w2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> w2_v2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w2</span> <span class="main">∈</span> good <span class="skolem">v2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> w1_t <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="skolem"><span class="skolem">ρ1</span></span> <span class="keyword2"><span class="keyword">where</span></span> w1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span> <span class="main">=</span> BClos <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> gt<span class="main">:</span> <span class="quoted"><span class="quoted">"good_fun <span class="skolem">t</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">ρ1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_fun_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> w2_v2 v2p_v2 <span class="keyword1"><span class="command">have</span></span> w2_v2p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w2</span> <span class="main">∈</span> good <span class="skolem">v2'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sub_good<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> v23_t gt w2_v2p <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w3</span></span> <span class="keyword2"><span class="keyword">where</span></span> e_w3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">w2</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ1</span> <span class="main">⊢</span> <span class="skolem">e</span> <span class="main">⇓</span> <span class="skolem">w3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> w3_v3p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w3</span> <span class="main">∈</span> good <span class="skolem">v3'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gfun_mem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v2'</span></span> <span class="quoted"><span class="skolem">v3'</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">e</span></span> <span class="quoted"><span class="skolem">ρ1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> w3_v3p vp_v3p <span class="keyword1"><span class="command">have</span></span> w3_vp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w3</span> <span class="main">∈</span> good <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sub_good<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> e1_w1 e2_w2 w1 e_w3 w3_vp <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">ρ'</span> <span class="main">⊢</span> EApp <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="main">⇓</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> good <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span> <span class="comment1">― ‹EPrim›</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">f</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">ρ</span> <span class="skolem">v'</span> <span class="skolem">ρ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 5<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n1</span> <span class="skolem">n2</span> <span class="keyword3"><span class="command">assume</span></span> n1_e1<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n1</span> <span class="main">∈</span> E <span class="skolem">e1</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n2_e2<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n2</span> <span class="main">∈</span> E <span class="skolem">e2</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      vp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> VNat <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n1</span> <span class="skolem">n2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 5<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n1</span>"</span></span> <span class="quoted"><span class="skolem">ρ'</span></span><span class="main">]</span> n1_e1 5<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> e1_w1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ'</span> <span class="main">⊢</span> <span class="skolem">e1</span> <span class="main">⇓</span> BNat <span class="skolem">n1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> 5<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n2</span>"</span></span> <span class="quoted"><span class="skolem">ρ'</span></span><span class="main">]</span> n2_e2 5<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> e2_w2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ'</span> <span class="main">⊢</span> <span class="skolem">e2</span> <span class="main">⇓</span> BNat <span class="skolem">n2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> e1_w1 e2_w2 <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ'</span> <span class="main">⊢</span> EPrim <span class="skolem">f</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="main">⇓</span> BNat <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n1</span> <span class="skolem">n2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> vp <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"BNat <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n1</span> <span class="skolem">n2</span><span class="main">)</span> <span class="main">∈</span> good <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">ρ'</span> <span class="main">⊢</span> EPrim <span class="skolem">f</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="main">⇓</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> good <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span> <span class="comment1">― ‹EIf›</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e3</span> <span class="skolem">ρ</span> <span class="skolem">v'</span> <span class="skolem">ρ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 6<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword3"><span class="command">assume</span></span> n_e1<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n</span> <span class="main">∈</span> E <span class="skolem">e1</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> els<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="skolem">v'</span> <span class="main">∈</span> E <span class="skolem">e3</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      thn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> <span class="skolem">v'</span> <span class="main">∈</span> E <span class="skolem">e2</span> <span class="skolem">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 6<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="skolem">ρ'</span></span><span class="main">]</span> n_e1 6<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> e1_w1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ'</span> <span class="main">⊢</span> <span class="skolem">e1</span> <span class="main">⇓</span> BNat <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">ρ'</span> <span class="main">⊢</span> EIf <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e3</span> <span class="main">⇓</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> good <span class="skolem">v'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> 6<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">v'</span></span> <span class="quoted"><span class="skolem">ρ'</span></span><span class="main">]</span> True els 6<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w3</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        e3_w3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ'</span> <span class="main">⊢</span> <span class="skolem">e3</span> <span class="main">⇓</span> <span class="skolem">w3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> w3_vp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w3</span> <span class="main">∈</span> good <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">from</span></span> e1_w1 True e3_w3 w3_vp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> 6<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">v'</span></span> <span class="quoted"><span class="skolem">ρ'</span></span><span class="main">]</span> False thn 6<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w2</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        e2_w2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ'</span> <span class="main">⊢</span> <span class="skolem">e2</span> <span class="main">⇓</span> <span class="skolem">w2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> w2_vp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w2</span> <span class="main">∈</span> good <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">from</span></span> e1_w1 False e2_w2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ'</span> <span class="main">⊢</span> EIf <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e3</span> <span class="main">⇓</span> <span class="skolem">w2</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> eval_if1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ρ'</span></span> <span class="quoted"><span class="skolem">e1</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">e2</span></span> <span class="quoted"><span class="skolem">w2</span></span> <span class="quoted"><span class="skolem">e3</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> this w2_vp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">w2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> sound_wrt_op_sem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> E_e_n<span class="main">:</span> <span class="quoted"><span class="quoted">"E <span class="free">e</span> <span class="main">[]</span> <span class="main">=</span> E <span class="main">(</span>ENat <span class="free">n</span><span class="main">)</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fv_e<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="free">e</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⇓</span> ONat <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"VNat <span class="free">n</span> <span class="main">∈</span> E <span class="main">(</span>ENat <span class="free">n</span><span class="main">)</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
  <span class="keyword1"><span class="command">with</span></span> E_e_n <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="free">n</span> <span class="main">∈</span> E <span class="free">e</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"good_env <span class="main">[]</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> e_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">⇓</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> good <span class="main">(</span>VNat <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> denot_terminates <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> v_n <span class="keyword1"><span class="command">have</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> BNat <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> e_v fv_e <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="skolem"><span class="skolem">ob</span></span> <span class="keyword2"><span class="keyword">where</span></span> e_vp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⟶*</span> <span class="skolem">v'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    vp_ob<span class="main">:</span> <span class="quoted"><span class="quoted">"observe <span class="skolem">v'</span> <span class="skolem">ob</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v_ob<span class="main">:</span> <span class="quoted"><span class="quoted">"bs_observe <span class="skolem">v</span> <span class="skolem">ob</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sound_wrt_small_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> e_vp vp_ob v_ob v <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> run_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">ob</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DenotCompleteFSet">
<div class="head">
<h1>Theory DenotCompleteFSet</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Completeness of the declarative semantics wrt. operational"</span></span>

<span class="keyword1"><span class="command">theory</span></span> DenotCompleteFSet
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="ChangeEnv.html">ChangeEnv</a> <a href="SmallStepLam.html">SmallStepLam</a> <a href="DenotSoundFSet.html">DenotSoundFSet</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Reverse substitution preserves denotation"</span></span>
  
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">join</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> val <span class="main">⇒</span> val option"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊔</span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>VNat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊔</span></span> <span class="main">(</span>VNat <span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n'</span></span></span> <span class="keyword1">then</span> Some <span class="main">(</span>VNat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>VFun <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊔</span></span> <span class="main">(</span>VFun <span class="free"><span class="bound"><span class="entity">f'</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>VFun <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">|∪|</span> <span class="free"><span class="bound"><span class="entity">f'</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="free">⊔</span></span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1" id="DenotCompleteFSet-combine_values"><span class="command">lemma</span></span> combine_values<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> vv<span class="main">:</span> <span class="quoted"><span class="quoted">"isval <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v1v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">∈</span> E <span class="free">v</span> <span class="free">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v2v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v2</span> <span class="main">∈</span> E <span class="free">v</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">" <span class="main">∃</span> <span class="bound">v3</span><span class="main">.</span> <span class="bound">v3</span> <span class="main">∈</span> E <span class="free">v</span> <span class="free">ρ</span> <span class="main">∧</span> <span class="main">(</span><span class="free">v1</span> <span class="main">⊔</span> <span class="free">v2</span> <span class="main">=</span> Some <span class="bound">v3</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> vv v1v v2v <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v1</span></span> <span class="quoted"><span class="free">v2</span></span> <span class="quoted"><span class="free">ρ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="DenotCompleteFSet-le_union1"><span class="command">lemma</span></span> le_union1<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v1</span><span class="main">::</span><span class="quoted">val</span> <span class="keyword2"><span class="keyword">assumes</span></span> v12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">⊔</span> <span class="free">v2</span> <span class="main">=</span> Some <span class="free">v12</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">⊑</span> <span class="free">v12</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v1</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>VNat <span class="skolem">n1</span><span class="main">)</span> <span class="keyword1"><span class="command">hence</span></span> v1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v1</span><span class="main">=</span>VNat <span class="skolem">n1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v2</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>VNat <span class="skolem">n2</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> v1 v12 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n1</span><span class="main">=</span><span class="skolem">n2</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>VFun <span class="skolem">x2</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> v1 v12 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>VFun <span class="skolem">t2</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> VFun <span class="keyword1"><span class="command">have</span></span> v1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v1</span><span class="main">=</span>VFun <span class="skolem">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v2</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>VNat <span class="skolem">n1</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> v1 v12 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>VFun <span class="skolem">n2</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> v1 v12 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DenotCompleteFSet-le_union2"><span class="command">lemma</span></span> le_union2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v1</span> <span class="main">⊔</span> <span class="free">v2</span> <span class="main">=</span> Some <span class="free">v12</span> <span class="main">⟹</span> <span class="free">v2</span> <span class="main">⊑</span> <span class="free">v12</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v1</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v2</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x1 x1'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">x1</span> <span class="main">=</span> <span class="improper">x1'</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v2</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="DenotCompleteFSet-le_union_left"><span class="command">lemma</span></span> le_union_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v1</span> <span class="main">⊔</span> <span class="free">v2</span> <span class="main">=</span> Some <span class="free">v12</span><span class="main">;</span> <span class="free">v1</span> <span class="main">⊑</span> <span class="free">v3</span><span class="main">;</span> <span class="free">v2</span> <span class="main">⊑</span> <span class="free">v3</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">v12</span> <span class="main">⊑</span> <span class="free">v3</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v1</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v2</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
<span class="keyword1" id="DenotCompleteFSet-e_val"><span class="command">lemma</span></span> e_val<span class="main">:</span> <span class="quoted"><span class="quoted">"isval <span class="free">v</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">v'</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">∈</span> E <span class="free">v</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{||}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="DenotCompleteFSet-reverse_subst_lam"><span class="command">lemma</span></span> reverse_subst_lam<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fl<span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="free">f</span> <span class="main">∈</span> E <span class="main">(</span>ELam <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="free">ρ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> vv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_val <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ls<span class="main">:</span> <span class="quoted"><span class="quoted">"ELam <span class="free">x</span> <span class="free">e</span> <span class="main">=</span> ELam <span class="free">x</span> <span class="main">(</span>subst <span class="free">y</span> <span class="free">v</span> <span class="free">e'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v1</span> <span class="bound">v2</span><span class="main">.</span> <span class="bound">v2</span> <span class="main">∈</span> E <span class="main">(</span>subst <span class="free">y</span> <span class="free">v</span> <span class="free">e'</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">v1</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span> 
        <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">ρ'</span> <span class="bound">v'</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">∈</span> E <span class="free">v</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">v2</span> <span class="main">∈</span> E <span class="free">e'</span> <span class="bound">ρ'</span> <span class="main">∧</span> <span class="bound">ρ'</span> <span class="main">≈</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="bound">v'</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">v1</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">ρ'</span> <span class="bound">v''</span><span class="main">.</span> <span class="bound">v''</span> <span class="main">∈</span> E <span class="free">v</span> <span class="main">[]</span> <span class="main">∧</span> VFun <span class="free">f</span> <span class="main">∈</span> E <span class="main">(</span>ELam <span class="free">x</span> <span class="free">e'</span><span class="main">)</span> <span class="bound">ρ'</span> <span class="main">∧</span> <span class="bound">ρ'</span> <span class="main">≈</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="bound">v''</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fl vv ls IH xy 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">e'</span></span> <span class="quoted"><span class="free">ρ</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">from</span></span> empty<span class="main">(</span>2<span class="main">)</span> is_val_def <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> vp_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> E <span class="skolem">v</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> e_val<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">v'</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="main">{||}</span> <span class="main">∈</span> E <span class="main">(</span>ELam <span class="skolem">x</span> <span class="skolem">e'</span><span class="main">)</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">≈</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> vp_v 1 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">e'</span> <span class="skolem">ρ</span> <span class="skolem">v</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> insert<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="skolem">f</span> <span class="main">∈</span> E <span class="main">(</span>ELam <span class="skolem">x</span> <span class="skolem">e</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v1</span></span> <span class="skolem"><span class="skolem">v2</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v1</span><span class="main">,</span><span class="skolem">v2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> insert 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">ρ'</span> <span class="bound">v''</span><span class="main">.</span> <span class="bound">v''</span> <span class="main">∈</span> E <span class="skolem">v</span> <span class="main">[]</span> <span class="main">∧</span> VFun <span class="skolem">f</span> <span class="main">∈</span> E <span class="main">(</span>ELam <span class="skolem">x</span> <span class="skolem">e'</span><span class="main">)</span> <span class="bound">ρ'</span> <span class="main">∧</span> <span class="bound">ρ'</span> <span class="main">≈</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="bound">v''</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ρ''</span></span> <span class="skolem"><span class="skolem">v''</span></span> <span class="keyword2"><span class="keyword">where</span></span> vpp_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v''</span> <span class="main">∈</span> E <span class="skolem">v</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f_l<span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="skolem">f</span> <span class="main">∈</span> E <span class="main">(</span>ELam <span class="skolem">x</span> <span class="skolem">e'</span><span class="main">)</span> <span class="skolem">ρ''</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> rpp_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ''</span> <span class="main">≈</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">v''</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> insert<span class="main">(</span>3<span class="main">)</span> a <span class="keyword1"><span class="command">have</span></span> v2_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> E <span class="skolem">e</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">v1</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> e_lam_elim2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> insert v2_e <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ρ''</span> <span class="bound">v'</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">∈</span> E <span class="skolem">v</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">v2</span> <span class="main">∈</span> E <span class="skolem">e'</span> <span class="bound">ρ''</span> <span class="main">∧</span> <span class="bound">ρ''</span> <span class="main">≈</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">v1</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ρ3</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> vp_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> E <span class="skolem">v</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v2_ep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> E <span class="skolem">e'</span> <span class="skolem">ρ3</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> r3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ3</span> <span class="main">≈</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">v'</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">v1</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> insert<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isval <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this vp_v vpp_v <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v3</span></span> <span class="keyword2"><span class="keyword">where</span></span> v3_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v3</span> <span class="main">∈</span> E <span class="skolem">v</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vp_vpp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">⊔</span> <span class="skolem">v''</span> <span class="main">=</span> Some <span class="skolem">v3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> combine_values <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="main">(</span>finsert <span class="skolem">a</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">∈</span> E <span class="main">(</span>ELam <span class="skolem">x</span> <span class="skolem">e'</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">v3</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> vp_vpp <span class="keyword1"><span class="command">have</span></span> v3_vpp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v''</span> <span class="main">⊑</span> <span class="skolem">v3</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> le_union2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> rpp_r v3_vpp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ''</span> <span class="main">⊑</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">v3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_eq_def env_le_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> f_l this <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="skolem">f</span> <span class="main">∈</span> E <span class="main">(</span>ELam <span class="skolem">x</span> <span class="skolem">e'</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">v3</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> raise_env<span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> vp_vpp <span class="keyword1"><span class="command">have</span></span> vp_v3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">⊑</span> <span class="skolem">v3</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> le_union1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> vp_v3 r3 insert <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ3</span> <span class="main">⊑</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">v1</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">v3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_eq_def env_le_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> v2_ep this <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> E <span class="skolem">e'</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">v1</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">v3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> raise_env<span class="main">)</span>      
    <span class="keyword1"><span class="command">from</span></span> 2 3 a <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> e_lam_intro2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">v3</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ</span> <span class="main">≈</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">v3</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> v3_v 4 5 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="DenotCompleteFSet-lookup_ext_none"><span class="command">lemma</span></span> lookup_ext_none<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> lookup <span class="free">ρ</span> <span class="free">y</span> <span class="main">=</span> None<span class="main">;</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> lookup <span class="main">(</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">― ‹For reverse subst lemma, the variable case shows up over and over, so we prove it as a lemma›</span>
<span class="keyword1" id="DenotCompleteFSet-rev_subst_var"><span class="command">lemma</span></span> rev_subst_var<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> EVar <span class="free">y</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">=</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_val <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vp_E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v'</span> <span class="main">∈</span> E <span class="free">e'</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">ρ'</span> <span class="bound">v''</span><span class="main">.</span> <span class="bound">v''</span> <span class="main">∈</span> E <span class="free">v</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">v'</span> <span class="main">∈</span> E <span class="free">e</span> <span class="bound">ρ'</span> <span class="main">∧</span> <span class="bound">ρ'</span> <span class="main">≈</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="bound">v''</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> vv <span class="keyword1"><span class="command">have</span></span> lx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> FV <span class="free">v</span> <span class="main">⟶</span> lookup <span class="main">[]</span> <span class="bound">x</span> <span class="main">=</span> lookup <span class="free">ρ</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> ev vp_E lx env_strengthen<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">v'</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">ρ</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> n_Ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v'</span> <span class="main">∈</span> E <span class="free">v</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">have</span></span> ly<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">v'</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> Some <span class="free">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> env_eq_def <span class="keyword1"><span class="command">have</span></span> rr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">v'</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">v'</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> ev ly <span class="keyword1"><span class="command">have</span></span> n_Ee<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v'</span> <span class="main">∈</span> E <span class="free">e</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">v'</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">from</span></span> n_Ev rr n_Ee <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="DenotCompleteFSet-reverse_subst_pres_denot"><span class="command">lemma</span></span> reverse_subst_pres_denot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> vep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v'</span> <span class="main">∈</span> E <span class="free">e'</span> <span class="free">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_val <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e'</span> <span class="main">=</span> subst <span class="free">y</span> <span class="free">v</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">ρ'</span> <span class="bound">v''</span><span class="main">.</span> <span class="bound">v''</span> <span class="main">∈</span> E <span class="free">v</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">v'</span> <span class="main">∈</span> E <span class="free">e</span> <span class="bound">ρ'</span> <span class="main">∧</span> <span class="bound">ρ'</span> <span class="main">≈</span> <span class="main">(</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="bound">v''</span><span class="main">)</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> vep vv ep 
<span class="keyword1"><span class="command">proof</span></span>  <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v'</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> E.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="comment1">― ‹e' = ENat n›</span>
  <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> vp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> VNat <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> ENat <span class="skolem">n</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">e</span> <span class="main">=</span> EVar <span class="skolem">y</span> <span class="main">∧</span> <span class="skolem">v</span> <span class="main">=</span> ENat <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> ENat <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>2<span class="main">)</span> e_val is_val_def <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v''</span></span> <span class="keyword2"><span class="keyword">where</span></span> vpp_E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v''</span> <span class="main">∈</span> E <span class="skolem">v</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> env_eq_def <span class="keyword1"><span class="command">have</span></span> rr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">v''</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">v''</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> vp e <span class="keyword1"><span class="command">have</span></span> vp_E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> E <span class="skolem">e</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">v''</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> vpp_E vp_E rr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> EVar <span class="skolem">y</span> <span class="main">∧</span> <span class="skolem">v</span> <span class="main">=</span> ENat <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> ev 1<span class="main">(</span>2<span class="main">)</span> 1<span class="main">(</span>1<span class="main">)</span> rev_subst_var <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="comment1">― ‹e' = EVar x›</span>
  <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword1"><span class="command">have</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> EVar <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 2 e <span class="keyword1"><span class="command">have</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>2<span class="main">)</span> e_val is_val_def <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v''</span></span> <span class="keyword2"><span class="keyword">where</span></span> vpp_E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v''</span> <span class="main">∈</span> E <span class="skolem">v</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> env_eq_def <span class="keyword1"><span class="command">have</span></span> rr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">v''</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">v''</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> 2<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vx</span></span> <span class="keyword2"><span class="keyword">where</span></span> lx<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="skolem">ρ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">vx</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vp_vx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">⊑</span> <span class="skolem">vx</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> e lx vp_vx xy <span class="keyword1"><span class="command">have</span></span> vp_E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> E <span class="skolem">e</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">v''</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">from</span></span> vpp_E rr vp_E <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">eb</span> <span class="skolem">ρ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> EVar <span class="skolem">y</span> <span class="main">∧</span> <span class="skolem">v</span> <span class="main">=</span> ELam <span class="skolem">x</span> <span class="skolem">eb</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> ev 3<span class="main">(</span>3<span class="main">)</span> 3<span class="main">(</span>2<span class="main">)</span> rev_subst_var <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> ELam <span class="skolem">x</span> <span class="skolem">eb</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>3<span class="main">)</span> e_val is_val_def <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v''</span></span> <span class="keyword2"><span class="keyword">where</span></span> vpp_E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v''</span> <span class="main">∈</span> E <span class="skolem">v</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> env_eq_def <span class="keyword1"><span class="command">have</span></span> rr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">v''</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">v''</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> ex <span class="keyword1"><span class="command">have</span></span> lz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> FV <span class="main">(</span>ELam <span class="skolem">x</span> <span class="skolem">eb</span><span class="main">)</span> <span class="main">⟶</span> lookup <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">v''</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="bound">z</span> <span class="main">=</span> lookup <span class="skolem">ρ</span> <span class="bound">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> ex 3<span class="main">(</span>2<span class="main">)</span> lz env_strengthen<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v'</span></span> <span class="quoted"><span class="quoted">"ELam <span class="skolem">x</span> <span class="skolem">eb</span>"</span></span> <span class="quoted"><span class="skolem">ρ</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">v''</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> vp_E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> E <span class="skolem">e</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">v''</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> vpp_E vp_E rr <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> exb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">e'</span><span class="main">.</span> <span class="skolem">e</span> <span class="main">=</span> ELam <span class="skolem">x</span> <span class="bound">e'</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="skolem">eb</span> <span class="main">=</span> subst <span class="skolem">y</span> <span class="skolem">v</span> <span class="bound">e'</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> exb <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e''</span></span> <span class="keyword2"><span class="keyword">where</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> ELam <span class="skolem">x</span> <span class="skolem">e''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> eb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">eb</span> <span class="main">=</span> subst <span class="skolem">y</span> <span class="skolem">v</span> <span class="skolem">e''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> vp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> VFun <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>2<span class="main">)</span> vp <span class="keyword1"><span class="command">have</span></span> f_E<span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="skolem">f</span> <span class="main">∈</span> E <span class="main">(</span>ELam <span class="skolem">x</span> <span class="skolem">eb</span><span class="main">)</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>4<span class="main">)</span> e xy <span class="keyword1"><span class="command">have</span></span> ls<span class="main">:</span> <span class="quoted"><span class="quoted">"ELam <span class="skolem">x</span> <span class="skolem">eb</span> <span class="main">=</span> ELam <span class="skolem">x</span> <span class="main">(</span>subst <span class="skolem">y</span> <span class="skolem">v</span> <span class="skolem">e''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>3<span class="main">)</span> eb <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v1</span> <span class="bound">v2</span><span class="main">.</span> <span class="bound">v2</span> <span class="main">∈</span> E <span class="main">(</span>subst <span class="skolem">y</span> <span class="skolem">v</span> <span class="skolem">e''</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="bound">v1</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> 
        <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">ρ'</span> <span class="bound">v'</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">∈</span> E <span class="skolem">v</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">v2</span> <span class="main">∈</span> E <span class="skolem">e''</span> <span class="bound">ρ'</span> <span class="main">∧</span> <span class="bound">ρ'</span> <span class="main">≈</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="bound">v'</span><span class="main">)</span><span class="main">#</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="bound">v1</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="improper">v1</span><span class="main">,</span><span class="improper">v2</span><span class="main">)</span> <span class="main">∈</span> fset <span class="main">{|</span><span class="main">(</span><span class="improper">v1</span><span class="main">,</span><span class="improper">v2</span><span class="main">)</span><span class="main">|}</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 3<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">from</span></span> f_E 3<span class="main">(</span>3<span class="main">)</span> ls xy IH e vp <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> reverse_subst_lam<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">e</span> <span class="main">=</span> EVar <span class="skolem">y</span> <span class="main">∧</span> <span class="skolem">v</span> <span class="main">=</span> ELam <span class="skolem">x</span> <span class="skolem">eb</span><span class="main">)</span>
      <span class="main">∨</span> <span class="main">(</span><span class="skolem">e</span> <span class="main">=</span> ELam <span class="skolem">x</span> <span class="skolem">eb</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span><span class="main">)</span>
      <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">e'</span><span class="main">.</span> <span class="skolem">e</span> <span class="main">=</span> ELam <span class="skolem">x</span> <span class="bound">e'</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="skolem">eb</span> <span class="main">=</span> subst <span class="skolem">y</span> <span class="skolem">v</span> <span class="bound">e'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="comment1">― ‹e' = EApp e1 e2›</span>
  <span class="keyword1"><span class="command">from</span></span> 4<span class="main">(</span>4<span class="main">)</span> 4<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e1'</span></span> <span class="skolem"><span class="skolem">e2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> EApp <span class="skolem">e1'</span> <span class="skolem">e2'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> e1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">e1</span> <span class="main">=</span> subst <span class="skolem">y</span> <span class="skolem">v</span> <span class="skolem">e1'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> e2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e2</span> <span class="main">=</span> subst <span class="skolem">y</span> <span class="skolem">v</span> <span class="skolem">e2'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="improper">x</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x1 x2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="improper">x1</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> 4<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">v2</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">v2'</span></span><span class="main">::</span><span class="quoted">val</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">v3'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    f_E<span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="skolem">f</span> <span class="main">∈</span> E <span class="skolem">e1</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v2_E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> E <span class="skolem">e2</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v23<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v2'</span><span class="main">,</span><span class="skolem">v3'</span><span class="main">)</span> <span class="main">∈</span> fset <span class="skolem">f</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> v2p_v2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2'</span> <span class="main">⊑</span> <span class="skolem">v2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vp_v3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">⊑</span> <span class="skolem">v3'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> 4<span class="main">(</span>1<span class="main">)</span> f_E 4<span class="main">(</span>4<span class="main">)</span> e1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ρ1</span></span> <span class="skolem"><span class="skolem">w1</span></span> <span class="keyword2"><span class="keyword">where</span></span> v1_Ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span> <span class="main">∈</span> E <span class="skolem">v</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f_E1<span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="skolem">f</span> <span class="main">∈</span> E <span class="skolem">e1'</span> <span class="skolem">ρ1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> r1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ1</span> <span class="main">≈</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w1</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> 4<span class="main">(</span>2<span class="main">)</span> v2_E 4<span class="main">(</span>4<span class="main">)</span> e2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ρ2</span></span> <span class="skolem"><span class="skolem">w2</span></span> <span class="keyword2"><span class="keyword">where</span></span> v2_Ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w2</span> <span class="main">∈</span> E <span class="skolem">v</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v2_E2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> E <span class="skolem">e2'</span> <span class="skolem">ρ2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> r2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ2</span> <span class="main">≈</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w2</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> 4<span class="main">(</span>4<span class="main">)</span> v1_Ev v2_Ev combine_values <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w3</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    w3_Ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w3</span> <span class="main">∈</span> E <span class="skolem">v</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> w123<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span> <span class="main">⊔</span> <span class="skolem">w2</span> <span class="main">=</span> Some <span class="skolem">w3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> is_val_def<span class="main">)</span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> w123 le_union1 <span class="keyword1"><span class="command">have</span></span> w13<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span> <span class="main">⊑</span> <span class="skolem">w3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> w123 le_union2 <span class="keyword1"><span class="command">have</span></span> w23<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w2</span> <span class="main">⊑</span> <span class="skolem">w3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> w13 <span class="keyword1"><span class="command">have</span></span> r13<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w1</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_le_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> w23 <span class="keyword1"><span class="command">have</span></span> r23<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w2</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_le_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> r1 f_E1 <span class="keyword1"><span class="command">have</span></span> f_E1b<span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="skolem">f</span> <span class="main">∈</span> E <span class="skolem">e1'</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w1</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_swap<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> f_E1b r13 <span class="keyword1"><span class="command">have</span></span> f_E1c<span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="skolem">f</span> <span class="main">∈</span> E <span class="skolem">e1'</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> raise_env<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> r2 v2_E2 <span class="keyword1"><span class="command">have</span></span> v2_E2b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> E <span class="skolem">e2'</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w2</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_swap<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> v2_E2b r23 <span class="keyword1"><span class="command">have</span></span> v2_E2c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> E <span class="skolem">e2'</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> raise_env<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> f_E1c v2_E2c v23 v2p_v2 vp_v3 <span class="keyword1"><span class="command">have</span></span> vp_E2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> E <span class="main">(</span>EApp <span class="skolem">e1'</span> <span class="skolem">e2'</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> rr3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_eq_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> w3_Ev vp_E2 rr3 e <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">f</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="comment1">― ‹e' = EPrim f e1 e2, very similar to case for EApp›</span>
  <span class="keyword1"><span class="command">from</span></span> 5<span class="main">(</span>4<span class="main">)</span> 5<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e1'</span></span> <span class="skolem"><span class="skolem">e2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> EPrim <span class="skolem">f</span> <span class="skolem">e1'</span> <span class="skolem">e2'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> e1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">e1</span> <span class="main">=</span> subst <span class="skolem">y</span> <span class="skolem">v</span> <span class="skolem">e1'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> e2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e2</span> <span class="main">=</span> subst <span class="skolem">y</span> <span class="skolem">v</span> <span class="skolem">e2'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="improper">x</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x1 x2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="improper">x1</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> 5<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n1</span></span> <span class="skolem"><span class="skolem">n2</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    n1_E<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n1</span> <span class="main">∈</span> E <span class="skolem">e1</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n2_E<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n2</span> <span class="main">∈</span> E <span class="skolem">e2</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> VNat <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n1</span> <span class="skolem">n2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> 5<span class="main">(</span>1<span class="main">)</span> n1_E 5<span class="main">(</span>4<span class="main">)</span> e1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ρ1</span></span> <span class="skolem"><span class="skolem">w1</span></span> <span class="keyword2"><span class="keyword">where</span></span> v1_Ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span> <span class="main">∈</span> E <span class="skolem">v</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n1_E1<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n1</span> <span class="main">∈</span> E <span class="skolem">e1'</span> <span class="skolem">ρ1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> r1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ1</span> <span class="main">≈</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w1</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> 5<span class="main">(</span>2<span class="main">)</span> n2_E 5<span class="main">(</span>4<span class="main">)</span> e2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ρ2</span></span> <span class="skolem"><span class="skolem">w2</span></span> <span class="keyword2"><span class="keyword">where</span></span> v2_Ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w2</span> <span class="main">∈</span> E <span class="skolem">v</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n2_E2<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n2</span> <span class="main">∈</span> E <span class="skolem">e2'</span> <span class="skolem">ρ2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> r2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ2</span> <span class="main">≈</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w2</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> 5<span class="main">(</span>4<span class="main">)</span> v1_Ev v2_Ev combine_values <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w3</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    w3_Ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w3</span> <span class="main">∈</span> E <span class="skolem">v</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> w123<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span> <span class="main">⊔</span> <span class="skolem">w2</span> <span class="main">=</span> Some <span class="skolem">w3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> is_val_def<span class="main">)</span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> w123 le_union1 <span class="keyword1"><span class="command">have</span></span> w13<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span> <span class="main">⊑</span> <span class="skolem">w3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> w123 le_union2 <span class="keyword1"><span class="command">have</span></span> w23<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w2</span> <span class="main">⊑</span> <span class="skolem">w3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> w13 <span class="keyword1"><span class="command">have</span></span> r13<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w1</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_le_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> w23 <span class="keyword1"><span class="command">have</span></span> r23<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w2</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_le_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> r1 n1_E1 <span class="keyword1"><span class="command">have</span></span> n1_E1b<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n1</span> <span class="main">∈</span> E <span class="skolem">e1'</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w1</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_swap<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> n1_E1b r13 <span class="keyword1"><span class="command">have</span></span> n1_E1c<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n1</span> <span class="main">∈</span> E <span class="skolem">e1'</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> raise_env<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> r2 n2_E2 <span class="keyword1"><span class="command">have</span></span> n2_E2b<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n2</span> <span class="main">∈</span> E <span class="skolem">e2'</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w2</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_swap<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> n2_E2b r23 <span class="keyword1"><span class="command">have</span></span> v2_E2c<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n2</span> <span class="main">∈</span> E <span class="skolem">e2'</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> raise_env<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> n1_E1c v2_E2c vp <span class="keyword1"><span class="command">have</span></span> vp_E2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> E <span class="main">(</span>EPrim <span class="skolem">f</span> <span class="skolem">e1'</span> <span class="skolem">e2'</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> rr3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_eq_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> w3_Ev vp_E2 rr3 e <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e3</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="comment1">― ‹e' = EIf e1 e2 e3›</span>
  <span class="keyword1"><span class="command">from</span></span> 6<span class="main">(</span>5<span class="main">)</span> 6<span class="main">(</span>6<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e1'</span></span> <span class="skolem"><span class="skolem">e2'</span></span> <span class="skolem"><span class="skolem">e3'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> EIf <span class="skolem">e1'</span> <span class="skolem">e2'</span> <span class="skolem">e3'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> e1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">e1</span> <span class="main">=</span> subst <span class="skolem">y</span> <span class="skolem">v</span> <span class="skolem">e1'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> e2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e2</span> <span class="main">=</span> subst <span class="skolem">y</span> <span class="skolem">v</span> <span class="skolem">e2'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> e3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e3</span> <span class="main">=</span> subst <span class="skolem">y</span> <span class="skolem">v</span> <span class="skolem">e3'</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">=</span><span class="improper">x1</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">=</span><span class="improper">x31</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 6<span class="main">(</span>4<span class="main">)</span> e_if_elim <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n_E<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n</span> <span class="main">∈</span> E <span class="skolem">e1</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
    els<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="skolem">v'</span> <span class="main">∈</span> E <span class="skolem">e3</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> thn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> <span class="skolem">v'</span> <span class="main">∈</span> E <span class="skolem">e2</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> 6 n_E e1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ρ1</span></span> <span class="skolem"><span class="skolem">w1</span></span> <span class="keyword2"><span class="keyword">where</span></span> w1_Ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span> <span class="main">∈</span> E <span class="skolem">v</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n_E2<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n</span> <span class="main">∈</span> E <span class="skolem">e1'</span> <span class="skolem">ρ1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> r1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ1</span> <span class="main">≈</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w1</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> els <span class="keyword1"><span class="command">have</span></span> vp_E2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> E <span class="skolem">e3</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> 6 vp_E2 e3 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ρ2</span></span> <span class="skolem"><span class="skolem">w2</span></span> <span class="keyword2"><span class="keyword">where</span></span> w2_Ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w2</span> <span class="main">∈</span> E <span class="skolem">v</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vp_E2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> E <span class="skolem">e3'</span> <span class="skolem">ρ2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> r2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ2</span> <span class="main">≈</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w2</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> 6<span class="main">(</span>5<span class="main">)</span> w1_Ev w2_Ev combine_values <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w3</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      w3_Ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w3</span> <span class="main">∈</span> E <span class="skolem">v</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> w123<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span> <span class="main">⊔</span> <span class="skolem">w2</span> <span class="main">=</span> Some <span class="skolem">w3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> is_val_def<span class="main">)</span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">from</span></span> w123 le_union1 <span class="keyword1"><span class="command">have</span></span> w13<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span> <span class="main">⊑</span> <span class="skolem">w3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> w123 le_union2 <span class="keyword1"><span class="command">have</span></span> w23<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w2</span> <span class="main">⊑</span> <span class="skolem">w3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> w13 <span class="keyword1"><span class="command">have</span></span> r13<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w1</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_le_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> w23 <span class="keyword1"><span class="command">have</span></span> r23<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w2</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_le_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> r1 n_E2 <span class="keyword1"><span class="command">have</span></span> n_E1b<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n</span> <span class="main">∈</span> E <span class="skolem">e1'</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w1</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_swap<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> n_E1b r13 <span class="keyword1"><span class="command">have</span></span> n_E1c<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n</span> <span class="main">∈</span> E <span class="skolem">e1'</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> raise_env<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> r2 vp_E2 <span class="keyword1"><span class="command">have</span></span> vp_E2b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> E <span class="skolem">e3'</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w2</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_swap<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> vp_E2b r23 <span class="keyword1"><span class="command">have</span></span> vp_E2c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> E <span class="skolem">e3'</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> raise_env<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> rr3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_eq_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> True n_E1c vp_E2c e <span class="keyword1"><span class="command">have</span></span> vp_E3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> E <span class="skolem">e</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">from</span></span> w3_Ev rr3 vp_E3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> thn <span class="keyword1"><span class="command">have</span></span> vp_E2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> E <span class="skolem">e2</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> 6 vp_E2 e2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ρ2</span></span> <span class="skolem"><span class="skolem">w2</span></span> <span class="keyword2"><span class="keyword">where</span></span> w2_Ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w2</span> <span class="main">∈</span> E <span class="skolem">v</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vp_E2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> E <span class="skolem">e2'</span> <span class="skolem">ρ2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> r2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ2</span> <span class="main">≈</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w2</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> 6<span class="main">(</span>5<span class="main">)</span> w1_Ev w2_Ev combine_values <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w3</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      w3_Ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w3</span> <span class="main">∈</span> E <span class="skolem">v</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> w123<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span> <span class="main">⊔</span> <span class="skolem">w2</span> <span class="main">=</span> Some <span class="skolem">w3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> is_val_def<span class="main">)</span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">from</span></span> w123 le_union1 <span class="keyword1"><span class="command">have</span></span> w13<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span> <span class="main">⊑</span> <span class="skolem">w3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> w123 le_union2 <span class="keyword1"><span class="command">have</span></span> w23<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w2</span> <span class="main">⊑</span> <span class="skolem">w3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> w13 <span class="keyword1"><span class="command">have</span></span> r13<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w1</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_le_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> w23 <span class="keyword1"><span class="command">have</span></span> r23<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w2</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_le_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> r1 n_E2 <span class="keyword1"><span class="command">have</span></span> n_E1b<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n</span> <span class="main">∈</span> E <span class="skolem">e1'</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w1</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_swap<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> n_E1b r13 <span class="keyword1"><span class="command">have</span></span> n_E1c<span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="skolem">n</span> <span class="main">∈</span> E <span class="skolem">e1'</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> raise_env<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> r2 vp_E2 <span class="keyword1"><span class="command">have</span></span> vp_E2b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> E <span class="skolem">e2'</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w2</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> env_swap<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> vp_E2b r23 <span class="keyword1"><span class="command">have</span></span> vp_E2c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> E <span class="skolem">e2'</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> raise_env<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> rr3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">≈</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> env_eq_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> False n_E1c vp_E2c e <span class="keyword1"><span class="command">have</span></span> vp_E3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> E <span class="skolem">e</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">w3</span><span class="main">)</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">from</span></span> w3_Ev rr3 vp_E3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Reverse reduction preserves denotation"</span></span>

<span class="keyword1" id="DenotCompleteFSet-reverse_step_pres_denot"><span class="command">lemma</span></span> reverse_step_pres_denot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span><span class="main">::</span><span class="quoted">exp</span> <span class="keyword2"><span class="keyword">assumes</span></span> e_ep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⟶</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v_ep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> E <span class="free">e'</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> e_ep v_ep
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">ρ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reduce.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">v</span> <span class="skolem">x</span> <span class="skolem">e</span> <span class="skolem">v'</span> <span class="skolem">ρ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> beta <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ρ'</span></span> <span class="skolem"><span class="skolem">v''</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v''</span> <span class="main">∈</span> E <span class="skolem">v</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> E <span class="skolem">e</span> <span class="skolem">ρ'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ'</span> <span class="main">≈</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">v''</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reverse_subst_pres_denot<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v'</span></span> <span class="quoted"><span class="quoted">"subst <span class="skolem">x</span> <span class="skolem">v</span> <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="skolem">ρ</span></span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">e</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> beta 1 2 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{|</span><span class="main">(</span><span class="skolem">v''</span><span class="main">,</span><span class="skolem">v'</span><span class="main">)</span><span class="main">|}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> env_swap<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">v''</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> env_strengthen<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    
<span class="keyword1" id="DenotCompleteFSet-reverse_multi_step_pres_denot"><span class="command">lemma</span></span> reverse_multi_step_pres_denot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span><span class="main">::</span><span class="quoted">exp</span> <span class="keyword2"><span class="keyword">assumes</span></span> e_ep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⟶*</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v_ep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> E <span class="free">e'</span> <span class="free">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ</span>"</span></span> 
  <span class="keyword1"><span class="command">using</span></span> e_ep v_ep reverse_step_pres_denot
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">ρ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> multi_step.induct<span class="main">)</span> <span class="operator">auto</span> 

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Completeness"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> completeness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⟶*</span> <span class="free">v</span>"</span></span><span class="keyword2"><span class="keyword">and</span></span> vv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_val <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v'</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ</span> <span class="main">∧</span> <span class="bound">v'</span> <span class="main">∈</span> E <span class="free">v</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> vv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v'</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">∈</span> E <span class="free">v</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> e_val <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> vp_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> E <span class="free">v</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> vp_v vv <span class="keyword1"><span class="command">have</span></span> vp_v2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> E <span class="free">v</span> <span class="free">ρ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> env_strengthen <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword1"><span class="command">from</span></span> ev vp_v2 reverse_multi_step_pres_denot<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="skolem">v'</span></span> <span class="quoted"><span class="free">ρ</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> E <span class="free">e</span> <span class="free">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">from</span></span> this vp_v <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> reduce_pres_denot<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span><span class="main">::</span><span class="quoted">exp</span> <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⟶</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"E <span class="free">e</span> <span class="main">=</span> E <span class="free">e'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span> 
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subject_reduction<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command">using</span></span> r <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span> 
  <span class="keyword1"><span class="command">using</span></span> r <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> reverse_step_pres_denot<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> multi_reduce_pres_denot<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">e</span><span class="main">::</span><span class="quoted">exp</span> <span class="keyword2"><span class="keyword">assumes</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⟶*</span> <span class="free">e'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"E <span class="free">e</span> <span class="main">=</span> E <span class="free">e'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r reduce_pres_denot <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> complete_wrt_op_sem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> e_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⇓</span> ONat <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"E <span class="free">e</span> <span class="main">[]</span> <span class="main">=</span> E <span class="main">(</span>ENat <span class="free">n</span><span class="main">)</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> e_n <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⟶*</span> ENat <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> run_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> v<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">v</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> multi_reduce_pres_denot <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DenotCongruenceFSet">
<div class="head">
<h1>Theory DenotCongruenceFSet</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Soundness wrt. contextual equivalence"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Denotational semantics is a congruence"</span></span>  

<span class="keyword1"><span class="command">theory</span></span> DenotCongruenceFSet
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="ChangeEnv.html">ChangeEnv</a> <a href="DenotSoundFSet.html">DenotSoundFSet</a> <a href="DenotCompleteFSet.html">DenotCompleteFSet</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1" id="DenotCongruenceFSet-e_lam_cong"><span class="command">lemma</span></span> e_lam_cong<span class="main">[</span><span class="operator">cong</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"E <span class="free">e</span>  <span class="main">=</span> E <span class="free">e'</span> <span class="main">⟹</span> E <span class="main">(</span>ELam <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> E <span class="main">(</span>ELam <span class="free">x</span> <span class="free">e'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="DenotCongruenceFSet-e_app_cong"><span class="command">lemma</span></span> e_app_cong<span class="main">[</span><span class="operator">cong</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> E <span class="free">e1</span> <span class="main">=</span> E <span class="free">e1'</span><span class="main">;</span> E <span class="free">e2</span> <span class="main">=</span> E <span class="free">e2'</span> <span class="main">⟧</span> <span class="main">⟹</span> E <span class="main">(</span>EApp <span class="free">e1</span> <span class="free">e2</span><span class="main">)</span> <span class="main">=</span> E <span class="main">(</span>EApp <span class="free">e1'</span> <span class="free">e2'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="operator">simp</span> 

<span class="keyword1" id="DenotCongruenceFSet-e_prim_cong"><span class="command">lemma</span></span> e_prim_cong<span class="main">[</span><span class="operator">cong</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> E <span class="free">e1</span> <span class="main">=</span> E <span class="free">e1'</span><span class="main">;</span> E <span class="free">e2</span> <span class="main">=</span> E <span class="free">e2'</span> <span class="main">⟧</span> <span class="main">⟹</span> E<span class="main">(</span>EPrim <span class="free">f</span> <span class="free">e1</span> <span class="free">e2</span><span class="main">)</span> <span class="main">=</span> E<span class="main">(</span>EPrim <span class="free">f</span> <span class="free">e1'</span> <span class="free">e2'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="operator">simp</span> 

<span class="keyword1" id="DenotCongruenceFSet-e_if_cong"><span class="command">lemma</span></span> e_if_cong<span class="main">[</span><span class="operator">cong</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> E <span class="free">e1</span> <span class="main">=</span> E <span class="free">e1'</span><span class="main">;</span> E <span class="free">e2</span> <span class="main">=</span> E <span class="free">e2'</span><span class="main">;</span> E <span class="free">e3</span> <span class="main">=</span> E <span class="free">e3'</span> <span class="main">⟧</span> 
    <span class="main">⟹</span> E <span class="main">(</span>EIf <span class="free">e1</span> <span class="free">e2</span> <span class="free">e3</span><span class="main">)</span> <span class="main">=</span> E <span class="main">(</span>EIf <span class="free">e1'</span> <span class="free">e2'</span> <span class="free">e3'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="operator">simp</span> 

<span class="keyword1"><span class="command">datatype</span></span> ctx <span class="main">=</span> CHole <span class="main">|</span> CLam <span class="quoted">name</span> <span class="quoted">ctx</span> <span class="main">|</span> CAppL <span class="quoted">ctx</span> <span class="quoted">exp</span> <span class="main">|</span> CAppR <span class="quoted">exp</span> <span class="quoted">ctx</span>
  <span class="main">|</span> CPrimL <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span>  <span class="quoted">ctx</span> <span class="quoted">exp</span> <span class="main">|</span> CPrimR <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span>  <span class="quoted">exp</span> <span class="quoted">ctx</span>
  <span class="main">|</span> CIf1 <span class="quoted">ctx</span> <span class="quoted">exp</span> <span class="quoted">exp</span> <span class="main">|</span> CIf2 <span class="quoted">exp</span> <span class="quoted">ctx</span> <span class="quoted">exp</span> <span class="main">|</span> CIf3 <span class="quoted">exp</span> <span class="quoted">exp</span> <span class="quoted">ctx</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">plug</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ctx <span class="main">⇒</span> exp <span class="main">⇒</span> exp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">plug</span> CHole <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">plug</span> <span class="main">(</span>CLam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> ELam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">plug</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">plug</span> <span class="main">(</span>CAppL <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> EApp <span class="main">(</span><span class="free">plug</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">plug</span> <span class="main">(</span>CAppR <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> EApp <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">(</span><span class="free">plug</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">plug</span> <span class="main">(</span>CPrimL <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> EPrim <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free">plug</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">plug</span> <span class="main">(</span>CPrimR <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> EPrim <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">(</span><span class="free">plug</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">plug</span> <span class="main">(</span>CIf1 <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> EIf <span class="main">(</span><span class="free">plug</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">plug</span> <span class="main">(</span>CIf2 <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> EIf <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">(</span><span class="free">plug</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">plug</span> <span class="main">(</span>CIf3 <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> EIf <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">(</span><span class="free">plug</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span> 
    
<span class="keyword1" id="DenotCongruenceFSet-congruence"><span class="command">lemma</span></span> congruence<span class="main">:</span> <span class="quoted"><span class="quoted">"E <span class="free">e</span> <span class="main">=</span> E <span class="free">e'</span> <span class="main">⟹</span> E <span class="main">(</span>plug <span class="free">C</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> E <span class="main">(</span>plug <span class="free">C</span> <span class="free">e'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">C</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">e'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CIf1 <span class="skolem">C</span> <span class="skolem">e2</span> <span class="skolem">e3</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"E <span class="main">(</span>EIf <span class="main">(</span>plug <span class="skolem">C</span> <span class="skolem">e</span><span class="main">)</span> <span class="skolem">e2</span> <span class="skolem">e3</span><span class="main">)</span> <span class="main">=</span> E <span class="main">(</span>EIf <span class="main">(</span>plug <span class="skolem">C</span> <span class="skolem">e'</span><span class="main">)</span> <span class="skolem">e2</span> <span class="skolem">e3</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> e_if_cong<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> CIf1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CIf2 <span class="skolem">e1</span> <span class="skolem">C</span> <span class="skolem">e3</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"E <span class="main">(</span>EIf <span class="skolem">e1</span> <span class="main">(</span>plug <span class="skolem">C</span> <span class="skolem">e</span><span class="main">)</span> <span class="skolem">e3</span><span class="main">)</span> <span class="main">=</span> E <span class="main">(</span>EIf <span class="skolem">e1</span> <span class="main">(</span>plug <span class="skolem">C</span> <span class="skolem">e'</span><span class="main">)</span> <span class="skolem">e3</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> e_if_cong<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> CIf2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CIf3 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">C</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"E <span class="main">(</span>EIf <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="main">(</span>plug <span class="skolem">C</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> E <span class="main">(</span>EIf <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="main">(</span>plug <span class="skolem">C</span> <span class="skolem">e'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> e_if_cong<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> CIf3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Auxiliary lemmas"</span></span> 
  
<span class="keyword1" id="DenotCongruenceFSet-diverge_denot_empty"><span class="command">lemma</span></span> diverge_denot_empty<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"diverge <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fve<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="free">e</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"E <span class="free">e</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"E <span class="free">e</span> <span class="main">[]</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> wte<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> E <span class="free">e</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"good_env <span class="main">[]</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> wte ge <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> e_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">⇓</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> gv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> good <span class="skolem">A</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> denot_terminates <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> e_v fve <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> e_vp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⟶*</span> <span class="skolem">v'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> val_vp<span class="main">:</span> <span class="quoted"><span class="quoted">"isval <span class="skolem">v'</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> sound_wrt_small_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> d e_vp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">e'</span><span class="main">.</span> <span class="skolem">v'</span> <span class="main">⟶</span> <span class="bound">e'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diverge_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">with</span></span> val_vp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> val_stuck <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DenotCongruenceFSet-goes_wrong_denot_empty"><span class="command">lemma</span></span> goes_wrong_denot_empty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> gw<span class="main">:</span> <span class="quoted"><span class="quoted">"goes_wrong <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fv_e<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="free">e</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"E <span class="free">e</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"E <span class="free">e</span> <span class="main">[]</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> wte<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> E <span class="free">e</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">have</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"good_env <span class="main">[]</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> gw <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="keyword2"><span class="keyword">where</span></span> e_ep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⟶*</span> <span class="skolem">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s_ep<span class="main">:</span> <span class="quoted"><span class="quoted">"stuck <span class="skolem">e'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nv_ep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> isval <span class="skolem">e'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> wte e_ep <span class="keyword1"><span class="command">have</span></span> wtep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> E <span class="skolem">e'</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> preservation <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> fv_e e_ep <span class="keyword1"><span class="command">have</span></span> fv_ep<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="skolem">e'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduction_pres_fv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> wtep fv_ep <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_val <span class="skolem">e'</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">e''</span><span class="main">.</span> <span class="skolem">e'</span> <span class="main">⟶</span> <span class="bound">e''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> progress<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="skolem">e'</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> this s_ep nv_ep <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1" id="DenotCongruenceFSet-denot_empty_diverge"><span class="command">lemma</span></span> denot_empty_diverge<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> E_e<span class="main">:</span> <span class="quoted"><span class="quoted">"E <span class="free">e</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fv_e<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="free">e</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"diverge <span class="free">e</span> <span class="main">∨</span> goes_wrong <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> nd_gw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>diverge <span class="free">e</span> <span class="main">∨</span> goes_wrong <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> nd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> diverge <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> nd_gw <span class="keyword1"><span class="command">have</span></span> gw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> goes_wrong <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> nd <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span><span class="main">::</span><span class="quoted">exp</span> <span class="keyword2"><span class="keyword">where</span></span> e_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">⟶*</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> stuck<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">e'</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">⟶</span> <span class="bound">e'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> diverge_def<span class="main">)</span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> gw e_v stuck <span class="keyword1"><span class="command">have</span></span> val_v<span class="main">:</span> <span class="quoted"><span class="quoted">"isval <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> goes_wrong_def stuck_def<span class="main">)</span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> fv_e e_v <span class="keyword1"><span class="command">have</span></span> fv_v<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="skolem">v</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduction_pres_fv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> val_v fv_v <span class="keyword1"><span class="command">have</span></span> val_v2<span class="main">:</span> <span class="quoted"><span class="quoted">"is_val <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">from</span></span> e_v val_v2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> wte<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> E <span class="free">e</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wtv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> E <span class="skolem">v</span> <span class="main">[]</span>"</span></span> 
     <span class="keyword1"><span class="command">using</span></span> completeness<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> this E_e <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DenotCongruenceFSet-val_ty_observe"><span class="command">lemma</span></span> val_ty_observe<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span> <span class="main">∈</span> E <span class="free">v</span> <span class="main">[]</span><span class="main">;</span> <span class="free">A</span> <span class="main">∈</span> E <span class="free">v'</span> <span class="main">[]</span><span class="main">;</span>
    observe <span class="free">v</span> <span class="free">ob</span><span class="main">;</span> isval <span class="free">v'</span><span class="main">;</span> isval <span class="free">v</span> <span class="main">⟧</span> <span class="main">⟹</span> observe <span class="free">v'</span> <span class="free">ob</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v'</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">v'</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ob</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Soundness wrt. contextual equivalence"</span></span>

<span class="keyword1" id="DenotCongruenceFSet-soundness_wrt_ctx_equiv_aux"><span class="command">lemma</span></span> soundness_wrt_ctx_equiv_aux<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> e12<span class="main">:</span> <span class="quoted"><span class="quoted">"E <span class="free">e1</span> <span class="main">=</span> E <span class="free">e2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fv_e1<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="main">(</span>plug <span class="free">C</span> <span class="free">e1</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fv_e2<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="main">(</span>plug <span class="free">C</span> <span class="free">e2</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>plug <span class="free">C</span> <span class="free">e1</span><span class="main">)</span> <span class="free">ob</span> <span class="main">⟶</span> run <span class="main">(</span>plug <span class="free">C</span> <span class="free">e2</span><span class="main">)</span> <span class="free">ob</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> run_Ce1<span class="main">:</span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>plug <span class="free">C</span> <span class="free">e1</span><span class="main">)</span> <span class="free">ob</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> e12 <span class="keyword1"><span class="command">have</span></span> pe12<span class="main">:</span> <span class="quoted"><span class="quoted">"E <span class="main">(</span>plug <span class="free">C</span> <span class="free">e1</span><span class="main">)</span> <span class="main">=</span> E <span class="main">(</span>plug <span class="free">C</span> <span class="free">e2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> congruence<span class="main">)</span>   
  <span class="keyword1"><span class="command">from</span></span> run_Ce1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span>plug <span class="free">C</span> <span class="free">e1</span><span class="main">)</span> <span class="main">⟶*</span> <span class="bound">v</span> <span class="main">∧</span> observe <span class="bound">v</span> <span class="free">ob</span><span class="main">)</span> 
             <span class="main">∨</span> <span class="main">(</span><span class="main">(</span>diverge <span class="main">(</span>plug <span class="free">C</span> <span class="free">e1</span><span class="main">)</span> <span class="main">∨</span> goes_wrong <span class="main">(</span>plug <span class="free">C</span> <span class="free">e1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">ob</span> <span class="main">=</span> OBad<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> run_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"run <span class="main">(</span>plug <span class="free">C</span> <span class="free">e2</span><span class="main">)</span> <span class="free">ob</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> plug <span class="free">C</span> <span class="free">e1</span> <span class="main">⟶*</span> <span class="bound">v</span> <span class="main">∧</span> observe <span class="bound">v</span> <span class="free">ob</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> r_v<span class="main">:</span> <span class="quoted"><span class="quoted">"plug <span class="free">C</span> <span class="free">e1</span> <span class="main">⟶*</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ob_v<span class="main">:</span> <span class="quoted"><span class="quoted">"observe <span class="skolem">v</span> <span class="free">ob</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> r_v fv_e1 <span class="keyword1"><span class="command">have</span></span> fv_v<span class="main">:</span> <span class="quoted"><span class="quoted">"FV <span class="skolem">v</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> reduction_pres_fv<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> ob_v fv_v <span class="keyword1"><span class="command">have</span></span> val_v<span class="main">:</span> <span class="quoted"><span class="quoted">"is_val <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">)</span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">from</span></span> r_v val_v <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span>  <span class="keyword2"><span class="keyword">where</span></span> ce1a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> E <span class="main">(</span>plug <span class="free">C</span> <span class="free">e1</span><span class="main">)</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wt_v_ap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> E <span class="skolem">v</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> completeness<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"plug <span class="free">C</span> <span class="free">e1</span>"</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">from</span></span> ce1a pe12 <span class="keyword1"><span class="command">have</span></span> ce2a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> E <span class="main">(</span>plug <span class="free">C</span> <span class="free">e2</span><span class="main">)</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
    <span class="keyword1"><span class="command">have</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"good_env <span class="main">[]</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> ce2a ge <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Ce2_vp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">⊢</span> plug <span class="free">C</span> <span class="free">e2</span> <span class="main">⇓</span> <span class="skolem">v'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vpa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> good <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> denot_terminates <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">from</span></span> Ce2_vp fv_e2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v''</span></span> <span class="skolem"><span class="skolem">ob'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Ce2_vpp<span class="main">:</span> <span class="quoted"><span class="quoted">"plug <span class="free">C</span> <span class="free">e2</span> <span class="main">⟶*</span> <span class="skolem">v''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vvpp<span class="main">:</span> <span class="quoted"><span class="quoted">"isval <span class="skolem">v''</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ovpp<span class="main">:</span> <span class="quoted"><span class="quoted">"observe <span class="skolem">v''</span> <span class="skolem">ob'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vp_ob<span class="main">:</span> <span class="quoted"><span class="quoted">"bs_observe <span class="skolem">v'</span> <span class="skolem">ob'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sound_wrt_small_step<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"plug <span class="free">C</span> <span class="free">e2</span>"</span></span> <span class="quoted"><span class="skolem">v'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> ovpp <span class="keyword1"><span class="command">have</span></span> vpp_ob<span class="main">:</span> <span class="quoted"><span class="quoted">"observe <span class="skolem">v''</span> <span class="free">ob</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> ce2a Ce2_vpp <span class="keyword1"><span class="command">have</span></span> vpp_app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> E <span class="skolem">v''</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> preservation <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">from</span></span> vpp_app wt_v_ap ob_v vvpp val_v
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> val_ty_observe<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span> 
    <span class="keyword1"><span class="command">from</span></span> Ce2_vpp vpp_ob <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> run_def<span class="main">)</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> d_e1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>diverge <span class="main">(</span>plug <span class="free">C</span> <span class="free">e1</span><span class="main">)</span> <span class="main">∨</span> goes_wrong <span class="main">(</span>plug <span class="free">C</span> <span class="free">e1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">ob</span> <span class="main">=</span> OBad"</span></span>
    <span class="keyword1"><span class="command">from</span></span> d_e1 fv_e1 <span class="keyword1"><span class="command">have</span></span> E_Ce1<span class="main">:</span> <span class="quoted"><span class="quoted">"E <span class="main">(</span>plug <span class="free">C</span> <span class="free">e1</span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> diverge_denot_empty goes_wrong_denot_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">from</span></span> E_Ce1 pe12 <span class="keyword1"><span class="command">have</span></span> E_Ce2<span class="main">:</span> <span class="quoted"><span class="quoted">"E <span class="main">(</span>plug <span class="free">C</span> <span class="free">e2</span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">from</span></span> E_Ce2 fv_e2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diverge <span class="main">(</span>plug <span class="free">C</span> <span class="free">e2</span><span class="main">)</span> <span class="main">∨</span> goes_wrong <span class="main">(</span>plug <span class="free">C</span> <span class="free">e2</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> denot_empty_diverge <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">from</span></span> this d_e1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> run_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ctx_equiv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> exp <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≃</span>"</span> 51<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">≃</span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">C</span> <span class="bound">ob</span><span class="main">.</span> FV <span class="main">(</span>plug <span class="bound">C</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> FV <span class="main">(</span>plug <span class="bound">C</span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟶</span>
   run <span class="main">(</span>plug <span class="bound">C</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="bound">ob</span> <span class="main">=</span> run <span class="main">(</span>plug <span class="bound">C</span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span><span class="main">)</span> <span class="bound">ob</span>"</span></span> 

<span class="keyword1"><span class="command">theorem</span></span> denot_sound_wrt_ctx_equiv<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> e12<span class="main">:</span> <span class="quoted"><span class="quoted">"E <span class="free">e1</span> <span class="main">=</span> E <span class="free">e2</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">≃</span> <span class="free">e2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> e12
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ctx_equiv_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> soundness_wrt_ctx_equiv_aux<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> soundness_wrt_ctx_equiv_aux<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DenotEqualitiesFSet">
<div class="head">
<h1>Theory DenotEqualitiesFSet</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Denotational equalities regarding reduction"</span></span> 

<span class="keyword1"><span class="command">theory</span></span> DenotEqualitiesFSet
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="DenotCongruenceFSet.html">DenotCongruenceFSet</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">theorem</span></span> eval_prim<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> e1<span class="main">:</span><span class="quoted"><span class="quoted">"E <span class="free">e1</span> <span class="main">=</span> E <span class="main">(</span>ENat <span class="free">n1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> e2<span class="main">:</span><span class="quoted"><span class="quoted">"E <span class="free">e2</span> <span class="main">=</span> E <span class="main">(</span>ENat <span class="free">n2</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"E<span class="main">(</span>EPrim <span class="free">f</span> <span class="free">e1</span> <span class="free">e2</span><span class="main">)</span><span class="main">=</span>E<span class="main">(</span>ENat <span class="main">(</span><span class="free">f</span> <span class="free">n1</span> <span class="free">n2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> e1 e2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1"><span class="command">theorem</span></span> eval_ifz<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> e1<span class="main">:</span> <span class="quoted"><span class="quoted">"E <span class="free">e1</span>  <span class="main">=</span> E<span class="main">(</span>ENat <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"E<span class="main">(</span>EIf <span class="free">e1</span> <span class="free">e2</span> <span class="free">e3</span><span class="main">)</span> <span class="main">=</span> E<span class="main">(</span><span class="free">e3</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> e1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
 
<span class="keyword1"><span class="command">theorem</span></span> eval_ifnz<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> e1<span class="main">:</span> <span class="quoted"><span class="quoted">"E<span class="main">(</span><span class="free">e1</span><span class="main">)</span> <span class="main">=</span> E<span class="main">(</span>ENat <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"E<span class="main">(</span>EIf <span class="free">e1</span> <span class="free">e2</span> <span class="free">e3</span><span class="main">)</span> <span class="main">=</span> E<span class="main">(</span><span class="free">e2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> e1 nz <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1"><span class="command">theorem</span></span> eval_app_lam<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> vv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_val <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"E<span class="main">(</span>EApp <span class="main">(</span>ELam <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> E <span class="main">(</span>subst <span class="free">x</span> <span class="free">v</span> <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span> 
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"EApp <span class="main">(</span>ELam <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="free">v</span> <span class="main">⟶</span> subst <span class="free">x</span> <span class="free">v</span> <span class="free">e</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> beta<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> vv <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subject_reduction<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"EApp <span class="main">(</span>ELam <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="free">v</span> <span class="main">⟶</span> subst <span class="free">x</span> <span class="free">v</span> <span class="free">e</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> beta<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> vv <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> reverse_step_pres_denot<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Optimizer">
<div class="head">
<h1>Theory Optimizer</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Correctness of an optimizer"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Optimizer
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Lambda.html">Lambda</a> <a href="DenotEqualitiesFSet.html">DenotEqualitiesFSet</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_value</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_value</span> <span class="main">(</span>ENat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_value</span> <span class="main">(</span>ELam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>FV <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">is_value</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1" id="Optimizer-is_value_is_val"><span class="command">lemma</span></span> is_value_is_val<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_value <span class="free">e</span> <span class="main">⟹</span> isval <span class="free">e</span> <span class="main">∧</span> FV <span class="free">e</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">opt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> nat <span class="main">⇒</span> exp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">opt</span> <span class="main">(</span>EVar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> EVar <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">opt</span> <span class="main">(</span>ENat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> ENat <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">opt</span> <span class="main">(</span>ELam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> ELam <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">opt</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">opt</span> <span class="main">(</span>EApp <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> EApp <span class="main">(</span><span class="free">opt</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">opt</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span> 
  <span class="quoted"><span class="quoted">"<span class="free">opt</span> <span class="main">(</span>EApp <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">e1'</span> <span class="main">=</span> <span class="free">opt</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="keyword1">in</span> <span class="keyword1">let</span> <span class="bound">e2'</span> <span class="main">=</span> <span class="free">opt</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
     <span class="main">(</span><span class="keyword1">case</span> <span class="bound">e1'</span> <span class="keyword1">of</span>
        ELam <span class="bound">x</span> <span class="bound">e</span> <span class="main">⇒</span> <span class="keyword1">if</span> is_value <span class="bound">e2'</span> <span class="keyword1">then</span> <span class="free">opt</span> <span class="main">(</span>subst <span class="bound">x</span> <span class="bound">e2'</span> <span class="bound">e</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>
                   <span class="keyword1">else</span> EApp <span class="bound">e1'</span> <span class="bound">e2'</span>
     <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> EApp <span class="bound">e1'</span> <span class="bound">e2'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">opt</span> <span class="main">(</span>EPrim <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">e1'</span> <span class="main">=</span> <span class="free">opt</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">in</span> <span class="keyword1">let</span> <span class="bound">e2'</span> <span class="main">=</span> <span class="free">opt</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="bound">e1'</span><span class="main">,</span> <span class="bound">e2'</span><span class="main">)</span> <span class="keyword1">of</span>
       <span class="main">(</span>ENat <span class="bound">n1</span><span class="main">,</span> ENat <span class="bound">n2</span><span class="main">)</span> <span class="main">⇒</span> ENat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">n1</span> <span class="bound">n2</span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> EPrim <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">e1'</span> <span class="bound">e2'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">opt</span> <span class="main">(</span>EIf <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">e1'</span> <span class="main">=</span> <span class="free">opt</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">in</span> <span class="keyword1">let</span> <span class="bound">e2'</span> <span class="main">=</span> <span class="free">opt</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">in</span> <span class="keyword1">let</span> <span class="bound">e3'</span> <span class="main">=</span> <span class="free">opt</span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="bound">e1'</span> <span class="keyword1">of</span>
      ENat <span class="bound">n</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="bound">e3'</span> <span class="keyword1">else</span> <span class="bound">e2'</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> EIf <span class="bound">e1'</span> <span class="bound">e2'</span> <span class="bound">e3'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Optimizer-opt_correct_aux"><span class="command">lemma</span></span> opt_correct_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"E <span class="free">e</span> <span class="main">=</span> E <span class="main">(</span>opt <span class="free">e</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> opt.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"opt <span class="skolem">e1</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span><span class="main">)</span> 
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x e<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_value <span class="main">(</span>opt <span class="skolem">e2</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>   
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"E <span class="main">(</span>EApp <span class="main">(</span>ELam <span class="improper">x</span> <span class="improper">e</span><span class="main">)</span> <span class="main">(</span>opt <span class="skolem">e2</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                       <span class="main">=</span> E <span class="main">(</span>subst <span class="improper">x</span> <span class="main">(</span>opt <span class="skolem">e2</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="improper">e</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eval_app_lam<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> E.simps<span class="main">)</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"E<span class="main">(</span>EApp <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span> <span class="main">=</span> E<span class="main">(</span>EApp <span class="main">(</span>ELam <span class="improper">x</span> <span class="improper">e</span><span class="main">)</span> <span class="main">(</span>opt <span class="skolem">e2</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> e_app_cong<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">f</span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"opt <span class="skolem">e1</span> <span class="skolem">k</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"opt <span class="skolem">e2</span> <span class="skolem">k</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="skolem">e3</span> <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"opt <span class="skolem">e1</span> <span class="skolem">k</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> opt_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">≃</span> opt <span class="free">e</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> opt_correct_aux denot_sound_wrt_ctx_equiv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SystemF">
<div class="head">
<h1>Theory SystemF</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Semantics and type soundness for System F"</span></span>

<span class="keyword1"><span class="command">theory</span></span> SystemF
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="../../HOL/HOL-Library/FSet.html">HOL-Library.FSet</a>"</span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Syntax and values"</span></span>
  
<span class="keyword1"><span class="command">type_synonym</span></span> name <span class="main">=</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">datatype</span></span> ty <span class="main">=</span> TVar <span class="quoted">nat</span> <span class="main">|</span> TNat <span class="main">|</span> Fun <span class="quoted">ty</span> <span class="quoted">ty</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">→</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 60<span class="main">)</span> <span class="main">|</span> Forall <span class="quoted">ty</span> 

<span class="keyword1"><span class="command">datatype</span></span> exp <span class="main">=</span> EVar <span class="quoted">name</span> <span class="main">|</span> ENat <span class="quoted">nat</span> <span class="main">|</span> ELam <span class="quoted">ty</span> <span class="quoted">exp</span> <span class="main">|</span> EApp <span class="quoted">exp</span> <span class="quoted">exp</span>
  <span class="main">|</span> EAbs <span class="quoted">exp</span>  <span class="main">|</span> EInst <span class="quoted">exp</span> <span class="quoted">ty</span> <span class="main">|</span> EFix <span class="quoted">ty</span> <span class="quoted">exp</span> 

<span class="keyword1"><span class="command">datatype</span></span> val <span class="main">=</span> VNat <span class="quoted">nat</span> <span class="main">|</span> Fun <span class="quoted"><span class="quoted">"<span class="main">(</span>val <span class="main">×</span> val<span class="main">)</span> fset"</span></span> <span class="main">|</span> Abs <span class="quoted"><span class="quoted">"val option"</span></span> <span class="main">|</span> Wrong

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">val_le</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> val <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊑</span>"</span> 52<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>VNat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊑</span></span> <span class="main">(</span>VNat <span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊑</span></span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fset <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⊆</span> fset <span class="free"><span class="bound"><span class="entity">f'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Abs None<span class="main">)</span> <span class="main"><span class="free">⊑</span></span> <span class="main">(</span>Abs None<span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"Abs <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊑</span></span> Abs <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">v'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main"><span class="free">⊑</span></span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"Wrong <span class="main"><span class="free">⊑</span></span> Wrong <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">::</span>val<span class="main">)</span> <span class="main"><span class="free">⊑</span></span> <span class="free"><span class="bound"><span class="entity">v'</span></span></span> <span class="main">=</span> False"</span></span>  

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Set monad"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">set_bind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">set_bind</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="bound">v</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">v'</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">v'</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> set_bind_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_set_bind"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>pttrns<span class="main">,</span><span class="tfree">'a</span> set<span class="main">,</span><span class="tfree">'b</span><span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_ <span class="keyword1">←</span> _<span class="keyword1">;</span><span class="keyword3">//</span>_<span class="keyword3">)</span>"</span> 0<span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="free">P</span> <span class="main">←</span> <span class="free">E</span><span class="main">;</span> <span class="free">F</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> set_bind <span class="free">E</span> <span class="main">(</span><span class="main">λ</span><span class="free">P</span><span class="main">.</span> <span class="free">F</span><span class="main">)</span>"</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">errset_bind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val set <span class="main">⇒</span> <span class="main">(</span>val <span class="main">⇒</span> val set<span class="main">)</span> <span class="main">⇒</span> val set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">errset_bind</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="bound">v</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">v'</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∧</span> <span class="bound">v'</span> <span class="main">≠</span> Wrong <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">v'</span> <span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">=</span> Wrong <span class="main">∧</span> Wrong <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> errset_bind_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_errset_bind"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>pttrns<span class="main">,</span>val set<span class="main">,</span>val<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_ <span class="keyword1">:=</span> _<span class="keyword1">;</span><span class="keyword3">//</span>_<span class="keyword3">)</span>"</span> 0<span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="free">P</span> <span class="main">:=</span> <span class="free">E</span><span class="main">;</span> <span class="free">F</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> errset_bind <span class="free">E</span> <span class="main">(</span><span class="main">λ</span><span class="free">P</span><span class="main">.</span> <span class="free">F</span><span class="main">)</span>"</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">return</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> val set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">return</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">v'</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> return_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Denotational semantics"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> tyenv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>val set<span class="main">)</span> list"</span></span> 
<span class="keyword1"><span class="command">type_synonym</span></span> env <span class="main">=</span> <span class="quoted"><span class="quoted">"val list"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">iterate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>env <span class="main">⇒</span> val set<span class="main">)</span> <span class="main">⇒</span> env <span class="main">⇒</span> val <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  iterate_none<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">iterate</span> <span class="free"><span class="bound"><span class="entity">Ee</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">(</span>Fun <span class="main">{||}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  iterate_again<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">iterate</span> <span class="free"><span class="bound"><span class="entity">Ee</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Ee</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">iterate</span> <span class="free"><span class="bound"><span class="entity">Ee</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="free"><span class="bound"><span class="entity">f'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">apply_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val set <span class="main">⇒</span> val set <span class="main">⇒</span> val set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">apply_fun</span> <span class="free"><span class="bound"><span class="entity">V1</span></span></span> <span class="free"><span class="bound"><span class="entity">V2</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="bound">v1</span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">V1</span></span></span><span class="main">;</span> <span class="bound">v2</span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">V2</span></span></span><span class="main">;</span>
                       <span class="keyword1">case</span> <span class="bound">v1</span> <span class="keyword1">of</span> Fun <span class="bound">f</span> <span class="main">⇒</span> 
                          <span class="main">(</span><span class="bound">v2'</span><span class="main">,</span><span class="bound">v3'</span><span class="main">)</span> <span class="main">←</span> fset <span class="bound">f</span><span class="main">;</span>
                          <span class="keyword1">if</span> <span class="bound">v2'</span> <span class="main">⊑</span> <span class="bound">v2</span> <span class="keyword1">then</span> return <span class="bound">v3'</span> <span class="keyword1">else</span> <span class="main">{}</span>
                       <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> return Wrong<span class="main">)</span>"</span></span>  

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">E</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> env <span class="main">⇒</span> val set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  Enat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>ENat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> return <span class="main">(</span>VNat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  Evar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>EVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  Elam<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>ELam <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">v</span> <span class="main">=</span> Fun <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v1</span> <span class="bound">v2'</span><span class="main">.</span> <span class="main">(</span><span class="bound">v1</span><span class="main">,</span><span class="bound">v2'</span><span class="main">)</span> <span class="main">∈</span> fset <span class="bound">f</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∃</span> <span class="bound">v2</span><span class="main">.</span> <span class="bound">v2</span> <span class="main">∈</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="bound">v1</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="bound">v2'</span> <span class="main">⊑</span> <span class="bound">v2</span><span class="main">)</span><span class="main">)</span> <span class="main">}</span>"</span></span> <span class="main">|</span>
  Eapp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>EApp <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> apply_fun <span class="main">(</span><span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  Efix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>EFix <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">{</span> <span class="bound">v</span><span class="main">.</span> iterate <span class="main">(</span><span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="bound">v</span> <span class="main">}</span>"</span></span> <span class="main">|</span> 
  Eabs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>EAbs <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">v'</span><span class="main">.</span> <span class="bound">v</span> <span class="main">=</span> Abs <span class="main">(</span>Some <span class="bound">v'</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">v'</span> <span class="main">∈</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span> 
                               <span class="main">∨</span> <span class="main">(</span><span class="bound">v</span> <span class="main">=</span> Abs None <span class="main">∧</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="main">}</span>"</span></span> <span class="main">|</span> 
  Einst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>EInst <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> 
       <span class="main">(</span><span class="bound">v</span> <span class="main">:=</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">;</span>
        <span class="keyword1">case</span> <span class="bound">v</span> <span class="keyword1">of</span>
          Abs None <span class="main">⇒</span> <span class="main">{}</span>
        <span class="main">|</span> Abs <span class="main">(</span>Some <span class="bound">v'</span><span class="main">)</span> <span class="main">⇒</span> return <span class="bound">v'</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> return Wrong<span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Types: substitution and semantics"</span></span>
  
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">shift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> ty <span class="main">⇒</span> ty"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">shift</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> TNat <span class="main">=</span> TNat"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">shift</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>TVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> TVar <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="keyword1">else</span> TVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">shift</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">shift</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">shift</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">shift</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Forall <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="main">=</span> Forall <span class="main">(</span><span class="free">shift</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> ty <span class="main">⇒</span> ty <span class="main">⇒</span> ty"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> TNat <span class="main">=</span> TNat"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">(</span>TVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span>
                         <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> TVar <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> 
                         <span class="keyword1">else</span> TVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">(</span>Forall <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="main">=</span> Forall <span class="main">(</span><span class="free">subst</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span>shift <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">T</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ty <span class="main">⇒</span> tyenv <span class="main">⇒</span> val set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 Tnat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> TNat <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">v</span> <span class="main">=</span> VNat <span class="bound">n</span> <span class="main">}</span>"</span></span> <span class="main">|</span>
 Tvar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">(</span>TVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="keyword1">then</span>
                         <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">v'</span><span class="main">.</span> <span class="bound">v'</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">⊑</span> <span class="bound">v'</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">≠</span> Wrong<span class="main">}</span>
                        <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
 Tfun<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">v</span> <span class="main">=</span> Fun <span class="bound">f</span> <span class="main">∧</span> 
                        <span class="main">(</span><span class="main">∀</span> <span class="bound">v1</span> <span class="bound">v2'</span><span class="main">.</span><span class="main">(</span><span class="bound">v1</span><span class="main">,</span><span class="bound">v2'</span><span class="main">)</span><span class="main">∈</span>fset <span class="bound">f</span> <span class="main">⟶</span>
                          <span class="bound">v1</span><span class="main">∈</span><span class="free">T</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">⟶</span><span class="main">(</span><span class="main">∃</span> <span class="bound">v2</span><span class="main">.</span> <span class="bound">v2</span> <span class="main">∈</span> <span class="free">T</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">∧</span> <span class="bound">v2'</span> <span class="main">⊑</span> <span class="bound">v2</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">|</span>
 Tall<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">(</span>Forall <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v'</span><span class="main">.</span> <span class="bound">v</span> <span class="main">=</span> Abs <span class="main">(</span>Some <span class="bound">v'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">V</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">∈</span> <span class="free">T</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">(</span><span class="bound">V</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                           <span class="main">∨</span> <span class="bound">v</span> <span class="main">=</span> Abs None <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Type system"</span></span>
  
<span class="keyword1"><span class="command">type_synonym</span></span> tyctx <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ty <span class="main">×</span> nat<span class="main">)</span> list <span class="main">×</span> nat"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_tyvar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tyctx <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_tyvar</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> snd <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">push_ty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ty <span class="main">⇒</span> tyctx <span class="main">⇒</span> tyctx"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">push_ty</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">,</span>snd <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">#</span> fst <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> snd <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">push_tyvar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tyctx <span class="main">⇒</span> tyctx"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">push_tyvar</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">≡</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">,</span> Suc <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">good_ctx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tyctx <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">good_ctx</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">≡</span> <span class="main">∀</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">⟶</span> snd <span class="main">(</span><span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="main">!</span> <span class="bound">n</span><span class="main">)</span> <span class="main">≤</span> snd <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tyctx <span class="main">⇒</span> nat <span class="main">⇒</span> ty option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lookup</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
                    <span class="keyword1">let</span> <span class="bound">k</span> <span class="main">=</span> snd <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">-</span> snd <span class="main">(</span><span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
                    Some <span class="main">(</span>shift <span class="bound">k</span> <span class="main">0</span> <span class="main">(</span>fst <span class="main">(</span><span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                  <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">well_typed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tyctx <span class="main">⇒</span> exp <span class="main">⇒</span> ty <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">:</span> _"</span> <span class="main">[</span>55<span class="main">,</span>55<span class="main">,</span>55<span class="main">]</span> 54<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  wtnat<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> ENat <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">:</span></span> TNat"</span></span> <span class="main">|</span>
  wtvar<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> lookup <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> EVar <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span> <span class="main">|</span>
  wtapp<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> EApp <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span> <span class="main">|</span>
  wtlam<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> push_ty <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> ELam <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span> <span class="main">|</span>
  wtfix<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> push_ty <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">→</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">→</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> EFix <span class="main">(</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span> <span class="main">|</span>
  wtabs<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> push_tyvar <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> EAbs <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> Forall <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span> <span class="main">|</span>
  wtinst<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="free">:</span></span> Forall <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> EInst <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main"><span class="free">:</span></span> <span class="main">(</span>subst <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">wfenv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"env <span class="main">⇒</span> tyenv <span class="main">⇒</span> tyctx <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊢</span> _<span class="keyword1">,</span>_ <span class="keyword1">:</span> _"</span> <span class="main">[</span>55<span class="main">,</span>55<span class="main">,</span>55<span class="main">]</span> 54<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  wfnil<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊢</span></span> <span class="main">[]</span><span class="main"><span class="free">,</span></span><span class="main">[]</span> <span class="main"><span class="free">:</span></span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  wfvbind<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∈</span> T <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main"><span class="free">⊢</span></span>  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="main"><span class="free">:</span></span> push_ty <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>"</span></span> <span class="main">|</span>
  wftbind<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main"><span class="free">,</span></span><span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main"><span class="free">,</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">η</span></span></span><span class="main">)</span> <span class="main"><span class="free">:</span></span> push_tyvar <span class="free"><span class="bound"><span class="entity">Γ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span>
  wtnat_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> ENat <span class="free">n</span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  wtvar_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> EVar <span class="free">n</span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  wtapp_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> EApp <span class="free">e</span> <span class="free">e'</span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  wtlam_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> ELam <span class="free">σ</span> <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  wtfix_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> EFix <span class="free">σ</span> <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  wtabs_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> EAbs <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  wtinst_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> EInst <span class="free">e</span> <span class="free">σ</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>

<span class="keyword1" id="SystemF-wfenv_good_ctx"><span class="command">lemma</span></span> wfenv_good_ctx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">ρ</span><span class="main">,</span><span class="free">η</span> <span class="main">:</span> <span class="free">Γ</span> <span class="main">⟹</span> good_ctx <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wfenv.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> wfnil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_ctx_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wfvbind <span class="skolem">ρ</span> <span class="skolem">η</span> <span class="skolem">Γ</span> <span class="skolem">v</span> <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> good_ctx_def push_ty_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Γ</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> n<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">n</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wftbind <span class="skolem">ρ</span> <span class="skolem">η</span> <span class="skolem">Γ</span> <span class="skolem">V</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> good_ctx_def push_tyvar_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Γ</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> n<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">n</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Well-typed Programs don't go wrong"</span></span>

<span class="keyword1" id="SystemF-nth_append1"><span class="command">lemma</span></span> nth_append1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">ρ1</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ρ1</span><span class="main">@</span><span class="free">ρ2</span><span class="main">)</span><span class="main">!</span><span class="free">n</span> <span class="main">=</span> <span class="free">ρ1</span><span class="main">!</span><span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ρ1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ρ2</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">ρ1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SystemF-nth_append2"><span class="command">lemma</span></span> nth_append2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> length <span class="free">ρ1</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">ρ1</span><span class="main">@</span><span class="free">ρ2</span><span class="main">)</span><span class="main">!</span><span class="free">n</span> <span class="main">=</span> <span class="free">ρ2</span><span class="main">!</span><span class="main">(</span><span class="free">n</span> <span class="main">-</span> length <span class="free">ρ1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ρ1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ρ2</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">ρ1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SystemF-shift_append_preserves_T_aux"><span class="command">lemma</span></span> shift_append_preserves_T_aux<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"T <span class="free">τ</span> <span class="main">(</span><span class="free">ρ1</span><span class="main">@</span><span class="free">ρ3</span><span class="main">)</span> <span class="main">=</span> T <span class="main">(</span>shift <span class="main">(</span>length <span class="free">ρ2</span><span class="main">)</span> <span class="main">(</span>length <span class="free">ρ1</span><span class="main">)</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span><span class="free">ρ1</span><span class="main">@</span><span class="free">ρ2</span><span class="main">@</span><span class="free">ρ3</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ρ1</span></span> <span class="quoted"><span class="free">ρ2</span></span> <span class="quoted"><span class="free">ρ3</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Forall <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mem_Collect_eq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x v'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">v'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> V<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">V</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"T <span class="skolem">τ</span> <span class="main">(</span><span class="main">(</span><span class="improper">V</span><span class="main">#</span><span class="skolem">ρ1</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ρ3</span><span class="main">)</span> <span class="main">=</span>
       T <span class="main">(</span>shift <span class="main">(</span>length <span class="skolem">ρ2</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span><span class="improper">V</span><span class="main">#</span><span class="skolem">ρ1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="improper">V</span><span class="main">#</span><span class="skolem">ρ1</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ρ2</span> <span class="main">@</span> <span class="skolem">ρ3</span><span class="main">)</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mem_Collect_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> x v'<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">v'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> V<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">V</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"T <span class="skolem">τ</span> <span class="main">(</span><span class="main">(</span><span class="improper">V</span><span class="main">#</span><span class="skolem">ρ1</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ρ3</span><span class="main">)</span> <span class="main">=</span>
       T <span class="main">(</span>shift <span class="main">(</span>length <span class="skolem">ρ2</span><span class="main">)</span> <span class="main">(</span>length <span class="main">(</span><span class="improper">V</span><span class="main">#</span><span class="skolem">ρ1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="improper">V</span><span class="main">#</span><span class="skolem">ρ1</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">ρ2</span> <span class="main">@</span> <span class="skolem">ρ3</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
    
<span class="keyword1" id="SystemF-shift_append_preserves_T"><span class="command">lemma</span></span> shift_append_preserves_T<span class="main">:</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"T <span class="free">τ</span> <span class="free">ρ3</span> <span class="main">=</span> T <span class="main">(</span>shift <span class="main">(</span>length <span class="free">ρ2</span><span class="main">)</span> <span class="main">0</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span><span class="free">ρ2</span><span class="main">@</span><span class="free">ρ3</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> shift_append_preserves_T_aux<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">τ</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="free">ρ3</span></span> <span class="quoted"><span class="free">ρ2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="SystemF-drop_shift_preserves_T"><span class="command">lemma</span></span> drop_shift_preserves_T<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="free">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"T <span class="free">τ</span> <span class="main">(</span>drop <span class="free">k</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">=</span> T <span class="main">(</span>shift <span class="free">k</span> <span class="main">0</span> <span class="free">τ</span><span class="main">)</span> <span class="free">ρ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="free">k</span> <span class="free">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?r3</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"drop <span class="free">k</span> <span class="free">ρ</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"T <span class="free">τ</span> <span class="main">(</span><span class="var">?r3</span><span class="main">)</span> <span class="main">=</span> T <span class="main">(</span>shift <span class="main">(</span>length <span class="var">?r2</span><span class="main">)</span> <span class="main">0</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span><span class="var">?r2</span><span class="main">@</span><span class="var">?r3</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> shift_append_preserves_T_aux<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">τ</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?r3</span></span></span> <span class="var"><span class="quoted"><span class="var">?r2</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?r2</span><span class="main">@</span><span class="var">?r3</span> <span class="main">=</span> <span class="free">ρ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> k <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?r2</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">from</span></span> 1 2 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SystemF-shift_cons_preserves_T"><span class="command">lemma</span></span> shift_cons_preserves_T<span class="main">:</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"T <span class="free">τ</span> <span class="free">ρ</span> <span class="main">=</span> T <span class="main">(</span>shift <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> drop_shift_preserves_T<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">#</span><span class="free">ρ</span>"</span></span> <span class="quoted"><span class="free">τ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    
<span class="keyword1" id="SystemF-compose_shift"><span class="command">lemma</span></span> compose_shift<span class="main">:</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"shift <span class="main">(</span><span class="free">j</span><span class="main">+</span><span class="free">k</span><span class="main">)</span> <span class="free">c</span> <span class="free">τ</span> <span class="main">=</span> shift <span class="free">j</span> <span class="free">c</span> <span class="main">(</span>shift <span class="free">k</span> <span class="free">c</span> <span class="free">τ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">auto</span>
    
<span class="keyword1" id="SystemF-shift_zero_id"><span class="command">lemma</span></span> shift_zero_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"shift <span class="main">0</span> <span class="free">c</span> <span class="free">τ</span> <span class="main">=</span> <span class="free">τ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">auto</span> 
    
<span class="keyword1" id="SystemF-lookup_wfenv"><span class="command">lemma</span></span> lookup_wfenv<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> r_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">ρ</span><span class="main">,</span><span class="free">η</span> <span class="main">:</span> <span class="free">Γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ln<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="free">Γ</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="free">ρ</span><span class="main">!</span><span class="free">n</span> <span class="main">=</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> T <span class="free">τ</span> <span class="free">η</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_g ln
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ρ</span></span> <span class="quoted"><span class="free">η</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wfenv.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> wfnil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lookup_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wfvbind <span class="skolem">ρ</span> <span class="skolem">η</span> <span class="skolem">Γ</span> <span class="skolem">v</span> <span class="skolem">τ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> wfvbind<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> vtp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> T <span class="skolem">τ'</span> <span class="skolem">η</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">from</span></span> 0 wfvbind<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">=</span>  shift <span class="main">0</span> <span class="main">0</span> <span class="skolem">τ'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lookup_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> push_ty_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">from</span></span> 0 vtp t <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"push_ty <span class="skolem">τ'</span> <span class="skolem">Γ</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> wfvbind<span class="main">(</span>4<span class="main">)</span> Suc <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> gnp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="skolem">Γ</span><span class="main">)</span><span class="main">!</span><span class="skolem">n'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">,</span><span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">=</span> shift <span class="main">(</span>snd <span class="skolem">Γ</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">0</span> <span class="skolem">σ</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> npg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lookup_def push_ty_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="skolem">Γ</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">Γ</span> <span class="main">!</span> <span class="skolem">n'</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>  
    <span class="keyword1"><span class="command">from</span></span> gnp Suc npg t <span class="keyword1"><span class="command">have</span></span> ln<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="skolem">Γ</span> <span class="skolem">n'</span> <span class="main">=</span> Some <span class="skolem">τ</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lookup_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">from</span></span> wfvbind<span class="main">(</span>3<span class="main">)</span> ln <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> rnp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span><span class="main">!</span><span class="skolem">n'</span> <span class="main">=</span> <span class="skolem">v'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> T <span class="skolem">τ</span> <span class="skolem">η</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> Suc rnp vt <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wftbind <span class="skolem">ρ</span> <span class="skolem">η</span> <span class="skolem">Γ</span> <span class="skolem">V</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">Γ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">Γ</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">=</span> fst <span class="main">(</span>fst <span class="skolem">Γ</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> snd <span class="main">(</span>fst <span class="skolem">Γ</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> wftbind<span class="main">(</span>3<span class="main">)</span> s k <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">=</span> shift <span class="main">(</span>Suc <span class="var">?b</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">0</span> <span class="skolem">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="main">(</span>fst <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> push_tyvar_def lookup_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">n</span></span> <span class="main"><span class="main">&lt;</span></span> length <span class="main"><span class="main">(</span></span>fst <span class="skolem"><span class="skolem">Γ</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"shift <span class="main">(</span><span class="var">?b</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span>fst <span class="main">(</span><span class="var">?a</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> wftbind<span class="main">(</span>3<span class="main">)</span> k <span class="keyword1"><span class="command">have</span></span> ln<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="skolem">Γ</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="var">?t</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> push_tyvar_def lookup_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Γ</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> k' G<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="improper">k'</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">from</span></span> wftbind<span class="main">(</span>2<span class="main">)</span> ln <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> rn_vp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">v'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vp_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> T <span class="var">?t</span> <span class="skolem">η</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> vp_t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> T <span class="main">(</span>shift <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="var">?t</span><span class="main">)</span> <span class="main">(</span><span class="skolem">V</span> <span class="main">#</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> shift_cons_preserves_T <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">hence</span></span> vp_t2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> T <span class="main">(</span>shift <span class="main">(</span>Suc <span class="main">0</span> <span class="main">+</span> <span class="main">(</span><span class="var">?b</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span>fst <span class="main">(</span><span class="var">?a</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">V</span> <span class="main">#</span> <span class="skolem">η</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> compose_shift<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">-</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?a</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> wftbind<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"good_ctx <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wfenv_good_ctx <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> this k nl <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">≥</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> good_ctx_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">+</span> <span class="main">(</span><span class="var">?b</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> Suc <span class="var">?b</span> <span class="main">-</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> this vp_t2 <span class="keyword1"><span class="command">have</span></span> vp_t3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> T <span class="main">(</span>shift <span class="main">(</span>Suc <span class="var">?b</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span>fst <span class="main">(</span><span class="var">?a</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">V</span> <span class="main">#</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> rn_vp vp_t3 t s <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SystemF-less_wrong"><span class="command">lemma</span></span> less_wrong<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v</span> <span class="main">⊑</span> Wrong<span class="main">;</span> <span class="free">v</span> <span class="main">=</span> Wrong <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="SystemF-less_nat"><span class="command">lemma</span></span> less_nat<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v</span> <span class="main">⊑</span> VNat <span class="free">n</span><span class="main">;</span> <span class="free">v</span> <span class="main">=</span> VNat <span class="free">n</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="operator">auto</span> 
    
<span class="keyword1" id="SystemF-less_fun"><span class="command">lemma</span></span> less_fun<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v</span> <span class="main">⊑</span> Fun <span class="free">f</span><span class="main">;</span> <span class="main">⋀</span> <span class="bound">f'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">v</span> <span class="main">=</span> Fun <span class="bound">f'</span><span class="main">;</span> fset <span class="bound">f'</span> <span class="main">⊆</span> fset <span class="free">f</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="operator">auto</span>
    
<span class="keyword1" id="SystemF-less_refl"><span class="command">lemma</span></span> less_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⊑</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">v'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v'</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  
<span class="keyword1" id="SystemF-less_trans"><span class="command">lemma</span></span> less_trans<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v1</span><span class="main">::</span><span class="quoted">val</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">v2</span><span class="main">::</span><span class="quoted">val</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">v3</span><span class="main">::</span><span class="quoted">val</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v1</span> <span class="main">⊑</span> <span class="free">v2</span><span class="main">;</span> <span class="free">v2</span> <span class="main">⊑</span> <span class="free">v3</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">v1</span> <span class="main">⊑</span> <span class="free">v3</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">v2</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v1</span></span> <span class="quoted"><span class="free">v3</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>VNat <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v1</span></span><span class="main">)</span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v1</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v3</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Abs <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v1</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">v3</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> v' v3'<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">v'</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">v3'</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">v'</span></span><span class="main">)</span> 
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Wrong
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1" id="SystemF-T_down_closed"><span class="command">lemma</span></span> T_down_closed<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> vt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> T <span class="free">τ</span> <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vp_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v'</span> <span class="main">⊑</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v'</span> <span class="main">∈</span> T <span class="free">τ</span> <span class="free">η</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> vt vp_v
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">v'</span></span> <span class="quoted"><span class="free">η</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>TVar <span class="skolem">x</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="skolem">η</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> length <span class="skolem">η</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">v'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> less_trans<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">v'</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> TNat
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">τ1</span> <span class="skolem">τ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">f'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Forall <span class="skolem">τ</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="skolem">η</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">v'</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> v''<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">v''</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">V</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">v'</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1" id="SystemF-wrong_not_in_T"><span class="command">lemma</span></span> wrong_not_in_T<span class="main">:</span> <span class="quoted"><span class="quoted">"Wrong <span class="main">∉</span> T <span class="free">τ</span> <span class="free">η</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">τ</span></span><span class="main">)</span> <span class="operator">auto</span>
    
<span class="keyword1" id="SystemF-fun_app"><span class="command">lemma</span></span> fun_app<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> vmn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> T <span class="main">(</span><span class="free">m</span> <span class="main">→</span> <span class="free">n</span><span class="main">)</span> <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v2s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V'</span> <span class="main">⊆</span> T <span class="free">m</span> <span class="free">η</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"apply_fun <span class="free">V</span> <span class="free">V'</span> <span class="main">⊆</span> T <span class="free">n</span> <span class="free">η</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> vmn v2s <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command">using</span></span> wrong_not_in_T <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> v''<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">v'</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> v1 v2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">v1</span> <span class="main">⊑</span> <span class="improper">v''</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v1</span> <span class="bound">v2'</span><span class="main">.</span>
                <span class="main">(</span><span class="bound">v1</span><span class="main">,</span> <span class="bound">v2'</span><span class="main">)</span> <span class="main">∈</span> fset <span class="improper">x2</span> <span class="main">⟶</span> <span class="bound">v1</span> <span class="main">∈</span> T <span class="free">m</span> <span class="free">η</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v2</span><span class="main">.</span> <span class="bound">v2</span> <span class="main">∈</span> T <span class="free">n</span> <span class="free">η</span> <span class="main">∧</span> <span class="bound">v2'</span> <span class="main">⊑</span> <span class="bound">v2</span><span class="main">)</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> v1 v2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">v1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">v2</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> impE<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> T_down_closed <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>  <span class="keyword1"><span class="command">using</span></span> T_down_closed <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>   
    
<span class="keyword1" id="SystemF-T_eta"><span class="command">lemma</span></span> T_eta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v'</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">∈</span> T <span class="free">σ</span> <span class="main">(</span><span class="free">η</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">⊑</span> <span class="bound">v'</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">≠</span> Wrong<span class="main">}</span> <span class="main">=</span> T <span class="free">σ</span> <span class="free">η</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">using</span></span> T_down_closed <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> v<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">v</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> wrong_not_in_T <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
   
<span class="keyword1" id="SystemF-compositionality"><span class="command">lemma</span></span> compositionality<span class="main">:</span> <span class="quoted"><span class="quoted">"T <span class="free">τ</span> <span class="main">(</span><span class="free">η1</span> <span class="main">@</span> <span class="main">(</span>T <span class="free">σ</span> <span class="main">(</span><span class="free">η1</span><span class="main">@</span><span class="free">η2</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="free">η2</span><span class="main">)</span> <span class="main">=</span> T <span class="main">(</span>subst <span class="main">(</span>length <span class="free">η1</span><span class="main">)</span> <span class="free">σ</span> <span class="free">τ</span><span class="main">)</span> <span class="main">(</span><span class="free">η1</span><span class="main">@</span><span class="free">η2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">η1</span></span> <span class="quoted"><span class="free">η2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>TVar <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"length <span class="skolem">η1</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">using</span></span> T_eta <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"length <span class="skolem">η1</span> <span class="main">&lt;</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">x'</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> Suc <span class="bound">x'</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> 
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> TNat
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Fun <span class="skolem">τ1</span> <span class="skolem">τ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Forall <span class="skolem">τ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"T <span class="main">(</span>Forall <span class="skolem">τ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">η1</span> <span class="main">@</span> T <span class="skolem">σ</span> <span class="main">(</span><span class="skolem">η1</span> <span class="main">@</span> <span class="skolem">η2</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">η2</span><span class="main">)</span> <span class="main">=</span>
        T <span class="main">(</span>subst <span class="main">(</span>length <span class="skolem">η1</span><span class="main">)</span> <span class="skolem">σ</span> <span class="main">(</span>Forall <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">η1</span> <span class="main">@</span> <span class="skolem">η2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mem_Collect_eq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">v'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">V</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mem_Collect_eq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">v'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">V</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">v'</span> <span class="skolem">V</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">η1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?R1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span><span class="main">#</span><span class="skolem">η1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"shift <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> T <span class="skolem">τ</span> <span class="main">(</span><span class="skolem">V</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">η1</span> <span class="main">@</span> T <span class="skolem">σ</span> <span class="main">(</span><span class="skolem">η1</span> <span class="main">@</span> <span class="skolem">η2</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">η2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> T <span class="skolem">τ</span> <span class="main">(</span><span class="var">?R1</span> <span class="main">@</span> T <span class="skolem">σ</span> <span class="main">(</span><span class="skolem">η1</span><span class="main">@</span><span class="skolem">η2</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">η2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        
    <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"T <span class="skolem">σ</span> <span class="main">(</span><span class="skolem">η1</span><span class="main">@</span><span class="skolem">η2</span><span class="main">)</span> <span class="main">=</span> T <span class="var">?s</span> <span class="main">(</span><span class="skolem">V</span><span class="main">#</span><span class="main">(</span><span class="skolem">η1</span><span class="main">@</span><span class="skolem">η2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> shift_cons_preserves_T<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> a b <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> T <span class="skolem">τ</span> <span class="main">(</span><span class="var">?R1</span> <span class="main">@</span> T <span class="var">?s</span> <span class="main">(</span><span class="var">?R1</span> <span class="main">@</span> <span class="skolem">η2</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">η2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> Forall<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?R1</span></span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="quoted"><span class="skolem">η2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"T <span class="skolem">τ</span> <span class="main">(</span><span class="var">?R1</span> <span class="main">@</span> T <span class="var">?s</span> <span class="main">(</span><span class="var">?R1</span> <span class="main">@</span> <span class="skolem">η2</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">η2</span><span class="main">)</span> <span class="main">=</span>
                                  T <span class="main">(</span>subst <span class="main">(</span>length <span class="var">?R1</span><span class="main">)</span> <span class="var">?s</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">(</span><span class="var">?R1</span> <span class="main">@</span> <span class="skolem">η2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> c 2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> T <span class="main">(</span>subst <span class="main">(</span>Suc <span class="var">?L1</span><span class="main">)</span> <span class="var">?s</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">V</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">η1</span> <span class="main">@</span> <span class="skolem">η2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">v'</span> <span class="skolem">V</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">η1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?R1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span><span class="main">#</span><span class="skolem">η1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"shift <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> T <span class="main">(</span>subst <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">η1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>shift <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">0</span> <span class="skolem">σ</span><span class="main">)</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">V</span> <span class="main">#</span> <span class="skolem">η1</span> <span class="main">@</span> <span class="skolem">η2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> Forall<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?R1</span></span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="quoted"><span class="skolem">η2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"T <span class="skolem">τ</span> <span class="main">(</span><span class="var">?R1</span> <span class="main">@</span> T <span class="var">?s</span> <span class="main">(</span><span class="var">?R1</span> <span class="main">@</span> <span class="skolem">η2</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">η2</span><span class="main">)</span> <span class="main">=</span>
                                  T <span class="main">(</span>subst <span class="main">(</span>length <span class="var">?R1</span><span class="main">)</span> <span class="var">?s</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">(</span><span class="var">?R1</span> <span class="main">@</span> <span class="skolem">η2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> T <span class="skolem">τ</span> <span class="main">(</span><span class="var">?R1</span> <span class="main">@</span> T <span class="var">?s</span> <span class="main">(</span><span class="var">?R1</span> <span class="main">@</span> <span class="skolem">η2</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">η2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"T <span class="skolem">σ</span> <span class="main">(</span><span class="skolem">η1</span><span class="main">@</span><span class="skolem">η2</span><span class="main">)</span> <span class="main">=</span> T <span class="var">?s</span> <span class="main">(</span><span class="skolem">V</span><span class="main">#</span><span class="main">(</span><span class="skolem">η1</span><span class="main">@</span><span class="skolem">η2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> shift_cons_preserves_T<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> 3 b <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> T <span class="skolem">τ</span> <span class="main">(</span><span class="var">?R1</span> <span class="main">@</span> T <span class="skolem">σ</span> <span class="main">(</span><span class="skolem">η1</span><span class="main">@</span><span class="skolem">η2</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">η2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> T <span class="skolem">τ</span> <span class="main">(</span><span class="skolem">V</span> <span class="main">#</span> <span class="skolem">η1</span> <span class="main">@</span> T <span class="skolem">σ</span> <span class="main">(</span><span class="skolem">η1</span> <span class="main">@</span> <span class="skolem">η2</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">η2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SystemF-iterate_sound"><span class="command">lemma</span></span> iterate_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> it<span class="main">:</span> <span class="quoted"><span class="quoted">"iterate <span class="free">Ee</span> <span class="free">ρ</span> <span class="free">v</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> T <span class="main">(</span><span class="free">σ</span><span class="main">→</span><span class="free">τ</span><span class="main">)</span> <span class="free">η</span> <span class="main">⟶</span> <span class="free">Ee</span> <span class="main">(</span><span class="bound">v</span><span class="main">#</span><span class="free">ρ</span><span class="main">)</span> <span class="main">⊆</span> T <span class="main">(</span><span class="free">σ</span><span class="main">→</span><span class="free">τ</span><span class="main">)</span> <span class="free">η</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> T <span class="main">(</span><span class="free">σ</span><span class="main">→</span><span class="free">τ</span><span class="main">)</span> <span class="free">η</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> it IH
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> iterate.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>iterate_none <span class="skolem">Ee</span> <span class="skolem">ρ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>iterate_again <span class="skolem">Ee</span> <span class="skolem">ρ</span> <span class="skolem">f</span> <span class="skolem">f'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> iterate_again <span class="keyword1"><span class="command">have</span></span> f_st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> T <span class="main">(</span><span class="free">σ</span><span class="main">→</span><span class="free">τ</span><span class="main">)</span> <span class="free">η</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> iterate_again f_st <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ee</span> <span class="main">(</span><span class="skolem">f</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">⊆</span> T <span class="main">(</span><span class="free">σ</span><span class="main">→</span><span class="free">τ</span><span class="main">)</span> <span class="free">η</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> this iterate_again <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">theorem</span></span> welltyped_dont_go_wrong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wte<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">e</span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wfr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="free">ρ</span><span class="main">,</span><span class="free">η</span> <span class="main">:</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"E <span class="free">e</span> <span class="free">ρ</span> <span class="main">⊆</span> T <span class="free">τ</span> <span class="free">η</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wte wfr
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ρ</span></span> <span class="quoted"><span class="free">η</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> well_typed.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wtnat <span class="skolem">Γ</span> <span class="skolem">n</span> <span class="skolem">ρ</span> <span class="skolem">η</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wtvar <span class="skolem">Γ</span> <span class="skolem">n</span> <span class="skolem">τ</span> <span class="skolem">ρ</span> <span class="skolem">η</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> wtvar <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> lx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> T <span class="skolem">τ</span> <span class="skolem">η</span>"</span></span><span class="keyword1"><span class="command">using</span></span> lookup_wfenv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> lx vt <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">using</span></span> T_down_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">ρ</span><span class="main">!</span><span class="skolem">n</span>"</span></span> <span class="quoted"><span class="skolem">τ</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">η</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wtapp <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">σ</span> <span class="skolem">τ</span> <span class="skolem">e'</span> <span class="skolem">ρ</span> <span class="skolem">η</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> wtapp <span class="keyword1"><span class="command">have</span></span> Ee<span class="main">:</span> <span class="quoted"><span class="quoted">"E <span class="skolem">e</span> <span class="skolem">ρ</span> <span class="main">⊆</span> T <span class="main">(</span><span class="skolem">σ</span> <span class="main">→</span> <span class="skolem">τ</span><span class="main">)</span> <span class="skolem">η</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">from</span></span> wtapp <span class="keyword1"><span class="command">have</span></span> Eep<span class="main">:</span> <span class="quoted"><span class="quoted">"E <span class="skolem">e'</span> <span class="skolem">ρ</span> <span class="main">⊆</span> T <span class="skolem">σ</span> <span class="skolem">η</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
  <span class="keyword1"><span class="command">from</span></span> Ee Eep <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fun_app <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wtlam <span class="skolem">σ</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">τ</span> <span class="skolem">ρ</span> <span class="skolem">η</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">f</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">v1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">v2'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">v1</span> <span class="skolem">v2'</span> <span class="skolem">v2</span>
    <span class="keyword3"><span class="command">assume</span></span> v1_T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span> <span class="main">∈</span> T <span class="skolem">σ</span> <span class="skolem">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v2_E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> E <span class="skolem">e</span> <span class="main">(</span><span class="skolem">v1</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> v2p_v2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2'</span> <span class="main">⊑</span> <span class="skolem">v2</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span><span class="main">#</span><span class="skolem">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> wtlam<span class="main">(</span>3<span class="main">)</span> v1_T <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="skolem">v1</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">,</span><span class="skolem">η</span> <span class="main">:</span> push_ty <span class="skolem">σ</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> wtlam<span class="main">(</span>2<span class="main">)</span> 1 <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"E <span class="skolem">e</span> <span class="main">(</span><span class="skolem">v1</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">⊆</span> T <span class="skolem">τ</span> <span class="skolem">η</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> IH v2_E <span class="keyword1"><span class="command">have</span></span> v2_T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> T <span class="skolem">τ</span> <span class="skolem">η</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> v2_T <span class="keyword1"><span class="command">have</span></span> v2_Tb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span> <span class="main">∈</span> T <span class="skolem">τ</span> <span class="skolem">η</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> v2_Tb v2p_v2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v2</span><span class="main">.</span> <span class="bound">v2</span> <span class="main">∈</span> T <span class="skolem">τ</span> <span class="skolem">η</span> <span class="main">∧</span> <span class="skolem">v2'</span> <span class="main">⊑</span> <span class="bound">v2</span> "</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wtfix <span class="skolem">σ</span> <span class="skolem">τ</span> <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">ρ</span> <span class="skolem">η</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">v</span><span class="main">.</span> iterate <span class="main">(</span>E <span class="skolem">e</span><span class="main">)</span> <span class="skolem">ρ</span> <span class="bound">v</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">∈</span> T <span class="main">(</span><span class="skolem">σ</span> <span class="main">→</span> <span class="skolem">τ</span><span class="main">)</span> <span class="skolem">η</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> it<span class="main">:</span> <span class="quoted"><span class="quoted">"iterate <span class="main">(</span>E <span class="skolem">e</span><span class="main">)</span> <span class="skolem">ρ</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> T <span class="main">(</span><span class="skolem">σ</span> <span class="main">→</span> <span class="skolem">τ</span><span class="main">)</span> <span class="skolem">η</span> <span class="main">⟶</span> E <span class="skolem">e</span> <span class="main">(</span><span class="bound">v</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">⊆</span> T <span class="main">(</span><span class="skolem">σ</span> <span class="main">→</span> <span class="skolem">τ</span><span class="main">)</span> <span class="skolem">η</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarify</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v'</span> <span class="skolem">v''</span> <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> T <span class="main">(</span><span class="skolem">σ</span><span class="main">→</span><span class="skolem">τ</span><span class="main">)</span> <span class="skolem">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v''</span> <span class="main">∈</span> E <span class="skolem">e</span> <span class="main">(</span><span class="skolem">v'</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> wtfix<span class="main">(</span>3<span class="main">)</span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊢</span> <span class="main">(</span><span class="skolem">v'</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span><span class="main">,</span><span class="skolem">η</span> <span class="main">:</span> push_ty <span class="main">(</span><span class="skolem">σ</span> <span class="main">→</span> <span class="skolem">τ</span><span class="main">)</span> <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> wtfix<span class="main">(</span>2<span class="main">)</span> this <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"E <span class="skolem">e</span> <span class="main">(</span><span class="skolem">v'</span><span class="main">#</span><span class="skolem">ρ</span><span class="main">)</span> <span class="main">⊆</span> T <span class="main">(</span><span class="skolem">σ</span><span class="main">→</span><span class="skolem">τ</span><span class="main">)</span> <span class="skolem">η</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> 3 IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v''</span> <span class="main">∈</span> T <span class="main">(</span><span class="skolem">σ</span><span class="main">→</span><span class="skolem">τ</span><span class="main">)</span>  <span class="skolem">η</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v''</span> <span class="main">∈</span> T <span class="main">(</span><span class="skolem">σ</span> <span class="main">→</span> <span class="skolem">τ</span><span class="main">)</span> <span class="skolem">η</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> it 1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> T <span class="main">(</span><span class="skolem">σ</span> <span class="main">→</span> <span class="skolem">τ</span><span class="main">)</span> <span class="skolem">η</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> iterate_sound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"E <span class="skolem">e</span>"</span></span> <span class="quoted"><span class="skolem">ρ</span></span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">σ</span></span> <span class="quoted"><span class="skolem">τ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wtabs <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">τ</span> <span class="skolem">ρ</span> <span class="skolem">η</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mem_Collect_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI1<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">v'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">v'</span> <span class="skolem">V</span> <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> E <span class="skolem">e</span> <span class="skolem">ρ</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> wtabs<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="main">⊢</span> <span class="skolem">ρ</span><span class="main">,</span><span class="main">(</span><span class="skolem">V</span><span class="main">#</span><span class="skolem">η</span><span class="main">)</span> <span class="main">:</span> push_tyvar <span class="skolem">Γ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> wtabs<span class="main">(</span>2<span class="main">)</span> 3 <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"E <span class="skolem">e</span> <span class="skolem">ρ</span> <span class="main">⊆</span> T <span class="skolem">τ</span> <span class="main">(</span><span class="skolem">V</span><span class="main">#</span><span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">from</span></span> 2 IH <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> T <span class="skolem">τ</span> <span class="main">(</span><span class="skolem">V</span><span class="main">#</span><span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="skolem">ρ</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wtinst <span class="skolem">Γ</span> <span class="skolem">e</span> <span class="skolem">τ</span> <span class="skolem">σ</span> <span class="skolem">ρ</span> <span class="skolem">η</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> wtinst<span class="main">(</span>2<span class="main">)</span> wtinst<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"E <span class="skolem">e</span> <span class="skolem">ρ</span> <span class="main">⊆</span> T <span class="main">(</span>Forall <span class="skolem">τ</span><span class="main">)</span> <span class="skolem">η</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span> 
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mem_Collect_eq<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">v'</span> <span class="keyword3"><span class="command">assume</span></span> vp_E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> E <span class="skolem">e</span> <span class="skolem">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> vp_w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">≠</span> Wrong"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
      x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">v'</span> <span class="keyword1">of</span> Abs None <span class="main">⇒</span> <span class="main">{}</span> <span class="main">|</span> Abs <span class="main">(</span>Some <span class="bound">xa</span><span class="main">)</span> <span class="main">⇒</span> return <span class="bound">xa</span>
             <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">{</span><span class="bound">v'</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">⊑</span> Wrong<span class="main">}</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">from</span></span> IH vp_E <span class="keyword1"><span class="command">have</span></span> vp_T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> T <span class="main">(</span>Forall <span class="skolem">τ</span><span class="main">)</span> <span class="skolem">η</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> vp_T <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">v''</span><span class="main">.</span> <span class="skolem">v'</span> <span class="main">=</span> Abs <span class="main">(</span>Some <span class="bound">v''</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">V</span><span class="main">.</span> <span class="bound">v''</span> <span class="main">∈</span> T <span class="skolem">τ</span> <span class="main">(</span><span class="bound">V</span><span class="main">#</span><span class="skolem">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                           <span class="main">∨</span> <span class="skolem">v'</span> <span class="main">=</span> Abs None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> T <span class="main">(</span>subst <span class="main">0</span> <span class="skolem">σ</span> <span class="skolem">τ</span><span class="main">)</span> <span class="skolem">η</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v''</span><span class="main">.</span> <span class="skolem">v'</span> <span class="main">=</span> Abs <span class="main">(</span>Some <span class="bound">v''</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">V</span><span class="main">.</span> <span class="bound">v''</span> <span class="main">∈</span> T <span class="skolem">τ</span> <span class="main">(</span><span class="bound">V</span><span class="main">#</span><span class="skolem">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v''</span></span> <span class="keyword2"><span class="keyword">where</span></span> vp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> Abs <span class="main">(</span>Some <span class="skolem">v''</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
        vpp_T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">V</span><span class="main">.</span> <span class="skolem">v''</span> <span class="main">∈</span> T <span class="skolem">τ</span> <span class="main">(</span><span class="bound">V</span><span class="main">#</span><span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> vp x <span class="keyword1"><span class="command">have</span></span> x_vpp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊑</span> <span class="skolem">v''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?V</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"T <span class="skolem">σ</span> <span class="skolem">η</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> vpp_T <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v''</span> <span class="main">∈</span> T <span class="skolem">τ</span> <span class="main">(</span><span class="var">?V</span><span class="main">#</span><span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v''</span> <span class="main">∈</span> T <span class="main">(</span>subst <span class="main">0</span> <span class="skolem">σ</span> <span class="skolem">τ</span><span class="main">)</span> <span class="skolem">η</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> compositionality<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">τ</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="skolem">σ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> this x_vpp <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> T <span class="main">(</span>subst <span class="main">0</span> <span class="skolem">σ</span> <span class="skolem">τ</span><span class="main">)</span> <span class="skolem">η</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> T_down_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> vp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> Abs None"</span></span>
      <span class="keyword1"><span class="command">from</span></span> vp x <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> T <span class="main">(</span>subst <span class="main">0</span> <span class="skolem">σ</span> <span class="skolem">τ</span><span class="main">)</span> <span class="skolem">η</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> IH <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">=</span> Wrong <span class="main">∧</span> Wrong <span class="main">∈</span> E <span class="skolem">e</span> <span class="skolem">ρ</span><span class="main">}</span> <span class="main">⊆</span> T <span class="main">(</span>subst <span class="main">0</span> <span class="skolem">σ</span> <span class="skolem">τ</span><span class="main">)</span> <span class="skolem">η</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> wrong_not_in_T <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword2"><span class="keyword">end</span></span>
  
</pre>
</div><div id="MutableRef">
<div class="head">
<h1>Theory MutableRef</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Semantics of mutable references"</span></span>

<span class="keyword1"><span class="command">theory</span></span> MutableRef
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="../../HOL/HOL-Library/FSet.html">HOL-Library.FSet</a>"</span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> ty <span class="main">=</span> TNat <span class="main">|</span> TFun <span class="quoted">ty</span> <span class="quoted">ty</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">→</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 60<span class="main">)</span> <span class="main">|</span> TPair <span class="quoted">ty</span> <span class="quoted">ty</span> <span class="main">|</span> TRef <span class="quoted">ty</span>

<span class="keyword1"><span class="command">type_synonym</span></span> name <span class="main">=</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">datatype</span></span> exp <span class="main">=</span> EVar <span class="quoted">name</span> <span class="main">|</span> ENat <span class="quoted">nat</span> <span class="main">|</span> ELam <span class="quoted">ty</span> <span class="quoted">exp</span> <span class="main">|</span> EApp <span class="quoted">exp</span> <span class="quoted">exp</span> 
  <span class="main">|</span> EPrim <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="quoted">exp</span> <span class="quoted">exp</span> <span class="main">|</span> EIf <span class="quoted">exp</span> <span class="quoted">exp</span> <span class="quoted">exp</span>
  <span class="main">|</span> EPair <span class="quoted">exp</span> <span class="quoted">exp</span> <span class="main">|</span> EFst <span class="quoted">exp</span> <span class="main">|</span> ESnd <span class="quoted">exp</span>
  <span class="main">|</span> ERef <span class="quoted">exp</span> <span class="main">|</span> ERead <span class="quoted">exp</span> <span class="main">|</span> EWrite <span class="quoted">exp</span> <span class="quoted">exp</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Denotations (values)"</span></span>
  
<span class="keyword1"><span class="command">datatype</span></span> val <span class="main">=</span> VNat <span class="quoted">nat</span> <span class="main">|</span> VFun <span class="quoted"><span class="quoted">"<span class="main">(</span>val <span class="main">×</span> val<span class="main">)</span> fset"</span></span> <span class="main">|</span> VPair <span class="quoted">val</span> <span class="quoted">val</span> <span class="main">|</span> VAddr <span class="quoted">nat</span> <span class="main">|</span> Wrong

<span class="keyword1"><span class="command">type_synonym</span></span> func <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>val <span class="main">×</span> val<span class="main">)</span> fset"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> store <span class="main">=</span> <span class="quoted"><span class="quoted">"func"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">val_le</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> val <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊑</span>"</span> 52<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  vnat_le<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>VNat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊑</span></span> <span class="main">(</span>VNat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  vaddr_le<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>VAddr <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊑</span></span> <span class="main">(</span>VAddr <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span> 
  wrong_le<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Wrong <span class="main"><span class="free">⊑</span></span> Wrong"</span></span> <span class="main">|</span>
  vfun_le<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">|⊆|</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">⟹</span> <span class="main">(</span>VFun <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊑</span></span> <span class="main">(</span>VFun <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  vpair_le<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main"><span class="free">⊑</span></span> <span class="free"><span class="bound"><span class="entity">v1'</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main"><span class="free">⊑</span></span> <span class="free"><span class="bound"><span class="entity">v2'</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>VPair <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊑</span></span> <span class="main">(</span>VPair <span class="free"><span class="bound"><span class="entity">v1'</span></span></span> <span class="free"><span class="bound"><span class="entity">v2'</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">vsize</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">vsize</span> <span class="main">(</span>VNat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">vsize</span> <span class="main">(</span>VFun <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> ffold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">u</span><span class="main">)</span><span class="main">)</span><span class="main">.</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">v</span> <span class="main">+</span> <span class="bound">u</span> <span class="main">+</span> <span class="bound">r</span><span class="main">)</span> <span class="main">0</span>
                            <span class="main">(</span>fimage <span class="main">(</span>map_prod <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="free">vsize</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="free">vsize</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">vsize</span> <span class="main">(</span>VPair <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">vsize</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">+</span> <span class="free">vsize</span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">vsize</span> <span class="main">(</span>VAddr <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">vsize</span> Wrong <span class="main">=</span> <span class="main">1</span>"</span></span> 

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Non-deterministic state monad"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> M <span class="main">=</span> <span class="quoted"><span class="quoted">"store <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> store<span class="main">)</span> set"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> M <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> M<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> M"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bind</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">μ1</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">μ3</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">v'</span> <span class="bound">μ2</span><span class="main">.</span> <span class="main">(</span><span class="bound">v'</span><span class="main">,</span><span class="bound">μ2</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">μ1</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">μ3</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">v'</span> <span class="bound">μ2</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> bind_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_bind"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>pttrns<span class="main">,</span><span class="tfree">'a</span> M<span class="main">,</span><span class="tfree">'b</span><span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_ <span class="keyword1">←</span> _<span class="keyword1">;</span><span class="keyword3">//</span>_<span class="keyword3">)</span>"</span> 0<span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="free">P</span> <span class="main">←</span> <span class="free">E</span><span class="main">;</span> <span class="free">F</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> bind <span class="free">E</span> <span class="main">(</span><span class="main">λ</span><span class="free">P</span><span class="main">.</span> <span class="free">F</span><span class="main">)</span>"</span>

<span class="keyword1"><span class="command">no_notation</span></span> <span class="quoted">"binomial"</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">choose</span>"</span> 65<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">choose</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> M"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">choose</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">μ1</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∧</span> <span class="bound">μ1</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> choose_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">return</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> M"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">return</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span><span class="main">)</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> return_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">zero</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> M"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">zero</span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="main">≡</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> zero_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
   
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">err_bind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val M <span class="main">⇒</span> <span class="main">(</span>val <span class="main">⇒</span> val M<span class="main">)</span> <span class="main">⇒</span> val M"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">err_bind</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="bound">x</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">;</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> Wrong <span class="keyword1">then</span> return Wrong <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> err_bind_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_errset_bind"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>pttrns<span class="main">,</span>val M<span class="main">,</span>val<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_ <span class="keyword1">:=</span> _<span class="keyword1">;</span><span class="keyword3">//</span>_<span class="keyword3">)</span>"</span> 0<span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="free">P</span> <span class="main">:=</span> <span class="free">E</span><span class="main">;</span> <span class="free">F</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> err_bind <span class="free">E</span> <span class="main">(</span><span class="main">λ</span><span class="free">P</span><span class="main">.</span> <span class="free">F</span><span class="main">)</span>"</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">down</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> val M"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">down</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">μ1</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">v'</span><span class="main">,</span><span class="bound">μ</span><span class="main">)</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∧</span> <span class="bound">μ</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">μ1</span></span></span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> down_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">get_store</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"store M"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">get_store</span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span><span class="main">)</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> get_store_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">put_store</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"store <span class="main">⇒</span> unit M"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">put_store</span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{</span> <span class="main">(</span><span class="main">()</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">μ</span></span></span><span class="main">)</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> put_store_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mapM</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fset <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> M<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> fset<span class="main">)</span> M"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mapM</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> ffold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span><span class="main">;</span> <span class="bound">bs</span> <span class="main">←</span> <span class="bound">r</span><span class="main">;</span> return <span class="main">(</span>finsert <span class="bound">b</span> <span class="bound">bs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>return <span class="main">{||}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">run</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"store <span class="main">⇒</span> val M <span class="main">⇒</span> <span class="main">(</span>val <span class="main">×</span> store<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">run</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> run_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sdom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"store <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sdom</span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span>VAddr <span class="bound">a</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> fset <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_addr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"store <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_addr</span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span> <span class="main">=</span> ffold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span>VAddr <span class="bound">n</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> max <span class="bound">n</span> <span class="bound">r</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">r</span><span class="main">)</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">μ</span></span></span>"</span></span>
 
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Denotational semantics"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">apply_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val M <span class="main">⇒</span> val M <span class="main">⇒</span> val M"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">apply_fun</span> <span class="free"><span class="bound"><span class="entity">V1</span></span></span> <span class="free"><span class="bound"><span class="entity">V2</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="bound">v1</span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">V1</span></span></span><span class="main">;</span> <span class="bound">v2</span> <span class="main">:=</span> <span class="free"><span class="bound"><span class="entity">V2</span></span></span><span class="main">;</span>
                       <span class="keyword1">case</span> <span class="bound">v1</span> <span class="keyword1">of</span> VFun <span class="bound">f</span> <span class="main">⇒</span> 
                          <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">p'</span><span class="main">)</span> <span class="main">←</span> choose <span class="main">(</span>fset <span class="bound">f</span><span class="main">)</span><span class="main">;</span> <span class="bound">μ0</span> <span class="main">←</span> get_store<span class="main">;</span>
                          <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">p'</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span>VPair <span class="bound">v</span> <span class="main">(</span>VFun <span class="bound">μ</span><span class="main">)</span><span class="main">,</span> VPair <span class="bound">v'</span> <span class="main">(</span>VFun <span class="bound">μ'</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span>
                            <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">⊑</span> <span class="bound">v2</span> <span class="main">∧</span> <span class="main">(</span>VFun <span class="bound">μ</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span>VFun <span class="bound">μ0</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span> <span class="main">←</span> put_store <span class="bound">μ'</span><span class="main">;</span> down <span class="bound">v'</span><span class="main">)</span> 
                            <span class="keyword1">else</span> zero
                          <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> zero<span class="main">)</span>
                       <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> return Wrong<span class="main">)</span>"</span></span>  

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nvals</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>val fset<span class="main">)</span> M"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nvals</span> <span class="main">0</span> <span class="main">=</span> return <span class="main">{||}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">nvals</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">v</span> <span class="main">←</span> choose UNIV<span class="main">;</span> <span class="bound">L</span> <span class="main">←</span> <span class="free">nvals</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">;</span> return <span class="main">(</span>finsert <span class="bound">v</span> <span class="bound">L</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vals</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>val fset<span class="main">)</span> M"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vals</span> <span class="main">≡</span> <span class="main">(</span><span class="bound">n</span> <span class="main">←</span> choose UNIV<span class="main">;</span> nvals <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> vals_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">npairs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> func M"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">npairs</span> <span class="main">0</span> <span class="main">=</span> return <span class="main">{||}</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">npairs</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">v</span> <span class="main">←</span> choose UNIV<span class="main">;</span> <span class="bound">v'</span> <span class="main">←</span> choose <span class="main">{</span><span class="bound">v</span><span class="main">::</span>val<span class="main">.</span> True<span class="main">}</span><span class="main">;</span>
                     <span class="bound">P</span> <span class="main">←</span> <span class="free">npairs</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">;</span> return <span class="main">(</span>finsert <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">v'</span><span class="main">)</span> <span class="bound">P</span><span class="main">)</span><span class="main">)</span>"</span></span>  

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tables</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"func M"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tables</span> <span class="main">≡</span> <span class="main">(</span><span class="bound">n</span> <span class="main">←</span> choose <span class="main">{</span><span class="bound">k</span><span class="main">::</span>nat<span class="main">.</span> True<span class="main">}</span><span class="main">;</span> npairs <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> tables_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">read</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> val M"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">read</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="bound">μ</span> <span class="main">←</span> get_store<span class="main">;</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> sdom <span class="bound">μ</span> <span class="keyword1">then</span>
                           <span class="main">(</span><span class="main">(</span><span class="bound">v1</span><span class="main">,</span><span class="bound">v2</span><span class="main">)</span> <span class="main">←</span> choose <span class="main">(</span>fset <span class="bound">μ</span><span class="main">)</span><span class="main">;</span> <span class="keyword1">if</span> <span class="bound">v1</span> <span class="main">=</span> VAddr <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">then</span> return <span class="bound">v2</span> <span class="keyword1">else</span> zero<span class="main">)</span>
                       <span class="keyword1">else</span> return Wrong<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> read_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> val <span class="main">⇒</span> val M"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="bound">μ</span> <span class="main">←</span> get_store<span class="main">;</span>
                 <span class="main"><span class="bound">_</span></span> <span class="main">←</span> put_store <span class="main">(</span>finsert <span class="main">(</span>VAddr <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">(</span>ffilter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">v'</span><span class="main">)</span><span class="main">.</span> <span class="bound">v</span> <span class="main">≠</span> VAddr <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="bound">μ</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                 return <span class="main">(</span>VAddr <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> update_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">type_synonym</span></span> env <span class="main">=</span> <span class="quoted"><span class="quoted">"val list"</span></span>    
  
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">E</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"exp <span class="main">⇒</span> env <span class="main">⇒</span> val M"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  Enat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>ENat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> return <span class="main">(</span>VNat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  Evar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>EVar <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="keyword1">then</span> down <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">!</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1">else</span> return Wrong<span class="main">)</span>"</span></span> <span class="main">|</span>
  Elam<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>ELam <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="bound">L</span> <span class="main">←</span> vals<span class="main">;</span> 
                           <span class="bound">t</span> <span class="main">←</span> mapM <span class="bound">L</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">μ</span> <span class="main">←</span> tables<span class="main">;</span>  <span class="main">(</span><span class="bound">v'</span><span class="main">,</span><span class="bound">μ'</span><span class="main">)</span> <span class="main">←</span> choose <span class="main">(</span>run <span class="bound">μ</span> <span class="main">(</span><span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="bound">v</span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> 
                                     return <span class="main">(</span>VPair <span class="bound">v</span> <span class="main">(</span>VFun <span class="bound">μ</span><span class="main">)</span><span class="main">,</span>VPair <span class="bound">v'</span> <span class="main">(</span>VFun <span class="bound">μ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
                           return <span class="main">(</span>VFun <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  Eapp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>EApp <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> apply_fun <span class="main">(</span><span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  Eprim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>EPrim <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="bound">v1</span> <span class="main">:=</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">;</span> <span class="bound">v2</span> <span class="main">:=</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">;</span>
                                 <span class="keyword1">case</span> <span class="main">(</span><span class="bound">v1</span><span class="main">,</span> <span class="bound">v2</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span>VNat <span class="bound">n1</span><span class="main">,</span>VNat <span class="bound">n2</span><span class="main">)</span> <span class="main">⇒</span> return <span class="main">(</span>VNat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">n1</span> <span class="bound">n2</span><span class="main">)</span><span class="main">)</span>
                                 <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> return Wrong<span class="main">)</span>"</span></span> <span class="main">|</span>
  Eif<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>EIf <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="bound">v1</span> <span class="main">:=</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">;</span> <span class="keyword1">case</span> <span class="bound">v1</span> <span class="keyword1">of</span> VNat <span class="bound">n</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e3</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="keyword1">else</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">)</span>
                                            <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> return Wrong<span class="main">)</span>"</span></span> <span class="main">|</span>
  Epair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>EPair <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="bound">v1</span> <span class="main">:=</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">;</span> <span class="bound">v2</span> <span class="main">:=</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">;</span> return <span class="main">(</span>VPair <span class="bound">v1</span> <span class="bound">v2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  Efst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>EFst <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="bound">v</span><span class="main">:=</span><span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">;</span> <span class="keyword1">case</span> <span class="bound">v</span> <span class="keyword1">of</span> VPair <span class="bound">v1</span> <span class="bound">v2</span> <span class="main">⇒</span> return <span class="bound">v1</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> return Wrong<span class="main">)</span>"</span></span> <span class="main">|</span>
  Esnd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>ESnd <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="bound">v</span><span class="main">:=</span><span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">;</span> <span class="keyword1">case</span> <span class="bound">v</span> <span class="keyword1">of</span> VPair <span class="bound">v1</span> <span class="bound">v2</span> <span class="main">⇒</span> return <span class="bound">v2</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> return Wrong<span class="main">)</span>"</span></span> <span class="main">|</span>
  Eref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>ERef <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="bound">v</span><span class="main">:=</span><span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">;</span> <span class="bound">μ</span> <span class="main">←</span> get_store<span class="main">;</span> <span class="bound">a</span> <span class="main">←</span> choose UNIV<span class="main">;</span>
                         <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> sdom <span class="bound">μ</span> <span class="keyword1">then</span> zero
                         <span class="keyword1">else</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span> <span class="main">←</span> put_store <span class="main">(</span>finsert <span class="main">(</span>VAddr <span class="bound">a</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="bound">μ</span><span class="main">)</span><span class="main">;</span>
                               return <span class="main">(</span>VAddr <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  Eread<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>ERead <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="bound">v</span> <span class="main">:=</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">;</span> <span class="keyword1">case</span> <span class="bound">v</span> <span class="keyword1">of</span> VAddr <span class="bound">a</span> <span class="main">⇒</span> read <span class="bound">a</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> return Wrong<span class="main">)</span>"</span></span> <span class="main">|</span>
  Ewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">(</span>EWrite <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="bound">v1</span> <span class="main">:=</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">;</span> <span class="bound">v2</span> <span class="main">:=</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">ρ</span></span></span><span class="main">;</span>
                                 <span class="keyword1">case</span> <span class="bound">v1</span> <span class="keyword1">of</span> VAddr <span class="bound">a</span> <span class="main">⇒</span> update <span class="bound">a</span> <span class="bound">v2</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> return Wrong<span class="main">)</span>"</span></span>


  
  

<span class="keyword2"><span class="keyword">end</span></span>
  
   
</pre>
</div><div id="MutableRefProps">
<div class="head">
<h1>Theory MutableRefProps</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> MutableRefProps
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="MutableRef.html">MutableRef</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">inductive_cases</span></span> 
  vfun_le_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="free">t1</span> <span class="main">⊑</span> VFun <span class="free">t2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  le_fun_nat_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="free">t2</span> <span class="main">⊑</span> VNat <span class="free">x1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  le_any_nat_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⊑</span> VNat <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  le_nat_any_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"VNat <span class="free">n</span> <span class="main">⊑</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  le_fun_any_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"VFun <span class="free">t</span> <span class="main">⊑</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  le_any_fun_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⊑</span> VFun <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  le_pair_any_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"VPair <span class="free">v1</span> <span class="free">v2</span> <span class="main">⊑</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  le_any_pair_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⊑</span> VPair <span class="free">v1</span> <span class="free">v2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  le_addr_any_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"VAddr <span class="free">a</span> <span class="main">⊑</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  le_any_addr_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⊑</span> VAddr <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  le_wrong_any_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Wrong <span class="main">⊑</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  le_any_wrong_inv<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⊑</span> Wrong"</span></span>

<span class="keyword1"><span class="command">proposition</span></span> val_le_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">⊑</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">proposition</span></span> val_le_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v1</span> <span class="main">⊑</span> <span class="free">v2</span><span class="main">;</span> <span class="free">v2</span> <span class="main">⊑</span> <span class="free">v3</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">v1</span> <span class="main">⊑</span> <span class="free">v3</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">v2</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v1</span></span> <span class="quoted"><span class="free">v3</span></span><span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">proposition</span></span> val_le_antisymm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">v1</span> <span class="main">⊑</span> <span class="free">v2</span><span class="main">;</span> <span class="free">v2</span> <span class="main">⊑</span> <span class="free">v1</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">v1</span> <span class="main">=</span> <span class="free">v2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">v1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v2</span></span><span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    
<span class="keyword2"><span class="keyword">end</span></span>
  
</pre>
</div>