<div id="Pairing_Heap_Tree">
<div class="head">
<h1>Theory Pairing_Heap_Tree</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Hauke Brinkop and Tobias Nipkow *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Pairing Heap in Binary Tree Representation›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Pairing_Heap_Tree
<span class="keyword2"><span class="keyword">imports</span></span>  
  <span class="quoted">"<a href="../../HOL/HOL-Library/Tree_Multiset.html">HOL-Library.Tree_Multiset</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Data_Structures/Priority_Queue_Specs.html">HOL-Data_Structures.Priority_Queue_Specs</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definitions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Pairing heaps \cite{FredmanSST86}
in their original representation as binary trees.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">get_min</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder tree <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">get_min</span> <span class="main">(</span>Node <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">link</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">link</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">hsx</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">hsy</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
   <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">hsy</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">hsx</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span> <span class="keyword1">else</span> Node <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">hsx</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">hsy</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">link</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pass<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pass<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">hsx</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">hsy</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> link <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">hsx</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">hsy</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span><span class="free">pass<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">pass<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pass<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pass<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">hsx</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">=</span> link<span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">hsx</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">pass<span class="hidden">⇩</span><sub>2</sub></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">pass<span class="hidden">⇩</span><sub>2</sub></span> Leaf <span class="main">=</span> Leaf"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">del_min</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">del_min</span> Leaf <span class="main">=</span> Leaf"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">del_min</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">hs</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Leaf<span class="main">)</span> <span class="main">=</span> pass<span class="hidden">⇩</span><sub>2</sub> <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge</span> Leaf <span class="free"><span class="bound"><span class="entity">hp</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">hp</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">hp</span></span></span> Leaf <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">hp</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">hsx</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> Leaf<span class="main">)</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">hsy</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> Leaf<span class="main">)</span> <span class="main">=</span> link <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">hsx</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">hsy</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> Leaf<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> tree <span class="main">⇒</span> <span class="tfree">'a</span> tree"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">hp</span></span></span> <span class="main">=</span> merge <span class="main">(</span>Node Leaf <span class="free"><span class="bound"><span class="entity">x</span></span></span> Leaf<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">hp</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The invariant is the conjunction of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>is_root›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>pheap›</span></span></span></span>:›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_root</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_root</span> <span class="free"><span class="bound"><span class="entity">hp</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">hp</span></span></span> <span class="keyword1">of</span> Leaf <span class="main">⇒</span> True <span class="main">|</span> Node <span class="bound">l</span> <span class="bound">x</span> <span class="bound">r</span> <span class="main">⇒</span> <span class="bound">r</span> <span class="main">=</span> Leaf<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pheap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> tree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pheap</span> Leaf <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">pheap</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set_tree <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> <span class="free">pheap</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free">pheap</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness Proofs›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> link_struct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span> <span class="bound">a</span><span class="main">.</span> link <span class="main">(</span>Node <span class="free">hsx</span> <span class="free">x</span> <span class="main">(</span>Node <span class="free">hsy</span> <span class="free">y</span> <span class="free">hs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Node <span class="bound">l</span> <span class="bound">a</span> <span class="free">hs</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> pass<span class="hidden">⇩</span><sub>1</sub>_struct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pass<span class="hidden">⇩</span><sub>1</sub> <span class="main">(</span>Node <span class="free">hs1</span> <span class="free">x</span> <span class="free">hs</span><span class="main">)</span> <span class="main">=</span> Node <span class="bound">l</span> <span class="bound">a</span> <span class="bound">r</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">hs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> pass<span class="hidden">⇩</span><sub>2</sub>_struct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span> <span class="bound">a</span><span class="main">.</span> pass<span class="hidden">⇩</span><sub>2</sub> <span class="main">(</span>Node <span class="free">hs1</span> <span class="free">x</span> <span class="free">hs</span><span class="main">)</span> <span class="main">=</span> Node <span class="bound">l</span> <span class="bound">a</span> Leaf"</span></span> 
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">hs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">hs1</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pass<span class="hidden">⇩</span><sub>2</sub>.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> link_struct<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_root_merge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_root <span class="free">h1</span> <span class="main">⟹</span> is_root <span class="free">h2</span> <span class="main">⟹</span> is_root <span class="main">(</span>merge <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_root_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"is_root <span class="free">h</span> <span class="main">⟹</span> is_root <span class="main">(</span>insert <span class="free">x</span> <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_root_del_min<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_root <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_root <span class="main">(</span>del_min <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Node <span class="skolem">lx</span> <span class="skolem">x</span> <span class="skolem">rx</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rx</span> <span class="main">=</span> Leaf"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">lx</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Node <span class="skolem">ly</span> <span class="skolem">y</span> <span class="skolem">ry</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">la</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">ra</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"pass<span class="hidden">⇩</span><sub>1</sub> <span class="skolem">lx</span> <span class="main">=</span> Node <span class="skolem">a</span> <span class="skolem">la</span> <span class="skolem">ra</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> pass<span class="hidden">⇩</span><sub>1</sub>_struct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lb</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"pass<span class="hidden">⇩</span><sub>2</sub> <span class="main">…</span> <span class="main">=</span> Node <span class="skolem">b</span> <span class="skolem">lb</span> Leaf"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pass<span class="hidden">⇩</span><sub>2</sub>_struct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> pheap_merge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> is_root <span class="free">h1</span><span class="main">;</span> is_root <span class="free">h2</span><span class="main">;</span> pheap <span class="free">h1</span><span class="main">;</span> pheap <span class="free">h2</span> <span class="main">⟧</span> <span class="main">⟹</span> pheap <span class="main">(</span>merge <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pheap_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"is_root <span class="free">h</span> <span class="main">⟹</span> pheap <span class="free">h</span> <span class="main">⟹</span> pheap <span class="main">(</span>insert <span class="free">x</span> <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pheap_link<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> pheap <span class="free">t</span> <span class="main">⟹</span> pheap <span class="main">(</span>link <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> link.induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pheap_pass1<span class="main">:</span> <span class="quoted"><span class="quoted">"pheap <span class="free">h</span> <span class="main">⟹</span> pheap <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pass<span class="hidden">⇩</span><sub>1</sub>.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pheap_pass2<span class="main">:</span> <span class="quoted"><span class="quoted">"pheap <span class="free">h</span> <span class="main">⟹</span> pheap <span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub> <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pheap_link<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pheap_del_min<span class="main">:</span> <span class="quoted"><span class="quoted">"is_root <span class="free">h</span> <span class="main">⟹</span> pheap <span class="free">h</span> <span class="main">⟹</span> pheap <span class="main">(</span>del_min <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pheap_pass1 pheap_pass2 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Functional Correctness›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> get_min_in<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> get_min <span class="free">h</span> <span class="main">∈</span> set_tree <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> neq_Leaf_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> get_min_min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> is_root <span class="free">h</span><span class="main">;</span> pheap <span class="free">h</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> set_tree <span class="free">h</span> <span class="main">⟧</span> <span class="main">⟹</span> get_min <span class="free">h</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> mset_link<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_tree <span class="main">(</span>link <span class="free">t</span><span class="main">)</span> <span class="main">=</span> mset_tree <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> link.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_pass<span class="hidden">⇩</span><sub>1</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"mset_tree <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> mset_tree <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pass<span class="hidden">⇩</span><sub>1</sub>.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_pass<span class="hidden">⇩</span><sub>2</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"mset_tree <span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> mset_tree <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pass<span class="hidden">⇩</span><sub>2</sub>.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_link<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_merge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> is_root <span class="free">h1</span><span class="main">;</span> is_root <span class="free">h2</span> <span class="main">⟧</span>
 <span class="main">⟹</span>  mset_tree <span class="main">(</span>merge <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span> <span class="main">=</span> mset_tree <span class="free">h1</span> <span class="main">+</span> mset_tree <span class="free">h2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h1</span></span> <span class="quoted"><span class="free">h2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
<span class="comment1">(*
lemma mset_merge_pairs: "mset_tree (merge_pairs h) = mset_tree h"
by(induction h rule: merge_pairs.induct)(auto simp: mset_link add_ac)
*)</span>
<span class="keyword1"><span class="command">lemma</span></span> mset_del_min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> is_root <span class="free">h</span><span class="main">;</span> <span class="free">t</span> <span class="main">≠</span> Leaf <span class="main">⟧</span> <span class="main">⟹</span>
  mset_tree <span class="main">(</span>del_min <span class="free">h</span><span class="main">)</span> <span class="main">=</span> mset_tree <span class="free">h</span> <span class="main">-</span> <span class="main">{#</span>get_min <span class="free">h</span><span class="main">#}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> del_min.induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_pass<span class="hidden">⇩</span><sub>1</sub> mset_pass<span class="hidden">⇩</span><sub>2</sub><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Last step: prove all axioms of the priority queue specification:›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> pairing<span class="main">:</span> Priority_Queue_Merge
<span class="keyword2"><span class="keyword">where</span></span> empty <span class="main">=</span> <span class="quoted">Leaf</span> <span class="keyword2"><span class="keyword">and</span></span> is_empty <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="bound">h</span> <span class="main">=</span> Leaf"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> merge <span class="main">=</span> <span class="quoted">merge</span> <span class="keyword2"><span class="keyword">and</span></span> insert <span class="main">=</span> <span class="quoted">insert</span>
<span class="keyword2"><span class="keyword">and</span></span> del_min <span class="main">=</span> <span class="quoted">del_min</span> <span class="keyword2"><span class="keyword">and</span></span> get_min <span class="main">=</span> <span class="quoted">get_min</span>
<span class="keyword2"><span class="keyword">and</span></span> invar <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">h</span><span class="main">.</span> is_root <span class="bound">h</span> <span class="main">∧</span> pheap <span class="bound">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> mset <span class="main">=</span> <span class="quoted">mset_tree</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">q</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_merge<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_del_min<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 5 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_Min_iff get_min_in get_min_min<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 6 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 7 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> is_root_insert pheap_insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 8 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> is_root_del_min pheap_del_min <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 9 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_merge<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 10 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> is_root_merge pheap_merge <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Pairing_Heap_List1">
<div class="head">
<h1>Theory Pairing_Heap_List1</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Tobias Nipkow *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Pairing Heap According to Okasaki›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Pairing_Heap_List1
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Pattern_Aliases.html">HOL-Library.Pattern_Aliases</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Data_Structures/Priority_Queue_Specs.html">HOL-Data_Structures.Priority_Queue_Specs</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definitions›</span></span>

<span class="keyword1"><span class="command">text</span></span>
<span class="quoted"><span class="plain_text">‹This implementation follows Okasaki \cite{Okasaki}.
It satisfies the invariant that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Empty›</span></span></span></span> only occurs
at the root of a pairing heap. The functional correctness proof does not
require the invariant but the amortized analysis (elsewhere) makes use of it.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> heap <span class="main">=</span> Empty <span class="main">|</span> Hp <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> heap list"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">get_min</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> heap <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">get_min</span> <span class="main">(</span>Hp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> insert

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> pattern_aliases
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> heap <span class="main">⇒</span> <span class="tfree">'a</span> heap <span class="main">⇒</span> <span class="tfree">'a</span> heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> Empty <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">merge</span> Empty <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="main">(</span>Hp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">hsx</span></span></span> <span class="main">=:</span> <span class="free"><span class="bound"><span class="entity">hx</span></span></span><span class="main">)</span> <span class="main">(</span>Hp <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">hsy</span></span></span> <span class="main">=:</span> <span class="free"><span class="bound"><span class="entity">hy</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> Hp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">hy</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">hsx</span></span></span><span class="main">)</span> <span class="keyword1">else</span> Hp <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">hx</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">hsy</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> heap <span class="main">⇒</span> <span class="tfree">'a</span> heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> merge <span class="main">(</span>Hp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">[]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pass<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> heap list <span class="main">⇒</span> <span class="tfree">'a</span> heap list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pass<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h1</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">h2</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">=</span> merge <span class="free"><span class="bound"><span class="entity">h1</span></span></span> <span class="free"><span class="bound"><span class="entity">h2</span></span></span> <span class="main">#</span> <span class="free">pass<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">pass<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pass<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> heap list <span class="main">⇒</span> <span class="tfree">'a</span> heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pass<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[]</span> <span class="main">=</span> Empty"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pass<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">=</span> merge <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span><span class="free">pass<span class="hidden">⇩</span><sub>2</sub></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge_pairs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span>  heap list <span class="main">⇒</span> <span class="tfree">'a</span> heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_pairs</span> <span class="main">[]</span> <span class="main">=</span> Empty"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_pairs</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_pairs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h1</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">h2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">=</span> merge <span class="main">(</span>merge <span class="free"><span class="bound"><span class="entity">h1</span></span></span> <span class="free"><span class="bound"><span class="entity">h2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">merge_pairs</span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">del_min</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> heap <span class="main">⇒</span> <span class="tfree">'a</span> heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">del_min</span> Empty <span class="main">=</span> Empty"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">del_min</span> <span class="main">(</span>Hp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">=</span> pass<span class="hidden">⇩</span><sub>2</sub> <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness Proofs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An optimization:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pass12_merge_pairs<span class="main">:</span> <span class="quoted"><span class="quoted">"pass<span class="hidden">⇩</span><sub>2</sub> <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">hs</span><span class="main">)</span> <span class="main">=</span> merge_pairs <span class="free">hs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">hs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_pairs.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> pass12_merge_pairs<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mset_heap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> heap <span class="main">⇒</span><span class="tfree">'a</span> multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">mset_heap</span> Empty <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">mset_heap</span> <span class="main">(</span>Hp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{#</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#}</span> <span class="main">+</span> sum_mset<span class="main">(</span>mset<span class="main">(</span>map <span class="free">mset_heap</span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pheap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> heap <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pheap</span> Empty <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">pheap</span> <span class="main">(</span>Hp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">h</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈#</span> mset_heap <span class="bound">h</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> <span class="free">pheap</span> <span class="bound">h</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pheap_merge<span class="main">:</span> <span class="quoted"><span class="quoted">"pheap <span class="free">h1</span> <span class="main">⟹</span> pheap <span class="free">h2</span> <span class="main">⟹</span> pheap <span class="main">(</span>merge <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h1</span></span> <span class="quoted"><span class="free">h2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pheap_merge_pairs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">h</span> <span class="main">∈</span> set <span class="free">hs</span><span class="main">.</span> pheap <span class="bound">h</span> <span class="main">⟹</span> pheap <span class="main">(</span>merge_pairs <span class="free">hs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">hs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_pairs.induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pheap_merge<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pheap_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"pheap <span class="free">h</span> <span class="main">⟹</span> pheap <span class="main">(</span>insert <span class="free">x</span> <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pheap_merge<span class="main">)</span>
<span class="comment1">(*
lemma pheap_pass1: "∀h ∈ set hs. pheap h ⟹ ∀h ∈ set (pass<span class="hidden">⇩</span><sub>1</sub> hs). pheap h"
by(induction hs rule: pass<span class="hidden">⇩</span><sub>1</sub>.induct) (auto simp: pheap_merge)

lemma pheap_pass2: "∀h ∈ set hs. pheap h ⟹ pheap (pass<span class="hidden">⇩</span><sub>2</sub> hs)"
by (induction hs)(auto simp: pheap_merge)
*)</span>
<span class="keyword1"><span class="command">lemma</span></span> pheap_del_min<span class="main">:</span> <span class="quoted"><span class="quoted">"pheap <span class="free">h</span> <span class="main">⟹</span> pheap <span class="main">(</span>del_min <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pass12_merge_pairs pheap_merge_pairs<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Functional Correctness›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mset_heap_empty_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_heap <span class="free">h</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">⟷</span> <span class="free">h</span> <span class="main">=</span> Empty"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> get_min_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">≠</span> Empty <span class="main">⟹</span> get_min <span class="free">h</span> <span class="main">∈#</span> mset_heap<span class="main">(</span><span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> get_min.induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> get_min_min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h</span> <span class="main">≠</span> Empty<span class="main">;</span> pheap <span class="free">h</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈#</span> mset_heap<span class="main">(</span><span class="free">h</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> get_min <span class="free">h</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> get_min.induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> get_min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> pheap <span class="free">h</span><span class="main">;</span>  <span class="free">h</span> <span class="main">≠</span> Empty <span class="main">⟧</span> <span class="main">⟹</span> get_min <span class="free">h</span> <span class="main">=</span> Min_mset <span class="main">(</span>mset_heap <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Min_eqI finite_set_mset get_min_in get_min_min <span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_merge<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_heap <span class="main">(</span>merge <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span> <span class="main">=</span> mset_heap <span class="free">h1</span> <span class="main">+</span> mset_heap <span class="free">h2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h1</span></span> <span class="quoted"><span class="free">h2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_heap <span class="main">(</span>insert <span class="free">a</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">+</span> mset_heap <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_merge insert_def add_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_merge_pairs<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_heap <span class="main">(</span>merge_pairs <span class="free">hs</span><span class="main">)</span> <span class="main">=</span> sum_mset<span class="main">(</span>image_mset mset_heap<span class="main">(</span>mset <span class="free">hs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">hs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_pairs.induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_merge<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_del_min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">≠</span> Empty <span class="main">⟹</span>
  mset_heap <span class="main">(</span>del_min <span class="free">h</span><span class="main">)</span> <span class="main">=</span> mset_heap <span class="free">h</span> <span class="main">-</span> <span class="main">{#</span>get_min <span class="free">h</span><span class="main">#}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pass12_merge_pairs mset_merge_pairs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Last step: prove all axioms of the priority queue specification:›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> pairing<span class="main">:</span> Priority_Queue_Merge
<span class="keyword2"><span class="keyword">where</span></span> empty <span class="main">=</span> <span class="quoted">Empty</span> <span class="keyword2"><span class="keyword">and</span></span> is_empty <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="bound">h</span> <span class="main">=</span> Empty"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> merge <span class="main">=</span> <span class="quoted">merge</span> <span class="keyword2"><span class="keyword">and</span></span> insert <span class="main">=</span> <span class="quoted">insert</span>
<span class="keyword2"><span class="keyword">and</span></span> del_min <span class="main">=</span> <span class="quoted">del_min</span> <span class="keyword2"><span class="keyword">and</span></span> get_min <span class="main">=</span> <span class="quoted">get_min</span>
<span class="keyword2"><span class="keyword">and</span></span> invar <span class="main">=</span> <span class="quoted">pheap</span> <span class="keyword2"><span class="keyword">and</span></span> mset <span class="main">=</span> <span class="quoted">mset_heap</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">q</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_insert mset_merge<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_del_min mset_heap_empty_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 5 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> get_min mset_heap.simps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 6 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 7 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> pheap_insert<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 8 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pheap_del_min<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 9 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_merge<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 10 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pheap_merge<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Pairing_Heap_List2">
<div class="head">
<h1>Theory Pairing_Heap_List2</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Tobias Nipkow *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Pairing Heap According to Oksaki (Modified)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Pairing_Heap_List2
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Data_Structures/Priority_Queue_Specs.html">HOL-Data_Structures.Priority_Queue_Specs</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definitions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This version of pairing heaps is a modified version
of the one by Okasaki \cite{Okasaki} that avoids structural invariants.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> hp <span class="main">=</span> Hp <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">(</span><span class="free"><span class="entity">hps</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> hp list"</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> heap <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> hp option"</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> insert

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">get_min</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> heap <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">get_min</span> <span class="main">(</span>Some<span class="main">(</span>Hp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">link</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> hp <span class="main">⇒</span> <span class="tfree">'a</span> hp <span class="main">⇒</span> <span class="tfree">'a</span> hp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">link</span> <span class="main">(</span>Hp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">lx</span></span></span><span class="main">)</span> <span class="main">(</span>Hp <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ly</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> Hp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Hp <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ly</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">lx</span></span></span><span class="main">)</span> <span class="keyword1">else</span> Hp <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span>Hp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">lx</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ly</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> heap <span class="main">⇒</span> <span class="tfree">'a</span> heap <span class="main">⇒</span> <span class="tfree">'a</span> heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> None <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">merge</span> None <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">h1</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">h2</span></span></span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span>link <span class="free"><span class="bound"><span class="entity">h1</span></span></span> <span class="free"><span class="bound"><span class="entity">h2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> merge_None<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"merge None <span class="free">h</span> <span class="main">=</span> <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span><span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> heap <span class="main">⇒</span> <span class="tfree">'a</span> heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> None <span class="main">=</span> Some<span class="main">(</span>Hp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span>link <span class="main">(</span>Hp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">[]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pass<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> hp list <span class="main">⇒</span> <span class="tfree">'a</span> hp list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pass<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pass<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">]</span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pass<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h1</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">h2</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">=</span> link <span class="free"><span class="bound"><span class="entity">h1</span></span></span> <span class="free"><span class="bound"><span class="entity">h2</span></span></span> <span class="main">#</span> <span class="free">pass<span class="hidden">⇩</span><sub>1</sub></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pass<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> hp list <span class="main">⇒</span> <span class="tfree">'a</span> heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pass<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">[]</span> <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pass<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="keyword1">case</span> <span class="free">pass<span class="hidden">⇩</span><sub>2</sub></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">|</span> Some <span class="bound">h'</span> <span class="main">⇒</span> link <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="bound">h'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge_pairs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> hp list <span class="main">⇒</span> <span class="tfree">'a</span> heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_pairs</span> <span class="main">[]</span> <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_pairs</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">]</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_pairs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h1</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">h2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">=</span>
  Some<span class="main">(</span><span class="keyword1">let</span> <span class="bound">h12</span> <span class="main">=</span> link <span class="free"><span class="bound"><span class="entity">h1</span></span></span> <span class="free"><span class="bound"><span class="entity">h2</span></span></span> <span class="keyword1">in</span> <span class="keyword1">case</span> <span class="free">merge_pairs</span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="bound">h12</span> <span class="main">|</span> Some <span class="bound">h</span> <span class="main">⇒</span> link <span class="bound">h12</span> <span class="bound">h</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">del_min</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> heap <span class="main">⇒</span> <span class="tfree">'a</span> heap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">del_min</span> None <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">del_min</span> <span class="main">(</span>Some<span class="main">(</span>Hp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> pass<span class="hidden">⇩</span><sub>2</sub> <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness Proofs›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An optimization:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pass12_merge_pairs<span class="main">:</span> <span class="quoted"><span class="quoted">"pass<span class="hidden">⇩</span><sub>2</sub> <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">hs</span><span class="main">)</span> <span class="main">=</span> merge_pairs <span class="free">hs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">hs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_pairs.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> pass12_merge_pairs<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">php</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> hp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">php</span> <span class="main">(</span>Hp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">h</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set_hp <span class="bound">h</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> <span class="free">php</span> <span class="bound">h</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">invar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> heap <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">invar</span> <span class="free"><span class="bound"><span class="entity">ho</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ho</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">h</span> <span class="main">⇒</span> php <span class="bound">h</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> php_link<span class="main">:</span> <span class="quoted"><span class="quoted">"php <span class="free">h1</span> <span class="main">⟹</span> php <span class="free">h2</span> <span class="main">⟹</span> php <span class="main">(</span>link <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h1</span></span> <span class="quoted"><span class="free">h2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> link.induct<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> invar_merge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> invar <span class="free">h1</span><span class="main">;</span> invar <span class="free">h2</span> <span class="main">⟧</span> <span class="main">⟹</span> invar <span class="main">(</span>merge <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> php_link invar_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> invar_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"invar <span class="free">h</span> <span class="main">⟹</span> invar <span class="main">(</span>insert <span class="free">x</span> <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> php_link invar_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> invar_pass1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">h</span> <span class="main">∈</span> set <span class="free">hs</span><span class="main">.</span> php <span class="bound">h</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">h</span> <span class="main">∈</span> set <span class="main">(</span>pass<span class="hidden">⇩</span><sub>1</sub> <span class="free">hs</span><span class="main">)</span><span class="main">.</span> php <span class="bound">h</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">hs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pass<span class="hidden">⇩</span><sub>1</sub>.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> php_link<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> invar_pass2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">h</span> <span class="main">∈</span> set <span class="free">hs</span><span class="main">.</span> php <span class="bound">h</span> <span class="main">⟹</span> invar <span class="main">(</span>pass<span class="hidden">⇩</span><sub>2</sub> <span class="free">hs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">hs</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> php_link invar_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> invar_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"invar<span class="main">(</span>Some <span class="free">h</span><span class="main">)</span> <span class="main">=</span> php <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> invar_del_min<span class="main">:</span> <span class="quoted"><span class="quoted">"invar <span class="free">h</span> <span class="main">⟹</span> invar <span class="main">(</span>del_min <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> del_min.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invar_Some <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> invar_pass1 invar_pass2<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Functional Correctness›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mset_hp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> hp <span class="main">⇒</span><span class="tfree">'a</span> multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">mset_hp</span> <span class="main">(</span>Hp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{#</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#}</span> <span class="main">+</span> sum_mset<span class="main">(</span>mset<span class="main">(</span>map <span class="free">mset_hp</span> <span class="free"><span class="bound"><span class="entity">hs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mset_heap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> heap <span class="main">⇒</span><span class="tfree">'a</span> multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">mset_heap</span> <span class="free"><span class="bound"><span class="entity">ho</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ho</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">{#}</span> <span class="main">|</span> Some <span class="bound">h</span> <span class="main">⇒</span> mset_hp <span class="bound">h</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_mset_mset_hp<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>mset_hp <span class="free">h</span><span class="main">)</span> <span class="main">=</span> set_hp <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_hp_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mset_hp <span class="free">hp</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">hp</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_heap_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_heap<span class="main">(</span>Some <span class="free">hp</span><span class="main">)</span> <span class="main">=</span> mset_hp <span class="free">hp</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_heap_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_heap_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_heap <span class="free">h</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">⟷</span> <span class="free">h</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_heap_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> get_min_in<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">≠</span> None <span class="main">⟹</span> get_min <span class="free">h</span> <span class="main">∈</span> set_hp<span class="main">(</span>the <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> get_min.induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> get_min_min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">h</span> <span class="main">≠</span> None<span class="main">;</span> invar <span class="free">h</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> set_hp<span class="main">(</span>the <span class="free">h</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> get_min <span class="free">h</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> get_min.induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invar_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> mset_link<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_hp <span class="main">(</span>link <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span> <span class="main">=</span> mset_hp <span class="free">h1</span> <span class="main">+</span> mset_hp <span class="free">h2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h1</span></span> <span class="quoted"><span class="free">h2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> link.induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_ac<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_merge<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_heap <span class="main">(</span>merge <span class="free">h1</span> <span class="free">h2</span><span class="main">)</span> <span class="main">=</span> mset_heap <span class="free">h1</span> <span class="main">+</span> mset_heap <span class="free">h2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h1</span></span> <span class="quoted"><span class="free">h2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_heap_def mset_link <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_heap <span class="main">(</span>insert <span class="free">a</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">+</span> mset_heap <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">h</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_link mset_heap_def insert_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_merge_pairs<span class="main">:</span> <span class="quoted"><span class="quoted">"mset_heap <span class="main">(</span>merge_pairs <span class="free">hs</span><span class="main">)</span> <span class="main">=</span> sum_mset<span class="main">(</span>image_mset mset_hp <span class="main">(</span>mset <span class="free">hs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">hs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_pairs.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_merge mset_link mset_heap_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mset_del_min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">≠</span> None <span class="main">⟹</span>
  mset_heap <span class="main">(</span>del_min <span class="free">h</span><span class="main">)</span> <span class="main">=</span> mset_heap <span class="free">h</span> <span class="main">-</span> <span class="main">{#</span>get_min <span class="free">h</span><span class="main">#}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> del_min.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_heap_Some pass12_merge_pairs mset_merge_pairs<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Last step: prove all axioms of the priority queue specification:›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> pairing<span class="main">:</span> Priority_Queue_Merge
<span class="keyword2"><span class="keyword">where</span></span> empty <span class="main">=</span> <span class="quoted">None</span> <span class="keyword2"><span class="keyword">and</span></span> is_empty <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">h</span><span class="main">.</span> <span class="bound">h</span> <span class="main">=</span> None"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> merge <span class="main">=</span> <span class="quoted">merge</span> <span class="keyword2"><span class="keyword">and</span></span> insert <span class="main">=</span> <span class="quoted">insert</span>
<span class="keyword2"><span class="keyword">and</span></span> del_min <span class="main">=</span> <span class="quoted">del_min</span> <span class="keyword2"><span class="keyword">and</span></span> get_min <span class="main">=</span> <span class="quoted">get_min</span>
<span class="keyword2"><span class="keyword">and</span></span> invar <span class="main">=</span> <span class="quoted">invar</span> <span class="keyword2"><span class="keyword">and</span></span> mset <span class="main">=</span> <span class="quoted">mset_heap</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_heap_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">q</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_heap_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_insert mset_merge<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_del_min mset_heap_empty<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">q</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> get_min_in<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_Min_iff get_min_min mset_heap_empty mset_heap_Some set_mset_mset_hp<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 6 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 7 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> invar_insert<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 8 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_del_min<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 9 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_merge<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 10 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invar_merge<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>