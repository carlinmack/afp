<div id="Lehmer">
<div class="head">
<h1>Theory Lehmer</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Lehmer
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Main.html">Main</a>
  <span class="quoted">"<a href="../../HOL/HOL-Number_Theory/Residues.html">HOL-Number_Theory.Residues</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Lehmer's Theorem›</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{sec:lehmer}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section we prove Lehmer's Theorem~\cite{lehmer1927fermat_converse} and its converse.
  These two theorems characterize a necessary and complete criterion for primality. This criterion
  is the basis of the Lucas-Lehmer primality test and the primality certificates of
  Pratt~\cite{pratt1975certificate}.
›</span></span>

<span class="keyword1" id="Lehmer-mod_1_coprime_nat"><span class="command">lemma</span></span> mod_1_coprime_nat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"coprime <span class="free">a</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">nat</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> that coprime_1_left <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="free">a</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cong_imp_coprime cong_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This is a weak variant of Lehmer's theorem: All numbers less then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">p</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">1</span></span> <span class="main"><span class="main">::</span></span> nat"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  must be considered.
›</span></span>

<span class="keyword1" id="Lehmer-lehmers_weak_theorem"><span class="command">lemma</span></span> lehmers_weak_theorem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> min_cong1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cong1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> totient_imp_prime<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">≤</span> <span class="free">p</span>›</span></span> cong1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"coprime <span class="free">a</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mod_1_coprime_nat<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free"><span class="free">p</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> totient <span class="free">p</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> euler_theorem<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"totient <span class="free">p</span> <span class="main">≥</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∨</span> totient <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_cong1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"totient <span class="free">p</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"totient <span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">≤</span> <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">≥</span> <span class="numeral">2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"totient <span class="free">p</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> totient_less<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"totient <span class="free">p</span> <span class="main">=</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">≥</span> <span class="numeral">2</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Lehmer-prime_factors_elem"><span class="command">lemma</span></span> prime_factors_elem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> prime_factors <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"prime <span class="free">n</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prime_factors_dvd prime_factor_nat<span class="main">)</span>

<span class="keyword1" id="Lehmer-cong_pow_1_nat"><span class="command">lemma</span></span> cong_pow_1_nat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">using</span></span> cong_pow <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Lehmer-cong_gcd_eq_1_nat"><span class="command">lemma</span></span> cong_gcd_eq_1_nat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cong_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="free">m</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> gcd <span class="free">m</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> gcd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">*</span> <span class="skolem">c</span> <span class="main">=</span> <span class="free">n</span> <span class="main">*</span> <span class="skolem">d</span> <span class="main">+</span> gcd <span class="free">m</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bezout_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> cong_m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cong_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">*</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cong_props <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> cong_pow_1_nat power_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">1</span> <span class="main">*</span> <span class="free">a</span> <span class="main">^</span> gcd <span class="free">m</span> <span class="free">n</span> <span class="main">=</span> <span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">*</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="main">^</span> gcd <span class="free">m</span> <span class="free">n</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong_scalar_right<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cong_sym<span class="main">)</span> <span class="main">(</span><span class="operator">fact</span> cong_n<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="free">n</span> <span class="main">*</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="main">^</span> gcd <span class="free">m</span> <span class="free">n</span> <span class="main">=</span> <span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="skolem">c</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gcd <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_add<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cong_m <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> gcd <span class="free">m</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Lehmer-One_leq_div"><span class="command">lemma</span></span> One_leq_div<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="keyword1">div</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">dvd</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_div_mult_self mult.left_neutral mult_less_cancel2<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> lehmers_theorem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pf_notcong1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> prime_factors <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cong1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">≤</span><span class="free">p</span>›</span></span> pf_notcong1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cong_pow_1_nat less_diff_conv linorder_neqE_nat linorder_not_less
      one_add_one prime_factors_elem two_is_prime_nat<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> A_notcong_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gcd_cong_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> gcd <span class="skolem">x</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cong_gcd_eq_1_nat<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span>›</span></span> _ cong1<span class="main"><span class="main">]</span></span><span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gcd <span class="skolem">x</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="var">?thesis</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gcd_p1<span class="main">:</span> <span class="quoted"><span class="quoted">"gcd <span class="skolem">x</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"gcd <span class="skolem">x</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> gcd_le2_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">≤</span> <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">linarith</span><span class="main">)</span>

        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span>gcd <span class="skolem">x</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> p_1_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> gcd <span class="skolem">x</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> c_def <span class="keyword1"><span class="command">using</span></span> gcd_p1
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_mult_div_cancel<span class="main">)</span>

        <span class="keyword1"><span class="command">from</span></span> gcd_p1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> c_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> One_leq_div<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q_pf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> prime_factors <span class="skolem">c</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> prime_factors_elem <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> prime_factors <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> q_pf <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">c</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">≤</span> <span class="free">p</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> p_1_eq<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prime_factors_product<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">^</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> p_1_eq<span class="main"><span class="keyword3">,</span></span><span class="operator">subst</span> dvd_div_mult_self<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="keyword1">dvd</span> <span class="skolem">c</span>›</span></span><span class="main"><span class="main">,</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
             <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> One_nat_def <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mult gcd_cong_1 cong_pow_1_nat<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> pf_notcong1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span>›</span></span> gcd_le1_nat gr_implies_not0 linorder_not_less<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> lehmers_weak_theorem<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">≤</span> <span class="free">p</span>›</span></span> _ cong1<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The converse of Lehmer's theorem is also true.
›</span></span>

<span class="keyword1" id="Lehmer-converse_lehmer_weak"><span class="command">lemma</span></span> converse_lehmer_weak<span class="main">:</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> prime_p<span class="main">:</span> <span class="quoted"><span class="quoted">"prime <span class="free">p</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">a</span><span class="main">.</span> <span class="main">[</span><span class="bound">a</span><span class="main">^</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">⟶</span> <span class="main">[</span><span class="bound">a</span><span class="main">^</span><span class="bound">x</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>
             <span class="main">∧</span> <span class="bound">a</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
 <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prime_ge_2_nat<span class="main"><span class="main">[</span></span><span class="operator">OF</span> prime_p<span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span> <span class="main">..</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> <span class="main">∧</span> <span class="main">{</span><span class="main">1</span> <span class="main">..</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">a</span><span class="main">^</span><span class="bound">i</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">|</span> <span class="bound">i</span> <span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> UNIV<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> residue_prime_mult_group_has_gen<span class="main">[</span><span class="operator">OF</span> prime_p<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">{</span></span>
   <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">∧</span> <span class="main">[</span><span class="skolem">a</span><span class="main">^</span><span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">a</span><span class="main">^</span><span class="bound">i</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> UNIV<span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">a</span><span class="main">^</span><span class="bound">i</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≤</span> <span class="skolem">x</span><span class="main">}</span>"</span></span>
     <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">a</span> <span class="main">^</span> <span class="bound">i</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≤</span> <span class="skolem">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="skolem">a</span> <span class="main">^</span> <span class="bound">i</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> UNIV<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> y<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">a</span><span class="main">^</span><span class="bound">i</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">|</span> <span class="bound">i</span> <span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> UNIV<span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">^</span><span class="skolem">i</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">i</span> <span class="keyword1">div</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">i</span> <span class="keyword1">mod</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">q</span><span class="main">*</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_def q_def<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> y_q_r<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">q</span><span class="main">*</span><span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="skolem">a</span> <span class="main">^</span> <span class="skolem">r</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> i power_add mod_mult_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">q</span><span class="main">*</span><span class="skolem">x</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">^</span> <span class="skolem">x</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">q</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mod mult.commute power_mult<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> y_r<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">^</span> <span class="skolem">r</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span><span class="main">≥</span><span class="numeral">2</span>›</span></span> x
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def y_q_r<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">a</span> <span class="main">^</span> <span class="bound">i</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≤</span> <span class="skolem">x</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">^</span><span class="skolem">x</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span><span class="main">≥</span><span class="numeral">2</span>›</span></span> x
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cong_def y_r<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> y_r r_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">" <span class="main">{</span><span class="skolem">a</span> <span class="main">^</span> <span class="bound">i</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> UNIV<span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="skolem">a</span> <span class="main">^</span> <span class="bound">i</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≤</span> <span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">note</span></span> X <span class="main">=</span> this

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> card <span class="main">{</span><span class="main">1</span> <span class="main">..</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span> <span class="main">..</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">a</span><span class="main">^</span><span class="bound">i</span> <span class="keyword1">mod</span> <span class="free">p</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="main">1</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≤</span> <span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">a</span><span class="main">^</span><span class="bound">i</span> <span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">…</span> <span class="main">≤</span> <span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Finite_Set.card_image_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">a</span><span class="main">^</span><span class="bound">i</span> <span class="keyword1">mod</span> <span class="free">p</span>"</span></span><span class="main">]</span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">≤</span> <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
   <span class="keyword1"><span class="command">}</span></span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">⟶</span> <span class="main">[</span><span class="skolem">a</span><span class="main">^</span><span class="bound">x</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> a_is_gen <span class="main">=</span> this
 <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">&gt;</span><span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">p</span> <span class="keyword1">dvd</span> <span class="skolem">a</span> "</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">¬</span> <span class="free">p</span> <span class="keyword1">dvd</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="keyword1">dvd</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≤</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dvd_nat_bounds<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="keyword1">dvd</span> <span class="skolem">a</span>›</span></span><span class="main">]</span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span><span class="main">&gt;</span><span class="main">1</span>›</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"coprime <span class="skolem">a</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prime_imp_coprime_nat <span class="main">[</span><span class="operator">OF</span> prime_p<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> totient <span class="free">p</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> euler_theorem<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> prime_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"totient <span class="free">p</span> <span class="main">=</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> totient_prime<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">^</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> a_is_gen a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> converse_lehmer<span class="main">:</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> prime_p<span class="main">:</span><span class="quoted"><span class="quoted">"prime<span class="main">(</span><span class="free">p</span><span class="main">)</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">a</span> <span class="main">.</span> <span class="main">[</span><span class="bound">a</span><span class="main">^</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span>
              <span class="main">(</span><span class="main">∀</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> prime_factors <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">[</span><span class="bound">a</span><span class="main">^</span><span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">q</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>
              <span class="main">∧</span> <span class="bound">a</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
 <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prime_ge_2_nat<span class="main"><span class="main">[</span></span><span class="operator">OF</span> prime_p<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">^</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">x</span> <span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">p</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">⟶</span> <span class="main">[</span><span class="skolem">a</span><span class="main">^</span><span class="bound">x</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">∧</span> <span class="skolem">a</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">a</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> converse_lehmer_weak<span class="main">[</span><span class="operator">OF</span> prime_p<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="keyword3"><span class="command">assume</span></span> q<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> prime_factors <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">q</span> <span class="main">∧</span> <span class="skolem">q</span> <span class="main">≤</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span><span class="main">≥</span><span class="numeral">2</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dvd_nat_bounds prime_factors_gt_0_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="skolem">q</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> div_le_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> div_self<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> q <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prime_ge_2_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="skolem">q</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">≥</span> <span class="numeral">2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">^</span><span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">≠</span> <span class="main">1</span><span class="main">]</span> <span class="main">(</span><span class="keyword1">mod</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="skolem">q</span> <span class="main">≥</span> <span class="main">1</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_diff_Suc less_eq_Suc_le<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>