<div id="Automaton">
<div class="head">
<h1>Theory Automaton</h1>
</div>
<pre class="source"><span class="comment1">(*  Author: Tobias Nipkow, Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Regular Expressions Equivalence Framework"</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Automaton
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Regular-Sets/Regular_Exp.html">Regular-Sets.Regular_Exp</a>"</span> <span class="quoted">"<a href="../../HOL/HOL-Library/While_Combinator.html">HOL-Library.While_Combinator</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">add_atoms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_atoms</span> Zero <span class="main">=</span> id"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">add_atoms</span> One <span class="main">=</span> id"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">add_atoms</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> List.insert <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">add_atoms</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">add_atoms</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">o</span> <span class="free">add_atoms</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">add_atoms</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">add_atoms</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">o</span> <span class="free">add_atoms</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">add_atoms</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">add_atoms</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_add_atoms<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>add_atoms <span class="free">r</span> <span class="free">as</span><span class="main">)</span> <span class="main">=</span> atoms <span class="free">r</span> <span class="main">∪</span> set <span class="free">as</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> rtrancl_fold_product<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">f</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">,</span><span class="free">f</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">|</span> <span class="bound">r</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">:</span> <span class="free">A</span><span class="main">}</span><span class="main">^*</span> <span class="main">=</span>
       <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>fold <span class="free">f</span> <span class="bound">w</span> <span class="bound">r</span><span class="main">,</span>fold <span class="free">f</span> <span class="bound">w</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">|</span> <span class="bound">r</span> <span class="bound">s</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">:</span> lists <span class="free">A</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">r'</span> <span class="skolem">s'</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">r'</span><span class="main">,</span><span class="skolem">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> <span class="var">?L</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">r'</span><span class="main">,</span><span class="skolem">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_rtrancl_induct2<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> refl <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fold_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fold_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">r'</span> <span class="skolem">s'</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">w</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span><span class="main">,</span> fold <span class="free">f</span> <span class="skolem">w</span> <span class="skolem">r</span><span class="main">,</span> fold <span class="free">f</span> <span class="skolem">w</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">:</span><span class="var">?L</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> snoc <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rtrancl_into_rtrancl<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">r'</span><span class="main">,</span><span class="skolem">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> <span class="var">?R</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">r'</span><span class="main">,</span><span class="skolem">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">:</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_lists_conv_set<span class="main">)</span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rtrancl_fold_product1<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">}</span><span class="main">^*</span> <span class="main">=</span>
       <span class="main">{</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span>fold <span class="free">f</span> <span class="bound">w</span> <span class="bound">r</span><span class="main">)</span> <span class="main">|</span> <span class="bound">r</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">:</span> lists <span class="free">A</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span> <span class="main">:</span> <span class="var">?L</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span> <span class="main">:</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converse_rtrancl_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> base <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fold_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> step <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fold_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">w</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> fold <span class="free">f</span> <span class="skolem">w</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">:</span><span class="var">?L</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> snoc <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rtrancl_into_rtrancl<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span> <span class="main">:</span> <span class="var">?R</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span> <span class="main">:</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_lists_conv_set<span class="main">)</span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lang_eq_ext_Nil_fold_Deriv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">r</span> <span class="free">s</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝔅</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span>fold Deriv <span class="bound">w</span> <span class="main">(</span>lang <span class="free">r</span><span class="main">)</span><span class="main">,</span> fold Deriv <span class="bound">w</span> <span class="main">(</span>lang <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">|</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">w</span><span class="main">∈</span>lists <span class="main">(</span>atoms <span class="free">r</span> <span class="main">∪</span> atoms <span class="free">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">r</span> <span class="main">=</span> lang <span class="free">s</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">K</span><span class="main">,</span> <span class="bound">L</span><span class="main">)</span> <span class="main">∈</span> <span class="free">𝔅</span><span class="main">.</span> <span class="main">[]</span> <span class="main">∈</span> <span class="bound">K</span> <span class="main">⟷</span> <span class="main">[]</span> <span class="main">∈</span> <span class="bound">L</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lang_eq_ext 𝔅_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> in_fold_Deriv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>



<span class="keyword1"><span class="command">locale</span></span> rexp_DA <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">delta</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">final</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">L</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> L_init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">(</span><span class="free">init</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> lang <span class="free">r</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> L_delta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span><span class="main">(</span><span class="free">delta</span> <span class="free">a</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> Deriv <span class="free">a</span> <span class="main">(</span><span class="free">L</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> final_iff_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">final</span> <span class="free">s</span> <span class="main">⟷</span> <span class="main">[]</span> <span class="main">∈</span> <span class="free">L</span> <span class="free">s</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> L_deltas<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">(</span>fold <span class="free">delta</span> <span class="free">w</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> fold Deriv <span class="free">w</span> <span class="main">(</span><span class="free">L</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L_delta<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">closure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">*</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">*</span> <span class="tfree">'s</span><span class="main">)</span> list <span class="main">*</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">*</span> <span class="tfree">'s</span><span class="main">)</span> set<span class="main">)</span> option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">closure</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">=</span> rtrancl_while <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="free">final</span> <span class="bound">p</span> <span class="main">=</span> <span class="free">final</span> <span class="bound">q</span><span class="main">)</span>
          <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">q</span><span class="main">)</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">delta</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">,</span> <span class="free">delta</span> <span class="bound">a</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span>"</span></span>
<span class="comment1">(* stop when same opti? *)</span>

<span class="keyword1"><span class="command">theorem</span></span> closure_sound_complete<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> result<span class="main">:</span> <span class="quoted"><span class="quoted">"closure <span class="free">as</span> <span class="main">(</span><span class="free">init</span> <span class="free">r</span><span class="main">,</span><span class="free">init</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="free">ws</span><span class="main">,</span><span class="free">R</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> atoms<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">as</span> <span class="main">=</span> atoms <span class="free">r</span> <span class="main">∪</span> atoms <span class="free">s</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ws</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> lang <span class="free">r</span> <span class="main">=</span> lang <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lang <span class="free">r</span> <span class="main">=</span> lang <span class="free">s</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">r'</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">r0</span><span class="main">,</span><span class="bound">s0</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">delta</span> <span class="bound">a</span> <span class="bound">r0</span><span class="main">,</span><span class="free">delta</span> <span class="bound">a</span> <span class="bound">s0</span><span class="main">)</span><span class="main">)</span><span class="main">|</span> <span class="bound">r0</span> <span class="bound">s0</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">:</span> set <span class="free">as</span><span class="main">}</span><span class="main">^*</span> <span class="main">``</span> <span class="main">{</span><span class="main">(</span><span class="free">init</span> <span class="free">r</span><span class="main">,</span><span class="free">init</span> <span class="free">s</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
    <span class="free">final</span> <span class="bound">r'</span> <span class="main">=</span> <span class="free">final</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atoms rtrancl_fold_product Ball_def lang_eq_ext_Nil_fold_Deriv imp_ex
      L_deltas L_init final_iff_Nil <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Un_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">q</span><span class="main">)</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">delta</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">,</span> <span class="free">delta</span> <span class="bound">a</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
    <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">,</span> <span class="free">delta</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">,</span> <span class="free">delta</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span> <span class="main">|</span><span class="bound">r</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> set <span class="free">as</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> atoms rtrancl_while_Some<span class="main">[</span><span class="operator">OF</span> result<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> closure_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> leq Ball_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The overall procedure›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">check_eqv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">check_eqv</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">as</span> <span class="main">=</span> add_atoms <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>add_atoms <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">[]</span><span class="main">)</span>
   <span class="keyword1">in</span> <span class="keyword1">case</span> closure <span class="bound">as</span> <span class="main">(</span><span class="free">init</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free">init</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
     Some<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> soundness<span class="main">:</span> 
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"check_eqv <span class="free">r</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">r</span> <span class="main">=</span> lang <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?as</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"add_atoms <span class="free">r</span> <span class="main">(</span>add_atoms <span class="free">s</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"closure <span class="var">?as</span> <span class="main">(</span><span class="free">init</span> <span class="free">r</span><span class="main">,</span> <span class="free">init</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="skolem">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> check_eqv_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.splits list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> closure_sound_complete<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">r</span> <span class="main">=</span> lang <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_add_atoms<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* completeness needs termination of closure, otherwise result could be None *)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Auxiliary functions:›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reachable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'s</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">reachable</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
  snd<span class="main">(</span>the<span class="main">(</span>rtrancl_while <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">delta</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">init</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">automaton</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">*</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">*</span> <span class="tfree">'s</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">automaton</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
  snd <span class="main">(</span>the
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">init</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">;</span>
       <span class="bound">start</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="bound">i</span><span class="main">]</span><span class="main">,</span> <span class="main">{</span><span class="bound">i</span><span class="main">}</span><span class="main">)</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">;</span>
       <span class="bound">test</span> <span class="main">=</span> <span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">ws</span><span class="main">,</span> <span class="bound">Z</span><span class="main">)</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span><span class="main">.</span> <span class="bound">ws</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span>
       <span class="bound">step</span> <span class="main">=</span> <span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">ws</span><span class="main">,</span> <span class="bound">Z</span><span class="main">)</span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span><span class="main">.</span>
         <span class="main">(</span><span class="keyword1">let</span> <span class="bound">s</span> <span class="main">=</span> hd <span class="bound">ws</span><span class="main">;</span>
              <span class="bound">new_edges</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span><span class="main">,</span> <span class="free">delta</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">;</span>
              <span class="bound">new</span> <span class="main">=</span> remdups <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">ss</span><span class="main">.</span> <span class="bound">ss</span> <span class="main">∉</span> <span class="bound">Z</span><span class="main">)</span> <span class="main">(</span>map snd <span class="bound">new_edges</span><span class="main">)</span><span class="main">)</span>
         <span class="keyword1">in</span> <span class="main">(</span><span class="main">(</span><span class="bound">new</span> <span class="main">@</span> tl <span class="bound">ws</span><span class="main">,</span> set <span class="bound">new</span> <span class="main">∪</span> <span class="bound">Z</span><span class="main">)</span><span class="main">,</span> set <span class="bound">new_edges</span> <span class="main">∪</span> <span class="bound">A</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">in</span> while_option <span class="bound">test</span> <span class="bound">step</span> <span class="bound">start</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">match</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="free">final</span> <span class="main">(</span>fold <span class="free">delta</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">(</span><span class="free">init</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> match_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"match <span class="free">s</span> <span class="free">w</span> <span class="main">⟷</span> <span class="free">w</span> <span class="main">∈</span> lang <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> match_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> L_init L_delta in_fold_Deriv final_iff_Nil L_deltas Deriv_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> rexp_DFA <span class="main">=</span> rexp_DA <span class="main">+</span>
<span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span>fold <span class="free">delta</span> <span class="bound">w</span> <span class="main">(</span><span class="free">init</span> <span class="free">s</span><span class="main">)</span> <span class="main">|</span> <span class="bound">w</span><span class="main">.</span> True<span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_rtrancl_delta_Image<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">delta</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">,</span><span class="free">delta</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">|</span> <span class="bound">r</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">:</span> <span class="free">A</span><span class="main">}</span><span class="main">^*</span> <span class="main">``</span> <span class="main">{</span><span class="main">(</span><span class="free">init</span> <span class="free">r</span><span class="main">,</span> <span class="free">init</span> <span class="free">s</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rtrancl_fold_product Image_singleton
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_cartesian_product<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> fin fin<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted">"termination"</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">st</span><span class="main">.</span> closure <span class="free">as</span> <span class="main">(</span><span class="free">init</span> <span class="free">r</span><span class="main">,</span><span class="free">init</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">st</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> closure <span class="free">as</span> <span class="var">?i</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> closure_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_while_finite_Some<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">st</span><span class="main">)</span><span class="main">.</span> <span class="bound">st</span> <span class="main">∈</span> set <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span><span class="bound">q</span><span class="main">)</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">delta</span> <span class="bound">a</span> <span class="bound">p</span><span class="main">,</span> <span class="free">delta</span> <span class="bound">a</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> <span class="main">{</span><span class="var">?i</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Image_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rtrancl_mono<span class="main"><span class="main">]</span></span> finite_rtrancl_delta_Image<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> completeness<span class="main">:</span> 
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lang <span class="free">r</span> <span class="main">=</span> lang <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"check_eqv <span class="free">r</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?as</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"add_atoms <span class="free">r</span> <span class="main">(</span>add_atoms <span class="free">s</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"closure <span class="var">?as</span> <span class="main">(</span><span class="free">init</span> <span class="free">r</span><span class="main">,</span> <span class="free">init</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="skolem">ws</span><span class="main">,</span><span class="skolem">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"termination"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> closure_sound_complete<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> assms
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"check_eqv <span class="free">r</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> check_eqv_def set_add_atoms<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_rtrancl_delta_Image1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">delta</span> <span class="bound">a</span> <span class="bound">r</span><span class="main">}</span><span class="main">^*</span> <span class="main">``</span> <span class="main">{</span><span class="free">init</span> <span class="free">r</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rtrancl_fold_product1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ fin<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reachable<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="free">as</span> <span class="free">r</span> <span class="main">=</span> <span class="main">{</span>fold <span class="free">delta</span> <span class="bound">w</span> <span class="main">(</span><span class="free">init</span> <span class="free">r</span><span class="main">)</span> <span class="main">|</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">∈</span> lists <span class="main">(</span>set <span class="free">as</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> finite_reachable<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reachable <span class="free">as</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wsZ</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"rtrancl_while <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">delta</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="free">init</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">wsZ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span><span class="operator">intro</span> rtrancl_while_finite_Some Image_mono rtrancl_mono
      finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_rtrancl_delta_Image1<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"set <span class="free"><span class="free"><span class="free">as</span></span></span>"</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">r</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"reachable <span class="free">as</span> <span class="free">r</span> <span class="main">=</span> <span class="main">{</span>fold <span class="free">delta</span> <span class="bound">w</span> <span class="main">(</span><span class="free">init</span> <span class="free">r</span><span class="main">)</span> <span class="main">|</span> <span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">∈</span> lists <span class="main">(</span>set <span class="free">as</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> reachable_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">wsZ</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rtrancl_while_Some <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rtrancl_fold_product1 image_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reachable <span class="free">as</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ fin<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Derivatives_Finite">
<div class="head">
<h1>Theory Derivatives_Finite</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Dmitriy Traytel, ported by Tobias Nipkow *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Finiteness of Derivatives Modulo ACI›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="comment1">(* split into Norm and Fin theories *)</span>
<span class="keyword1"><span class="command">theory</span></span> Derivatives_Finite
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Regular-Sets/Derivatives.html">Regular-Sets.Derivatives</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lifting constructors to lists›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rexp_of_list</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rexp_of_list</span> <span class="free"><span class="bound"><span class="entity">OP</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_list</span> <span class="free"><span class="bound"><span class="entity">OP</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rexp_of_list</span> <span class="free"><span class="bound"><span class="entity">OP</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">OP</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free">rexp_of_list</span> <span class="free"><span class="bound"><span class="entity">OP</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">PLUS</span> <span class="main">≡</span> rexp_of_list Plus Zero"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">TIMES</span> <span class="main">≡</span> rexp_of_list Times One"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_singleton_induct <span class="main">[</span><span class="operator">case_names</span> nil single cons<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">xs</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction_schema</span> <span class="main">(</span><span class="operator">pat_completeness</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">lexicographic_order</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ACI normalization›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">toplevel_summands</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">toplevel_summands</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">toplevel_summands</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∪</span> <span class="free">toplevel_summands</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">toplevel_summands</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">flatten</span> <span class="free"><span class="bound"><span class="entity">LISTOP</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">LISTOP</span></span></span> <span class="main">(</span>sorted_list_of_set <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> toplevel_summands_nonempty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"toplevel_summands <span class="free">r</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> toplevel_summands_finite<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>toplevel_summands <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">ACI_norm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword1">«</span>_<span class="keyword1">»</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">«</span></span>Zero<span class="main"><span class="free">»</span></span> <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">«</span></span>One<span class="main"><span class="free">»</span></span> <span class="main">=</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">«</span></span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main"><span class="free">»</span></span> <span class="main">=</span> Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">«</span></span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">»</span></span> <span class="main">=</span> flatten PLUS <span class="main">(</span>toplevel_summands <span class="main">(</span>Plus <span class="main"><span class="free">«</span></span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main"><span class="free">»</span></span> <span class="main"><span class="free">«</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">»</span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">«</span></span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">»</span></span> <span class="main">=</span> Times <span class="main"><span class="free">«</span></span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main"><span class="free">»</span></span> <span class="main"><span class="free">«</span></span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main"><span class="free">»</span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">«</span></span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main"><span class="free">»</span></span> <span class="main">=</span> Star <span class="main"><span class="free">«</span></span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main"><span class="free">»</span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Plus_toplevel_summands<span class="main">:</span> <span class="quoted"><span class="quoted">"Plus <span class="free">r</span> <span class="free">s</span> <span class="main">∈</span> toplevel_summands <span class="free">t</span> <span class="main">⟹</span> False"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> toplevel_summands_not_Plus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="free">x</span> <span class="main">≠</span> Plus <span class="bound">r</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> toplevel_summands <span class="free">x</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> toplevel_summands_PLUS_strong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> list_all <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Plus <span class="bound">r</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">⟧</span> <span class="main">⟹</span> toplevel_summands <span class="main">(</span>PLUS <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> toplevel_summands_flatten<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">;</span> finite <span class="free">X</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Plus <span class="bound">r</span> <span class="bound">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> toplevel_summands <span class="main">(</span>flatten PLUS <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> toplevel_summands_PLUS_strong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="free">X</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> list_all_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> ACI_norm_Plus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">r</span><span class="main">»</span> <span class="main">=</span> Plus <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="free">r</span> <span class="main">=</span> Plus <span class="bound">s</span> <span class="bound">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> toplevel_summands_flatten_ACI_norm_image<span class="main">:</span>
  <span class="quoted"><span class="quoted">"toplevel_summands <span class="main">(</span>flatten PLUS <span class="main">(</span>ACI_norm <span class="main">`</span> toplevel_summands <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ACI_norm <span class="main">`</span> toplevel_summands <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> toplevel_summands_flatten<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ACI_norm_Plus <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Plus_toplevel_summands<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> toplevel_summands_flatten_ACI_norm_image_Union<span class="main">:</span>
  <span class="quoted"><span class="quoted">"toplevel_summands <span class="main">(</span>flatten PLUS <span class="main">(</span>ACI_norm <span class="main">`</span> toplevel_summands <span class="free">r</span> <span class="main">∪</span> ACI_norm <span class="main">`</span> toplevel_summands <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    ACI_norm <span class="main">`</span> toplevel_summands <span class="free">r</span> <span class="main">∪</span> ACI_norm <span class="main">`</span> toplevel_summands <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> toplevel_summands_flatten<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ACI_norm_Plus<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sym<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Plus_toplevel_summands<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> toplevel_summands_ACI_norm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"toplevel_summands <span class="main">«</span><span class="free">r</span><span class="main">»</span> <span class="main">=</span> ACI_norm <span class="main">`</span> toplevel_summands <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toplevel_summands_flatten_ACI_norm_image_Union<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ACI_norm_flatten<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">r</span><span class="main">»</span> <span class="main">=</span> flatten PLUS <span class="main">(</span>ACI_norm <span class="main">`</span> toplevel_summands <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_Un toplevel_summands_flatten_ACI_norm_image<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> ACI_norm_idem<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="main">«</span><span class="free">r</span><span class="main">»</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="main">«</span>Plus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">»</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span>flatten PLUS <span class="main">(</span>toplevel_summands <span class="main">«</span><span class="skolem">r</span><span class="main">»</span> <span class="main">∪</span> toplevel_summands <span class="main">«</span><span class="skolem">s</span><span class="main">»</span><span class="main">)</span><span class="main">»</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">«</span>flatten PLUS <span class="var">?U</span><span class="main">»</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> flatten PLUS <span class="main">(</span>ACI_norm <span class="main">`</span> toplevel_summands <span class="main">(</span>flatten PLUS <span class="var">?U</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ACI_norm_flatten<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"toplevel_summands <span class="main">(</span>flatten PLUS <span class="var">?U</span><span class="main">)</span> <span class="main">=</span> <span class="var">?U</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> toplevel_summands_flatten<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Plus_toplevel_summands<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flatten PLUS <span class="main">(</span>ACI_norm <span class="main">`</span> <span class="var">?U</span><span class="main">)</span> <span class="main">=</span> flatten PLUS <span class="main">(</span>toplevel_summands <span class="main">«</span><span class="skolem">r</span><span class="main">»</span> <span class="main">∪</span> toplevel_summands <span class="main">«</span><span class="skolem">s</span><span class="main">»</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> image_Un toplevel_summands_ACI_norm<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Plus<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Atoms"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> atoms_toplevel_summands<span class="main">:</span>
  <span class="quoted"><span class="quoted">"atoms <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span><span class="main">∈</span>toplevel_summands <span class="free">s</span><span class="main">.</span> atoms <span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_PLUS<span class="main">:</span> <span class="quoted"><span class="quoted">"atoms <span class="main">(</span>PLUS <span class="free">xs</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Σ</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> atoms <span class="bound">r</span> <span class="main">⊆</span> <span class="free">Σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> atoms_PLUS<span class="main">:</span> <span class="quoted"><span class="quoted">"atoms <span class="main">(</span>PLUS <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> atoms <span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> atoms_flatten_PLUS<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">X</span> <span class="main">⟹</span> atoms <span class="main">(</span>flatten PLUS <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> atoms <span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> wf_PLUS<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="free">X</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> atoms_ACI_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"atoms <span class="main">«</span><span class="free">r</span><span class="main">»</span> <span class="main">=</span> atoms <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
   <span class="keyword1"><span class="command">using</span></span> atoms_toplevel_summands<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="skolem">r1</span><span class="main">»</span>"</span></span><span class="main">]</span> atoms_toplevel_summands<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="skolem">r2</span><span class="main">»</span>"</span></span><span class="main">]</span>
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atoms_flatten_PLUS ball_Un Un_commute<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Language"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> toplevel_summands_lang<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> toplevel_summands <span class="free">s</span> <span class="main">⟹</span> lang <span class="free">r</span> <span class="main">⊆</span> lang <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> toplevel_summands_lang_UN<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lang <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span><span class="main">∈</span>toplevel_summands <span class="free">s</span><span class="main">.</span> lang <span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> toplevel_summands_in_lang<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> lang <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">∈</span>toplevel_summands <span class="free">s</span><span class="main">.</span> <span class="free">w</span> <span class="main">∈</span> lang <span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lang_PLUS<span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span>PLUS <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> lang <span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lang_PLUS_map<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lang <span class="main">(</span>PLUS <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> lang <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lang_flatten_PLUS<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">X</span> <span class="main">⟹</span> lang <span class="main">(</span>flatten PLUS <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> lang <span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> lang_PLUS<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="free">X</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">theorem</span></span> lang_ACI_norm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lang <span class="main">«</span><span class="free">r</span><span class="main">»</span> <span class="main">=</span> lang <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> Plus<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lang <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">⊆</span> lang <span class="main">«</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">»</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> toplevel_summands_in_lang<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="skolem">r1</span><span class="main">»</span>"</span></span><span class="main">]</span> toplevel_summands_in_lang<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="skolem">r2</span><span class="main">»</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> toplevel_summands_lang<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Finiteness of ACI-Equivalent Derivatives›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> toplevel_summands_deriv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"toplevel_summands <span class="main">(</span>deriv <span class="free">as</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">s</span><span class="main">∈</span>toplevel_summands <span class="free">r</span><span class="main">.</span> toplevel_summands <span class="main">(</span>deriv <span class="free">as</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> derivs_Zero<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"derivs <span class="free">xs</span> Zero <span class="main">=</span> Zero"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> derivs_One<span class="main">:</span> <span class="quoted"><span class="quoted">"derivs <span class="free">xs</span> One <span class="main">∈</span> <span class="main">{</span>Zero<span class="main">,</span> One<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> derivs_Atom<span class="main">:</span> <span class="quoted"><span class="quoted">"derivs <span class="free">xs</span> <span class="main">(</span>Atom <span class="free">as</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span>Zero<span class="main">,</span> One<span class="main">,</span> Atom <span class="free">as</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Cons <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> insertE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> derivs_One<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> derivs_Plus<span class="main">:</span> <span class="quoted"><span class="quoted">"derivs <span class="free">xs</span> <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span>derivs <span class="free">xs</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>derivs <span class="free">xs</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> derivs_PLUS<span class="main">:</span> <span class="quoted"><span class="quoted">"derivs <span class="free">xs</span> <span class="main">(</span>PLUS <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> PLUS <span class="main">(</span>map <span class="main">(</span>derivs <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> derivs_Plus<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> toplevel_summands_derivs_Times<span class="main">:</span> <span class="quoted"><span class="quoted">"toplevel_summands <span class="main">(</span>derivs <span class="free">xs</span> <span class="main">(</span>Times <span class="free">r</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span>
  <span class="main">{</span>Times <span class="main">(</span>derivs <span class="free">xs</span> <span class="free">r</span><span class="main">)</span> <span class="free">s</span><span class="main">}</span> <span class="main">∪</span>
  <span class="main">{</span><span class="bound">r'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="bound">r'</span> <span class="main">∈</span> toplevel_summands <span class="main">(</span>derivs <span class="bound">ys</span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">ys</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">zs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">=</span> <span class="free">xs</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def derivs_Plus<span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> toplevel_summands_derivs_Star_nonempty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> toplevel_summands <span class="main">(</span>derivs <span class="free">xs</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span>
    <span class="main">{</span>Times <span class="main">(</span>derivs <span class="bound">ys</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span> <span class="main">|</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">∃</span><span class="bound">zs</span><span class="main">.</span> <span class="bound">ys</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">zs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">=</span> <span class="free">xs</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> spec<span class="main">[</span><span class="operator">OF</span> 1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> toplevel_summands_derivs_Times<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> impE <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> meta_spec subsetD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> toplevel_summands_derivs_Star<span class="main">:</span>
  <span class="quoted"><span class="quoted">"toplevel_summands <span class="main">(</span>derivs <span class="free">xs</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span>
    <span class="main">{</span>Star <span class="free">r</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span>Times <span class="main">(</span>derivs <span class="bound">ys</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>Star <span class="free">r</span><span class="main">)</span> <span class="main">|</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">∃</span><span class="bound">zs</span><span class="main">.</span> <span class="bound">ys</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">zs</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">=</span> <span class="free">xs</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> toplevel_summands_derivs_Star_nonempty<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> toplevel_summands_PLUS<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> toplevel_summands <span class="main">(</span>PLUS <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">r</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> toplevel_summands <span class="main">(</span><span class="free">f</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> ACI_norm_toplevel_summands_Zero<span class="main">:</span> <span class="quoted"><span class="quoted">"toplevel_summands <span class="free">r</span> <span class="main">⊆</span> <span class="main">{</span>Zero<span class="main">}</span> <span class="main">⟹</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span> <span class="main">=</span> Zero"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ACI_norm_flatten<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> subset_singletonD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_ACI_norm_toplevel_summands<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="free">f</span> <span class="main">«</span><span class="bound">s</span><span class="main">»</span> <span class="main">|</span><span class="bound">s</span><span class="main">.</span> toplevel_summands <span class="bound">s</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">f</span> <span class="main">«</span><span class="bound">s</span><span class="main">»</span> <span class="main">|</span> <span class="bound">s</span><span class="main">.</span>
    toplevel_summands <span class="bound">s</span> <span class="main">⊆</span> <span class="free">B</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> flatten PLUS <span class="main">∘</span> <span class="main">(`)</span> ACI_norm<span class="main">)</span> <span class="main">`</span> Pow <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> ACI_norm_flatten<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_surj <span class="main"><span class="main">[</span></span><span class="operator">OF</span> iffD2 <span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_Pow_iff<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> finite_derivs<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">«</span>derivs <span class="bound">xs</span> <span class="free">r</span><span class="main">»</span> <span class="main">|</span> <span class="bound">xs</span> <span class="main">.</span> True<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Zero <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> One <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{</span></span></span>Zero<span class="main"><span class="main"><span class="main">,</span></span></span> One<span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> insertE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> derivs_One<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Atom <span class="skolem">as</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{</span></span></span>Zero<span class="main"><span class="main"><span class="main">,</span></span></span> One<span class="main"><span class="main"><span class="main">,</span></span></span> Atom <span class="skolem"><span class="skolem"><span class="skolem">as</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> insertE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> derivs_Atom<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> derivs_Plus <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_cartesian_product<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> Plus<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Times <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>toplevel_summands <span class="main">`</span> <span class="main">{</span><span class="main">«</span>derivs <span class="bound">xs</span> <span class="skolem">s</span><span class="main">»</span> <span class="main">|</span> <span class="bound">xs</span> <span class="main">.</span> True<span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">«</span><span class="bound">r'</span><span class="main">»</span> <span class="main">|</span><span class="bound">r'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="bound">r'</span> <span class="main">∈</span> toplevel_summands <span class="main">(</span>derivs <span class="bound">ys</span> <span class="skolem">s</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound">r'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="bound">r'</span> <span class="main">∈</span> toplevel_summands <span class="main">«</span>derivs <span class="bound">ys</span> <span class="skolem">s</span><span class="main">»</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toplevel_summands_ACI_norm<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">«</span><span class="bound">r'</span><span class="main">»</span> <span class="main">|</span><span class="bound">r'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="bound">r'</span> <span class="main">∈</span> toplevel_summands <span class="main">(</span>derivs <span class="bound">ys</span> <span class="skolem">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>toplevel_summands <span class="main">`</span> <span class="main">{</span><span class="main">«</span>derivs <span class="bound">xs</span> <span class="skolem">s</span><span class="main">»</span> <span class="main">|</span> <span class="bound">xs</span> <span class="main">.</span> True<span class="main">}</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> <span class="main">{</span>Times <span class="main">(</span>derivs <span class="bound">ys</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">|</span> <span class="bound">ys</span><span class="main">.</span> True<span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">r'</span><span class="main">.</span> <span class="bound">r'</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">ys</span><span class="main">.</span> toplevel_summands <span class="main">(</span>derivs <span class="bound">ys</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ACI_norm_flatten<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">rule</span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="bound"><span class="bound">X</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">∃</span></span><span class="bound"><span class="bound">xs</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">X</span></span> <span class="main"><span class="main">⊆</span></span> ACI_norm <span class="main"><span class="main">`</span></span> <span class="var"><span class="var">?X</span></span> <span class="bound"><span class="bound">xs</span></span><span class="main"><span class="main">}</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"flatten PLUS"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">X</span><span class="main">.</span> <span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">X</span> <span class="main">⊆</span> ACI_norm <span class="main">`</span> <span class="var">?X</span> <span class="bound">xs</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fin <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_Un <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Times<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">r</span><span class="main">.</span> Times <span class="bound">r</span> <span class="main">«</span><span class="skolem">s</span><span class="main">»</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> toplevel_summands_derivs_Times<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> imageI<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="bound">r'</span><span class="main">.</span> Times <span class="bound">r'</span> <span class="main">(</span>Star <span class="main">(</span><span class="bound">f</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Star <span class="skolem">r</span><span class="main">}</span> <span class="main">∪</span> <span class="var">?f</span> id <span class="main">`</span> <span class="main">{</span><span class="bound">r'</span><span class="main">.</span> <span class="bound">r'</span> <span class="main">∈</span> <span class="main">{</span>derivs <span class="bound">ys</span> <span class="skolem">r</span><span class="main">|</span><span class="bound">ys</span><span class="main">.</span> True<span class="main">}</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ACI_norm_flatten<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">rule</span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="bound"><span class="bound">X</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">X</span></span> <span class="main"><span class="main">⊆</span></span> ACI_norm <span class="main"><span class="main">`</span></span> <span class="var"><span class="var">?X</span></span><span class="main"><span class="main">}</span></span>"</span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"flatten PLUS"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> ACI_norm <span class="main">`</span> <span class="var">?f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> <span class="bound">X</span> <span class="main">=</span> <span class="var">?f</span> ACI_norm <span class="main">`</span> ACI_norm <span class="main">`</span> <span class="bound">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">⊆</span> ACI_norm <span class="main">`</span> <span class="var">?X</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_Collect_subsets<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> * <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_imageI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> ACI_norm"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ Star<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> toplevel_summands_derivs_Star<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> imageI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Deriving preserves ACI-equivalence›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ACI_norm_PLUS<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="bound">r</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span><span class="bound">s</span><span class="main">»</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span> <span class="main">«</span>PLUS <span class="free">xs</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span>PLUS <span class="free">ys</span><span class="main">»</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_all2_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> list_all2_lengthD<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> toplevel_summands_ACI_norm_deriv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">a</span><span class="main">∈</span>toplevel_summands <span class="free">r</span><span class="main">.</span> toplevel_summands <span class="main">«</span>deriv <span class="free">as</span> <span class="main">«</span><span class="bound">a</span><span class="main">»</span><span class="main">»</span><span class="main">)</span> <span class="main">=</span> toplevel_summands <span class="main">«</span>deriv <span class="free">as</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span><span class="main">»</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> toplevel_summands.simps toplevel_summands_ACI_norm
     toplevel_summands_deriv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">»</span>"</span></span><span class="main">]</span> image_Un Union_Un_distrib
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_UN<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> toplevel_summands_nullable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nullable <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">∈</span>toplevel_summands <span class="free">s</span><span class="main">.</span> nullable <span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nullable_PLUS<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nullable <span class="main">(</span>PLUS <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> nullable <span class="bound">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> ACI_norm_nullable<span class="main">:</span> <span class="quoted"><span class="quoted">"nullable <span class="main">«</span><span class="free">r</span><span class="main">»</span> <span class="main">=</span> nullable <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> toplevel_summands_nullable
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nullable_PLUS<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> ACI_norm_deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">«</span>deriv <span class="free">as</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span>deriv <span class="free">as</span> <span class="free">r</span><span class="main">»</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> deriv.simps ACI_norm_flatten<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"deriv <span class="skolem">as</span> <span class="main">«</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">»</span>"</span></span><span class="main">]</span>
     toplevel_summands_deriv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">as</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">»</span>"</span></span><span class="main">]</span> image_Un image_UN
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toplevel_summands_ACI_norm toplevel_summands_flatten_ACI_norm_image_Union<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toplevel_summands_ACI_norm<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> toplevel_summands_ACI_norm_deriv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ACI_norm_nullable<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> deriv_preserves<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">r</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span><span class="free">s</span><span class="main">»</span> <span class="main">⟹</span> <span class="main">«</span>deriv <span class="free">as</span> <span class="free">r</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span>deriv <span class="free">as</span> <span class="free">s</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ ACI_norm_deriv ACI_norm_deriv<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">erule</span> arg_cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> derivs_snoc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"derivs <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span>deriv <span class="free">x</span> <span class="main">(</span>derivs <span class="free">xs</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> ACI_norm_derivs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">«</span>derivs <span class="free">xs</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span>derivs <span class="free">xs</span> <span class="free">r</span><span class="main">»</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ACI_norm_deriv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"derivs <span class="skolem">xs</span> <span class="skolem">r</span>"</span></span><span class="main">]</span> ACI_norm_deriv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"derivs <span class="skolem">xs</span> <span class="main">«</span><span class="skolem">r</span><span class="main">»</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Alternative ACI defintions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Not necessary but conceptually nicer (and seems also to be faster?!)›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ACI_nPlus</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ACI_nPlus</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free">ACI_nPlus</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="main">(</span><span class="free">ACI_nPlus</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ACI_nPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="keyword1">then</span> Plus <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="keyword1">then</span> Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span>
  <span class="keyword1">else</span> Plus <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main">(</span><span class="free">ACI_nPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ACI_nPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
  <span class="keyword1">else</span> Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">ACI_norm_alt</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">ACI_norm_alt</span> Zero <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ACI_norm_alt</span> One <span class="main">=</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ACI_norm_alt</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ACI_norm_alt</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> ACI_nPlus <span class="main">(</span><span class="free">ACI_norm_alt</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">ACI_norm_alt</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ACI_norm_alt</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Times <span class="main">(</span><span class="free">ACI_norm_alt</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">ACI_norm_alt</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ACI_norm_alt</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Star <span class="main">(</span><span class="free">ACI_norm_alt</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> toplevel_summands_ACI_nPlus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"toplevel_summands <span class="main">(</span>ACI_nPlus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> toplevel_summands <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ACI_nPlus.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> toplevel_summands_ACI_norm_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"toplevel_summands <span class="main">(</span>ACI_norm_alt <span class="free">r</span><span class="main">)</span> <span class="main">=</span> ACI_norm_alt <span class="main">`</span> toplevel_summands <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toplevel_summands_ACI_nPlus<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ACI_norm_alt_Plus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ACI_norm_alt <span class="free">r</span> <span class="main">=</span> Plus <span class="free">s</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> <span class="free">r</span> <span class="main">=</span> Plus <span class="bound">s</span> <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> toplevel_summands_flatten_ACI_norm_alt_image<span class="main">:</span>
  <span class="quoted"><span class="quoted">"toplevel_summands <span class="main">(</span>flatten PLUS <span class="main">(</span>ACI_norm_alt <span class="main">`</span> toplevel_summands <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ACI_norm_alt <span class="main">`</span> toplevel_summands <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> toplevel_summands_flatten<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ACI_norm_alt_Plus <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Plus_toplevel_summands<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ACI_norm_ACI_norm_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">«</span>ACI_norm_alt <span class="free">r</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ACI_norm_flatten <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> ACI_norm_flatten <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> toplevel_summands_ACI_nPlus<span class="main">)</span>
      <span class="main">(</span><span class="operator">metis</span> ACI_norm_flatten Plus.IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Plus.IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> image_Un toplevel_summands.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> toplevel_summands_ACI_nPlus toplevel_summands_ACI_norm<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ACI_nPlus_singleton_PLUS<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> sorted <span class="free">xs</span><span class="main">;</span> distinct <span class="free">xs</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Plus <span class="bound">r</span> <span class="bound">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
  ACI_nPlus <span class="free">x</span> <span class="main">(</span>PLUS <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="keyword1">then</span> PLUS <span class="free">xs</span> <span class="keyword1">else</span> PLUS <span class="main">(</span>insort <span class="free">x</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>single <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main">)</span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ACI_nPlus.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons <span class="skolem">y1</span> <span class="skolem">y2</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> ACI_nPlus_PLUS<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">xs1</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> <span class="free">xs2</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">xs1</span> <span class="main">@</span> <span class="free">xs2</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Plus <span class="bound">r</span> <span class="bound">s</span><span class="main">)</span><span class="main">;</span> sorted <span class="free">xs2</span><span class="main">;</span> distinct <span class="free">xs2</span><span class="main">⟧</span><span class="main">⟹</span>
  ACI_nPlus <span class="main">(</span>PLUS <span class="free">xs1</span><span class="main">)</span> <span class="main">(</span>PLUS <span class="free">xs2</span><span class="main">)</span> <span class="main">=</span> flatten PLUS <span class="main">(</span>set <span class="main">(</span><span class="free">xs1</span> <span class="main">@</span> <span class="free">xs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>single <span class="skolem">x1</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ACI_nPlus_singleton_PLUS<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sorted_list_of_set_insert<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> insert_absorb<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set finite_sorted_distinct_unique sorted_list_of_set<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">PLUS</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> remdups_id_iff_distinct sorted_list_of_set_sort_remdups sorted_sort_id<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons <span class="skolem">x11</span> <span class="skolem">x12</span> <span class="skolem">xs1</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sorted_list_of_set_insert<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ACI_nPlus_singleton_PLUS<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sorted_list_of_set_insert <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">x11</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_insert_left<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">x11</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> insert_absorb<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_insert_right<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">x11</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> insert_absorb<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">x12</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> ACI_nPlus_flatten_PLUS<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">X1</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">;</span> <span class="free">X2</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">;</span> finite <span class="free">X1</span><span class="main">;</span> finite <span class="free">X2</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X1</span> <span class="main">∪</span> <span class="free">X2</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> Plus <span class="bound">r</span> <span class="bound">s</span><span class="main">)</span><span class="main">⟧</span><span class="main">⟹</span>
  ACI_nPlus <span class="main">(</span>flatten PLUS <span class="free">X1</span><span class="main">)</span> <span class="main">(</span>flatten PLUS <span class="free">X2</span><span class="main">)</span> <span class="main">=</span> flatten PLUS <span class="main">(</span><span class="free">X1</span> <span class="main">∪</span> <span class="free">X2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ACI_nPlus_PLUS<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ACI_nPlus_ACI_norm <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ACI_nPlus <span class="main">«</span><span class="free">r</span><span class="main">»</span> <span class="main">«</span><span class="free">s</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_Un Un_assoc ACI_norm_flatten <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span><span class="main"><span class="main">]</span></span> ACI_norm_flatten <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="main">]</span></span> ACI_norm_flatten <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Plus <span class="free">r</span> <span class="free">s</span>"</span></span><span class="main"><span class="main">]</span></span>
    toplevel_summands_flatten_ACI_norm_image
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> ACI_nPlus_flatten_PLUS<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">metis</span> ACI_norm_Plus Plus_toplevel_summands<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ACI_norm_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ACI_norm_alt <span class="free">r</span> <span class="main">=</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> ACI_norm_alt<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">ACI</span> <span class="keyword2"><span class="keyword">where</span></span>
  ACI_refl<span class="main">:</span>       <span class="quoted"><span class="quoted">"<span class="free">ACI</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span> <span class="main">|</span>
  ACI_sym<span class="main">:</span>        <span class="quoted"><span class="quoted">"<span class="free">ACI</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">ACI</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span> <span class="main">|</span>
  ACI_trans<span class="main">:</span>      <span class="quoted"><span class="quoted">"<span class="free">ACI</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">ACI</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟹</span> <span class="free">ACI</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
  ACI_Plus_cong<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">ACI</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">;</span> <span class="free">ACI</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">ACI</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  ACI_Times_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">ACI</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">;</span> <span class="free">ACI</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">ACI</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  ACI_Star_cong<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">ACI</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟹</span> <span class="free">ACI</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  ACI_assoc<span class="main">:</span>      <span class="quoted"><span class="quoted">"<span class="free">ACI</span> <span class="main">(</span>Plus <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  ACI_comm<span class="main">:</span>       <span class="quoted"><span class="quoted">"<span class="free">ACI</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  ACI_idem<span class="main">:</span>       <span class="quoted"><span class="quoted">"<span class="free">ACI</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ACI_atoms<span class="main">:</span> <span class="quoted"><span class="quoted">"ACI <span class="free">r</span> <span class="free">s</span> <span class="main">⟹</span> atoms <span class="free">r</span> <span class="main">=</span> atoms <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ACI.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ACI_nullable<span class="main">:</span> <span class="quoted"><span class="quoted">"ACI <span class="free">r</span> <span class="free">s</span> <span class="main">⟹</span> nullable <span class="free">r</span> <span class="main">=</span> nullable <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ACI.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ACI_lang<span class="main">:</span> <span class="quoted"><span class="quoted">"ACI <span class="free">r</span> <span class="free">s</span> <span class="main">⟹</span> lang <span class="free">r</span> <span class="main">=</span> lang <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ACI.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ACI_deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"ACI <span class="free">r</span> <span class="free">s</span> <span class="main">⟹</span> ACI <span class="main">(</span>deriv <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>deriv <span class="free">a</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ACI.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ACI_Times_cong <span class="skolem">r1</span> <span class="skolem">s1</span> <span class="skolem">r2</span> <span class="skolem">s2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ACI.intros <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ACI_nullable<span class="main">)</span>
      <span class="main">(</span><span class="operator">metis</span> ACI.ACI_Times_cong ACI_Plus_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ACI.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ACI_Plus_assocI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ACI <span class="main">(</span>Plus <span class="free">r1</span> <span class="free">r2</span><span class="main">)</span> <span class="free">s2</span> <span class="main">⟹</span> ACI <span class="main">(</span>Plus <span class="free">r1</span> <span class="main">(</span>Plus <span class="free">s1</span> <span class="free">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Plus <span class="free">s1</span> <span class="free">s2</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"ACI <span class="main">(</span>Plus <span class="free">r1</span> <span class="free">r2</span><span class="main">)</span> <span class="free">s2</span> <span class="main">⟹</span> ACI <span class="main">(</span>Plus <span class="free">r1</span> <span class="main">(</span>Plus <span class="free">r2</span> <span class="free">s1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Plus <span class="free">s1</span> <span class="free">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ACI_assoc ACI_comm ACI_Plus_cong ACI_refl ACI_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ACI_Plus_idemI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>ACI <span class="free">r</span> <span class="free">s1</span><span class="main">;</span> ACI <span class="free">r</span> <span class="free">s2</span><span class="main">⟧</span> <span class="main">⟹</span> ACI <span class="free">r</span> <span class="main">(</span>Plus <span class="free">s1</span> <span class="free">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ACI_Plus_cong ACI_idem ACI_sym ACI_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ACI_Plus_idemI'<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>ACI <span class="free">r1</span> <span class="free">s1</span><span class="main">;</span> ACI <span class="main">(</span>Plus <span class="free">r1</span> <span class="free">r2</span><span class="main">)</span> <span class="free">s2</span><span class="main">⟧</span> <span class="main">⟹</span> ACI <span class="main">(</span>Plus <span class="free">r1</span> <span class="free">r2</span><span class="main">)</span> <span class="main">(</span>Plus <span class="free">s1</span> <span class="free">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ACI_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ACI_Plus_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ACI_sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ACI_idem<span class="main"><span class="main">]</span></span> ACI_refl<span class="main"><span class="main">]</span></span>
             ACI_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ACI_assoc ACI_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ACI_Plus_cong ACI_refl<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ACI_ACI_nPlus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>ACI <span class="free">r1</span> <span class="free">s1</span><span class="main">;</span> ACI <span class="free">r2</span> <span class="free">s2</span><span class="main">⟧</span> <span class="main">⟹</span> ACI <span class="main">(</span>ACI_nPlus <span class="free">r1</span> <span class="free">r2</span><span class="main">)</span> <span class="main">(</span>Plus <span class="free">s1</span> <span class="free">s2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r1</span></span> <span class="quoted"><span class="free">r2</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">s2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ACI_nPlus.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ACI_refl 1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> ACI_refl 1<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> 1<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ACI_comm ACI_trans<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"2_1"</span> <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ACI_Plus_cong<span class="main">[</span><span class="operator">OF</span> ACI_refl <span class="quoted">"2_1"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ <span class="quoted">"2_1"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ACI_refl<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">r1</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ACI.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"2_2"</span> <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ACI_Plus_cong<span class="main">[</span><span class="operator">OF</span> ACI_refl <span class="quoted">"2_2"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ <span class="quoted">"2_2"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ACI_refl<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">r1</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ACI.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"2_3"</span> _ <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ACI_Plus_cong<span class="main">[</span><span class="operator">OF</span> ACI_refl <span class="quoted">"2_3"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ <span class="quoted">"2_3"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ACI_refl<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">r1</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ACI.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"2_4"</span> _ _ <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ACI_Plus_cong<span class="main">[</span><span class="operator">OF</span> ACI_refl <span class="quoted">"2_4"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ <span class="quoted">"2_4"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ACI_refl<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">r1</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ACI.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span><span class="quoted">"2_5"</span> _ <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ACI_Plus_cong<span class="main">[</span><span class="operator">OF</span> ACI_refl <span class="quoted">"2_5"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ <span class="quoted">"2_5"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ACI_refl<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">r1</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ACI.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ACI.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ACI_ACI_norm<span class="main">:</span> <span class="quoted"><span class="quoted">"ACI <span class="main">«</span><span class="free">r</span><span class="main">»</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ACI_norm_alt<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ACI.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ACI_ACI_nPlus<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ACI_norm_eqI<span class="main">:</span> <span class="quoted"><span class="quoted">"ACI <span class="free">r</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span><span class="free">s</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ACI.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> toplevel_summands_ACI_norm ACI_norm_flatten<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
    toplevel_summands_flatten_ACI_norm_image_Union <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ACI_I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">r</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span><span class="free">s</span><span class="main">»</span> <span class="main">⟹</span> ACI <span class="free">r</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ACI_ACI_norm ACI_sym ACI_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ACI_decidable<span class="main">:</span> <span class="quoted"><span class="quoted">"ACI <span class="free">r</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">«</span><span class="free">r</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span><span class="free">s</span><span class="main">»</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ACI_I ACI_norm_eqI<span class="main">)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Deriv_PDeriv">
<div class="head">
<h1>Theory Deriv_PDeriv</h1>
</div>
<pre class="source"><span class="comment1">(*  Author: Tobias Nipkow, Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Connection Between Derivatives and Partial Derivatives"</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Deriv_PDeriv
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Derivatives_Finite.html">Derivatives_Finite</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">lemma</span></span> pderiv_not_is_Zero_is_Plus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> pderiv <span class="free">a</span> <span class="free">r</span><span class="main">.</span> <span class="main">¬</span> is_Zero <span class="bound">x</span> <span class="main">∧</span> <span class="main">¬</span> is_Plus <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_pderiv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pderiv <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> PLUS_inject<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">ys</span><span class="main">.</span> <span class="main">¬</span> is_Zero <span class="bound">x</span> <span class="main">∧</span> <span class="main">¬</span> is_Plus <span class="bound">x</span><span class="main">;</span> sorted <span class="free">xs</span><span class="main">;</span> sorted <span class="free">ys</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span>PLUS <span class="free">xs</span> <span class="main">=</span> PLUS <span class="free">ys</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> nil <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> single <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> cons <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_list_of_set_inject<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>finite <span class="free">R</span><span class="main">;</span> finite <span class="free">S</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span>sorted_list_of_set <span class="free">R</span> <span class="main">=</span> sorted_list_of_set <span class="free">S</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">R</span> <span class="main">=</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">R</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_linorder_min_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_linorder_min_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">b</span> <span class="skolem">S</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> insort_not_Nil<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">R</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>4<span class="main">,</span>1-3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_linorder_min_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">b</span> <span class="skolem">S</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">R</span><span class="main">)</span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span>insert <span class="skolem">b</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> insert<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insort <span class="skolem">a</span> <span class="main">(</span>sorted_list_of_set <span class="skolem">R</span><span class="main">)</span> <span class="main">=</span> insort <span class="skolem">b</span> <span class="main">(</span>sorted_list_of_set <span class="skolem">S</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ sorted_list_of_set.insert sorted_list_of_set.insert<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> insert<span class="main">(</span>2<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">#</span> sorted_list_of_set <span class="skolem">R</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">#</span> sorted_list_of_set <span class="skolem">S</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="skolem">R</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="skolem">S</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> list.exhaust<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> insort_not_Nil <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">using</span></span> insert.prems<span class="main">(</span>1<span class="main">)</span> set_sorted_list_of_set <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">using</span></span> insert.prems<span class="main">(</span>1<span class="main">)</span> set_sorted_list_of_set <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">using</span></span> insert.prems<span class="main">(</span>1<span class="main">)</span> set_sorted_list_of_set <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">using</span></span> insert.hyps<span class="main">(</span>1<span class="main">)</span> set_sorted_list_of_set <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">using</span></span> insert.hyps<span class="main">(</span>1<span class="main">)</span> set_sorted_list_of_set <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">using</span></span> insert.hyps<span class="main">(</span>1<span class="main">)</span> set_sorted_list_of_set <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">using</span></span> insert.hyps<span class="main">(</span>1<span class="main">)</span> set_sorted_list_of_set <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">using</span></span> insert.hyps<span class="main">(</span>1<span class="main">)</span> set_sorted_list_of_set <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">with</span></span> insert <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">a</span> <span class="skolem">R</span> <span class="main">=</span> insert <span class="skolem">b</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">a</span> <span class="skolem">R</span> <span class="main">=</span> insert <span class="skolem">b</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="main">(</span>insert <span class="skolem">a</span> <span class="skolem">R</span><span class="main">)</span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span>insert <span class="skolem">b</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flatten_PLUS_inject<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∪</span> <span class="free">S</span><span class="main">.</span> <span class="main">¬</span> is_Zero <span class="bound">x</span> <span class="main">∧</span> <span class="main">¬</span> is_Plus <span class="bound">x</span><span class="main">;</span> finite <span class="free">R</span><span class="main">;</span> finite <span class="free">S</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span>flatten PLUS <span class="free">R</span> <span class="main">=</span> flatten PLUS <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">R</span> <span class="main">=</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> PLUS_inject sorted_list_of_set_inject<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">pset</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pset</span> Zero <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pset</span> One <span class="main">=</span> <span class="main">{</span>One<span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pset</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pset</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">pset</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∪</span> <span class="free">pset</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pset</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Timess <span class="main">(</span><span class="free">pset</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pset</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pset_not_is_Zero_is_Plus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> pset <span class="free">r</span><span class="main">.</span> <span class="main">¬</span> is_Zero <span class="bound">x</span> <span class="main">∧</span> <span class="main">¬</span> is_Plus <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_pset<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pset <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> pset_deriv<span class="main">:</span> <span class="quoted"><span class="quoted">"pset <span class="main">(</span>deriv <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> pderiv <span class="free">a</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pnorm</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pnorm</span> <span class="main">=</span> flatten PLUS <span class="keyword1">o</span> pset"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pnorm_deriv_eq_iff_pderiv_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pnorm <span class="main">(</span>deriv <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> pnorm <span class="main">(</span>deriv <span class="free">a</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> pderiv <span class="free">a</span> <span class="free">r</span> <span class="main">=</span> pderiv <span class="free">a</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pnorm_def o_apply pset_deriv
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> flatten_PLUS_inject<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pnPlus</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pnPlus</span> Zero <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> Zero <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnPlus</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free">pnPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free">pnPlus</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> le_rexp <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
     <span class="keyword1">else</span> Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free">pnPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnPlus</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
      <span class="keyword1">else</span> <span class="keyword1">if</span> le_rexp <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
      <span class="keyword1">else</span> Plus <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pnTimes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pnTimes</span> Zero <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnTimes</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> pnPlus <span class="main">(</span><span class="free">pnTimes</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">pnTimes</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnTimes</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">pnorm_alt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pnorm_alt</span> Zero <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnorm_alt</span> One <span class="main">=</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnorm_alt</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnorm_alt</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> pnPlus <span class="main">(</span><span class="free">pnorm_alt</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">pnorm_alt</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnorm_alt</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> pnTimes <span class="main">(</span><span class="free">pnorm_alt</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnorm_alt</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Star <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pset_pnPlus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pset <span class="main">(</span>pnPlus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> pset <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pnPlus.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> pset_pnTimes<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pset <span class="main">(</span>pnTimes <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> pset <span class="main">(</span>Times <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pnTimes.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pset_pnPlus<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pset_pnorm_alt_Times<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> pset <span class="free">r</span> <span class="main">⟹</span> pnTimes <span class="main">(</span>pnorm_alt <span class="free">s</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Times <span class="main">(</span>pnorm_alt <span class="free">s</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> pset_pnorm_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pset <span class="main">(</span>pnorm_alt <span class="free">r</span><span class="main">)</span> <span class="main">=</span> pnorm_alt <span class="main">`</span> pset <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pset_pnPlus pset_pnTimes pset_pnorm_alt_Times image_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pset_pnTimes_Times<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> pset <span class="free">r</span> <span class="main">⟹</span> pnTimes <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> Times <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> pset_pnorm_alt_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> pset <span class="free">r</span> <span class="main">⟹</span> pnorm_alt <span class="free">s</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pset_pnTimes_Times<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pnorm_alt_image_pset<span class="main">:</span> <span class="quoted"><span class="quoted">"pnorm_alt <span class="main">`</span> pset <span class="free">r</span> <span class="main">=</span> pset <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pset_pnorm_alt_id pset_pnTimes_Times image_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pnorm_pnorm_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"pnorm <span class="main">(</span>pnorm_alt <span class="free">r</span><span class="main">)</span> <span class="main">=</span> pnorm <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pnorm_def pset_pnPlus pset_pnTimes pset_pnorm_alt pnorm_alt_image_pset<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pnPlus_singleton_PLUS<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> sorted <span class="free">xs</span><span class="main">;</span> distinct <span class="free">xs</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">¬</span>is_Zero <span class="bound">x</span> <span class="main">∧</span> <span class="main">¬</span>is_Plus <span class="bound">x</span><span class="main">⟧</span> <span class="main">⟹</span>
  pnPlus <span class="free">x</span> <span class="main">(</span>PLUS <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="keyword1">then</span> PLUS <span class="free">xs</span> <span class="keyword1">else</span> PLUS <span class="main">(</span>insort <span class="free">x</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>single <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_Zero_def is_Plus_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pnPlus.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_rexp_def less_eq_rexp_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pnPlus.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_rexp_def less_eq_rexp_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pnPlus.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_rexp_def less_eq_rexp_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons <span class="skolem">y1</span> <span class="skolem">y2</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_Zero_def is_Plus_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> UnCI insertI1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> antisym less_eq_rexp_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> antisym less_eq_rexp_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> UnCI insertI1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> antisym less_eq_rexp_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> antisym less_eq_rexp_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> pnPlus_PlusL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Zero <span class="main">⟹</span> pnPlus <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> pnPlus <span class="free">r</span> <span class="main">(</span>pnPlus <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> pnPlus_ZeroR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pnPlus <span class="free">r</span> Zero <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> PLUS_eq_Zero<span class="main">:</span> <span class="quoted"><span class="quoted">"PLUS <span class="free">xs</span> <span class="main">=</span> Zero <span class="main">⟷</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[</span>Zero<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> pnPlus_PLUS<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">xs1</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> <span class="free">xs2</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">xs1</span> <span class="main">@</span> <span class="free">xs2</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>is_Zero <span class="bound">x</span> <span class="main">∧</span> <span class="main">¬</span>is_Plus <span class="bound">x</span><span class="main">;</span> sorted <span class="free">xs2</span><span class="main">;</span> distinct <span class="free">xs2</span><span class="main">⟧</span><span class="main">⟹</span>
  pnPlus <span class="main">(</span>PLUS <span class="free">xs1</span><span class="main">)</span> <span class="main">(</span>PLUS <span class="free">xs2</span><span class="main">)</span> <span class="main">=</span> flatten PLUS <span class="main">(</span>set <span class="main">(</span><span class="free">xs1</span> <span class="main">@</span> <span class="free">xs2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>single <span class="skolem">x1</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pnPlus_singleton_PLUS<span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insert_absorb <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sorted_list_of_set_insert<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set finite_sorted_distinct_unique sorted_list_of_set<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">PLUS</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> remdups_id_iff_distinct sorted_list_of_set_sort_remdups sorted_sort_id<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons <span class="skolem">x11</span> <span class="skolem">x12</span> <span class="skolem">xs1</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> rexp_of_list.simps
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> pnPlus_PlusL<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> PLUS_eq_Zero<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_decomp rexp.disc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> cons<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sorted_list_of_set_insert<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pnPlus_singleton_PLUS<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_insort set_insort_key <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sorted_list_of_set_insert<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command">unfolding</span></span> insert_commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x11</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_insert_left<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">x11</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> insert_absorb<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Un_insert_right<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">x11</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> insert_absorb<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> pnPlus_flatten_PLUS<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">X1</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">;</span> <span class="free">X2</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">;</span> finite <span class="free">X1</span><span class="main">;</span> finite <span class="free">X2</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X1</span> <span class="main">∪</span> <span class="free">X2</span><span class="main">.</span>  <span class="main">¬</span>is_Zero <span class="bound">x</span> <span class="main">∧</span> <span class="main">¬</span>is_Plus <span class="bound">x</span><span class="main">⟧</span><span class="main">⟹</span>
  pnPlus <span class="main">(</span>flatten PLUS <span class="free">X1</span><span class="main">)</span> <span class="main">(</span>flatten PLUS <span class="free">X2</span><span class="main">)</span> <span class="main">=</span> flatten PLUS <span class="main">(</span><span class="free">X1</span> <span class="main">∪</span> <span class="free">X2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pnPlus_PLUS<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> pnPlus_pnorm<span class="main">:</span> <span class="quoted"><span class="quoted">"pnPlus <span class="main">(</span>pnorm <span class="free">r</span><span class="main">)</span> <span class="main">(</span>pnorm <span class="free">s</span><span class="main">)</span> <span class="main">=</span> pnorm <span class="main">(</span>Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"pset <span class="free">r</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> pset <span class="free">s</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pnorm_def pset_pnPlus pset_pnorm_alt <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pnPlus_flatten_PLUS<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pnTimes_not_Zero_or_Plus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">¬</span> is_Zero <span class="free">x</span><span class="main">;</span> <span class="main">¬</span> is_Plus <span class="free">x</span><span class="main">⟧</span> <span class="main">⟹</span> pnTimes <span class="free">x</span> <span class="free">r</span> <span class="main">=</span> Times <span class="free">x</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> pnTimes_PLUS<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">¬</span>is_Zero <span class="bound">x</span> <span class="main">∧</span> <span class="main">¬</span>is_Plus <span class="bound">x</span><span class="main">⟧</span><span class="main">⟹</span>
  pnTimes <span class="main">(</span>PLUS <span class="free">xs</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> flatten PLUS <span class="main">(</span>Timess <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_singleton_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> rexp_of_list.simps pnTimes.simps
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> pnTimes_not_Zero_or_Plus<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_insort set_insort_key <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sorted_list_of_set_insert<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> pnPlus_singleton_PLUS<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_insort set_insort_key <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sorted_list_of_set_insert<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> insert_commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Times <span class="skolem">y</span> <span class="skolem">r</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sorted_list_of_set_insert<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> insert_absorb<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"Times <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">r</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> pnTimes_flatten_PLUS<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">X1</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">;</span> finite <span class="free">X1</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X1</span><span class="main">.</span> <span class="main">¬</span>is_Zero <span class="bound">x</span> <span class="main">∧</span> <span class="main">¬</span>is_Plus <span class="bound">x</span><span class="main">⟧</span><span class="main">⟹</span>
  pnTimes <span class="main">(</span>flatten PLUS <span class="free">X1</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> flatten PLUS <span class="main">(</span>Timess <span class="free">X1</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pnTimes_PLUS<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> pnTimes_pnorm<span class="main">:</span> <span class="quoted"><span class="quoted">"pnTimes <span class="main">(</span>pnorm <span class="free">r1</span><span class="main">)</span> <span class="free">r2</span> <span class="main">=</span> pnorm <span class="main">(</span>Times <span class="free">r1</span> <span class="free">r2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"pset <span class="free">r1</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pnorm_def pset_pnTimes pset_pnorm_alt <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pnTimes_flatten_PLUS<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pnorm_alt<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pnorm_alt <span class="free">r</span> <span class="main">=</span> pnorm <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> pnorm_alt.simps pnPlus_pnorm pnTimes_pnorm<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pnorm_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> insort_eq_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="bound">a</span><span class="main">;</span> sorted <span class="free">xs</span><span class="main">⟧</span> <span class="main">⟹</span> insort <span class="free">b</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">b</span> <span class="main">#</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> pderiv_PLUS<span class="main">:</span> <span class="quoted"><span class="quoted">"pderiv <span class="free">a</span> <span class="main">(</span>PLUS <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> pderiv <span class="free">a</span> <span class="free">x</span> <span class="main">∪</span> pderiv <span class="free">a</span> <span class="main">(</span>PLUS <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> pderiv_set_flatten_PLUS<span class="main">:</span>
   <span class="quoted"><span class="quoted">"finite <span class="free">X</span> <span class="main">⟹</span> pderiv <span class="main">(</span><span class="free">a</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> <span class="main">(</span>flatten PLUS <span class="free">X</span><span class="main">)</span> <span class="main">=</span> pderiv_set <span class="free">a</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_linorder_min_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">b</span> <span class="skolem">X</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pderiv <span class="free">a</span> <span class="main">(</span>flatten PLUS <span class="main">(</span>insert <span class="skolem">b</span> <span class="skolem">X</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> pderiv <span class="free">a</span> <span class="skolem">b</span> <span class="main">∪</span> pderiv <span class="free">a</span> <span class="main">(</span>flatten PLUS <span class="skolem">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pderiv_PLUS insort_eq_Cons insert.hyps<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> insert.IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> pderiv <span class="free">a</span> <span class="skolem">b</span> <span class="main">∪</span> pderiv_set <span class="free">a</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> fold_pderiv_set_flatten_PLUS<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">w</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> finite <span class="free">X</span><span class="main">⟧</span> <span class="main">⟹</span> fold pderiv_set <span class="free">w</span> <span class="main">{</span>flatten PLUS <span class="free">X</span><span class="main">}</span> <span class="main">=</span> fold pderiv_set <span class="free">w</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">X</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pderiv_set_flatten_PLUS<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fold_pnorm_deriv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> pnorm <span class="main">(</span>deriv <span class="bound">a</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="free">s</span> <span class="main">=</span> flatten PLUS <span class="main">(</span>fold pderiv_set <span class="free">w</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">w</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> fold_pderiv_set_flatten_PLUS<span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span> Cons.IH
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pnorm_def pset_deriv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pnorm_def pset_deriv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">pnderiv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder <span class="main">⇒</span> <span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> rexp"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pnderiv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Zero<span class="main">)</span> <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnderiv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>One<span class="main">)</span> <span class="main">=</span> Zero"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnderiv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="keyword1">then</span> One <span class="keyword1">else</span> Zero<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnderiv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> pnPlus <span class="main">(</span><span class="free">pnderiv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">pnderiv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnderiv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="keyword1">if</span> nullable <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="keyword1">then</span> pnPlus <span class="main">(</span>pnTimes <span class="main">(</span><span class="free">pnderiv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">pnderiv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span> <span class="keyword1">else</span> pnTimes <span class="main">(</span><span class="free">pnderiv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnderiv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> pnTimes <span class="main">(</span><span class="free">pnderiv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pnderiv_alt<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pnderiv <span class="free">a</span> <span class="free">r</span> <span class="main">=</span> pnorm <span class="main">(</span>deriv <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pnorm_alt<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pnderiv_pderiv<span class="main">:</span> <span class="quoted"><span class="quoted">"pnderiv <span class="free">a</span> <span class="free">r</span> <span class="main">=</span> flatten PLUS <span class="main">(</span>pderiv <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pnderiv_alt pnorm_def o_apply pset_deriv <span class="keyword1"><span class="command">..</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Deriv_Autos">
<div class="head">
<h1>Theory Deriv_Autos</h1>
</div>
<pre class="source"><span class="comment1">(*  Author: Tobias Nipkow, Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Framework Instantiations using (Partial) Derivatives"</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Deriv_Autos
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Automaton.html">Automaton</a>
  <span class="quoted">"<a href="../Regular-Sets/NDerivative.html">Regular-Sets.NDerivative</a>"</span>
  <a href="Deriv_PDeriv.html">Deriv_PDeriv</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Brzozowski Derivatives Modulo ACI›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ACI_norm_derivs_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">«</span>derivs <span class="free">w</span> <span class="free">r</span><span class="main">»</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> <span class="main">«</span>deriv <span class="bound">a</span> <span class="bound">r</span><span class="main">»</span><span class="main">)</span> <span class="free">w</span> <span class="main">«</span><span class="free">r</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ACI_norm_deriv<span class="main">)</span>

<span class="keyword1"><span class="command">global_interpretation</span></span> brzozowski<span class="main">:</span> rexp_DFA <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">«</span><span class="bound">r</span><span class="main">»</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="bound">r</span><span class="main">.</span> <span class="main">«</span>deriv <span class="bound">a</span> <span class="bound">r</span><span class="main">»</span>"</span></span> <span class="quoted">nullable</span> <span class="quoted">lang</span>
  <span class="keyword2"><span class="keyword">defines</span></span> brzozowski_closure <span class="main">=</span> <span class="quoted">brzozowski.closure</span>
    <span class="keyword2"><span class="keyword">and</span></span> check_eqv_brz <span class="main">=</span> <span class="quoted">brzozowski.check_eqv</span>
    <span class="keyword2"><span class="keyword">and</span></span> reachable_brz <span class="main">=</span> <span class="quoted">brzozowski.reachable</span>
    <span class="keyword2"><span class="keyword">and</span></span> automaton_brz <span class="main">=</span> <span class="quoted">brzozowski.automaton</span>
    <span class="keyword2"><span class="keyword">and</span></span> match_brz <span class="main">=</span> <span class="quoted">brzozowski.match</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lang_ACI_norm<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lang_ACI_norm lang_deriv<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nullable_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ACI_norm_derivs_alt<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> finite_derivs<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Brzozowski Derivatives Modulo ACI Operating on the Quotient Type›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> derivs_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"derivs <span class="main">=</span> fold deriv"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"derivs <span class="skolem">w</span> <span class="main">=</span> fold deriv <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">functor</span></span> <span class="quoted">map_rexp</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> o_def id_def map_map_rexp map_rexp_ident<span class="main">)</span>

<span class="keyword1"><span class="command">quotient_type</span></span> <span class="tfree">'a</span> ACI_rexp <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp"</span></span> <span class="main">/</span> <span class="quoted">ACI</span>
  <span class="keyword2"><span class="keyword">morphisms</span></span> rep_ACI_rexp ACI_class
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> equivpI reflpI sympI transpI<span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ACI_refl ACI_sym ACI_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> ACI_rexp <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"<span class="main">{</span>equal<span class="main">,</span> linorder<span class="main">}</span>"</span></span><span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>equal<span class="main">,</span> linorder<span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">less_eq_ACI_rexp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ACI_rexp <span class="main">⇒</span> <span class="tfree">'a</span> ACI_rexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> less_eq <span class="main">«</span><span class="bound">r</span><span class="main">»</span> <span class="main">«</span><span class="bound">s</span><span class="main">»</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ACI_decidable<span class="main">)</span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">less_ACI_rexp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ACI_rexp <span class="main">⇒</span> <span class="tfree">'a</span> ACI_rexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> less <span class="main">«</span><span class="bound">r</span><span class="main">»</span> <span class="main">«</span><span class="bound">s</span><span class="main">»</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ACI_decidable<span class="main">)</span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">equal_ACI_rexp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ACI_rexp <span class="main">⇒</span> <span class="tfree">'a</span> ACI_rexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="bound">r</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span><span class="bound">s</span><span class="main">»</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ACI_decidable<span class="main">)</span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ACI_decidable<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> ACI_deriv <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder <span class="main">⇒</span> <span class="tfree">'a</span> ACI_rexp <span class="main">⇒</span> <span class="tfree">'a</span> ACI_rexp"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">deriv</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ACI_deriv<span class="main">)</span>
<span class="keyword1"><span class="command">lift_definition</span></span> ACI_nullable <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder ACI_rexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">nullable</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ACI_nullable<span class="main">)</span>
<span class="keyword1"><span class="command">lift_definition</span></span> ACI_lang <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder ACI_rexp <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">lang</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ACI_lang<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_fun <span class="main">(</span>rel_set <span class="main">(</span>pcr_ACI_rexp <span class="main">(=)</span><span class="main">)</span><span class="main">)</span> <span class="main">(=)</span> <span class="main">(</span>finite <span class="keyword1">o</span> image ACI_norm<span class="main">)</span> finite"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_fun_def rel_set_def cr_ACI_rexp_def ACI_rexp.pcr_cr_eq
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">ACI_class</span><span class="main"><span class="main">]</span></span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"ACI_norm <span class="keyword1">o</span> rep_ACI_rexp"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> ACI_norm_idem ACI_rexp.abs_eq_iff ACI_decidable imageI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ACI_decidable<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ACI_sym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Quotient_rep_abs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Quotient_ACI_rexp<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> ACI_refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> brzozowski_quotient<span class="main">:</span> rexp_DFA <span class="quoted">ACI_class</span> <span class="quoted">ACI_deriv</span> <span class="quoted">ACI_nullable</span> <span class="quoted">ACI_lang</span>
  <span class="keyword2"><span class="keyword">defines</span></span> brzozowski_quotient_closure <span class="main">=</span> <span class="quoted">brzozowski_quotient.closure</span>
    <span class="keyword2"><span class="keyword">and</span></span> check_eqv_brzq <span class="main">=</span> <span class="quoted">brzozowski_quotient.check_eqv</span>
    <span class="keyword2"><span class="keyword">and</span></span> reachable_brzq <span class="main">=</span> <span class="quoted">brzozowski_quotient.reachable</span>
    <span class="keyword2"><span class="keyword">and</span></span> automaton_brzq <span class="main">=</span> <span class="quoted">brzozowski_quotient.automaton</span>
    <span class="keyword2"><span class="keyword">and</span></span> match_brzq <span class="main">=</span> <span class="quoted">brzozowski_quotient.match</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> lang_deriv<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> nullable_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ACI_decidable derivs_alt <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ finite_derivs<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Brzozowski Derivatives Modulo ACI++ (Only Soundness)›</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> nderiv<span class="main">:</span> rexp_DA <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> norm <span class="bound">x</span>"</span></span> <span class="quoted">nderiv</span> <span class="quoted">nullable</span> <span class="quoted">lang</span>
  <span class="keyword2"><span class="keyword">defines</span></span> nderiv_closure <span class="main">=</span> <span class="quoted">nderiv.closure</span>
    <span class="keyword2"><span class="keyword">and</span></span> check_eqv_n <span class="main">=</span> <span class="quoted">nderiv.check_eqv</span>
    <span class="keyword2"><span class="keyword">and</span></span> reachable_n <span class="main">=</span> <span class="quoted">nderiv.reachable</span>
    <span class="keyword2"><span class="keyword">and</span></span> automaton_n <span class="main">=</span> <span class="quoted">nderiv.automaton</span>
    <span class="keyword2"><span class="keyword">and</span></span> match_n <span class="main">=</span> <span class="quoted">nderiv.match</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lang_nderiv<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nullable_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Partial Derivatives›</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> pderiv<span class="main">:</span> rexp_DFA <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">{</span><span class="bound">r</span><span class="main">}</span>"</span></span> <span class="quoted">pderiv_set</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">P</span><span class="main">.</span> <span class="main">∃</span><span class="bound">p</span><span class="main">∈</span><span class="bound">P</span><span class="main">.</span> nullable <span class="bound">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">P</span><span class="main">.</span> <span class="main">⋃</span><span class="main">(</span>lang <span class="main">`</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> pderiv_closure <span class="main">=</span> <span class="quoted">pderiv.closure</span>
    <span class="keyword2"><span class="keyword">and</span></span> check_eqv_p <span class="main">=</span> <span class="quoted">pderiv.check_eqv</span>
    <span class="keyword2"><span class="keyword">and</span></span> reachable_p <span class="main">=</span> <span class="quoted">pderiv.reachable</span>
    <span class="keyword2"><span class="keyword">and</span></span> automaton_p <span class="main">=</span> <span class="quoted">pderiv.automaton</span>
    <span class="keyword2"><span class="keyword">and</span></span> match_p <span class="main">=</span> <span class="quoted">pderiv.match</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Deriv_pderiv<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nullable_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">s</span><span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> pderivs_lang_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold pderiv_set <span class="skolem">w</span> <span class="main">=</span> Union <span class="keyword1">o</span> image <span class="main">(</span>pderivs_lang <span class="main">{</span><span class="skolem">w</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>fold pderiv_set <span class="bound">w</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span> <span class="main">|</span><span class="bound">w</span><span class="main">.</span> True<span class="main">}</span> <span class="main">⊆</span> Pow <span class="main">(</span>pderivs_lang UNIV <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> finite_pderivs_lang<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> pnderiv<span class="main">:</span> rexp_DFA <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span>"</span></span> <span class="quoted">pnderiv</span> <span class="quoted">nullable</span> <span class="quoted">lang</span>
  <span class="keyword2"><span class="keyword">defines</span></span> pnderiv_closure <span class="main">=</span> <span class="quoted">pnderiv.closure</span>
    <span class="keyword2"><span class="keyword">and</span></span> check_eqv_pn <span class="main">=</span> <span class="quoted">pnderiv.check_eqv</span>
    <span class="keyword2"><span class="keyword">and</span></span> reachable_pn <span class="main">=</span> <span class="quoted">pnderiv.reachable</span>
    <span class="keyword2"><span class="keyword">and</span></span> automaton_pn <span class="main">=</span> <span class="quoted">pnderiv.automaton</span>
    <span class="keyword2"><span class="keyword">and</span></span> match_pn <span class="main">=</span> <span class="quoted">pnderiv.match</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pnorm_def pset_deriv Deriv_pderiv pnderiv_alt<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nullable_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> pnderiv_alt<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pderiv.fin<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"flatten PLUS"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fold_pnorm_deriv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Languages as States›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Not executable but still instructive.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Derivs_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Derivs <span class="free">w</span> <span class="free">L</span> <span class="main">=</span> fold Deriv <span class="free">w</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">interpretation</span></span> language<span class="main">:</span> rexp_DFA <span class="quoted">lang</span> <span class="quoted">Deriv</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">L</span><span class="main">.</span> <span class="main">[]</span> <span class="main">∈</span> <span class="bound">L</span>"</span></span> <span class="quoted">id</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>fold Deriv <span class="bound">w</span> <span class="main">(</span>lang <span class="skolem">s</span><span class="main">)</span> <span class="main">|</span><span class="bound">w</span><span class="main">.</span> True<span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="main">⋃</span><span class="main">(</span>lang <span class="main">`</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> Pow <span class="main">(</span>pderivs_lang UNIV <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Derivs_alt_def<span class="main"><span class="main">]</span></span> Derivs_pderivs pderivs_lang_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_Pow_iff finite_pderivs_lang_UNIV<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">str_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> lang <span class="main">=&gt;</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">≈</span>_"</span> <span class="main">[</span>100<span class="main">]</span> 100<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">≈</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span>  <span class="main">(</span><span class="main">∀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">x</span> <span class="main">@</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟷</span> <span class="bound">y</span> <span class="main">@</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> str_eq_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">≈</span><span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> fold Deriv <span class="bound">x</span> <span class="free">A</span> <span class="main">=</span> fold Deriv <span class="bound">y</span> <span class="free">A</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> str_eq_def set_eq_iff in_fold_Deriv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> Myhill_Nerode2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">//</span> <span class="main">≈</span>lang <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> str_eq_alt quotient_def Image_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> language.fin<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">X</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">{</span></span></span><span class="bound"><span class="bound"><span class="bound">y</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">X</span></span></span> <span class="main"><span class="main"><span class="main">=</span></span></span> fold Deriv <span class="bound"><span class="bound"><span class="bound">y</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>lang <span class="free"><span class="free"><span class="free">r</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">r</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Position_Autos">
<div class="head">
<h1>Theory Position_Autos</h1>
</div>
<pre class="source"><span class="comment1">(*  Author: Tobias Nipkow, Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Framework Instantiations using Marked Regular Expressions›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Position_Autos
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Automaton.html">Automaton</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Marked Regular Expressions›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> mrexp <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool <span class="main">*</span> <span class="tfree">'a</span><span class="main">)</span> rexp"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">strip</span> <span class="main">≡</span> map_rexp snd"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">mrexps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> mrexp<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mrexps</span> Zero <span class="main">=</span> <span class="main">{</span>Zero<span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mrexps</span> One <span class="main">=</span> <span class="main">{</span>One<span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mrexps</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Atom <span class="main">(</span>True<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">,</span> Atom <span class="main">(</span>False<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mrexps</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> case_prod Plus <span class="main">`</span> <span class="main">(</span><span class="free">mrexps</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">×</span> <span class="free">mrexps</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mrexps</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> case_prod Times <span class="main">`</span> <span class="main">(</span><span class="free">mrexps</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">×</span> <span class="free">mrexps</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mrexps</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Star <span class="main">`</span> <span class="free">mrexps</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_mrexps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>mrexps <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> strip_mrexps<span class="main">:</span> <span class="quoted"><span class="quoted">"strip <span class="main">`</span> mrexps <span class="free">r</span> <span class="main">=</span> <span class="main">{</span><span class="free">r</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_eq_subset subset_iff image_iff<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Lm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mrexp <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Lm</span> Zero <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">Lm</span> One <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">Lm</span> <span class="main">(</span>Atom<span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">Lm</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">Lm</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∪</span> <span class="free">Lm</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">Lm</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">Lm</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">@@</span> lang<span class="main">(</span>strip <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="free">Lm</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">Lm</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">Lm</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">@@</span> star<span class="main">(</span>lang<span class="main">(</span>strip <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">final</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mrexp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">final</span> Zero <span class="main">=</span> False"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">final</span> One <span class="main">=</span> False"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">final</span> <span class="main">(</span>Atom<span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">final</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">final</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∨</span> <span class="free">final</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">final</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">final</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> nullable <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="free">final</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">final</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">final</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">read</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> mrexp <span class="main">⇒</span> <span class="tfree">'a</span> mrexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">read</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> map_rexp <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">m</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">m</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">=</span><span class="bound">x</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> read_mrexps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> mrexps <span class="free">s</span> <span class="main">⟹</span> read <span class="free">a</span> <span class="free">r</span> <span class="main">∈</span> mrexps <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">follow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="tfree">'a</span> mrexp <span class="main">⇒</span> <span class="tfree">'a</span> mrexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">follow</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> Zero <span class="main">=</span> Zero"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">follow</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> One <span class="main">=</span> One"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">follow</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Atom<span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Atom<span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">follow</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span><span class="free">follow</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">follow</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">follow</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span>
  Times <span class="main">(</span><span class="free">follow</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">follow</span> <span class="main">(</span>final <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∧</span> nullable <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">follow</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Star<span class="main">(</span><span class="free">follow</span> <span class="main">(</span>final <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> follow_mrexps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> mrexps <span class="free">s</span> <span class="main">⟹</span> follow <span class="free">b</span> <span class="free">r</span> <span class="main">∈</span> mrexps <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> strip_read<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"strip <span class="main">(</span>read <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> strip <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_map_rexp split_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Nil_notin_Lm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∉</span> Lm <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Nil_in_lang_strip<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> lang<span class="main">(</span><span class="free">r</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">[]</span> <span class="main">∈</span> lang<span class="main">(</span>strip <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> strip_follow<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"strip<span class="main">(</span>follow <span class="free">m</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> strip <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> conc_lemma<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">{</span><span class="bound"><span class="bound">w</span></span> <span class="main">:</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span><span class="main">.</span> <span class="bound">w</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">P</span><span class="main">(</span>hd <span class="bound">w</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">w</span></span> <span class="main">:</span> <span class="free">A</span><span class="main">.</span> <span class="bound">w</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">P</span><span class="main">(</span>hd <span class="bound">w</span><span class="main">)</span><span class="main">}</span> <span class="main">@@</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> conc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> hd_append2<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Lm_read<span class="main">:</span> <span class="quoted"><span class="quoted">"Lm <span class="main">(</span>read <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">w</span></span> <span class="main">:</span> Lm <span class="free">r</span><span class="main">.</span> <span class="bound">w</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> hd <span class="bound">w</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Times <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> conc_lemma<span class="main">[</span><span class="operator">OF</span> Nil_notin_Lm<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r1 <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">r1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Star <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> conc_lemma<span class="main">[</span><span class="operator">OF</span> Nil_notin_Lm<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="free">a</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tl_conc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">⟹</span>tl <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">@@</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> tl <span class="main">`</span> <span class="free">A</span> <span class="main">@@</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def Bex_def tl_append <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Nil_in_tl_Lm_if_final<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"final <span class="free">r</span> <span class="main">⟹</span> <span class="main">[]</span> <span class="main">:</span> tl <span class="main">`</span> Lm <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nullable_iff image_Un<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Nil_notin_tl_if_not_final<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> final <span class="free">r</span> <span class="main">⟹</span> <span class="main">[]</span> <span class="main">∉</span> tl <span class="main">`</span> Lm <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nullable_iff Nil_tl singleton_in_conc <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Lm_follow<span class="main">:</span> <span class="quoted"><span class="quoted">"Lm <span class="main">(</span>follow <span class="free">m</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> tl <span class="main">`</span> Lm <span class="free">r</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">m</span> <span class="keyword1">then</span> lang<span class="main">(</span>strip <span class="free">r</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Atom <span class="skolem">mb</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mb</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Times <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_Diff image_Un conc_Un_distrib nullable_iff
          conc_Diff_if_Nil1 Nil_notin_tl_if_not_final Un_ac<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_Diff conc_Un_distrib
          conc_Diff_if_Nil1 Nil_notin_tl_if_not_final star_Diff_Nil_fold<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Mark Before Atom›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Position automaton where mark is placed before atoms.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">empty_mrexp</span> <span class="main">≡</span> map_rexp <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span>False<span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> empty_mrexp_mrexps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"empty_mrexp <span class="free">r</span> <span class="main">∈</span> mrexps <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nullable_empty_mrexp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nullable <span class="main">(</span>empty_mrexp <span class="free">r</span><span class="main">)</span> <span class="main">=</span> nullable <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">init_b</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span>follow True <span class="main">(</span>empty_mrexp <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">,</span> nullable <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> init_b_mrexps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"init_b <span class="free">r</span> <span class="main">∈</span> mrexps <span class="free">r</span> <span class="main">×</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> init_b_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">delta_b</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">delta_b</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">r'</span> <span class="main">=</span> read <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">in</span> <span class="main">(</span>follow False <span class="bound">r'</span><span class="main">,</span> final <span class="bound">r'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> delta_b_mrexps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rb</span> <span class="main">∈</span> mrexps <span class="free">r</span> <span class="main">×</span> UNIV <span class="main">⟹</span> delta_b <span class="free">a</span> <span class="free">rb</span> <span class="main">∈</span> mrexps <span class="free">r</span> <span class="main">×</span> UNIV"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fold_delta_b_init_b_mrexps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fold delta_b <span class="free">w</span> <span class="main">(</span>init_b <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> mrexps <span class="free">s</span> <span class="main">×</span> UNIV"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">L_b</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">L_b</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> Lm <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">final_b</span> <span class="main">≡</span> snd"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Lm_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"Lm <span class="main">(</span>empty_mrexp <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> final_read_Lm<span class="main">:</span> <span class="quoted"><span class="quoted">"final<span class="main">(</span>read <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">∈</span> Lm <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nullable_iff concI_if_Nil2 singleton_in_conc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">global_interpretation</span></span> before<span class="main">:</span> rexp_DFA <span class="quoted">init_b</span> <span class="quoted">delta_b</span> <span class="quoted">final_b</span> <span class="quoted">L_b</span>
  <span class="keyword2"><span class="keyword">defines</span></span> before_closure <span class="main">=</span> <span class="quoted">before.closure</span>
    <span class="keyword2"><span class="keyword">and</span></span> check_eqv_b <span class="main">=</span> <span class="quoted">before.check_eqv</span>
    <span class="keyword2"><span class="keyword">and</span></span> reachable_b <span class="main">=</span> <span class="quoted">before.reachable</span>
    <span class="keyword2"><span class="keyword">and</span></span> automaton_b <span class="main">=</span> <span class="quoted">before.automaton</span>
    <span class="keyword2"><span class="keyword">and</span></span> match_b <span class="main">=</span> <span class="quoted">before.match</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">r</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"L_b <span class="main">(</span>init_b <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> lang <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_b_def Lm_follow Lm_empty map_map_rexp nullable_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">a</span> <span class="skolem">rb</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"L_b <span class="main">(</span>delta_b <span class="skolem">a</span> <span class="skolem">rb</span><span class="main">)</span> <span class="main">=</span> Deriv <span class="skolem">a</span> <span class="main">(</span>L_b <span class="skolem">rb</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rb</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Deriv_def final_read_Lm image_def Lm_read Lm_follow<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">rb</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"final_b <span class="skolem">rb</span> <span class="main">⟷</span> <span class="main">[]</span> <span class="main">∈</span> L_b <span class="skolem">rb</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rb</span></span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>fold delta_b <span class="bound">w</span> <span class="main">(</span>init_b <span class="skolem">s</span><span class="main">)</span> <span class="main">|</span><span class="bound">w</span><span class="main">.</span> True<span class="main">}</span> <span class="main">⊆</span> mrexps <span class="skolem">s</span> <span class="main">×</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> CollectE exE<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> fold_delta_b_init_b_mrexps<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span>fold delta_b <span class="bound">w</span> <span class="main">(</span>init_b <span class="skolem">s</span><span class="main">)</span> <span class="main">|</span><span class="bound">w</span><span class="main">.</span> True<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Mark After Atom›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Position automaton where mark is placed after atoms. This is the
Glushkov and McNaughton/Yamada construction.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">init_a</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span>True<span class="main">,</span> empty_mrexp <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> init_a_mrexps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"init_a <span class="free">r</span> <span class="main">∈</span> UNIV <span class="main">×</span> mrexps <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> init_a_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">delta_a</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">delta_a</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span> read <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>follow <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> delta_a_mrexps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">br</span> <span class="main">∈</span> UNIV <span class="main">×</span> mrexps <span class="free">r</span> <span class="main">⟹</span> delta_a <span class="free">a</span> <span class="free">br</span> <span class="main">∈</span> UNIV <span class="main">×</span> mrexps <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fold_delta_a_init_a_mrexps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fold delta_a <span class="free">w</span> <span class="main">(</span>init_a <span class="free">s</span><span class="main">)</span> <span class="main">∈</span> UNIV <span class="main">×</span> mrexps <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">final_a</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">final_a</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">⟷</span> final <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∧</span> nullable <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">L_a</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">L_a</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Lm <span class="main">(</span>follow <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> final_a<span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>  <span class="keyword1">then</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nonfinal_empty_mrexp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> final <span class="main">(</span>empty_mrexp <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Cons_eq_tl_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">=</span> tl <span class="free">ys</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">ys</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">#</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> tl_eq_Cons_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tl <span class="free">ys</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">ys</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">#</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">global_interpretation</span></span> after<span class="main">:</span> rexp_DFA <span class="quoted">init_a</span> <span class="quoted">delta_a</span> <span class="quoted">final_a</span> <span class="quoted">L_a</span>
  <span class="keyword2"><span class="keyword">defines</span></span> after_closure <span class="main">=</span> <span class="quoted">after.closure</span>
    <span class="keyword2"><span class="keyword">and</span></span> check_eqv_a <span class="main">=</span> <span class="quoted">after.check_eqv</span>
    <span class="keyword2"><span class="keyword">and</span></span> reachable_a <span class="main">=</span> <span class="quoted">after.reachable</span>
    <span class="keyword2"><span class="keyword">and</span></span> automaton_a <span class="main">=</span> <span class="quoted">after.automaton</span>
    <span class="keyword2"><span class="keyword">and</span></span> match_a <span class="main">=</span> <span class="quoted">after.match</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">r</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"L_a <span class="main">(</span>init_a <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> lang <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> init_a_def nonfinal_empty_mrexp Lm_follow Lm_empty map_map_rexp nullable_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">a</span> <span class="skolem">br</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"L_a <span class="main">(</span>delta_a <span class="skolem">a</span> <span class="skolem">br</span><span class="main">)</span> <span class="main">=</span> Deriv <span class="skolem">a</span> <span class="main">(</span>L_a <span class="skolem">br</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">br</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Deriv_def final_read_Lm Lm_read Lm_follow<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def neq_Nil_conv<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">br</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"final_a <span class="skolem">br</span> <span class="main">⟷</span> <span class="main">[]</span> <span class="main">∈</span> L_a <span class="skolem">br</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">br</span></span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>fold delta_a <span class="bound">w</span> <span class="main">(</span>init_a <span class="skolem">s</span><span class="main">)</span> <span class="main">|</span><span class="bound">w</span><span class="main">.</span> True<span class="main">}</span> <span class="main">⊆</span> UNIV <span class="main">×</span> mrexps <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> CollectE exE<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> fold_delta_a_init_a_mrexps<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span>fold delta_a <span class="bound">w</span> <span class="main">(</span>init_a <span class="skolem">s</span><span class="main">)</span> <span class="main">|</span><span class="bound">w</span><span class="main">.</span> True<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The ``before'' atomaton is a quotient of the ``after'' automaton.

The proof below follows an informal proof given by Helmut Seidl in personal communication. 
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">hom_ab</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">hom_ab</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>follow <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> final_a <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hom_delta<span class="main">:</span> <span class="quoted"><span class="quoted">"hom_ab <span class="main">(</span>delta_a <span class="free">x</span> <span class="free">br</span><span class="main">)</span> <span class="main">=</span> delta_b <span class="free">x</span> <span class="main">(</span>hom_ab <span class="free">br</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">br</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hom_deltas<span class="main">:</span> <span class="quoted"><span class="quoted">"hom_ab <span class="main">(</span>fold delta_a <span class="free">w</span> <span class="free">br</span><span class="main">)</span> <span class="main">=</span> fold delta_b <span class="free">w</span> <span class="main">(</span>hom_ab <span class="free">br</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">br</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hom_delta<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> hom_init<span class="main">:</span> <span class="quoted"><span class="quoted">"hom_ab <span class="main">(</span>init_a <span class="free">r</span><span class="main">)</span> <span class="main">=</span> init_b <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> init_a_def init_b_def hom_ab.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nonfinal_empty_mrexp<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> reachable_ab<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable_b <span class="free">as</span> <span class="free">r</span> <span class="main">=</span> hom_ab <span class="main">`</span> reachable_a <span class="free">as</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> after.reachable before.reachable <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hom_init hom_deltas<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> card_reachable_ab<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>reachable_b <span class="free">as</span> <span class="free">r</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>reachable_a <span class="free">as</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> reachable_ab <span class="keyword1"><span class="command">using</span></span> after.finite_reachable <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_image_le<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The implementation by Fischer et al.:›</span></span>

<span class="comment1">(* better: shift b m r and move m b r *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">shift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="tfree">'a</span> mrexp <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> mrexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">shift</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> One <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> One"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">shift</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Zero <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Zero"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">shift</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Atom <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> Atom <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">shift</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> Plus <span class="main">(</span><span class="free">shift</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">shift</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">shift</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span>
  Times <span class="main">(</span><span class="free">shift</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">shift</span> <span class="main">(</span>final <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∧</span> nullable <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">shift</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> Star <span class="main">(</span><span class="free">shift</span> <span class="main">(</span>final <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> shift_read_follow<span class="main">:</span> <span class="quoted"><span class="quoted">"shift <span class="free">m</span> <span class="free">r</span> <span class="free">x</span> <span class="main">=</span> read <span class="free">x</span> <span class="main">(</span>follow <span class="free">m</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> shift.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹In the spirit of Asperti, and similarly quadratic because of need
to call final1 in move.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">final1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mrexp <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">final1</span> Zero <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">final1</span> One <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">final1</span> <span class="main">(</span>Atom<span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">final1</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">final1</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∨</span> <span class="free">final1</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">final1</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">final1</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∨</span> nullable <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="free">final1</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">final1</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free">final1</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">move</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> mrexp <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'a</span> mrexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">move</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> One <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> One"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">move</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Zero <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Zero"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">move</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Atom <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> Atom <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">move</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> Plus <span class="main">(</span><span class="free">move</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">move</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">move</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span>
  Times <span class="main">(</span><span class="free">move</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">move</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>final1 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∧</span> nullable <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">move</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> Star <span class="main">(</span><span class="free">move</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>final1 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nullable_read<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nullable <span class="main">(</span>read <span class="free">c</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> nullable <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> final_read_final1<span class="main">:</span> <span class="quoted"><span class="quoted">"final <span class="main">(</span>read <span class="free">c</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> final1 <span class="free">r</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> move_follow_read<span class="main">:</span> <span class="quoted"><span class="quoted">"move <span class="free">c</span> <span class="free">r</span> <span class="free">m</span> <span class="main">=</span> follow <span class="free">m</span> <span class="main">(</span>read <span class="free">c</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> move.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> final_read_final1<span class="main">)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>

</pre>
</div><div id="After2">
<div class="head">
<h1>Theory After2</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Tobias Nipkow, Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Linear Time Optimization for ``Mark After Atom''›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> After2
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Position_Autos.html">Position_Autos</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> mrexp2 <span class="main">=</span>
  Zero2 <span class="main">|</span>
  One2 <span class="main">|</span>
  Atom2 <span class="main">(</span><span class="free"><span class="free"><span class="entity">fin</span></span></span><span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span>
  Plus2 <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mrexp2"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mrexp2"</span></span> <span class="main">(</span>fin<span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="free"><span class="entity">nul</span></span></span><span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span> <span class="main">|</span>
  Times2 <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mrexp2"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mrexp2"</span></span> <span class="main">(</span>fin<span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span> <span class="main">(</span>nul<span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span> <span class="main">|</span>
  Star2 <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mrexp2"</span></span> <span class="main">(</span>fin<span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fin</span> Zero2 <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nul</span> Zero2 <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fin</span> One2 <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nul</span> One2 <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nul</span> <span class="main">(</span>Atom2 <span class="main">_</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nul</span> <span class="main">(</span>Star2 <span class="main">_</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> True"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">mrexps2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> mrexp2<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mrexps2</span> Zero <span class="main">=</span> <span class="main">{</span>Zero2<span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mrexps2</span> One <span class="main">=</span> <span class="main">{</span>One2<span class="main">}</span> "</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mrexps2</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Atom2 True <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> Atom2 False <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mrexps2</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">f</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> Plus2 <span class="bound">r</span> <span class="bound">s</span> <span class="bound">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">mrexps2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">×</span> <span class="free">mrexps2</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mrexps2</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">f</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> Times2 <span class="bound">r</span> <span class="bound">s</span> <span class="bound">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">mrexps2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">×</span> <span class="free">mrexps2</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>  <span class="main">×</span> UNIV<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mrexps2</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span><span class="main">.</span> Star2 <span class="bound">r</span> <span class="bound">f</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">mrexps2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_mrexps3<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>mrexps2 <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">plus2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">==</span> Plus2 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>fin <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∨</span> fin <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>nul <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∨</span> nul <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">times2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">==</span> Times2 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>fin <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> nul <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> fin <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>nul <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> nul <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">star2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">==</span> Star2 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>fin <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">empty_mrexp2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> mrexp2"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">empty_mrexp2</span> Zero <span class="main">=</span> Zero2"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">empty_mrexp2</span> One <span class="main">=</span> One2"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">empty_mrexp2</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Atom2 False <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">empty_mrexp2</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> plus2 <span class="main">(</span><span class="free">empty_mrexp2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">empty_mrexp2</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">empty_mrexp2</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> times2 <span class="main">(</span><span class="free">empty_mrexp2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">empty_mrexp2</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">empty_mrexp2</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> star2 <span class="main">(</span><span class="free">empty_mrexp2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">shift2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="tfree">'a</span> mrexp2 <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> mrexp2"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">shift2</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> One2 <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> One2"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">shift2</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Zero2 <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Zero2"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">shift2</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Atom2 <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> Atom2 <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">shift2</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Plus2 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> plus2 <span class="main">(</span><span class="free">shift2</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">shift2</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">shift2</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Times2 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> times2 <span class="main">(</span><span class="free">shift2</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">shift2</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∧</span> nul <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∨</span> fin <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">shift2</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Star2 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span>  star2 <span class="main">(</span><span class="free">shift2</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∨</span> fin <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">strip2</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">strip2</span> Zero2 <span class="main">=</span> Zero"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">strip2</span> One2 <span class="main">=</span> One"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">strip2</span> <span class="main">(</span>Atom2 <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Atom <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">strip2</span> <span class="main">(</span>Plus2 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span><span class="free">strip2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">strip2</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">strip2</span> <span class="main">(</span>Times2 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> Times <span class="main">(</span><span class="free">strip2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">strip2</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">strip2</span> <span class="main">(</span>Star2 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> Star <span class="main">(</span><span class="free">strip2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> strip_mrexps2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>strip <span class="keyword1">o</span> strip2<span class="main">)</span> <span class="main">`</span> mrexps2 <span class="free">r</span> <span class="main">=</span> <span class="main">{</span><span class="free">r</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_eq_subset subset_iff image_iff<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">ok2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mrexp2 <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ok2</span> Zero2 <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">ok2</span> One2 <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">ok2</span> <span class="main">(</span>Atom2 <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">ok2</span> <span class="main">(</span>Plus2 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ok2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="free">ok2</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">rs</span> <span class="main">=</span> Plus <span class="main">(</span>strip2 <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>strip2 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> final <span class="bound">rs</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> nullable <span class="bound">rs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">ok2</span> <span class="main">(</span>Times2 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ok2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="free">ok2</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">rs</span> <span class="main">=</span> Times <span class="main">(</span>strip2 <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>strip2 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> final <span class="bound">rs</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> nullable <span class="bound">rs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">ok2</span> <span class="main">(</span>Star2 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ok2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> final <span class="main">(</span>strip2 <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ok2_fin_final<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ok2 <span class="free">r</span> <span class="main">⟹</span> fin <span class="free">r</span> <span class="main">=</span> final <span class="main">(</span>strip2 <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ok2_nul_nullable<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ok2 <span class="free">r</span> <span class="main">⟹</span> nul <span class="free">r</span> <span class="main">=</span> nullable <span class="main">(</span>strip2 <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> strip2_shift2<span class="main">:</span> <span class="quoted"><span class="quoted">"ok2 <span class="free">r</span> <span class="main">⟹</span> strip2<span class="main">(</span>shift2 <span class="free">m</span> <span class="free">r</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> shift <span class="free">m</span> <span class="main">(</span>strip2 <span class="free">r</span><span class="main">)</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> disj_commute<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> ok2_empty_mrexp2<span class="main">:</span> <span class="quoted"><span class="quoted">"ok2 <span class="main">(</span>empty_mrexp2 <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> ok2_shift2<span class="main">:</span> <span class="quoted"><span class="quoted">"ok2 <span class="free">r</span> <span class="main">⟹</span> ok2<span class="main">(</span>shift2 <span class="free">m</span> <span class="free">r</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> strip2_empty_mrexp2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"strip2 <span class="main">(</span>empty_mrexp2 <span class="free">r</span><span class="main">)</span> <span class="main">=</span> empty_mrexp <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nul_empty_mrexp2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nul <span class="main">(</span>empty_mrexp2 <span class="free">r</span><span class="main">)</span> <span class="main">=</span> nullable <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nonfin_empty_mrexp2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> fin <span class="main">(</span>empty_mrexp2 <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> empty_mrexp2_mrexps2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"empty_mrexp2 <span class="free">s</span> <span class="main">∈</span> mrexps2 <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> shift2_mrexps2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> mrexps2 <span class="free">s</span> <span class="main">⟹</span> shift2 <span class="free">x</span> <span class="free">r</span> <span class="free">a</span> <span class="main">∈</span> mrexps2 <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="tfree">'a</span> ok_mrexp2 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">b</span> <span class="main">::</span> bool<span class="main">,</span> <span class="bound">r</span> <span class="main">::</span> <span class="tfree">'a</span> mrexp2<span class="main">)</span><span class="main">.</span> ok2 <span class="bound">r</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mem_Collect_eq split_beta <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> snd_eqD ok2_empty_mrexp2<span class="main">)</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_ok_mrexp2

<span class="keyword1"><span class="command">lift_definition</span></span> init_okm <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> ok_mrexp2"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="main">(</span>True<span class="main">,</span> empty_mrexp2 <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ok2_empty_mrexp2 <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> ok2.simps<span class="main">)</span>
<span class="keyword1"><span class="command">lift_definition</span></span> delta_okm <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> ok_mrexp2 <span class="main">⇒</span> <span class="tfree">'a</span> ok_mrexp2"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>False<span class="main">,</span> shift2 <span class="bound">m</span> <span class="bound">r</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mem_Collect_eq split_beta snd_conv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ok2_shift2<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lift_definition</span></span> nullable_okm <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ok_mrexp2 <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> fin <span class="bound">r</span> <span class="main">∨</span> <span class="bound">m</span> <span class="main">∧</span> nul <span class="bound">r</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> lang_okm <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ok_mrexp2 <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> L_a <span class="main">(</span><span class="bound">m</span><span class="main">,</span> strip2 <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>


<span class="keyword1"><span class="command">instantiation</span></span> ok_mrexp2 <span class="main">::</span> <span class="main">(</span><span class="quoted">equal</span><span class="main">)</span> <span class="quoted"><span class="quoted">"equal"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eq_mrexp2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eq_mrexp2</span> Zero2 Zero2 <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eq_mrexp2</span> One2 One2 <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eq_mrexp2</span> <span class="main">(</span>Atom2 <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Atom2 <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eq_mrexp2</span> <span class="main">(</span>Plus2 <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span>Plus2 <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">eq_mrexp2</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="main">∧</span> <span class="free">eq_mrexp2</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eq_mrexp2</span> <span class="main">(</span>Times2 <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span>Times2 <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">eq_mrexp2</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="main">∧</span> <span class="free">eq_mrexp2</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eq_mrexp2</span> <span class="main">(</span>Star2 <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span>Star2 <span class="free"><span class="bound"><span class="entity">r2</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">eq_mrexp2</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eq_mrexp2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_mrexp2_imp_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>eq_mrexp2 <span class="free">r</span> <span class="free">s</span><span class="main">;</span> ok2 <span class="free">r</span><span class="main">;</span> ok2 <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">r</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eq_mrexp2.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_mrexp2_refl<span class="main">[</span><span class="operator">simplified</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⟹</span> eq_mrexp2 <span class="free">r</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eq_mrexp2.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_mrexp2_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>ok2 <span class="free">r</span><span class="main">;</span> ok2 <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> eq_mrexp2 <span class="free">r</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_mrexp2_imp_eq eq_mrexp2_refl<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">equal_ok_mrexp2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ok_mrexp2 <span class="main">⇒</span> <span class="tfree">'a</span> ok_mrexp2 <span class="main">⇒</span> bool"</span></span>
   <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">b1</span><span class="main">,</span><span class="bound">r1</span><span class="main">)</span> <span class="main">(</span><span class="bound">b2</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span><span class="main">.</span> <span class="bound">b1</span> <span class="main">=</span> <span class="bound">b2</span> <span class="main">∧</span> eq_mrexp2 <span class="bound">r1</span> <span class="bound">r2</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_mrexp2_eq<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> after2<span class="main">:</span> rexp_DFA <span class="quoted">init_okm</span> <span class="quoted">delta_okm</span> <span class="quoted">nullable_okm</span> <span class="quoted">lang_okm</span>
  <span class="keyword2"><span class="keyword">defines</span></span> after2_closure <span class="main">=</span> <span class="quoted">after2.closure</span>
    <span class="keyword2"><span class="keyword">and</span></span> check_eqv_a2 <span class="main">=</span> <span class="quoted">after2.check_eqv</span>
    <span class="keyword2"><span class="keyword">and</span></span> reachable_a2 <span class="main">=</span> <span class="quoted">after2.reachable</span>
    <span class="keyword2"><span class="keyword">and</span></span> automaton_a2 <span class="main">=</span> <span class="quoted">after2.automaton</span>
    <span class="keyword2"><span class="keyword">and</span></span> match_a2 <span class="main">=</span> <span class="quoted">after2.match</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">r</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lang_okm <span class="main">(</span>init_okm <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> lang <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta init_a_def nonfinal_empty_mrexp Lm_follow Lm_empty
      map_map_rexp nullable_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">a</span> <span class="skolem">br</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lang_okm <span class="main">(</span>delta_okm <span class="skolem">a</span> <span class="skolem">br</span><span class="main">)</span> <span class="main">=</span> Deriv <span class="skolem">a</span> <span class="main">(</span>lang_okm <span class="skolem">br</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
    <span class="keyword1"><span class="command">unfolding</span></span> split_beta fst_conv snd_conv mem_Collect_eq after.L_delta<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> delta_a.simps
      shift_read_follow<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> strip2_shift2<span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">br</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"nullable_okm <span class="skolem">br</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span> <span class="main">∈</span> lang_okm <span class="skolem">br</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>False<span class="main">,</span> shift2 <span class="bound">m</span> <span class="bound">r</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="bound">w</span> <span class="main">(</span>True<span class="main">,</span> empty_mrexp2 <span class="skolem">s</span><span class="main">)</span> <span class="main">|</span><span class="bound">w</span><span class="main">.</span> True<span class="main">}</span> <span class="main">⊆</span>
    UNIV <span class="main">×</span> mrexps2 <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> CollectE exE conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">hypsubst</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>False<span class="main">,</span> shift2 <span class="bound">m</span> <span class="bound">r</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">w</span> <span class="main">(</span>True<span class="main">,</span> empty_mrexp2 <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span>
      UNIV <span class="main">×</span> mrexps2 <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> shift2_mrexps2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span>fold delta_okm <span class="bound">w</span> <span class="main">(</span>init_okm <span class="skolem">s</span><span class="main">)</span> <span class="main">|</span><span class="bound">w</span><span class="main">.</span> True<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">erule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subset_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Before2">
<div class="head">
<h1>Theory Before2</h1>
</div>
<pre class="source"><span class="comment1">(*  Author: Tobias Nipkow, Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Linear Time Optimization for ``Mark Before Atom'' (for a Fixed Alphabet)›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Before2
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Position_Autos.html">Position_Autos</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">declare</span></span> Let_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> mrexp3 <span class="main">=</span>
  Zero3 <span class="main">|</span>
  One3 <span class="main">|</span>
  Atom3 <span class="quoted">bool</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span>
  Plus3 <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mrexp3"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mrexp3"</span></span> <span class="main">(</span><span class="free"><span class="free"><span class="entity">fin1</span></span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="free"><span class="entity">nul</span></span></span><span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span> <span class="main">|</span>
  Times3 <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mrexp3"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mrexp3"</span></span> <span class="main">(</span>fin1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span><span class="main">)</span> <span class="main">(</span>nul<span class="main">:</span> <span class="quoted">bool</span><span class="main">)</span> <span class="main">|</span>
  Star3 <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mrexp3"</span></span> <span class="main">(</span>fin1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fin1</span> Zero3 <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nul</span> Zero3 <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fin1</span> One3 <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nul</span> One3 <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fin1</span> <span class="main">(</span>Atom3 <span class="free">m</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">m</span> <span class="keyword1">then</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nul</span> <span class="main">(</span>Atom3 <span class="main">_</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nul</span> <span class="main">(</span>Star3 <span class="main">_</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> True"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">final3</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">final3</span> Zero3 <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">final3</span> One3 <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">final3</span> <span class="main">(</span>Atom3 <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">final3</span> <span class="main">(</span>Plus3 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">final3</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∨</span> <span class="free">final3</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">final3</span> <span class="main">(</span>Times3 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">final3</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∨</span> nul <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="free">final3</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">final3</span> <span class="main">(</span>Star3 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">final3</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">mrexps3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> mrexp3<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mrexps3</span> Zero <span class="main">=</span> <span class="main">{</span>Zero3<span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mrexps3</span> One <span class="main">=</span> <span class="main">{</span>One3<span class="main">}</span> "</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mrexps3</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Atom3 True <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> Atom3 False <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mrexps3</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">f1</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> Plus3 <span class="bound">r</span> <span class="bound">s</span> <span class="bound">f1</span> <span class="bound">n</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">mrexps3</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">×</span> <span class="free">mrexps3</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">×</span> Pow <span class="main">(</span>atoms <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mrexps3</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">f1</span><span class="main">,</span> <span class="bound">n</span><span class="main">)</span><span class="main">.</span> Times3 <span class="bound">r</span> <span class="bound">s</span> <span class="bound">f1</span> <span class="bound">n</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">mrexps3</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">×</span> <span class="free">mrexps3</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">×</span> Pow <span class="main">(</span>atoms <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>  <span class="main">×</span> UNIV<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mrexps3</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">f1</span><span class="main">)</span><span class="main">.</span> Star3 <span class="bound">r</span> <span class="bound">f1</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">mrexps3</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">×</span> Pow <span class="main">(</span>atoms <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_atoms<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>atoms <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_mrexps3<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>mrexps3 <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">plus3</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">==</span> Plus3 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>fin1 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∪</span> fin1 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span>nul <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∨</span> nul <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">times3</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">==</span>
  <span class="keyword1">let</span> <span class="bound">ns</span> <span class="main">=</span> nul <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">in</span> Times3 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>fin1 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">ns</span> <span class="keyword1">then</span> fin1 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>nul <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="bound">ns</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">star3</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">==</span> Star3 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>fin1 <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">follow3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="tfree">'a</span> mrexp3 <span class="main">⇒</span> <span class="tfree">'a</span> mrexp3"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">follow3</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> Zero3 <span class="main">=</span> Zero3"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">follow3</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> One3 <span class="main">=</span> One3"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">follow3</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Atom3 <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> Atom3 <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">follow3</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Plus3 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> plus3 <span class="main">(</span><span class="free">follow3</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">follow3</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">follow3</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Times3 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span>
  times3 <span class="main">(</span><span class="free">follow3</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">follow3</span> <span class="main">(</span>final3 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∧</span> nul <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">follow3</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Star3 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> star3<span class="main">(</span><span class="free">follow3</span> <span class="main">(</span>final3 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">empty_mrexp3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> mrexp3"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">empty_mrexp3</span> Zero <span class="main">=</span> Zero3"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">empty_mrexp3</span> One <span class="main">=</span> One3"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">empty_mrexp3</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Atom3 False <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">empty_mrexp3</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> plus3 <span class="main">(</span><span class="free">empty_mrexp3</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">empty_mrexp3</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">empty_mrexp3</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> times3 <span class="main">(</span><span class="free">empty_mrexp3</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">empty_mrexp3</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">empty_mrexp3</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> star3 <span class="main">(</span><span class="free">empty_mrexp3</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">move3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> mrexp3 <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'a</span> mrexp3"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">move3</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> One3 <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> One3"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">move3</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> Zero3 <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Zero3"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">move3</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Atom3 <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> Atom3 <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">move3</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Plus3 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> plus3 <span class="main">(</span><span class="free">move3</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">move3</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">move3</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Times3 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span>
  times3 <span class="main">(</span><span class="free">move3</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">move3</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∈</span> fin1 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∧</span> nul <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">move3</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Star3 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> star3 <span class="main">(</span><span class="free">move3</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">∈</span> fin1 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">strip3</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">strip3</span> Zero3 <span class="main">=</span> Zero"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">strip3</span> One3 <span class="main">=</span> One"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">strip3</span> <span class="main">(</span>Atom3 <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Atom <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">strip3</span> <span class="main">(</span>Plus3 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span><span class="free">strip3</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">strip3</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">strip3</span> <span class="main">(</span>Times3 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> Times <span class="main">(</span><span class="free">strip3</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">strip3</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">strip3</span> <span class="main">(</span>Star3 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> Star <span class="main">(</span><span class="free">strip3</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> strip_mrexps3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>strip <span class="keyword1">o</span> strip3<span class="main">)</span> <span class="main">`</span> mrexps3 <span class="free">r</span> <span class="main">=</span> <span class="main">{</span><span class="free">r</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_eq_subset subset_iff image_iff<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">ok3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mrexp3 <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ok3</span> Zero3 <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">ok3</span> One3 <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">ok3</span> <span class="main">(</span>Atom3 <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">ok3</span> <span class="main">(</span>Plus3 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ok3</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="free">ok3</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">rs</span> <span class="main">=</span> Plus <span class="main">(</span>strip3 <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>strip3 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="main">=</span> Collect <span class="main">(</span>final1 <span class="bound">rs</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> nullable <span class="bound">rs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">ok3</span> <span class="main">(</span>Times3 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ok3</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="free">ok3</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">rs</span> <span class="main">=</span> Times <span class="main">(</span>strip3 <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>strip3 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="main">=</span> Collect <span class="main">(</span>final1 <span class="bound">rs</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> nullable <span class="bound">rs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">ok3</span> <span class="main">(</span>Star3 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ok3</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">f1</span></span></span> <span class="main">=</span> Collect <span class="main">(</span>final1 <span class="main">(</span>strip3 <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ok3_fin1_final1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ok3 <span class="free">r</span> <span class="main">⟹</span> fin1 <span class="free">r</span> <span class="main">=</span> Collect <span class="main">(</span>final1 <span class="main">(</span>strip3 <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ok3_nul_nullable<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ok3 <span class="free">r</span> <span class="main">⟹</span> nul <span class="free">r</span> <span class="main">=</span> nullable <span class="main">(</span>strip3 <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ok3_final3_final<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ok3 <span class="free">r</span> <span class="main">⟹</span> final3 <span class="free">r</span> <span class="main">=</span> final <span class="main">(</span>strip3 <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> follow3_follow<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ok3 <span class="free">r</span> <span class="main">⟹</span> strip3 <span class="main">(</span>follow3 <span class="free">m</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> follow <span class="free">m</span> <span class="main">(</span>strip3 <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nul_follow3<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ok3 <span class="free">r</span> <span class="main">⟹</span> nul <span class="main">(</span>follow3 <span class="free">m</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> nul <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ok3_follow3<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ok3 <span class="free">r</span> <span class="main">⟹</span> ok3 <span class="main">(</span>follow3 <span class="free">m</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fin1_atoms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x</span> <span class="main">∈</span> fin1 <span class="free">mr</span><span class="main">;</span> <span class="free">mr</span> <span class="main">∈</span> mrexps3 <span class="free">r</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> atoms <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> follow3_mrexps3<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> mrexps3 <span class="free">s</span> <span class="main">⟹</span> follow3 <span class="free">m</span> <span class="free">r</span> <span class="main">∈</span> mrexps3 <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fin1_atoms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> empty_mrexp3_mrexps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"empty_mrexp3 <span class="free">r</span> <span class="main">∈</span> mrexps3 <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fin1_atoms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> strip3_empty_mrexp3<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"strip3 <span class="main">(</span>empty_mrexp3 <span class="free">r</span><span class="main">)</span> <span class="main">=</span> empty_mrexp <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> strip3_move3<span class="main">:</span> <span class="quoted"><span class="quoted">"ok3 <span class="free">r</span> <span class="main">⟹</span> strip3<span class="main">(</span>move3 <span class="free">m</span> <span class="free">r</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> move <span class="free">m</span> <span class="main">(</span>strip3 <span class="free">r</span><span class="main">)</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> disj_commute<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> nul_empty_mrexp3<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nul <span class="main">(</span>empty_mrexp3 <span class="free">r</span><span class="main">)</span> <span class="main">=</span> nullable <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> ok3_empty_mrexp3<span class="main">:</span> <span class="quoted"><span class="quoted">"ok3 <span class="main">(</span>empty_mrexp3 <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> ok3_move3<span class="main">:</span> <span class="quoted"><span class="quoted">"ok3 <span class="free">r</span> <span class="main">⟹</span> ok3<span class="main">(</span>move3 <span class="free">m</span> <span class="free">r</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> nonfin1_empty_mrexp3<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∉</span> fin1 <span class="main">(</span>empty_mrexp3 <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> move3_mrexps3<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> mrexps3 <span class="free">s</span> <span class="main">⟹</span> move3 <span class="free">x</span> <span class="free">r</span> <span class="free">a</span> <span class="main">∈</span> mrexps3 <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fin1_atoms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="tfree">'a</span> ok_mrexp3 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">r</span> <span class="main">::</span> <span class="tfree">'a</span> mrexp3<span class="main">,</span> <span class="bound">b</span> <span class="main">::</span> bool<span class="main">)</span><span class="main">.</span> ok3 <span class="bound">r</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mem_Collect_eq split_beta <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_eqD ok3_empty_mrexp3<span class="main">)</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_ok_mrexp3

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">init_m</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="bound">mr</span> <span class="main">=</span> follow3 True <span class="main">(</span>empty_mrexp3 <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">mr</span><span class="main">,</span> nul <span class="bound">mr</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> init_okm <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> ok_mrexp3"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">init_m</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ok3_empty_mrexp3<span class="main">)</span>
<span class="keyword1"><span class="command">lift_definition</span></span> delta_okm <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> ok_mrexp3 <span class="main">⇒</span> <span class="tfree">'a</span> ok_mrexp3"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>move3 <span class="bound">a</span> <span class="bound">r</span> False<span class="main">,</span> <span class="bound">a</span> <span class="main">∈</span> fin1 <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mem_Collect_eq split_beta fst_conv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ok3_move3<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lift_definition</span></span> nullable_okm <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ok_mrexp3 <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"snd"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> lang_okm <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ok_mrexp3 <span class="main">⇒</span> <span class="tfree">'a</span> lang"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">.</span> L_b <span class="main">(</span>strip3 <span class="bound">r</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>


<span class="keyword1"><span class="command">instantiation</span></span> ok_mrexp3 <span class="main">::</span> <span class="main">(</span><span class="quoted">equal</span><span class="main">)</span> <span class="quoted"><span class="quoted">"equal"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eq_mrexp3</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eq_mrexp3</span> Zero3 Zero3 <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eq_mrexp3</span> One3 One3 <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eq_mrexp3</span> <span class="main">(</span>Atom3 <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Atom3 <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eq_mrexp3</span> <span class="main">(</span>Plus3 <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span>Plus3 <span class="free"><span class="bound"><span class="entity">r3</span></span></span> <span class="free"><span class="bound"><span class="entity">s3</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">eq_mrexp3</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r3</span></span></span> <span class="main">∧</span> <span class="free">eq_mrexp3</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s3</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eq_mrexp3</span> <span class="main">(</span>Times3 <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span>Times3 <span class="free"><span class="bound"><span class="entity">r3</span></span></span> <span class="free"><span class="bound"><span class="entity">s3</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">eq_mrexp3</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r3</span></span></span> <span class="main">∧</span> <span class="free">eq_mrexp3</span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s3</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eq_mrexp3</span> <span class="main">(</span>Star3 <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span>Star3 <span class="free"><span class="bound"><span class="entity">r3</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">eq_mrexp3</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="free"><span class="bound"><span class="entity">r3</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eq_mrexp3</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_mrexp3_imp_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>eq_mrexp3 <span class="free">r</span> <span class="free">s</span><span class="main">;</span> ok3 <span class="free">r</span><span class="main">;</span> ok3 <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">r</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eq_mrexp3.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_mrexp3_refl<span class="main">[</span><span class="operator">simplified</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="free">s</span> <span class="main">⟹</span> eq_mrexp3 <span class="free">r</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eq_mrexp3.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_mrexp3_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>ok3 <span class="free">r</span><span class="main">;</span> ok3 <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span> eq_mrexp3 <span class="free">r</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span> <span class="main">=</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_mrexp3_imp_eq eq_mrexp3_refl<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">equal_ok_mrexp3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ok_mrexp3 <span class="main">⇒</span> <span class="tfree">'a</span> ok_mrexp3 <span class="main">⇒</span> bool"</span></span>
   <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">r1</span><span class="main">,</span> <span class="bound">b1</span><span class="main">)</span> <span class="main">(</span><span class="bound">r3</span><span class="main">,</span> <span class="bound">b3</span><span class="main">)</span><span class="main">.</span> <span class="bound">b1</span> <span class="main">=</span> <span class="bound">b3</span> <span class="main">∧</span> eq_mrexp3 <span class="bound">r1</span> <span class="bound">r3</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_mrexp3_eq<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> before2<span class="main">:</span> rexp_DFA <span class="quoted">init_okm</span> <span class="quoted">delta_okm</span> <span class="quoted">nullable_okm</span> <span class="quoted">lang_okm</span>
  <span class="keyword2"><span class="keyword">defines</span></span> before2_closure <span class="main">=</span> <span class="quoted">before2.closure</span>
    <span class="keyword2"><span class="keyword">and</span></span> check_eqv_b2 <span class="main">=</span> <span class="quoted">before2.check_eqv</span>
    <span class="keyword2"><span class="keyword">and</span></span> reachable_b2 <span class="main">=</span> <span class="quoted">before2.reachable</span>
    <span class="keyword2"><span class="keyword">and</span></span> automaton_b2 <span class="main">=</span> <span class="quoted">before2.automaton</span>
    <span class="keyword2"><span class="keyword">and</span></span> match_b2 <span class="main">=</span> <span class="quoted">before2.match</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">r</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lang_okm <span class="main">(</span>init_okm <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> lang <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta init_a_def nonfinal_empty_mrexp Lm_follow Lm_empty
      map_map_rexp nullable_iff ok3_empty_mrexp3<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">a</span> <span class="skolem">br</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lang_okm <span class="main">(</span>delta_okm <span class="skolem">a</span> <span class="skolem">br</span><span class="main">)</span> <span class="main">=</span> Deriv <span class="skolem">a</span> <span class="main">(</span>lang_okm <span class="skolem">br</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
    <span class="keyword1"><span class="command">unfolding</span></span> split_beta fst_conv snd_conv mem_Collect_eq before.L_delta<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> delta_b.simps
      move_follow_read<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> final_read_final1 Let_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> strip3_move3<span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">br</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"nullable_okm <span class="skolem">br</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span> <span class="main">∈</span> lang_okm <span class="skolem">br</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>move3 <span class="bound">a</span> <span class="bound">r</span> False<span class="main">,</span> <span class="bound">a</span> <span class="main">∈</span> fin1 <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">w</span> <span class="main">(</span>init_m <span class="skolem">s</span><span class="main">)</span> <span class="main">|</span><span class="bound">w</span><span class="main">.</span> True<span class="main">}</span> <span class="main">⊆</span>
    mrexps3 <span class="skolem">s</span> <span class="main">×</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> CollectE exE conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">hypsubst</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>move3 <span class="bound">a</span> <span class="bound">r</span> False<span class="main">,</span> <span class="bound">a</span> <span class="main">∈</span> fin1 <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">w</span> <span class="main">(</span>init_m <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span>
      mrexps3 <span class="skolem">s</span> <span class="main">×</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> move3_mrexps3<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span>fold delta_okm <span class="bound">w</span> <span class="main">(</span>init_okm <span class="skolem">s</span><span class="main">)</span> <span class="main">|</span><span class="bound">w</span><span class="main">.</span> True<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">erule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subset_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Regex_Equivalence">
<div class="head">
<h1>Theory Regex_Equivalence</h1>
</div>
<pre class="source"><span class="comment1">(*  Author: Tobias Nipkow, Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Various Algorithms for Regular Expression Equivalence›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Regex_Equivalence
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Deriv_Autos.html">Deriv_Autos</a>
  <a href="Position_Autos.html">Position_Autos</a>
  <a href="After2.html">After2</a>
  <a href="Before2.html">Before2</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Code_Target_Nat.html">HOL-Library.Code_Target_Nat</a>"</span>
  <span class="quoted">"<a href="../Efficient-Mergesort/Efficient_Sort.html">Efficient-Mergesort.Efficient_Sort</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">export_code</span></span>
    <span class="quoted"><span class="quoted">check_eqv_brz</span></span>
    <span class="quoted"><span class="quoted">check_eqv_brzq</span></span>
    <span class="quoted"><span class="quoted">check_eqv_n</span></span>
    <span class="quoted"><span class="quoted">check_eqv_p</span></span>
    <span class="quoted"><span class="quoted">check_eqv_pn</span></span>
    <span class="quoted"><span class="quoted">check_eqv_b</span></span>
    <span class="quoted"><span class="quoted">check_eqv_b2</span></span>
    <span class="quoted"><span class="quoted">check_eqv_a</span></span>
    <span class="quoted"><span class="quoted">check_eqv_a2</span></span>
    <span class="quoted"><span class="quoted">match_brz</span></span>
    <span class="quoted"><span class="quoted">match_brzq</span></span>
    <span class="quoted"><span class="quoted">match_n</span></span>
    <span class="quoted"><span class="quoted">match_p</span></span>
    <span class="quoted"><span class="quoted">match_pn</span></span>
    <span class="quoted"><span class="quoted">match_b</span></span>
    <span class="quoted"><span class="quoted">match_b2</span></span>
    <span class="quoted"><span class="quoted">match_a</span></span>
    <span class="quoted"><span class="quoted">match_a2</span></span>
    <span class="keyword2"><span class="keyword">in</span></span> SML <span class="keyword2"><span class="keyword">module_name</span></span> Rexp

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Examples">
<div class="head">
<h1>Theory Examples</h1>
</div>
<pre class="source"><span class="comment1">(*  Author: Tobias Nipkow, Dmitriy Traytel *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Some Tests›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Examples
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Regex_Equivalence.html">Regex_Equivalence</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Examples›</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Test: <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>B(n) = (One + a + aa + ⋯ + a<span class="hidden">⇧</span><sup>n</sup><span class="hidden">⇧</span><sup>-</sup><span class="hidden">⇧</span><sup>1</sup>) (a<span class="hidden">⇧</span><sup>n</sup>)<span class="hidden">⇧</span><sup>*</sup> = a<span class="hidden">⇧</span><sup>*</sup>›</span></span> (see Asperti)›</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pow</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pow</span> <span class="main">0</span> <span class="main">=</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pow</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> Atom True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pow</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> Times <span class="main">(</span>Atom True<span class="main">)</span> <span class="main">(</span><span class="free">pow</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pow_left</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pow_left</span> <span class="main">0</span> <span class="main">=</span> One"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pow_left</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> Atom True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pow_left</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> Times <span class="main">(</span><span class="free">pow_left</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>Atom True<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Sum</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Sum</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Sum</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> Plus <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">Sum</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span>Times <span class="main">(</span>Sum pow <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Star <span class="main">(</span>pow <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Star <span class="main">(</span>Atom True<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">B_left</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span>Times <span class="main">(</span>Sum pow_left <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Star <span class="main">(</span>pow_left <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Star <span class="main">(</span>Atom True<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">seq_left</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> foldr <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">s</span><span class="main">.</span> Times <span class="bound">s</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span>replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> One"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">seq</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> foldr Times <span class="main">(</span>replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> One"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">re_left</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Times <span class="main">(</span>seq_left <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Plus <span class="main">(</span>Atom True<span class="main">)</span> One<span class="main">)</span><span class="main">)</span> <span class="main">(</span>seq_left <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Atom True<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">re</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Times <span class="main">(</span>seq <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Plus <span class="main">(</span>Atom True<span class="main">)</span> One<span class="main">)</span><span class="main">)</span> <span class="main">(</span>seq <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Atom True<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span>re_left <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> True<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"case_prod match_brz <span class="main">(</span>M <span class="numeral">128</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"case_prod match_brzq <span class="main">(</span>M <span class="numeral">128</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"case_prod match_n <span class="main">(</span>M <span class="numeral">64</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"case_prod match_p <span class="main">(</span>M <span class="numeral">64</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"case_prod match_pn <span class="main">(</span>M <span class="numeral">64</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"case_prod match_a <span class="main">(</span>M <span class="numeral">512</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"case_prod match_b <span class="main">(</span>M <span class="numeral">512</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"case_prod match_a2 <span class="main">(</span>M <span class="numeral">2048</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"case_prod match_b2 <span class="main">(</span>M <span class="numeral">2048</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"case_prod check_eqv_brz <span class="main">(</span>B <span class="numeral">32</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"case_prod check_eqv_brzq <span class="main">(</span>B <span class="numeral">16</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"case_prod check_eqv_n <span class="main">(</span>B <span class="numeral">256</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"case_prod check_eqv_p <span class="main">(</span>B <span class="numeral">256</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"case_prod check_eqv_b <span class="main">(</span>B <span class="numeral">256</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"case_prod check_eqv_a <span class="main">(</span>B <span class="numeral">256</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"case_prod check_eqv_b2 <span class="main">(</span>B <span class="numeral">256</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"case_prod check_eqv_a2 <span class="main">(</span>B <span class="numeral">256</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Benchmark">
<div class="head">
<h1>Theory Benchmark</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Benchmark
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Regex_Equivalence.html">Regex_Equivalence</a> <a href="../../Tools/Spec_Check/Spec_Check.html">Spec_Check.Spec_Check</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bool_checkers</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>string <span class="main">*</span> <span class="main">(</span>bool rexp <span class="main">⇒</span> bool rexp <span class="main">⇒</span> bool<span class="main">)</span><span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bool_checkers</span> <span class="main">=</span> <span class="main">[</span>
    <span class="main">(</span><span class="inner_quoted">''D ''</span><span class="main">,</span> check_eqv_brz<span class="main">)</span><span class="main">,</span>
    <span class="comment1">⌦‹(''DQ'', check_eqv_brzq),›</span>
    <span class="main">(</span><span class="inner_quoted">''N ''</span><span class="main">,</span> check_eqv_n<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="inner_quoted">''P ''</span><span class="main">,</span> check_eqv_p<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="inner_quoted">''PN''</span><span class="main">,</span> check_eqv_pn<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="inner_quoted">''B ''</span><span class="main">,</span> check_eqv_b<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="inner_quoted">''B2''</span><span class="main">,</span> check_eqv_b2<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="inner_quoted">''A ''</span><span class="main">,</span> check_eqv_a<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="inner_quoted">''A2''</span><span class="main">,</span> check_eqv_a2<span class="main">)</span>
    <span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bool_matchers</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>string <span class="main">*</span> <span class="main">(</span>bool rexp <span class="main">⇒</span> bool list <span class="main">⇒</span> bool<span class="main">)</span><span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bool_matchers</span> <span class="main">=</span> <span class="main">[</span>
    <span class="main">(</span><span class="inner_quoted">''D ''</span><span class="main">,</span> match_brz<span class="main">)</span><span class="main">,</span>
    <span class="comment1">⌦‹(''DQ'', match_brzq),›</span>
    <span class="main">(</span><span class="inner_quoted">''N ''</span><span class="main">,</span> match_n<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="inner_quoted">''P ''</span><span class="main">,</span> match_p<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="inner_quoted">''PN''</span><span class="main">,</span> match_pn<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="inner_quoted">''B ''</span><span class="main">,</span> match_b<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="inner_quoted">''B2''</span><span class="main">,</span> match_b2<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="inner_quoted">''A ''</span><span class="main">,</span> match_a<span class="main">)</span><span class="main">,</span>
    <span class="main">(</span><span class="inner_quoted">''A2''</span><span class="main">,</span> match_a2<span class="main">)</span>
    <span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Rexp</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Zero</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">Zero</span><span class="antiquote">}</span></span></span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">One</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">One</span><span class="antiquote">}</span></span></span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Atom</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">Atom</span><span class="antiquote">}</span></span></span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Plus</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">Plus</span><span class="antiquote">}</span></span></span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Times</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">Times</span><span class="antiquote">}</span></span></span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">Star</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">Star</span><span class="antiquote">}</span></span></span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bool_checkers</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">bool_checkers</span><span class="antiquote">}</span></span></span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">bool_matchers</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">bool_matchers</span><span class="antiquote">}</span></span></span><span class="main">;</span>
<span class="keyword2"><span class="keyword">end</span></span>
›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">timeout</span> <span class="main">=</span> Time.fromSeconds <span class="inner_numeral">10</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">res</span> <span class="main">=</span> <span class="entity">Res</span> <span class="keyword2"><span class="keyword">of</span></span> bool * Time.time <span class="main">|</span> <span class="entity">TO</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sum</span> <span class="main">[</span><span class="main">]</span> <span class="main">=</span> Time.fromSeconds <span class="inner_numeral">0</span>
  <span class="main">|</span> <span class="entity">sum</span> <span class="main">(</span><span class="entity">TO</span> :: <span class="entity">xs</span><span class="main">)</span> <span class="main">=</span> <span class="entity">timeout</span> + <span class="entity">sum</span> <span class="entity">xs</span>
  <span class="main">|</span> <span class="entity">sum</span> <span class="main">(</span><span class="entity">Res</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span> :: <span class="entity">xs</span><span class="main">)</span> <span class="main">=</span> <span class="entity">t</span> + <span class="entity">sum</span> <span class="entity">xs</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">average</span> <span class="entity">xs</span> <span class="main">=</span> Time.fromReal <span class="main">(</span>Time.toReal <span class="main">(</span><span class="entity">sum</span> <span class="entity">xs</span><span class="main">)</span> / real <span class="main">(</span>length <span class="entity">xs</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">time</span> <span class="entity">f</span> <span class="entity">x</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">timer</span> <span class="main">=</span> Timer.startRealTimer <span class="main">(</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">res</span> <span class="main">=</span> Timeout.apply <span class="entity">timeout</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">)</span> <span class="main">=&gt;</span> uncurry <span class="entity">f</span> <span class="entity">x</span><span class="main">)</span> <span class="main">(</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">time</span> <span class="main">=</span> Timer.checkRealTimer <span class="entity">timer</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">Res</span> <span class="main">(</span><span class="entity">res</span><span class="main">,</span> <span class="entity">time</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span> <span class="keyword3"><span class="keyword">handle</span></span> Timeout.TIMEOUT <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">TO</span><span class="main">;</span>
›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">list_n</span> <span class="inner_numeral">0</span> <span class="main">_</span> <span class="entity">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="main">]</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span>
    <span class="main">|</span> <span class="entity">list_n</span> <span class="entity">n</span> <span class="entity">g</span> <span class="entity">r</span> <span class="main">=</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">x</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span> <span class="main">=</span> <span class="entity">g</span> <span class="entity">r</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">xs</span><span class="main">,</span><span class="entity">r</span><span class="main">)</span> <span class="main">=</span> <span class="entity">list_n</span> <span class="main">(</span><span class="entity">n</span> - <span class="inner_numeral">1</span><span class="main">)</span> <span class="entity">g</span> <span class="entity">r</span>
      <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">x</span>::<span class="entity">xs</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">join</span> <span class="entity">g</span> <span class="entity">r</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">g'</span><span class="main">,</span> <span class="entity">r'</span><span class="main">)</span> <span class="main">=</span> <span class="entity">g</span> <span class="entity">r</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span> <span class="entity">g'</span> <span class="entity">r'</span> <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">regex</span> <span class="inner_numeral">0</span> <span class="main">=</span> <span class="entity">Generator.map</span> <span class="entity">Rexp.Atom</span> <span class="entity">Generator.flip</span>
    <span class="main">|</span> <span class="entity">regex</span> <span class="entity">n</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">let</span></span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">m</span> <span class="main">=</span> <span class="entity">Generator.selectL</span> <span class="main">(</span><span class="inner_numeral">0</span> upto <span class="entity">n</span> - <span class="inner_numeral">1</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">plus</span> <span class="main">=</span> <span class="entity">join</span> <span class="main">(</span><span class="entity">Generator.map</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">m</span> <span class="main">=&gt;</span>
        <span class="entity">Generator.map2</span> <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">regex</span> <span class="entity">m</span><span class="main">,</span> <span class="entity">regex</span> <span class="main">(</span><span class="entity">n</span> - <span class="inner_numeral">1</span> - <span class="entity">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">m</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">times</span> <span class="main">=</span> <span class="entity">join</span> <span class="main">(</span><span class="entity">Generator.map</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">m</span> <span class="main">=&gt;</span>
        <span class="entity">Generator.map2</span> <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">regex</span> <span class="entity">m</span><span class="main">,</span> <span class="entity">regex</span> <span class="main">(</span><span class="entity">n</span> - <span class="inner_numeral">1</span> - <span class="entity">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">m</span><span class="main">)</span><span class="main">;</span>
      <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">star</span> <span class="main">=</span> <span class="entity">join</span> <span class="main">(</span><span class="entity">Generator.map</span> <span class="main">(</span><span class="entity">Generator.map</span> <span class="entity">Rexp.Star</span> o <span class="entity">regex</span><span class="main">)</span> <span class="main">(</span><span class="entity">Generator.lift</span> <span class="main">(</span><span class="entity">n</span> - <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword2"><span class="keyword">in</span></span>
      <span class="entity">Generator.chooseL</span> <span class="main">[</span><span class="entity">plus</span><span class="main">,</span> <span class="entity">times</span><span class="main">,</span> <span class="entity">star</span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
›</span>

<span class="comment1">(*
ML {*
val checkers = drop 2 Rexp.bool_checkers
val sizes = [50,100,150,200,250];
val regexes = fst (fold_map (fn f =&gt; fn r =&gt; f r) (map (list_n 100 o regex) sizes)
  (Generator.new ()));
*}

declare [[ML_print_depth 100000]]
ML {*
fun alph Rexp.Zero = 0
  | alph Rexp.One = 0
  | alph (Rexp.Atom _) = 1
  | alph (Rexp.Plus (r, s)) = alph r + alph s
  | alph (Rexp.Times (r, s)) = alph r + alph s
  | alph (Rexp.Star r) = alph r;
map (map alph) regexes
*}
declare [[ML_print_depth 10]]
*)</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">header</span> <span class="entity">checkers</span> <span class="main">=</span>
  warning <span class="main">(</span><span class="inner_quoted">"n     "</span> ^  space_implode <span class="inner_quoted">"    "</span> <span class="main">(</span>map <span class="main">(</span>String.implode o fst<span class="main">)</span> <span class="entity">checkers</span><span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pad</span> <span class="entity">i</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> &lt; <span class="inner_numeral">10</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_numeral">4</span>
       <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> &lt; <span class="inner_numeral">100</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_numeral">3</span>
       <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> &lt; <span class="inner_numeral">1000</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_numeral">2</span>
       <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">i</span> &lt; <span class="inner_numeral">10000</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_numeral">1</span>
       <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_numeral">0</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">round</span> <span class="entity">n</span> <span class="entity">ts</span> <span class="main">=</span>
  warning <span class="main">(</span>string_of_int <span class="entity">n</span> ^ implode <span class="main">(</span>replicate <span class="main">(</span><span class="inner_numeral">1</span> + <span class="entity">pad</span> <span class="entity">n</span><span class="main">)</span> <span class="inner_quoted">" "</span><span class="main">)</span> ^
    space_implode <span class="inner_quoted">" "</span> <span class="main">(</span>map Time.toString <span class="entity">ts</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">run</span> <span class="entity">checkers</span> <span class="entity">sizes</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">regexes</span> <span class="main">=</span> fst <span class="main">(</span>fold_map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">f</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">r</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="entity">r</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="entity">list_n</span> <span class="inner_numeral">100</span> o <span class="entity">regex</span><span class="main">)</span> <span class="entity">sizes</span><span class="main">)</span>
      <span class="main">(</span><span class="entity">Generator.new</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">header</span> <span class="entity">checkers</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> map_index <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">i</span><span class="main">,</span> <span class="entity">rs</span><span class="main">)</span> <span class="main">=&gt;</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">n</span> <span class="main">=</span> nth <span class="entity">sizes</span> <span class="entity">i</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ts</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">ch</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">average</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">r</span> <span class="main">=&gt;</span> <span class="entity">time</span> <span class="entity">ch</span> <span class="main">(</span><span class="entity">r</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span><span class="main">)</span> <span class="entity">rs</span><span class="main">)</span><span class="main">)</span> <span class="entity">checkers</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">round</span> <span class="entity">n</span> <span class="entity">ts</span>
      <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span> <span class="entity">regexes</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="main">(</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">run_re</span> <span class="entity">mk_eq</span> <span class="entity">checkers</span> <span class="entity">sizes</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">header</span> <span class="entity">checkers</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">n</span> <span class="main">=&gt;</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">eq</span> <span class="main">=</span> <span class="entity">mk_eq</span> <span class="entity">n</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ts</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">ch</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">time</span> <span class="entity">ch</span> <span class="entity">eq</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="entity">Res</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">t</span> <span class="main">|</span> <span class="entity">TO</span> <span class="main">=&gt;</span> <span class="entity">timeout</span><span class="main">)</span> <span class="entity">checkers</span><span class="main">;</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="entity">round</span> <span class="entity">n</span> <span class="entity">ts</span>
      <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span> <span class="entity">sizes</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="main">(</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
›</span>

<span class="comment1">(*
ML {* run Rexp.bool_checkers [10,20,30,40,50,100] *}
n     D     N     P     PN    B     B2    A     A2 
10    0.070 0.000 0.000 0.000 0.000 0.000 0.000 0.000 
20    1.401 0.000 0.001 0.000 0.000 0.000 0.000 0.000 
30    4.235 0.005 0.002 0.002 0.000 0.000 0.000 0.000 
40    5.080 0.089 0.005 0.004 0.000 0.000 0.000 0.000 
50    6.916 0.222 0.012 0.010 0.001 0.000 0.001 0.001 
100   9.587 2.593 0.137 0.116 0.002 0.002 0.003 0.002
*)</span>

<span class="comment1">(*
ML {* run (drop 2 Rexp.bool_checkers) [50,100,150,200,250] *}
n     P     PN    B     B2    A     A2 
50    0.011 0.009 0.001 0.000 0.001 0.001 
100   0.136 0.112 0.002 0.002 0.004 0.003 
150   0.635 0.499 0.009 0.008 0.013 0.010 
200   2.029 1.744 0.016 0.013 0.025 0.019 
250   4.490 3.719 0.028 0.024 0.040 0.030 
*)</span>

<span class="comment1">(*
ML {* run (drop 4 Rexp.bool_checkers) [100,200,300,400,500,600,700,800,900,1000]
n     B     B2    A     A2 
100   0.003 0.002 0.005 0.003 
200   0.023 0.019 0.033 0.025 
300   0.090 0.078 0.119 0.094 
400   0.215 0.213 0.278 0.222 
500   0.443 0.450 0.555 0.477
600   0.710 0.806 0.948 0.776
700   1.304 1.382 1.575 1.335
800   1.696 1.902 2.151 1.848 
900   2.388 2.643 2.878 2.567 
1000  2.985 3.280 3.498 3.137
*)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Asperti's example›</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pow</span> <span class="inner_numeral">0</span> <span class="main">=</span> <span class="entity">Rexp.One</span>
  <span class="main">|</span> <span class="entity">pow</span> <span class="inner_numeral">1</span> <span class="main">=</span> <span class="entity">Rexp.Atom</span> true
  <span class="main">|</span> <span class="entity">pow</span> <span class="entity">n</span> <span class="main">=</span> <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">,</span> <span class="entity">pow</span> <span class="main">(</span><span class="entity">n</span> - <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">powl</span> <span class="inner_numeral">0</span> <span class="main">=</span> <span class="entity">Rexp.One</span>
  <span class="main">|</span> <span class="entity">powl</span> <span class="inner_numeral">1</span> <span class="main">=</span> <span class="entity">Rexp.Atom</span> true
  <span class="main">|</span> <span class="entity">powl</span> <span class="entity">n</span> <span class="main">=</span> <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">powl</span> <span class="main">(</span><span class="entity">n</span> - <span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span> <span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sum</span> <span class="entity">f</span> <span class="inner_numeral">0</span> <span class="main">=</span> <span class="entity">f</span> <span class="inner_numeral">0</span>
  <span class="main">|</span> <span class="entity">sum</span> <span class="entity">f</span> <span class="entity">n</span> <span class="main">=</span> <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">f</span> <span class="entity">n</span><span class="main">,</span> <span class="entity">sum</span> <span class="entity">f</span> <span class="main">(</span><span class="entity">n</span> - <span class="inner_numeral">1</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">b</span> <span class="entity">n</span> <span class="main">=</span> <span class="main">(</span><span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">sum</span> <span class="entity">pow</span> <span class="main">(</span><span class="entity">n</span> - <span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span> <span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">pow</span> <span class="entity">n</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">bl</span> <span class="entity">n</span> <span class="main">=</span> <span class="main">(</span><span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">sum</span> <span class="entity">powl</span> <span class="main">(</span><span class="entity">n</span> - <span class="inner_numeral">1</span><span class="main">)</span><span class="main">,</span> <span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">powl</span> <span class="entity">n</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">;</span>

›</span>

<span class="comment1">(*
ML {* run_re b Rexp.bool_checkers [30,40,50,70,100,200] *}
ML {* run_re bl Rexp.bool_checkers [30,40,50,70,100,200] *}
ML {* run_re b (drop 1 Rexp.bool_checkers) [100,200,300,400,500] *}
ML {* run_re bl (drop 1 Rexp.bool_checkers) [100,200,300,400,500] *}
ML {* run_re b (take 3 (drop 1 Rexp.bool_checkers)) [500,600,700,800] *}
ML {* run_re bl (take 3 (drop 1 Rexp.bool_checkers)) [500,600,700,800] *}
*)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Fischer's example (matching)›</span></span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">seq</span> <span class="entity">n</span> <span class="main">=</span> Library.foldr1 <span class="entity">Rexp.Times</span> o replicate <span class="entity">n</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">seql</span> <span class="entity">n</span> <span class="main">=</span> Library.foldr1 <span class="main">(</span><span class="entity">Rexp.Times</span> o swap<span class="main">)</span> o replicate <span class="entity">n</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">re</span> <span class="entity">n</span> <span class="main">=</span> <span class="main">(</span><span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">seq</span> <span class="entity">n</span> <span class="main">(</span><span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">,</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">seq</span> <span class="entity">n</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">,</span>
  replicate <span class="entity">n</span> true<span class="main">)</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">rel</span> <span class="entity">n</span> <span class="main">=</span> <span class="main">(</span><span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">seql</span> <span class="entity">n</span> <span class="main">(</span><span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">,</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">seql</span> <span class="entity">n</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">,</span>
  replicate <span class="entity">n</span> true<span class="main">)</span><span class="main">;</span>

›</span>

<span class="comment1">(*
ML {* run_re re Rexp.bool_matchers [30,40,50,70,100] *}
ML {* run_re rel Rexp.bool_matchers [30,40,50,70,100] *}
ML {* run_re re (drop 4 Rexp.bool_matchers) [100,300,500,700,1000,1300,1600,2000,2500,3000,4000,5000] *}
ML {* run_re rel (drop 4 Rexp.bool_matchers) [100,300,500,700,1000,1300,1600,2000,2500,3000,4000,5000] *}
*)</span>
<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">monster</span> <span class="main">=</span>
curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span>
<span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span>
<span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="entity">Rexp.Zero</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span>
<span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span>
<span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span>
true<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span>
false<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span>
false<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span>
<span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span>
<span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span>
true<span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="entity">Rexp.One</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span>
true<span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="entity">Rexp.Zero</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span>
false<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span>
true<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span>
<span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span>
<span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span>
<span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span>
<span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span>
<span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span>
<span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span>
<span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="entity">Rexp.Zero</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="entity">Rexp.One</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span>
false<span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="entity">Rexp.Zero</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span>
<span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span>
<span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.One</span><span class="main">)</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span>
false<span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span>
<span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span>
true<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span>
<span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span>
false<span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="entity">Rexp.One</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="entity">Rexp.One</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span>
<span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span>
false<span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span>
false<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="main">(</span><span class="entity">Rexp.Atom</span>
true<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span>
<span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span>
true<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span>
true<span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span>
<span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span>
<span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="entity">Rexp.Zero</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span>
false<span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="entity">Rexp.Zero</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="entity">Rexp.Zero</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="entity">Rexp.One</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span>
<span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="entity">Rexp.One</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span>
true<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="entity">Rexp.One</span><span class="main">)</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span>
<span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span>
<span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span>
<span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span>
true<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span>
<span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span>
<span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span>
true<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span>
false<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span>
<span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span>
true<span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="entity">Rexp.One</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span>
<span class="entity">Rexp.One</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span>
<span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="entity">Rexp.Zero</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span>
<span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span>
<span class="entity">Rexp.One</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="main">(</span>curry
<span class="entity">Rexp.Times</span> <span class="entity">Rexp.One</span> <span class="entity">Rexp.Zero</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.One</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span> <span class="entity">Rexp.Zero</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="entity">Rexp.One</span> <span class="main">(</span>curry <span class="entity">Rexp.Plus</span> <span class="main">(</span>curry <span class="entity">Rexp.Times</span> <span class="entity">Rexp.Zero</span> <span class="entity">Rexp.One</span><span class="main">)</span> <span class="main">(</span>curry
<span class="entity">Rexp.Plus</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span>
<span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Star</span> <span class="main">(</span><span class="entity">Rexp.Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
›</span>

<span class="comment1">(*
ML {* run_re (K (monster, monster)) Rexp.bool_checkers [1] *}
*)</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">runTO</span> <span class="entity">checker</span> <span class="entity">sizes</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">regexes</span> <span class="main">=</span> fst <span class="main">(</span>fold_map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">f</span> <span class="main">=&gt;</span> <span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">r</span> <span class="main">=&gt;</span> <span class="entity">f</span> <span class="entity">r</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="entity">list_n</span> <span class="inner_numeral">1000</span> o <span class="entity">regex</span><span class="main">)</span> <span class="entity">sizes</span><span class="main">)</span>
      <span class="main">(</span><span class="entity">Generator.new</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">rs</span> <span class="main">=&gt;</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">print</span> <span class="main">(</span><span class="entity">TO</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>warning <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote">@{</span><span class="operator">make_string</span><span class="antiquote">}</span></span></span></span> <span class="main">(</span>nth <span class="entity">rs</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="entity">TO</span><span class="main">)</span>
          <span class="main">|</span> <span class="entity">print</span> <span class="main">(</span><span class="entity">t</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>warning <span class="main">(</span>string_of_int <span class="entity">i</span><span class="main">)</span><span class="main">;</span> <span class="entity">t</span><span class="main">)</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">ts</span> <span class="main">=</span> map_index <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">(</span><span class="entity">i</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="entity">print</span> <span class="main">(</span><span class="entity">time</span> <span class="main">(</span>snd <span class="entity">checker</span><span class="main">)</span> <span class="main">(</span><span class="entity">r</span><span class="main">,</span> <span class="entity">r</span><span class="main">)</span><span class="main">,</span> <span class="entity">i</span><span class="main">)</span><span class="main">)</span> <span class="entity">rs</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> warning <span class="main">(</span>String.implode <span class="main">(</span>fst <span class="entity">checker</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        warning <span class="main">(</span>Time.toString <span class="main">(</span><span class="entity">average</span> <span class="entity">ts</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span> <span class="entity">regexes</span><span class="main">;</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="main">(</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>
›</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹<span class="keyword2"><span class="keyword">local</span></span> <span class="keyword3"><span class="keyword">open</span></span> Rexp <span class="keyword2"><span class="keyword">in</span></span>

 <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">evil</span> <span class="main">=</span>

 <span class="entity">Star</span> <span class="main">(</span><span class="entity">Star</span> <span class="main">(</span><span class="entity">Star</span> <span class="main">(</span><span class="entity">Times</span> <span class="main">(</span><span class="entity">Times</span> <span class="main">(</span><span class="entity">Star</span> <span class="main">(</span><span class="entity">Star</span> <span class="main">(</span><span class="entity">Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">Plus</span> <span class="main">(</span><span class="entity">Star</span> <span class="main">(</span><span class="entity">Star</span> <span class="main">(</span><span class="entity">Plus</span> <span class="main">(</span><span class="entity">Times</span> <span class="main">(</span><span class="entity">Atom</span>
 false<span class="main">,</span> <span class="entity">Plus</span> <span class="main">(</span><span class="entity">Atom</span> false<span class="main">,</span> <span class="entity">Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">Times</span> <span class="main">(</span><span class="entity">Times</span> <span class="main">(</span><span class="entity">Times</span> <span class="main">(</span><span class="entity">Atom</span> false<span class="main">,</span> <span class="entity">Plus</span> <span class="main">(</span><span class="entity">Atom</span> true<span class="main">,</span> <span class="entity">Atom</span>
 false<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">Times</span> <span class="main">(</span><span class="entity">Atom</span> true<span class="main">,</span> <span class="entity">Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">Times</span> <span class="main">(</span><span class="entity">Star</span> <span class="main">(</span><span class="entity">Times</span> <span class="main">(</span><span class="entity">Times</span> <span class="main">(</span><span class="entity">Atom</span> true<span class="main">,</span> <span class="entity">Atom</span> false<span class="main">)</span><span class="main">,</span> <span class="entity">Atom</span>
 true<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">Times</span> <span class="main">(</span><span class="entity">Times</span> <span class="main">(</span><span class="entity">Plus</span> <span class="main">(</span><span class="entity">Atom</span> false<span class="main">,</span> <span class="entity">Plus</span> <span class="main">(</span><span class="entity">Atom</span> true<span class="main">,</span> <span class="entity">Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">Atom</span> true<span class="main">)</span><span class="main">,</span>
 <span class="entity">Star</span> <span class="main">(</span><span class="entity">Plus</span> <span class="main">(</span><span class="entity">Atom</span> false<span class="main">,</span> <span class="entity">Atom</span> true<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="entity">Plus</span> <span class="main">(</span><span class="entity">Atom</span> false<span class="main">,</span> <span class="entity">Star</span> <span class="main">(</span><span class="entity">Atom</span> false<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
›</span>
<span class="comment1">(*
ML {* snd (nth Rexp.bool_checkers 1) evil evil *}

ML {*
  runTO (nth Rexp.bool_checkers 1) [28]
*}
*)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>